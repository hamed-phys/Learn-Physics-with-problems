<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Wave Optics & Polarization — Conceptual Solutions (a–f) with Interactive Visualizations</title>
  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.10);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --faint: rgba(255,255,255,0.45);
      --accent: #7dd3fc;
      --accent2:#a78bfa;
      --good: #34d399;
      --warn: #fbbf24;
      --bad: #fb7185;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --serif: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
      --shadow: 0 20px 60px rgba(0,0,0,0.35);
      --radius: 18px;
      --radius2: 26px;
      --border: 1px solid rgba(255,255,255,0.14);
      --grid: rgba(255,255,255,0.08);
      --gridBold: rgba(255,255,255,0.12);
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg: #f6f7fb;
        --panel: rgba(10,20,40,0.05);
        --panel2: rgba(10,20,40,0.08);
        --text: rgba(10,20,40,0.92);
        --muted: rgba(10,20,40,0.72);
        --faint: rgba(10,20,40,0.50);
        --shadow: 0 18px 50px rgba(10,20,40,0.12);
        --border: 1px solid rgba(10,20,40,0.14);
        --grid: rgba(10,20,40,0.09);
        --gridBold: rgba(10,20,40,0.14);
      }
    }

    *{ box-sizing: border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(125,211,252,0.25), transparent 60%),
        radial-gradient(900px 650px at 85% 15%, rgba(167,139,250,0.20), transparent 55%),
        radial-gradient(800px 600px at 60% 90%, rgba(52,211,153,0.10), transparent 60%),
        linear-gradient(180deg, var(--bg), var(--bg));
      color: var(--text);
      line-height: 1.6;
      letter-spacing: 0.1px;
    }

    a{ color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    header{
      padding: clamp(26px, 4vw, 44px) clamp(18px, 5vw, 64px) 18px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .kicker{
      display:flex;
      gap:10px;
      flex-wrap: wrap;
      align-items:center;
      color: var(--muted);
      font-size: 0.95rem;
    }
    .pill{
      padding: 6px 10px;
      border-radius: 999px;
      background: var(--panel);
      border: var(--border);
      display:inline-flex;
      align-items:center;
      gap:8px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;
      background: linear-gradient(135deg, var(--accent), var(--accent2));
      box-shadow: 0 0 0 3px rgba(125,211,252,0.15);
    }
    h1{
      margin: 14px 0 8px;
      font-size: clamp(1.85rem, 3.2vw, 3.0rem);
      line-height: 1.12;
      letter-spacing: -0.5px;
    }
    .subtitle{
      max-width: 70ch;
      color: var(--muted);
      font-size: 1.05rem;
    }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px clamp(18px, 5vw, 64px) 80px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
    }

    article{
      background: var(--panel);
      border: var(--border);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      position:relative;
    }
    article::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(700px 220px at 20% 0%, rgba(125,211,252,0.20), transparent 70%),
                  radial-gradient(550px 220px at 80% 0%, rgba(167,139,250,0.16), transparent 70%);
      pointer-events:none;
      opacity:0.85;
    }
    .content{
      position:relative;
      padding: clamp(18px, 2.6vw, 34px);
    }

    section{ margin: 24px 0; }
    section:first-child{ margin-top: 0; }
    h2{
      margin: 0 0 10px;
      font-size: 1.35rem;
      letter-spacing: -0.2px;
    }
    h3{
      margin: 18px 0 10px;
      font-size: 1.12rem;
      letter-spacing: -0.1px;
      color: rgba(255,255,255,0.95);
    }
    @media (prefers-color-scheme: light){
      h3{ color: rgba(10,20,40,0.92); }
    }

    .toc{
      padding: 18px;
      background: var(--panel);
      border: var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      position: sticky;
      top: 14px;
    }
    .toc h2{
      margin: 0 0 10px;
      font-size: 1.1rem;
    }
    .toc ol{
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
    }
    .toc li{ margin: 6px 0; }
    .toc .mini{
      font-size: 0.92rem;
      color: var(--faint);
      margin-top: 10px;
    }

    .callouts{
      display:grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 12px;
      margin-top: 14px;
    }
    @media (max-width: 680px){
      .callouts{ grid-template-columns: 1fr; }
    }
    .callout{
      border-radius: var(--radius);
      border: var(--border);
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      padding: 14px 14px 12px;
      position:relative;
      overflow:hidden;
    }
    .callout::after{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(260px 120px at 20% 10%, rgba(52,211,153,0.16), transparent 60%),
                  radial-gradient(240px 120px at 80% 0%, rgba(125,211,252,0.16), transparent 60%);
      opacity:0.8;
      pointer-events:none;
    }
    .callout > *{ position:relative; }
    .callout b{ color: var(--text); }
    .small{ font-size: 0.95rem; color: var(--muted); }

    .eq{
      font-family: var(--mono);
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.16);
      border-radius: 14px;
      padding: 12px 14px;
      overflow-x:auto;
      white-space: nowrap;
      color: rgba(255,255,255,0.93);
    }
    @media (prefers-color-scheme: light){
      .eq{
        background: rgba(10,20,40,0.06);
        border: 1px solid rgba(10,20,40,0.14);
        color: rgba(10,20,40,0.92);
      }
    }
    .eq .sym{ color: var(--accent); }
    .eq .num{ color: var(--good); }
    .eq .op{ color: var(--accent2); }

    .final-box{
      border-radius: var(--radius2);
      border: 1px solid rgba(125,211,252,0.35);
      background: linear-gradient(180deg, rgba(125,211,252,0.12), rgba(167,139,250,0.08));
      padding: 16px 16px 14px;
      box-shadow: 0 10px 40px rgba(0,0,0,0.18);
      position:relative;
      overflow:hidden;
    }
    .final-box::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(400px 140px at 30% 0%, rgba(125,211,252,0.28), transparent 70%),
                  radial-gradient(420px 150px at 80% 0%, rgba(167,139,250,0.22), transparent 72%);
      pointer-events:none;
      opacity:0.75;
    }
    .final-box > *{ position:relative; }
    .final-box h2{ margin: 0 0 10px; }

    figure{
      margin: 14px 0 0;
      padding: 14px;
      border-radius: var(--radius2);
      border: var(--border);
      background: linear-gradient(180deg, var(--panel2), var(--panel));
    }
    figcaption{
      margin-top: 10px;
      color: var(--muted);
      font-size: 0.95rem;
    }

    .canvas-wrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }
    canvas{
      width: 100%;
      height: auto;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.10);
    }
    @media (prefers-color-scheme: light){
      canvas{ background: rgba(10,20,40,0.04); border: 1px solid rgba(10,20,40,0.14); }
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      align-items:end;
      margin-top: 6px;
    }
    @media (max-width: 720px){
      .controls{ grid-template-columns: 1fr; }
    }

    .control{
      padding: 12px 12px 10px;
      border-radius: var(--radius);
      border: var(--border);
      background: var(--panel);
    }
    label{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap: 10px;
      font-size: 0.95rem;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    .readout{
      font-family: var(--mono);
      font-size: 0.95rem;
      color: var(--text);
      white-space: nowrap;
    }
    .btn{
      appearance:none;
      border: var(--border);
      background: linear-gradient(180deg, rgba(125,211,252,0.18), rgba(167,139,250,0.12));
      color: var(--text);
      padding: 10px 12px;
      border-radius: 14px;
      cursor:pointer;
      font-weight: 600;
      letter-spacing: 0.2px;
      transition: transform 180ms ease, box-shadow 180ms ease;
      box-shadow: 0 12px 30px rgba(0,0,0,0.18);
    }
    .btn:hover{ transform: translateY(-1px); }
    .btn:active{ transform: translateY(0px) scale(0.99); }
    .btn:focus{
      outline: 3px solid rgba(125,211,252,0.35);
      outline-offset: 2px;
    }

    .two-col{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 880px){
      .two-col{ grid-template-columns: 1fr; }
    }

    .qa{
      border-left: 3px solid rgba(125,211,252,0.55);
      padding-left: 12px;
      margin: 10px 0;
    }
    .qa .q{
      font-weight: 700;
      letter-spacing: -0.1px;
      margin-bottom: 4px;
    }
    .qa .a{ color: var(--muted); }

    .sanity{
      border-radius: var(--radius);
      border: 1px solid rgba(52,211,153,0.35);
      background: linear-gradient(180deg, rgba(52,211,153,0.10), rgba(0,0,0,0));
      padding: 12px 12px 10px;
      margin-top: 10px;
    }
    .sanity h4{
      margin: 0 0 6px;
      font-size: 1.0rem;
      color: rgba(52,211,153,0.95);
    }
    .sanity ul{
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
    }

    footer{
      margin-top: 26px;
      padding-top: 16px;
      border-top: 1px solid rgba(255,255,255,0.12);
      color: var(--faint);
      font-size: 0.92rem;
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      justify-content:space-between;
    }

    /* Subtle entrance animation */
    @keyframes rise {
      from { opacity: 0; transform: translateY(10px); }
      to   { opacity: 1; transform: translateY(0); }
    }
    article, .toc { animation: rise 520ms ease both; }
    .toc { animation-delay: 80ms; }
  </style>
</head>
<body>
  <header>
    <div class="kicker">
      <span class="pill"><span class="dot" aria-hidden="true"></span> Wave Optics • Polarization • Dispersion • Diffraction</span>
      <span class="pill">Conceptual set (a–f) • Fully worked + interactive visuals</span>
    </div>
    <h1>Problem 1 — Conceptual Questions (a–f): Full Solutions with Visualizations</h1>
    <p class="subtitle">
      This article answers each part rigorously but beginner-friendly, with clean equation blocks and
      two <code>&lt;canvas&gt;</code> visualizations: (1) a labeled plot of deep-water phase/group velocity vs. wavenumber,
      and (2) a diffraction-limited Moon→Earth laser geometry diagram. A slider updates the plot in real time.
    </p>
  </header>

  <main class="grid">
    <aside class="toc" aria-label="Article navigation">
      <h2>On this page</h2>
      <ol>
        <li><a href="#summary">Quick Summary</a></li>
        <li><a href="#a">a) Circular → Linear polarizer</a></li>
        <li><a href="#b">b) Bandwidth for 1 ns pulses</a></li>
        <li><a href="#c">c) Deep-water dispersion: vp & vg</a></li>
        <li><a href="#d">d) Laser spot size (diffraction-limited)</a></li>
        <li><a href="#e">e) Why sunglasses work worse sideways</a></li>
        <li><a href="#f">f) Grating: lines/cm and wavelength</a></li>
        <li><a href="#final">Final Answer Box</a></li>
        <li><a href="#viz">Interactive Visualizations</a></li>
      </ol>
      <p class="mini">
        Accessibility: high-contrast, keyboard-focusable controls, ARIA labels, no external libraries.
      </p>
    </aside>

    <article>
      <div class="content">
        <section id="summary">
          <h2>Quick Summary</h2>
          <div class="callouts">
            <div class="callout">
              <b>(a)</b> Circularly polarized light through an ideal linear polarizer transmits half the intensity:
              <div class="eq" role="math" aria-label="Transmitted intensity equals I0 over 2">
                <span class="sym">I</span><sub>T</sub> <span class="op">=</span> <span class="num">1</span>/<span class="num">2</span> <span class="sym">I</span><sub>0</sub>
              </div>
            </div>
            <div class="callout">
              <b>(b)</b> A 1 ns pulse implies GHz-scale spectral content:
              <div class="eq" role="math" aria-label="Bandwidth scale is about 1 over tau">
                Δ<span class="sym">f</span> <span class="op">~</span> <span class="num">1</span>/<span class="sym">τ</span> <span class="op">≈</span> <span class="num">1</span> <span class="sym">GHz</span> (order)
              </div>
            </div>
            <div class="callout">
              <b>(c)</b> For deep-water waves <span class="sym">ω</span>=√(gk):
              <div class="eq" role="math" aria-label="Phase and group velocity formulas">
                <span class="sym">v</span><sub>p</sub><span class="op">=</span>√(<span class="sym">g</span>/<span class="sym">k</span>),&nbsp;
                <span class="sym">v</span><sub>g</sub><span class="op">=</span><span class="num">1</span>/<span class="num">2</span>√(<span class="sym">g</span>/<span class="sym">k</span>)<span class="op">=</span><span class="sym">v</span><sub>p</sub>/<span class="num">2</span>
              </div>
            </div>
            <div class="callout">
              <b>(d)</b> Diffraction-limited divergence gives a Moon→Earth spot of order <b>0.5 km diameter</b> for
              λ=500 nm, D=1 m, L=3.8×10<sup>8</sup> m.
            </div>
          </div>
        </section>

        <section id="a">
          <h2>(a) Circularly polarized light through a linear polarizer</h2>
          <p>
            <b>Idea:</b> A linear polarizer passes only the electric-field component along its transmission axis.
            Circular polarization has <i>equal power</i> in any pair of orthogonal linear directions, so an ideal
            linear polarizer always transmits exactly half the incident intensity.
          </p>

          <h3>Derivation (clear steps)</h3>
          <p>
            Represent right-circular polarization as two equal-amplitude orthogonal components with a 90° phase shift:
          </p>
          <div class="eq" role="math" aria-label="Electric field for circular polarization">
            <b>E</b>(t) <span class="op">=</span> <span class="sym">E</span><sub>0</sub>
            ( <span class="sym">x̂</span> cos(ωt) <span class="op">+</span> <span class="sym">ŷ</span> sin(ωt) )
          </div>
          <p>
            A linear polarizer transmitting along <span class="sym">x̂</span> outputs only
            <span class="sym">E</span><sub>x</sub>(t)=<span class="sym">E</span><sub>0</sub>cos(ωt).
            Since intensity is proportional to time-averaged squared field,
            <span class="sym">I</span>∝⟨<span class="sym">E</span><sup>2</sup>⟩:
          </p>
          <div class="two-col">
            <div>
              <div class="eq" role="math" aria-label="Incident average E squared">
                ⟨|<b>E</b>|<sup>2</sup>⟩ <span class="op">=</span> ⟨<span class="sym">E</span><sub>0</sub><sup>2</sup>(cos<sup>2</sup>ωt <span class="op">+</span> sin<sup>2</sup>ωt)⟩
                <span class="op">=</span> <span class="sym">E</span><sub>0</sub><sup>2</sup>
              </div>
            </div>
            <div>
              <div class="eq" role="math" aria-label="Transmitted average Ex squared">
                ⟨<span class="sym">E</span><sub>x</sub><sup>2</sup>⟩ <span class="op">=</span> ⟨<span class="sym">E</span><sub>0</sub><sup>2</sup>cos<sup>2</sup>ωt⟩
                <span class="op">=</span> <span class="sym">E</span><sub>0</sub><sup>2</sup>/2
              </div>
            </div>
          </div>
          <p>
            Therefore the transmitted intensity is half:
          </p>
          <div class="eq" role="math" aria-label="Final for a">
            <span class="sym">I</span><sub>T</sub> <span class="op">=</span> <span class="num">1</span>/<span class="num">2</span> <span class="sym">I</span><sub>0</sub>
          </div>

          <div class="sanity">
            <h4>Sanity checks</h4>
            <ul>
              <li><b>Units:</b> intensity remains intensity.</li>
              <li><b>Limiting case:</b> independent of polarizer angle (circular has no preferred axis).</li>
              <li><b>Meaning:</b> polarizer removes one of two equal-power orthogonal linear components.</li>
            </ul>
          </div>
        </section>

        <section id="b">
          <h2>(b) Bandwidth required for 1 ns square pulses</h2>
          <p>
            <b>Idea:</b> Sharp time-domain features require broad frequency content. A pulse of duration
            <span class="sym">τ</span> has characteristic spectral width on the order of 1/<span class="sym">τ</span>.
            An <i>ideal</i> mathematical square wave needs infinitely many harmonics; real electronics only aims for an
            approximate square, which requires a finite (but still large) bandwidth.
          </p>

          <h3>Frequency scale from the rectangular pulse spectrum</h3>
          <p>
            A rectangular pulse of width <span class="sym">τ</span> has a sinc-shaped spectrum; the first zero occurs at
            <span class="sym">f</span>=1/<span class="sym">τ</span>. For <span class="sym">τ</span>=1 ns:
          </p>
          <div class="eq" role="math" aria-label="Bandwidth estimate for 1 ns">
            <span class="sym">τ</span><span class="op">=</span><span class="num">1</span> ns <span class="op">=</span><span class="num">10</span><sup class="num">−9</sup> s
            &nbsp;⇒&nbsp; <span class="num">1</span>/<span class="sym">τ</span> <span class="op">=</span> <span class="num">10</span><sup class="num">9</sup> Hz <span class="op">=</span> <span class="num">1</span> GHz
          </div>
          <p>
            To preserve “square-ish” edges, you typically need several harmonics, so practical bandwidth is often
            a few times this scale.
          </p>

          <div class="sanity">
            <h4>Sanity checks</h4>
            <ul>
              <li><b>Units:</b> 1/s gives Hz.</li>
              <li><b>Limiting case:</b> τ→0 implies bandwidth→∞ (sharper pulses need more frequencies).</li>
              <li><b>Interpretation:</b> 1 ns timing demands GHz-class signal paths.</li>
            </ul>
          </div>
        </section>

        <section id="c">
          <h2>(c) Deep-water dispersion: ω = √(gk) → phase & group velocities</h2>
          <p>
            <b>Idea:</b> In dispersive waves, crests move with the <b>phase velocity</b>
            <span class="sym">v</span><sub>p</sub>=ω/k, while the envelope/energy travels with the <b>group velocity</b>
            <span class="sym">v</span><sub>g</sub>=dω/dk.
          </p>

          <h3>Compute <span class="sym">v</span><sub>p</sub> and <span class="sym">v</span><sub>g</sub></h3>
          <p>Given ω(k)=√(gk):</p>
          <div class="eq" role="math" aria-label="Phase velocity derivation">
            <span class="sym">v</span><sub>p</sub> <span class="op">=</span> ω/k
            <span class="op">=</span> √(gk)/k
            <span class="op">=</span> √(g/k)
          </div>
          <p>Differentiate ω with respect to k:</p>
          <div class="eq" role="math" aria-label="Group velocity derivation">
            ω <span class="op">=</span> (gk)<sup>1/2</sup> <span class="op">=</span> g<sup>1/2</sup>k<sup>1/2</sup>
            &nbsp;⇒&nbsp; <span class="sym">v</span><sub>g</sub><span class="op">=</span>dω/dk
            <span class="op">=</span> g<sup>1/2</sup>·(<span class="num">1</span>/<span class="num">2</span>)k<sup>−1/2</sup>
            <span class="op">=</span> (<span class="num">1</span>/<span class="num">2</span>)√(g/k)
          </div>
          <p>
            Therefore:
          </p>
          <div class="eq" role="math" aria-label="Final for c">
            <span class="sym">v</span><sub>p</sub><span class="op">=</span>√(g/k),&nbsp;
            <span class="sym">v</span><sub>g</sub><span class="op">=</span><span class="num">1</span>/<span class="num">2</span>√(g/k)
            <span class="op">=</span> <span class="sym">v</span><sub>p</sub>/<span class="num">2</span>
          </div>

          <div class="sanity">
            <h4>Sanity checks</h4>
            <ul>
              <li><b>Units:</b> g/k has units (m/s²)/(1/m)=m²/s² → √ gives m/s.</li>
              <li><b>Limiting case:</b> k→∞ (short waves) makes both speeds smaller.</li>
              <li><b>Meaning:</b> packets/energy move at half the crest speed in deep water.</li>
            </ul>
          </div>
        </section>

        <section id="d">
          <h2>(d) Diffraction-limited Moon → Earth laser spot size</h2>
          <p>
            <b>Given:</b> λ = 500 nm, beam width on Moon D = 1 m, distance L = 380,000 km.
            Diffraction-limited means the beam divergence is set by aperture diffraction.
          </p>

          <h3>Compute the diffraction-limited angular spread</h3>
          <p>
            For a circular/finite aperture, the characteristic angular radius to the first minimum is
            θ ≈ 1.22 λ/D (in radians). Then the spot radius at distance L is r ≈ θL.
          </p>
          <div class="eq" role="math" aria-label="Divergence and radius relationship">
            θ <span class="op">≈</span> <span class="num">1.22</span>·λ/D,&nbsp;&nbsp; r <span class="op">≈</span> θL,&nbsp;&nbsp; d<sub>spot</sub> <span class="op">≈</span> <span class="num">2</span>r
          </div>

          <h3>Plug in numbers (step-by-step)</h3>
          <div class="eq" role="math" aria-label="Numeric calculation for d">
            λ<span class="op">=</span><span class="num">500</span> nm<span class="op">=</span><span class="num">5</span>×<span class="num">10</span><sup class="num">−7</sup> m,&nbsp;
            D<span class="op">=</span><span class="num">1</span> m,&nbsp;
            L<span class="op">=</span><span class="num">380,000</span> km<span class="op">=</span><span class="num">3.8</span>×<span class="num">10</span><sup class="num">8</sup> m
          </div>
          <div class="eq" role="math" aria-label="Theta calculation">
            θ <span class="op">≈</span> <span class="num">1.22</span>(<span class="num">5</span>×<span class="num">10</span><sup class="num">−7</sup>)/<span class="num">1</span>
            <span class="op">=</span> <span class="num">6.1</span>×<span class="num">10</span><sup class="num">−7</sup> rad
          </div>
          <div class="eq" role="math" aria-label="Spot size calculation">
            r <span class="op">≈</span> θL <span class="op">≈</span> (<span class="num">6.1</span>×<span class="num">10</span><sup class="num">−7</sup>)(<span class="num">3.8</span>×<span class="num">10</span><sup class="num">8</sup>)
            <span class="op">≈</span> <span class="num">2.3</span>×<span class="num">10</span><sup class="num">2</sup> m
            <span class="op">≈</span> <span class="num">230</span> m
          </div>
          <p>So the diameter is approximately 2r ≈ 460 m (about 0.5 km).</p>

          <div class="sanity">
            <h4>Sanity checks</h4>
            <ul>
              <li><b>Units:</b> θ is dimensionless, r=θL gives meters.</li>
              <li><b>Limiting case:</b> bigger D → smaller θ → smaller spot (makes sense).</li>
              <li><b>Meaning:</b> tiny diffraction angles become huge spots over lunar distances.</li>
            </ul>
          </div>
        </section>

        <section id="e">
          <h2>(e) Why Polaroid sunglasses reduce glare less when you lie on your side</h2>
          <p>
            <b>Idea:</b> Reflections from a horizontal water surface are strongly polarized (especially near Brewster’s angle).
            The glare is predominantly <b>horizontally polarized</b> (electric field parallel to the surface).
            Polaroid sunglasses are usually oriented to block this horizontal polarization when your head is upright.
          </p>

          <div class="qa">
            <div class="q">What changes when you lie down on your side?</div>
            <div class="a">
              The sunglasses rotate with your head. Their transmission axis—designed to be “vertical” when upright—becomes
              horizontal relative to the world when you rotate ~90°. That misalignment means the glasses now transmit more
              of the horizontally polarized glare, so they appear less effective.
            </div>
          </div>

          <div class="sanity">
            <h4>Sanity checks</h4>
            <ul>
              <li><b>Limiting case:</b> rotate by 90° → maximum loss of glare suppression.</li>
              <li><b>Meaning:</b> it’s a polarization-geometry issue, not a “brightness” issue.</li>
            </ul>
          </div>
        </section>

        <section id="f">
          <h2>(f) Diffraction grating: effect of more lines/cm and longer wavelength</h2>
          <p>
            Principal maxima of a grating occur at angles satisfying the grating equation:
          </p>
          <div class="eq" role="math" aria-label="Grating equation">
            d sinθ <span class="op">=</span> mλ,&nbsp;&nbsp; m <span class="op">=</span> 0, ±1, ±2, …
          </div>

          <h3>(f1) More lines per centimeter</h3>
          <p>
            More lines/cm means the grating spacing <b>d decreases</b>. For fixed order m and wavelength λ,
            sinθ = mλ/d increases as d decreases → θ increases. So the principal maxima move farther from the center
            (greater angular separation). However, allowed orders must satisfy |sinθ|≤1, so:
          </p>
          <div class="eq" role="math" aria-label="Max order condition">
            |m|λ ≤ d &nbsp;⇒&nbsp; |m| ≤ d/λ
          </div>
          <p>
            Smaller d can reduce the number of observable orders.
          </p>

          <h3>(f2) Longer wavelength on the same grating</h3>
          <p>
            Increasing λ (keeping d fixed) increases sinθ = mλ/d, so maxima move outward to larger angles.
            The maximum order |m|≤d/λ decreases, so fewer orders fit.
          </p>

          <div class="sanity">
            <h4>Sanity checks</h4>
            <ul>
              <li><b>Limiting case:</b> if mλ > d then that order vanishes (no real θ).</li>
              <li><b>Meaning:</b> both smaller d and larger λ increase angular dispersion, but can reduce visible orders.</li>
            </ul>
          </div>
        </section>

        <section id="final">
          <div class="final-box" role="region" aria-label="Final answers">
            <h2>Final Answer (All Parts)</h2>
            <div class="two-col">
              <div>
                <p class="small"><b>(a)</b> Circular → linear polarizer:</p>
                <div class="eq" role="math" aria-label="Final a">
                  <span class="sym">I</span><sub>T</sub> <span class="op">=</span> <span class="num">1</span>/<span class="num">2</span> <span class="sym">I</span><sub>0</sub>
                </div>

                <p class="small" style="margin-top:10px;"><b>(b)</b> 1 ns pulse bandwidth (order):</p>
                <div class="eq" role="math" aria-label="Final b">
                  Δ<span class="sym">f</span> <span class="op">~</span> <span class="num">1</span>/<span class="sym">τ</span> <span class="op">≈</span> <span class="num">1</span> GHz (often a few GHz for “square-ish”)
                </div>

                <p class="small" style="margin-top:10px;"><b>(c)</b> Deep water ω=√(gk):</p>
                <div class="eq" role="math" aria-label="Final c">
                  <span class="sym">v</span><sub>p</sub><span class="op">=</span>√(g/k),&nbsp;
                  <span class="sym">v</span><sub>g</sub><span class="op">=</span><span class="num">1</span>/<span class="num">2</span>√(g/k)
                  <span class="op">=</span> <span class="sym">v</span><sub>p</sub>/<span class="num">2</span>
                </div>
              </div>

              <div>
                <p class="small"><b>(d)</b> Diffraction-limited Moon→Earth spot (λ=500 nm, D=1 m, L=3.8×10<sup>8</sup> m):</p>
                <div class="eq" role="math" aria-label="Final d">
                  θ <span class="op">≈</span> <span class="num">1.22</span>λ/D <span class="op">≈</span> <span class="num">6.1</span>×<span class="num">10</span><sup class="num">−7</sup> rad,&nbsp;
                  d<sub>spot</sub> <span class="op">≈</span> <span class="num">2</span>θL <span class="op">≈</span> <span class="num">4.6</span>×<span class="num">10</span><sup class="num">2</sup> m <span class="op">≈</span> <span class="num">0.46</span> km
                </div>

                <p class="small" style="margin-top:10px;"><b>(e)</b> Sunglasses sideways:</p>
                <div class="eq" role="math" aria-label="Final e">
                  Lying on your side rotates the polarizer axis, misaligning it with horizontally polarized glare from the lake → less suppression.
                </div>

                <p class="small" style="margin-top:10px;"><b>(f)</b> Grating changes:</p>
                <div class="eq" role="math" aria-label="Final f">
                  d sinθ = mλ.&nbsp; More lines/cm ⇒ smaller d ⇒ larger θ (maxima spread out) but fewer orders (|m|≤d/λ).&nbsp;
                  Longer λ ⇒ larger θ and fewer orders.
                </div>
              </div>
            </div>
          </div>
        </section>

        <section id="viz">
          <h2>Interactive Visualizations</h2>
          <p>
            The visuals below use the same core equations from parts (c) and (d). Use the controls to see how changing
            the wavenumber range affects phase/group velocities, and how changing aperture affects the diffraction spot.
          </p>

          <figure aria-label="Plot of phase and group velocity versus wavenumber with interactive control">
            <div class="canvas-wrap">
              <canvas id="plotCanvas" width="980" height="520" role="img"
                aria-label="Graph: Deep-water waves phase velocity and group velocity versus wavenumber with gridlines and axes."></canvas>

              <div class="controls" role="group" aria-label="Controls for the deep-water velocity plot">
                <div class="control">
                  <label for="kMax">
                    <span>Max wavenumber <span style="color:var(--faint)">(k<sub>max</sub>)</span></span>
                    <span class="readout" id="kMaxReadout">kmax = 10.0 1/m</span>
                  </label>
                  <input id="kMax" type="range" min="1" max="80" step="1" value="10"
                         aria-label="Slider to set maximum wavenumber for the plot" />
                  <div class="small">Plot range: k from 0.2 to k<sub>max</sub> (units 1/m). Uses g = 9.81 m/s².</div>
                </div>

                <div class="control">
                  <button class="btn" id="toggleScale" type="button" aria-label="Toggle linear or log scaling of the horizontal axis">
                    Toggle k-axis: Linear
                  </button>
                  <div class="small" style="margin-top:8px;">
                    Tip: log-k makes it easier to see both low-k and high-k behavior on one graph.
                  </div>
                </div>
              </div>
            </div>
            <figcaption>
              <b>Figure 1.</b> Deep-water dispersion ω=√(gk) implies <span class="sym">v</span><sub>p</sub>=√(g/k) and
              <span class="sym">v</span><sub>g</sub>=½√(g/k). The plot shows both curves with units, gridlines, axes, and a legend.
            </figcaption>
          </figure>

          <figure aria-label="Diagram of diffraction-limited laser beam from Moon to Earth with interactive aperture control">
            <div class="canvas-wrap">
              <canvas id="diagramCanvas" width="980" height="520" role="img"
                aria-label="Diagram: diffraction-limited laser from Moon to Earth showing aperture D, divergence angle, distance L, and resulting spot size with labels."></canvas>

              <div class="controls" role="group" aria-label="Controls for diffraction diagram">
                <div class="control">
                  <label for="aperture">
                    <span>Aperture/beam width <span style="color:var(--faint)">(D)</span></span>
                    <span class="readout" id="apertureReadout">D = 1.00 m</span>
                  </label>
                  <input id="aperture" type="range" min="0.2" max="5" step="0.05" value="1"
                         aria-label="Slider to set the beam width or aperture in meters" />
                  <div class="small">Uses λ = 500 nm, L = 3.8×10<sup>8</sup> m. Updates θ ≈ 1.22λ/D and spot size d ≈ 2θL.</div>
                </div>

                <div class="control">
                  <div class="eq" id="spotReadout" role="math" aria-label="Computed diffraction values">
                    θ <span class="op">≈</span> <span class="num">6.10</span>×<span class="num">10</span><sup class="num">−7</sup> rad,&nbsp;
                    d<sub>spot</sub> <span class="op">≈</span> <span class="num">460</span> m
                  </div>
                  <div class="small">Interpretation: larger D reduces diffraction divergence, shrinking the spot on Earth.</div>
                </div>
              </div>
            </div>
            <figcaption>
              <b>Figure 2.</b> Diffraction-limited geometry: θ ≈ 1.22λ/D and spot diameter d ≈ 2θL. The diagram is not to scale,
              but labels and computed values are physically consistent.
            </figcaption>
          </figure>
        </section>

        <footer>
          <span>© Article-ready HTML • No external assets • Canvas visuals drawn with vanilla JS</span>
          <span>Equations: styled HTML (no MathJax) • Color scheme adapts to light/dark</span>
        </footer>
      </div>
    </article>
  </main>

  <script>
    (() => {
      "use strict";

      // -----------------------
      // Constants used in solution
      // -----------------------
      const g = 9.81;                 // m/s^2
      const lambda = 500e-9;          // m
      const L = 380000e3;             // m (380,000 km)
      const airy = 1.22;              // Airy factor

      // -----------------------
      // Utility helpers
      // -----------------------
      const $ = (id) => document.getElementById(id);

      function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

      function niceNumber(x){
        // format for display: choose fixed or scientific depending on magnitude
        const ax = Math.abs(x);
        if (ax === 0) return "0";
        if (ax >= 1000 || ax < 0.01) {
          return x.toExponential(2).replace("e+", "×10^").replace("e-", "×10^-");
        }
        if (ax >= 100) return x.toFixed(0);
        if (ax >= 10) return x.toFixed(1);
        if (ax >= 1) return x.toFixed(2);
        return x.toFixed(3);
      }

      function getThemeColors(){
        // Read computed CSS variables to keep canvas styling consistent across light/dark.
        const cs = getComputedStyle(document.documentElement);
        return {
          text: cs.getPropertyValue("--text").trim(),
          muted: cs.getPropertyValue("--muted").trim(),
          faint: cs.getPropertyValue("--faint").trim(),
          grid: cs.getPropertyValue("--grid").trim(),
          gridBold: cs.getPropertyValue("--gridBold").trim(),
          accent: cs.getPropertyValue("--accent").trim(),
          accent2: cs.getPropertyValue("--accent2").trim(),
          good: cs.getPropertyValue("--good").trim(),
          warn: cs.getPropertyValue("--warn").trim(),
          bad: cs.getPropertyValue("--bad").trim(),
        };
      }

      function setCanvasHiDPI(canvas){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        const w = Math.max(1, Math.round(rect.width * dpr));
        const h = Math.max(1, Math.round(rect.height * dpr));
        if (canvas.width !== w || canvas.height !== h){
          canvas.width = w; canvas.height = h;
        }
        const ctx = canvas.getContext("2d");
        ctx.setTransform(dpr,0,0,dpr,0,0);
        return ctx;
      }

      // -----------------------
      // Plot 1: vp & vg vs k
      // -----------------------
      const plotCanvas = $("plotCanvas");
      const kMaxSlider = $("kMax");
      const kMaxReadout = $("kMaxReadout");
      const toggleScaleBtn = $("toggleScale");

      let logScale = false;

      function vp(k){ return Math.sqrt(g / k); }
      function vg(k){ return 0.5 * Math.sqrt(g / k); }

      function drawAxes(ctx, x0, y0, w, h, xLabel, yLabel, title){
        const c = getThemeColors();
        ctx.save();
        ctx.translate(0.5, 0.5); // crisp lines
        // Background grid
        ctx.strokeStyle = c.grid;
        ctx.lineWidth = 1;

        const nx = 10, ny = 8;
        for (let i=0;i<=nx;i++){
          const x = x0 + (w*i/nx);
          ctx.beginPath();
          ctx.moveTo(x, y0);
          ctx.lineTo(x, y0+h);
          ctx.stroke();
        }
        for (let j=0;j<=ny;j++){
          const y = y0 + (h*j/ny);
          ctx.beginPath();
          ctx.moveTo(x0, y);
          ctx.lineTo(x0+w, y);
          ctx.stroke();
        }

        // Bold axes box
        ctx.strokeStyle = c.gridBold;
        ctx.lineWidth = 1.5;
        ctx.strokeRect(x0, y0, w, h);

        // Title
        ctx.fillStyle = c.text;
        ctx.font = "700 16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(title, x0, y0 - 14);

        // Axis labels
        ctx.fillStyle = c.muted;
        ctx.font = "13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(xLabel, x0 + w - ctx.measureText(xLabel).width, y0 + h + 28);

        ctx.save();
        ctx.translate(x0 - 42, y0 + h/2);
        ctx.rotate(-Math.PI/2);
        ctx.fillText(yLabel, 0, 0);
        ctx.restore();

        ctx.restore();
      }

      function drawLegend(ctx, x, y, items){
        const c = getThemeColors();
        ctx.save();
        ctx.fillStyle = "rgba(0,0,0,0.0)";
        // Legend background
        const pad = 10;
        let maxW = 0;
        ctx.font = "13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        items.forEach(it => { maxW = Math.max(maxW, ctx.measureText(it.label).width); });
        const boxW = pad*2 + 18 + 8 + maxW;
        const boxH = pad*2 + items.length*18;

        // Use semi-transparent panel
        const isLight = matchMedia("(prefers-color-scheme: light)").matches;
        ctx.fillStyle = isLight ? "rgba(246,247,251,0.75)" : "rgba(11,16,32,0.55)";
        ctx.strokeStyle = c.gridBold;
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.roundRect(x, y, boxW, boxH, 12);
        ctx.fill();
        ctx.stroke();

        // Entries
        ctx.fillStyle = c.text;
        items.forEach((it, idx) => {
          const yy = y + pad + idx*18 + 13;
          ctx.strokeStyle = it.color;
          ctx.lineWidth = 3;
          ctx.beginPath();
          ctx.moveTo(x + pad, yy - 5);
          ctx.lineTo(x + pad + 18, yy - 5);
          ctx.stroke();

          ctx.fillStyle = c.text;
          ctx.fillText(it.label, x + pad + 18 + 8, yy - 1);
        });

        ctx.restore();
      }

      function mapX(k, kMin, kMax, x0, w){
        if (!logScale){
          return x0 + (k - kMin) * (w / (kMax - kMin));
        }
        const a = Math.log10(kMin);
        const b = Math.log10(kMax);
        const t = (Math.log10(k) - a) / (b - a);
        return x0 + t*w;
      }

      function drawPlot(){
        const ctx = setCanvasHiDPI(plotCanvas);
        const c = getThemeColors();
        const rect = plotCanvas.getBoundingClientRect();
        const W = rect.width, H = rect.height;

        // Clear
        ctx.clearRect(0,0,W,H);

        const padL = 70, padR = 26, padT = 52, padB = 60;
        const x0 = padL, y0 = padT;
        const w = W - padL - padR;
        const h = H - padT - padB;

        // Data range
        const kMin = 0.2; // 1/m (avoid singularity at k=0)
        const kMax = Math.max(kMin + 0.01, parseFloat(kMaxSlider.value));
        // y range based on vp at kMin and kMax
        const yMax = vp(kMin);
        const yMin = vg(kMax) * 0.92; // slightly below smallest curve
        const yPad = (yMax - yMin) * 0.08;
        const yLo = Math.max(0, yMin - yPad);
        const yHi = yMax + yPad;

        function mapY(v){
          return y0 + h - (v - yLo) * (h / (yHi - yLo));
        }

        // Axes & grid
        drawAxes(ctx, x0, y0, w, h, "wavenumber k (1/m)", "velocity (m/s)", "Deep-water waves: phase & group velocities vs wavenumber");

        // Tick labels (x and y)
        ctx.save();
        ctx.fillStyle = c.muted;
        ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";

        // y ticks
        const ny = 8;
        for (let j=0;j<=ny;j++){
          const v = yLo + (yHi - yLo) * (j/ny);
          const y = mapY(v);
          ctx.fillText(v.toFixed(v>=10?1:2), x0 - 10 - ctx.measureText(v.toFixed(v>=10?1:2)).width, y+4);
        }

        // x ticks
        const nx = 10;
        for (let i=0;i<=nx;i++){
          let k;
          if (!logScale){
            k = kMin + (kMax - kMin)*(i/nx);
          } else {
            const a = Math.log10(kMin), b = Math.log10(kMax);
            k = Math.pow(10, a + (b-a)*(i/nx));
          }
          const x = mapX(k, kMin, kMax, x0, w);
          const label = (!logScale) ? k.toFixed(k>=10?0:1) : (k>=10? k.toFixed(0) : k.toFixed(1));
          ctx.fillText(label, x - ctx.measureText(label).width/2, y0 + h + 18);
        }
        ctx.restore();

        // Curves
        function drawCurve(fn, color){
          ctx.save();
          ctx.strokeStyle = color;
          ctx.lineWidth = 2.5;
          ctx.beginPath();
          const N = 320;
          for (let i=0;i<=N;i++){
            let k;
            if (!logScale){
              k = kMin + (kMax - kMin)*(i/N);
            } else {
              const a = Math.log10(kMin), b = Math.log10(kMax);
              k = Math.pow(10, a + (b-a)*(i/N));
            }
            const x = mapX(k, kMin, kMax, x0, w);
            const y = mapY(fn(k));
            if (i===0) ctx.moveTo(x,y);
            else ctx.lineTo(x,y);
          }
          ctx.stroke();
          ctx.restore();
        }

        drawCurve(vp, c.accent);
        drawCurve(vg, c.good);

        // Legend
        drawLegend(ctx, x0 + 14, y0 + 12, [
          {label: "phase velocity vp = √(g/k)", color: c.accent},
          {label: "group velocity vg = ½√(g/k)", color: c.good}
        ]);

        // Annotation: ratio
        ctx.save();
        ctx.fillStyle = c.faint;
        ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        const note = "For all k: vg = vp / 2";
        ctx.fillText(note, x0 + w - ctx.measureText(note).width - 8, y0 + 18);
        ctx.restore();
      }

      function updatePlotReadout(){
        const kMax = parseFloat(kMaxSlider.value);
        kMaxReadout.textContent = `kmax = ${kMax.toFixed(1)} 1/m`;
      }

      kMaxSlider.addEventListener("input", () => {
        updatePlotReadout();
        drawPlot();
      });

      toggleScaleBtn.addEventListener("click", () => {
        logScale = !logScale;
        toggleScaleBtn.textContent = `Toggle k-axis: ${logScale ? "Log" : "Linear"}`;
        drawPlot();
      });

      // -----------------------
      // Diagram 2: Diffraction-limited laser
      // -----------------------
      const diagramCanvas = $("diagramCanvas");
      const apertureSlider = $("aperture");
      const apertureReadout = $("apertureReadout");
      const spotReadout = $("spotReadout");

      function thetaFromD(D){ return airy * lambda / D; }          // rad
      function spotDiameter(D){ return 2 * thetaFromD(D) * L; }    // m

      function drawDiffractionDiagram(){
        const ctx = setCanvasHiDPI(diagramCanvas);
        const c = getThemeColors();
        const rect = diagramCanvas.getBoundingClientRect();
        const W = rect.width, H = rect.height;

        ctx.clearRect(0,0,W,H);

        const pad = 28;
        const xL = pad, xR = W - pad;
        const yMid = H * 0.56;

        // Extract parameter
        const D = parseFloat(apertureSlider.value);

        // Computations
        const th = thetaFromD(D);
        const dSpot = spotDiameter(D);

        // Diagram not to scale: compress distance L visually.
        const beamStartX = xL + 120;
        const beamEndX = xR - 140;

        // Visual beam half-height at end based on theta (scaled for visibility)
        // Use a scale factor so that typical theta produces a nice spread on the canvas.
        const spreadScale = 2.2e8; // chosen to make 1e-6 rad visible
        const halfSpread = clamp(th * spreadScale, 10, H * 0.34);

        // Background grid (light)
        ctx.save();
        ctx.translate(0.5,0.5);
        ctx.strokeStyle = c.grid;
        ctx.lineWidth = 1;
        const nx = 12, ny = 8;
        for (let i=0;i<=nx;i++){
          const x = pad + (W-2*pad)*i/nx;
          ctx.beginPath(); ctx.moveTo(x, pad); ctx.lineTo(x, H-pad); ctx.stroke();
        }
        for (let j=0;j<=ny;j++){
          const y = pad + (H-2*pad)*j/ny;
          ctx.beginPath(); ctx.moveTo(pad, y); ctx.lineTo(W-pad, y); ctx.stroke();
        }
        // Frame
        ctx.strokeStyle = c.gridBold;
        ctx.lineWidth = 1.5;
        ctx.strokeRect(pad, pad, W-2*pad, H-2*pad);
        ctx.restore();

        // Title
        ctx.save();
        ctx.fillStyle = c.text;
        ctx.font = "700 16px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText("Diffraction-limited Moon → Earth laser geometry (not to scale)", pad, pad - 10);
        ctx.restore();

        // Moon and Earth stylized discs
        const moonX = xL + 80, moonY = yMid;
        const earthX = xR - 80, earthY = yMid;

        function drawPlanet(x, y, r, fill1, fill2, label){
          ctx.save();
          const grd = ctx.createRadialGradient(x-r*0.3,y-r*0.3,r*0.3,x,y,r);
          grd.addColorStop(0, fill1);
          grd.addColorStop(1, fill2);
          ctx.fillStyle = grd;
          ctx.beginPath(); ctx.arc(x,y,r,0,Math.PI*2); ctx.fill();

          // subtle ring
          ctx.strokeStyle = "rgba(255,255,255,0.12)";
          ctx.lineWidth = 2;
          ctx.beginPath(); ctx.arc(x,y,r+2,0,Math.PI*2); ctx.stroke();

          ctx.fillStyle = c.muted;
          ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
          ctx.fillText(label, x - ctx.measureText(label).width/2, y + r + 18);
          ctx.restore();
        }

        const isLight = matchMedia("(prefers-color-scheme: light)").matches;
        drawPlanet(moonX, moonY, 28, isLight ? "rgba(240,243,248,0.95)" : "rgba(220,225,235,0.92)",
                              isLight ? "rgba(180,190,210,0.90)" : "rgba(120,130,150,0.85)", "Moon");
        drawPlanet(earthX, earthY, 34, isLight ? "rgba(120,220,255,0.95)" : "rgba(80,170,255,0.92)",
                               isLight ? "rgba(40,120,220,0.90)" : "rgba(40,90,170,0.85)", "Earth");

        // Aperture indicator on Moon side
        ctx.save();
        ctx.strokeStyle = c.accent2;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(beamStartX, moonY - 26);
        ctx.lineTo(beamStartX, moonY + 26);
        ctx.stroke();
        ctx.fillStyle = c.muted;
        ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText("Aperture / beam width D", beamStartX - 60, moonY - 34);

        // D bracket
        ctx.strokeStyle = c.accent2;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(beamStartX - 14, moonY - 26);
        ctx.lineTo(beamStartX - 14, moonY + 26);
        ctx.moveTo(beamStartX - 22, moonY - 26);
        ctx.lineTo(beamStartX - 6, moonY - 26);
        ctx.moveTo(beamStartX - 22, moonY + 26);
        ctx.lineTo(beamStartX - 6, moonY + 26);
        ctx.stroke();

        ctx.fillStyle = c.text;
        ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(`D = ${D.toFixed(2)} m`, beamStartX - 84, moonY + 6);
        ctx.restore();

        // Beam (triangular wedge)
        ctx.save();
        ctx.globalAlpha = 0.95;

        // Beam fill gradient
        const beamGrad = ctx.createLinearGradient(beamStartX, 0, beamEndX, 0);
        beamGrad.addColorStop(0, isLight ? "rgba(167,139,250,0.18)" : "rgba(167,139,250,0.20)");
        beamGrad.addColorStop(1, isLight ? "rgba(125,211,252,0.18)" : "rgba(125,211,252,0.22)");
        ctx.fillStyle = beamGrad;

        ctx.beginPath();
        ctx.moveTo(beamStartX, yMid - 4);
        ctx.lineTo(beamEndX, yMid - halfSpread);
        ctx.lineTo(beamEndX, yMid + halfSpread);
        ctx.lineTo(beamStartX, yMid + 4);
        ctx.closePath();
        ctx.fill();

        // Beam outline
        ctx.strokeStyle = c.accent;
        ctx.lineWidth = 2.2;
        ctx.beginPath();
        ctx.moveTo(beamStartX, yMid);
        ctx.lineTo(beamEndX, yMid - halfSpread);
        ctx.moveTo(beamStartX, yMid);
        ctx.lineTo(beamEndX, yMid + halfSpread);
        ctx.stroke();
        ctx.restore();

        // Distance label (compressed visually)
        ctx.save();
        ctx.strokeStyle = c.gridBold;
        ctx.lineWidth = 2;
        const yDist = yMid + halfSpread + 42;
        ctx.beginPath();
        ctx.moveTo(beamStartX, yDist);
        ctx.lineTo(beamEndX, yDist);
        ctx.stroke();

        // Arrow heads
        ctx.fillStyle = c.gridBold;
        ctx.beginPath();
        ctx.moveTo(beamStartX, yDist);
        ctx.lineTo(beamStartX + 10, yDist - 6);
        ctx.lineTo(beamStartX + 10, yDist + 6);
        ctx.closePath();
        ctx.fill();

        ctx.beginPath();
        ctx.moveTo(beamEndX, yDist);
        ctx.lineTo(beamEndX - 10, yDist - 6);
        ctx.lineTo(beamEndX - 10, yDist + 6);
        ctx.closePath();
        ctx.fill();

        ctx.fillStyle = c.muted;
        ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        const Llabel = "Distance L = 3.8×10^8 m";
        ctx.fillText(Llabel, (beamStartX + beamEndX)/2 - ctx.measureText(Llabel).width/2, yDist - 10);
        ctx.restore();

        // Divergence angle annotation
        ctx.save();
        ctx.strokeStyle = c.good;
        ctx.lineWidth = 2;
        ctx.beginPath();
        // small angle arc at start
        const rArc = 46;
        ctx.arc(beamStartX, yMid, rArc, -0.22, 0.22);
        ctx.stroke();

        ctx.fillStyle = c.good;
        ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        const thText = `θ ≈ 1.22λ/D = ${th.toExponential(2)} rad`;
        ctx.fillText("Divergence angle", beamStartX + 10, yMid - 58);
        ctx.fillStyle = c.muted;
        ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText(thText.replace("e-","×10^-").replace("e+","×10^"), beamStartX + 10, yMid - 40);
        ctx.restore();

        // Spot size label at Earth side
        ctx.save();
        ctx.strokeStyle = c.warn;
        ctx.lineWidth = 2.2;
        // bracket at end showing 2*halfSpread (visual)
        ctx.beginPath();
        ctx.moveTo(beamEndX + 18, yMid - halfSpread);
        ctx.lineTo(beamEndX + 18, yMid + halfSpread);
        ctx.moveTo(beamEndX + 10, yMid - halfSpread);
        ctx.lineTo(beamEndX + 26, yMid - halfSpread);
        ctx.moveTo(beamEndX + 10, yMid + halfSpread);
        ctx.lineTo(beamEndX + 26, yMid + halfSpread);
        ctx.stroke();

        ctx.fillStyle = c.warn;
        ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText("Spot diameter (concept)", beamEndX - 30, yMid - halfSpread - 14);

        ctx.fillStyle = c.muted;
        ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        const dText = `d ≈ 2θL = ${dSpot.toFixed(0)} m`;
        ctx.fillText(dText, beamEndX - 30, yMid - halfSpread + 4);
        ctx.restore();

        // Small note: not to scale
        ctx.save();
        ctx.fillStyle = c.faint;
        ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
        ctx.fillText("Note: geometry is compressed for display (values computed exactly).", pad + 2, H - pad + 18);
        ctx.restore();

        // Update readouts
        apertureReadout.textContent = `D = ${D.toFixed(2)} m`;
        const thStr = th.toExponential(2);
        spotReadout.innerHTML =
          `θ <span class="op">≈</span> <span class="num">${thStr.split("e")[0]}</span>×<span class="num">10</span><sup class="num">${thStr.split("e")[1]}</sup> rad,&nbsp;
           d<sub>spot</sub> <span class="op">≈</span> <span class="num">${dSpot.toFixed(0)}</span> m`;
      }

      apertureSlider.addEventListener("input", () => {
        drawDiffractionDiagram();
      });

      // -----------------------
      // Handle resize + theme changes
      // -----------------------
      function redrawAll(){
        updatePlotReadout();
        drawPlot();
        drawDiffractionDiagram();
      }

      // Initial draw (after layout)
      window.addEventListener("load", redrawAll);
      window.addEventListener("resize", () => {
        // Debounce a bit to avoid thrash
        clearTimeout(window.__vizTO);
        window.__vizTO = setTimeout(redrawAll, 90);
      });

      // Repaint when system theme changes (light/dark)
      const mql = matchMedia("(prefers-color-scheme: light)");
      if (mql && mql.addEventListener){
        mql.addEventListener("change", redrawAll);
      }

      // Polyfill for roundRect on older browsers
      if (!CanvasRenderingContext2D.prototype.roundRect){
        CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
          r = Math.min(r, w/2, h/2);
          this.beginPath();
          this.moveTo(x+r, y);
          this.arcTo(x+w, y, x+w, y+h, r);
          this.arcTo(x+w, y+h, x, y+h, r);
          this.arcTo(x, y+h, x, y, r);
          this.arcTo(x, y, x+w, y, r);
          this.closePath();
          return this;
        };
      }

    })();
  </script>
</body>
</html>
