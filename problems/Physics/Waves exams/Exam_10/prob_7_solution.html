<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Discharging a Capacitor in a Series RLC Circuit — Critical Damping Solution</title>
  <style>
    :root{
      --bg: #0b1020;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.09);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.72);
      --faint: rgba(255,255,255,0.55);
      --line: rgba(255,255,255,0.14);
      --accent: #7dd3fc;
      --accent2:#a78bfa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 18px 45px rgba(0,0,0,0.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1100px 700px at 18% 12%, rgba(125,211,252,0.20), transparent 55%),
        radial-gradient(900px 600px at 85% 22%, rgba(167,139,250,0.18), transparent 55%),
        radial-gradient(900px 700px at 55% 92%, rgba(52,211,153,0.12), transparent 55%),
        linear-gradient(180deg, #070a14, #0b1020 55%, #070a14);
      line-height:1.55;
      overflow-x:hidden;
    }

    a{color:inherit; text-decoration:none}
    a:hover{opacity:0.95; text-decoration:underline}

    header.hero{
      padding: clamp(22px, 4vw, 44px) clamp(16px, 4vw, 44px);
      max-width: 1200px;
      margin: 0 auto;
      position: relative;
    }
    .hero .kicker{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:8px 12px;
      border:1px solid var(--line);
      border-radius: 999px;
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      box-shadow: var(--shadow);
      font-size: 13px;
      color: var(--muted);
      letter-spacing:0.2px;
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background: radial-gradient(circle at 30% 30%, #fff, var(--accent));
      box-shadow: 0 0 0 6px rgba(125,211,252,0.10);
    }
    h1{
      margin:14px 0 8px;
      font-size: clamp(26px, 4vw, 44px);
      line-height: 1.1;
      letter-spacing: -0.02em;
    }
    .subtitle{
      margin: 0 0 16px;
      color: var(--muted);
      max-width: 70ch;
      font-size: clamp(14px, 1.9vw, 17px);
    }

    .layout{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 clamp(12px, 4vw, 44px) clamp(30px, 6vw, 60px);
      display:grid;
      grid-template-columns: 310px 1fr;
      gap: 18px;
      align-items:start;
    }

    /* Sticky TOC */
    nav.toc{
      position: sticky;
      top: 14px;
      align-self:start;
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.08), rgba(255,255,255,0.04));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .toc header{
      padding: 14px 14px 10px;
      border-bottom: 1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap: 10px;
    }
    .toc header strong{font-size: 14px; letter-spacing:0.2px}
    .toc header .mini{
      font-size: 12px;
      color: var(--faint);
      white-space:nowrap;
    }
    .toc ol{
      margin:0;
      padding: 10px 14px 14px 18px;
      display:grid;
      gap: 8px;
      list-style: decimal;
      color: var(--muted);
    }
    .toc li{
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      transition: transform 160ms ease, background 160ms ease, border-color 160ms ease;
    }
    .toc li:hover{
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
      transform: translateY(-1px);
    }
    .toc a{display:block}
    .toc small{display:block; color: var(--faint); font-size:12px; margin-top:2px}

    main{
      display:grid;
      gap: 18px;
      min-width:0;
    }

    .card{
      border: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.075), rgba(255,255,255,0.035));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      position: relative;
    }
    .card .head{
      padding: 16px 16px 12px;
      border-bottom: 1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:flex-start;
      gap: 14px;
    }
    .card .head h2{
      margin:0;
      font-size: 16px;
      letter-spacing:0.2px;
    }
    .card .head p{
      margin: 4px 0 0;
      color: var(--muted);
      font-size: 13px;
      max-width: 68ch;
    }
    .card .body{
      padding: 16px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap: 14px;
      align-items:start;
    }

    .quick{
      display:grid;
      gap: 10px;
    }
    .bullets{
      margin:0;
      padding-left: 18px;
      color: var(--muted);
    }
    .bullets li{margin: 6px 0}

    .callouts{
      display:grid;
      gap: 10px;
    }
    .callout{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .callout .tag{
      display:inline-flex;
      align-items:center;
      gap: 8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 12px;
      color: var(--muted);
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.05);
      margin-bottom: 8px;
      user-select:none;
    }
    .tag .pill{width:8px;height:8px;border-radius:50%}
    .pill.ok{background: var(--ok)}
    .pill.warn{background: var(--warn)}
    .pill.bad{background: var(--bad)}
    .callout p{margin:0; color: var(--muted); font-size: 13px}

    .eq{
      font-family: var(--mono);
      font-size: 13px;
      line-height: 1.45;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.14);
      padding: 10px 10px;
      border-radius: 14px;
      overflow:auto;
      position: relative;
    }
    .eqRow{
      display:flex;
      gap: 10px;
      align-items: flex-start;
      flex-wrap: wrap;
    }
    .copyBtn{
      appearance:none;
      border: 1px solid rgba(255,255,255,0.16);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      font-size: 12px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      transition: transform 160ms ease, background 160ms ease, border-color 160ms ease;
      user-select:none;
      white-space:nowrap;
    }
    .copyBtn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,0.08);
      border-color: rgba(255,255,255,0.22);
    }
    .copyBtn:active{transform: translateY(0px) scale(0.99)}
    .copyBtn .ic{
      width: 10px; height: 10px;
      border-radius: 3px;
      border:1px solid rgba(255,255,255,0.30);
      background: linear-gradient(135deg, rgba(125,211,252,0.7), rgba(167,139,250,0.6));
    }

    .steps{
      display:grid;
      gap: 10px;
    }
    .step{
      display:grid;
      grid-template-columns: 42px 1fr;
      gap: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .num{
      width: 34px; height: 34px;
      border-radius: 12px;
      display:flex;
      align-items:center;
      justify-content:center;
      font-weight: 700;
      font-size: 13px;
      color: #081018;
      background: linear-gradient(135deg, rgba(125,211,252,0.95), rgba(52,211,153,0.85));
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
    }
    .step h3{margin:0 0 4px; font-size: 14px}
    .step p{margin:0; color: var(--muted); font-size: 13px}

    .boxed{
      border: 1px solid rgba(125,211,252,0.35);
      background: linear-gradient(180deg, rgba(125,211,252,0.12), rgba(0,0,0,0.18));
      border-radius: 18px;
      padding: 14px;
      box-shadow: 0 18px 45px rgba(0,0,0,0.25);
    }
    .boxed h3{margin: 0 0 8px; font-size: 14px}
    .boxed .eq{border-color: rgba(125,211,252,0.30); background: rgba(0,0,0,0.22)}

    .controls{
      display:grid;
      gap: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.16);
      border-radius: 16px;
      padding: 12px;
    }
    .controls .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap: 10px;
      align-items:center;
    }
    label{
      font-size: 13px;
      color: var(--muted);
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    .val{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
      padding: 6px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.05);
      white-space:nowrap;
    }
    .pillNote{
      font-size: 12px;
      color: var(--faint);
      margin-top: 2px;
    }

    .canvasWrap{
      display:grid;
      gap: 10px;
    }
    .canvasCard{
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.18);
      border-radius: 16px;
      padding: 10px;
      overflow:hidden;
    }
    canvas{
      width:100%;
      height: 280px;
      display:block;
    }
    .canvasCard .cap{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap: 12px;
      padding: 6px 6px 10px;
      color: var(--muted);
    }
    .cap strong{color: var(--text); font-size: 13px}
    .cap span{font-size: 12px; color: var(--faint)}
    .legendMini{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 6px;
      padding: 0 6px 4px;
      color: var(--muted);
      font-size: 12px;
    }
    .key{
      display:inline-flex;
      gap: 8px;
      align-items:center;
      padding: 6px 10px;
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 999px;
      background: rgba(255,255,255,0.05);
    }
    .swatch{
      width: 18px; height: 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
    }
    .swatch2{
      width: 18px; height: 4px;
      border-radius: 999px;
      background: linear-gradient(90deg, var(--ok), rgba(125,211,252,0.6));
    }

    footer{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px clamp(16px, 4vw, 44px) 34px;
      color: var(--faint);
      font-size: 12px;
    }

    /* Print-friendly */
    @media print{
      body{background:#fff; color:#000}
      .card, nav.toc{box-shadow:none}
      nav.toc{position: static}
      .copyBtn, .controls{display:none !important}
      .card{break-inside: avoid; background:#fff}
      .eq{background:#f4f4f4; border-color:#ddd}
      canvas{display:none}
      a{text-decoration:underline}
    }

    /* Responsive */
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
      nav.toc{position: relative; top:auto}
      .grid2{grid-template-columns: 1fr}
      canvas{height: 260px}
    }

    /* Subtle entrance animation */
    @keyframes floatIn{
      from{transform: translateY(8px); opacity:0}
      to{transform: translateY(0); opacity:1}
    }
    .card{animation: floatIn 420ms ease both}
    .card:nth-child(2){animation-delay: 40ms}
    .card:nth-child(3){animation-delay: 80ms}
    .card:nth-child(4){animation-delay: 120ms}
  </style>
</head>

<body>
  <header class="hero">
    <div class="kicker"><span class="dot" aria-hidden="true"></span>Series RLC discharge • differential equation • critical damping</div>
    <h1>Discharging a Capacitor in an RLC Circuit (Critical Damping)</h1>
    <p class="subtitle">
      A capacitor initially holds charge <span style="font-family:var(--mono)">q0</span>. At <span style="font-family:var(--mono)">t=0</span> the switch closes, and the circuit evolves according to Kirchhoff’s laws. Below: analysis, roadmap, full derivation, and interactive plots (charge + energy) with a live damping control.
    </p>
  </header>

  <div class="layout">
    <nav class="toc" aria-label="Table of contents">
      <header>
        <strong>Table of Contents</strong>
        <span class="mini">Sticky</span>
      </header>
      <ol>
        <li><a href="#quick">Quick Summary</a><small>Key results at a glance</small></li>
        <li><a href="#part1">PART 1 — Problem Analysis</a><small>What’s given, what’s asked</small></li>
        <li><a href="#part2">PART 2 — Strategy & Tips</a><small>Minimal roadmap (no algebra)</small></li>
        <li><a href="#part3">PART 3 — Full Solution</a><small>Derivation + final boxed answers</small></li>
        <li><a href="#viz">Interactive Visualizations</a><small>Diagram + plots + controls</small></li>
      </ol>
    </nav>

    <main>
      <!-- Quick Summary -->
      <section class="card" id="quick">
        <div class="head">
          <div>
            <h2>Quick Summary</h2>
            <p>For a series RLC discharge with initial capacitor charge <span style="font-family:var(--mono)">q0</span> and zero initial inductor current, the charge obeys a damped oscillator equation.</p>
          </div>
        </div>
        <div class="body grid2">
          <div class="quick">
            <ul class="bullets">
              <li><strong>Differential equation:</strong> <span style="font-family:var(--mono)">L q¨ + R q˙ + (1/C) q = 0</span>.</li>
              <li><strong>Initial conditions:</strong> <span style="font-family:var(--mono)">q(0)=q0</span>, <span style="font-family:var(--mono)">i(0)=q˙(0)=0</span> (inductor current can’t jump).</li>
              <li><strong>Critical damping:</strong> <span style="font-family:var(--mono)">Rcrit = 2√(L/C)</span>.</li>
              <li><strong>Critical solution:</strong> <span style="font-family:var(--mono)">q(t)=q0(1+ω0 t)e^{-ω0 t}</span>, where <span style="font-family:var(--mono)">ω0=1/√(LC)=R/(2L)</span> at critical damping.</li>
              <li><strong>Undamped period (R=0):</strong> <span style="font-family:var(--mono)">T = 2π√(LC)</span>.</li>
            </ul>

            <div class="eqRow">
              <button class="copyBtn" data-copy="L*q''(t) + R*q'(t) + (1/C)*q(t) = 0">
                <span class="ic" aria-hidden="true"></span>Copy ODE
              </button>
              <button class="copyBtn" data-copy="R_crit = 2*sqrt(L/C)">
                <span class="ic" aria-hidden="true"></span>Copy Rcrit
              </button>
              <button class="copyBtn" data-copy="q(t) = q0*(1 + (R*t)/(2*L))*exp(-(R*t)/(2*L))   (critical damping)">
                <span class="ic" aria-hidden="true"></span>Copy q(t) (critical)
              </button>
            </div>
          </div>

          <div class="callouts">
            <div class="callout">
              <div class="tag"><span class="pill ok"></span>Physical picture</div>
              <p>
                The capacitor’s electric energy converts into magnetic energy in the inductor, while the resistor dissipates energy as heat.
                The competition between <span style="font-family:var(--mono)">L</span> (inertia), <span style="font-family:var(--mono)">C</span> (restoring), and <span style="font-family:var(--mono)">R</span> (damping) sets whether the discharge oscillates or not.
              </p>
            </div>
            <div class="callout">
              <div class="tag"><span class="pill warn"></span>Critical damping</div>
              <p>
                “Critical” means the system returns to zero as fast as possible <em>without oscillating</em>.
                It is the boundary between underdamped oscillations and overdamped non-oscillatory decay.
              </p>
            </div>
            <div class="callout">
              <div class="tag"><span class="pill bad"></span>Common pitfall</div>
              <p>
                Mixing up <span style="font-family:var(--mono)">q</span> and <span style="font-family:var(--mono)">i</span>: in a series circuit, <span style="font-family:var(--mono)">i = dq/dt</span>.
                Initial current is <strong>zero</strong> because the inductor resists sudden changes.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- PART 1 -->
      <section class="card" id="part1">
        <div class="head">
          <div>
            <h2>PART 1 — Problem Analysis (no solving yet)</h2>
            <p>We clarify what the circuit does when the switch is closed at <span style="font-family:var(--mono)">t=0</span>, and what must be computed for the critically damped discharge.</p>
          </div>
        </div>
        <div class="body">
          <article>
            <h3 style="margin-top:0">1) Restate the problem (in my own words)</h3>
            <p style="color:var(--muted); margin-top:6px">
              A series circuit contains a capacitor <span style="font-family:var(--mono)">C</span>, an inductor <span style="font-family:var(--mono)">L</span>, and a resistor <span style="font-family:var(--mono)">R</span>, controlled by a switch.
              Initially the switch is open and the capacitor carries charge <span style="font-family:var(--mono)">q0</span>.
              At <span style="font-family:var(--mono)">t=0</span> the switch closes, the capacitor discharges through the RLC loop, and we must write the governing differential equation, apply initial conditions, determine the value of <span style="font-family:var(--mono)">R</span> for critical damping, find the analytic charge <span style="font-family:var(--mono)">q(t)</span> in that critical case, and sketch the behavior using the undamped period <span style="font-family:var(--mono)">T</span> (for <span style="font-family:var(--mono)">R=0</span>) as a time unit.
            </p>

            <h3>2) Given quantities</h3>
            <ul class="bullets">
              <li>Capacitance: <span style="font-family:var(--mono)">C</span></li>
              <li>Inductance: <span style="font-family:var(--mono)">L</span></li>
              <li>Resistance: <span style="font-family:var(--mono)">R</span> (to be tuned for critical damping)</li>
              <li>Initial capacitor charge: <span style="font-family:var(--mono)">q0</span></li>
              <li>Switch closes at: <span style="font-family:var(--mono)">t = 0</span></li>
            </ul>

            <h3>3) Unknowns</h3>
            <ul class="bullets">
              <li>Time-dependent charge: <span style="font-family:var(--mono)">q(t)</span></li>
              <li>Current: <span style="font-family:var(--mono)">i(t)=dq/dt</span></li>
              <li>Critical resistance: <span style="font-family:var(--mono)">Rcrit</span></li>
              <li>Undamped period (for reference scaling): <span style="font-family:var(--mono)">T</span></li>
            </ul>

            <h3>4) What must be found/proved</h3>
            <ul class="bullets">
              <li>(a) Write the ODE satisfied by <span style="font-family:var(--mono)">q(t)</span> during discharge.</li>
              <li>(b) State initial conditions at <span style="font-family:var(--mono)">t=0</span>.</li>
              <li>(c) Find <span style="font-family:var(--mono)">R</span> that yields critical damping.</li>
              <li>(d) Solve for <span style="font-family:var(--mono)">q(t)</span> in the critical case in terms of <span style="font-family:var(--mono)">q0, L, R</span> (and consistent with critical condition).</li>
              <li>(e) Sketch <span style="font-family:var(--mono)">q(t)</span> for critical damping and label time in units of <span style="font-family:var(--mono)">T</span> (undamped period).</li>
            </ul>

            <h3>5) Relevant physical principles & why they apply</h3>
            <ul class="bullets">
              <li><strong>Kirchhoff’s Voltage Law (KVL):</strong> In a lumped-element series loop, the sum of voltage drops is zero. This directly produces the governing differential equation.</li>
              <li><strong>Constitutive relations:</strong>
                <span style="font-family:var(--mono)">vC = q/C</span>, <span style="font-family:var(--mono)">vR = iR</span>, <span style="font-family:var(--mono)">vL = L di/dt</span>.
                These link circuit variables to <span style="font-family:var(--mono)">q</span> and <span style="font-family:var(--mono)">i</span>.
              </li>
              <li><strong>Inductor current continuity:</strong> <span style="font-family:var(--mono)">i(t)</span> cannot change instantaneously (finite <span style="font-family:var(--mono)">L</span>), giving the crucial initial condition.</li>
              <li><strong>Damped harmonic oscillator math:</strong> The ODE is a second-order linear constant-coefficient equation; damping regimes follow from the discriminant of the characteristic polynomial.</li>
            </ul>

            <h3>6) Candidate approaches (2–3) and comparison</h3>
            <div class="callouts">
              <div class="callout">
                <div class="tag"><span class="pill ok"></span>Approach A: KVL in terms of q(t)</div>
                <p>
                  Write KVL: <span style="font-family:var(--mono)">vL + vR + vC = 0</span> and substitute
                  <span style="font-family:var(--mono)">i = dq/dt</span>. This produces a single ODE directly for <span style="font-family:var(--mono)">q(t)</span>.
                  Fastest and cleanest for parts (a)–(d).
                </p>
              </div>
              <div class="callout">
                <div class="tag"><span class="pill warn"></span>Approach B: State-space (q,i)</div>
                <p>
                  Write two first-order equations:
                  <span style="font-family:var(--mono)">q˙=i</span> and
                  <span style="font-family:var(--mono)">L i˙ + R i + q/C = 0</span>.
                  Great for intuition and numerical plots, slightly longer algebra for analytic solution.
                </p>
              </div>
              <div class="callout">
                <div class="tag"><span class="pill bad"></span>Approach C: Energy method (qualitative)</div>
                <p>
                  Track energy <span style="font-family:var(--mono)">E = q²/(2C) + (L i²)/2</span> and dissipation
                  <span style="font-family:var(--mono)">P= i²R</span>.
                  Useful for sanity checks and decay behavior, but not sufficient alone to get the exact <span style="font-family:var(--mono)">q(t)</span>.
                </p>
              </div>
            </div>

            <h3>7) Best approach & justification</h3>
            <p style="color:var(--muted); margin-bottom:0">
              We choose <strong>Approach A (KVL in terms of q)</strong> because it immediately yields the required ODE and enables a direct classification into damping regimes via the characteristic equation. We’ll still use the energy expression as a sanity check and for the interactive secondary plot.
            </p>
          </article>
        </div>
      </section>

      <!-- PART 2 -->
      <section class="card" id="part2">
        <div class="head">
          <div>
            <h2>PART 2 — Strategy & Tips (roadmap only)</h2>
            <p>Minimal plan (no algebra yet). Each step: goal + tool/equation used.</p>
          </div>
        </div>
        <div class="body">
          <div class="steps">
            <div class="step">
              <div class="num">1</div>
              <div>
                <h3>Define variables and sign convention</h3>
                <p>Goal: choose <span style="font-family:var(--mono)">q(t)</span> on the capacitor and current <span style="font-family:var(--mono)">i(t)</span> around the loop. Tool: <span style="font-family:var(--mono)">i = dq/dt</span> in a series loop.</p>
              </div>
            </div>
            <div class="step">
              <div class="num">2</div>
              <div>
                <h3>Write KVL around the series loop</h3>
                <p>Goal: sum voltage drops to zero. Tool: <span style="font-family:var(--mono)">vL + vR + vC = 0</span>.</p>
              </div>
            </div>
            <div class="step">
              <div class="num">3</div>
              <div>
                <h3>Substitute element laws to get an ODE in q(t)</h3>
                <p>Goal: eliminate voltages and current. Tools: <span style="font-family:var(--mono)">vL=L di/dt</span>, <span style="font-family:var(--mono)">vR=Ri</span>, <span style="font-family:var(--mono)">vC=q/C</span>, plus <span style="font-family:var(--mono)">i=q˙</span>.</p>
              </div>
            </div>
            <div class="step">
              <div class="num">4</div>
              <div>
                <h3>State initial conditions at t=0</h3>
                <p>Goal: set constants later. Tools: capacitor initially has <span style="font-family:var(--mono)">q(0)=q0</span>; inductor current continuity gives <span style="font-family:var(--mono)">i(0)=0</span> ⇒ <span style="font-family:var(--mono)">q˙(0)=0</span>.</p>
              </div>
            </div>
            <div class="step">
              <div class="num">5</div>
              <div>
                <h3>Classify damping via characteristic equation</h3>
                <p>Goal: find the critical boundary. Tool: discriminant of <span style="font-family:var(--mono)">r² + (R/L)r + 1/(LC)=0</span>.</p>
              </div>
            </div>
            <div class="step">
              <div class="num">6</div>
              <div>
                <h3>Write the critical-damping form and apply initial conditions</h3>
                <p>Goal: obtain closed-form <span style="font-family:var(--mono)">q(t)</span>. Tool: repeated-root solution <span style="font-family:var(--mono)">(A+Bt)e^{rt}</span>.</p>
              </div>
            </div>
            <div class="step">
              <div class="num">7</div>
              <div>
                <h3>Scale time axis by the undamped period T</h3>
                <p>Goal: sketch/plot with <span style="font-family:var(--mono)">t/T</span>. Tool: for <span style="font-family:var(--mono)">R=0</span>, <span style="font-family:var(--mono)">ω0=1/√(LC)</span> and <span style="font-family:var(--mono)">T=2π/ω0</span>.</p>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="callout">
            <div class="tag"><span class="pill warn"></span>Common mistakes & quick tips</div>
            <p>
              • Don’t set <span style="font-family:var(--mono)">q˙(0)</span> from “discharging” intuition—use <strong>inductor current continuity</strong>: <span style="font-family:var(--mono)">i(0)=0</span>.<br/>
              • Keep track that <span style="font-family:var(--mono)">ω0=1/√(LC)</span> is the <em>undamped</em> natural frequency; with damping, the oscillation (if any) uses <span style="font-family:var(--mono)">ωd</span>.<br/>
              • Check units: <span style="font-family:var(--mono)">R</span> should come out in ohms and <span style="font-family:var(--mono)">Rt/L</span> must be dimensionless.
            </p>
          </div>
        </div>
      </section>

      <!-- PART 3 -->
      <section class="card" id="part3">
        <div class="head">
          <div>
            <h2>PART 3 — Full Solution</h2>
            <p>Physical intuition first, then step-by-step derivation. Final results boxed, followed by sanity checks.</p>
          </div>
        </div>
        <div class="body">
          <article>
            <h3 style="margin-top:0">Physical intuition</h3>
            <p style="color:var(--muted)">
              When the switch closes, the charged capacitor creates a voltage that drives current through the inductor and resistor.
              The inductor resists an instantaneous jump in current, so initially the current is zero. As current builds, energy
              sloshes between the capacitor’s electric field and the inductor’s magnetic field, while the resistor continuously
              drains energy as heat. If <span style="font-family:var(--mono)">R</span> is small, you see decaying oscillations (underdamped).
              If <span style="font-family:var(--mono)">R</span> is large, the system returns to zero without oscillating (overdamped).
              Exactly at the boundary is <strong>critical damping</strong>, the fastest non-oscillatory return to equilibrium.
            </p>

            <hr style="border:0;border-top:1px solid var(--line); margin: 14px 0;"/>

            <h3>(a) Differential equation for q(t)</h3>
            <p style="color:var(--muted); margin-top:6px">
              Choose a loop current <span style="font-family:var(--mono)">i(t)</span> and capacitor charge <span style="font-family:var(--mono)">q(t)</span> (same sign convention consistently).
              In a series circuit, <span style="font-family:var(--mono)">i(t)=dq/dt</span>.
            </p>

            <p style="color:var(--muted)">
              Apply Kirchhoff’s Voltage Law around the loop:
            </p>
            <div class="eq">
              vL(t) + vR(t) + vC(t) = 0
            </div>

            <p style="color:var(--muted)">
              Substitute element relations:
              <span style="font-family:var(--mono)">vL = L di/dt</span>,
              <span style="font-family:var(--mono)">vR = R i</span>,
              <span style="font-family:var(--mono)">vC = q/C</span>,
              and <span style="font-family:var(--mono)">i = q˙</span>.
            </p>

            <div class="eq">
              L (di/dt) + R i + (q/C) = 0
              <br/>
              i = q˙  ⇒  di/dt = q¨
              <br/>
              Therefore:  L q¨(t) + R q˙(t) + (1/C) q(t) = 0
            </div>

            <div class="eqRow" style="margin-top:10px">
              <button class="copyBtn" data-copy="L*q''(t) + R*q'(t) + (1/C)*q(t) = 0">
                <span class="ic" aria-hidden="true"></span>Copy (a)
              </button>
            </div>

            <h3 style="margin-top:18px">(b) Initial conditions</h3>
            <p style="color:var(--muted)">
              Initially the capacitor is charged to <span style="font-family:var(--mono)">q0</span>, so:
            </p>
            <div class="eq">q(0) = q0</div>

            <p style="color:var(--muted)">
              The inductor current cannot change instantaneously. Since the switch was open before <span style="font-family:var(--mono)">t=0</span>,
              the loop current was zero, hence:
            </p>
            <div class="eq">
              i(0) = 0
              <br/>
              but i(t) = q˙(t)  ⇒  q˙(0) = 0
            </div>

            <h3 style="margin-top:18px">(c) Condition for critical damping</h3>
            <p style="color:var(--muted)">
              Solve the ODE using a trial solution <span style="font-family:var(--mono)">q(t)=e^{rt}</span>, giving the characteristic equation:
            </p>
            <div class="eq">
              L r² + R r + (1/C) = 0
              <br/>
              r² + (R/L) r + 1/(LC) = 0
            </div>

            <p style="color:var(--muted)">
              Critical damping occurs when the discriminant is zero:
              <span style="font-family:var(--mono)">(R/L)² - 4/(LC) = 0</span>.
            </p>
            <div class="eq">
              (R/L)² = 4/(LC)
              <br/>
              ⇒ Rcrit = 2 √(L/C)
            </div>

            <div class="eqRow" style="margin-top:10px">
              <button class="copyBtn" data-copy="R_crit = 2*sqrt(L/C)">
                <span class="ic" aria-hidden="true"></span>Copy (c)
              </button>
            </div>

            <h3 style="margin-top:18px">(d) Analytic expression for q(t) at critical damping</h3>
            <p style="color:var(--muted)">
              At critical damping the characteristic equation has a repeated root
              <span style="font-family:var(--mono)">r = -R/(2L)</span>.
              The general critically damped solution is:
            </p>
            <div class="eq">
              q(t) = (A + B t) e^{rt},  where  r = -R/(2L)
            </div>

            <p style="color:var(--muted)">
              Apply the initial conditions.
            </p>
            <div class="eq">
              q(0)=q0  ⇒  A = q0
            </div>

            <p style="color:var(--muted)">
              Next use <span style="font-family:var(--mono)">q˙(0)=0</span>. Differentiate:
            </p>
            <div class="eq">
              q(t) = (A + Bt)e^{rt}
              <br/>
              q˙(t) = B e^{rt} + (A + Bt) r e^{rt}
              <br/>
              q˙(0) = B + A r = 0  ⇒  B = -A r
            </div>

            <p style="color:var(--muted)">
              With <span style="font-family:var(--mono)">A=q0</span> and <span style="font-family:var(--mono)">r=-R/(2L)</span>, we get
              <span style="font-family:var(--mono)">B = q0 (R/(2L))</span>. Therefore:
            </p>

            <div class="boxed">
              <h3>Critical-damping charge</h3>
              <div class="eq" id="finalEq">
                q(t) = q0 (1 + (R t)/(2L)) exp(-(R t)/(2L))   (for R = Rcrit)
              </div>
              <div class="eq" style="margin-top:10px">
                Equivalent form using ω0 = 1/√(LC):
                <br/>
                At critical: ω0 = R/(2L) and q(t) = q0 (1 + ω0 t) e^{-ω0 t}
              </div>
              <div class="eqRow" style="margin-top:10px">
                <button class="copyBtn" data-copy="q(t) = q0*(1 + (R*t)/(2*L))*exp(-(R*t)/(2*L))   (critical damping: R=Rcrit)">
                  <span class="ic" aria-hidden="true"></span>Copy (d) final
                </button>
              </div>
            </div>

            <h3 style="margin-top:18px">(e) Sketch q(t) for critical damping, with time in units of T</h3>
            <p style="color:var(--muted)">
              The undamped natural frequency (when <span style="font-family:var(--mono)">R=0</span>) is
              <span style="font-family:var(--mono)">ω0 = 1/√(LC)</span>, so the undamped period is:
            </p>
            <div class="eq">
              T = 2π/ω0 = 2π √(LC)
            </div>

            <p style="color:var(--muted)">
              In critical damping, <span style="font-family:var(--mono)">q(t)</span> decreases monotonically from <span style="font-family:var(--mono)">q0</span> to 0 without oscillating.
              The interactive plot below shows the sketch with the horizontal axis in units of <span style="font-family:var(--mono)">t/T</span>.
            </p>

            <hr style="border:0;border-top:1px solid var(--line); margin: 16px 0;"/>

            <h3>Sanity checks</h3>
            <div class="callouts">
              <div class="callout">
                <div class="tag"><span class="pill ok"></span>Units</div>
                <p>
                  In <span style="font-family:var(--mono)">L q¨ + R q˙ + (1/C) q = 0</span>:
                  <br/>
                  <span style="font-family:var(--mono)">L q¨</span> has units <span style="font-family:var(--mono)">H·C/s² = (V·s/A)·C/s² = V</span>;
                  <span style="font-family:var(--mono)">R q˙</span> has <span style="font-family:var(--mono)">Ω·C/s = V</span>;
                  <span style="font-family:var(--mono)">(1/C)q</span> has <span style="font-family:var(--mono)">C/F = V</span>. Consistent.
                </p>
              </div>
              <div class="callout">
                <div class="tag"><span class="pill warn"></span>Limiting cases</div>
                <p>
                  • If <span style="font-family:var(--mono)">R → 0</span>, the ODE becomes <span style="font-family:var(--mono)">q¨ + ω0² q = 0</span>, giving undamped oscillations of period <span style="font-family:var(--mono)">T=2π√(LC)</span>.<br/>
                  • If <span style="font-family:var(--mono)">R</span> is very large (overdamped), discharge is slow and non-oscillatory.
                </p>
              </div>
              <div class="callout">
                <div class="tag"><span class="pill bad"></span>Physical interpretation</div>
                <p>
                  The exponential factor <span style="font-family:var(--mono)">exp(-(R t)/(2L))</span> reflects resistive energy loss.
                  The prefactor <span style="font-family:var(--mono)">(1 + (R t)/(2L))</span> is characteristic of a repeated root:
                  it ensures the decay is as fast as possible without crossing zero (no oscillation).
                </p>
              </div>
            </div>
          </article>
        </div>
      </section>

      <!-- Visualizations -->
      <section class="card" id="viz">
        <div class="head">
          <div>
            <h2>Interactive Visualizations (Canvas + Live Control)</h2>
            <p>
              Controls update <strong>all</strong> graphics: the circuit diagram shows the damping regime, the main plot shows <span style="font-family:var(--mono)">q(t)/q0</span> vs <span style="font-family:var(--mono)">t/T</span>, and the secondary plot shows energy decay.
              Example values are used for visualization only.
            </p>
          </div>
        </div>
        <div class="body grid2">
          <div class="controls" aria-label="Interactive controls">
            <div class="row">
              <label for="L">Inductance L (example)</label>
              <span class="val" id="Lval"></span>
            </div>
            <input id="L" type="range" min="1" max="100" value="10" />
            <div class="pillNote">Slider units: mH (millihenry)</div>

            <div class="row" style="margin-top:8px">
              <label for="C">Capacitance C (example)</label>
              <span class="val" id="Cval"></span>
            </div>
            <input id="C" type="range" min="0.10" max="10.00" step="0.05" value="1.00" />
            <div class="pillNote">Slider units: µF (microfarad)</div>

            <div class="row" style="margin-top:8px">
              <label for="Rratio">Resistance R as a multiple of R<sub>crit</sub></label>
              <span class="val" id="Rval"></span>
            </div>
            <input id="Rratio" type="range" min="0.00" max="3.00" step="0.01" value="1.00" />
            <div class="pillNote">
              <span id="regimeNote"></span>
            </div>

            <div class="row" style="margin-top:10px">
              <button class="copyBtn" id="copyParams">
                <span class="ic" aria-hidden="true"></span>Copy current parameters
              </button>
              <button class="copyBtn" id="reset">
                <span class="ic" aria-hidden="true"></span>Reset to critical
              </button>
            </div>
          </div>

          <div class="canvasWrap">
            <div class="canvasCard">
              <div class="cap">
                <strong>1) Circuit Diagram (Setup)</strong>
                <span>Series RLC with switch (illustrative)</span>
              </div>
              <canvas id="circuit" aria-label="Circuit diagram canvas"></canvas>
            </div>

            <div class="canvasCard">
              <div class="cap">
                <strong>2) Main Plot: Charge vs Time</strong>
                <span>y: q(t)/q0, x: t/T (T = 2π√(LC) for R=0)</span>
              </div>
              <canvas id="plotQ" aria-label="Charge plot canvas"></canvas>
              <div class="legendMini">
                <span class="key"><span class="swatch"></span> q(t)/q0</span>
              </div>
            </div>

            <div class="canvasCard">
              <div class="cap">
                <strong>3) Secondary Plot: Energy vs Time</strong>
                <span>y: E(t)/E0, x: t/T</span>
              </div>
              <canvas id="plotE" aria-label="Energy plot canvas"></canvas>
              <div class="legendMini">
                <span class="key"><span class="swatch2"></span> E(t)/E0</span>
              </div>
            </div>
          </div>
        </div>
      </section>

    </main>
  </div>

  <footer>
    Built as a self-contained HTML article (no external libraries). Plots use example parameters for visualization; the final analytic results above remain symbolic.
  </footer>

  <script>
    // ---------- Copy buttons (plain text) ----------
    (function setupCopy(){
      function toast(msg){
        const t = document.createElement('div');
        t.textContent = msg;
        t.style.position = 'fixed';
        t.style.left = '50%';
        t.style.bottom = '18px';
        t.style.transform = 'translateX(-50%)';
        t.style.padding = '10px 12px';
        t.style.background = 'rgba(0,0,0,0.75)';
        t.style.border = '1px solid rgba(255,255,255,0.18)';
        t.style.borderRadius = '14px';
        t.style.color = 'rgba(255,255,255,0.92)';
        t.style.fontSize = '12px';
        t.style.zIndex = '9999';
        t.style.boxShadow = '0 18px 45px rgba(0,0,0,0.35)';
        t.style.backdropFilter = 'blur(8px)';
        t.style.opacity = '0';
        t.style.transition = 'opacity 160ms ease, transform 160ms ease';
        document.body.appendChild(t);
        requestAnimationFrame(()=>{ t.style.opacity='1'; t.style.transform='translateX(-50%) translateY(-2px)'; });
        setTimeout(()=>{ t.style.opacity='0'; t.style.transform='translateX(-50%) translateY(6px)'; }, 950);
        setTimeout(()=>{ t.remove(); }, 1200);
      }

      async function copyText(txt){
        try{
          await navigator.clipboard.writeText(txt);
          toast('Copied to clipboard');
        }catch(e){
          // fallback
          const ta = document.createElement('textarea');
          ta.value = txt;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          ta.remove();
          toast('Copied to clipboard');
        }
      }

      document.querySelectorAll('[data-copy]').forEach(btn=>{
        btn.addEventListener('click', ()=> copyText(btn.getAttribute('data-copy')));
      });

      document.getElementById('copyParams').addEventListener('click', ()=>{
        const s = stateSummary();
        copyText(s);
      });
    })();

    // ---------- Math helpers ----------
    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

    // Charge solution q(t) for series RLC with q(0)=q0, i(0)=q'(0)=0.
    // Using:
    //   q'' + (R/L) q' + (1/(LC)) q = 0
    // Define α = R/(2L), ω0 = 1/√(LC).
    // Underdamped: α < ω0
    //   q/q0 = e^{-α t} [ cos(ωd t) + (α/ωd) sin(ωd t) ]
    // Critical: α = ω0
    //   q/q0 = (1 + α t) e^{-α t}
    // Overdamped: α > ω0
    //   roots r1, r2 = -α ± √(α^2 - ω0^2)
    //   with q(0)=q0, q'(0)=0 => q/q0 = (r2 e^{r1 t} - r1 e^{r2 t})/(r2 - r1)
    function qNorm(t, L, C, R){
      const alpha = R/(2*L);
      const w0 = 1/Math.sqrt(L*C);
      const eps = 1e-10;
      if (Math.abs(alpha - w0) < 1e-6*w0){
        return (1 + alpha*t) * Math.exp(-alpha*t);
      } else if (alpha < w0){
        const wd = Math.sqrt(w0*w0 - alpha*alpha);
        return Math.exp(-alpha*t) * (Math.cos(wd*t) + (alpha/wd)*Math.sin(wd*t));
      } else {
        const s = Math.sqrt(Math.max(0, alpha*alpha - w0*w0));
        const r1 = -alpha + s;
        const r2 = -alpha - s;
        // Avoid divide by zero:
        if (Math.abs(r2 - r1) < eps){
          return (1 + alpha*t) * Math.exp(-alpha*t);
        }
        return (r2*Math.exp(r1*t) - r1*Math.exp(r2*t)) / (r2 - r1);
      }
    }

    function qPrimeNorm(t, L, C, R){
      // derivative of q/q0 with respect to t
      const alpha = R/(2*L);
      const w0 = 1/Math.sqrt(L*C);
      const eps = 1e-10;
      if (Math.abs(alpha - w0) < 1e-6*w0){
        // q = (1+αt)e^{-αt} => q' = αe^{-αt} - α(1+αt)e^{-αt} = -α^2 t e^{-αt}
        return -alpha*alpha * t * Math.exp(-alpha*t);
      } else if (alpha < w0){
        const wd = Math.sqrt(w0*w0 - alpha*alpha);
        const e = Math.exp(-alpha*t);
        const cos = Math.cos(wd*t);
        const sin = Math.sin(wd*t);
        // q = e [cos + (α/wd) sin]
        // q' = e[-α(cos+(α/wd)sin) + (-wd sin) + (α/wd)(wd cos)]
        //     = e[ -α cos - (α^2/wd) sin - wd sin + α cos ]
        //     = e[ -(wd + α^2/wd) sin ]
        return e * (-(wd + (alpha*alpha)/wd) * sin);
      } else {
        const s = Math.sqrt(Math.max(0, alpha*alpha - w0*w0));
        const r1 = -alpha + s;
        const r2 = -alpha - s;
        if (Math.abs(r2 - r1) < eps){
          return -alpha*alpha * t * Math.exp(-alpha*t);
        }
        // q = (r2 e^{r1 t} - r1 e^{r2 t})/(r2-r1)
        // q' = (r2 r1 e^{r1 t} - r1 r2 e^{r2 t})/(r2-r1) = (r1 r2 (e^{r1 t} - e^{r2 t}))/(r2-r1)
        const num = (r1*r2)*(Math.exp(r1*t) - Math.exp(r2*t));
        return num/(r2 - r1);
      }
    }

    function energyNorm(t, L, C, R){
      // E = q^2/(2C) + (L i^2)/2, i = q'
      // Normalize by E0 = q0^2/(2C) since i(0)=0
      const qn = qNorm(t,L,C,R);
      const qpn = qPrimeNorm(t,L,C,R); // (1/q0) dq/dt
      // q = q0 qn; i = q0 qpn
      // E/E0 = (q0^2 qn^2/(2C) + L q0^2 qpn^2/2) / (q0^2/(2C)) = qn^2 + L C qpn^2
      return qn*qn + (L*C)*qpn*qpn;
    }

    // ---------- Canvas drawing helpers ----------
    function setupHiDPICanvas(canvas){
      const ctx = canvas.getContext('2d');
      function resize(){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.max(2, Math.floor(rect.width * dpr));
        canvas.height = Math.max(2, Math.floor(rect.height * dpr));
        ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
        return {w: rect.width, h: rect.height, dpr};
      }
      return {ctx, resize};
    }

    function drawGrid(ctx, x0,y0,w,h, xTicks, yTicks){
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.10)';
      ctx.lineWidth = 1;
      // vertical
      for(let i=0;i<=xTicks;i++){
        const x = x0 + (w*i/xTicks);
        ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y0+h); ctx.stroke();
      }
      // horizontal
      for(let j=0;j<=yTicks;j++){
        const y = y0 + (h*j/yTicks);
        ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x0+w,y); ctx.stroke();
      }
      ctx.restore();
    }

    function drawAxes(ctx, x0,y0,w,h, xLabel, yLabel){
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.22)';
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.rect(x0,y0,w,h);
      ctx.stroke();

      ctx.fillStyle = 'rgba(255,255,255,0.78)';
      ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(xLabel, x0 + w - ctx.measureText(xLabel).width, y0 + h + 18);
      ctx.save();
      ctx.translate(x0 - 28, y0 + 12);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();
      ctx.restore();
    }

    function drawTicks(ctx, x0,y0,w,h, xMin,xMax, yMin,yMax, xN, yN){
      ctx.save();
      ctx.fillStyle = 'rgba(255,255,255,0.68)';
      ctx.font = '11px var(--mono)';
      ctx.strokeStyle = 'rgba(255,255,255,0.22)';
      ctx.lineWidth = 1;

      // x ticks
      for(let i=0;i<=xN;i++){
        const x = x0 + w*i/xN;
        const v = xMin + (xMax-xMin)*i/xN;
        ctx.beginPath();
        ctx.moveTo(x, y0+h);
        ctx.lineTo(x, y0+h+5);
        ctx.stroke();
        const txt = (Math.abs(v) < 1e-9) ? '0' : (Number(v.toFixed(2)).toString());
        const tw = ctx.measureText(txt).width;
        ctx.fillText(txt, x - tw/2, y0+h+18);
      }
      // y ticks
      for(let j=0;j<=yN;j++){
        const y = y0 + h*(1 - j/yN);
        const v = yMin + (yMax-yMin)*j/yN;
        ctx.beginPath();
        ctx.moveTo(x0-5, y);
        ctx.lineTo(x0, y);
        ctx.stroke();
        const txt = (Math.abs(v) < 1e-9) ? '0' : (Number(v.toFixed(2)).toString());
        const tw = ctx.measureText(txt).width;
        ctx.fillText(txt, x0-8 - tw, y+4);
      }
      ctx.restore();
    }

    function plotLine(ctx, x0,y0,w,h, xs, ys, xMin,xMax, yMin,yMax, gradientA='rgba(125,211,252,0.95)', gradientB='rgba(167,139,250,0.90)'){
      const mapX = x => x0 + (x - xMin) * w / (xMax - xMin);
      const mapY = y => y0 + (yMax - y) * h / (yMax - yMin);

      ctx.save();
      ctx.lineWidth = 2.2;
      const grad = ctx.createLinearGradient(x0, y0, x0+w, y0);
      grad.addColorStop(0, gradientA);
      grad.addColorStop(1, gradientB);
      ctx.strokeStyle = grad;

      ctx.beginPath();
      for(let i=0;i<xs.length;i++){
        const X = mapX(xs[i]);
        const Y = mapY(ys[i]);
        if(i===0) ctx.moveTo(X,Y);
        else ctx.lineTo(X,Y);
      }
      ctx.stroke();

      // glow
      ctx.globalAlpha = 0.25;
      ctx.lineWidth = 6.5;
      ctx.strokeStyle = grad;
      ctx.stroke();
      ctx.restore();
    }

    function title(ctx, text, x, y){
      ctx.save();
      ctx.fillStyle = 'rgba(255,255,255,0.88)';
      ctx.font = '13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(text, x, y);
      ctx.restore();
    }

    // ---------- State / UI ----------
    const els = {
      L: document.getElementById('L'),
      C: document.getElementById('C'),
      Rratio: document.getElementById('Rratio'),
      Lval: document.getElementById('Lval'),
      Cval: document.getElementById('Cval'),
      Rval: document.getElementById('Rval'),
      regimeNote: document.getElementById('regimeNote'),
      reset: document.getElementById('reset')
    };

    function getState(){
      const L_mH = parseFloat(els.L.value);
      const C_uF = parseFloat(els.C.value);
      const L = L_mH * 1e-3;
      const C = C_uF * 1e-6;
      const Rcrit = 2*Math.sqrt(L/C);
      const ratio = parseFloat(els.Rratio.value);
      const R = ratio * Rcrit;
      const w0 = 1/Math.sqrt(L*C);
      const T = 2*Math.PI / w0;
      const alpha = R/(2*L);
      let regime = 'underdamped';
      if (Math.abs(alpha - w0) < 1e-6*w0) regime = 'critical';
      else if (alpha > w0) regime = 'overdamped';
      return {L_mH,C_uF, L,C, Rcrit, ratio, R, w0, T, alpha, regime};
    }

    function formatOhm(x){
      if (x < 1) return (x*1000).toFixed(1) + ' mΩ';
      if (x < 1000) return x.toFixed(2) + ' Ω';
      return (x/1000).toFixed(2) + ' kΩ';
    }
    function formatTime(x){
      if (x < 1e-3) return (x*1e6).toFixed(2)+' µs';
      if (x < 1) return (x*1e3).toFixed(2)+' ms';
      return x.toFixed(3)+' s';
    }

    function stateSummary(){
      const s = getState();
      return [
        `Example parameters (for plots only):`,
        `L = ${s.L_mH.toFixed(1)} mH`,
        `C = ${s.C_uF.toFixed(2)} µF`,
        `Rcrit = 2*sqrt(L/C) = ${formatOhm(s.Rcrit)}`,
        `R = ${s.ratio.toFixed(2)} * Rcrit = ${formatOhm(s.R)}`,
        `ω0 = 1/sqrt(LC) = ${s.w0.toFixed(2)} rad/s`,
        `T = 2π*sqrt(LC) = ${formatTime(s.T)}`,
        `Regime: ${s.regime}`
      ].join('\n');
    }

    // ---------- Canvas instances ----------
    const circuitCanvas = setupHiDPICanvas(document.getElementById('circuit'));
    const plotQCanvas   = setupHiDPICanvas(document.getElementById('plotQ'));
    const plotECanvas   = setupHiDPICanvas(document.getElementById('plotE'));

    function drawCircuit(){
      const {ctx, resize} = circuitCanvas;
      const {w,h} = resize();
      ctx.clearRect(0,0,w,h);

      const s = getState();

      // Background wash
      ctx.save();
      const bg = ctx.createLinearGradient(0,0,w,h);
      bg.addColorStop(0,'rgba(125,211,252,0.08)');
      bg.addColorStop(1,'rgba(167,139,250,0.06)');
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,w,h);
      ctx.restore();

      title(ctx, 'Series RLC Discharge Loop', 10, 18);

      // Regime badge
      const badge = (()=>{
        if(s.regime==='critical') return {text:'CRITICAL', col:'rgba(52,211,153,0.95)'};
        if(s.regime==='underdamped') return {text:'UNDERDAMPED', col:'rgba(125,211,252,0.95)'};
        return {text:'OVERDAMPED', col:'rgba(251,191,36,0.95)'};
      })();
      ctx.save();
      ctx.font = '12px var(--mono)';
      const padX=10, padY=6;
      const tw = ctx.measureText(badge.text).width;
      const bx = w - (tw + padX*2) - 10;
      const by = 10;
      ctx.fillStyle = 'rgba(0,0,0,0.35)';
      ctx.strokeStyle = 'rgba(255,255,255,0.18)';
      ctx.lineWidth = 1;
      roundRect(ctx, bx, by, tw+padX*2, 26, 12);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = badge.col;
      ctx.fillText(badge.text, bx+padX, by+17);
      ctx.restore();

      // Draw loop
      const margin = 24;
      const x1 = margin, y1 = 45;
      const x2 = w - margin, y2 = h - margin;
      const midX = (x1+x2)/2;
      const midY = (y1+y2)/2;

      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.75)';
      ctx.lineWidth = 2;

      // Wires rectangle
      // Top wire with switch gap
      const gap = 40;
      const swX = midX - gap/2;
      ctx.beginPath();
      ctx.moveTo(x1, y1);
      ctx.lineTo(swX, y1);
      ctx.moveTo(swX+gap, y1);
      ctx.lineTo(x2, y1);
      ctx.stroke();

      // switch blade
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(125,211,252,0.95)';
      ctx.lineWidth = 2.5;
      ctx.moveTo(swX, y1);
      ctx.lineTo(swX+gap*0.85, y1-18);
      ctx.stroke();

      // Right vertical: inductor
      ctx.strokeStyle = 'rgba(255,255,255,0.75)';
      ctx.lineWidth = 2;
      // wire from top to inductor start
      const indTop = y1 + 18;
      const indBot = y2 - 18;
      ctx.beginPath();
      ctx.moveTo(x2, y1);
      ctx.lineTo(x2, indTop);
      ctx.stroke();
      drawInductor(ctx, x2, indTop, indBot, 6, 10);

      // wire to bottom
      ctx.beginPath();
      ctx.moveTo(x2, indBot);
      ctx.lineTo(x2, y2);
      ctx.stroke();

      // Bottom: resistor segment in middle
      const rLeft = midX - 65, rRight = midX + 65;
      ctx.beginPath();
      ctx.moveTo(x2, y2);
      ctx.lineTo(rRight, y2);
      ctx.stroke();
      drawResistor(ctx, rRight, y2, rLeft, y2, 9, 9);
      ctx.beginPath();
      ctx.moveTo(rLeft, y2);
      ctx.lineTo(x1, y2);
      ctx.stroke();

      // Left vertical: capacitor
      const capTop = y1 + 55;
      const capBot = y2 - 55;
      ctx.beginPath();
      ctx.moveTo(x1, y2);
      ctx.lineTo(x1, capBot);
      ctx.stroke();
      drawCapacitor(ctx, x1, capBot, capTop);
      ctx.beginPath();
      ctx.moveTo(x1, capTop);
      ctx.lineTo(x1, y1);
      ctx.stroke();

      // Labels
      ctx.fillStyle = 'rgba(255,255,255,0.85)';
      ctx.font = '12px ui-sans-serif, system-ui';
      ctx.fillText('Switch (closes at t=0)', swX-40, y1-24);
      ctx.fillText(`L = ${s.L_mH.toFixed(1)} mH`, x2-95, midY);
      ctx.fillText(`R = ${formatOhm(s.R)}`, midX-35, y2+18);
      ctx.fillText(`C = ${s.C_uF.toFixed(2)} µF`, x1+10, midY);

      // Direction arrow for i(t)
      ctx.strokeStyle = 'rgba(167,139,250,0.95)';
      ctx.lineWidth = 2;
      drawArrow(ctx, midX-35, y1+10, midX+35, y1+10);
      ctx.fillStyle = 'rgba(255,255,255,0.78)';
      ctx.font = '12px var(--mono)';
      ctx.fillText('i(t)', midX+42, y1+14);

      // Note q(t) on capacitor
      ctx.fillStyle = 'rgba(255,255,255,0.78)';
      ctx.font = '12px var(--mono)';
      ctx.fillText('q(t)', x1+20, capTop+18);

      ctx.restore();

      // Footer note
      ctx.save();
      ctx.fillStyle = 'rgba(255,255,255,0.65)';
      ctx.font = '11px ui-sans-serif, system-ui';
      ctx.fillText('Lumped-element model: vL + vR + vC = 0 with i = dq/dt', 10, h-10);
      ctx.restore();
    }

    function roundRect(ctx, x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr,y);
      ctx.arcTo(x+w,y,x+w,y+h,rr);
      ctx.arcTo(x+w,y+h,x,y+h,rr);
      ctx.arcTo(x,y+h,x,y,rr);
      ctx.arcTo(x,y,x+w,y,rr);
      ctx.closePath();
    }

    function drawArrow(ctx, x1,y1,x2,y2){
      const dx = x2-x1, dy=y2-y1;
      const L = Math.hypot(dx,dy) || 1;
      const ux = dx/L, uy=dy/L;
      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(x2,y2);
      ctx.stroke();
      const ah = 10;
      const aw = 6;
      const px = x2 - ux*ah;
      const py = y2 - uy*ah;
      ctx.beginPath();
      ctx.moveTo(x2,y2);
      ctx.lineTo(px - uy*aw, py + ux*aw);
      ctx.lineTo(px + uy*aw, py - ux*aw);
      ctx.closePath();
      ctx.fillStyle = ctx.strokeStyle;
      ctx.fill();
    }

    function drawInductor(ctx, x, yTop, yBot, turns, radius){
      const len = yBot - yTop;
      const step = len / (turns*2);
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.85)';
      ctx.lineWidth = 2;
      // start lead
      ctx.beginPath();
      ctx.moveTo(x, yTop);
      ctx.lineTo(x, yTop+step);
      ctx.stroke();
      let y = yTop + step;
      for(let i=0;i<turns;i++){
        ctx.beginPath();
        ctx.arc(x, y + step, radius, -Math.PI/2, Math.PI/2, false);
        ctx.stroke();
        y += 2*step;
      }
      // end lead
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x, yBot);
      ctx.stroke();
      ctx.restore();
    }

    function drawResistor(ctx, x1,y1,x2,y2, zigzags, amp){
      // assume horizontal
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.85)';
      ctx.lineWidth = 2;
      const L = x1 - x2;
      const step = L/(zigzags*2);
      ctx.beginPath();
      ctx.moveTo(x1,y1);
      let x = x1;
      let up = true;
      for(let i=0;i<zigzags*2;i++){
        x -= step;
        const y = y1 + (up ? -amp : amp);
        ctx.lineTo(x,y);
        up = !up;
      }
      ctx.lineTo(x2,y2);
      ctx.stroke();
      ctx.restore();
    }

    function drawCapacitor(ctx, x, yBot, yTop){
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.85)';
      ctx.lineWidth = 2;
      const plateGap = 10;
      const plateLen = 26;
      const mid = (yTop+yBot)/2;

      // wire to bottom plate
      ctx.beginPath();
      ctx.moveTo(x, yBot);
      ctx.lineTo(x, mid + plateGap);
      ctx.stroke();

      // bottom plate
      ctx.beginPath();
      ctx.moveTo(x - plateLen/2, mid + plateGap);
      ctx.lineTo(x + plateLen/2, mid + plateGap);
      ctx.stroke();

      // top plate
      ctx.beginPath();
      ctx.moveTo(x - plateLen/2, mid - plateGap);
      ctx.lineTo(x + plateLen/2, mid - plateGap);
      ctx.stroke();

      // wire to top
      ctx.beginPath();
      ctx.moveTo(x, mid - plateGap);
      ctx.lineTo(x, yTop);
      ctx.stroke();
      ctx.restore();
    }

    function drawPlotQ(){
      const {ctx, resize} = plotQCanvas;
      const {w,h} = resize();
      ctx.clearRect(0,0,w,h);

      const s = getState();
      const pad = {l:54, r:16, t:18, b:34};
      const x0=pad.l, y0=pad.t, pw=w-pad.l-pad.r, ph=h-pad.t-pad.b;

      // backdrop
      ctx.save();
      const bg = ctx.createLinearGradient(0,0,w,h);
      bg.addColorStop(0,'rgba(125,211,252,0.07)');
      bg.addColorStop(1,'rgba(0,0,0,0.0)');
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,w,h);
      ctx.restore();

      drawGrid(ctx,x0,y0,pw,ph,6,5);

      // Choose time range in units of T
      const xMin = 0, xMax = 3; // up to 3 periods
      // Compute series
      const N=500;
      const xs=[], ys=[];
      let yMin = +1e9, yMax = -1e9;
      for(let i=0;i<N;i++){
        const x = xMin + (xMax-xMin)*i/(N-1); // x = t/T
        const t = x * s.T;
        const qn = qNorm(t, s.L, s.C, s.R);
        xs.push(x);
        ys.push(qn);
        yMin = Math.min(yMin, qn);
        yMax = Math.max(yMax, qn);
      }
      // nice bounds
      yMax = Math.max(1.05, yMax);
      yMin = Math.min(-0.55, yMin);
      yMin = clamp(yMin, -1.2, 1);
      yMax = clamp(yMax, -1, 1.2);

      drawAxes(ctx,x0,y0,pw,ph,'t/T (dimensionless)','q(t)/q0 (dimensionless)');
      drawTicks(ctx,x0,y0,pw,ph, xMin,xMax, yMin,yMax, 6, 5);

      // plot line
      plotLine(ctx,x0,y0,pw,ph, xs,ys, xMin,xMax, yMin,yMax);

      // Mark critical curve label
      ctx.save();
      ctx.fillStyle = 'rgba(255,255,255,0.78)';
      ctx.font = '12px var(--mono)';
      const label = `R/Rcrit = ${s.ratio.toFixed(2)}  (${s.regime})`;
      ctx.fillText(label, x0+8, y0+16);
      ctx.restore();

      // Add zero line
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.22)';
      ctx.lineWidth = 1;
      const yZero = y0 + (yMax - 0) * ph / (yMax - yMin);
      ctx.beginPath(); ctx.moveTo(x0, yZero); ctx.lineTo(x0+pw, yZero); ctx.stroke();
      ctx.restore();
    }

    function drawPlotE(){
      const {ctx, resize} = plotECanvas;
      const {w,h} = resize();
      ctx.clearRect(0,0,w,h);

      const s = getState();
      const pad = {l:54, r:16, t:18, b:34};
      const x0=pad.l, y0=pad.t, pw=w-pad.l-pad.r, ph=h-pad.t-pad.b;

      ctx.save();
      const bg = ctx.createLinearGradient(0,0,w,h);
      bg.addColorStop(0,'rgba(52,211,153,0.06)');
      bg.addColorStop(1,'rgba(0,0,0,0.0)');
      ctx.fillStyle = bg;
      ctx.fillRect(0,0,w,h);
      ctx.restore();

      drawGrid(ctx,x0,y0,pw,ph,6,5);

      const xMin=0, xMax=3;
      const N=500;
      const xs=[], ys=[];
      let yMin=0, yMax=1;
      for(let i=0;i<N;i++){
        const x = xMin + (xMax-xMin)*i/(N-1);
        const t = x*s.T;
        const En = energyNorm(t, s.L, s.C, s.R);
        xs.push(x);
        ys.push(En);
        yMax = Math.max(yMax, En);
      }
      yMax = Math.min(1.25, yMax);
      yMin = 0;

      drawAxes(ctx,x0,y0,pw,ph,'t/T (dimensionless)','E(t)/E0 (dimensionless)');
      drawTicks(ctx,x0,y0,pw,ph, xMin,xMax, yMin,yMax, 6, 5);

      // Plot in a greenish gradient
      plotLine(ctx,x0,y0,pw,ph, xs,ys, xMin,xMax, yMin,yMax, 'rgba(52,211,153,0.95)', 'rgba(125,211,252,0.75)');

      // annotate E0
      ctx.save();
      ctx.fillStyle = 'rgba(255,255,255,0.78)';
      ctx.font = '12px var(--mono)';
      ctx.fillText('E0 = q0²/(2C)  (since i(0)=0)', x0+8, y0+16);
      ctx.restore();
    }

    function updateLabels(){
      const s = getState();
      els.Lval.textContent = `${s.L_mH.toFixed(1)} mH`;
      els.Cval.textContent = `${s.C_uF.toFixed(2)} µF`;
      els.Rval.textContent = `R = ${s.ratio.toFixed(2)}·Rcrit = ${formatOhm(s.R)}  (Rcrit=${formatOhm(s.Rcrit)})`;

      let note = '';
      if(s.regime==='critical'){
        note = `Regime: CRITICAL (fastest non-oscillatory).  T = ${formatTime(s.T)}.`;
      }else if(s.regime==='underdamped'){
        note = `Regime: UNDERDAMPED (decaying oscillations).  T = ${formatTime(s.T)} (undamped reference).`;
      }else{
        note = `Regime: OVERDAMPED (slow non-oscillatory).  T = ${formatTime(s.T)} (undamped reference).`;
      }
      els.regimeNote.textContent = note;
    }

    function redrawAll(){
      updateLabels();
      drawCircuit();
      drawPlotQ();
      drawPlotE();
    }

    // Resize observers to keep plots responsive & crisp
    const ro = new ResizeObserver(()=> redrawAll());
    ro.observe(document.getElementById('circuit'));
    ro.observe(document.getElementById('plotQ'));
    ro.observe(document.getElementById('plotE'));

    // UI events
    ['input','change'].forEach(evt=>{
      els.L.addEventListener(evt, redrawAll);
      els.C.addEventListener(evt, redrawAll);
      els.Rratio.addEventListener(evt, redrawAll);
    });

    document.getElementById('reset').addEventListener('click', ()=>{
      els.Rratio.value = '1.00';
      redrawAll();
    });

    // Initial draw
    redrawAll();
  </script>
</body>
</html>
