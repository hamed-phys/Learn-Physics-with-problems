<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Oscillator in a Viscous Medium — Driven Damped Spring-Mass (HTML Article)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#101827;
      --card:#0f1a2b;
      --ink:#e9eef7;
      --muted:#a8b3c7;
      --faint:#6f7f99;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --border:rgba(255,255,255,.10);
      --shadow: 0 18px 45px rgba(0,0,0,.45);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 900px at 15% 10%, rgba(125,211,252,.12), transparent 60%),
        radial-gradient(1000px 800px at 85% 20%, rgba(167,139,250,.10), transparent 55%),
        radial-gradient(1200px 900px at 55% 95%, rgba(52,211,153,.08), transparent 55%),
        linear-gradient(180deg, #070a10 0%, var(--bg) 30%, #060911 100%);
      line-height:1.6;
      overflow-x:hidden;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header.hero{
      padding:34px 18px 22px;
      max-width:1200px;
      margin:0 auto;
    }
    .heroCard{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow);
      padding:26px 22px;
      position:relative;
      overflow:hidden;
    }
    .heroCard:before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(700px 220px at 10% 0%, rgba(125,211,252,.20), transparent 60%),
        radial-gradient(600px 220px at 90% 20%, rgba(167,139,250,.16), transparent 60%);
      filter: blur(10px);
      opacity:.7;
      pointer-events:none;
    }
    .heroGrid{
      position:relative;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:start;
    }
    h1{
      margin:0 0 8px 0;
      letter-spacing:.2px;
      font-size: clamp(24px, 2.4vw, 38px);
      line-height:1.2;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: clamp(14px, 1.2vw, 16px);
    }
    .pillRow{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .pill{
      border:1px solid var(--border);
      background: rgba(16,24,39,.65);
      padding:7px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:12px;
      backdrop-filter: blur(6px);
    }
    .quick{
      background: rgba(15,26,43,.70);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px 14px 12px;
    }
    .quick h2{
      margin:0 0 8px 0;
      font-size:15px;
      letter-spacing:.25px;
      color:#dbe8ff;
    }
    .quick ul{margin:8px 0 0 18px; padding:0}
    .quick li{color:var(--muted); margin:6px 0}
    main{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 60px;
    }
    .layout{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      align-items:start;
    }
    nav.toc{
      position:sticky;
      top:14px;
      align-self:start;
      border:1px solid var(--border);
      background: rgba(16,24,39,.65);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      padding:14px 12px;
      box-shadow: 0 12px 26px rgba(0,0,0,.25);
    }
    .toc h3{
      margin:0 0 10px 0;
      font-size:13px;
      letter-spacing:.2px;
      color: #dbe8ff;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .toc small{color:var(--faint)}
    .toc a{
      display:block;
      padding:8px 10px;
      border-radius: 12px;
      color:var(--muted);
      border:1px solid transparent;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-size:13px;
    }
    .toc a:hover{
      background: rgba(125,211,252,.08);
      border-color: rgba(125,211,252,.22);
      transform: translateY(-1px);
      text-decoration:none;
    }
    .toc .hint{
      margin-top:10px;
      padding:10px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.16);
      color:var(--faint);
      font-size:12px;
    }
    article{
      min-width:0;
    }
    section{
      margin-top:18px;
      border:1px solid var(--border);
      background: rgba(16,24,39,.45);
      border-radius: var(--radius);
      overflow:hidden;
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
    }
    section > header{
      padding:14px 16px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,0));
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    section > header h2{
      margin:0;
      font-size:15px;
      letter-spacing:.25px;
      color:#e8f2ff;
    }
    .content{
      padding: 14px 16px 18px;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .heroGrid{grid-template-columns: 1fr}
      .layout{grid-template-columns: 1fr}
      nav.toc{position:relative; top:auto}
      .grid2{grid-template-columns:1fr}
    }
    .card{
      background: rgba(15,26,43,.70);
      border:1px solid var(--border);
      border-radius: var(--radius);
      padding:14px;
      min-width:0;
    }
    .card h3{
      margin:0 0 8px 0;
      font-size:14px;
      color:#dbe8ff;
      letter-spacing:.2px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:12px;
      flex-wrap:wrap;
    }
    .muted{color:var(--muted)}
    .kicker{color:var(--faint); font-size:12px; margin-top:-2px}
    ul,ol{margin:10px 0 0 18px}
    li{margin:6px 0}
    .eq{
      position:relative;
      padding:12px 12px 10px;
      border-radius: 14px;
      border:1px solid rgba(125,211,252,.20);
      background: linear-gradient(180deg, rgba(125,211,252,.10), rgba(125,211,252,.05));
      overflow:hidden;
    }
    .eq code, .eq pre{
      font-family: var(--mono);
      color:#eaf6ff;
      font-size:13px;
      white-space:pre-wrap;
      word-break:break-word;
      margin:0;
    }
    .eq .copyBtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(16,24,39,.65);
      color:var(--muted);
      border-radius: 12px;
      padding:6px 10px;
      font-size:12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .eq .copyBtn:hover{
      transform: translateY(-1px);
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.30);
    }
    .callout{
      border-radius: var(--radius);
      border:1px solid var(--border);
      background: rgba(15,26,43,.65);
      padding:14px;
      display:flex;
      gap:12px;
      align-items:flex-start;
    }
    .badge{
      width:34px; height:34px;
      border-radius: 12px;
      display:grid;
      place-items:center;
      flex:0 0 auto;
      background: rgba(125,211,252,.14);
      border:1px solid rgba(125,211,252,.22);
      color:#dff4ff;
      font-weight:700;
    }
    .callout strong{color:#eaf6ff}
    .boxFinal{
      border:1px solid rgba(52,211,153,.30);
      background: linear-gradient(180deg, rgba(52,211,153,.12), rgba(52,211,153,.06));
      border-radius: calc(var(--radius) + 2px);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .boxFinal:before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(800px 260px at 20% 0%, rgba(52,211,153,.22), transparent 60%);
      filter: blur(10px);
      opacity:.65;
      pointer-events:none;
    }
    .boxFinal h3{position:relative}
    .boxFinal .eq{position:relative; border-color: rgba(52,211,153,.30); background: rgba(52,211,153,.06)}
    .rowControls{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 980px){ .rowControls{grid-template-columns:1fr} }
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 680px){ .controls{grid-template-columns:1fr} }
    .control{
      border:1px solid var(--border);
      background: rgba(16,24,39,.55);
      border-radius: 16px;
      padding:10px 10px 8px;
    }
    .control label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .control input[type="range"]{width:100%}
    .control input[type="number"]{
      width:100%;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding:8px 10px;
      color:var(--ink);
      font-family: var(--mono);
      font-size:12px;
      outline:none;
    }
    .btnRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:10px;
      align-items:center;
    }
    button.btn{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(16,24,39,.75);
      color:var(--muted);
      border-radius: 14px;
      padding:9px 12px;
      font-size:12px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    button.btn:hover{
      transform: translateY(-1px);
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.30);
    }
    button.btn.primary{
      color:#061018;
      background: linear-gradient(180deg, rgba(125,211,252,.95), rgba(125,211,252,.70));
      border-color: rgba(125,211,252,.45);
      font-weight:700;
    }
    button.btn.primary:hover{
      background: linear-gradient(180deg, rgba(125,211,252,1), rgba(125,211,252,.78));
    }
    button.btn.good{
      color:#04120b;
      background: linear-gradient(180deg, rgba(52,211,153,.95), rgba(52,211,153,.72));
      border-color: rgba(52,211,153,.45);
      font-weight:700;
    }
    .canvasWrap{
      border:1px solid var(--border);
      background: rgba(8,12,18,.60);
      border-radius: var(--radius);
      padding:12px;
      overflow:hidden;
      min-width:0;
    }
    .canvasTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
      flex-wrap:wrap;
    }
    .canvasTitle h4{
      margin:0;
      font-size:13px;
      color:#dbe8ff;
      letter-spacing:.2px;
    }
    .canvasTitle .meta{
      color:var(--faint);
      font-size:12px;
      font-family: var(--mono);
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius: 14px;
      background: radial-gradient(800px 450px at 25% 10%, rgba(125,211,252,.08), transparent 55%),
                  radial-gradient(700px 420px at 80% 20%, rgba(167,139,250,.07), transparent 60%),
                  rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.08);
    }
    .foot{
      max-width:1200px;
      margin:0 auto;
      padding: 18px 18px 30px;
      color: var(--faint);
      font-size:12px;
    }
    .toast{
      position: fixed;
      bottom:16px;
      left:50%;
      transform: translateX(-50%);
      background: rgba(16,24,39,.92);
      border:1px solid rgba(255,255,255,.14);
      color: var(--muted);
      padding:10px 12px;
      border-radius: 14px;
      box-shadow: 0 12px 30px rgba(0,0,0,.35);
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9999;
    }
    .toast.show{
      opacity:1;
      transform: translateX(-50%) translateY(-2px);
    }

    /* Print-friendly */
    @media print{
      body{background:#fff; color:#111}
      header.hero, main, .foot{max-width: 900px}
      nav.toc{display:none}
      section, .heroCard, .card, .canvasWrap{box-shadow:none; background:#fff; border-color:#ddd}
      .eq{background:#f6fbff; border-color:#bcd}
      .boxFinal{background:#f3fff7; border-color:#bdb}
      canvas{display:none}
      a{color:#06c}
    }
  </style>
</head>
<body>
  <header class="hero">
    <div class="heroCard">
      <div class="heroGrid">
        <div>
          <h1>Oscillator in a Viscous Medium (Driven Damped Spring–Mass)</h1>
          <p class="subtitle">
            A mass on a spring is immersed in water, experiencing a viscous force proportional to its velocity <em>relative</em> to the liquid.
            We derive the equations of motion for free decay, cup-driven forcing, and combined cup + spring-end driving, then find steady-state amplitudes and a perfect cancellation condition.
          </p>
          <div class="pillRow" aria-label="topic tags">
            <span class="pill">Damped Oscillator</span>
            <span class="pill">Relative-Velocity Drag</span>
            <span class="pill">Forced Response</span>
            <span class="pill">Amplitude & Phase</span>
            <span class="pill">Vibration Isolation</span>
          </div>
        </div>
        <aside class="quick" aria-label="Quick Summary">
          <h2>Quick Summary</h2>
          <ul>
            <li>Use <strong>x(t)</strong> = displacement of the mass from equilibrium <strong>B</strong> (cup at rest).</li>
            <li>Free motion: <strong>m ẍ + b ẋ + k x = 0</strong>.</li>
            <li>Cup drive <strong>d₁(t)=D₁ cos(ωt)</strong> enters through <em>relative</em> drag: RHS = <strong>b ḋ₁(t)</strong>.</li>
            <li>Steady-state amplitude (cup-only): <strong>|X| = (b D₁ ω) / √[(k−mω²)²+(bω)²]</strong>.</li>
            <li>With spring-end drive <strong>d₂(t)=D₂ cos(ωt+φ)</strong>: RHS adds <strong>k d₂(t)</strong>.</li>
            <li>Perfect cancellation (steady-state <strong>x(t)=0</strong>): <strong>D₂ = (bω/k)D₁</strong>, <strong>φ = −π/2</strong>.</li>
          </ul>
        </aside>
      </div>
    </div>
  </header>

  <main>
    <div class="layout">
      <nav class="toc" aria-label="Table of Contents">
        <h3>On this page <small>sticky</small></h3>
        <a href="#viz">Interactive Visuals</a>
        <a href="#part1">PART 1 — Problem Analysis</a>
        <a href="#part2">PART 2 — Strategy & Tips</a>
        <a href="#part3">PART 3 — Full Solution</a>
        <a href="#final">Final Boxed Results</a>
        <div class="hint">
          Tip: Use the sliders to see how damping and drive frequency reshape resonance, phase, and time response.
        </div>
      </nav>

      <article>
        <section id="viz">
          <header>
            <h2>Interactive Visualizations (Setup + Response)</h2>
            <div class="muted">Canvas plots update live with parameters</div>
          </header>
          <div class="content">
            <div class="rowControls">
              <div class="card">
                <h3>
                  Parameters (example values for plotting)
                  <span class="kicker">Final answers below remain symbolic</span>
                </h3>
                <div class="controls" role="group" aria-label="interactive controls">
                  <div class="control">
                    <label>
                      <span>Mass m (kg)</span>
                      <span id="mVal" class="muted">1.00</span>
                    </label>
                    <input id="m" type="range" min="0.2" max="5" step="0.01" value="1"/>
                  </div>
                  <div class="control">
                    <label>
                      <span>Spring k (N/m)</span>
                      <span id="kVal" class="muted">20.0</span>
                    </label>
                    <input id="k" type="range" min="2" max="80" step="0.1" value="20"/>
                  </div>
                  <div class="control">
                    <label>
                      <span>Damping b (N·s/m)</span>
                      <span id="bVal" class="muted">2.00</span>
                    </label>
                    <input id="b" type="range" min="0" max="20" step="0.01" value="2"/>
                  </div>
                  <div class="control">
                    <label>
                      <span>Cup amplitude D₁ (m)</span>
                      <span id="D1Val" class="muted">0.050</span>
                    </label>
                    <input id="D1" type="range" min="0" max="0.2" step="0.001" value="0.05"/>
                  </div>
                  <div class="control">
                    <label>
                      <span>Drive frequency ω (rad/s)</span>
                      <span id="wVal" class="muted">4.00</span>
                    </label>
                    <input id="w" type="range" min="0.2" max="20" step="0.01" value="4"/>
                  </div>
                  <div class="control">
                    <label>
                      <span>Spring-end amplitude D₂ (m)</span>
                      <span id="D2Val" class="muted">0.000</span>
                    </label>
                    <input id="D2" type="range" min="0" max="0.2" step="0.001" value="0"/>
                  </div>
                  <div class="control">
                    <label>
                      <span>Spring-end phase φ (rad)</span>
                      <span id="phiVal" class="muted">0.00</span>
                    </label>
                    <input id="phi" type="range" min="-3.1416" max="3.1416" step="0.001" value="0"/>
                  </div>
                  <div class="control">
                    <label>
                      <span>Mode</span>
                      <span id="modeVal" class="muted">Cup-only</span>
                    </label>
                    <select id="mode" style="width:100%; background:rgba(0,0,0,.18); border:1px solid rgba(255,255,255,.12); border-radius:12px; padding:8px 10px; color:var(--ink); font-size:12px;">
                      <option value="cup">Cup-only drive</option>
                      <option value="both">Cup + spring-end drive</option>
                    </select>
                  </div>
                </div>

                <div class="btnRow">
                  <button class="btn primary" id="btnCancel">Set cancellation (x(t)=0) for current ω</button>
                  <button class="btn" id="btnReset">Reset example values</button>
                  <button class="btn" id="btnPause">Pause animation</button>
                </div>

                <div class="callout" style="margin-top:12px;">
                  <div class="badge">i</div>
                  <div class="muted">
                    The plots use the same symbols as the derivation:
                    <strong>m, k, b, D₁, ω, D₂, φ</strong>.
                    Drag uses relative velocity: <strong>F_drag = −b( ẋ − ḋ₁ )</strong>.
                  </div>
                </div>
              </div>

              <div class="card">
                <h3>Derived steady-state complex amplitude (used in plots)</h3>
                <div class="eq" data-copy="eqComplex">
                  <button class="copyBtn" data-copy-btn="eqComplex">Copy</button>
                  <pre><code id="eqComplex">Let d1(t)=D1 cos(ωt), d2(t)=D2 cos(ωt+φ).
Define the dynamic stiffness: Z(ω) = (k − m ω^2) + i (b ω).

Cup-only forcing: f(t)=b ḋ1(t) = −b D1 ω sin(ωt) = Re{ (i b D1 ω) e^{iωt} }.
So X = (i b D1 ω) / Z(ω) and |X| = (b D1 ω)/|Z(ω)|.

Both drives: RHS phasor = (i b D1 ω) + k D2 e^{iφ}
So X = [ i b D1 ω + k D2 e^{iφ} ] / Z(ω).</code></pre>
                </div>
                <p class="muted" style="margin-top:10px;">
                  In the “both-drive” mode, the time signal shown is the steady-state motion:
                  <span style="font-family:var(--mono);">x_ss(t)=Re{ X e^{iωt} }</span>.
                </p>
              </div>
            </div>

            <div class="grid2" style="margin-top:14px;">
              <figure class="canvasWrap">
                <div class="canvasTitle">
                  <h4>1) Physical setup diagram (labeled)</h4>
                  <div class="meta">A, B, C + x(t), d₁(t), d₂(t)</div>
                </div>
                <canvas id="canSetup" aria-label="Setup diagram canvas"></canvas>
              </figure>

              <figure class="canvasWrap">
                <div class="canvasTitle">
                  <h4>2) Main plot — steady-state amplitude |X(ω)|</h4>
                  <div class="meta">x amplitude vs ω (rad/s)</div>
                </div>
                <canvas id="canAmp" aria-label="Amplitude plot canvas"></canvas>
              </figure>
            </div>

            <div class="grid2" style="margin-top:14px;">
              <figure class="canvasWrap">
                <div class="canvasTitle">
                  <h4>3) Secondary plot — phase lag arg(X) vs ω</h4>
                  <div class="meta">phase (rad)</div>
                </div>
                <canvas id="canPhase" aria-label="Phase plot canvas"></canvas>
              </figure>

              <figure class="canvasWrap">
                <div class="canvasTitle">
                  <h4>4) Time-domain steady-state x(t) (1–2 periods)</h4>
                  <div class="meta">updates with ω, b, D₁, D₂, φ</div>
                </div>
                <canvas id="canTime" aria-label="Time plot canvas"></canvas>
              </figure>
            </div>
          </div>
        </section>

        <section id="part1">
          <header>
            <h2>PART 1 — Problem Analysis (no solving yet)</h2>
            <div class="muted">Understand the model before doing algebra</div>
          </header>
          <div class="content">
            <div class="card">
              <h3>Rewrite the problem in my own words</h3>
              <p class="muted">
                A mass <strong>m</strong> hangs from a spring (constant <strong>k</strong>) and is submerged in water. The water produces a viscous drag force proportional to the mass’s velocity <em>relative</em> to the water:
                <span style="font-family:var(--mono);">F_drag = −b v_rel</span>, where <strong>b &gt; 0</strong>.
                Point <strong>A</strong> is the spring’s suspension point, <strong>B</strong> is the static equilibrium position of the mass when the cup is at rest, and <strong>C</strong> is the bottom of the cup.
                We must write equations of motion for (a) free decay, (b) cup-driven motion, (c) steady-state amplitude under cup drive, (d) combined cup + moving suspension point, and (e) choose suspension driving that makes the mass stationary in steady state.
              </p>
            </div>

            <div class="grid2" style="margin-top:14px;">
              <div class="card">
                <h3>Given quantities</h3>
                <ul class="muted">
                  <li>Mass: <strong>m</strong></li>
                  <li>Spring constant: <strong>k</strong></li>
                  <li>Viscous coefficient: <strong>b</strong> with drag force <strong>F = −b v_rel</strong></li>
                  <li>Cup (fluid) bottom position: <strong>d₁(t)=D₁ cos(ωt)</strong> (when driven)</li>
                  <li>Suspension point position: <strong>d₂(t)=D₂ cos(ωt+φ)</strong> (when driven)</li>
                </ul>
              </div>

              <div class="card">
                <h3>Unknowns</h3>
                <ul class="muted">
                  <li>Mass position function <strong>x(t)</strong> (defined carefully below)</li>
                  <li>For part (c): steady-state amplitude of <strong>x(t)</strong></li>
                  <li>For part (e): required <strong>D₂</strong> and <strong>φ</strong> for cancellation</li>
                </ul>
              </div>
            </div>

            <div class="card" style="margin-top:14px;">
              <h3>What must be found / proved</h3>
              <ul class="muted">
                <li>(a) Differential equation for vertical motion when the cup is at rest.</li>
                <li>(b) Differential equation for <strong>x(t)</strong> when the cup is driven with <strong>d₁(t)</strong>.</li>
                <li>(c) Steady-state amplitude of the mass under cup drive.</li>
                <li>(d) Differential equation when both cup <em>and</em> spring suspension point are driven.</li>
                <li>(e) Choose <strong>D₂</strong> and <strong>φ</strong> so that the steady-state motion satisfies <strong>x(t)=0</strong> for all times.</li>
              </ul>
            </div>

            <div class="grid2" style="margin-top:14px;">
              <div class="card">
                <h3>Relevant physical principles (and why they apply)</h3>
                <ul class="muted">
                  <li><strong>Newton’s 2nd law</strong>: the mass’s acceleration is set by the net force.</li>
                  <li><strong>Hooke’s law</strong>: spring force is proportional to extension; for small motions we use a linear spring model.</li>
                  <li><strong>Linear viscous drag</strong>: the problem states a drag proportional to <em>relative</em> velocity, so the forcing depends on <strong>ẋ − (fluid velocity)</strong>.</li>
                  <li><strong>Equilibrium shift</strong>: gravity/buoyancy produce a constant offset; measuring displacement from equilibrium removes constant forces and simplifies the ODE.</li>
                  <li><strong>Steady-state sinusoidal response</strong>: linear systems driven sinusoidally respond sinusoidally at the same frequency (after transients decay).</li>
                </ul>
              </div>

              <div class="card">
                <h3>2–3 candidate approaches (compare)</h3>
                <ol class="muted">
                  <li><strong>Force-balance ODE in time domain</strong>: write all forces, choose a coordinate, shift by equilibrium. Simple and direct for (a), (b), (d).</li>
                  <li><strong>Phasor / complex impedance method</strong>: represent sinusoidal terms as complex exponentials to get amplitude/phase cleanly for (c), (e). Fast and less error-prone.</li>
                  <li><strong>Laplace transform</strong>: powerful for full transient + steady state, but heavier than needed since the question focuses on ODE form and steady-state amplitude.</li>
                </ol>
              </div>
            </div>

            <div class="callout" style="margin-top:14px;">
              <div class="badge">✓</div>
              <div class="muted">
                <strong>Best approach:</strong> use the time-domain ODE with a displacement-from-equilibrium coordinate, then use the phasor method for steady-state amplitude/phase and cancellation.
                This matches the problem’s goals (ODEs + steady state) with minimal algebra and maximal clarity.
              </div>
            </div>
          </div>
        </section>

        <section id="part2">
          <header>
            <h2>PART 2 — Strategy & Tips (roadmap only)</h2>
            <div class="muted">Plan first; no algebra yet</div>
          </header>
          <div class="content">
            <div class="card">
              <h3>Step-by-step roadmap (5–10 steps)</h3>
              <ol class="muted">
                <li>
                  <strong>Define a clean coordinate</strong>:
                  choose <span style="font-family:var(--mono);">x(t)</span> as the mass displacement from equilibrium point <span style="font-family:var(--mono);">B</span>.
                  <br/><span class="kicker">Tool: equilibrium shift to remove constant forces (mg, buoyancy).</span>
                </li>
                <li>
                  <strong>Write forces on the mass</strong>:
                  spring force ∝ displacement, drag force ∝ relative velocity.
                  <br/><span class="kicker">Tool: Hooke’s law; given drag law.</span>
                </li>
                <li>
                  <strong>Apply Newton’s 2nd law</strong> to get the ODE for cup at rest.
                  <br/><span class="kicker">Tool: ΣF = m ẍ.</span>
                </li>
                <li>
                  <strong>Include cup motion</strong>:
                  fluid velocity equals cup velocity <span style="font-family:var(--mono);">ḋ₁(t)</span>, so drag uses <span style="font-family:var(--mono);">ẋ − ḋ₁</span>.
                  <br/><span class="kicker">Tool: relative velocity in viscous force.</span>
                </li>
                <li>
                  <strong>Identify the forcing form</strong> in the ODE (right-hand side).
                  <br/><span class="kicker">Tool: rewrite RHS as sinusoid at ω.</span>
                </li>
                <li>
                  <strong>Compute steady-state amplitude</strong> using the standard forced damped oscillator response (or phasors).
                  <br/><span class="kicker">Tool: complex impedance Z(ω).</span>
                </li>
                <li>
                  <strong>Add spring-end motion</strong>:
                  spring extension becomes <span style="font-family:var(--mono);">x − d₂(t)</span>.
                  <br/><span class="kicker">Tool: relative displacement in Hooke’s law.</span>
                </li>
                <li>
                  <strong>Enforce cancellation condition</strong>:
                  set the steady-state solution to <span style="font-family:var(--mono);">x(t)=0</span> and solve for <span style="font-family:var(--mono);">D₂, φ</span>.
                  <br/><span class="kicker">Tool: match sinusoidal terms (phasors).</span>
                </li>
              </ol>
            </div>

            <div class="grid2" style="margin-top:14px;">
              <div class="card">
                <h3>Common mistakes</h3>
                <ul class="muted">
                  <li>Using <strong>−b ẋ</strong> when the drag is relative: it must be <strong>−b( ẋ − ḋ₁ )</strong> if the water moves with the cup.</li>
                  <li>Forgetting to shift by equilibrium, leaving constant <strong>mg</strong> terms that clutter the ODE.</li>
                  <li>Mixing “position of the cup” with “position of the mass” without specifying the coordinate frame.</li>
                  <li>In steady-state, forgetting that the response is at the same frequency <strong>ω</strong> (transients are separate).</li>
                </ul>
              </div>
              <div class="card">
                <h3>Quick tips</h3>
                <ul class="muted">
                  <li>Define <strong>x(t)</strong> as displacement from equilibrium <strong>B</strong> → removes constant forces automatically.</li>
                  <li>Think “drag tries to make the mass match the fluid velocity.” That is why <strong>b ḋ₁</strong> appears as a drive.</li>
                  <li>Use the “dynamic stiffness” <strong>Z(ω)=(k−mω²)+i(bω)</strong> to read amplitude/phase at a glance.</li>
                </ul>
              </div>
            </div>

            <div class="callout" style="margin-top:14px;">
              <div class="badge">!</div>
              <div class="muted">
                <strong>Reminder:</strong> In this roadmap we do not do algebra; the full derivation starts next.
              </div>
            </div>
          </div>
        </section>

        <section id="part3">
          <header>
            <h2>PART 3 — Full Solution</h2>
            <div class="muted">Intuition → derivation → boxed answers + checks</div>
          </header>
          <div class="content">
            <div class="card">
              <h3>Coordinate choice and symbols (used everywhere)</h3>
              <p class="muted">
                Let <strong>x(t)</strong> be the vertical displacement of the mass from the equilibrium point <strong>B</strong> (equilibrium when the cup is at rest).
                We take upward as positive. With this choice, constant forces (gravity and buoyancy) cancel out of the dynamics, and the spring force is simply
                <strong>−k x</strong> when the suspension point is fixed.
              </p>
              <p class="muted">
                When the cup moves, we assume the water moves with the cup (rigid translation), so the water velocity is <strong>ḋ₁(t)</strong>.
                The viscous force on the mass depends on relative velocity:
                <span style="font-family:var(--mono);">F_drag = −b( ẋ − ḋ₁ )</span>.
              </p>
              <p class="muted">
                When the suspension point (A) moves by <strong>d₂(t)</strong>, the spring extension changes by <strong>(x − d₂)</strong>, so the spring force becomes
                <span style="font-family:var(--mono);">F_spring = −k( x − d₂ )</span>.
              </p>
            </div>

            <div class="grid2" style="margin-top:14px;">
              <div class="card">
                <h3>(a) Cup at rest: equation of motion</h3>
                <p class="muted">
                  Physical intuition: the spring pulls the mass back toward equilibrium, while viscosity dissipates energy by opposing motion relative to the (still) water.
                </p>
                <p class="muted"><strong>Forces:</strong></p>
                <ul class="muted">
                  <li>Spring: <span style="font-family:var(--mono);">F_s = −k x</span></li>
                  <li>Drag (cup/water at rest ⇒ fluid velocity 0): <span style="font-family:var(--mono);">F_d = −b ẋ</span></li>
                </ul>
                <p class="muted"><strong>Newton’s 2nd law:</strong> <span style="font-family:var(--mono);">m ẍ = F_s + F_d</span></p>
                <div class="eq" data-copy="eqA">
                  <button class="copyBtn" data-copy-btn="eqA">Copy</button>
                  <pre><code id="eqA">m ẍ + b ẋ + k x = 0   (cup at rest; x measured from equilibrium B)</code></pre>
                </div>
              </div>

              <div class="card">
                <h3>(b) Cup driven: equation for x(t)</h3>
                <p class="muted">
                  The cup bottom (and thus the water) moves as <strong>d₁(t)=D₁ cos(ωt)</strong>, so the water velocity is <strong>ḋ₁(t)</strong>.
                  Drag depends on relative velocity:
                  <span style="font-family:var(--mono);">F_d = −b( ẋ − ḋ₁ )</span>.
                  The spring end is fixed in part (b), so <span style="font-family:var(--mono);">F_s = −k x</span>.
                </p>
                <p class="muted"><strong>Newton’s 2nd law:</strong></p>
                <div class="eq" data-copy="eqB">
                  <button class="copyBtn" data-copy-btn="eqB">Copy</button>
                  <pre><code id="eqB">m ẍ = −k x − b( ẋ − ḋ₁ )
⇒ m ẍ + b ẋ + k x = b ḋ₁(t)

With d₁(t)=D₁ cos(ωt):  ḋ₁(t)= −D₁ ω sin(ωt)
So: m ẍ + b ẋ + k x = − b D₁ ω sin(ωt)</code></pre>
                </div>
              </div>
            </div>

            <div class="grid2" style="margin-top:14px;">
              <div class="card">
                <h3>(c) Steady-state amplitude (cup-only)</h3>
                <p class="muted">
                  Intuition: the cup drives the mass only through viscosity—if <strong>b→0</strong> there is no coupling, so the amplitude must go to zero. Resonance is limited by damping.
                </p>
                <p class="muted">
                  The steady-state response to a sinusoidal drive has the same frequency <strong>ω</strong>.
                  The standard amplitude for <span style="font-family:var(--mono);">m ẍ + b ẋ + k x = F0 sin(ωt)</span> is
                  <span style="font-family:var(--mono);">|X| = F0 / √[(k−mω²)² + (bω)²]</span>.
                  Here <strong>F0 = b D₁ ω</strong>.
                </p>
                <div class="eq" data-copy="eqC">
                  <button class="copyBtn" data-copy-btn="eqC">Copy</button>
                  <pre><code id="eqC">Steady-state amplitude (cup-only):
|X(ω)| = (b D₁ ω) / √[(k − m ω²)² + (b ω)²]</code></pre>
                </div>
              </div>

              <div class="card">
                <h3>(d) Both cup and spring end driven</h3>
                <p class="muted">
                  Now the spring’s suspension point moves as <strong>d₂(t)=D₂ cos(ωt+φ)</strong>.
                  The spring force depends on extension <strong>(x − d₂)</strong>:
                  <span style="font-family:var(--mono);">F_s = −k(x − d₂)</span>.
                  Drag still depends on relative velocity to the water: <strong>−b( ẋ − ḋ₁ )</strong>.
                </p>
                <div class="eq" data-copy="eqD">
                  <button class="copyBtn" data-copy-btn="eqD">Copy</button>
                  <pre><code id="eqD">m ẍ = −k(x − d₂) − b( ẋ − ḋ₁ )
⇒ m ẍ + b ẋ + k x = b ḋ₁(t) + k d₂(t)

With d₁(t)=D₁ cos(ωt), d₂(t)=D₂ cos(ωt+φ):
m ẍ + b ẋ + k x = −b D₁ ω sin(ωt) + k D₂ cos(ωt+φ)</code></pre>
                </div>
              </div>
            </div>

            <div class="card" style="margin-top:14px;">
              <h3>(e) Choose D₂ and φ so that steady-state x(t)=0 for all times</h3>
              <p class="muted">
                We want the steady-state motion to be identically zero: <strong>x(t)=0</strong> at all times (after transients).
                If <strong>x=0</strong>, then <strong>ẋ=0</strong> and <strong>ẍ=0</strong>. Substitute into the forced equation from (d):
              </p>
              <div class="eq" data-copy="eqE1">
                <button class="copyBtn" data-copy-btn="eqE1">Copy</button>
                <pre><code id="eqE1">Set x = 0 in:  m ẍ + b ẋ + k x = b ḋ₁(t) + k d₂(t)
⇒ 0 = b ḋ₁(t) + k d₂(t)
⇒ d₂(t) = −(b/k) ḋ₁(t)</code></pre>
              </div>
              <p class="muted" style="margin-top:10px;">
                Since <strong>d₁(t)=D₁ cos(ωt)</strong>, we have <strong>ḋ₁(t)=−D₁ ω sin(ωt)</strong>. Therefore:
                <span style="font-family:var(--mono);">d₂(t) = (b/k) D₁ ω sin(ωt)</span>.
                But the suspension point is specified as <strong>d₂(t)=D₂ cos(ωt+φ)</strong>.
                Use the identity <span style="font-family:var(--mono);">sin(ωt)=cos(ωt − π/2)</span> to match amplitude and phase.
              </p>
              <div class="eq" data-copy="eqE2">
                <button class="copyBtn" data-copy-btn="eqE2">Copy</button>
                <pre><code id="eqE2">Required cancellation drive:
D₂ = (b ω / k) D₁
φ = −π/2   (equivalently 3π/2)</code></pre>
              </div>
              <div class="callout" style="margin-top:12px;">
                <div class="badge">★</div>
                <div class="muted">
                  Interpretation: the suspension point must move <strong>90° out of phase</strong> with the cup displacement so that the spring drive exactly cancels the viscous coupling from the moving fluid.
                </div>
              </div>
            </div>

            <div class="grid2" style="margin-top:14px;">
              <div class="card">
                <h3>Sanity checks</h3>
                <ul class="muted">
                  <li>
                    <strong>Units:</strong> In (b), RHS is <span style="font-family:var(--mono);">b ḋ₁</span>.
                    Since <span style="font-family:var(--mono);">b</span> is N·s/m and <span style="font-family:var(--mono);">ḋ₁</span> is m/s, product is N — correct for force.
                  </li>
                  <li>
                    <strong>Limiting case b → 0:</strong> Cup-only amplitude (c) gives <span style="font-family:var(--mono);">|X| → 0</span>.
                    If there’s no viscous coupling, moving the cup doesn’t drive the mass — correct.
                  </li>
                  <li>
                    <strong>Low frequency ω → 0:</strong> Cup-only amplitude (c) gives <span style="font-family:var(--mono);">|X| ~ (b D₁ ω)/k → 0</span>.
                    Quasi-static slow cup motion produces negligible relative-velocity drag — correct.
                  </li>
                  <li>
                    <strong>High frequency ω → ∞:</strong> <span style="font-family:var(--mono);">|X| ~ (b D₁ ω)/(m ω²) = (b D₁)/(m ω) → 0</span>.
                    Inertia dominates, mass can’t follow rapidly — correct.
                  </li>
                  <li>
                    <strong>Cancellation:</strong> If <span style="font-family:var(--mono);">d₂ = −(b/k) ḋ₁</span>, then RHS in (d) is exactly zero, leaving homogeneous dynamics; steady-state forced motion vanishes — correct.
                  </li>
                </ul>
              </div>

              <div class="card">
                <h3>Physical interpretation (what the math is saying)</h3>
                <ul class="muted">
                  <li><strong>Drag is the coupling</strong> between cup motion and the mass: the water “pulls” on the mass only when there is relative velocity.</li>
                  <li><strong>Resonance still exists</strong> because the system is a damped oscillator; even a drag-based drive can excite it.</li>
                  <li><strong>Cancellation drive</strong> is a simple vibration-isolation idea: move the suspension to counteract the fluid-induced forcing.</li>
                </ul>
              </div>
            </div>
          </div>
        </section>

        <section id="final">
          <header>
            <h2>Final Boxed Results (copy-ready)</h2>
            <div class="muted">Key equations and answers</div>
          </header>
          <div class="content">
            <div class="boxFinal">
              <h3>Answer set (a)–(e)</h3>

              <div class="eq" data-copy="eqFinal">
                <button class="copyBtn" data-copy-btn="eqFinal">Copy</button>
                <pre><code id="eqFinal">(a) Cup at rest:
m ẍ + b ẋ + k x = 0

(b) Cup driven with d₁(t)=D₁ cos(ωt):
m ẍ + b ẋ + k x = b ḋ₁(t) = − b D₁ ω sin(ωt)

(c) Steady-state amplitude (cup-only):
|X(ω)| = (b D₁ ω) / √[(k − m ω²)² + (b ω)²]

(d) Both cup and spring-end driven, d₂(t)=D₂ cos(ωt+φ):
m ẍ + b ẋ + k x = b ḋ₁(t) + k d₂(t)
= −b D₁ ω sin(ωt) + k D₂ cos(ωt+φ)

(e) Choose D₂ and φ so steady-state x(t)=0:
d₂(t) = −(b/k) ḋ₁(t)  ⇒  D₂ = (b ω / k) D₁,  φ = −π/2 (mod 2π)</code></pre>
              </div>
            </div>
          </div>
        </section>
      </article>
    </div>
  </main>

  <footer class="foot">
    <div>
      Built as a self-contained HTML article (vanilla HTML/CSS/JS). Canvas plots are illustrative using example values; symbolic results above are general.
    </div>
  </footer>

  <div class="toast" id="toast" role="status" aria-live="polite">Copied.</div>

  <script>
    // ---------- Utilities ----------
    const TAU = Math.PI * 2;

    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
    function fmt(x, digits=3){
      if (!isFinite(x)) return "—";
      const abs = Math.abs(x);
      if (abs >= 1000) return x.toFixed(0);
      if (abs >= 100) return x.toFixed(1);
      if (abs >= 10) return x.toFixed(2);
      if (abs >= 1) return x.toFixed(3);
      return x.toFixed(digits);
    }
    function showToast(msg){
      const t = document.getElementById('toast');
      t.textContent = msg;
      t.classList.add('show');
      clearTimeout(showToast._timer);
      showToast._timer = setTimeout(()=>t.classList.remove('show'), 1100);
    }

    // ---------- Copy buttons ----------
    document.querySelectorAll('[data-copy-btn]').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const id = btn.getAttribute('data-copy-btn');
        const el = document.getElementById(id);
        const text = el ? el.textContent.trim() : '';
        navigator.clipboard.writeText(text).then(()=>showToast('Copied equation text.'));
      });
    });

    // ---------- Controls ----------
    const els = {
      m: document.getElementById('m'),
      k: document.getElementById('k'),
      b: document.getElementById('b'),
      D1: document.getElementById('D1'),
      w: document.getElementById('w'),
      D2: document.getElementById('D2'),
      phi: document.getElementById('phi'),
      mode: document.getElementById('mode'),

      mVal: document.getElementById('mVal'),
      kVal: document.getElementById('kVal'),
      bVal: document.getElementById('bVal'),
      D1Val: document.getElementById('D1Val'),
      wVal: document.getElementById('wVal'),
      D2Val: document.getElementById('D2Val'),
      phiVal: document.getElementById('phiVal'),
      modeVal: document.getElementById('modeVal'),

      btnCancel: document.getElementById('btnCancel'),
      btnReset: document.getElementById('btnReset'),
      btnPause: document.getElementById('btnPause'),
    };

    const state = {
      m: 1.0,
      k: 20.0,
      b: 2.0,
      D1: 0.05,
      w: 4.0,
      D2: 0.0,
      phi: 0.0,
      mode: 'cup',
      paused: false,
      t0: performance.now()/1000
    };

    function syncUI(){
      els.mVal.textContent = fmt(state.m, 2);
      els.kVal.textContent = fmt(state.k, 1);
      els.bVal.textContent = fmt(state.b, 2);
      els.D1Val.textContent = state.D1.toFixed(3);
      els.wVal.textContent = fmt(state.w, 2);
      els.D2Val.textContent = state.D2.toFixed(3);
      els.phiVal.textContent = fmt(state.phi, 3);
      els.modeVal.textContent = (state.mode==='cup') ? 'Cup-only' : 'Cup + spring-end';

      // Disable D2/phi sliders in cup-only mode (still show but visually)
      const dis = (state.mode === 'cup');
      els.D2.disabled = dis;
      els.phi.disabled = dis;
      els.D2.parentElement.style.opacity = dis ? .55 : 1;
      els.phi.parentElement.style.opacity = dis ? .55 : 1;
    }

    function readUI(){
      state.m = parseFloat(els.m.value);
      state.k = parseFloat(els.k.value);
      state.b = parseFloat(els.b.value);
      state.D1 = parseFloat(els.D1.value);
      state.w = parseFloat(els.w.value);
      state.D2 = parseFloat(els.D2.value);
      state.phi = parseFloat(els.phi.value);
      state.mode = els.mode.value;
      syncUI();
      redrawAll();
    }

    ['m','k','b','D1','w','D2','phi','mode'].forEach(id=>{
      els[id].addEventListener('input', readUI);
      els[id].addEventListener('change', readUI);
    });

    els.btnReset.addEventListener('click', ()=>{
      els.m.value = 1.0;
      els.k.value = 20.0;
      els.b.value = 2.0;
      els.D1.value = 0.05;
      els.w.value = 4.0;
      els.D2.value = 0.0;
      els.phi.value = 0.0;
      els.mode.value = 'cup';
      readUI();
      showToast('Reset example values.');
    });

    els.btnPause.addEventListener('click', ()=>{
      state.paused = !state.paused;
      els.btnPause.textContent = state.paused ? 'Resume animation' : 'Pause animation';
      if(!state.paused){
        state.t0 = performance.now()/1000;
      }
      showToast(state.paused ? 'Animation paused.' : 'Animation resumed.');
    });

    els.btnCancel.addEventListener('click', ()=>{
      // Set cancellation for current omega: D2 = (b ω / k) D1, phi = -pi/2
      const D2 = (state.k === 0) ? 0 : (state.b * state.w / state.k) * state.D1;
      const phi = -Math.PI/2;
      els.mode.value = 'both';
      els.D2.value = clamp(D2, parseFloat(els.D2.min), parseFloat(els.D2.max));
      els.phi.value = phi;
      readUI();
      showToast('Cancellation parameters applied.');
    });

    // ---------- Complex arithmetic ----------
    function c(re, im){ return {re, im}; }
    function cAdd(a,b){ return c(a.re+b.re, a.im+b.im); }
    function cMul(a,b){ return c(a.re*b.re - a.im*b.im, a.re*b.im + a.im*b.re); }
    function cAbs(a){ return Math.hypot(a.re, a.im); }
    function cArg(a){ return Math.atan2(a.im, a.re); }

    // phasor for X: X = [ i b D1 ω + k D2 e^{iφ} ] / [ (k - m ω^2) + i b ω ]
    function phasorX(omega){
      const m = state.m, k = state.k, b = state.b, D1 = state.D1;
      const Z = c(k - m*omega*omega, b*omega);
      const cup = c(0, b*D1*omega); // i b D1 ω
      let rhs = cup;
      if(state.mode === 'both'){
        const D2 = state.D2, phi = state.phi;
        const springDrive = c(k*D2*Math.cos(phi), k*D2*Math.sin(phi));
        rhs = cAdd(cup, springDrive);
      }
      // divide rhs/Z
      const denom = Z.re*Z.re + Z.im*Z.im;
      return c( (rhs.re*Z.re + rhs.im*Z.im)/denom, (rhs.im*Z.re - rhs.re*Z.im)/denom );
    }

    // ---------- Canvas drawing helpers ----------
    function setupCanvas(canvas){
      const ctx = canvas.getContext('2d');
      function resize(){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        const w = Math.max(240, rect.width);
        const h = Math.max(220, rect.height);
        canvas.width = Math.floor(w*dpr);
        canvas.height = Math.floor(h*dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        return {w, h, dpr};
      }
      return {ctx, resize};
    }

    function drawGrid(ctx, x0,y0,w,h, xTicks=5, yTicks=5){
      ctx.save();
      ctx.globalAlpha = 0.85;
      ctx.lineWidth = 1;
      for(let i=0;i<=xTicks;i++){
        const x = x0 + (w*i/xTicks);
        ctx.strokeStyle = 'rgba(255,255,255,0.07)';
        ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y0+h); ctx.stroke();
      }
      for(let j=0;j<=yTicks;j++){
        const y = y0 + (h*j/yTicks);
        ctx.strokeStyle = 'rgba(255,255,255,0.07)';
        ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x0+w,y); ctx.stroke();
      }
      ctx.restore();
    }

    function drawAxes(ctx, plot, xLabel, yLabel){
      const {x0,y0,w,h} = plot;
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.22)';
      ctx.lineWidth = 1.2;
      ctx.beginPath(); ctx.moveTo(x0,y0+h); ctx.lineTo(x0+w,y0+h); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x0,y0+h); ctx.stroke();

      ctx.fillStyle = 'rgba(233,238,247,0.85)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.textAlign='center';
      ctx.fillText(xLabel, x0+w/2, y0+h+34);
      ctx.save();
      ctx.translate(x0-34, y0+h/2);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();
      ctx.restore();
    }

    function drawTicks(ctx, plot, xMin,xMax,yMin,yMax, nx=5, ny=5){
      const {x0,y0,w,h} = plot;
      ctx.save();
      ctx.fillStyle='rgba(233,238,247,0.75)';
      ctx.font='11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.strokeStyle='rgba(255,255,255,0.16)';
      ctx.lineWidth=1;

      // x ticks
      ctx.textAlign='center';
      for(let i=0;i<=nx;i++){
        const xv = xMin + (xMax-xMin)*i/nx;
        const x = x0 + w*i/nx;
        ctx.beginPath(); ctx.moveTo(x, y0+h); ctx.lineTo(x, y0+h+6); ctx.stroke();
        ctx.fillText(fmt(xv,2), x, y0+h+18);
      }
      // y ticks
      ctx.textAlign='right';
      for(let j=0;j<=ny;j++){
        const yv = yMin + (yMax-yMin)*(ny-j)/ny;
        const y = y0 + h*j/ny;
        ctx.beginPath(); ctx.moveTo(x0-6, y); ctx.lineTo(x0, y); ctx.stroke();
        ctx.fillText(fmt(yv,2), x0-10, y+4);
      }
      ctx.restore();
    }

    function mapX(x, xMin,xMax, plot){ return plot.x0 + plot.w*(x-xMin)/(xMax-xMin); }
    function mapY(y, yMin,yMax, plot){ return plot.y0 + plot.h*(1-(y-yMin)/(yMax-yMin)); }

    function drawLine(ctx, plot, xs, ys, xMin,xMax,yMin,yMax, strokeStyle='rgba(125,211,252,0.95)', width=2){
      ctx.save();
      ctx.strokeStyle = strokeStyle;
      ctx.lineWidth = width;
      ctx.lineJoin = 'round';
      ctx.lineCap = 'round';
      ctx.beginPath();
      for(let i=0;i<xs.length;i++){
        const X = mapX(xs[i], xMin,xMax, plot);
        const Y = mapY(ys[i], yMin,yMax, plot);
        if(i===0) ctx.moveTo(X,Y);
        else ctx.lineTo(X,Y);
      }
      ctx.stroke();
      ctx.restore();
    }

    function drawVLine(ctx, plot, x, xMin,xMax, color='rgba(255,255,255,0.35)'){
      const X = mapX(x, xMin,xMax, plot);
      ctx.save();
      ctx.strokeStyle = color;
      ctx.lineWidth = 1.5;
      ctx.setLineDash([6,6]);
      ctx.beginPath(); ctx.moveTo(X, plot.y0); ctx.lineTo(X, plot.y0+plot.h); ctx.stroke();
      ctx.restore();
    }

    // ---------- Canvases ----------
    const canSetup = setupCanvas(document.getElementById('canSetup'));
    const canAmp   = setupCanvas(document.getElementById('canAmp'));
    const canPhase = setupCanvas(document.getElementById('canPhase'));
    const canTime  = setupCanvas(document.getElementById('canTime'));

    // ---------- Drawing: Setup diagram ----------
    function drawSetup(){
      const {ctx, resize} = canSetup;
      const {w,h} = resize();
      ctx.clearRect(0,0,w,h);

      const pad = 18;
      const left = pad, top = pad, right = w-pad, bottom = h-pad;
      const midX = left + (right-left)*0.35;

      // Cup rectangle
      const cupX = left + (right-left)*0.22;
      const cupW = (right-left)*0.50;
      const cupY = top + (bottom-top)*0.20;
      const cupH = (bottom-top)*0.62;

      ctx.save();
      // subtle title
      ctx.fillStyle='rgba(233,238,247,0.85)';
      ctx.font='12px ' + getComputedStyle(document.body).fontFamily;
      ctx.fillText('Spring–mass in moving cup (water)', left, top-2);
      ctx.restore();

      // Cup outline
      ctx.save();
      ctx.strokeStyle='rgba(255,255,255,0.28)';
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.rect(cupX, cupY, cupW, cupH);
      ctx.stroke();
      ctx.restore();

      // Water fill
      const waterY = cupY + cupH*0.16;
      ctx.save();
      ctx.fillStyle='rgba(125,211,252,0.10)';
      ctx.fillRect(cupX+1, waterY, cupW-2, cupY+cupH-waterY-1);
      // hatch lines
      ctx.strokeStyle='rgba(125,211,252,0.14)';
      ctx.lineWidth=1;
      for(let x=cupX- cupH; x<cupX+cupW+cupH; x+=12){
        ctx.beginPath();
        ctx.moveTo(x, waterY);
        ctx.lineTo(x+cupH*0.8, cupY+cupH);
        ctx.stroke();
      }
      ctx.restore();

      // A (suspension point) position line
      const A_y = top + 16;
      const A_x = midX;
      ctx.save();
      ctx.strokeStyle='rgba(255,255,255,0.30)';
      ctx.setLineDash([6,6]);
      ctx.beginPath();
      ctx.moveTo(A_x-70, A_y);
      ctx.lineTo(A_x+70, A_y);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle='rgba(233,238,247,0.85)';
      ctx.font='12px ' + getComputedStyle(document.body).fontFamily;
      ctx.fillText('A (spring end)  d₂(t)', A_x+78, A_y+4);
      ctx.restore();

      // Draw spring from A down into cup
      const springTopY = A_y;
      const springBottomY = waterY + (cupY+cupH-waterY)*0.25;
      const coils = 10;
      const amp = 10;
      ctx.save();
      ctx.strokeStyle='rgba(233,238,247,0.75)';
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.moveTo(A_x, springTopY);
      for(let i=1;i<=coils;i++){
        const t = i/coils;
        const y = springTopY + (springBottomY-springTopY)*t;
        const x = A_x + (i%2===0 ? -amp : amp);
        ctx.lineTo(x,y);
      }
      ctx.lineTo(A_x, springBottomY+10);
      ctx.stroke();
      ctx.restore();

      // Mass (circle)
      const massX = A_x;
      // steady-state example y based on x(t) instantaneous
      const tNow = (performance.now()/1000 - state.t0);
      const omega = state.w;
      const X = phasorX(omega);
      const xNow = state.paused ? 0 : (X.re*Math.cos(omega*tNow) - X.im*Math.sin(omega*tNow));
      const yBase = springBottomY + 34;
      const massY = yBase + xNow*120; // visual scale

      ctx.save();
      ctx.fillStyle='rgba(233,238,247,0.9)';
      ctx.beginPath();
      ctx.arc(massX, massY, 12, 0, TAU);
      ctx.fill();
      ctx.strokeStyle='rgba(0,0,0,0.35)';
      ctx.lineWidth=2;
      ctx.stroke();
      ctx.restore();

      // B equilibrium line
      const B_y = yBase;
      ctx.save();
      ctx.strokeStyle='rgba(255,255,255,0.28)';
      ctx.setLineDash([6,6]);
      ctx.beginPath();
      ctx.moveTo(A_x+32, B_y);
      ctx.lineTo(right-8, B_y);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle='rgba(233,238,247,0.85)';
      ctx.font='12px ' + getComputedStyle(document.body).fontFamily;
      ctx.fillText('B (equilibrium, cup at rest)', A_x+36, B_y-6);
      ctx.restore();

      // x(t) arrow
      ctx.save();
      const arrowX = A_x-58;
      ctx.strokeStyle='rgba(52,211,153,0.85)';
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.moveTo(arrowX, B_y);
      ctx.lineTo(arrowX, massY);
      ctx.stroke();
      // arrow head
      const dir = (massY>B_y)?1:-1;
      ctx.beginPath();
      ctx.moveTo(arrowX, massY);
      ctx.lineTo(arrowX-6, massY-10*dir);
      ctx.lineTo(arrowX+6, massY-10*dir);
      ctx.closePath();
      ctx.fillStyle='rgba(52,211,153,0.85)';
      ctx.fill();
      ctx.fillStyle='rgba(233,238,247,0.85)';
      ctx.font='12px ' + getComputedStyle(document.body).fontFamily;
      ctx.fillText('x(t)', arrowX-14, (B_y+massY)/2 - 4);
      ctx.restore();

      // C bottom reference and d1(t)
      const C_y = cupY + cupH;
      ctx.save();
      ctx.strokeStyle='rgba(255,255,255,0.28)';
      ctx.setLineDash([6,6]);
      ctx.beginPath();
      ctx.moveTo(cupX+cupW+10, C_y);
      ctx.lineTo(right-8, C_y);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle='rgba(233,238,247,0.85)';
      ctx.font='12px ' + getComputedStyle(document.body).fontFamily;
      ctx.fillText('C (cup bottom)  d₁(t)', cupX+cupW+14, C_y-6);
      ctx.restore();

      // show d1 motion arrow at bottom
      ctx.save();
      const d1Now = state.paused ? 0 : state.D1*Math.cos(omega*tNow);
      const baseX = cupX + cupW*0.82;
      const baseY = C_y + 10;
      ctx.strokeStyle='rgba(167,139,250,0.9)';
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.moveTo(baseX, baseY);
      ctx.lineTo(baseX, baseY + d1Now*140);
      ctx.stroke();
      ctx.fillStyle='rgba(167,139,250,0.9)';
      ctx.beginPath();
      ctx.arc(baseX, baseY + d1Now*140, 3.5, 0, TAU);
      ctx.fill();
      ctx.fillStyle='rgba(233,238,247,0.80)';
      ctx.font='11px ' + getComputedStyle(document.body).fontFamily;
      ctx.fillText('cup motion', baseX+10, baseY + d1Now*140 + 4);
      ctx.restore();
    }

    // ---------- Plot: amplitude vs omega ----------
    function drawAmp(){
      const {ctx, resize} = canAmp;
      const {w,h} = resize();
      ctx.clearRect(0,0,w,h);

      const plot = {x0:56, y0:20, w:w-76, h:h-68};

      // data sweep
      const wMin = 0.01, wMax = 20.0;
      const N = 600;
      const xs = new Array(N);
      const ys = new Array(N);
      let yMax = 0;

      const m = state.m, k = state.k, b = state.b, D1 = state.D1;

      for(let i=0;i<N;i++){
        const om = wMin + (wMax-wMin)*i/(N-1);
        xs[i] = om;

        // compute |X|
        const Zre = k - m*om*om;
        const Zim = b*om;
        const Zabs = Math.hypot(Zre, Zim);

        // RHS magnitude depends on mode
        let rhsAbs;
        if(state.mode === 'cup'){
          rhsAbs = b*D1*om;
        }else{
          // | i b D1 om + k D2 e^{iφ} |
          const cup = c(0, b*D1*om);
          const spring = c(k*state.D2*Math.cos(state.phi), k*state.D2*Math.sin(state.phi));
          rhsAbs = cAbs(cAdd(cup, spring));
        }
        const amp = (Zabs>0) ? (rhsAbs / Zabs) : 0;
        ys[i] = amp;
        if(amp > yMax) yMax = amp;
      }

      // axis ranges
      const xMin = 0, xMax = 20;
      const yMin = 0;
      const yMaxNice = (yMax <= 1e-9) ? 1 : (Math.ceil(yMax*10)/10);

      // background grid + axes
      drawGrid(ctx, plot.x0, plot.y0, plot.w, plot.h, 5, 5);
      drawAxes(ctx, plot, 'ω (rad/s)', '|X| (m)');
      drawTicks(ctx, plot, xMin,xMax,yMin,yMaxNice, 5, 5);

      // curve
      drawLine(ctx, plot, xs, ys, xMin,xMax, yMin,yMaxNice, 'rgba(125,211,252,0.95)', 2.2);

      // marker line at current omega
      drawVLine(ctx, plot, state.w, xMin,xMax, 'rgba(255,255,255,0.35)');

      // annotate current point
      const Xnow = phasorX(state.w);
      const ampNow = cAbs(Xnow);
      const px = mapX(state.w, xMin,xMax, plot);
      const py = mapY(ampNow, yMin,yMaxNice, plot);

      ctx.save();
      ctx.fillStyle = 'rgba(233,238,247,0.92)';
      ctx.beginPath(); ctx.arc(px, py, 4.5, 0, TAU); ctx.fill();
      ctx.strokeStyle='rgba(0,0,0,0.35)'; ctx.lineWidth=2; ctx.stroke();

      ctx.fillStyle='rgba(233,238,247,0.80)';
      ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      const label = `|X| @ ω=${fmt(state.w,2)} ≈ ${fmt(ampNow,4)} m`;
      ctx.fillText(label, plot.x0+8, plot.y0+14);
      ctx.restore();

      // legend
      ctx.save();
      ctx.fillStyle='rgba(233,238,247,0.75)';
      ctx.font='12px ' + getComputedStyle(document.body).fontFamily;
      const modeText = (state.mode==='cup') ? 'cup-only: RHS = b ḋ₁' : 'both drives: RHS = b ḋ₁ + k d₂';
      ctx.fillText(modeText, plot.x0+8, plot.y0+plot.h+52);
      ctx.restore();
    }

    // ---------- Plot: phase vs omega ----------
    function drawPhase(){
      const {ctx, resize} = canPhase;
      const {w,h} = resize();
      ctx.clearRect(0,0,w,h);

      const plot = {x0:56, y0:20, w:w-76, h:h-68};

      const wMin = 0.01, wMax = 20.0;
      const N = 600;
      const xs = new Array(N);
      const ys = new Array(N);

      for(let i=0;i<N;i++){
        const om = wMin + (wMax-wMin)*i/(N-1);
        xs[i] = om;
        // phase of X
        const m = state.m, k = state.k, b = state.b, D1 = state.D1;

        const Z = c(k - m*om*om, b*om);
        const cup = c(0, b*D1*om);
        let rhs = cup;
        if(state.mode==='both'){
          const spring = c(k*state.D2*Math.cos(state.phi), k*state.D2*Math.sin(state.phi));
          rhs = cAdd(cup, spring);
        }
        // X = rhs/Z => arg(X)=arg(rhs)-arg(Z)
        const ph = cArg(rhs) - cArg(Z);
        // wrap to [-pi, pi]
        let wrapped = ph;
        while(wrapped > Math.PI) wrapped -= TAU;
        while(wrapped < -Math.PI) wrapped += TAU;
        ys[i] = wrapped;
      }

      const xMin = 0, xMax = 20;
      const yMin = -Math.PI, yMax = Math.PI;

      drawGrid(ctx, plot.x0, plot.y0, plot.w, plot.h, 5, 4);
      drawAxes(ctx, plot, 'ω (rad/s)', 'arg(X) (rad)');
      drawTicks(ctx, plot, xMin,xMax,yMin,yMax, 5, 4);

      drawLine(ctx, plot, xs, ys, xMin,xMax,yMin,yMax, 'rgba(167,139,250,0.95)', 2.2);
      drawVLine(ctx, plot, state.w, xMin,xMax, 'rgba(255,255,255,0.35)');

      const Xnow = phasorX(state.w);
      const phNow = cArg(Xnow);
      const px = mapX(state.w, xMin,xMax, plot);
      const py = mapY(phNow, yMin,yMax, plot);

      ctx.save();
      ctx.fillStyle='rgba(233,238,247,0.92)';
      ctx.beginPath(); ctx.arc(px, py, 4.5, 0, TAU); ctx.fill();
      ctx.strokeStyle='rgba(0,0,0,0.35)'; ctx.lineWidth=2; ctx.stroke();

      ctx.fillStyle='rgba(233,238,247,0.80)';
      ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(`phase @ ω=${fmt(state.w,2)} ≈ ${fmt(phNow,3)} rad`, plot.x0+8, plot.y0+14);

      // y-axis reference lines at 0, +/- pi/2
      ctx.strokeStyle='rgba(255,255,255,0.18)';
      ctx.setLineDash([5,6]);
      [0, Math.PI/2, -Math.PI/2].forEach(val=>{
        const y = mapY(val, yMin,yMax, plot);
        ctx.beginPath(); ctx.moveTo(plot.x0, y); ctx.lineTo(plot.x0+plot.w, y); ctx.stroke();
      });
      ctx.setLineDash([]);

      ctx.restore();
    }

    // ---------- Plot: time response ----------
    function drawTime(){
      const {ctx, resize} = canTime;
      const {w,h} = resize();
      ctx.clearRect(0,0,w,h);

      const plot = {x0:56, y0:20, w:w-76, h:h-68};

      const omega = state.w;
      const X = phasorX(omega);
      const amp = cAbs(X);

      // choose time window: 0 .. T*2 (or something stable)
      const T = TAU / omega;
      const tMin = 0;
      const tMax = 2*T;

      const N = 520;
      const xs = new Array(N);
      const ys = new Array(N);

      for(let i=0;i<N;i++){
        const t = tMin + (tMax-tMin)*i/(N-1);
        xs[i] = t;
        // x(t)=Re{ X e^{i ω t} } = Xre cos - Xim sin
        ys[i] = X.re*Math.cos(omega*t) - X.im*Math.sin(omega*t);
      }

      // y range: symmetric around 0
      const yPad = 0.12;
      const yMax = (amp<=1e-9) ? 1 : amp*(1+yPad);
      const yMin = -yMax;

      drawGrid(ctx, plot.x0, plot.y0, plot.w, plot.h, 6, 5);
      drawAxes(ctx, plot, 't (s)', 'x(t) (m)');
      drawTicks(ctx, plot, tMin,tMax,yMin,yMax, 6, 5);

      // x(t)
      drawLine(ctx, plot, xs, ys, tMin,tMax,yMin,yMax, 'rgba(52,211,153,0.95)', 2.2);

      // add zero line
      ctx.save();
      ctx.strokeStyle='rgba(255,255,255,0.18)';
      ctx.setLineDash([5,6]);
      const y0line = mapY(0, yMin,yMax, plot);
      ctx.beginPath(); ctx.moveTo(plot.x0, y0line); ctx.lineTo(plot.x0+plot.w, y0line); ctx.stroke();
      ctx.setLineDash([]);
      ctx.restore();

      // annotate
      ctx.save();
      ctx.fillStyle='rgba(233,238,247,0.80)';
      ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      const modeText = (state.mode==='cup') ? 'cup-only' : 'both';
      ctx.fillText(`steady-state x(t) — mode=${modeText}, |X|≈${fmt(amp,4)} m`, plot.x0+8, plot.y0+14);
      ctx.restore();
    }

    // ---------- Redraw all ----------
    function redrawAll(){
      drawSetup();
      drawAmp();
      drawPhase();
      drawTime();
    }

    // ---------- Animation loop (diagram only needs time) ----------
    function loop(){
      if(!state.paused){
        // Just redraw setup diagram and time plot to animate (amp/phase static)
        drawSetup();
        drawTime();
      }
      requestAnimationFrame(loop);
    }

    // ---------- Initial ----------
    function init(){
      // set UI from defaults
      syncUI();
      redrawAll();
      window.addEventListener('resize', redrawAll);
      loop();
    }

    readUI();
    init();

    // Smooth scrolling for TOC links
    document.querySelectorAll('nav.toc a[href^="#"]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const id = a.getAttribute('href').slice(1);
        const el = document.getElementById(id);
        if(el){
          el.scrollIntoView({behavior:'smooth', block:'start'});
        }
      });
    });
  </script>
</body>
</html>
