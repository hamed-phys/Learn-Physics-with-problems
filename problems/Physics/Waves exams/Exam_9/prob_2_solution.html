<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Cyclotron Radiation from an Accelerating Charge — Full Solution</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#101827;
      --panel2:#0f172a;
      --text:#e6edf7;
      --muted:#a7b3c7;
      --line:rgba(255,255,255,.10);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 30% 10%, rgba(125,211,252,.12), transparent 55%),
                  radial-gradient(900px 700px at 85% 25%, rgba(167,139,250,.10), transparent 60%),
                  linear-gradient(180deg, var(--bg), #070a10);
      color:var(--text);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding: clamp(18px, 3vw, 34px) clamp(16px, 4vw, 42px);
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,24,39,.65), rgba(16,24,39,.18));
      backdrop-filter: blur(8px);
      position:relative;
      overflow:hidden;
    }
    header::after{
      content:"";
      position:absolute;
      inset:-40px -80px auto auto;
      width:520px;height:520px;
      background: radial-gradient(circle at 30% 30%, rgba(125,211,252,.22), transparent 60%),
                  radial-gradient(circle at 60% 60%, rgba(167,139,250,.18), transparent 62%);
      transform: rotate(12deg);
      pointer-events:none;
    }
    .title{
      max-width:1100px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:22px;
      align-items:start;
    }
    h1{
      margin:0 0 8px 0;
      font-size: clamp(22px, 2.4vw, 34px);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: clamp(13px, 1.3vw, 15px);
    }

    main{
      max-width:1100px;
      margin:0 auto;
      padding: clamp(16px, 3vw, 34px) clamp(14px, 4vw, 42px) 70px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      align-items:start;
    }

    /* Sticky mini TOC */
    nav#toc{
      position: sticky;
      top: 14px;
      align-self:start;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,24,39,.78), rgba(16,24,39,.42));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px 10px;
    }
    #toc h2{
      margin:0 0 10px;
      font-size:14px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    .toc-list{
      list-style:none;
      padding:0;margin:0;
      display:grid;
      gap:8px;
    }
    .toc-list a{
      display:flex;
      gap:10px;
      align-items:center;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid transparent;
      background: rgba(255,255,255,.03);
      color:var(--text);
      font-size:13px;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .toc-list a:hover{
      transform: translateY(-1px);
      background: rgba(125,211,252,.08);
      border-color: rgba(125,211,252,.18);
      text-decoration:none;
    }
    .dot{
      width:10px;height:10px;border-radius:99px;
      background: rgba(125,211,252,.65);
      box-shadow: 0 0 0 4px rgba(125,211,252,.10);
      flex:0 0 auto;
    }

    article{
      display:grid;
      gap:16px;
    }

    .card{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(16,24,39,.72), rgba(16,24,39,.40));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card > .hd{
      padding:14px 16px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      background: rgba(255,255,255,.02);
    }
    .card .hd h2, .card .hd h3{
      margin:0;
      font-size:15px;
      letter-spacing:.03em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .card .bd{
      padding:14px 16px 16px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
      nav#toc{position:relative; top:auto}
      .title{grid-template-columns: 1fr}
      .grid2{grid-template-columns: 1fr}
    }

    .summary{
      display:flex;flex-wrap:wrap;gap:10px;
      margin:10px 0 0;
      padding:0;
      list-style:none;
    }
    .pill{
      border:1px solid rgba(125,211,252,.22);
      background: rgba(125,211,252,.08);
      padding:8px 10px;
      border-radius:999px;
      font-size:13px;
      color:var(--text);
    }

    .callouts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .callouts{grid-template-columns:1fr} }
    .callout{
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px 10px;
      background: rgba(255,255,255,.03);
    }
    .callout strong{color:var(--accent)}
    .muted{color:var(--muted)}
    ul,ol{margin:10px 0 0 18px}
    li{margin:6px 0}

    .eq{
      margin:10px 0;
      border:1px solid rgba(167,139,250,.22);
      background: rgba(167,139,250,.08);
      border-radius:16px;
      padding:10px 10px 10px 12px;
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    .eq pre{
      margin:0;
      font-family:var(--mono);
      font-size: 13px;
      white-space: pre-wrap;
      word-break: break-word;
      line-height:1.4;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.05);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:12px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(255,255,255,.08); border-color: rgba(125,211,252,.20)}
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn.primary{
      border-color: rgba(125,211,252,.35);
      background: rgba(125,211,252,.10);
    }
    .btn.primary:hover{background: rgba(125,211,252,.14)}
    .btn.good{border-color: rgba(52,211,153,.35); background: rgba(52,211,153,.10)}
    .btn.warn{border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.10)}

    .boxfinal{
      border:1px solid rgba(52,211,153,.28);
      background: rgba(52,211,153,.08);
      border-radius: 18px;
      padding:14px 14px 12px;
      margin-top:12px;
    }
    .boxfinal h3{
      margin:0 0 8px 0;
      font-size:14px;
      letter-spacing:.08em;
      text-transform:uppercase;
      color:rgba(52,211,153,.95);
    }
    .boxfinal pre{
      margin:0;
      font-family:var(--mono);
      font-size:13px;
      white-space:pre-wrap;
      word-break:break-word;
    }

    /* Viz */
    figure{margin:0}
    .vizWrap{
      padding:12px 12px 14px;
      display:grid;
      gap:10px;
    }
    .vizTop{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      flex-wrap:wrap;
      gap:10px;
    }
    .vizTitle{
      margin:0;
      font-size:15px;
      color:var(--text);
    }
    .vizMeta{
      font-size:12px;
      color:var(--muted);
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius:16px;
      border:1px solid var(--line);
      background: radial-gradient(900px 380px at 40% 25%, rgba(255,255,255,.035), rgba(255,255,255,.015));
    }
    .controls{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    @media (max-width: 980px){
      canvas{height:300px}
      .controls{grid-template-columns: 1fr}
    }
    label{
      display:grid;
      gap:6px;
      font-size:12px;
      color:var(--muted);
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    select, input[type="number"]{
      width:100%;
      padding:10px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      color: var(--text);
      outline:none;
    }
    .readout{
      font-family: var(--mono);
      font-size:12px;
      color: var(--text);
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.03);
    }
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .kpiRow{grid-template-columns:1fr 1fr} }
    .kpi{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius:16px;
      padding:10px 10px 9px;
    }
    .kpi .k{font-size:11px;color:var(--muted)}
    .kpi .v{font-family:var(--mono); margin-top:4px; font-size:12px}
    footer{
      max-width:1100px;
      margin:0 auto;
      padding: 0 42px 34px;
      color: var(--muted);
      font-size:12px;
    }
    @media print{
      body{background:#fff;color:#000}
      header, nav#toc{display:none !important}
      .card{box-shadow:none}
      canvas{border:1px solid #999}
      .btn{display:none}
      a{color:#000;text-decoration:underline}
    }
  </style>
</head>

<body>
<header>
  <div class="title">
    <div>
      <h1>Cyclotron Radiation from an Accelerating Charge</h1>
      <p class="subtitle">
        Non-relativistic charge (v ≪ c) in a uniform magnetic field: circular motion, cyclotron frequency, and far-field radiation + polarization.
      </p>

      <ul class="summary" aria-label="Quick Summary">
        <li class="pill">Radius: <span style="font-family:var(--mono)">R = m v0 / (q B0)</span></li>
        <li class="pill">Cyclotron freq: <span style="font-family:var(--mono)">ω = q B0 / m</span></li>
        <li class="pill">Acceleration: <span style="font-family:var(--mono)">|a| = v0 ω = q B0 v0 / m</span></li>
        <li class="pill">Far field: <span style="font-family:var(--mono)">E = (q/(4πϵ0 c² r)) [n×(n×a)]</span></li>
        <li class="pill">On axis (+z): circular polarization</li>
      </ul>
    </div>

    <div class="card" style="margin-top:4px">
      <div class="hd">
        <h2>Interactive Parameters</h2>
        <button class="btn primary" id="btnReset" type="button">Reset example values</button>
      </div>
      <div class="bd">
        <div class="controls">
          <label>
            Particle preset (q, m)
            <select id="preset">
              <option value="electron">Electron (q = e, m = mₑ)</option>
              <option value="proton" selected>Proton (q = e, m = mₚ)</option>
              <option value="custom">Custom</option>
            </select>
          </label>

          <label>
            Magnetic field B0 (T)
            <input id="B0" type="range" min="0.05" max="2.0" step="0.01" value="0.50" />
            <div class="readout" id="B0r">0.50 T</div>
          </label>

          <label>
            Speed v0 (m/s) (non-relativistic demo)
            <input id="v0" type="range" min="1e5" max="2e7" step="1e5" value="4e6" />
            <div class="readout" id="v0r">4.0e6 m/s</div>
          </label>

          <label id="customQWrap" style="display:none">
            Custom q (C)
            <input id="qCustom" type="number" value="1.602176634e-19" step="1e-21" />
          </label>

          <label id="customMWrap" style="display:none">
            Custom m (kg)
            <input id="mCustom" type="number" value="1.67262192369e-27" step="1e-30" />
          </label>

          <div>
            <button class="btn good" id="btnCopyDerived" type="button">Copy derived values</button>
            <div class="muted" style="font-size:12px;margin-top:6px">
              Example values only (symbolic results below stay general).
            </div>
          </div>
        </div>

        <div class="kpiRow" aria-label="Derived quantities">
          <div class="kpi"><div class="k">Radius R (m)</div><div class="v" id="kpiR">—</div></div>
          <div class="kpi"><div class="k">Cyclotron ω (rad/s)</div><div class="v" id="kpiW">—</div></div>
          <div class="kpi"><div class="k">Acceleration |a| (m/s²)</div><div class="v" id="kpiA">—</div></div>
          <div class="kpi"><div class="k">E₀ at r=10 m (V/m)</div><div class="v" id="kpiE">—</div></div>
        </div>
      </div>
    </div>
  </div>
</header>

<main>
  <nav id="toc" aria-label="Table of Contents">
    <h2>Contents</h2>
    <ul class="toc-list">
      <li><a href="#analysis"><span class="dot"></span>PART 1 — Problem Analysis</a></li>
      <li><a href="#strategy"><span class="dot" style="background:rgba(167,139,250,.7);box-shadow:0 0 0 4px rgba(167,139,250,.12)"></span>PART 2 — Strategy & Tips</a></li>
      <li><a href="#solution"><span class="dot" style="background:rgba(52,211,153,.7);box-shadow:0 0 0 4px rgba(52,211,153,.12)"></span>PART 3 — Full Solution</a></li>
      <li><a href="#viz"><span class="dot" style="background:rgba(251,191,36,.8);box-shadow:0 0 0 4px rgba(251,191,36,.12)"></span>Interactive Visualizations</a></li>
    </ul>
  </nav>

  <article>
    <!-- PART 1 -->
    <section id="analysis" class="card">
      <div class="hd"><h2>PART 1 — Problem Analysis (no solving yet)</h2></div>
      <div class="bd">
        <h3 style="margin:0 0 8px 0">Restate the problem (in plain words)</h3>
        <p class="muted" style="margin:0">
          A positively charged particle enters a region with a uniform magnetic field <span style="font-family:var(--mono)">B = B0 ẑ</span>.
          Its initial velocity is <span style="font-family:var(--mono)">v(0) = v0 x̂</span> in the x–y plane. Because the magnetic force is perpendicular
          to the velocity, the particle executes circular motion. We then analyze the radiation from this accelerating charge as seen by distant observers,
          including the radiation frequency and polarization for different observation directions.
        </p>

        <div class="callouts" role="group" aria-label="Given and unknowns">
          <div class="callout">
            <strong>Given</strong>
            <ul>
              <li>Charge <span style="font-family:var(--mono)">q &gt; 0</span>, mass <span style="font-family:var(--mono)">m</span></li>
              <li>Initial velocity <span style="font-family:var(--mono)">v(0)=v0 x̂</span></li>
              <li>Uniform magnetic field <span style="font-family:var(--mono)">B = B0 ẑ</span></li>
              <li>Non-relativistic regime <span style="font-family:var(--mono)">v ≪ c</span></li>
              <li>Far-field observers (radiation zone)</li>
            </ul>
          </div>
          <div class="callout">
            <strong>Unknowns</strong>
            <ul>
              <li>Radius <span style="font-family:var(--mono)">R</span> of circular trajectory</li>
              <li>Radiation angular frequency <span style="font-family:var(--mono)">ω</span></li>
              <li>Acceleration vector <span style="font-family:var(--mono)">a(t)</span> (magnitude + direction)</li>
              <li>Far-field electric field <span style="font-family:var(--mono)">E</span> at specified observer directions</li>
              <li>Polarization nature (none / linear / circular / elliptical)</li>
            </ul>
          </div>
        </div>

        <h3 style="margin:16px 0 8px">What must be found / proved</h3>
        <ol>
          <li>Express <span style="font-family:var(--mono)">R</span> in terms of <span style="font-family:var(--mono)">m, q, v0, B0</span>.</li>
          <li>Find the radiation angular frequency <span style="font-family:var(--mono)">ω</span>.</li>
          <li>Find <span style="font-family:var(--mono)">a(t)</span> (magnitude and direction).</li>
          <li>For an observer at <span style="font-family:var(--mono)">+r0 ẑ</span>, give <span style="font-family:var(--mono)">E</span> magnitude + direction and determine polarization.</li>
          <li>For an observer at <span style="font-family:var(--mono)">+r0(ŷ+ẑ)</span>, determine polarization type (no need for magnitude).</li>
        </ol>

        <h3 style="margin:16px 0 8px">Relevant physical principles (and why)</h3>
        <ul>
          <li>
            <strong>Lorentz force:</strong> <span style="font-family:var(--mono)">F = q v × B</span>. Here <span style="font-family:var(--mono)">B</span> is uniform and
            perpendicular to the velocity (in x–y plane), so the force is always perpendicular to <span style="font-family:var(--mono)">v</span>, implying
            <em>uniform circular motion</em> (speed constant, direction changes).
          </li>
          <li>
            <strong>Cyclotron (Larmor) frequency:</strong> For non-relativistic motion in a uniform <span style="font-family:var(--mono)">B</span>, the angular frequency is
            <span style="font-family:var(--mono)">ω = qB0/m</span>. This sets both the orbital frequency and (in the dipole, v≪c limit) the dominant radiation frequency.
          </li>
          <li>
            <strong>Radiation from an accelerating charge (far field):</strong> In the radiation zone,
            <span style="font-family:var(--mono)">E_rad ∝ n×(n×a)</span> evaluated at the retarded time. This directly connects the particle’s acceleration to the observed wave and its polarization.
          </li>
        </ul>

        <h3 style="margin:16px 0 8px">Possible approaches (2–3) and comparison</h3>
        <ol>
          <li>
            <strong>Newton + Lorentz force (time-domain):</strong> Solve <span style="font-family:var(--mono)">m dv/dt = q v×B</span> to get
            <span style="font-family:var(--mono)">v(t), a(t)</span>, then use the far-field radiation formula.
            <span class="muted">Best for explicit acceleration and polarization.</span>
          </li>
          <li>
            <strong>Uniform circular motion geometry:</strong> Use centripetal relations <span style="font-family:var(--mono)">v=ωR</span> and
            <span style="font-family:var(--mono)">a=v²/R</span>, with <span style="font-family:var(--mono)">qvB = mv²/R</span>.
            <span class="muted">Fast for parts (a)–(c); still need radiation formula for (d)–(e).</span>
          </li>
          <li>
            <strong>Energy/power methods:</strong> Use Larmor power <span style="font-family:var(--mono)">P = q² a²/(6πϵ0 c³)</span> and angular pattern
            <span style="font-family:var(--mono)">dP/dΩ ∝ |n×(n×a)|²</span>.
            <span class="muted">Good for intensity patterns; does not replace explicit polarization analysis.</span>
          </li>
        </ol>

        <h3 style="margin:16px 0 8px">Chosen approach</h3>
        <p style="margin:0">
          We’ll combine (1) and (2): first solve the Lorentz-force equation to obtain a clean, explicit
          <span style="font-family:var(--mono)">v(t)</span> and <span style="font-family:var(--mono)">a(t)</span> for a positively charged particle.
          Then we plug <span style="font-family:var(--mono)">a</span> into the standard far-field radiation expression
          to determine the observed <span style="font-family:var(--mono)">E</span> direction and polarization for the two observer locations.
        </p>
      </div>
    </section>

    <!-- PART 2 -->
    <section id="strategy" class="card">
      <div class="hd"><h2>PART 2 — Strategy & Tips (roadmap only)</h2></div>
      <div class="bd">
        <h3 style="margin:0 0 8px 0">Minimal roadmap (no algebra yet)</h3>
        <ol>
          <li>
            <strong>Set geometry & directions.</strong>
            <div class="muted">Goal: understand force direction and rotation sense.</div>
            <div class="muted">Tool: right-hand rule for <span style="font-family:var(--mono)">v×B</span>.</div>
          </li>
          <li>
            <strong>Relate magnetic force to centripetal force.</strong>
            <div class="muted">Goal: obtain radius <span style="font-family:var(--mono)">R</span>.</div>
            <div class="muted">Tool: <span style="font-family:var(--mono)">qvB = mv²/R</span>.</div>
          </li>
          <li>
            <strong>Extract angular frequency.</strong>
            <div class="muted">Goal: obtain <span style="font-family:var(--mono)">ω</span> and connect it to the radiation frequency.</div>
            <div class="muted">Tool: <span style="font-family:var(--mono)">ω = v/R</span> for circular motion.</div>
          </li>
          <li>
            <strong>Write explicit <span style="font-family:var(--mono)">v(t)</span> consistent with initial condition.</strong>
            <div class="muted">Goal: capture the correct phase so <span style="font-family:var(--mono)">v(0)=v0 x̂</span>.</div>
            <div class="muted">Tool: solutions of uniform rotation in the plane.</div>
          </li>
          <li>
            <strong>Differentiate to get <span style="font-family:var(--mono)">a(t)</span>.</strong>
            <div class="muted">Goal: magnitude & direction of acceleration at any time.</div>
            <div class="muted">Tool: <span style="font-family:var(--mono)">a=dv/dt</span> and centripetal interpretation.</div>
          </li>
          <li>
            <strong>Use far-field radiation formula.</strong>
            <div class="muted">Goal: get <span style="font-family:var(--mono)">E</span> direction and polarization.</div>
            <div class="muted">Tool: <span style="font-family:var(--mono)">E = (q/(4πϵ0 c² r)) [n×(n×a)]</span>.</div>
          </li>
          <li>
            <strong>Analyze polarization for each observer direction.</strong>
            <div class="muted">Goal: circular vs elliptical vs linear.</div>
            <div class="muted">Tool: look at orthogonal components in the plane transverse to <span style="font-family:var(--mono)">n</span> and their relative phase/amplitude.</div>
          </li>
        </ol>

        <h3 style="margin:16px 0 8px">Common mistakes & quick tips</h3>
        <ul>
          <li><strong>Sign/rotation errors:</strong> For <span style="font-family:var(--mono)">q&gt;0</span>, with <span style="font-family:var(--mono)">B=B0 ẑ</span> and <span style="font-family:var(--mono)">v(0)=v0 x̂</span>, the initial force is toward <span style="font-family:var(--mono)">−ŷ</span>.</li>
          <li><strong>Mixing ω’s:</strong> The orbital cyclotron frequency (non-relativistic) is <span style="font-family:var(--mono)">ω=qB0/m</span>; that is also the dominant radiation frequency in the v≪c limit.</li>
          <li><strong>Forgetting projection:</strong> Radiation field is transverse: it depends on <span style="font-family:var(--mono)">n×(n×a)</span>, not on <span style="font-family:var(--mono)">a</span> directly.</li>
          <li><strong>Polarization test:</strong> On the axis of circular motion, equal-amplitude quadrature components → <em>circular</em>. Off-axis, unequal amplitudes → typically <em>elliptical</em>.</li>
        </ul>
      </div>
    </section>

    <!-- PART 3 -->
    <section id="solution" class="card">
      <div class="hd"><h2>PART 3 — Full Solution</h2></div>
      <div class="bd">
        <h3 style="margin:0 0 8px 0">Physical intuition (before math)</h3>
        <p style="margin:0">
          A magnetic field does no work: it bends the velocity without changing its magnitude. So the particle moves in a circle
          in the x–y plane at constant speed <span style="font-family:var(--mono)">v0</span>. Because the charge is accelerating (centripetally),
          it radiates. In the non-relativistic far zone, the radiation electric field points along the component of the acceleration
          perpendicular to the line of sight. For an observer on the +z axis, the acceleration rotates in the x–y plane, so the observed
          transverse field also rotates with constant magnitude → circular polarization.
        </p>

        <hr style="border:none;border-top:1px solid var(--line); margin:14px 0">

        <h3 style="margin:0 0 8px 0">(a) Radius of the circular trajectory</h3>
        <p style="margin:0 0 10px 0">
          The Lorentz force magnitude in this configuration is
          <span style="font-family:var(--mono)">|F| = q v B0</span> because <span style="font-family:var(--mono)">v ⟂ B</span>.
          For uniform circular motion, the required centripetal force is
          <span style="font-family:var(--mono)">m v² / R</span>.
          Setting them equal (with <span style="font-family:var(--mono)">v=v0</span> constant):
        </p>
        <div class="eq">
          <pre id="eqR">q v0 B0 = m v0^2 / R   ⇒   R = m v0 / (q B0)</pre>
          <button class="btn" data-copy="#eqR" type="button">Copy</button>
        </div>

        <h3 style="margin:16px 0 8px 0">(b) Angular frequency of the radiation</h3>
        <p style="margin:0 0 10px 0">
          For circular motion <span style="font-family:var(--mono)">v0 = ωR</span>, so
          <span style="font-family:var(--mono)">ω = v0/R</span>.
          Using the result from (a):
        </p>
        <div class="eq">
          <pre id="eqW">ω = v0 / R = (q B0) / m</pre>
          <button class="btn" data-copy="#eqW" type="button">Copy</button>
        </div>
        <p class="muted" style="margin:0">
          In the non-relativistic (dipole) regime, the dominant radiation oscillates at this same cyclotron frequency.
        </p>

        <h3 style="margin:16px 0 8px 0">(c) Acceleration a(t): magnitude and direction</h3>
        <p style="margin:0 0 10px 0">
          The equation of motion is
          <span style="font-family:var(--mono)">m dv/dt = q v × (B0 ẑ)</span>.
          Choose <span style="font-family:var(--mono)">ω = qB0/m</span> and write a velocity consistent with the initial condition
          <span style="font-family:var(--mono)">v(0)=v0 x̂</span> and the correct initial force direction:
        </p>

        <div class="eq">
          <pre id="eqVt">v(t) = v0[ cos(ωt) x̂ − sin(ωt) ŷ ]</pre>
          <button class="btn" data-copy="#eqVt" type="button">Copy</button>
        </div>

        <p style="margin:0 0 10px 0">
          Differentiate to get the acceleration:
        </p>

        <div class="eq">
          <pre id="eqAt">a(t) = dv/dt = v0 ω[ −sin(ωt) x̂ − cos(ωt) ŷ ]</pre>
          <button class="btn" data-copy="#eqAt" type="button">Copy</button>
        </div>

        <p style="margin:0">
          Magnitude is constant:
          <span style="font-family:var(--mono)">|a| = v0 ω = (qB0/m) v0 = v0²/R</span>.
          Direction is always toward the instantaneous center of the circle (centripetal), rotating in the x–y plane.
        </p>

        <h3 style="margin:16px 0 8px 0">(d) Far-field E at a distant observer at +r0 ẑ and polarization</h3>
        <p style="margin:0 0 10px 0">
          In the radiation zone for non-relativistic motion, the electric field from an accelerating charge is
        </p>

        <div class="eq">
          <pre id="eqErad">E(r,t) = (q/(4πϵ0 c^2 r)) [ n × (n × a(t_ret)) ] ,  where n = r̂</pre>
          <button class="btn" data-copy="#eqErad" type="button">Copy</button>
        </div>

        <p style="margin:0 0 10px 0">
          For the observer at <span style="font-family:var(--mono)">+r0 ẑ</span>, we have <span style="font-family:var(--mono)">n = ẑ</span>.
          Since <span style="font-family:var(--mono)">a</span> lies entirely in the x–y plane, <span style="font-family:var(--mono)">a·n = 0</span>.
          Using the vector identity <span style="font-family:var(--mono)">n×(n×a) = n(n·a) − a</span>, this reduces to:
        </p>

        <div class="eq">
          <pre id="eqEz">n = ẑ  and  a·n=0  ⇒  n×(n×a) = −a
⇒  E(+r0ẑ,t) = − (q/(4πϵ0 c^2 r0)) a(t_ret)</pre>
          <button class="btn" data-copy="#eqEz" type="button">Copy</button>
        </div>

        <p style="margin:0 0 10px 0">
          Therefore the <strong>magnitude</strong> is constant (in time) and equals:
        </p>

        <div class="eq">
          <pre id="eqE0">|E| = (q/(4πϵ0 c^2 r0)) |a| = (q/(4πϵ0 c^2 r0)) (v0 ω) = (q/(4πϵ0 c^2 r0)) (q B0 v0 / m)</pre>
          <button class="btn" data-copy="#eqE0" type="button">Copy</button>
        </div>

        <p style="margin:0 0 10px 0">
          The <strong>direction</strong> is in the x–y plane and rotates with time, because <span style="font-family:var(--mono)">a(t)</span> rotates.
          Using the explicit <span style="font-family:var(--mono)">a(t)</span> from (c),
          <span style="font-family:var(--mono)">E</span> has two transverse components of equal amplitude and 90° phase shift:
          (one behaves like <span style="font-family:var(--mono)">sin(ωt)</span>, the other like <span style="font-family:var(--mono)">cos(ωt)</span>).
        </p>

        <div class="callout" style="margin-top:12px">
          <strong>Polarization at +z:</strong>
          Because the observed transverse field has equal-amplitude quadrature components in x and y, the tip of <span style="font-family:var(--mono)">E</span>
          traces a circle in time → the radiation is <strong>circularly polarized</strong> (not unpolarized, not linear).
        </div>

        <h3 style="margin:16px 0 8px 0">(e) Polarization for observer at +r0(ŷ + ẑ)</h3>
        <p style="margin:0 0 10px 0">
          Here the observation direction is
          <span style="font-family:var(--mono)">n = (ŷ + ẑ)/√2</span>, i.e. a 45° tilt from the +z axis toward +y.
          The far field is still transverse to <span style="font-family:var(--mono)">n</span>:
          <span style="font-family:var(--mono)">E ∝ a − n(n·a)</span>.
          Since the acceleration rotates in the x–y plane, its projection onto <span style="font-family:var(--mono)">n</span> varies in time
          (because <span style="font-family:var(--mono)">n</span> has a y-component), so the transverse components do not remain equal-amplitude.
        </p>

        <div class="callout">
          <strong>Polarization at 45° off-axis:</strong>
          The transverse field generally has two orthogonal components with a relative phase near 90° (because the source acceleration rotates),
          but with <em>unequal amplitudes</em> after projecting perpendicular to <span style="font-family:var(--mono)">n</span>.
          Unequal quadrature components trace an ellipse → the radiation is <strong>elliptically polarized</strong>.
          (Only on-axis do you get perfect circular polarization; in the orbital plane you approach linear polarization.)
        </div>

        <div class="boxfinal" role="group" aria-label="Final boxed answers">
          <h3>Final Results (symbolic)</h3>
          <pre id="finalBox">Given v(0)=v0 x̂, B=B0 ẑ, q>0 (non-relativistic):

(a) Radius:
R = m v0 / (q B0)

(b) Angular frequency (cyclotron and dominant radiation):
ω = q B0 / m

(c) Acceleration:
v(t) = v0[ cos(ωt) x̂ − sin(ωt) ŷ ]
a(t) = v0 ω[ −sin(ωt) x̂ − cos(ωt) ŷ ]
|a| = v0 ω = q B0 v0 / m = v0^2 / R

(d) Far-field E at +r0 ẑ:
E = (q/(4πϵ0 c^2 r0)) [ n×(n×a) ], with n=ẑ ⇒ E = −(q/(4πϵ0 c^2 r0)) a(t_ret)
|E| = (q/(4πϵ0 c^2 r0)) |a|
Polarization: circular (on-axis)

(e) At +r0(ŷ+ẑ):
Polarization: elliptical (off-axis projection makes unequal transverse components)</pre>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px">
            <button class="btn primary" data-copy="#finalBox" type="button">Copy final answers</button>
          </div>
        </div>

        <h3 style="margin:16px 0 8px 0">Sanity checks</h3>
        <ul>
          <li>
            <strong>Units:</strong>
            <span style="font-family:var(--mono)">R = m v0/(q B0)</span> has units
            <span style="font-family:var(--mono)">(kg·m/s)/(C·T)</span> and since <span style="font-family:var(--mono)">T = kg/(C·s)</span>, this gives meters.
            <span style="font-family:var(--mono)">ω = qB0/m</span> gives <span style="font-family:var(--mono)">1/s</span>. The radiation field scale
            <span style="font-family:var(--mono)">E ~ q a /(4πϵ0 c^2 r)</span> has units of V/m.
          </li>
          <li>
            <strong>Limiting cases:</strong>
            If <span style="font-family:var(--mono)">B0 → 0</span>, then <span style="font-family:var(--mono)">R→∞</span> and <span style="font-family:var(--mono)">ω→0</span>:
            straight-line motion with no transverse acceleration → no cyclotron radiation.
            If <span style="font-family:var(--mono)">m</span> increases, <span style="font-family:var(--mono)">ω</span> decreases and the orbit widens, as expected for a “heavier” particle.
          </li>
          <li>
            <strong>Physical interpretation:</strong>
            The E-field is always perpendicular to the line of sight (transverse radiation).
            On-axis, the transverse acceleration rotates uniformly → circular polarization.
            Off-axis, the projection changes amplitudes → elliptical polarization.
          </li>
        </ul>
      </div>
    </section>

    <!-- VISUALIZATION -->
    <section id="viz" class="card">
      <div class="hd">
        <h2>Interactive Visualizations (Canvas)</h2>
        <div style="display:flex; gap:10px; flex-wrap:wrap">
          <button class="btn warn" id="btnPlay" type="button">Play/Pause motion</button>
          <button class="btn" id="btnSnapshot" type="button">Copy snapshot note</button>
        </div>
      </div>
      <div class="bd">
        <div class="grid2">
          <figure class="vizWrap">
            <div class="vizTop">
              <h3 class="vizTitle">1) Geometry & Setup Diagram</h3>
              <div class="vizMeta">Circular orbit in x–y, B along +z, observer directions</div>
            </div>
            <canvas id="cSetup" aria-label="Setup diagram"></canvas>
            <div class="muted" style="font-size:12px">
              The blue arrow is <span style="font-family:var(--mono)">v(t)</span>, the purple arrow is <span style="font-family:var(--mono)">a(t)</span>.
              Green arrow shows <span style="font-family:var(--mono)">B</span>. Dotted rays show observer directions.
            </div>
          </figure>

          <figure class="vizWrap">
            <div class="vizTop">
              <h3 class="vizTitle">2) Main Plot: Radius R vs Magnetic Field B0</h3>
              <div class="vizMeta">Using the symbolic result <span style="font-family:var(--mono)">R = m v0/(q B0)</span></div>
            </div>
            <canvas id="cMain" aria-label="Main plot"></canvas>
            <div class="muted" style="font-size:12px">
              Sweep of <span style="font-family:var(--mono)">B0</span> with the current parameter point highlighted.
            </div>
          </figure>
        </div>

        <figure class="vizWrap" style="margin-top:12px">
          <div class="vizTop">
            <h3 class="vizTitle">3) Secondary Plot: Angular Radiation Pattern (phase-averaged)</h3>
            <div class="vizMeta">
              For acceleration rotating in x–y: ⟨|n×(n×a)|²⟩ ∝ (1 + cos²θ)/2 (θ from +z)
            </div>
          </div>
          <canvas id="cSecondary" aria-label="Secondary plot"></canvas>
          <div class="muted" style="font-size:12px">
            Markers: θ=0 (observer at +z) and θ=45° (observer toward ŷ+ẑ). Intensity is normalized (dimensionless).
          </div>
        </figure>
      </div>
    </section>
  </article>
</main>

<footer>
  <div style="max-width:1100px;margin:0 auto">
    <p style="margin:0">
      Notes: This article assumes the non-relativistic regime (v ≪ c) and uses the standard radiation-zone expression
      for an accelerating point charge. Plots use example values for visualization only; symbolic answers remain general.
    </p>
  </div>
</footer>

<script>
(() => {
  // ---------- Physical constants (SI) ----------
  const EPS0 = 8.8541878128e-12;
  const C = 299792458;
  const E_CHARGE = 1.602176634e-19;
  const M_E = 9.1093837015e-31;
  const M_P = 1.67262192369e-27;

  // Example observation radius for E0 KPI
  const R_OBS = 10; // meters

  // ---------- DOM ----------
  const presetEl = document.getElementById('preset');
  const B0El = document.getElementById('B0');
  const v0El = document.getElementById('v0');
  const B0r = document.getElementById('B0r');
  const v0r = document.getElementById('v0r');
  const qCustomEl = document.getElementById('qCustom');
  const mCustomEl = document.getElementById('mCustom');
  const customQWrap = document.getElementById('customQWrap');
  const customMWrap = document.getElementById('customMWrap');
  const btnReset = document.getElementById('btnReset');
  const btnCopyDerived = document.getElementById('btnCopyDerived');
  const btnPlay = document.getElementById('btnPlay');
  const btnSnapshot = document.getElementById('btnSnapshot');

  const kpiR = document.getElementById('kpiR');
  const kpiW = document.getElementById('kpiW');
  const kpiA = document.getElementById('kpiA');
  const kpiE = document.getElementById('kpiE');

  // Copy buttons for equations
  document.querySelectorAll('[data-copy]').forEach(btn => {
    btn.addEventListener('click', async () => {
      const sel = btn.getAttribute('data-copy');
      const node = document.querySelector(sel);
      const text = node ? (node.innerText || node.textContent) : '';
      await copyText(text.trim());
      flash(btn, 'Copied');
    });
  });

  btnReset.addEventListener('click', () => {
    presetEl.value = 'proton';
    B0El.value = 0.50;
    v0El.value = 4e6;
    qCustomEl.value = E_CHARGE;
    mCustomEl.value = M_P;
    applyPreset();
    updateAll(true);
    flash(btnReset, 'Reset');
  });

  btnCopyDerived.addEventListener('click', async () => {
    const s = derivedSummaryText();
    await copyText(s);
    flash(btnCopyDerived, 'Copied');
  });

  btnSnapshot.addEventListener('click', async () => {
    const s = snapshotNote();
    await copyText(s);
    flash(btnSnapshot, 'Copied');
  });

  // ---------- State ----------
  const state = {
    q: E_CHARGE,
    m: M_P,
    B0: parseFloat(B0El.value),
    v0: parseFloat(v0El.value),
    t: 0,
    running: true
  };

  function applyPreset(){
    const p = presetEl.value;
    if (p === 'electron'){
      state.q = E_CHARGE;
      state.m = M_E;
      customQWrap.style.display = 'none';
      customMWrap.style.display = 'none';
    } else if (p === 'proton'){
      state.q = E_CHARGE;
      state.m = M_P;
      customQWrap.style.display = 'none';
      customMWrap.style.display = 'none';
    } else {
      customQWrap.style.display = '';
      customMWrap.style.display = '';
      state.q = parseFloat(qCustomEl.value);
      state.m = parseFloat(mCustomEl.value);
    }
  }

  presetEl.addEventListener('change', () => { applyPreset(); updateAll(true); });
  qCustomEl.addEventListener('input', () => { if (presetEl.value==='custom'){ applyPreset(); updateAll(true);} });
  mCustomEl.addEventListener('input', () => { if (presetEl.value==='custom'){ applyPreset(); updateAll(true);} });

  B0El.addEventListener('input', () => { state.B0 = parseFloat(B0El.value); updateAll(false); });
  v0El.addEventListener('input', () => { state.v0 = parseFloat(v0El.value); updateAll(false); });

  btnPlay.addEventListener('click', () => {
    state.running = !state.running;
    flash(btnPlay, state.running ? 'Playing' : 'Paused');
  });

  // ---------- Formatting ----------
  function fmtSci(x, sig=3){
    if (!isFinite(x)) return '—';
    const ax = Math.abs(x);
    if (ax === 0) return '0';
    if (ax >= 1e4 || ax < 1e-2){
      const e = Math.floor(Math.log10(ax));
      const m = x / Math.pow(10, e);
      return `${m.toFixed(sig-1)}e${e}`;
    }
    return x.toFixed(sig);
  }
  function fmtSI(x){
    return fmtSci(x, 4);
  }

  // ---------- Derived quantities ----------
  function omega(){ return (state.q * state.B0) / state.m; }           // rad/s
  function radius(){ return (state.m * state.v0) / (state.q * state.B0); } // m
  function accelMag(){ return state.v0 * omega(); }                    // m/s^2
  function E0_at_r(r){ return (state.q * accelMag()) / (4*Math.PI*EPS0*C*C*r); } // V/m (non-rel rad field scale)
  // Phase-averaged normalized intensity vs theta: I(θ) ∝ (1+cos^2θ)/2
  function I_norm(theta){
    const c = Math.cos(theta);
    return 0.5*(1 + c*c);
  }

  function derivedSummaryText(){
    const w = omega(), R = radius(), a = accelMag(), E0 = E0_at_r(R_OBS);
    return [
      'Derived values (example parameters):',
      `q = ${state.q} C`,
      `m = ${state.m} kg`,
      `B0 = ${state.B0} T`,
      `v0 = ${state.v0} m/s`,
      '',
      `R = m v0/(q B0) = ${R} m`,
      `ω = q B0/m = ${w} rad/s`,
      `|a| = v0 ω = ${a} m/s^2`,
      `E0(r=${R_OBS} m) = q|a|/(4πϵ0 c^2 r) = ${E0} V/m`
    ].join('\n');
  }
  function snapshotNote(){
    const w = omega(), R = radius();
    return `Snapshot: preset=${presetEl.value}, B0=${state.B0} T, v0=${state.v0} m/s, R=${R} m, ω=${w} rad/s, t=${state.t.toFixed(3)} s`;
  }

  // ---------- Canvas utilities ----------
  function makeHiDPICanvas(canvas){
    const ctx = canvas.getContext('2d');
    function resize(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.round(rect.width * dpr);
      canvas.height = Math.round(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
      return {w: rect.width, h: rect.height, dpr};
    }
    return {canvas, ctx, resize};
  }

  function clear(ctx, w, h){
    ctx.clearRect(0,0,w,h);
  }

  function drawGrid(ctx, x0, y0, w, h, dx, dy){
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.06)';
    ctx.lineWidth = 1;
    for(let x=x0; x<=x0+w+0.5; x+=dx){
      ctx.beginPath(); ctx.moveTo(x, y0); ctx.lineTo(x, y0+h); ctx.stroke();
    }
    for(let y=y0; y<=y0+h+0.5; y+=dy){
      ctx.beginPath(); ctx.moveTo(x0, y); ctx.lineTo(x0+w, y); ctx.stroke();
    }
    ctx.restore();
  }

  function drawAxes(ctx, plot, xLabel, yLabel){
    const {x, y, w, h} = plot;
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
    ctx.lineWidth = 1.2;
    ctx.beginPath(); ctx.moveTo(x, y); ctx.lineTo(x, y+h); ctx.lineTo(x+w, y+h); ctx.stroke();

    ctx.fillStyle = 'rgba(255,255,255,0.75)';
    ctx.font = '12px ui-sans-serif, system-ui';
    ctx.fillText(xLabel, x+w-ctx.measureText(xLabel).width, y+h+18);
    ctx.save();
    ctx.translate(x-34, y+10);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, 0, 0);
    ctx.restore();

    ctx.restore();
  }

  function ticks(ctx, plot, xMin, xMax, yMin, yMax, nX=5, nY=5){
    const {x, y, w, h} = plot;
    ctx.save();
    ctx.fillStyle = 'rgba(255,255,255,0.65)';
    ctx.font = '11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas';
    ctx.strokeStyle = 'rgba(255,255,255,0.22)';
    ctx.lineWidth = 1;

    for(let i=0;i<=nX;i++){
      const t = i/nX;
      const xx = x + t*w;
      const val = xMin + t*(xMax-xMin);
      ctx.beginPath(); ctx.moveTo(xx, y+h); ctx.lineTo(xx, y+h+6); ctx.stroke();
      const s = fmtSci(val, 3);
      ctx.fillText(s, xx - ctx.measureText(s).width/2, y+h+18);
    }
    for(let j=0;j<=nY;j++){
      const t = j/nY;
      const yy = y + (1-t)*h;
      const val = yMin + t*(yMax-yMin);
      ctx.beginPath(); ctx.moveTo(x-6, yy); ctx.lineTo(x, yy); ctx.stroke();
      const s = fmtSci(val, 3);
      ctx.fillText(s, x-10-ctx.measureText(s).width, yy+4);
    }
    ctx.restore();
  }

  function toPlotX(plot, xMin, xMax, X){
    return plot.x + (X-xMin)/(xMax-xMin)*plot.w;
  }
  function toPlotY(plot, yMin, yMax, Y){
    return plot.y + (1-(Y-yMin)/(yMax-yMin))*plot.h;
  }

  function line(ctx, x1,y1,x2,y2, color='rgba(125,211,252,0.9)', lw=2){
    ctx.save();
    ctx.strokeStyle=color; ctx.lineWidth=lw;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    ctx.restore();
  }
  function circle(ctx, cx,cy,r, color='rgba(255,255,255,0.8)', lw=2, fill=null){
    ctx.save();
    ctx.beginPath(); ctx.arc(cx,cy,r,0,Math.PI*2);
    if(fill){ ctx.fillStyle=fill; ctx.fill(); }
    ctx.strokeStyle=color; ctx.lineWidth=lw; ctx.stroke();
    ctx.restore();
  }
  function arrow(ctx, x1,y1,x2,y2, color='rgba(125,211,252,0.95)', lw=2){
    const dx=x2-x1, dy=y2-y1;
    const L=Math.hypot(dx,dy) || 1;
    const ux=dx/L, uy=dy/L;
    const head=10, wing=5;
    ctx.save();
    ctx.strokeStyle=color; ctx.fillStyle=color; ctx.lineWidth=lw;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x2,y2);
    ctx.lineTo(x2 - head*ux + wing*(-uy), y2 - head*uy + wing*(ux));
    ctx.lineTo(x2 - head*ux - wing*(-uy), y2 - head*uy - wing*(ux));
    ctx.closePath(); ctx.fill();
    ctx.restore();
  }

  // ---------- Canvases ----------
  const setup = makeHiDPICanvas(document.getElementById('cSetup'));
  const main = makeHiDPICanvas(document.getElementById('cMain'));
  const secondary = makeHiDPICanvas(document.getElementById('cSecondary'));

  function drawSetup(){
    const {ctx} = setup;
    const {w,h} = setup.resize();
    clear(ctx,w,h);

    // Layout
    const pad=14;
    const cx = w*0.42, cy = h*0.54;
    const Rpix = Math.min(w,h)*0.26;

    // Title overlay
    ctx.save();
    ctx.fillStyle='rgba(255,255,255,0.88)';
    ctx.font='13px ui-sans-serif, system-ui';
    ctx.fillText('x–y plane (orbit), B along +z', pad, 18);
    ctx.restore();

    // Orbit
    circle(ctx, cx, cy, Rpix, 'rgba(255,255,255,0.25)', 2);

    // Axes
    arrow(ctx, cx, cy, cx+Rpix*1.15, cy, 'rgba(255,255,255,0.35)', 2);
    arrow(ctx, cx, cy, cx, cy-Rpix*1.15, 'rgba(255,255,255,0.35)', 2);
    ctx.save();
    ctx.fillStyle='rgba(255,255,255,0.65)';
    ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas';
    ctx.fillText('x', cx+Rpix*1.18, cy+12);
    ctx.fillText('y', cx-10, cy-Rpix*1.18);
    ctx.restore();

    // Particle position on orbit
    const wcyc = omega();
    const ang = -wcyc*state.t; // clockwise when looking +z (because v rotates toward -y)
    const px = cx + Rpix*Math.cos(ang);
    const py = cy + Rpix*Math.sin(ang);
    circle(ctx, px, py, 6, 'rgba(255,255,255,0.18)', 1.5, 'rgba(125,211,252,0.25)');

    // Velocity direction: tangent (clockwise)
    // v(t) = v0[cos ωt x - sin ωt y] -> direction angle = -ωt
    // tangent is direction of v: angle_v = -ωt (in x-y). At position angle ang, tangent is +90deg from radial for clockwise -> same.
    const vx = Math.cos(-wcyc*state.t);
    const vy = -Math.sin(wcyc*state.t); // consistent
    const vScale = Rpix*0.55;
    arrow(ctx, px, py, px + vScale*vx, py + vScale*vy, 'rgba(125,211,252,0.95)', 2.4);

    // Acceleration direction: inward (centripetal) toward center
    const ax = (cx - px);
    const ay = (cy - py);
    const aL = Math.hypot(ax,ay) || 1;
    const aScale = Rpix*0.45;
    arrow(ctx, px, py, px + aScale*(ax/aL), py + aScale*(ay/aL), 'rgba(167,139,250,0.95)', 2.4);

    // B field arrow (out of plane, show at top-right)
    const bx0 = w*0.78, by0 = h*0.25;
    arrow(ctx, bx0, by0+40, bx0, by0-20, 'rgba(52,211,153,0.95)', 2.6);
    ctx.save();
    ctx.fillStyle='rgba(52,211,153,0.9)';
    ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas';
    ctx.fillText('B = B0 ẑ', bx0-28, by0+58);
    ctx.restore();

    // Observers (rays)
    // Observer 1: +z (shown as "screen normal" label)
    const ox = w*0.74, oy = h*0.58;
    ctx.save();
    ctx.strokeStyle='rgba(255,255,255,0.18)';
    ctx.setLineDash([6,5]);
    ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(cx+Rpix*0.1, cy-Rpix*0.1); ctx.lineTo(ox, oy); ctx.stroke();
    ctx.restore();
    ctx.save();
    ctx.fillStyle='rgba(255,255,255,0.75)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText('Observer: +z (θ=0)', ox-10, oy-8);
    ctx.restore();

    // Observer 2: direction (y+z)/sqrt2, depict as another dotted ray slightly up
    const ox2 = w*0.74, oy2 = h*0.42;
    ctx.save();
    ctx.strokeStyle='rgba(255,255,255,0.14)';
    ctx.setLineDash([6,5]);
    ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(cx+Rpix*0.1, cy-Rpix*0.1); ctx.lineTo(ox2, oy2); ctx.stroke();
    ctx.restore();
    ctx.save();
    ctx.fillStyle='rgba(255,255,255,0.75)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText('Observer: (ŷ+ẑ) (θ=45°)', ox2-34, oy2-8);
    ctx.restore();

    // Legend
    ctx.save();
    ctx.fillStyle='rgba(255,255,255,0.85)';
    ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas';
    ctx.fillText('v(t)', pad, h-36);
    ctx.fillText('a(t)', pad+62, h-36);
    ctx.fillText('B', pad+132, h-36);
    arrow(ctx, pad+34, h-40, pad+52, h-40, 'rgba(125,211,252,0.95)', 2.4);
    arrow(ctx, pad+98, h-40, pad+116, h-40, 'rgba(167,139,250,0.95)', 2.4);
    arrow(ctx, pad+148, h-42, pad+148, h-58, 'rgba(52,211,153,0.95)', 2.4);
    ctx.restore();
  }

  function drawMain(){
    const {ctx} = main;
    const {w,h} = main.resize();
    clear(ctx,w,h);

    const padL=64, padR=16, padT=18, padB=44;
    const plot = {x:padL, y:padT, w:w-padL-padR, h:h-padT-padB};

    // background grid
    drawGrid(ctx, plot.x, plot.y, plot.w, plot.h, plot.w/6, plot.h/6);

    // Domain for B0 sweep
    const Bmin = 0.05, Bmax = 2.0;
    // Y range based on current params; sweep R over B range
    const q = state.q, m = state.m, v0 = state.v0;
    const Rmin = (m*v0)/(q*Bmax);
    const Rmax = (m*v0)/(q*Bmin);

    drawAxes(ctx, plot, 'B0 (T)', 'R (m)');
    ticks(ctx, plot, Bmin, Bmax, Rmin, Rmax, 5, 5);

    // Curve R(B)=m v0/(q B)
    ctx.save();
    ctx.strokeStyle='rgba(125,211,252,0.95)';
    ctx.lineWidth=2.4;
    ctx.beginPath();
    const N=200;
    for(let i=0;i<=N;i++){
      const B = Bmin + (i/N)*(Bmax-Bmin);
      const R = (m*v0)/(q*B);
      const x = toPlotX(plot, Bmin, Bmax, B);
      const y = toPlotY(plot, Rmin, Rmax, R);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
    ctx.restore();

    // Highlight current point
    const Bc = state.B0;
    const Rc = radius();
    const xc = toPlotX(plot, Bmin, Bmax, Bc);
    const yc = toPlotY(plot, Rmin, Rmax, Rc);
    circle(ctx, xc, yc, 5.5, 'rgba(251,191,36,0.95)', 2, 'rgba(251,191,36,0.25)');

    // Legend
    ctx.save();
    ctx.fillStyle='rgba(255,255,255,0.80)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText('Curve: R = m v0/(q B0)', plot.x+10, plot.y+18);
    ctx.fillText('● current', plot.x+10, plot.y+36);
    ctx.fillStyle='rgba(251,191,36,0.95)';
    ctx.fillText('●', plot.x+7, plot.y+36);
    ctx.restore();
  }

  function drawSecondary(){
    const {ctx} = secondary;
    const {w,h} = secondary.resize();
    clear(ctx,w,h);

    const padL=64, padR=16, padT=18, padB=44;
    const plot = {x:padL, y:padT, w:w-padL-padR, h:h-padT-padB};

    drawGrid(ctx, plot.x, plot.y, plot.w, plot.h, plot.w/8, plot.h/6);
    drawAxes(ctx, plot, 'θ from +z (rad)', 'Normalized ⟨I(θ)⟩');

    const thMin=0, thMax=Math.PI;
    const Imin=0, Imax=1; // since (1+cos^2)/2 ranges [0.5,1], but keep 0..1 for visual
    ticks(ctx, plot, thMin, thMax, Imin, Imax, 6, 5);

    // Draw curve
    ctx.save();
    ctx.strokeStyle='rgba(167,139,250,0.95)';
    ctx.lineWidth=2.4;
    ctx.beginPath();
    const N=240;
    for(let i=0;i<=N;i++){
      const th = thMin + (i/N)*(thMax-thMin);
      const I = I_norm(th);
      const x = toPlotX(plot, thMin, thMax, th);
      const y = toPlotY(plot, Imin, Imax, I);
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
    ctx.restore();

    // Markers at theta=0 and theta=pi/4
    const marks = [
      {th:0, label:'θ=0 (+z)', color:'rgba(52,211,153,0.95)'},
      {th:Math.PI/4, label:'θ=π/4 (ŷ+ẑ)', color:'rgba(251,191,36,0.95)'}
    ];
    marks.forEach(mk => {
      const x = toPlotX(plot, thMin, thMax, mk.th);
      const y = toPlotY(plot, Imin, Imax, I_norm(mk.th));
      circle(ctx, x, y, 6, mk.color, 2, mk.color.replace('0.95','0.22'));
      ctx.save();
      ctx.fillStyle='rgba(255,255,255,0.82)';
      ctx.font='12px ui-sans-serif, system-ui';
      ctx.fillText(mk.label, x+10, y-8);
      ctx.restore();
    });

    // Legend text
    ctx.save();
    ctx.fillStyle='rgba(255,255,255,0.80)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText('⟨I(θ)⟩ ∝ (1 + cos²θ)/2 (phase-averaged for rotating a)', plot.x+10, plot.y+18);
    ctx.restore();
  }

  // ---------- Update all ----------
  function updateReadouts(){
    B0r.textContent = `${parseFloat(state.B0).toFixed(2)} T`;
    v0r.textContent = `${fmtSci(state.v0, 3)} m/s`;

    const R = radius();
    const w = omega();
    const a = accelMag();
    const E0 = E0_at_r(R_OBS);

    kpiR.textContent = `${fmtSI(R)} m`;
    kpiW.textContent = `${fmtSI(w)} rad/s`;
    kpiA.textContent = `${fmtSI(a)} m/s²`;
    kpiE.textContent = `${fmtSI(E0)} V/m (at r=${R_OBS} m)`;
  }

  function updateAll(resetTime){
    if (resetTime) state.t = 0;
    updateReadouts();
    drawSetup();
    drawMain();
    drawSecondary();
  }

  // ---------- Animation loop ----------
  let last = performance.now();
  function loop(now){
    const dt = Math.min(0.03, (now-last)/1000);
    last = now;
    if (state.running){
      // Speed up time for visibility; scale by a small factor so very large ω doesn't flicker wildly.
      // Use a normalized "visual angular speed": ω_vis = clamp(ω, ...) mapped.
      const w = omega();
      const wVis = Math.max(0.5, Math.min(30, w * 1e-8)); // purely for visualization
      state.t += dt * (wVis/2.5);
    }
    // redraw setup frequently; other plots only depend on parameters, but keep cheap redraw for simplicity
    drawSetup();
    requestAnimationFrame(loop);
  }

  // ---------- Clipboard helpers ----------
  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
    }catch(e){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position='fixed';
      ta.style.left='-9999px';
      ta.style.top='-9999px';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      try{ document.execCommand('copy'); }catch(_){}
      document.body.removeChild(ta);
    }
  }
  function flash(btn, msg){
    const prev = btn.textContent;
    btn.textContent = msg;
    btn.style.borderColor = 'rgba(52,211,153,.45)';
    btn.style.background = 'rgba(52,211,153,.12)';
    setTimeout(() => {
      btn.textContent = prev;
      btn.style.borderColor = '';
      btn.style.background = '';
    }, 700);
  }

  // ---------- Init ----------
  function init(){
    applyPreset();
    state.B0 = parseFloat(B0El.value);
    state.v0 = parseFloat(v0El.value);
    updateAll(true);
    window.addEventListener('resize', () => updateAll(false));
    requestAnimationFrame(loop);
  }
  init();
})();
</script>
</body>
</html>
