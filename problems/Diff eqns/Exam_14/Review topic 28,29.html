<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Nonlinear Systems: Phase Portraits & Structural Stability (Problems 89–93)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1624;
      --ink:#e9eef7;
      --muted:#b7c2d6;
      --faint:#7f8aa3;
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --card:#111a2b;
      --border:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(110,231,255,.10), transparent 55%),
        radial-gradient(900px 600px at 85% 15%, rgba(167,139,250,.10), transparent 55%),
        radial-gradient(900px 700px at 40% 90%, rgba(52,211,153,.08), transparent 60%),
        var(--bg);
      line-height:1.55;
    }
    a{color:var(--accent)}
    header{
      padding:28px 18px 10px;
      border-bottom:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.04), transparent);
      position:relative;
      overflow:hidden;
    }
    header::after{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(700px 220px at 10% 40%, rgba(110,231,255,.10), transparent 60%),
        radial-gradient(700px 220px at 90% 40%, rgba(167,139,250,.10), transparent 60%);
      pointer-events:none;
      filter: blur(6px);
      opacity:.9;
    }
    header > .wrap{position:relative; z-index:1;}
    .wrap{max-width:1100px; margin:0 auto; padding:0 10px;}
    h1{margin:0 0 8px; font-size:clamp(22px, 2.3vw, 34px); letter-spacing:.2px}
    .subtitle{color:var(--muted); margin:0 0 14px; max-width:75ch}
    .grid{
      display:grid;
      grid-template-columns: 310px 1fr;
      gap:16px;
      align-items:start;
      padding:18px 0 34px;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr;}
    }

    /* Sticky mini TOC */
    nav.toc{
      position:sticky;
      top:14px;
      background:rgba(17,26,43,.75);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:14px 14px 12px;
      backdrop-filter: blur(10px);
    }
    nav.toc h2{
      font-size:14px;
      margin:0 0 8px;
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
    }
    nav.toc a{
      display:block;
      padding:7px 9px;
      border-radius:10px;
      color:var(--ink);
      text-decoration:none;
      border:1px solid transparent;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size:14px;
    }
    nav.toc a:hover{
      background:rgba(110,231,255,.08);
      border-color: rgba(110,231,255,.22);
      transform: translateX(2px);
    }
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.03);
      color: var(--muted);
      font-size: 13px;
    }

    main{padding-bottom:50px}
    section, article{scroll-margin-top:80px;}
    .card{
      background:rgba(17,26,43,.78);
      border:1px solid var(--border);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:16px 16px 14px;
      backdrop-filter: blur(10px);
    }
    .card h2{
      margin:0 0 8px;
      font-size:18px;
    }
    .card h3{
      margin:14px 0 6px;
      font-size:16px;
      color:var(--muted);
    }
    .muted{color:var(--muted)}
    .faint{color:var(--faint)}
    ul{margin:8px 0 0 22px}
    .quick{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){ .quick{grid-template-columns: 1fr;} }

    .callout{
      border-left:4px solid rgba(110,231,255,.65);
      padding:10px 12px;
      background: rgba(110,231,255,.06);
      border-radius:12px;
      margin:10px 0;
    }
    .callout.warn{
      border-left-color: rgba(251,191,36,.75);
      background: rgba(251,191,36,.07);
    }
    .callout.good{
      border-left-color: rgba(52,211,153,.75);
      background: rgba(52,211,153,.07);
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 900px){ .row{grid-template-columns:1fr;} }

    figure{margin:0}
    canvas{
      width:100%;
      height:330px;
      display:block;
      border-radius:14px;
      border:1px solid var(--border);
      background: rgba(10,14,22,.65);
    }
    .canvasTall{height:380px;}
    .controls{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center;
      margin:10px 0 0;
      padding:10px 10px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.16);
      background: rgba(255,255,255,.03);
    }
    .controls label{
      font-size:13px;
      color:var(--muted);
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 160px;
    }
    input[type="range"]{width:220px}
    select, button{
      font:inherit;
      color:var(--ink);
      background: rgba(255,255,255,.06);
      border:1px solid var(--border);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    button:hover, select:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.09);
      border-color: rgba(110,231,255,.25);
    }
    button:active{transform: translateY(0px) scale(.99)}
    .small{font-size:13px}
    .mono{
      font-family:var(--mono);
      font-size:13px;
      white-space:pre-wrap;
      word-break:break-word;
      background: rgba(0,0,0,.25);
      border:1px solid var(--border);
      border-radius:14px;
      padding:10px 10px;
      overflow:auto;
    }
    .eq{
      position:relative;
      margin:10px 0;
    }
    .copyBtn{
      position:absolute;
      top:10px;
      right:10px;
      font-size:12px;
      padding:6px 9px;
      border-radius:10px;
      border:1px solid rgba(110,231,255,.25);
      background: rgba(110,231,255,.07);
    }
    .copyBtn:hover{
      background: rgba(110,231,255,.10);
      border-color: rgba(110,231,255,.40);
    }
    .badge{
      display:inline-block;
      padding:3px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      vertical-align:middle;
      margin-left:8px;
    }
    .finalBox{
      border:1px solid rgba(52,211,153,.35);
      background: rgba(52,211,153,.08);
      border-radius:16px;
      padding:12px 12px;
      margin:12px 0;
    }
    .finalBox h3{margin:0 0 6px; color:var(--good)}
    footer{
      border-top:1px solid var(--border);
      color:var(--muted);
      padding:18px 0 30px;
    }
    .printHint{display:none}
    @media print{
      nav.toc{display:none}
      body{background:#fff; color:#000}
      header, .card, canvas, .mono{box-shadow:none; backdrop-filter:none}
      canvas{border:1px solid #ccc; background:#fff}
      .printHint{display:block}
      a{color:#000; text-decoration:underline}
      .copyBtn{display:none}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="pill">Topic 28–29 • Nonlinear Systems • Phase Portraits & Structural Stability</div>
    <h1>Problems 89–93: Qualitative Behavior via Nullclines, Linearization, and Structural Stability</h1>
    <p class="subtitle">
      We analyze five planar autonomous systems. The core tools are: nullclines (where one component stops changing),
      equilibrium (critical) points, Jacobians, eigenvalues, and how non-hyperbolic equilibria can change under small perturbations.
    </p>
  </div>
</header>

<div class="wrap">
  <div class="grid">
    <nav class="toc" aria-label="Table of Contents">
      <h2>Contents</h2>
      <a href="#quick">Quick Summary</a>
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a href="#part2">PART 2 — Strategy & Tips</a>
      <a href="#part3">PART 3 — Full Solution</a>
      <a href="#viz">Interactive Visualizations</a>
      <a href="#answers">Final Answers (Copy-ready)</a>
    </nav>

    <main>
      <section id="quick" class="card">
        <h2>Quick Summary <span class="badge">3–6 bullets</span></h2>
        <div class="quick">
          <div>
            <ul>
              <li><b>Problem 89:</b> equilibria at (0,0) (stable node) and (2,1) (saddle). Nullclines form a rectangle threshold: extinction vs runaway growth.</li>
              <li><b>Problem 90:</b> (0,0) linearizes to a <b>center</b> (non-hyperbolic), so small perturbations can turn it into a <b>stable spiral</b>, <b>unstable spiral</b>, or remain a center.</li>
              <li><b>Problem 91:</b> after shifting to the equilibrium, the system is exactly linear with eigenvalues ±i ⇒ a <b>true nonlinear center</b> with a conserved “energy”.</li>
            </ul>
          </div>
          <div>
            <ul>
              <li><b>Problem 92:</b> two equilibria: one is an <b>unstable spiral</b>, the other a <b>saddle</b>.</li>
              <li><b>Problem 93:</b> three equilibria: a <b>saddle</b>, a <b>stable node</b>, and an <b>unstable spiral</b>.</li>
              <li>Interactive phase-plane demo (below) uses the <b>same symbols</b> as the text and updates vector field, nullclines, and time-series live.</li>
            </ul>
          </div>
        </div>
        <p class="printHint"><b>Print tip:</b> For best printing, use “Background graphics: off”.</p>
      </section>

      <!-- PART 1 -->
      <section id="part1" class="card" style="margin-top:16px;">
        <h2>PART 1 — Problem Analysis (no solving yet)</h2>

        <h3>Rewrite the problems in plain words</h3>
        <ul>
          <li><b>89(a)</b> Sketch the phase portrait of the nonlinear system
            <span class="mono">x' = -x + xy,   y' = -2y + xy</span>.
            <b>89(b)</b> Interpret x,y as interacting populations and tell a plausible story.</li>
          <li><b>90</b> Sketch the phase portrait of
            <span class="mono">x' = x² - y,   y' = x(1 - y)</span>,
            and show the different possible behaviors near the <i>non-structurally stable</i> critical point.</li>
          <li><b>91</b> For
            <span class="mono">x' = x - 2y + 3,   y' = x - y + 2</span>,
            find the critical point, classify the linearization, and prove the full nonlinear system has a (nonlinear) center.</li>
          <li><b>92</b> For
            <span class="mono">x' = 1 - y²,   y' = x + 2y</span>,
            draw the phase portrait by linearizing at its critical points.</li>
          <li><b>93</b> For
            <span class="mono">x' = x - y - x² + xy,   y' = -y - x²</span>,
            do the same: find equilibria, linearize, and infer the local phase portrait.</li>
        </ul>

        <h3>Given quantities, unknowns, and what must be found</h3>
        <div class="row">
          <div>
            <div class="callout">
              <b>Given:</b> five planar autonomous systems (x′, y′). <br/>
              <b>Tools allowed:</b> nullclines, equilibria, Jacobian matrix, eigenvalues/eigenvectors, qualitative flow.
            </div>
            <ul>
              <li><b>Unknowns:</b> equilibrium points; type (node/saddle/spiral/center); qualitative trajectories.</li>
              <li><b>What to find:</b> phase portraits (at least locally correct), and one population-interaction story (Problem 89b).</li>
            </ul>
          </div>
          <div>
            <div class="callout good">
              <b>Key goal:</b> Determine the <i>geometry of flow</i> using:
              <ul>
                <li>Nullclines (x′=0, y′=0) to segment the plane into regions with fixed sign patterns.</li>
                <li>Linearization at critical points for local portrait.</li>
                <li>Structural stability: non-hyperbolic points (pure imaginary or zero eigenvalues) can change under tiny perturbations.</li>
              </ul>
            </div>
          </div>
        </div>

        <h3>Relevant physical principles/laws (and why)</h3>
        <ul>
          <li><b>Autonomous dynamics:</b> trajectories follow the vector field (x′,y′). Phase portraits visualize time-evolution without solving explicitly.</li>
          <li><b>Linearization principle:</b> near an equilibrium, the nonlinear system behaves like its Jacobian linear system—<i>if the equilibrium is hyperbolic</i> (no eigenvalues with Re=0).</li>
          <li><b>Structural stability:</b> non-hyperbolic equilibria (centers, lines of equilibria, etc.) can qualitatively change under arbitrarily small changes—important in modeling (e.g., parameter uncertainty).</li>
          <li><b>Population modeling intuition (Problem 89):</b> signs of x′, y′ describe growth/decay; product terms (xy) represent interaction rates (collisions/contacts).</li>
        </ul>

        <h3>2–3 possible approaches (compare briefly)</h3>
        <ol>
          <li><b>Nullclines + sign chart:</b> Find x′=0 and y′=0 curves; determine direction of flow in each region. Fast and global-ish.</li>
          <li><b>Equilibria + Jacobian eigen-analysis:</b> Classify each critical point (node/saddle/spiral/center). Best for local portrait near equilibria.</li>
          <li><b>Invariants / reduction:</b> Sometimes find conserved quantities (Problem 91) or reduce to a second-order ODE to prove a center.</li>
        </ol>

        <div class="callout warn">
          <b>Best approach here:</b> Combine (1) and (2) for Problems 89, 90, 92, 93; and use (3) for Problem 91 to rigorously prove a nonlinear center.
        </div>
      </section>

      <!-- PART 2 -->
      <section id="part2" class="card" style="margin-top:16px;">
        <h2>PART 2 — Strategy & Tips (roadmap only)</h2>

        <h3>Minimal step-by-step plan (5–10 steps)</h3>
        <ol>
          <li><b>Find nullclines</b> (goal: regions of constant sign). Tool: set x′=0 and y′=0.</li>
          <li><b>Find equilibria</b> (goal: critical points). Tool: solve x′=0 and y′=0 simultaneously.</li>
          <li><b>Compute Jacobian</b> (goal: local linear model). Tool: J = [[∂f/∂x, ∂f/∂y],[∂g/∂x, ∂g/∂y]].</li>
          <li><b>Classify each equilibrium</b> (goal: node/saddle/spiral/center). Tool: eigenvalues of J (trace/determinant works quickly).</li>
          <li><b>Sketch local portraits</b> (goal: correct geometry near points). Tool: eigenvectors for saddles/nodes; rotation for spirals/centers.</li>
          <li><b>Combine with nullcline sign info</b> (goal: global picture). Tool: arrows in regions + connect to equilibria types.</li>
          <li><b>For non-hyperbolic point (Problem 90)</b> (goal: “each possibility”). Tool: show small perturbation changes trace ⇒ stable/unstable spiral vs center.</li>
          <li><b>For Problem 91</b> (goal: prove nonlinear center). Tool: shift equilibrium to origin, reduce to u″+u=0 and find a conserved quantity.</li>
        </ol>

        <h3>Common mistakes + quick tips</h3>
        <ul>
          <li><b>Mistake:</b> calling a “center” structurally stable. <b>Tip:</b> centers are typically <i>not</i> structurally stable; a tiny damping term turns them into spirals.</li>
          <li><b>Mistake:</b> forgetting that nullclines include axes when factors like x or y appear. <b>Tip:</b> if f=x(…): then x=0 is part of x′=0.</li>
          <li><b>Mistake:</b> mixing local and global claims. <b>Tip:</b> linearization guarantees local behavior only (unless the system is globally linear like Problem 91 after shifting).</li>
          <li><b>Tip:</b> In 2D, use trace τ and determinant Δ:  
            <span class="mono">Δ&lt;0 ⇒ saddle;  Δ&gt;0 &amp; τ=0 ⇒ center/spiral depends on nonlinear terms;  Δ&gt;0 &amp; τ≠0 ⇒ spiral or node.</span>
          </li>
        </ul>
      </section>

      <!-- PART 3 -->
      <section id="part3" class="card" style="margin-top:16px;">
        <h2>PART 3 — Full Solution</h2>

        <article>
          <h3>Physical intuition (shared across problems)</h3>
          <p>
            A phase portrait is a “map of motion”: at each point (x,y), the vector (x′,y′) tells you
            which way the system moves. <b>Nullclines</b> are special curves where motion is horizontal (y′=0) or vertical (x′=0),
            and <b>equilibria</b> are their intersections. <b>Linearization</b> tells you the local shape near equilibria, while
            nullclines help you connect the picture globally.
          </p>
        </article>

        <!-- Problem 89 -->
        <article>
          <h3>Problem 89</h3>

          <div class="eq">
            <button class="copyBtn" data-copy="p89eq">Copy equations</button>
            <div id="p89eq" class="mono">Problem 89:
x' = -x + x y = x(y - 1)
y' = -2y + x y = y(x - 2)</div>
          </div>

          <h4>(a) Phase portrait via nullclines and linearization</h4>
          <p><b>Step 1: Nullclines.</b></p>
          <div class="mono">x' = x(y - 1) = 0  ⇒  x = 0  or  y = 1
y' = y(x - 2) = 0  ⇒  y = 0  or  x = 2</div>

          <p>
            These four straight lines split the plane into rectangles. In each region, the signs of (x′, y′) are fixed:
          </p>
          <div class="mono">Sign of x' is sign of x · sign(y - 1)
Sign of y' is sign of y · sign(x - 2)</div>

          <p><b>Step 2: Equilibria (intersections of nullclines).</b></p>
          <div class="mono">(x,y) = (0,0)  and  (x,y) = (2,1)</div>

          <p><b>Step 3: Jacobian and classification.</b></p>
          <div class="mono">f(x,y)=x(y-1)     ⇒  f_x = (y-1),  f_y = x
g(x,y)=y(x-2)     ⇒  g_x = y,      g_y = (x-2)

J = [ [ y-1 ,  x ],
      [  y  , x-2 ] ]</div>

          <p><b>At (0,0):</b></p>
          <div class="mono">J(0,0) = [ [-1, 0],
          [ 0,-2] ]
Eigenvalues: λ1=-1, λ2=-2  ⇒ stable node (sink).</div>

          <p><b>At (2,1):</b></p>
          <div class="mono">J(2,1) = [ [0, 2],
          [1, 0] ]
Characteristic: λ^2 - 2 = 0 ⇒ λ = ±√2  ⇒ saddle.</div>

          <div class="finalBox">
            <h3>Result (Problem 89a)</h3>
            <div class="mono">Equilibria: (0,0) is a stable node; (2,1) is a saddle.
Nullclines: x=0, y=0, x=2, y=1. The saddle separatrices divide trajectories that decay to (0,0) from those that blow up (in the first quadrant).</div>
          </div>

          <h4>(b) Population story</h4>
          <p>
            Interpret x(t), y(t) ≥ 0 as two populations. Each population decays on its own:
            x has “death rate” 1 (term −x), y has death rate 2 (term −2y).
            The interaction term +xy increases both growth rates: contact between the two populations benefits both.
          </p>
          <p>
            The nullclines give a natural <b>threshold story</b>:
          </p>
          <ul>
            <li>If y&lt;1 then x′=x(y−1)&lt;0 ⇒ x tends to decrease (species x can’t sustain itself unless y is large enough).</li>
            <li>If x&lt;2 then y′=y(x−2)&lt;0 ⇒ y tends to decrease (species y needs x above a threshold).</li>
          </ul>
          <p>
            So: <b>below the mutual-support thresholds</b> (x&lt;2 and y&lt;1), both decline to extinction (0,0).
            But if both are sufficiently large, the positive feedback can produce runaway growth (in this simplified model with no carrying capacity).
            The saddle at (2,1) is the tipping point separating these outcomes.
          </p>

          <h4>Sanity checks</h4>
          <ul>
            <li><b>Units:</b> if time has unit T and populations are scaled, then coefficients (1,2) are rates in 1/T, and xy must be scaled consistently—typical in nondimensionalized models.</li>
            <li><b>Limiting cases:</b> if y≈0 then x′≈−x ⇒ x decays exponentially; if x≈0 then y′≈−2y ⇒ y decays faster.</li>
            <li><b>Physical interpretation:</b> saddle threshold matches “mutualism with extinction boundary.”</li>
          </ul>
        </article>

        <!-- Problem 90 -->
        <article>
          <h3>Problem 90</h3>

          <div class="eq">
            <button class="copyBtn" data-copy="p90eq">Copy equations</button>
            <div id="p90eq" class="mono">Problem 90:
x' = x^2 - y
y' = x(1 - y)</div>
          </div>

          <p><b>Step 1: Equilibria.</b></p>
          <div class="mono">x' = 0 ⇒ y = x^2
y' = 0 ⇒ x=0  or  y=1

Intersections:
(0,0), (1,1), (-1,1)</div>

          <p><b>Step 2: Jacobian.</b></p>
          <div class="mono">f=x^2 - y  ⇒ f_x=2x, f_y=-1
g=x(1-y)  ⇒ g_x=1-y, g_y=-x

J = [ [2x, -1],
      [1-y, -x] ]</div>

          <p><b>At (1,1):</b></p>
          <div class="mono">J(1,1) = [ [ 2, -1],
          [ 0, -1] ]
Eigenvalues: 2 and -1 ⇒ saddle.</div>

          <p><b>At (-1,1):</b></p>
          <div class="mono">J(-1,1) = [ [-2, -1],
          [ 0,  1] ]
Eigenvalues: -2 and 1 ⇒ saddle.</div>

          <p><b>At (0,0):</b> (the non-structurally stable one)</p>
          <div class="mono">J(0,0) = [ [0, -1],
          [1,  0] ]
Eigenvalues: λ = ± i  ⇒ linearized system is a center (closed circles/ellipses).</div>

          <div class="callout warn">
            Because the eigenvalues are purely imaginary, the equilibrium at (0,0) is <b>non-hyperbolic</b>.
            Linearization alone cannot decide whether the nonlinear system has a center, a stable spiral, or an unstable spiral.
          </div>

          <h4>“One phase portrait for each possibility” (structural instability demonstration)</h4>
          <p>
            A clean way to show the possibilities is to add a tiny perturbation parameter ε to the x′ equation:
          </p>
          <div class="mono">Perturbed family:
x' = x^2 - y + ε x
y' = x(1 - y)</div>

          <p>
            The Jacobian at (0,0) becomes:
          </p>
          <div class="mono">J_ε(0,0) = [ [ε, -1],
            [1,  0] ]
Characteristic: λ^2 - ε λ + 1 = 0
So Re(λ) = ε/2.</div>

          <ul>
            <li><b>ε = 0:</b> Re(λ)=0 ⇒ <b>center</b> (closed orbits, neutrally stable).</li>
            <li><b>ε &lt; 0:</b> Re(λ)&lt;0 ⇒ <b>stable spiral</b> (spiral in).</li>
            <li><b>ε &gt; 0:</b> Re(λ)&gt;0 ⇒ <b>unstable spiral</b> (spiral out).</li>
          </ul>

          <div class="finalBox">
            <h3>Result (Problem 90)</h3>
            <div class="mono">Equilibria: (0,0), (1,1), (-1,1).
(1,1) and (-1,1) are saddles.
(0,0) linearizes to a center (±i), hence is not structurally stable: under small perturbations it can become a stable spiral, unstable spiral, or remain a center.</div>
          </div>
        </article>

        <!-- Problem 91 -->
        <article>
          <h3>Problem 91</h3>

          <div class="eq">
            <button class="copyBtn" data-copy="p91eq">Copy equations</button>
            <div id="p91eq" class="mono">Problem 91:
x' = x - 2y + 3
y' = x - y + 2</div>
          </div>

          <h4>(a) Critical point, linearization, and type</h4>
          <p><b>Step 1: Solve x′=0 and y′=0.</b></p>
          <div class="mono">x - 2y + 3 = 0
x - y + 2  = 0

Subtract second from first:
(-y + 1)=0 ⇒ y=1
Then x - 1 + 2 = 0 ⇒ x = -1

Critical point: (-1, 1)</div>

          <p><b>Step 2: Shift the equilibrium to the origin.</b> Let</p>
          <div class="mono">u = x + 1,   v = y - 1
(so u=v=0 corresponds to x=-1,y=1)</div>

          <p>Compute the system in (u,v): since x=u-1 and y=v+1,</p>
          <div class="mono">u' = x' = (u-1) - 2(v+1) + 3 = u - 2v
v' = y' = (u-1) - (v+1) + 2 = u - v</div>

          <p>
            This is <b>exactly linear</b> (no nonlinear terms were created). The matrix is
          </p>
          <div class="mono">[u'; v'] = A [u; v],   A = [ [ 1, -2],
                   [ 1, -1] ]</div>

          <p><b>Eigenvalue check:</b></p>
          <div class="mono">trace τ = 1 + (-1) = 0
det Δ = (1)(-1) - (-2)(1) = -1 + 2 = 1
Characteristic: λ^2 - τ λ + Δ = λ^2 + 1 = 0 ⇒ λ = ± i</div>

          <div class="finalBox">
            <h3>Result (Problem 91a)</h3>
            <div class="mono">Linearized (and in fact exact shifted) system has eigenvalues ±i ⇒ a center at (-1,1).</div>
          </div>

          <h4>(b) Prove the nonlinear system has a (nonlinear) center</h4>
          <p>
            Here the “nonlinear” system is actually an affine-linear system; after shifting,
            it becomes exactly linear. So it suffices to prove the shifted system has closed periodic orbits.
          </p>

          <p><b>Step 1: Reduce to a second-order ODE.</b> From</p>
          <div class="mono">u' = u - 2v
v' = u - v</div>

          <p>Differentiate u′ and substitute v′:</p>
          <div class="mono">u'' = (u' - 2v')
    = (u - 2v) - 2(u - v)
    = u - 2v - 2u + 2v
    = -u</div>

          <p>Therefore:</p>
          <div class="mono">u'' + u = 0</div>

          <p>
            This is the simple harmonic oscillator: solutions are periodic with period 2π:
          </p>
          <div class="mono">u(t) = C1 cos t + C2 sin t</div>

          <p><b>Step 2: Show a conserved quantity (first integral).</b>
            For u″+u=0, the “energy” is constant:
          </p>
          <div class="mono">E = u^2 + (u')^2 = constant</div>

          <p>
            But u′ = u − 2v, so in the (u,v)-plane:
          </p>
          <div class="mono">E = u^2 + (u - 2v)^2 = constant</div>

          <p>
            Level sets of E are ellipses centered at (0,0). Thus trajectories are closed curves around the equilibrium.
            Translating back, the original system has closed orbits around (−1,1): a <b>nonlinear center</b>.
          </p>

          <div class="finalBox">
            <h3>Result (Problem 91b)</h3>
            <div class="mono">With u=x+1, v=y-1:
u' = u - 2v, v' = u - v  ⇒  u'' + u = 0.
Conserved quantity: H(u,v)=u^2 + (u-2v)^2.
Hence trajectories are ellipses: the critical point (-1,1) is a true (nonlinear) center.</div>
          </div>

          <h4>Sanity checks</h4>
          <ul>
            <li><b>Units:</b> coefficients are rates (1/time) after nondimensionalization.</li>
            <li><b>Limiting case:</b> small displacement from equilibrium yields sinusoidal motion (consistent with ±i).</li>
            <li><b>Interpretation:</b> perfect center indicates no damping or growth—pure rotation in phase space.</li>
          </ul>
        </article>

        <!-- Problem 92 -->
        <article>
          <h3>Problem 92</h3>

          <div class="eq">
            <button class="copyBtn" data-copy="p92eq">Copy equations</button>
            <div id="p92eq" class="mono">Problem 92:
x' = 1 - y^2
y' = x + 2y</div>
          </div>

          <p><b>Step 1: Equilibria.</b></p>
          <div class="mono">x' = 0 ⇒ 1 - y^2 = 0 ⇒ y = ±1
y' = 0 ⇒ x + 2y = 0 ⇒ x = -2y

So equilibria: (-2, 1) and (2, -1)</div>

          <p><b>Step 2: Jacobian.</b></p>
          <div class="mono">f=1 - y^2 ⇒ f_x=0, f_y=-2y
g=x + 2y  ⇒ g_x=1, g_y=2

J = [ [0,  -2y],
      [1,   2 ] ]</div>

          <p><b>At (-2,1):</b></p>
          <div class="mono">J(-2,1) = [ [0, -2],
           [1,  2] ]
τ=2, Δ=2 ⇒ λ = 1 ± i
⇒ unstable spiral (source focus).</div>

          <p><b>At (2,-1):</b></p>
          <div class="mono">J(2,-1) = [ [0,  2],
           [1,  2] ]
τ=2, Δ=-2 ⇒ saddle.</div>

          <div class="finalBox">
            <h3>Result (Problem 92)</h3>
            <div class="mono">Equilibria: (-2,1) is an unstable spiral; (2,-1) is a saddle.</div>
          </div>
        </article>

        <!-- Problem 93 -->
        <article>
          <h3>Problem 93</h3>

          <div class="eq">
            <button class="copyBtn" data-copy="p93eq">Copy equations</button>
            <div id="p93eq" class="mono">Problem 93:
x' = x - y - x^2 + x y
y' = -y - x^2</div>
          </div>

          <p><b>Step 1: Equilibria.</b></p>
          <div class="mono">y' = 0 ⇒ -y - x^2 = 0 ⇒ y = -x^2
Substitute into x':
x' = x - (-x^2) - x^2 + x(-x^2)
   = x + x^2 - x^2 - x^3
   = x(1 - x^2)

So x=0, ±1, and y=-x^2:
(0,0), (1,-1), (-1,-1)</div>

          <p><b>Step 2: Jacobian.</b></p>
          <div class="mono">f(x,y)= x - y - x^2 + xy
f_x = 1 - 2x + y
f_y = -1 + x

g(x,y)= -y - x^2
g_x = -2x
g_y = -1

J = [ [1 - 2x + y,  -1 + x],
      [   -2x,         -1 ] ]</div>

          <p><b>At (0,0):</b></p>
          <div class="mono">J(0,0) = [ [1, -1],
          [0, -1] ]
Eigenvalues: 1, -1 ⇒ saddle.</div>

          <p><b>At (1,-1):</b></p>
          <div class="mono">J(1,-1) = [ [-2,  0],
           [-2, -1] ]
Eigenvalues: -2, -1 ⇒ stable node (sink).</div>

          <p><b>At (-1,-1):</b></p>
          <div class="mono">J(-1,-1) = [ [ 2, -2],
            [ 2, -1] ]
τ=1, Δ=2 ⇒ λ = (1 ± i√7)/2
Re(λ)=1/2&gt;0 ⇒ unstable spiral (source focus).</div>

          <div class="finalBox">
            <h3>Result (Problem 93)</h3>
            <div class="mono">Equilibria:
(0,0) saddle;
(1,-1) stable node;
(-1,-1) unstable spiral.</div>
          </div>
        </article>
      </section>

      <!-- Visualizations -->
      <section id="viz" class="card" style="margin-top:16px;">
        <h2>Interactive Visualizations (Canvas + Live Controls)</h2>
        <p class="muted">
          Demo system (matches <b>Problem 89</b>) with a tunable interaction strength <b>k</b>:
        </p>

        <div class="eq">
          <button class="copyBtn" data-copy="vizEq">Copy demo model</button>
          <div id="vizEq" class="mono">Interactive demo (Problem 89 family):
x' = -x + k x y = x(k y - 1)
y' = -2y + k x y = y(k x - 2)

Nullclines:
x'=0 ⇒ x=0 or y=1/k
y'=0 ⇒ y=0 or x=2/k
Equilibria: (0,0) and (2/k, 1/k)</div>
        </div>

        <div class="row">
          <figure>
            <figcaption class="muted small" style="margin:0 0 8px;">
              <b>1) Labeled “physical setup” diagram:</b> two interacting populations with decay and mutual contact benefit.
            </figcaption>
            <canvas id="setupCanvas" aria-label="Interaction diagram"></canvas>
          </figure>

          <figure>
            <figcaption class="muted small" style="margin:0 0 8px;">
              <b>2) Main quantitative plot:</b> phase plane vector field + nullclines + sample trajectories.
            </figcaption>
            <canvas id="phaseCanvas" class="canvasTall" aria-label="Phase portrait"></canvas>
          </figure>
        </div>

        <div class="row" style="margin-top:14px;">
          <figure>
            <figcaption class="muted small" style="margin:0 0 8px;">
              <b>3) Secondary plot:</b> time series x(t), y(t) from a chosen initial condition (RK4).
            </figcaption>
            <canvas id="timeCanvas" aria-label="Time series"></canvas>
          </figure>

          <div>
            <div class="callout">
              <b>How to read the plots</b>
              <ul>
                <li><b>Nullclines:</b> dashed lines where x′=0 or y′=0.</li>
                <li><b>Equilibria:</b> marked points at (0,0) and (2/k,1/k).</li>
                <li><b>Trajectories:</b> integrated forward in time; the saddle separatrix moves as k changes.</li>
              </ul>
            </div>
            <div class="controls">
              <label>
                Interaction strength <b>k</b> (1 / population units)
                <input id="kSlider" type="range" min="0.5" max="2.5" step="0.01" value="1.00" />
                <span class="faint small">Current: <span id="kVal">1.00</span></span>
              </label>

              <label>
                Initial condition preset
                <select id="icSelect">
                  <option value="0.6,0.4">IC A: (x0,y0)=(0.6,0.4)</option>
                  <option value="1.8,1.2" selected>IC B: (x0,y0)=(1.8,1.2)</option>
                  <option value="3.0,1.6">IC C: (x0,y0)=(3.0,1.6)</option>
                  <option value="0.9,1.4">IC D: (x0,y0)=(0.9,1.4)</option>
                </select>
              </label>

              <label>
                Trajectories count
                <input id="nTraj" type="range" min="2" max="12" step="1" value="7" />
                <span class="faint small">Current: <span id="nTrajVal">7</span></span>
              </label>

              <button id="randomBtn">Randomize ICs</button>
              <button id="resetBtn">Reset view</button>
            </div>

            <div class="mono" id="liveReadout" style="margin-top:10px;"></div>
          </div>
        </div>
      </section>

      <!-- Copy-ready Final Answers -->
      <section id="answers" class="card" style="margin-top:16px;">
        <h2>Final Answers (Copy-ready)</h2>

        <div class="eq">
          <button class="copyBtn" data-copy="finalAll">Copy all final results</button>
          <div id="finalAll" class="mono">Problem 89:
System: x'=-x+xy=x(y-1),  y'=-2y+xy=y(x-2).
Nullclines: x=0 or y=1;  y=0 or x=2.
Equilibria: (0,0) stable node; (2,1) saddle.
Population story: mutualistic interaction (+xy) with individual decay; saddle at (2,1) is a threshold separating extinction from runaway growth.

Problem 90:
Equilibria: (0,0), (1,1), (-1,1).
(1,1) saddle; (-1,1) saddle.
At (0,0): J=[[0,-1],[1,0]] ⇒ λ=±i (linear center, non-hyperbolic).
Structural instability: small perturbation (e.g., x' = x^2 - y + εx) gives Re(λ)=ε/2, so ε<0 stable spiral, ε>0 unstable spiral, ε=0 center.

Problem 91:
Critical point: (-1,1).
Shift u=x+1, v=y-1 ⇒ u'=u-2v, v'=u-v.
Eigenvalues ±i ⇒ center. In fact u''+u=0 and invariant H=u^2+(u-2v)^2=const, so closed orbits ⇒ nonlinear center at (-1,1).

Problem 92:
Equilibria: (-2,1) and (2,-1).
At (-2,1): λ=1±i ⇒ unstable spiral.
At (2,-1): Δ<0 ⇒ saddle.

Problem 93:
Equilibria: (0,0), (1,-1), (-1,-1).
(0,0) saddle; (1,-1) stable node; (-1,-1) unstable spiral (Re(λ)=1/2).</div>
        </div>
      </section>

      <footer class="wrap">
        <div class="muted">
          Built with vanilla HTML/CSS/JS. Canvases are high-DPI aware and responsive.
        </div>
      </footer>
    </main>
  </div>
</div>

<script>
/* =========================
   Copy buttons (plain text)
========================= */
(function(){
  function copyTextFrom(el){
    const text = el.textContent.replace(/\u00A0/g,' ');
    navigator.clipboard.writeText(text).then(()=>{
      // subtle feedback
    }).catch(()=>{});
  }
  document.querySelectorAll('.copyBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-copy');
      const el = document.getElementById(id);
      if(el) copyTextFrom(el);
    });
  });

  // Smooth TOC scrolling
  document.querySelectorAll('nav.toc a').forEach(a=>{
    a.addEventListener('click', (e)=>{
      const href = a.getAttribute('href');
      if(href && href.startsWith('#')){
        e.preventDefault();
        const target = document.querySelector(href);
        if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
        history.replaceState(null,'',href);
      }
    });
  });
})();

/* =========================
   Canvas helpers (HiDPI)
========================= */
function fitCanvas(canvas, cssHeight){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(1, Math.floor(rect.width * dpr));
  const h = Math.max(1, Math.floor((cssHeight ?? rect.height) * dpr));
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w;
    canvas.height = h;
  }
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return {ctx, dpr, cssW: rect.width, cssH: (cssHeight ?? rect.height)};
}

function lerp(a,b,t){ return a + (b-a)*t; }

/* =========================
   Plot primitives
========================= */
function drawAxes(ctx, box, opts){
  const {
    xMin, xMax, yMin, yMax,
    xLabel="x", yLabel="y",
    title="",
    unitX="", unitY="",
    grid=true
  } = opts;

  const {x, y, w, h} = box;
  // Background
  ctx.save();
  ctx.clearRect(0,0,box.canvasW,box.canvasH); // if provided
  ctx.restore();

  // panel fill
  ctx.save();
  ctx.fillStyle = "rgba(10,14,22,0.65)";
  ctx.fillRect(x,y,w,h);
  ctx.restore();

  // title
  ctx.save();
  ctx.fillStyle = "rgba(233,238,247,0.92)";
  ctx.font = "600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText(title, x+10, y+20);
  ctx.restore();

  // grid + frame
  ctx.save();
  ctx.strokeStyle = "rgba(255,255,255,0.12)";
  ctx.lineWidth = 1;
  ctx.strokeRect(x,y,w,h);

  function xToPx(X){ return x + (X - xMin) / (xMax-xMin) * w; }
  function yToPx(Y){ return y + (1 - (Y - yMin) / (yMax-yMin)) * h; }

  // ticks
  const nTicks = 6;
  ctx.fillStyle = "rgba(183,194,214,0.9)";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";

  for(let i=0;i<=nTicks;i++){
    const tx = lerp(xMin,xMax,i/nTicks);
    const px = xToPx(tx);
    if(grid){
      ctx.strokeStyle = "rgba(255,255,255,0.06)";
      ctx.beginPath(); ctx.moveTo(px,y); ctx.lineTo(px,y+h); ctx.stroke();
    }
    ctx.strokeStyle = "rgba(255,255,255,0.18)";
    ctx.beginPath(); ctx.moveTo(px,y+h); ctx.lineTo(px,y+h-6); ctx.stroke();
    ctx.fillText(tx.toFixed(1), px-10, y+h+16);
  }
  for(let i=0;i<=nTicks;i++){
    const ty = lerp(yMin,yMax,i/nTicks);
    const py = yToPx(ty);
    if(grid){
      ctx.strokeStyle = "rgba(255,255,255,0.06)";
      ctx.beginPath(); ctx.moveTo(x,py); ctx.lineTo(x+w,py); ctx.stroke();
    }
    ctx.strokeStyle = "rgba(255,255,255,0.18)";
    ctx.beginPath(); ctx.moveTo(x,py); ctx.lineTo(x+6,py); ctx.stroke();
    ctx.fillText(ty.toFixed(1), x-40, py+4);
  }

  // axis labels
  ctx.fillStyle = "rgba(183,194,214,0.95)";
  ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText(`${xLabel}${unitX ? " ("+unitX+")":""}`, x+w-90, y+h-10);
  ctx.save();
  ctx.translate(x+14, y+24);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(`${yLabel}${unitY ? " ("+unitY+")":""}`, 0, 0);
  ctx.restore();

  ctx.restore();

  return {xToPx, yToPx};
}

function drawDashedLine(ctx, x1,y1,x2,y2, color, dash=[6,6], width=1.5){
  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = width;
  ctx.setLineDash(dash);
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();
  ctx.restore();
}

function drawPoint(ctx, px, py, color, label){
  ctx.save();
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.arc(px,py,4.5,0,Math.PI*2);
  ctx.fill();
  ctx.strokeStyle = "rgba(0,0,0,0.35)";
  ctx.lineWidth = 2;
  ctx.stroke();

  if(label){
    ctx.fillStyle = "rgba(233,238,247,0.9)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
    ctx.fillText(label, px+8, py-8);
  }
  ctx.restore();
}

/* =========================
   Problem 89 demo system
   x' = -x + kxy
   y' = -2y + kxy
========================= */
function f(x,y,k){ return -x + k*x*y; }
function g(x,y,k){ return -2*y + k*x*y; }

function rk4Step(x,y,dt,k){
  const k1x = f(x,y,k), k1y = g(x,y,k);
  const k2x = f(x + 0.5*dt*k1x, y + 0.5*dt*k1y, k);
  const k2y = g(x + 0.5*dt*k1x, y + 0.5*dt*k1y, k);
  const k3x = f(x + 0.5*dt*k2x, y + 0.5*dt*k2y, k);
  const k3y = g(x + 0.5*dt*k2x, y + 0.5*dt*k2y, k);
  const k4x = f(x + dt*k3x, y + dt*k3y, k);
  const k4y = g(x + dt*k3x, y + dt*k3y, k);
  const nx = x + dt*(k1x + 2*k2x + 2*k3x + k4x)/6;
  const ny = y + dt*(k1y + 2*k2y + 2*k3y + k4y)/6;
  return [nx, ny];
}

function integrateTraj(x0,y0, k, dt, steps, clampBox){
  let x=x0, y=y0;
  const pts = [];
  for(let i=0;i<steps;i++){
    pts.push([x,y]);
    [x,y]=rk4Step(x,y,dt,k);
    if(!isFinite(x) || !isFinite(y)) break;
    if(clampBox){
      const {xMin,xMax,yMin,yMax} = clampBox;
      if(x < xMin-2 || x > xMax+2 || y < yMin-2 || y > yMax+2) break;
    }
  }
  return pts;
}

/* =========================
   Rendering
========================= */
const setupCanvas = document.getElementById('setupCanvas');
const phaseCanvas = document.getElementById('phaseCanvas');
const timeCanvas  = document.getElementById('timeCanvas');

const kSlider = document.getElementById('kSlider');
const kVal    = document.getElementById('kVal');
const icSelect= document.getElementById('icSelect');
const randomBtn = document.getElementById('randomBtn');
const resetBtn  = document.getElementById('resetBtn');
const nTrajSlider = document.getElementById('nTraj');
const nTrajVal = document.getElementById('nTrajVal');
const liveReadout = document.getElementById('liveReadout');

let view = {xMin:0, xMax:4, yMin:0, yMax:3}; // first quadrant focus for population meaning
let trajSeeds = [];

function seedFromPreset(){
  const [x0,y0] = icSelect.value.split(',').map(Number);
  return {x0,y0};
}

function randomizeSeeds(){
  const n = Number(nTrajSlider.value);
  trajSeeds = [];
  for(let i=0;i<n;i++){
    const x0 = 0.2 + Math.random()*(view.xMax-0.4);
    const y0 = 0.2 + Math.random()*(view.yMax-0.4);
    trajSeeds.push({x0,y0});
  }
  // include preset as first trajectory
  const p = seedFromPreset();
  trajSeeds[0] = p;
}

function ensureSeeds(){
  const n = Number(nTrajSlider.value);
  if(trajSeeds.length !== n) randomizeSeeds();
}

function drawSetup(){
  const {ctx, cssW, cssH} = fitCanvas(setupCanvas, setupCanvas.getBoundingClientRect().height);

  // background panel
  ctx.clearRect(0,0,cssW,cssH);
  ctx.fillStyle = "rgba(10,14,22,0.65)";
  ctx.fillRect(0,0,cssW,cssH);

  // title
  ctx.fillStyle = "rgba(233,238,247,0.92)";
  ctx.font = "600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText("Interaction Diagram (Problem 89 meaning)", 12, 22);

  // Nodes
  const L = {x: cssW*0.28, y: cssH*0.55};
  const R = {x: cssW*0.72, y: cssH*0.55};

  function node(p, label){
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,0.06)";
    ctx.strokeStyle = "rgba(255,255,255,0.14)";
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.roundRect(p.x-75, p.y-42, 150, 84, 18);
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = "rgba(233,238,247,0.95)";
    ctx.font = "700 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(label, p.x-58, p.y-10);

    ctx.fillStyle = "rgba(183,194,214,0.92)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
    ctx.fillText("decay term", p.x-58, p.y+10);
    ctx.restore();
  }

  node(L, "Population x");
  node(R, "Population y");

  // decay arrows
  function downArrow(x,y){
    ctx.save();
    ctx.strokeStyle="rgba(251,113,133,0.75)";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(x,y);
    ctx.lineTo(x,y+44);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x-6,y+36);
    ctx.lineTo(x,y+44);
    ctx.lineTo(x+6,y+36);
    ctx.stroke();
    ctx.restore();
  }
  downArrow(L.x, L.y+44);
  downArrow(R.x, R.y+44);

  // mutual benefit arrows
  function curvedArrow(a,b, bend, label){
    ctx.save();
    ctx.strokeStyle="rgba(110,231,255,0.75)";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(a.x, a.y);
    const cx = (a.x+b.x)/2;
    const cy = (a.y+b.y)/2 - bend;
    ctx.quadraticCurveTo(cx,cy,b.x,b.y);
    ctx.stroke();

    // arrow head near b
    const t=0.92;
    const px = (1-t)*(1-t)*a.x + 2*(1-t)*t*cx + t*t*b.x;
    const py = (1-t)*(1-t)*a.y + 2*(1-t)*t*cy + t*t*b.y;
    const dx = b.x - px;
    const dy = b.y - py;
    const ang = Math.atan2(dy,dx);
    ctx.beginPath();
    ctx.moveTo(b.x, b.y);
    ctx.lineTo(b.x-10*Math.cos(ang-0.35), b.y-10*Math.sin(ang-0.35));
    ctx.lineTo(b.x-10*Math.cos(ang+0.35), b.y-10*Math.sin(ang+0.35));
    ctx.closePath();
    ctx.fillStyle="rgba(110,231,255,0.75)";
    ctx.fill();

    ctx.fillStyle="rgba(183,194,214,0.92)";
    ctx.font="12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
    ctx.fillText(label, cx-40, cy-10);
    ctx.restore();
  }

  curvedArrow({x:L.x+70,y:L.y-10},{x:R.x-70,y:R.y-10}, 55, "+ k·x·y");
  curvedArrow({x:R.x-70,y:R.y+10},{x:L.x+70,y:L.y+10}, 55, "+ k·x·y");

  // text
  ctx.fillStyle="rgba(183,194,214,0.9)";
  ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText("Each population decays alone (−x, −2y) but gains from interactions (+kxy).", 12, cssH-14);
}

function drawPhase(){
  const rect = phaseCanvas.getBoundingClientRect();
  const {ctx, cssW, cssH} = fitCanvas(phaseCanvas, rect.height);

  const padL=56, padR=16, padT=34, padB=44;
  const box = {x:padL, y:padT, w:cssW-padL-padR, h:cssH-padT-padB, canvasW:cssW, canvasH:cssH};
  const k = Number(kSlider.value);

  const {xToPx, yToPx} = drawAxes(ctx, box, {
    ...view,
    xLabel:"x", yLabel:"y",
    unitX:"scaled individuals", unitY:"scaled individuals",
    title:"Phase Portrait (Problem 89): vector field, nullclines, equilibria, trajectories"
  });

  // Draw nullclines
  const yNc = 1/k;
  const xNc = 2/k;

  // x'=0 lines: x=0 (already boundary) and y=1/k
  drawDashedLine(ctx, box.x, yToPx(yNc), box.x+box.w, yToPx(yNc), "rgba(110,231,255,0.55)", [7,6], 1.6);

  // y'=0 lines: y=0 (boundary) and x=2/k
  drawDashedLine(ctx, xToPx(xNc), box.y, xToPx(xNc), box.y+box.h, "rgba(167,139,250,0.55)", [7,6], 1.6);

  // Labels for nullclines
  ctx.save();
  ctx.fillStyle="rgba(183,194,214,0.92)";
  ctx.font="12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
  ctx.fillText("x' = 0: y = 1/k", box.x+10, yToPx(yNc)-8);
  ctx.fillText("y' = 0: x = 2/k", xToPx(xNc)+8, box.y+18);
  ctx.restore();

  // Vector field sampling
  const nx=20, ny=16;
  ctx.save();
  for(let i=0;i<=nx;i++){
    for(let j=0;j<=ny;j++){
      const X = lerp(view.xMin, view.xMax, i/nx);
      const Y = lerp(view.yMin, view.yMax, j/ny);
      const vx = f(X,Y,k);
      const vy = g(X,Y,k);
      const sp = Math.hypot(vx,vy) + 1e-9;
      const ux = vx/sp, uy = vy/sp;
      const px = xToPx(X), py = yToPx(Y);

      // fade arrows with speed
      const alpha = Math.min(0.65, 0.20 + 0.35*Math.tanh(sp/2));
      ctx.strokeStyle = `rgba(233,238,247,${alpha*0.55})`;
      ctx.lineWidth = 1;

      const L = 9;
      ctx.beginPath();
      ctx.moveTo(px,py);
      ctx.lineTo(px + L*ux, py - L*uy);
      ctx.stroke();

      // head
      const ang = Math.atan2(-uy, ux);
      ctx.beginPath();
      ctx.moveTo(px + L*ux, py - L*uy);
      ctx.lineTo(px + L*ux - 4*Math.cos(ang-0.45), py - L*uy - 4*Math.sin(ang-0.45));
      ctx.lineTo(px + L*ux - 4*Math.cos(ang+0.45), py - L*uy - 4*Math.sin(ang+0.45));
      ctx.closePath();
      ctx.fillStyle = `rgba(233,238,247,${alpha*0.55})`;
      ctx.fill();
    }
  }
  ctx.restore();

  // Equilibria points
  drawPoint(ctx, xToPx(0), yToPx(0), "rgba(52,211,153,0.95)", "(0,0) sink");
  drawPoint(ctx, xToPx(xNc), yToPx(yNc), "rgba(251,191,36,0.95)", "(2/k,1/k) saddle");

  // Trajectories
  ensureSeeds();
  const clampBox = {...view};
  const dt = 0.02;
  const steps = 1100;

  ctx.save();
  ctx.lineWidth = 2;
  trajSeeds.forEach((s, idx)=>{
    const pts = integrateTraj(s.x0, s.y0, k, dt, steps, clampBox);

    // color blending without fixed named colors (use alpha only)
    const a = idx===0 ? 0.95 : 0.55;
    ctx.strokeStyle = `rgba(110,231,255,${a})`;

    ctx.beginPath();
    for(let i=0;i<pts.length;i++){
      const [X,Y]=pts[i];
      const px=xToPx(X), py=yToPx(Y);
      if(i===0) ctx.moveTo(px,py);
      else ctx.lineTo(px,py);
    }
    ctx.stroke();

    // mark initial point
    if(pts.length>0){
      const [X0,Y0]=pts[0];
      drawPoint(ctx, xToPx(X0), yToPx(Y0), `rgba(233,238,247,${a})`, idx===0 ? "IC" : "");
    }
  });
  ctx.restore();

  // Legend
  ctx.save();
  const lx = box.x+10, ly = box.y+box.h-36;
  ctx.fillStyle="rgba(0,0,0,0.28)";
  ctx.strokeStyle="rgba(255,255,255,0.12)";
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.roundRect(lx, ly, 260, 28, 10);
  ctx.fill(); ctx.stroke();
  ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillStyle="rgba(183,194,214,0.95)";
  ctx.fillText("Dashed: nullclines • Points: equilibria • Curves: trajectories", lx+10, ly+18);
  ctx.restore();
}

function drawTimeSeries(){
  const rect = timeCanvas.getBoundingClientRect();
  const {ctx, cssW, cssH} = fitCanvas(timeCanvas, rect.height);

  const padL=56, padR=16, padT=34, padB=44;
  const box = {x:padL, y:padT, w:cssW-padL-padR, h:cssH-padT-padB, canvasW:cssW, canvasH:cssH};

  const k = Number(kSlider.value);
  const preset = seedFromPreset();
  const x0 = preset.x0, y0 = preset.y0;

  const dt = 0.02;
  const T = 18;
  const steps = Math.floor(T/dt);
  let x=x0, y=y0;
  const series = [];
  let maxVal = 0;
  for(let i=0;i<=steps;i++){
    const t=i*dt;
    series.push([t,x,y]);
    maxVal = Math.max(maxVal, x, y);
    [x,y]=rk4Step(x,y,dt,k);
    if(!isFinite(x) || !isFinite(y)) break;
    if(x<0) x=0; // keep demo in population quadrant
    if(y<0) y=0;
    if(x>50 || y>50) break;
  }

  const xMin=0, xMax=T;
  const yMin=0, yMax=Math.max(3.2, maxVal*1.05);

  const {xToPx, yToPx} = drawAxes(ctx, box, {
    xMin, xMax, yMin, yMax,
    xLabel:"time", yLabel:"population",
    unitX:"arb. units", unitY:"scaled individuals",
    title:"Time Series from Selected IC (RK4 integration)"
  });

  // plot x(t) and y(t)
  ctx.save();
  ctx.lineWidth=2;

  // x(t)
  ctx.strokeStyle="rgba(110,231,255,0.85)";
  ctx.beginPath();
  series.forEach((p,i)=>{
    const [t,xx,yy]=p;
    const px=xToPx(t), py=yToPx(xx);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  });
  ctx.stroke();

  // y(t)
  ctx.strokeStyle="rgba(167,139,250,0.85)";
  ctx.beginPath();
  series.forEach((p,i)=>{
    const [t,xx,yy]=p;
    const px=xToPx(t), py=yToPx(yy);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  });
  ctx.stroke();

  // legend
  const lx=box.x+10, ly=box.y+10;
  ctx.fillStyle="rgba(0,0,0,0.28)";
  ctx.strokeStyle="rgba(255,255,255,0.12)";
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.roundRect(lx, ly, 160, 46, 12);
  ctx.fill(); ctx.stroke();

  ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillStyle="rgba(183,194,214,0.95)";
  ctx.fillText("Legend:", lx+10, ly+18);

  ctx.strokeStyle="rgba(110,231,255,0.85)";
  ctx.beginPath(); ctx.moveTo(lx+10, ly+30); ctx.lineTo(lx+44, ly+30); ctx.stroke();
  ctx.fillStyle="rgba(233,238,247,0.9)";
  ctx.fillText("x(t)", lx+54, ly+34);

  ctx.strokeStyle="rgba(167,139,250,0.85)";
  ctx.beginPath(); ctx.moveTo(lx+10, ly+42); ctx.lineTo(lx+44, ly+42); ctx.stroke();
  ctx.fillStyle="rgba(233,238,247,0.9)";
  ctx.fillText("y(t)", lx+54, ly+46);

  ctx.restore();
}

function updateReadout(){
  const k = Number(kSlider.value);
  const xStar = 2/k;
  const yStar = 1/k;

  // classification info (independent of k for saddle strength in this particular family)
  liveReadout.textContent =
`Live readout (Problem 89 demo)
k = ${k.toFixed(2)}  (interaction strength)
Nullclines: y = 1/k = ${yStar.toFixed(3)},   x = 2/k = ${xStar.toFixed(3)}
Equilibria: (0,0) stable node; (2/k,1/k) saddle
Interpretation: moving k shifts the tipping-point location (threshold).`;
}

function renderAll(){
  kVal.textContent = Number(kSlider.value).toFixed(2);
  nTrajVal.textContent = nTrajSlider.value;
  drawSetup();
  drawPhase();
  drawTimeSeries();
  updateReadout();
}

kSlider.addEventListener('input', renderAll);
icSelect.addEventListener('change', ()=>{
  // ensure the first trajectory is the preset
  if(trajSeeds.length) trajSeeds[0]=seedFromPreset();
  renderAll();
});
nTrajSlider.addEventListener('input', ()=>{
  trajSeeds = []; // force reseed
  renderAll();
});
randomBtn.addEventListener('click', ()=>{
  randomizeSeeds();
  renderAll();
});
resetBtn.addEventListener('click', ()=>{
  view = {xMin:0, xMax:4, yMin:0, yMax:3};
  randomizeSeeds();
  renderAll();
});

// Responsive rerender on resize
let resizeTimer=null;
window.addEventListener('resize', ()=>{
  clearTimeout(resizeTimer);
  resizeTimer=setTimeout(()=>renderAll(), 120);
});

// Init
randomizeSeeds();
renderAll();
</script>
</body>
</html>
