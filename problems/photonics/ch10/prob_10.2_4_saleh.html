<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Step-Index Fiber (Quasi-Plane-Wave): Propagation Constants, Confinement Shell, and Wavevector Components</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --card:#121c38;
      --text:#e8ecff;
      --muted:#b7c0ffcc;
      --faint:#b7c0ff66;
      --accent:#7aa7ff;
      --accent2:#64f0c8;
      --warn:#ffd36a;
      --ok:#7dff9b;
      --bad:#ff6b8b;
      --line:#ffffff1a;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 20% -10%, #1b2a63 0%, transparent 60%),
                  radial-gradient(1000px 700px at 110% 10%, #1a5a63 0%, transparent 55%),
                  linear-gradient(180deg, var(--bg), #070b16 55%, #060913);
      color:var(--text);
      line-height:1.5;
    }
    header{
      padding: 28px 18px 12px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .topbar{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{
      flex:1 1 520px;
      min-width: 280px;
    }
    h1{
      margin:0 0 6px;
      font-size: clamp(1.35rem, 2.6vw, 2.05rem);
      letter-spacing: .2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: .98rem;
      max-width: 78ch;
    }
    .meta{
      flex:0 1 360px;
      min-width: 260px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px 14px 10px;
      box-shadow: var(--shadow);
    }
    .meta .row{
      display:flex; justify-content:space-between; gap:12px;
      padding:6px 0;
      border-bottom:1px dashed rgba(255,255,255,.08);
      font-size:.93rem;
    }
    .meta .row:last-child{ border-bottom:none; }
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      background: rgba(122,167,255,.12);
      border:1px solid rgba(122,167,255,.25);
      color: var(--text);
      font-size:.86rem;
      white-space:nowrap;
    }
    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 8px 18px 54px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      align-items:start;
    }
    nav#toc{
      position: sticky;
      top: 14px;
      align-self:start;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    nav#toc h2{
      margin: 0 0 10px;
      font-size: 1rem;
      color: var(--text);
    }
    nav#toc a{
      display:block;
      padding: 7px 10px;
      border-radius: 12px;
      color: var(--muted);
      text-decoration:none;
      font-size:.92rem;
      border:1px solid transparent;
    }
    nav#toc a:hover{
      color: var(--text);
      background: rgba(122,167,255,.10);
      border-color: rgba(122,167,255,.20);
    }
    .content{
      min-width: 0;
    }
    section{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.025));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px 18px 14px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    section h2{
      margin: 0 0 10px;
      font-size: 1.18rem;
      letter-spacing:.2px;
    }
    section h3{
      margin: 14px 0 8px;
      font-size: 1.03rem;
      color: var(--text);
    }
    p{ margin: 10px 0; color: var(--text); }
    ul{ margin: 10px 0 10px 22px; color: var(--text); }
    li{ margin: 6px 0; }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 14px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
      nav#toc{ position: relative; top:0; }
      .grid2,.grid3{ grid-template-columns: 1fr; }
    }
    .callouts{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      margin: 10px 0 6px;
    }
    .callout{
      grid-column: span 12;
      background: linear-gradient(180deg, rgba(255,255,255,.055), rgba(255,255,255,.02));
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      padding: 12px 12px 10px;
    }
    .callout strong{ color: var(--text); }
    .callout.assump{ border-color: rgba(122,167,255,.28); }
    .callout.eq{ border-color: rgba(100,240,200,.25); }
    .callout.mist{ border-color: rgba(255,211,106,.28); }
    .callout.ans{ border-color: rgba(125,255,155,.26); }
    .callout.bad{ border-color: rgba(255,107,139,.28); }

    .eqrow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      overflow:auto;
    }
    pre, code{
      font-family: var(--mono);
      font-size: .92rem;
      color: #f4f7ff;
      margin: 0;
      white-space: pre-wrap;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(122,167,255,.35);
      background: rgba(122,167,255,.14);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size: .86rem;
      flex:0 0 auto;
      transition: transform .08s ease, background .2s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(122,167,255,.20); }
    .btn:active{ transform: translateY(1px); }
    .hint{
      color: var(--muted);
      font-size: .92rem;
      margin-top: 8px;
    }
    .vizWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
      margin-top: 10px;
    }
    figure{
      margin:0;
      padding: 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      overflow:hidden;
    }
    figcaption{
      margin-top: 8px;
      color: var(--muted);
      font-size:.92rem;
    }
    canvas{
      width: 100%;
      height: 340px;
      display:block;
      border-radius: 14px;
      background: radial-gradient(900px 450px at 30% 30%, rgba(122,167,255,.10), transparent 60%),
                  radial-gradient(850px 420px at 75% 45%, rgba(100,240,200,.08), transparent 62%),
                  rgba(6,10,22,.68);
      border: 1px solid rgba(255,255,255,.10);
    }
    .controls{
      display:flex;
      gap: 12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
      padding: 12px;
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      margin-top: 10px;
    }
    .control{
      display:flex; gap:10px; align-items:center; flex-wrap:wrap;
    }
    label{
      color: var(--muted);
      font-size:.92rem;
    }
    input[type="range"]{
      width: min(420px, 70vw);
      accent-color: var(--accent);
    }
    .readout{
      font-family: var(--mono);
      font-size:.92rem;
      color: var(--text);
      padding: 6px 10px;
      border-radius: 12px;
      background: rgba(255,255,255,.06);
      border: 1px solid rgba(255,255,255,.12);
    }
    .fadeIn{
      animation: fadeIn .35s ease both;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(4px); }
      to{ opacity:1; transform: translateY(0); }
    }
    .footer{
      max-width:1200px;
      margin: 0 auto;
      padding: 14px 18px 40px;
      color: var(--muted);
      font-size:.92rem;
    }
    .kpi{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    .kpi .box{
      background: rgba(255,255,255,.05);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px;
    }
    .kpi .box .lbl{ color: var(--muted); font-size:.85rem; }
    .kpi .box .val{ font-family: var(--mono); font-size:.95rem; margin-top:6px; }
    @media (max-width: 980px){
      .kpi{ grid-template-columns: repeat(2, 1fr); }
    }
    @media print{
      body{ background: #fff; color:#000; }
      header, main, section, nav#toc, figure { box-shadow:none !important; }
      nav#toc{ display:none; }
      section{ border:1px solid #ddd; }
      canvas{ display:none; }
      .btn{ display:none; }
      .controls{ display:none; }
      .eqrow{ background:#f6f6f6; border:1px solid #ddd; }
      code, pre{ color:#000; }
    }
  </style>
</head>
<body>
  <header>
    <div class="topbar">
      <div class="title">
        <h1>Propagation Constants &amp; Wavevector in a Step-Index Fiber (Quasi-Plane-Wave, <span style="font-family:var(--mono)">l = 1</span>)</h1>
        <p class="subtitle">
          We compute the smallest and largest guided propagation constants for a step-index fiber and, for the weakest-guided <span style="font-family:var(--mono)">l=1</span> mode, find the “cylindrical shell” of confinement and the local wavevector components.
        </p>
      </div>
      <div class="meta">
        <div class="row"><span>Core radius</span><span class="pill"><span style="opacity:.8">a</span> = <span style="font-family:var(--mono)">20&nbsp;µm</span></span></div>
        <div class="row"><span>Indices</span><span class="pill"><span style="opacity:.8">n₁</span>=1.47, <span style="opacity:.8">n₂</span>=1.46</span></div>
        <div class="row"><span>Wavelength</span><span class="pill"><span style="opacity:.8">λ₀</span> = <span style="font-family:var(--mono)">1.55&nbsp;µm</span></span></div>
        <div class="row"><span>Model</span><span class="pill">Quasi-plane-wave / weak-guidance scalar</span></div>
      </div>
    </div>
  </header>

  <main>
    <nav id="toc" class="fadeIn">
      <h2>Table of Contents</h2>
      <a href="#quick">Quick Summary</a>
      <a href="#part0">PART 0 — Concept Primer</a>
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a href="#part2">PART 2 — Strategy &amp; Tips</a>
      <a href="#part3">PART 3 — Full Solution</a>
      <a href="#part4">PART 4 — Deeper Understanding</a>
      <a href="#part5">PART 5 — Visualization Guide</a>
    </nav>

    <div class="content">
      <section id="quick" class="fadeIn">
        <h2>Quick Summary</h2>
        <ul>
          <li>We analyze a <strong>step-index optical fiber</strong> (core index <span style="font-family:var(--mono)">n₁</span>, cladding <span style="font-family:var(--mono)">n₂</span>) using a <strong>quasi-plane-wave / scalar</strong> mode quantization picture.</li>
          <li>The key idea: a guided mode has an axial propagation constant <span style="font-family:var(--mono)">β</span> with <span style="font-family:var(--mono)">n₂k₀ &lt; β &lt; n₁k₀</span>, where <span style="font-family:var(--mono)">k₀ = 2π/λ₀</span>.</li>
          <li>We approximate the core transverse wavenumber by <span style="font-family:var(--mono)">k_t = u/a</span>, where <span style="font-family:var(--mono)">u</span> is a (nearly) Bessel-quantized constant for a given <span style="font-family:var(--mono)">l</span> and radial order.</li>
          <li>Governing relation (dispersion inside the core): <span style="font-family:var(--mono)">β² + k_t² = (n₁k₀)²</span>.</li>
          <li>For <span style="font-family:var(--mono)">l=1</span>, we use the first few zeros of <span style="font-family:var(--mono)">J₁(u)</span> that satisfy <span style="font-family:var(--mono)">u &lt; V</span>, where <span style="font-family:var(--mono)">V = k₀ a √(n₁² − n₂²)</span>.</li>
          <li><strong>Numeric results (at λ₀=1.55 µm):</strong> the largest <span style="font-family:var(--mono)">β</span> is near <span style="font-family:var(--mono)">n₁k₀</span> (lowest radial order), and the smallest <span style="font-family:var(--mono)">β</span> is near <span style="font-family:var(--mono)">n₂k₀</span> (highest allowed radial order for <span style="font-family:var(--mono)">l=1</span>).</li>
          <li>For the smallest-β <span style="font-family:var(--mono)">l=1</span> mode, the field energy is concentrated in a <strong>cylindrical shell</strong> <span style="font-family:var(--mono)">r_min ≤ r ≤ a</span>, with <span style="font-family:var(--mono)">r_min = l/k_t = la/u</span>.</li>
        </ul>
      </section>

      <section id="part0" class="fadeIn">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <h3>Core definitions (symbols &amp; units)</h3>
        <ul>
          <li><strong>Free-space wavelength</strong>: <span style="font-family:var(--mono)">λ₀</span> (m). Free-space wavenumber <span style="font-family:var(--mono)">k₀ = 2π/λ₀</span> (rad/m).</li>
          <li><strong>Refractive indices</strong>: core <span style="font-family:var(--mono)">n₁</span>, cladding <span style="font-family:var(--mono)">n₂</span> (dimensionless), with <span style="font-family:var(--mono)">n₁ &gt; n₂</span>.</li>
          <li><strong>Axial propagation constant</strong>: <span style="font-family:var(--mono)">β</span> (rad/m). It sets phase advance along the fiber: field ∝ <span style="font-family:var(--mono)">e^{i(βz − ωt)}</span>.</li>
          <li><strong>Transverse wavenumber in the core</strong>: <span style="font-family:var(--mono)">k_t</span> (rad/m). In cylindrical coordinates it combines radial and azimuthal variation.</li>
          <li><strong>Fiber V-number</strong>: <span style="font-family:var(--mono)">V = k₀ a √(n₁² − n₂²)</span> (dimensionless). Roughly counts how many guided modes fit.</li>
          <li><strong>Azimuthal index</strong>: <span style="font-family:var(--mono)">l</span> (integer). Controls angular variation ∝ <span style="font-family:var(--mono)">e^{ilφ}</span>.</li>
        </ul>

        <h3>Physical meaning (what these represent)</h3>
        <ul>
          <li><span style="font-family:var(--mono)">β</span> measures how “fast” the phase propagates along <span style="font-family:var(--mono)">z</span>. Larger <span style="font-family:var(--mono)">β</span> means more of the wavevector points along the axis (tighter axial guidance).</li>
          <li><span style="font-family:var(--mono)">k_t</span> measures how rapidly the field varies across the core. Larger <span style="font-family:var(--mono)">k_t</span> means more transverse oscillation and typically <em>weaker</em> axial propagation (smaller <span style="font-family:var(--mono)">β</span>).</li>
          <li><span style="font-family:var(--mono)">V</span> is the transverse “space” available in units of wavelength. If <span style="font-family:var(--mono)">V</span> is large, many modes exist; if small, only a few.</li>
        </ul>

        <div class="callouts">
          <div class="callout assump">
            <strong>When the quasi-plane-wave / scalar model is valid</strong>
            <ul>
              <li>Weak guidance: <span style="font-family:var(--mono)">Δ = (n₁ − n₂)/n₁ ≪ 1</span>, so polarization effects are small and LP-mode/scalar pictures work well.</li>
              <li>We treat transverse behavior with a Bessel-like quantization and use the core dispersion <span style="font-family:var(--mono)">β² + k_t² = (n₁k₀)²</span>.</li>
              <li>Guidance requires total internal reflection: <span style="font-family:var(--mono)">n₂k₀ &lt; β &lt; n₁k₀</span>.</li>
            </ul>
          </div>
        </div>

        <h3>Key laws / governing equations</h3>
        <div class="eqrow">
          <pre id="eq_core_disp">Core dispersion (scalar):
β² + k_t² = (n₁ k₀)²

Guided-mode bounds:
n₂ k₀ < β < n₁ k₀

V-number:
V = k₀ a √(n₁² − n₂²)

Quasi-quantization (l fixed):
k_t = u/a   with u determined by a Bessel condition and u < V</pre>
          <button class="btn" data-copy="#eq_core_disp">Copy</button>
        </div>
        <p class="hint">
          In full vector theory, <span style="font-family:var(--mono)">u</span> is set by a transcendental characteristic equation.
          In quasi-plane-wave (WKB-like) estimates, <span style="font-family:var(--mono)">u</span> behaves similarly to Bessel zeros and is constrained by <span style="font-family:var(--mono)">u &lt; V</span>.
        </p>

        <h3>Mini intuition examples (quick)</h3>
        <ul>
          <li><strong>Fundamental-like mode:</strong> small transverse structure ⇒ small <span style="font-family:var(--mono)">k_t</span> ⇒ <span style="font-family:var(--mono)">β</span> close to <span style="font-family:var(--mono)">n₁k₀</span>.</li>
          <li><strong>Highest-order guided mode:</strong> large transverse oscillation ⇒ large <span style="font-family:var(--mono)">k_t</span> ⇒ <span style="font-family:var(--mono)">β</span> close to <span style="font-family:var(--mono)">n₂k₀</span> (barely guided).</li>
        </ul>

        <div class="callouts">
          <div class="callout mist">
            <strong>What to watch for (pitfalls)</strong>
            <ul>
              <li>Mixing units: keep <span style="font-family:var(--mono)">a</span> and <span style="font-family:var(--mono)">λ₀</span> in the same length units when computing <span style="font-family:var(--mono)">V</span>.</li>
              <li>Forgetting the guidance bounds: any computed <span style="font-family:var(--mono)">β</span> must satisfy <span style="font-family:var(--mono)">n₂k₀ &lt; β &lt; n₁k₀</span>.</li>
              <li>Confusing <span style="font-family:var(--mono)">l</span> (azimuthal order) with the radial order (often called <span style="font-family:var(--mono)">m</span>).</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="part1" class="fadeIn">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <h3>Rewrite the problem (in plain words)</h3>
        <p>
          A step-index fiber with core radius <span style="font-family:var(--mono)">a = 20 µm</span>, indices
          <span style="font-family:var(--mono)">n₁ = 1.47</span> (core) and <span style="font-family:var(--mono)">n₂ = 1.46</span> (cladding),
          operates at <span style="font-family:var(--mono)">λ₀ = 1.55 µm</span>. Using quasi-plane-wave theory and restricting to guided modes with azimuthal index
          <span style="font-family:var(--mono)">l = 1</span>:
        </p>
        <ul>
          <li>(a) find the smallest and largest propagation constants <span style="font-family:var(--mono)">β</span> among those <span style="font-family:var(--mono)">l=1</span> guided modes;</li>
          <li>(b) for the mode with smallest <span style="font-family:var(--mono)">β</span>, find the radii of the cylindrical shell where the wave is confined, and compute the wavevector components at <span style="font-family:var(--mono)">r = 5 µm</span>.</li>
        </ul>

        <div class="grid2">
          <div>
            <h3>Given</h3>
            <ul>
              <li><span style="font-family:var(--mono)">a = 20 µm</span></li>
              <li><span style="font-family:var(--mono)">n₁ = 1.47</span>, <span style="font-family:var(--mono)">n₂ = 1.46</span></li>
              <li><span style="font-family:var(--mono)">λ₀ = 1.55 µm</span> ⇒ <span style="font-family:var(--mono)">k₀ = 2π/λ₀</span></li>
              <li>Only guided modes with <span style="font-family:var(--mono)">l = 1</span></li>
            </ul>
          </div>
          <div>
            <h3>Unknowns</h3>
            <ul>
              <li><span style="font-family:var(--mono)">β_max</span> and <span style="font-family:var(--mono)">β_min</span> among the guided <span style="font-family:var(--mono)">l=1</span> set</li>
              <li>For the <span style="font-family:var(--mono)">β_min</span> mode: <span style="font-family:var(--mono)">r_min</span> and <span style="font-family:var(--mono)">r_max</span> of confinement shell</li>
              <li>Wavevector components at <span style="font-family:var(--mono)">r=5 µm</span>: <span style="font-family:var(--mono)">k_r</span>, <span style="font-family:var(--mono)">k_φ</span>, <span style="font-family:var(--mono)">k_z</span></li>
            </ul>
          </div>
        </div>

        <h3>Relevant principles (and why they apply)</h3>
        <ul>
          <li><strong>Waveguide dispersion in homogeneous core:</strong> locally the wavevector magnitude is <span style="font-family:var(--mono)">|k| = n₁k₀</span>, split into axial and transverse parts: <span style="font-family:var(--mono)">β² + k_t² = (n₁k₀)²</span>.</li>
          <li><strong>Guidance condition:</strong> to be confined by total internal reflection, <span style="font-family:var(--mono)">β</span> must exceed the cladding wavenumber <span style="font-family:var(--mono)">n₂k₀</span>.</li>
          <li><strong>Quasi-plane-wave quantization:</strong> for fixed azimuthal order <span style="font-family:var(--mono)">l</span>, allowed transverse structures are discrete and can be approximated using Bessel-like quantization constants <span style="font-family:var(--mono)">u</span> with constraint <span style="font-family:var(--mono)">u &lt; V</span>.</li>
        </ul>

        <div class="callouts">
          <div class="callout assump">
            <strong>Assumptions we will use (explicit)</strong>
            <ul>
              <li>Weak guidance / scalar LP-like approximation is acceptable (small index step).</li>
              <li>Use quasi-plane-wave quantization: for <span style="font-family:var(--mono)">l=1</span>, approximate radial orders by the first few zeros of <span style="font-family:var(--mono)">J₁(u)</span>.</li>
              <li>Neglect material dispersion and losses; steady-state monochromatic fields.</li>
            </ul>
          </div>
        </div>

        <h3>Possible approaches (compare)</h3>
        <ul>
          <li><strong>Full vector characteristic equation:</strong> highest accuracy; requires numerical root solving for each mode. (Overkill for “quasi-plane-wave” request.)</li>
          <li><strong>Scalar LP approximation + numerical roots:</strong> good for weak guidance; still involves transcendental equations.</li>
          <li><strong>Quasi-plane-wave / WKB-style quantization (chosen):</strong> fast, analytic-looking, gives good physical intuition, and matches the requested method.</li>
        </ul>
        <p><strong>Choice:</strong> we use the quasi-plane-wave method because the problem explicitly asks for it and because it cleanly yields (i) bounds on <span style="font-family:var(--mono)">β</span>, (ii) a confinement shell picture, and (iii) local wavevector components.</p>
      </section>

      <section id="part2" class="fadeIn">
        <h2>PART 2 — Strategy &amp; Tips (Roadmap Only)</h2>
        <ol>
          <li><strong>Compute</strong> <span style="font-family:var(--mono)">k₀ = 2π/λ₀</span>. <em>Meaning:</em> sets the optical scale.</li>
          <li><strong>Compute</strong> the V-number <span style="font-family:var(--mono)">V = k₀ a √(n₁² − n₂²)</span>. <em>Meaning:</em> determines how many <span style="font-family:var(--mono)">l=1</span> radial orders can be guided.</li>
          <li><strong>List</strong> candidate quasi-quantized <span style="font-family:var(--mono)">u</span> values for <span style="font-family:var(--mono)">l=1</span> (use Bessel zeros <span style="font-family:var(--mono)">J₁(u)=0</span>) and keep those with <span style="font-family:var(--mono)">u &lt; V</span>. <em>Meaning:</em> guided if transverse structure “fits” under <span style="font-family:var(--mono)">V</span>.</li>
          <li><strong>Convert</strong> each <span style="font-family:var(--mono)">u</span> into transverse wavenumber <span style="font-family:var(--mono)">k_t = u/a</span>.</li>
          <li><strong>Compute</strong> each propagation constant via <span style="font-family:var(--mono)">β = √((n₁k₀)² − k_t²)</span>. <em>Meaning:</em> Pythagorean split of the core wavevector.</li>
          <li><strong>Pick extremes:</strong> largest <span style="font-family:var(--mono)">β</span> ↔ smallest <span style="font-family:var(--mono)">u</span>; smallest <span style="font-family:var(--mono)">β</span> ↔ largest allowed <span style="font-family:var(--mono)">u</span>.</li>
          <li><strong>Confinement shell:</strong> for fixed <span style="font-family:var(--mono)">l</span>, the inner turning radius is <span style="font-family:var(--mono)">r_min = l/k_t = la/u</span>, outer is the core boundary <span style="font-family:var(--mono)">r_max = a</span>.</li>
          <li><strong>Local wavevector at radius</strong> <span style="font-family:var(--mono)">r</span> in core: use <span style="font-family:var(--mono)">k_z=β</span>, <span style="font-family:var(--mono)">k_φ = l/r</span>, and <span style="font-family:var(--mono)">k_r = √((n₁k₀)² − β² − (l/r)²)</span>.</li>
        </ol>

        <div class="callouts">
          <div class="callout mist">
            <strong>Common mistakes &amp; quick tips</strong>
            <ul>
              <li>Tip: always check <span style="font-family:var(--mono)">u &lt; V</span>; otherwise the mode is not guided in this approximation.</li>
              <li>Mistake: using <span style="font-family:var(--mono)">n₂k₀</span> instead of <span style="font-family:var(--mono)">n₁k₀</span> in the core dispersion.</li>
              <li>Tip: the smallest <span style="font-family:var(--mono)">β</span> should come out close to <span style="font-family:var(--mono)">n₂k₀</span> (barely guided), which is an excellent sanity check.</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="part3" class="fadeIn">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Physical intuition (before calculating)</h3>
        <p>
          The core supports discrete transverse “standing-wave-like” patterns. For a fixed azimuthal order <span style="font-family:var(--mono)">l=1</span>,
          the smallest radial order has the least transverse variation, so its transverse wavenumber <span style="font-family:var(--mono)">k_t</span> is small and its
          axial propagation constant <span style="font-family:var(--mono)">β</span> is largest (close to <span style="font-family:var(--mono)">n₁k₀</span>).
          The highest-order guided pattern has the greatest transverse variation: <span style="font-family:var(--mono)">k_t</span> is large, so <span style="font-family:var(--mono)">β</span> is smallest,
          approaching <span style="font-family:var(--mono)">n₂k₀</span>.
        </p>

        <h3>Step 1 — Compute basic optical scales</h3>
        <p>
          Free-space wavenumber:
          <span style="font-family:var(--mono)">k₀ = 2π/λ₀</span>, with <span style="font-family:var(--mono)">λ₀ = 1.55 µm = 1.55×10⁻⁶ m</span>.
        </p>
        <div class="eqrow">
          <pre id="eq_k0">k₀ = 2π/λ₀
   = 2π / (1.55×10⁻⁶ m)
   ≈ 4.0536679×10⁶ rad/m</pre>
          <button class="btn" data-copy="#eq_k0">Copy</button>
        </div>
        <p class="hint">This sets the magnitude of the wavevector in a material: <span style="font-family:var(--mono)">|k| = n k₀</span>.</p>

        <h3>Step 2 — Compute the V-number and interpret it</h3>
        <p>
          The V-number for a step-index fiber is
          <span style="font-family:var(--mono)">V = k₀ a √(n₁² − n₂²)</span>.
          This dimensionless number controls how many guided mode solutions exist.
        </p>
        <div class="eqrow">
          <pre id="eq_V">V = k₀ a √(n₁² − n₂²)

n₁² − n₂² = 1.47² − 1.46² = 2.1609 − 2.1316 = 0.0293
√(n₁² − n₂²) ≈ 0.17117

a = 20 µm = 2.0×10⁻⁵ m

V ≈ (4.0536679×10⁶)(2.0×10⁻⁵)(0.17117)
  ≈ 13.878</pre>
          <button class="btn" data-copy="#eq_V">Copy</button>
        </div>

        <div class="callouts">
          <div class="callout eq">
            <strong>Key equation (core “Pythagoras” split)</strong>
            <div class="eqrow" style="margin-top:10px;">
              <pre id="eq_pyth">Inside the core (index n₁):
β² + k_t² = (n₁ k₀)²

with k_t = u/a</pre>
              <button class="btn" data-copy="#eq_pyth">Copy</button>
            </div>
          </div>
        </div>

        <h3>Step 3 — Quasi-plane-wave quantization for <span style="font-family:var(--mono)">l=1</span></h3>
        <p>
          In this approximation, the discrete transverse structure for azimuthal order <span style="font-family:var(--mono)">l=1</span> is characterized by a
          dimensionless parameter <span style="font-family:var(--mono)">u</span> that behaves like a Bessel-mode quantization constant.
          We take <span style="font-family:var(--mono)">u</span> as the zeros of <span style="font-family:var(--mono)">J₁(u)</span>:
        </p>
        <ul>
          <li><span style="font-family:var(--mono)">u₁ ≈ 3.8317</span></li>
          <li><span style="font-family:var(--mono)">u₂ ≈ 7.0156</span></li>
          <li><span style="font-family:var(--mono)">u₃ ≈ 10.1735</span></li>
          <li><span style="font-family:var(--mono)">u₄ ≈ 13.3237</span></li>
          <li><span style="font-family:var(--mono)">u₅ ≈ 16.4706</span> (too large here)</li>
        </ul>
        <p>
          The guidance constraint in this quasi-picture is <span style="font-family:var(--mono)">u &lt; V</span>.
          Since <span style="font-family:var(--mono)">V ≈ 13.878</span>, the allowed <span style="font-family:var(--mono)">l=1</span> guided set is:
          <span style="font-family:var(--mono)">u₁, u₂, u₃, u₄</span> (four modes).
        </p>

        <h3>Step 4 — Compute propagation constants and take extremes (Part a)</h3>
        <p>
          For each allowed <span style="font-family:var(--mono)">u</span>,
          <span style="font-family:var(--mono)">k_t = u/a</span> and
          <span style="font-family:var(--mono)">β = √((n₁k₀)² − (u/a)²)</span>.
        </p>

        <div class="grid3">
          <div>
            <div class="eqrow">
              <pre id="eq_beta_formula">For each l=1 mode (u = u_m):
k_t = u/a
β(u) = √[(n₁k₀)² − (u/a)²]</pre>
              <button class="btn" data-copy="#eq_beta_formula">Copy</button>
            </div>

            <p>
              First compute the core and cladding wavenumbers (useful bounds):
            </p>
            <div class="eqrow">
              <pre id="eq_bounds">n₁k₀ = 1.47 k₀ ≈ 5.9588919×10⁶ rad/m
n₂k₀ = 1.46 k₀ ≈ 5.9183552×10⁶ rad/m</pre>
              <button class="btn" data-copy="#eq_bounds">Copy</button>
            </div>
          </div>

          <div class="callout ans">
            <strong>Part (a) answers (numerical)</strong>
            <div class="kpi">
              <div class="box">
                <div class="lbl">Largest β (l=1)</div>
                <div class="val" id="ans_beta_max">β_max ≈ 5.955811×10⁶ rad/m</div>
              </div>
              <div class="box">
                <div class="lbl">Smallest β (l=1)</div>
                <div class="val" id="ans_beta_min">β_min ≈ 5.921536×10⁶ rad/m</div>
              </div>
              <div class="box">
                <div class="lbl">Nearest bounds</div>
                <div class="val" id="ans_bounds">n₂k₀ &lt; β &lt; n₁k₀</div>
              </div>
              <div class="box">
                <div class="lbl">Guided l=1 count</div>
                <div class="val" id="ans_count">4 modes (u₁..u₄)</div>
              </div>
            </div>
            <p class="hint" style="margin:10px 0 0;">
              Largest β ↔ smallest <span style="font-family:var(--mono)">u</span> (here <span style="font-family:var(--mono)">u₁</span>).
              Smallest β ↔ largest allowed <span style="font-family:var(--mono)">u</span> (here <span style="font-family:var(--mono)">u₄</span> just below <span style="font-family:var(--mono)">V</span>).
            </p>
          </div>
        </div>

        <h3>Step 5 — Cylindrical-shell confinement for the smallest-β mode (Part b)</h3>
        <p>
          In cylindrical coordinates, a mode with angular dependence <span style="font-family:var(--mono)">e^{ilφ}</span> carries an azimuthal wavevector component.
          In a quasi-ray/WKB picture, the radial “momentum” depends on <span style="font-family:var(--mono)">r</span> because the azimuthal term scales like <span style="font-family:var(--mono)">l/r</span>.
          A simple and very useful result is the <strong>inner turning (caustic) radius</strong>:
        </p>
        <div class="eqrow">
          <pre id="eq_rmin">k_t = u/a

Azimuthal component magnitude:
k_φ(r) = l/r

Inner turning radius (where radial oscillation starts):
r_min = l/k_t = (l a)/u</pre>
          <button class="btn" data-copy="#eq_rmin">Copy</button>
        </div>
        <p>
          For the smallest-β <span style="font-family:var(--mono)">l=1</span> mode, we use the <strong>largest allowed</strong> <span style="font-family:var(--mono)">u</span>, which is
          <span style="font-family:var(--mono)">u₄ ≈ 13.3237</span>.
        </p>
        <div class="eqrow">
          <pre id="eq_rmin_num">For the smallest-β l=1 mode: u = u₄ ≈ 13.3237

r_min = (l a)/u = (1 × 20 µm)/13.3237 ≈ 1.501 µm
r_max = a = 20 µm</pre>
          <button class="btn" data-copy="#eq_rmin_num">Copy</button>
        </div>

        <div class="callouts">
          <div class="callout ans">
            <strong>Part (b1) confinement shell (numerical)</strong>
            <p style="margin:8px 0 0;">
              The weakest-guided <span style="font-family:var(--mono)">l=1</span> mode is concentrated in the cylindrical shell:
              <span style="font-family:var(--mono)">r_min ≈ 1.50 µm ≤ r ≤ r_max = 20 µm</span>.
            </p>
          </div>
        </div>

        <h3>Step 6 — Wavevector components at <span style="font-family:var(--mono)">r = 5 µm</span> (Part b)</h3>
        <p>
          Inside the core, the local wavevector magnitude is <span style="font-family:var(--mono)">n₁k₀</span>. We split it into cylindrical components:
        </p>
        <ul>
          <li><span style="font-family:var(--mono)">k_z = β</span> (axial component)</li>
          <li><span style="font-family:var(--mono)">k_φ(r) = l/r</span> (azimuthal component set by the <span style="font-family:var(--mono)">e^{ilφ}</span> phase)</li>
          <li><span style="font-family:var(--mono)">k_r(r) = √[(n₁k₀)² − β² − k_φ(r)²]</span> (from <span style="font-family:var(--mono)">k_r² + k_φ² + k_z² = (n₁k₀)²</span>)</li>
        </ul>

        <div class="eqrow">
          <pre id="eq_k_components">At radius r (inside core):
k_z = β
k_φ(r) = l/r
k_r(r) = √[(n₁k₀)² − β² − (l/r)²]</pre>
          <button class="btn" data-copy="#eq_k_components">Copy</button>
        </div>

        <p>
          Use <span style="font-family:var(--mono)">r = 5 µm = 5×10⁻⁶ m</span>, <span style="font-family:var(--mono)">l=1</span>,
          and <span style="font-family:var(--mono)">β = β_min ≈ 5.921536×10⁶ rad/m</span>.
        </p>

        <div class="eqrow">
          <pre id="eq_k_num">Given:
n₁k₀ ≈ 5.9588919×10⁶ rad/m
β_min ≈ 5.9215362×10⁶ rad/m
r = 5×10⁻⁶ m, l = 1

k_φ = l/r = 1/(5×10⁻⁶) = 2.00000×10⁵ rad/m

k_r = √[(n₁k₀)² − β² − k_φ²]
    ≈ √[(5.9588919e6)² − (5.9215362e6)² − (2.0e5)²]
    ≈ 6.35454×10⁵ rad/m

k_z = β ≈ 5.9215362×10⁶ rad/m</pre>
          <button class="btn" data-copy="#eq_k_num">Copy</button>
        </div>

        <div class="callouts">
          <div class="callout ans">
            <strong>Part (b2) wavevector components at r = 5 µm (numerical)</strong>
            <div class="eqrow" style="margin-top:10px;">
              <pre id="final_answer_text">For the smallest-β guided l=1 mode (u₄):
Confinement shell:  r_min ≈ 1.501 µm,  r_max = a = 20 µm

At r = 5 µm:
k_z = β ≈ 5.921536×10⁶ rad/m
k_φ = l/r ≈ 2.00000×10⁵ rad/m
k_r = √[(n₁k₀)² − β² − (l/r)²] ≈ 6.35454×10⁵ rad/m</pre>
              <button class="btn" data-copy="#final_answer_text">Copy final answer</button>
            </div>
          </div>
        </div>

        <h3>Sanity checks</h3>
        <ul>
          <li><strong>Units:</strong> all components <span style="font-family:var(--mono)">k_r, k_φ, k_z</span> are in rad/m (same as <span style="font-family:var(--mono)">k₀</span>).</li>
          <li><strong>Guidance bounds:</strong> <span style="font-family:var(--mono)">n₂k₀ ≈ 5.918×10⁶</span> &lt; <span style="font-family:var(--mono)">β_min ≈ 5.922×10⁶</span> &lt; <span style="font-family:var(--mono)">n₁k₀ ≈ 5.959×10⁶</span>.</li>
          <li><strong>Vector magnitude:</strong> <span style="font-family:var(--mono)">k_r² + k_φ² + k_z²</span> matches <span style="font-family:var(--mono)">(n₁k₀)²</span> by construction.</li>
          <li><strong>Limiting behavior:</strong> if <span style="font-family:var(--mono)">u → V</span>, then <span style="font-family:var(--mono)">β → n₂k₀</span> (barely guided). Our smallest-β mode has <span style="font-family:var(--mono)">u₄</span> close to <span style="font-family:var(--mono)">V</span>, so <span style="font-family:var(--mono)">β_min</span> is close to <span style="font-family:var(--mono)">n₂k₀</span>.</li>
        </ul>

        <p>
          <strong>Connection to geometry:</strong>
          the <span style="font-family:var(--mono)">l=1</span> factor forces a nonzero azimuthal wavevector <span style="font-family:var(--mono)">k_φ = 1/r</span>,
          which becomes large near the axis. This produces an inner turning radius <span style="font-family:var(--mono)">r_min</span>, so the mode’s energy tends to live in a ring-like region rather than right at <span style="font-family:var(--mono)">r=0</span>.
        </p>
      </section>

      <section id="part4" class="fadeIn">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpreting the formulas</h3>
        <ul>
          <li><span style="font-family:var(--mono)">β = √[(n₁k₀)² − (u/a)²]</span>: increasing transverse structure (bigger <span style="font-family:var(--mono)">u</span>) reduces axial propagation.</li>
          <li><span style="font-family:var(--mono)">u &lt; V</span>: the fiber can only support transverse patterns whose “size” is below the available normalized aperture <span style="font-family:var(--mono)">V</span>.</li>
          <li><span style="font-family:var(--mono)">r_min = la/u</span>: higher angular momentum (larger <span style="font-family:var(--mono)">l</span>) pushes the mode outward (larger inner hole); higher radial order (larger <span style="font-family:var(--mono)">u</span>) pulls it inward.</li>
        </ul>

        <h3>How parameters affect outcomes (connect to the plots)</h3>
        <ul>
          <li><strong>Increase λ₀:</strong> <span style="font-family:var(--mono)">k₀</span> decreases ⇒ <span style="font-family:var(--mono)">V</span> decreases ⇒ fewer guided <span style="font-family:var(--mono)">l=1</span> modes; the smallest-β mode moves closer to cutoff and may disappear.</li>
          <li><strong>Increase a:</strong> <span style="font-family:var(--mono)">V ∝ a</span> increases ⇒ more guided modes; more radial orders fit.</li>
          <li><strong>Increase index step (bigger √(n₁²−n₂²)):</strong> increases <span style="font-family:var(--mono)">V</span> and widens the allowed range between <span style="font-family:var(--mono)">n₂k₀</span> and <span style="font-family:var(--mono)">n₁k₀</span>.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p>
          A more accurate route starts from the full vector Maxwell boundary conditions and solves the step-index characteristic equation (involving Bessel functions
          <span style="font-family:var(--mono)">J_l</span> in the core and modified Bessel functions <span style="font-family:var(--mono)">K_l</span> in the cladding). In the weak-guidance limit, those vector modes reduce to LP modes and one can solve for
          <span style="font-family:var(--mono)">u</span> numerically rather than borrowing Bessel zeros directly. The quasi-plane-wave approach you used is the fast, intuition-first approximation of that program.
        </p>

        <h3>Concept checks (with answers)</h3>
        <ul>
          <li><strong>Q:</strong> Why must <span style="font-family:var(--mono)">β &gt; n₂k₀</span> for guidance? <br><strong>A:</strong> Otherwise the field oscillates in the cladding instead of decaying, so the mode leaks away.</li>
          <li><strong>Q:</strong> Which mode has the largest <span style="font-family:var(--mono)">β</span> and why? <br><strong>A:</strong> The lowest radial order (smallest <span style="font-family:var(--mono)">u</span>), because it has the smallest transverse wavenumber.</li>
          <li><strong>Q:</strong> What does <span style="font-family:var(--mono)">r_min</span> mean physically? <br><strong>A:</strong> It’s an inner caustic/turning radius: inside it the mode cannot sustain radial oscillation because the azimuthal “centrifugal” term dominates.</li>
          <li><strong>Q:</strong> If you decrease <span style="font-family:var(--mono)">a</span> enough, what happens to the <span style="font-family:var(--mono)">l=1</span> modes? <br><strong>A:</strong> <span style="font-family:var(--mono)">V</span> decreases; higher-order (and eventually all) <span style="font-family:var(--mono)">l=1</span> guided modes cut off.</li>
        </ul>
      </section>

      <section id="part5" class="fadeIn">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <div class="controls">
          <div class="control">
            <label for="lamSlider"><strong>Interactive control:</strong> wavelength <span style="font-family:var(--mono)">λ₀</span> (µm)</label>
            <input id="lamSlider" type="range" min="1.20" max="1.80" step="0.01" value="1.55" />
            <div class="readout" id="lamReadout">1.55 µm</div>
          </div>
          <div class="control">
            <span class="pill">All plots update live</span>
            <span class="pill">High-DPI canvas rendering</span>
          </div>
        </div>

        <div class="vizWrap">
          <figure>
            <canvas id="diagCanvas"></canvas>
            <figcaption>
              <strong>Diagram:</strong> fiber cross-section. The blue circle is the core boundary (<span style="font-family:var(--mono)">r=a</span>).
              The green dashed circle is the inner turning radius <span style="font-family:var(--mono)">r_min</span> for the weakest-guided <span style="font-family:var(--mono)">l=1</span> mode.
              The orange dot marks <span style="font-family:var(--mono)">r=5 µm</span>.
            </figcaption>
          </figure>

          <figure>
            <canvas id="mainPlot"></canvas>
            <figcaption>
              <strong>Main plot:</strong> discrete propagation constants <span style="font-family:var(--mono)">β</span> for guided <span style="font-family:var(--mono)">l=1</span> modes (points) versus radial order index.
              Horizontal bands show <span style="font-family:var(--mono)">n₂k₀</span> and <span style="font-family:var(--mono)">n₁k₀</span>. Smallest and largest <span style="font-family:var(--mono)">β</span> are highlighted.
            </figcaption>
          </figure>

          <figure>
            <canvas id="secondaryPlot"></canvas>
            <figcaption>
              <strong>Secondary plot:</strong> confinement inner radius <span style="font-family:var(--mono)">r_min = la/u</span> for each guided <span style="font-family:var(--mono)">l=1</span> mode.
              As <span style="font-family:var(--mono)">u</span> increases (higher order), <span style="font-family:var(--mono)">r_min</span> shrinks (shell extends closer to the axis).
            </figcaption>
          </figure>
        </div>

        <p class="hint">
          Move the wavelength slider: increasing <span style="font-family:var(--mono)">λ₀</span> decreases <span style="font-family:var(--mono)">k₀</span> and <span style="font-family:var(--mono)">V</span>, so some higher-order <span style="font-family:var(--mono)">l=1</span> modes disappear when their <span style="font-family:var(--mono)">u</span> no longer satisfies <span style="font-family:var(--mono)">u &lt; V</span>. You should see fewer points in the main plot and fewer entries in the secondary plot.
        </p>
      </section>
    </div>
  </main>

  <footer class="footer">
    <p>
      Built as a self-contained tutorial: no external libraries, no MathJax. The numerical values shown in the answer boxes correspond to the problem’s given wavelength <span style="font-family:var(--mono)">λ₀ = 1.55 µm</span>.
    </p>
  </footer>

  <script>
    /***********************
     * Utilities: copy buttons
     ***********************/
    function setupCopyButtons(){
      document.querySelectorAll('[data-copy]').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const sel = btn.getAttribute('data-copy');
          const el = document.querySelector(sel);
          if(!el) return;
          const text = el.innerText.replace(/\n+$/,'');
          try{
            await navigator.clipboard.writeText(text);
            const old = btn.textContent;
            btn.textContent = 'Copied ✓';
            setTimeout(()=>btn.textContent = old, 900);
          }catch(e){
            // fallback
            const ta = document.createElement('textarea');
            ta.value = text;
            document.body.appendChild(ta);
            ta.select();
            document.execCommand('copy');
            document.body.removeChild(ta);
            const old = btn.textContent;
            btn.textContent = 'Copied ✓';
            setTimeout(()=>btn.textContent = old, 900);
          }
        });
      });
    }

    /***********************
     * Physics core (quasi-plane-wave)
     ***********************/
    const params = {
      a: 20e-6,
      n1: 1.47,
      n2: 1.46,
      l: 1,
      rProbe: 5e-6,
      // J1 zeros (first several). Enough for our V range.
      j1zeros: [3.8317059702075125, 7.015586669815619, 10.173468135062722, 13.323691936314223, 16.470630050877634, 19.615858510468242]
    };

    function k0(lambda0){ return 2*Math.PI/lambda0; }

    function Vnumber(lambda0){
      const k = k0(lambda0);
      const NA2 = params.n1*params.n1 - params.n2*params.n2;
      return k*params.a*Math.sqrt(NA2);
    }

    function guidedModes_l1(lambda0){
      const V = Vnumber(lambda0);
      const modes = [];
      for(let i=0;i<params.j1zeros.length;i++){
        const u = params.j1zeros[i];
        if(u < V){
          const kt = u/params.a;
          const kk = params.n1*k0(lambda0);
          const beta = Math.sqrt(Math.max(0, kk*kk - kt*kt));
          modes.push({m:i+1, u, kt, beta});
        }
      }
      // sort by beta descending (equivalently u ascending)
      modes.sort((a,b)=>b.beta - a.beta);
      return {V, modes};
    }

    function wavevectorComponents(lambda0, mode, r){
      const kCore = params.n1*k0(lambda0);
      const kz = mode.beta;
      const kphi = params.l / r;
      const kr2 = Math.max(0, kCore*kCore - kz*kz - kphi*kphi);
      const kr = Math.sqrt(kr2);
      return {kCore, kz, kphi, kr};
    }

    function confinementShell(mode){
      // r_min = l / k_t = l a / u
      const rmin = params.l * params.a / mode.u;
      return {rmin, rmax: params.a};
    }

    /***********************
     * Canvas helpers (HiDPI + axes)
     ***********************/
    function setupCanvas(canvas){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.max(2, Math.floor(rect.width * dpr));
      canvas.height = Math.max(2, Math.floor(rect.height * dpr));
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
      return {ctx, w: rect.width, h: rect.height, dpr};
    }

    function drawGridAxes(ctx, box, xMin, xMax, yMin, yMax, opts){
      const {x, y, w, h} = box;
      const {
        xLabel='x', yLabel='y', title='',
        xTicks=5, yTicks=5
      } = opts || {};

      // background panel
      ctx.save();
      ctx.fillStyle = 'rgba(0,0,0,0.18)';
      roundRect(ctx, x, y, w, h, 14);
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.10)';
      ctx.lineWidth = 1;
      ctx.stroke();

      // title
      ctx.fillStyle = 'rgba(232,236,255,0.95)';
      ctx.font = '600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(title, x+12, y+20);

      // plot area
      const padL = 54, padR = 16, padT = 34, padB = 42;
      const px = x + padL, py = y + padT, pw = w - padL - padR, ph = h - padT - padB;

      // gridlines
      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      for(let i=0;i<=xTicks;i++){
        const t=i/xTicks;
        const gx = px + t*pw;
        ctx.moveTo(gx, py);
        ctx.lineTo(gx, py+ph);
      }
      for(let j=0;j<=yTicks;j++){
        const t=j/yTicks;
        const gy = py + t*ph;
        ctx.moveTo(px, gy);
        ctx.lineTo(px+pw, gy);
      }
      ctx.stroke();

      // axes
      ctx.strokeStyle = 'rgba(255,255,255,0.20)';
      ctx.beginPath();
      ctx.moveTo(px, py+ph);
      ctx.lineTo(px+pw, py+ph);
      ctx.moveTo(px, py);
      ctx.lineTo(px, py+ph);
      ctx.stroke();

      // ticks + labels
      ctx.fillStyle = 'rgba(183,192,255,0.85)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

      for(let i=0;i<=xTicks;i++){
        const t=i/xTicks;
        const xv = xMin + t*(xMax-xMin);
        const gx = px + t*pw;
        ctx.strokeStyle = 'rgba(255,255,255,0.22)';
        ctx.beginPath();
        ctx.moveTo(gx, py+ph);
        ctx.lineTo(gx, py+ph+6);
        ctx.stroke();
        const s = formatTick(xv);
        ctx.fillText(s, gx - ctx.measureText(s).width/2, py+ph+20);
      }

      for(let j=0;j<=yTicks;j++){
        const t=j/yTicks;
        const yv = yMax - t*(yMax-yMin);
        const gy = py + t*ph;
        ctx.strokeStyle = 'rgba(255,255,255,0.22)';
        ctx.beginPath();
        ctx.moveTo(px-6, gy);
        ctx.lineTo(px, gy);
        ctx.stroke();
        const s = formatTick(yv);
        ctx.fillText(s, px-10-ctx.measureText(s).width, gy+4);
      }

      // axis labels
      ctx.fillStyle = 'rgba(232,236,255,0.92)';
      ctx.font = '600 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(xLabel, px + pw/2 - ctx.measureText(xLabel).width/2, y + h - 10);

      ctx.save();
      ctx.translate(x+14, py+ph/2);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
      ctx.restore();

      ctx.restore();

      function xMap(xv){ return px + (xv-xMin)/(xMax-xMin)*pw; }
      function yMap(yv){ return py + (yMax-yv)/(yMax-yMin)*ph; }

      return {plot:{x:px,y:py,w:pw,h:ph}, xMap, yMap};
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr,y);
      ctx.arcTo(x+w,y,x+w,y+h,rr);
      ctx.arcTo(x+w,y+h,x,y+h,rr);
      ctx.arcTo(x,y+h,x,y,rr);
      ctx.arcTo(x,y,x+w,y,rr);
      ctx.closePath();
    }

    function formatTick(v){
      const av = Math.abs(v);
      if(av >= 1e6) return (v/1e6).toFixed(2) + 'e6';
      if(av >= 1e3) return (v/1e3).toFixed(2) + 'e3';
      if(av >= 10) return v.toFixed(2);
      if(av >= 1) return v.toFixed(3);
      return v.toFixed(4);
    }

    function drawLegend(ctx, items, x, y){
      ctx.save();
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      let yy = y;
      items.forEach(it=>{
        ctx.fillStyle = it.color;
        ctx.fillRect(x, yy-9, 12, 12);
        ctx.fillStyle = 'rgba(232,236,255,0.92)';
        ctx.fillText(it.label, x+18, yy+1);
        yy += 18;
      });
      ctx.restore();
    }

    /***********************
     * Draw: Diagram canvas
     ***********************/
    function drawDiagram(lambda0){
      const canvas = document.getElementById('diagCanvas');
      const {ctx, w, h} = setupCanvas(canvas);
      ctx.clearRect(0,0,w,h);

      const {modes} = guidedModes_l1(lambda0);
      if(modes.length === 0){
        ctx.fillStyle = 'rgba(232,236,255,0.92)';
        ctx.font = '600 16px system-ui';
        ctx.fillText('No guided l=1 modes at this wavelength (V too small).', 16, 34);
        return;
      }

      // smallest beta = last in descending beta list
      const modeMin = modes[modes.length-1];
      const shell = confinementShell(modeMin);
      const rmin = shell.rmin;

      // layout
      const cx = w*0.5, cy = h*0.52;
      const R = Math.min(w,h)*0.34; // core radius in pixels
      const scale = R / params.a;   // px per meter

      // title
      ctx.fillStyle = 'rgba(232,236,255,0.95)';
      ctx.font = '600 15px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText('Fiber cross-section & confinement shell (weakest-guided l=1 mode)', 14, 22);

      // core circle
      ctx.strokeStyle = 'rgba(122,167,255,0.9)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(cx, cy, R, 0, Math.PI*2);
      ctx.stroke();

      // cladding hint ring
      ctx.strokeStyle = 'rgba(255,255,255,0.14)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.arc(cx, cy, R*1.22, 0, Math.PI*2);
      ctx.stroke();

      // inner caustic
      ctx.setLineDash([6,6]);
      ctx.strokeStyle = 'rgba(100,240,200,0.95)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(cx, cy, rmin*scale, 0, Math.PI*2);
      ctx.stroke();
      ctx.setLineDash([]);

      // probe point at rProbe along +x
      const rp = params.rProbe*scale;
      ctx.fillStyle = 'rgba(255,211,106,0.95)';
      ctx.beginPath();
      ctx.arc(cx + rp, cy, 5, 0, Math.PI*2);
      ctx.fill();

      // labels
      ctx.fillStyle = 'rgba(183,192,255,0.90)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

      // axis lines
      ctx.strokeStyle = 'rgba(255,255,255,0.12)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(cx-R*1.25, cy);
      ctx.lineTo(cx+R*1.25, cy);
      ctx.moveTo(cx, cy-R*1.25);
      ctx.lineTo(cx, cy+R*1.25);
      ctx.stroke();

      // annotation lines
      // a
      ctx.strokeStyle = 'rgba(122,167,255,0.75)';
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx+R, cy);
      ctx.stroke();
      ctx.fillText('a = 20 µm', cx+R*0.55, cy-8);

      // rmin
      ctx.strokeStyle = 'rgba(100,240,200,0.75)';
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + rmin*scale, cy);
      ctx.stroke();
      ctx.fillText('r_min ≈ ' + (rmin*1e6).toFixed(3) + ' µm', cx + rmin*scale*0.35, cy+18);

      // r=5 µm
      ctx.strokeStyle = 'rgba(255,211,106,0.75)';
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(cx + rp, cy);
      ctx.stroke();
      ctx.fillText('probe r = 5 µm', cx + rp*0.55, cy-26);

      // small mode card
      const bx=14, by=h-90, bw=Math.min(520, w-28), bh=74;
      ctx.fillStyle='rgba(0,0,0,0.22)';
      roundRect(ctx,bx,by,bw,bh,14); ctx.fill();
      ctx.strokeStyle='rgba(255,255,255,0.10)'; ctx.stroke();

      ctx.fillStyle='rgba(232,236,255,0.92)';
      ctx.font='600 13px system-ui';
      ctx.fillText('Weakest-guided l=1 mode (largest u)', bx+12, by+22);

      ctx.fillStyle='rgba(183,192,255,0.92)';
      ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(`u ≈ ${modeMin.u.toFixed(4)},  β ≈ ${(modeMin.beta/1e6).toFixed(6)}e6 rad/m`, bx+12, by+44);
      ctx.fillText(`Shell: r_min ≈ ${(rmin*1e6).toFixed(3)} µm  to  a = 20 µm`, bx+12, by+62);
    }

    /***********************
     * Draw: Main plot (beta vs mode index)
     ***********************/
    function drawMainPlot(lambda0){
      const canvas = document.getElementById('mainPlot');
      const {ctx, w, h} = setupCanvas(canvas);
      ctx.clearRect(0,0,w,h);

      const res = guidedModes_l1(lambda0);
      const modes = res.modes;

      // compute bounds
      const k = k0(lambda0);
      const n1k = params.n1*k;
      const n2k = params.n2*k;

      // domain
      const xMin = 0.5;
      const xMax = Math.max(4.5, modes.length + 0.5);
      const yMin = n2k*0.995;
      const yMax = n1k*1.003;

      const padBox = {x: 0, y: 0, w, h};
      const ax = drawGridAxes(ctx, padBox, xMin, xMax, yMin, yMax, {
        title: 'Propagation constants for guided l=1 modes',
        xLabel: 'Radial order index m (dimensionless)',
        yLabel: 'β (rad/m)',
        xTicks: Math.max(4, modes.length),
        yTicks: 6
      });

      // horizontal bounds lines
      const yN1 = ax.yMap(n1k);
      const yN2 = ax.yMap(n2k);

      ctx.save();
      ctx.strokeStyle = 'rgba(122,167,255,0.65)';
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(ax.plot.x, yN1); ctx.lineTo(ax.plot.x+ax.plot.w, yN1); ctx.stroke();

      ctx.strokeStyle = 'rgba(255,107,139,0.65)';
      ctx.beginPath(); ctx.moveTo(ax.plot.x, yN2); ctx.lineTo(ax.plot.x+ax.plot.w, yN2); ctx.stroke();

      // points
      if(modes.length === 0){
        ctx.fillStyle = 'rgba(232,236,255,0.92)';
        ctx.font = '600 14px system-ui';
        ctx.fillText('No guided l=1 modes for this λ₀ (V too small).', ax.plot.x+10, ax.plot.y+40);
        ctx.restore();
        drawLegend(ctx, [
          {color:'rgba(122,167,255,0.65)', label:'n₁k₀'},
          {color:'rgba(255,107,139,0.65)', label:'n₂k₀'}
        ], ax.plot.x+12, ax.plot.y+60);
        return;
      }

      // sort by m ascending for x; our list is by beta descending, so remap
      const byM = modes.slice().sort((a,b)=>a.m-b.m);

      // connect line
      ctx.strokeStyle = 'rgba(255,255,255,0.18)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      byM.forEach((md, i)=>{
        const x = ax.xMap(md.m);
        const y = ax.yMap(md.beta);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // draw points with highlights
      const modeMax = byM.reduce((p,c)=> c.beta>p.beta?c:p, byM[0]);
      const modeMin = byM.reduce((p,c)=> c.beta<p.beta?c:p, byM[0]);

      byM.forEach(md=>{
        const x = ax.xMap(md.m);
        const y = ax.yMap(md.beta);

        let fill = 'rgba(232,236,255,0.90)';
        let r = 5;

        if(md === modeMax){ fill = 'rgba(125,255,155,0.95)'; r = 7; }
        if(md === modeMin){ fill = 'rgba(255,211,106,0.95)'; r = 7; }

        ctx.fillStyle = fill;
        ctx.beginPath();
        ctx.arc(x,y,r,0,Math.PI*2);
        ctx.fill();

        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(x,y,r,0,Math.PI*2);
        ctx.stroke();
      });

      // annotate extremes
      ctx.fillStyle = 'rgba(232,236,255,0.92)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      const xMaxPt = ax.xMap(modeMax.m), yMaxPt = ax.yMap(modeMax.beta);
      ctx.fillText(`β_max ≈ ${(modeMax.beta/1e6).toFixed(6)}e6`, xMaxPt+10, yMaxPt-10);
      const xMinPt = ax.xMap(modeMin.m), yMinPt = ax.yMap(modeMin.beta);
      ctx.fillText(`β_min ≈ ${(modeMin.beta/1e6).toFixed(6)}e6`, xMinPt+10, yMinPt+16);

      ctx.restore();

      // legend
      drawLegend(ctx, [
        {color:'rgba(232,236,255,0.85)', label:'β(m) points'},
        {color:'rgba(125,255,155,0.95)', label:'largest β'},
        {color:'rgba(255,211,106,0.95)', label:'smallest β'},
        {color:'rgba(122,167,255,0.65)', label:'n₁k₀'},
        {color:'rgba(255,107,139,0.65)', label:'n₂k₀'}
      ], ax.plot.x+12, ax.plot.y+60);

      // small V readout
      ctx.save();
      ctx.fillStyle='rgba(0,0,0,0.22)';
      roundRect(ctx, ax.plot.x+ax.plot.w-220, ax.plot.y+10, 210, 52, 12);
      ctx.fill();
      ctx.strokeStyle='rgba(255,255,255,0.10)'; ctx.stroke();
      ctx.fillStyle='rgba(183,192,255,0.92)';
      ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(`V ≈ ${res.V.toFixed(3)}`, ax.plot.x+ax.plot.w-206, ax.plot.y+32);
      ctx.fillText(`# guided l=1: ${modes.length}`, ax.plot.x+ax.plot.w-206, ax.plot.y+48);
      ctx.restore();
    }

    /***********************
     * Draw: Secondary plot (r_min vs mode index)
     ***********************/
    function drawSecondaryPlot(lambda0){
      const canvas = document.getElementById('secondaryPlot');
      const {ctx, w, h} = setupCanvas(canvas);
      ctx.clearRect(0,0,w,h);

      const res = guidedModes_l1(lambda0);
      const modes = res.modes.slice().sort((a,b)=>a.m-b.m);

      const xMin = 0.5;
      const xMax = Math.max(4.5, modes.length + 0.5);

      // y in microns for readability
      const rmins = modes.map(m=> (params.l*params.a/m.u)*1e6 );
      const yMin = 0.0;
      const yMax = Math.max(6, (Math.max(...rmins, 1.0))*1.15);

      const ax = drawGridAxes(ctx, {x:0,y:0,w,h}, xMin, xMax, yMin, yMax, {
        title: 'Inner turning radius r_min = (l a)/u for each guided l=1 mode',
        xLabel: 'Radial order index m (dimensionless)',
        yLabel: 'r_min (µm)',
        xTicks: Math.max(4, modes.length),
        yTicks: 6
      });

      // If no modes
      if(modes.length === 0){
        ctx.fillStyle = 'rgba(232,236,255,0.92)';
        ctx.font = '600 14px system-ui';
        ctx.fillText('No guided l=1 modes for this λ₀.', ax.plot.x+10, ax.plot.y+40);
        return;
      }

      // draw points + line
      ctx.strokeStyle = 'rgba(100,240,200,0.55)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      modes.forEach((md,i)=>{
        const rmin = (params.l*params.a/md.u)*1e6;
        const x = ax.xMap(md.m);
        const y = ax.yMap(rmin);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      });
      ctx.stroke();

      // points
      modes.forEach(md=>{
        const rmin = (params.l*params.a/md.u)*1e6;
        const x = ax.xMap(md.m);
        const y = ax.yMap(rmin);
        ctx.fillStyle = 'rgba(100,240,200,0.90)';
        ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.arc(x,y,5,0,Math.PI*2); ctx.stroke();

        // label u
        ctx.fillStyle = 'rgba(183,192,255,0.88)';
        ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
        ctx.fillText(`u≈${md.u.toFixed(2)}`, x+8, y-8);
      });

      // horizontal line for probe r=5um and a=20um if within chart
      const rp = params.rProbe*1e6;
      ctx.strokeStyle = 'rgba(255,211,106,0.45)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(ax.plot.x, ax.yMap(rp));
      ctx.lineTo(ax.plot.x+ax.plot.w, ax.yMap(rp));
      ctx.stroke();

      // legend
      drawLegend(ctx, [
        {color:'rgba(100,240,200,0.90)', label:'r_min points'},
        {color:'rgba(255,211,106,0.45)', label:'probe radius r=5 µm'}
      ], ax.plot.x+12, ax.plot.y+60);
    }

    /***********************
     * Update numerical answer boxes (fixed to original λ0=1.55 µm)
     ***********************/
    function updateFixedAnswers(){
      const lambda0 = 1.55e-6;
      const res = guidedModes_l1(lambda0);
      const modesByBeta = res.modes; // sorted by beta desc
      // For this parameter set, there should be 4 guided l=1 modes
      if(modesByBeta.length === 0){
        document.getElementById('ans_beta_max').textContent = 'β_max: (none guided)';
        document.getElementById('ans_beta_min').textContent = 'β_min: (none guided)';
        document.getElementById('ans_count').textContent = '0 modes';
        return;
      }
      const betaMax = modesByBeta[0].beta;
      const betaMin = modesByBeta[modesByBeta.length-1].beta;

      document.getElementById('ans_beta_max').textContent = `β_max ≈ ${betaMax.toExponential(6)} rad/m`;
      document.getElementById('ans_beta_min').textContent = `β_min ≈ ${betaMin.toExponential(6)} rad/m`;
      document.getElementById('ans_count').textContent = `${modesByBeta.length} modes (u₁..u₄)`;

      const k = k0(lambda0);
      const n1k = params.n1*k, n2k = params.n2*k;
      document.getElementById('ans_bounds').textContent = `n₂k₀ ≈ ${n2k.toExponential(6)};  n₁k₀ ≈ ${n1k.toExponential(6)}`;

      // Also keep the exact numbers used in the written solution consistent with computed values:
      // (We don't overwrite the solution text blocks; those were pre-filled to match.)
    }

    /***********************
     * Live update (slider)
     ***********************/
    function updateAll(){
      const lamUm = parseFloat(document.getElementById('lamSlider').value);
      document.getElementById('lamReadout').textContent = lamUm.toFixed(2) + ' µm';
      const lambda0 = lamUm * 1e-6;

      drawDiagram(lambda0);
      drawMainPlot(lambda0);
      drawSecondaryPlot(lambda0);
    }

    /***********************
     * Init + resize handling
     ***********************/
    function debounce(fn, ms){
      let t=null;
      return ()=>{ clearTimeout(t); t=setTimeout(fn, ms); };
    }

    window.addEventListener('resize', debounce(updateAll, 120));

    document.getElementById('lamSlider').addEventListener('input', updateAll);

    setupCopyButtons();
    updateFixedAnswers();
    updateAll();
  </script>
</body>
</html>
