<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Graded-Index Fiber (Parabolic p=2): Propagation Constant and Wavevector</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --card:#0f1730;
      --ink:#eaf0ff;
      --muted:#b8c4ffcc;
      --faint:#b8c4ff55;
      --accent:#7cd6ff;
      --accent2:#a6ffcb;
      --warn:#ffd27c;
      --ok:#a6ffcb;
      --bad:#ff8aa6;
      --line:#2a3a72;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 600px at 10% 0%, rgba(124,214,255,.18), transparent 60%),
        radial-gradient(1000px 600px at 90% 20%, rgba(166,255,203,.10), transparent 55%),
        radial-gradient(900px 500px at 50% 110%, rgba(255,210,124,.10), transparent 60%),
        linear-gradient(180deg, #070a14, var(--bg) 22%, #070a14 130%);
      line-height:1.55;
    }
    header{
      padding:28px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }
    .hero{
      background: linear-gradient(135deg, rgba(124,214,255,.14), rgba(166,255,203,.10));
      border:1px solid rgba(124,214,255,.22);
      border-radius: calc(var(--radius) + 6px);
      box-shadow: var(--shadow);
      padding:20px 18px;
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(700px 250px at 15% 25%, rgba(124,214,255,.18), transparent 60%),
        radial-gradient(700px 250px at 85% 60%, rgba(166,255,203,.14), transparent 60%);
      filter: blur(2px);
      pointer-events:none;
    }
    .hero > *{position:relative}
    h1{
      margin: 4px 0 6px;
      font-size: clamp(1.4rem, 1.1rem + 1.5vw, 2.2rem);
      letter-spacing: .2px;
    }
    .sub{
      margin:0;
      color: var(--muted);
      max-width: 80ch;
    }

    main{
      max-width:1200px;
      margin: 14px auto 64px;
      padding: 0 18px 48px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }

    nav.toc{
      position: sticky;
      top: 14px;
      align-self:start;
      background: rgba(17,26,51,.78);
      backdrop-filter: blur(10px);
      border:1px solid rgba(124,214,255,.18);
      border-radius: var(--radius);
      padding:14px 12px;
      box-shadow: 0 10px 28px rgba(0,0,0,.30);
    }
    nav.toc h2{
      font-size: .95rem;
      margin: 4px 8px 10px;
      color: var(--muted);
      letter-spacing:.4px;
      text-transform: uppercase;
    }
    nav.toc a{
      display:block;
      padding:8px 10px;
      margin: 4px 2px;
      border-radius: 12px;
      color: var(--ink);
      text-decoration:none;
      border: 1px solid transparent;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size: .95rem;
    }
    nav.toc a:hover{
      background: rgba(124,214,255,.10);
      border-color: rgba(124,214,255,.20);
      transform: translateY(-1px);
    }

    article{
      display:flex;
      flex-direction:column;
      gap: 14px;
      min-width: 0;
    }
    section{
      background: rgba(15,23,48,.72);
      border: 1px solid rgba(124,214,255,.15);
      border-radius: var(--radius);
      padding: 16px 16px;
      box-shadow: 0 10px 28px rgba(0,0,0,.26);
      overflow:hidden;
    }
    section h2{
      margin: 4px 0 10px;
      font-size: 1.25rem;
    }
    section h3{
      margin: 16px 0 8px;
      font-size: 1.05rem;
      color: var(--muted);
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 900px){
      .grid2{grid-template-columns:1fr}
    }

    .card{
      background: rgba(17,26,51,.65);
      border: 1px solid rgba(184,196,255,.14);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .callout{
      border-left: 4px solid var(--accent);
      background: rgba(124,214,255,.08);
      padding: 12px 12px;
      border-radius: 14px;
      margin: 10px 0;
    }
    .callout.warn{border-left-color: var(--warn); background: rgba(255,210,124,.10);}
    .callout.ok{border-left-color: var(--ok); background: rgba(166,255,203,.10);}
    .callout.bad{border-left-color: var(--bad); background: rgba(255,138,166,.10);}
    ul{margin: 8px 0 0 20px}
    li{margin: 6px 0}
    .eq{
      background: rgba(7,10,20,.55);
      border:1px solid rgba(184,196,255,.16);
      border-radius: 14px;
      padding: 10px 10px;
      font-family: var(--mono);
      font-size: .95rem;
      overflow:auto;
      position:relative;
    }
    .eq .copyBtn{
      position:absolute;
      top:8px;
      right:8px;
      border:1px solid rgba(124,214,255,.35);
      background: rgba(124,214,255,.12);
      color: var(--ink);
      border-radius: 10px;
      padding: 6px 8px;
      cursor:pointer;
      font-family: var(--sans);
      font-size: .85rem;
      transition: transform .12s ease, background .12s ease;
    }
    .eq .copyBtn:hover{transform: translateY(-1px); background: rgba(124,214,255,.18);}
    .pillrow{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
    }
    .pill{
      border:1px solid rgba(184,196,255,.18);
      background: rgba(17,26,51,.55);
      padding: 6px 10px;
      border-radius: 999px;
      font-size:.9rem;
      color: var(--muted);
    }

    figure{
      margin: 0;
      padding: 0;
    }
    .vizWrap{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 12px;
      align-items: stretch;
    }
    @media (max-width: 980px){
      .vizWrap{grid-template-columns:1fr}
    }
    .vizCard{
      background: rgba(17,26,51,.60);
      border: 1px solid rgba(184,196,255,.16);
      border-radius: 16px;
      padding: 12px;
      min-width: 0;
    }
    .canvasBox{
      width:100%;
      height: 330px;
      border-radius: 14px;
      border: 1px solid rgba(124,214,255,.18);
      background: radial-gradient(800px 300px at 50% 30%, rgba(124,214,255,.10), transparent 60%),
                  linear-gradient(180deg, rgba(7,10,20,.6), rgba(7,10,20,.85));
      display:block;
    }
    .canvasBox.short{height: 280px;}
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin-top: 10px;
      padding-top: 10px;
      border-top: 1px solid rgba(184,196,255,.14);
    }
    .control{
      display:grid;
      gap: 4px;
      min-width: 190px;
      flex: 1 1 220px;
    }
    label{color: var(--muted); font-size: .92rem;}
    input[type="range"]{width:100%}
    select, button{
      border-radius: 12px;
      border: 1px solid rgba(184,196,255,.18);
      background: rgba(7,10,20,.55);
      color: var(--ink);
      padding: 8px 10px;
      font-family: var(--sans);
    }
    button{
      cursor:pointer;
      border-color: rgba(124,214,255,.28);
      background: rgba(124,214,255,.10);
      transition: transform .12s ease, background .12s ease;
    }
    button:hover{transform: translateY(-1px); background: rgba(124,214,255,.16);}

    .small{
      font-size:.92rem;
      color: var(--muted);
    }
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 900px){
      .kpi{grid-template-columns:1fr}
    }
    .kpi .box{
      background: rgba(7,10,20,.45);
      border: 1px solid rgba(184,196,255,.15);
      border-radius: 16px;
      padding: 10px 10px;
    }
    .kpi .box b{display:block; margin-bottom: 4px;}
    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 48px;
      color: var(--muted);
      font-size:.92rem;
    }

    /* subtle motion, reduced-motion friendly */
    @media (prefers-reduced-motion: no-preference){
      section{animation: rise .28s ease both;}
      @keyframes rise{
        from{opacity:0; transform: translateY(8px);}
        to{opacity:1; transform: translateY(0);}
      }
    }

    /* print */
    @media print{
      body{background:#fff; color:#000}
      nav.toc{display:none}
      main{grid-template-columns:1fr}
      section, .hero{box-shadow:none; background:#fff; border:1px solid #ddd}
      .eq{background:#f7f7f7}
      .canvasBox{border:1px solid #ccc; background:#fff}
      .copyBtn{display:none}
    }
  </style>
</head>
<body>
<header>
  <div class="hero">
    <h1>Propagation Constant &amp; Wavevector in a Parabolic Graded-Index Fiber (p = 2)</h1>
    <p class="sub">
      We repeat the “step-index fiber” style calculations, but now the refractive index varies smoothly across the core.
      The key outcome: in a parabolic graded index, meridional rays follow <b>sinusoidal</b> trajectories, and the axial
      propagation constant <b>&beta;</b> (the z-component of the wavevector) remains an invariant of motion.
    </p>
    <div class="pillrow">
      <span class="pill">Geometrical optics / eikonal</span>
      <span class="pill">Parabolic profile (p=2)</span>
      <span class="pill">&beta; = k<sub>z</sub> conserved</span>
      <span class="pill">r(z) sinusoidal</span>
    </div>
  </div>
</header>

<main>
  <nav class="toc" aria-label="Table of contents">
    <h2>Contents</h2>
    <a href="#qs">Quick Summary</a>
    <a href="#p0">PART 0 — Concept Primer</a>
    <a href="#p1">PART 1 — Problem Analysis</a>
    <a href="#p2">PART 2 — Strategy &amp; Tips</a>
    <a href="#p3">PART 3 — Full Solution</a>
    <a href="#p4">PART 4 — Deeper Understanding</a>
    <a href="#p5">PART 5 — Visualization Guide</a>
  </nav>

  <article>
    <section id="qs">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>What this is about:</b> Determine the <b>axial propagation constant</b> &beta; and the <b>wavevector components</b> for rays in a <b>graded-index (GRIN) fiber</b> with <b>parabolic profile</b> (power-law exponent p = 2).</li>
        <li><b>Key physics idea:</b> In an axially uniform medium, the z-component of the wavevector is conserved:
          <b>&beta; = k<sub>z</sub></b> is an invariant even though <b>n = n(r)</b> changes with radius.</li>
        <li><b>Index model (parabolic):</b> For core radius <i>a</i> and relative index difference &Delta;,
          <span style="font-family:var(--mono)">n(r) = n1 * sqrt(1 - 2Δ (r/a)^2)</span> (exact GRIN model used here).</li>
        <li><b>Governing relation:</b> Local magnitude <b>|k| = n(r)k0</b>, with <b>k0 = 2π/λ</b>, and
          <b>k<sub>r</sub><sup>2</sup> + &beta;<sup>2</sup> = n(r)<sup>2</sup> k0<sup>2</sup></b>.</li>
        <li><b>Key result type:</b> Symbolic formulas for <b>r(z)</b>, <b>k<sub>r</sub>(z)</b>, and the “oscillation frequency” <b>g</b>; example numeric plots shown for typical telecom-like parameters.</li>
        <li><b>Signature GRIN behavior (p=2):</b> The ray radius varies sinusoidally:
          <b>r(z) = r<sub>max</sub> sin(gz + φ)</b>, and the ray “pitch” is <b>Z<sub>p</sub> = 2π/g</b>.</li>
      </ul>
    </section>

    <section id="p0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div class="card">
          <h3>Core definitions (symbols &amp; units)</h3>
          <ul>
            <li><b>Refractive index:</b> <span style="font-family:var(--mono)">n(r)</span> (dimensionless), varying with radius <span style="font-family:var(--mono)">r</span> (m).</li>
            <li><b>Free-space wavenumber:</b> <span style="font-family:var(--mono)">k0 = 2π/λ</span> (rad/m), with wavelength <span style="font-family:var(--mono)">λ</span> (m).</li>
            <li><b>Local wavevector magnitude:</b> <span style="font-family:var(--mono)">|k| = n(r) k0</span> (rad/m).</li>
            <li><b>Propagation constant:</b> <span style="font-family:var(--mono)">β</span> (rad/m), the axial component <span style="font-family:var(--mono)">kz</span>.</li>
            <li><b>Core radius:</b> <span style="font-family:var(--mono)">a</span> (m).</li>
            <li><b>Relative index difference:</b> <span style="font-family:var(--mono)">Δ = (n1^2 - n2^2)/(2 n1^2)</span> (dimensionless, typically ≪ 1).</li>
          </ul>
        </div>

        <div class="card">
          <h3>Physical meaning (what these represent)</h3>
          <ul>
            <li><b>&beta;:</b> controls phase accumulation along the fiber axis:
              phase ∝ <span style="font-family:var(--mono)">β z</span>. Larger &beta; means more axial “forward” propagation.</li>
            <li><b>k<sub>r</sub>:</b> the radial component; it measures how strongly the ray swings across the core.</li>
            <li><b>n(r) profile:</b> a “refractive index lens” that continuously bends rays back toward the axis. A parabolic profile produces an <b>ideal focusing</b> equivalent to a harmonic oscillator in ray optics.</li>
          </ul>
        </div>
      </div>

      <h3>Key laws/principles (validity &amp; assumptions)</h3>
      <div class="callout">
        <b>Eikonal / geometrical optics:</b> When the index varies slowly on the scale of the wavelength (<span style="font-family:var(--mono)">|∇n| ≪ k0 n</span>), light can be described by rays.
        The wavevector follows <span style="font-family:var(--mono)">|k| = n k0</span>, and conserved quantities come from symmetries.
      </div>

      <div class="grid2">
        <div class="card">
          <h3>Common models &amp; approximations</h3>
          <ul>
            <li><b>Power-law GRIN core:</b> <span style="font-family:var(--mono)">n(r) = n1 sqrt(1 - 2Δ (r/a)^p)</span>.</li>
            <li><b>Parabolic profile:</b> <span style="font-family:var(--mono)">p = 2</span>; special because ray equation becomes exactly harmonic (in the core).</li>
            <li><b>Weak guidance:</b> &Delta; ≪ 1 ⇒ small angles and small index contrast; simplifies pitch and intuition.</li>
          </ul>
        </div>
        <div class="card">
          <h3>Mini intuition examples</h3>
          <ul>
            <li><b>Step-index vs GRIN:</b> step-index rays reflect at the boundary; GRIN rays bend smoothly because the “speed of light” changes with radius.</li>
            <li><b>Parabolic GRIN:</b> behaves like a perfect “index lens” inside the core: the restoring bending force is proportional to displacement <span style="font-family:var(--mono)">r</span>, hence sinusoidal motion.</li>
          </ul>
        </div>
      </div>

      <div class="callout.warn">
        <b>What to watch for (pitfalls)</b>
        <ul>
          <li>Mixing <b>fields/modes</b> (wave optics) with <b>rays</b> (geometrical optics). Here we use the ray/eikonal picture to get &beta; and k-components.</li>
          <li>Forgetting that <b>&beta; is conserved</b> only because the fiber is uniform along <i>z</i> (no z-dependent index).</li>
          <li>Confusing <b>n(r)</b> with the cladding index <b>n2</b>; in GRIN, guiding is mostly from the graded core plus a lower-index cladding boundary.</li>
        </ul>
      </div>
    </section>

    <section id="p1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Problem restatement</h3>
      <p>
        We consider a graded-index fiber whose core refractive index follows a <b>parabolic radial profile</b> (power-law exponent <b>p = 2</b>).
        We want to carry out the same kind of calculations as for a step-index fiber: determine the <b>propagation constant</b> &beta; and
        the associated <b>wavevector components</b> (axial and radial), and understand the ray trajectory.
      </p>

      <div class="grid2">
        <div class="card">
          <h3>Given</h3>
          <ul>
            <li>Core radius <span style="font-family:var(--mono)">a</span></li>
            <li>Axis index <span style="font-family:var(--mono)">n1 = n(0)</span></li>
            <li>Relative index difference <span style="font-family:var(--mono)">Δ</span> (weak guidance typically)</li>
            <li>Parabolic profile <span style="font-family:var(--mono)">p = 2</span></li>
            <li>Free-space wavelength <span style="font-family:var(--mono)">λ</span> (for numeric illustration/plotting)</li>
          </ul>
        </div>
        <div class="card">
          <h3>Unknowns / what to find</h3>
          <ul>
            <li>Propagation constant <span style="font-family:var(--mono)">β = kz</span> (invariant)</li>
            <li>Radial wavevector <span style="font-family:var(--mono)">kr(r)</span> and slope <span style="font-family:var(--mono)">dr/dz</span></li>
            <li>Ray path <span style="font-family:var(--mono)">r(z)</span> and pitch <span style="font-family:var(--mono)">Zp</span></li>
            <li>Physical interpretation (how GRIN changes things vs step-index)</li>
          </ul>
        </div>
      </div>

      <h3>Relevant principles and why they apply</h3>
      <ul>
        <li><b>Local dispersion in dielectrics:</b> in isotropic medium, <span style="font-family:var(--mono)">|k| = n(r) k0</span>.</li>
        <li><b>Axial symmetry (z-invariance):</b> since <span style="font-family:var(--mono)">n</span> depends on <span style="font-family:var(--mono)">r</span> but not <span style="font-family:var(--mono)">z</span>, the canonical momentum along z is conserved ⇒ <span style="font-family:var(--mono)">kz = β</span> constant.</li>
        <li><b>Turning point condition:</b> at maximum radius <span style="font-family:var(--mono)">rmax</span>, the ray is locally parallel to z ⇒ <span style="font-family:var(--mono)">kr = 0</span> ⇒ <span style="font-family:var(--mono)">β = n(rmax) k0</span>.</li>
      </ul>

      <div class="callout">
        <b>Assumptions (explicit)</b>
        <ul>
          <li>Geometrical optics/eikonal: wavelength small relative to index-variation scale.</li>
          <li>Meridional rays (we ignore skew rays for clarity): motion in a plane through the fiber axis.</li>
          <li>Within the core, <span style="font-family:var(--mono)">n(r) = n1 sqrt(1 - 2Δ (r/a)^2)</span> (parabolic p=2 power-law form).</li>
          <li>Weak guidance often used for intuition (&Delta; ≪ 1), but the main derivation below keeps the p=2 form in <span style="font-family:var(--mono)">n^2</span>.</li>
        </ul>
      </div>

      <h3>Possible approaches (compare)</h3>
      <ul>
        <li><b>(A) Ray invariant + first-order ODE (best here):</b> Use <span style="font-family:var(--mono)">kr^2 + β^2 = n(r)^2 k0^2</span> to get <span style="font-family:var(--mono)">dr/dz</span>, then show it becomes harmonic for p=2. <i>Pros:</i> direct connection to &beta; and wavevector. <i>Cons:</i> assumes ray picture.</li>
        <li><b>(B) Fermat principle / Euler–Lagrange:</b> Minimize optical path <span style="font-family:var(--mono)">∫ n ds</span> to get a ray equation; yields the same harmonic result for p=2. <i>Pros:</i> deep variational insight. <i>Cons:</i> longer setup.</li>
        <li><b>(C) Full wave (LP modes) approximation:</b> Solve scalar wave equation in parabolic index (gives Hermite–Gaussian/Laguerre–Gaussian-like modes). <i>Pros:</i> modal interpretation. <i>Cons:</i> not what “same calculations as step-index ray constants” usually means.</li>
      </ul>
      <p><b>Chosen approach:</b> (A) Ray invariant + wavevector decomposition, because the question targets “propagation constants and wavevector” and p=2 yields a clean, teachable closed form.</p>
    </section>

    <section id="p2">
      <h2>PART 2 — Strategy &amp; Tips (Roadmap Only)</h2>

      <ol>
        <li><b>Write the parabolic index model</b>
          <div class="small">Tool: power-law GRIN for p=2. Meaning: sets how |k| changes with radius.</div>
        </li>
        <li><b>Use local dispersion</b> <span style="font-family:var(--mono)">|k| = n(r)k0</span>
          <div class="small">Meaning: wavevector magnitude tracks local index.</div>
        </li>
        <li><b>Invoke z-invariance</b> to assert <span style="font-family:var(--mono)">kz = β = constant</span>
          <div class="small">Meaning: the axial phase advance per unit length is fixed along the ray.</div>
        </li>
        <li><b>Relate radial component</b> via <span style="font-family:var(--mono)">kr^2 = n(r)^2 k0^2 − β^2</span>
          <div class="small">Meaning: transverse swing comes from the “excess” wavevector beyond β.</div>
        </li>
        <li><b>Connect to ray slope</b> using <span style="font-family:var(--mono)">dr/dz = kr/β</span> (paraxial/eikonal form)
          <div class="small">Meaning: transverse direction cosine is set by the ratio of components.</div>
        </li>
        <li><b>Use turning point condition</b> at <span style="font-family:var(--mono)">r = rmax</span>: <span style="font-family:var(--mono)">β = n(rmax) k0</span>
          <div class="small">Meaning: identifies β in terms of the maximum excursion.</div>
        </li>
        <li><b>Show the ODE is harmonic</b> for p=2 and solve <span style="font-family:var(--mono)">r(z)</span>
          <div class="small">Meaning: GRIN parabolic profile makes rays sinusoidal.</div>
        </li>
        <li><b>Extract pitch and component evolution</b>: <span style="font-family:var(--mono)">Zp = 2π/g</span>, compute <span style="font-family:var(--mono)">kr(z)</span>, <span style="font-family:var(--mono)">θ(z)</span>.
          <div class="small">Meaning: links geometry to wavevector.</div>
        </li>
        <li><b>Sanity checks</b>: units, limits (&Delta;→0, rmax→0), physical interpretation.
          <div class="small">Meaning: verify the formulas are consistent with intuition.</div>
        </li>
      </ol>

      <div class="callout.warn">
        <b>Common mistakes &amp; quick tips</b>
        <ul>
          <li>Don’t set <span style="font-family:var(--mono)">β = n1 k0</span> unless you explicitly assume <span style="font-family:var(--mono)">rmax → 0</span> (near-axis ray).</li>
          <li>Be consistent: <span style="font-family:var(--mono)">k = n k0</span> is a <i>local</i> magnitude; only <span style="font-family:var(--mono)">β</span> is conserved.</li>
          <li>The pitch becomes nearly wavelength-independent in weak guidance; that’s a <i>ray-optics</i> feature of p=2.</li>
        </ul>
      </div>
    </section>

    <section id="p3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Physical intuition (before math)</h3>
      <p>
        In a parabolic GRIN core, the index is highest on the axis and decreases with radius. A ray moving outward
        enters lower index, so its local wavevector magnitude <span style="font-family:var(--mono)">|k| = n(r)k0</span> decreases.
        To keep the axial component <span style="font-family:var(--mono)">β</span> constant, the transverse component must drop to zero at a turning point.
        The continuous “bending back” toward the axis acts like a restoring force proportional to displacement, so the ray oscillates sinusoidally.
      </p>

      <h3>Step 1 — Index profile (p = 2)</h3>
      <div class="eq" data-copy="eq1">
        <button class="copyBtn" data-copy-btn="eq1">Copy</button>
        <div id="eq1">n(r) = n1 * sqrt(1 - 2Δ (r/a)^2),   0 ≤ r ≤ a</div>
      </div>
      <p class="small">
        Here <span style="font-family:var(--mono)">n1 = n(0)</span> is the on-axis index, <span style="font-family:var(--mono)">a</span> is the core radius, and
        <span style="font-family:var(--mono)">Δ</span> sets the index depression toward the edge.
      </p>

      <h3>Step 2 — Local wavevector and conserved axial component</h3>
      <p>
        The local magnitude of the wavevector in an isotropic dielectric is
        <span style="font-family:var(--mono)">|k| = n(r) k0</span> with <span style="font-family:var(--mono)">k0 = 2π/λ</span>.
        Decompose the wavevector into axial and radial components for a meridional ray:
      </p>

      <div class="eq" data-copy="eq2">
        <button class="copyBtn" data-copy-btn="eq2">Copy</button>
        <div id="eq2">k(r)^2 = kr(r)^2 + kz^2 = n(r)^2 k0^2,   with kz = β (constant)</div>
      </div>

      <p>
        <b>Why is</b> <span style="font-family:var(--mono)">kz = β</span> <b>constant?</b>
        Because the medium is invariant under translation along z (the index depends on r only).
        That symmetry conserves the canonical momentum along z, which in ray optics corresponds to <span style="font-family:var(--mono)">kz</span>.
      </p>

      <h3>Step 3 — Solve for the radial wavevector component</h3>
      <p>From the Pythagorean relation for components:</p>
      <div class="eq" data-copy="eq3">
        <button class="copyBtn" data-copy-btn="eq3">Copy</button>
        <div id="eq3">kr(r) = ± sqrt(n(r)^2 k0^2 - β^2)</div>
      </div>
      <p class="small">
        The sign just tells whether the ray is moving outward (+) or inward (−) at that moment.
      </p>

      <h3>Step 4 — Connect wavevector components to the ray slope</h3>
      <p>
        The ray direction is parallel to the wavevector in isotropic media. In the meridional plane,
        the slope can be written (paraxial/eikonal form):
      </p>
      <div class="eq" data-copy="eq4">
        <button class="copyBtn" data-copy-btn="eq4">Copy</button>
        <div id="eq4">dr/dz = kr/β = ± (1/β) * sqrt(n(r)^2 k0^2 - β^2)</div>
      </div>

      <div class="callout">
        <b>What we did and why:</b> We used component geometry to translate a wavevector relation into a differential equation for the ray path <span style="font-family:var(--mono)">r(z)</span>.
      </div>

      <h3>Step 5 — Insert the parabolic n(r) and reveal a harmonic oscillator</h3>
      <p>
        Using <span style="font-family:var(--mono)">n(r)^2 = n1^2 (1 - 2Δ r^2/a^2)</span>, the slope equation becomes
      </p>

      <div class="eq" data-copy="eq5">
        <button class="copyBtn" data-copy-btn="eq5">Copy</button>
        <div id="eq5">dr/dz = ± (1/β) * sqrt( n1^2 k0^2 (1 - 2Δ r^2/a^2) - β^2 )</div>
      </div>

      <p>
        Define a convenient constant:
        <span style="font-family:var(--mono)">A = n1^2 k0^2 - β^2</span> (units: rad<sup>2</sup>/m<sup>2</sup>).
        Then
        <span style="font-family:var(--mono)">dr/dz = ± (1/β) sqrt(A - (2Δ n1^2 k0^2/a^2) r^2)</span>.
        Differentiate both sides with respect to z (carefully) to get a second-order equation:
      </p>

      <div class="eq" data-copy="eq6">
        <button class="copyBtn" data-copy-btn="eq6">Copy</button>
        <div id="eq6">d²r/dz² + g² r = 0,   where   g = (n1 k0/β) * (sqrt(2Δ)/a)</div>
      </div>

      <p class="small">
        <b>Explanation:</b> The derivative converts the square-root first integral into a linear restoring form.
        Parabolic index → restoring term proportional to r → simple harmonic motion.
      </p>

      <h3>Step 6 — Ray trajectory and pitch</h3>
      <p>The harmonic-oscillator solution is:</p>
      <div class="eq" data-copy="eq7">
        <button class="copyBtn" data-copy-btn="eq7">Copy</button>
        <div id="eq7">r(z) = rmax * sin(g z + φ),   and   dr/dz = g rmax * cos(g z + φ)</div>
      </div>

      <p>
        The spatial period (“pitch”) is
      </p>
      <div class="eq" data-copy="eq8">
        <button class="copyBtn" data-copy-btn="eq8">Copy</button>
        <div id="eq8">Zp = 2π/g = 2π a * (β/(n1 k0)) / sqrt(2Δ)</div>
      </div>

      <div class="callout ok">
        <b>Weak-guidance simplification:</b> If the ray stays near-axis so <span style="font-family:var(--mono)">β ≈ n1 k0</span>,
        then <span style="font-family:var(--mono)">Zp ≈ 2π a / sqrt(2Δ)</span> — nearly wavelength-independent in ray optics.
      </div>

      <h3>Step 7 — Relating β to maximum radius r<sub>max</sub> (turning point)</h3>
      <p>
        At the turning point <span style="font-family:var(--mono)">r = rmax</span>, the ray is momentarily parallel to z, so
        <span style="font-family:var(--mono)">kr = 0</span>. From <span style="font-family:var(--mono)">kr^2 = n(r)^2 k0^2 - β^2</span>:
      </p>
      <div class="eq" data-copy="eq9">
        <button class="copyBtn" data-copy-btn="eq9">Copy</button>
        <div id="eq9">β = n(rmax) k0 = n1 k0 * sqrt(1 - 2Δ (rmax/a)^2)</div>
      </div>

      <p>
        This is a particularly nice result: <b>&beta; is set by how far the ray ventures into lower index.</b>
        Solve it for <span style="font-family:var(--mono)">rmax</span> if you prefer:
      </p>
      <div class="eq" data-copy="eq10">
        <button class="copyBtn" data-copy-btn="eq10">Copy</button>
        <div id="eq10">rmax = (a/ sqrt(2Δ)) * sqrt(1 - (β/(n1 k0))^2)</div>
      </div>

      <h3>Step 8 — Wavevector components along the ray</h3>
      <p>
        The axial component is constant by construction:
        <span style="font-family:var(--mono)">kz = β</span>.
        The radial component follows from the slope:
        <span style="font-family:var(--mono)">kr = β (dr/dz)</span>.
        Using the sinusoidal solution:
      </p>

      <div class="eq" data-copy="eq11">
        <button class="copyBtn" data-copy-btn="eq11">Copy</button>
        <div id="eq11">kz = β (constant),   kr(z) = β * dr/dz = β g rmax * cos(g z + φ)</div>
      </div>

      <p>
        You can also express the instantaneous ray angle (relative to z) via
        <span style="font-family:var(--mono)">tan θ(z) = kr/β = dr/dz</span>
        (small angles: <span style="font-family:var(--mono)">θ ≈ dr/dz</span>).
      </p>

      <h3>Sanity checks</h3>
      <div class="grid2">
        <div class="card">
          <h3>Units / dimensions</h3>
          <ul>
            <li><span style="font-family:var(--mono)">β</span>, <span style="font-family:var(--mono)">k0</span>, <span style="font-family:var(--mono)">kr</span> all have units rad/m.</li>
            <li><span style="font-family:var(--mono)">g</span> has units 1/m, so <span style="font-family:var(--mono)">Zp = 2π/g</span> has units m.</li>
          </ul>
        </div>
        <div class="card">
          <h3>Limiting cases</h3>
          <ul>
            <li><b>&Delta; → 0:</b> index becomes uniform; <span style="font-family:var(--mono)">g → 0</span>, so the ray becomes a straight line (no oscillation).</li>
            <li><b>rmax → 0:</b> then <span style="font-family:var(--mono)">β → n1 k0</span> and the pitch approaches <span style="font-family:var(--mono)">2π a / sqrt(2Δ)</span>.</li>
            <li><b>At turning point:</b> <span style="font-family:var(--mono)">kr = 0</span> as required.</li>
          </ul>
        </div>
      </div>

      <div class="callout ok">
        <b>Connection to diagram/plots:</b> The diagram shows the graded core and a ray oscillating in radius.
        The main plot draws <span style="font-family:var(--mono)">r(z)</span> over multiple pitches. The secondary plot shows
        how <span style="font-family:var(--mono)">kr(z)</span> (and the small ray angle) oscillate in quadrature with <span style="font-family:var(--mono)">r(z)</span>.
      </div>

      <h3>Final Answer (boxed)</h3>
      <div class="eq" data-copy="finalAns">
        <button class="copyBtn" data-copy-btn="finalAns">Copy</button>
        <div id="finalAns">Parabolic GRIN (p=2): n(r)=n1*sqrt(1-2Δ(r/a)^2).
Local wavevector magnitude: |k|=n(r)k0, k0=2π/λ.
Axial propagation constant (invariant): kz=β=constant.
Radial component: kr(r)=±sqrt(n(r)^2 k0^2-β^2).
Ray slope: dr/dz=kr/β=±(1/β)sqrt(n(r)^2k0^2-β^2).

Turning point (r=rmax): β=n(rmax)k0=n1 k0*sqrt(1-2Δ(rmax/a)^2).

Ray equation reduces to SHM:
d²r/dz²+g²r=0,  g=(n1 k0/β)*(sqrt(2Δ)/a).

Solution: r(z)=rmax sin(gz+φ),
Pitch: Zp=2π/g=2π a*(β/(n1 k0))/sqrt(2Δ),
Wavevector components: kz=β,  kr(z)=β g rmax cos(gz+φ).</div>
      </div>
    </section>

    <section id="p4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpreting the formulas</h3>
      <ul>
        <li><b>&beta; as “how axial” the ray is:</b> If the ray stays near the axis, it samples high index and &beta; is close to <span style="font-family:var(--mono)">n1 k0</span>. If it swings outward, it samples lower index and &beta; drops via <span style="font-family:var(--mono)">β = n(rmax)k0</span>.</li>
        <li><b>g sets the focusing strength:</b> Larger &Delta; (steeper index drop) makes <span style="font-family:var(--mono)">g</span> larger → tighter oscillations → smaller pitch.</li>
        <li><b>Quadrature:</b> <span style="font-family:var(--mono)">r(z)</span> and <span style="font-family:var(--mono)">kr(z)</span> are 90° out of phase, like position and momentum in a harmonic oscillator.</li>
      </ul>

      <h3>Parameter effects (connect to interactive plots)</h3>
      <div class="grid2">
        <div class="card">
          <h3>Changing r<sub>max</sub>/a</h3>
          <ul>
            <li>Increases the excursion and decreases &beta; (because <span style="font-family:var(--mono)">n(rmax)</span> is smaller).</li>
            <li>Through <span style="font-family:var(--mono)">g ∝ 1/β</span>, the oscillation becomes slightly faster (shorter pitch) when &beta; decreases.</li>
            <li><span style="font-family:var(--mono)">kr</span> amplitude grows roughly with <span style="font-family:var(--mono)">β g rmax</span>, so it increases with excursion.</li>
          </ul>
        </div>
        <div class="card">
          <h3>Changing Δ</h3>
          <ul>
            <li>Larger &Delta; strengthens refraction, increasing <span style="font-family:var(--mono)">g ∝ sqrt(Δ)</span>.</li>
            <li>Pitch shrinks roughly as <span style="font-family:var(--mono)">Zp ∝ 1/sqrt(Δ)</span>.</li>
            <li>Also changes the mapping between <span style="font-family:var(--mono)">β</span> and <span style="font-family:var(--mono)">rmax</span>.</li>
          </ul>
        </div>
      </div>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        You can derive the same harmonic ray equation from <b>Fermat’s principle</b>.
        Write the optical path length functional <span style="font-family:var(--mono)">∫ n(r) ds</span> with
        <span style="font-family:var(--mono)">ds = sqrt(1+(dr/dz)^2) dz</span>, then apply Euler–Lagrange.
        The absence of explicit z-dependence immediately yields a conserved quantity equivalent to <span style="font-family:var(--mono)">β</span>,
        and for <span style="font-family:var(--mono)">n(r)^2</span> parabolic you obtain the same simple-harmonic motion.
      </p>

      <h3>Concept checks (quick self-test)</h3>
      <ul>
        <li><b>Q:</b> Why can <span style="font-family:var(--mono)">|k|</span> vary while <span style="font-family:var(--mono)">β</span> stays constant?
          <br><b>A:</b> Because <span style="font-family:var(--mono)">|k| = n(r)k0</span> depends on r, but z-translation symmetry conserves the z-component.</li>
        <li><b>Q:</b> What defines the turning point?
          <br><b>A:</b> <span style="font-family:var(--mono)">kr = 0</span> ⇒ <span style="font-family:var(--mono)">β = n(rmax)k0</span>.</li>
        <li><b>Q:</b> What happens if &Delta;→0?
          <br><b>A:</b> No index gradient ⇒ no focusing ⇒ <span style="font-family:var(--mono)">g→0</span> and rays become straight lines.</li>
        <li><b>Q:</b> Why is p=2 special?
          <br><b>A:</b> It makes the restoring “bending” proportional to r, producing an exact harmonic oscillator (sinusoidal rays).</li>
      </ul>
    </section>

    <section id="p5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <div class="vizWrap">
        <div class="vizCard">
          <h3 style="margin:0 0 8px;">Diagram: GRIN core + sinusoidal meridional ray</h3>
          <figure>
            <canvas id="cDiagram" class="canvasBox" aria-label="Fiber diagram canvas"></canvas>
          </figure>
          <p class="small">
            The shaded core indicates higher index at the center and lower index near the edge (parabolic in <span style="font-family:var(--mono)">n^2</span>).
            The ray oscillates between <span style="font-family:var(--mono)">±rmax</span> as it propagates along z.
          </p>
        </div>

        <div class="vizCard">
          <h3 style="margin:0 0 8px;">Main plot: ray trajectory r(z)</h3>
          <figure>
            <canvas id="cMain" class="canvasBox" aria-label="Main plot canvas"></canvas>
          </figure>

          <h3 style="margin:14px 0 8px;">Secondary plot: wavevector components</h3>
          <figure>
            <canvas id="cSecondary" class="canvasBox short" aria-label="Secondary plot canvas"></canvas>
          </figure>

          <div class="controls">
            <div class="control">
              <label for="rmaxSlider">Max excursion: r<sub>max</sub>/a</label>
              <input id="rmaxSlider" type="range" min="0.05" max="0.95" step="0.01" value="0.60"/>
              <div class="small"><span id="rmaxRead">0.60</span></div>
            </div>

            <div class="control">
              <label for="deltaSelect">Relative index difference Δ (example)</label>
              <select id="deltaSelect">
                <option value="0.003">0.003</option>
                <option value="0.006">0.006</option>
                <option value="0.010" selected>0.010</option>
                <option value="0.015">0.015</option>
                <option value="0.020">0.020</option>
              </select>
              <div class="small">Changes focusing strength (g ∝ √Δ)</div>
            </div>

            <div class="control">
              <label for="resetBtn">Actions</label>
              <button id="resetBtn" type="button">Reset to defaults</button>
              <div class="small">Updates all canvases live</div>
            </div>
          </div>

          <div class="kpi" aria-label="Computed values">
            <div class="box">
              <b>&beta; / (n1 k0)</b>
              <div id="kpiBetaNorm" class="small">—</div>
            </div>
            <div class="box">
              <b>Pitch Z<sub>p</sub></b>
              <div id="kpiPitch" class="small">—</div>
            </div>
            <div class="box">
              <b>g (1/m)</b>
              <div id="kpiG" class="small">—</div>
            </div>
          </div>

          <p class="small" style="margin-top:10px;">
            <b>Example values used for plotting:</b> n1 = 1.48, a = 25 μm, λ = 1.55 μm.
            The solution formulas remain symbolic; these numbers only set plot scales.
          </p>
        </div>
      </div>

      <div class="callout">
        <b>Interactive controls:</b>
        <ul>
          <li><b>r<sub>max</sub>/a slider</b> changes how far the ray reaches into lower index. This updates:
            (i) &beta; via <span style="font-family:var(--mono)">β = n(rmax)k0</span>,
            (ii) the oscillation rate <span style="font-family:var(--mono)">g</span>,
            (iii) the plotted trajectory <span style="font-family:var(--mono)">r(z)</span> and wavevector component <span style="font-family:var(--mono)">kr(z)</span>.</li>
          <li><b>Δ selector</b> changes the focusing strength. Larger Δ → shorter pitch and larger curvature in the trajectory plot.</li>
        </ul>
      </div>
    </section>
  </article>
</main>

<footer>
  <p>
    Notes: This article uses the geometrical-optics (ray/eikonal) picture appropriate when the index varies slowly on the wavelength scale.
    For full modal (LP) analysis in a parabolic GRIN fiber, one solves the wave equation and obtains mode families with nearly equal group delays—one
    reason parabolic GRIN reduces intermodal dispersion.
  </p>
</footer>

<script>
/* ---------- Copy buttons (plain text) ---------- */
(function(){
  function copyText(text){
    navigator.clipboard.writeText(text).then(()=>{
      // tiny, non-intrusive feedback: flash outline
    }).catch(()=>{});
  }
  document.querySelectorAll('.copyBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-copy-btn');
      const el = document.getElementById(id);
      if(el) copyText(el.textContent.trim());
      btn.textContent = "Copied";
      setTimeout(()=>btn.textContent="Copy", 900);
    });
  });
})();

/* ---------- Canvas utilities ---------- */
function setupCanvas(canvas){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(2, Math.floor(rect.width));
  const h = Math.max(2, Math.floor(rect.height));
  canvas.width = Math.floor(w * dpr);
  canvas.height = Math.floor(h * dpr);
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  return {ctx, w, h, dpr};
}
function clear(ctx, w, h){
  ctx.clearRect(0,0,w,h);
}

/* ---------- Plot primitives (axes, grid, ticks) ---------- */
function drawAxes(ctx, box, xLabel, yLabel, title){
  const {x,y,w,h, padL, padR, padT, padB} = box;
  // Title
  ctx.save();
  ctx.fillStyle = 'rgba(234,240,255,0.95)';
  ctx.font = '600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText(title, x + padL, y + 18);
  ctx.restore();

  // Axes box
  ctx.save();
  ctx.strokeStyle = 'rgba(184,196,255,0.22)';
  ctx.lineWidth = 1;
  ctx.strokeRect(x+padL, y+padT, w-padL-padR, h-padT-padB);
  ctx.restore();

  // Labels
  ctx.save();
  ctx.fillStyle = 'rgba(184,196,255,0.85)';
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText(xLabel, x + w - padR - ctx.measureText(xLabel).width, y + h - 8);
  // y label rotated
  ctx.translate(x + 12, y + padT + (h-padT-padB)/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, 0, 0);
  ctx.restore();
}

function drawGridTicks(ctx, box, xMin, xMax, yMin, yMax, nx=6, ny=5){
  const {x,y,w,h,padL,padR,padT,padB} = box;
  const X0 = x+padL, Y0=y+padT, W=w-padL-padR, H=h-padT-padB;

  ctx.save();
  ctx.strokeStyle = 'rgba(184,196,255,0.10)';
  ctx.lineWidth = 1;

  // vertical grid + x ticks
  for(let i=0;i<=nx;i++){
    const t=i/nx;
    const X = X0 + t*W;
    ctx.beginPath();
    ctx.moveTo(X, Y0);
    ctx.lineTo(X, Y0+H);
    ctx.stroke();

    const val = xMin + t*(xMax-xMin);
    const s = formatSI(val);
    ctx.fillStyle = 'rgba(184,196,255,0.75)';
    ctx.font = '11px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    const tw = ctx.measureText(s).width;
    ctx.fillText(s, X - tw/2, Y0+H+16);
    // tick
    ctx.strokeStyle = 'rgba(184,196,255,0.18)';
    ctx.beginPath();
    ctx.moveTo(X, Y0+H);
    ctx.lineTo(X, Y0+H+4);
    ctx.stroke();
    ctx.strokeStyle = 'rgba(184,196,255,0.10)';
  }

  // horizontal grid + y ticks
  for(let j=0;j<=ny;j++){
    const t=j/ny;
    const Y = Y0 + (1-t)*H;
    ctx.beginPath();
    ctx.moveTo(X0, Y);
    ctx.lineTo(X0+W, Y);
    ctx.stroke();

    const val = yMin + t*(yMax-yMin);
    const s = formatSI(val);
    ctx.fillStyle = 'rgba(184,196,255,0.75)';
    ctx.font = '11px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    const tw = ctx.measureText(s).width;
    ctx.fillText(s, X0 - 8 - tw, Y + 4);
    // tick
    ctx.strokeStyle = 'rgba(184,196,255,0.18)';
    ctx.beginPath();
    ctx.moveTo(X0-4, Y);
    ctx.lineTo(X0, Y);
    ctx.stroke();
    ctx.strokeStyle = 'rgba(184,196,255,0.10)';
  }
  ctx.restore();
}

function mapX(box, xVal, xMin, xMax){
  const X0 = box.x+box.padL, W=box.w-box.padL-box.padR;
  return X0 + (xVal-xMin)/(xMax-xMin)*W;
}
function mapY(box, yVal, yMin, yMax){
  const Y0 = box.y+box.padT, H=box.h-box.padT-box.padB;
  return Y0 + (1-(yVal-yMin)/(yMax-yMin))*H;
}

function legend(ctx, x, y, items){
  ctx.save();
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillStyle = 'rgba(234,240,255,0.92)';
  ctx.strokeStyle = 'rgba(184,196,255,0.18)';
  ctx.lineWidth = 1;
  // background
  const pad=8, lineH=18;
  let w=0;
  items.forEach(it=>{ w=Math.max(w, ctx.measureText(it.label).width); });
  const boxW = w + 44, boxH = items.length*lineH + pad*2;
  ctx.fillStyle = 'rgba(7,10,20,0.55)';
  ctx.fillRect(x, y, boxW, boxH);
  ctx.strokeRect(x, y, boxW, boxH);

  // items
  items.forEach((it, i)=>{
    const yy = y + pad + i*lineH + 12;
    ctx.strokeStyle = it.color;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x+10, yy-4);
    ctx.lineTo(x+30, yy-4);
    ctx.stroke();
    ctx.fillStyle = 'rgba(234,240,255,0.92)';
    ctx.fillText(it.label, x+36, yy);
  });
  ctx.restore();
}

/* ---------- Number formatting ---------- */
function formatSI(x){
  const ax = Math.abs(x);
  if(ax === 0) return "0";
  // prefer compact with powers for wide ranges
  if(ax >= 1e4 || ax < 1e-3){
    const p = Math.floor(Math.log10(ax));
    const m = x / Math.pow(10,p);
    return (m.toFixed(2)) + "e" + p;
  }
  // otherwise fixed-ish
  const places = ax < 1 ? 3 : ax < 10 ? 2 : ax < 100 ? 1 : 0;
  return x.toFixed(places);
}
function fmtMeters(x){
  const ax = Math.abs(x);
  if(ax >= 1e-2) return x.toFixed(3) + " m";
  if(ax >= 1e-5) return (x*1e3).toFixed(3) + " mm";
  if(ax >= 1e-8) return (x*1e6).toFixed(3) + " μm";
  return (x*1e9).toFixed(3) + " nm";
}

/* ---------- Physics model (example values for plotting) ---------- */
const ex = {
  n1: 1.48,
  a: 25e-6,
  lambda: 1.55e-6
};
function k0(){ return 2*Math.PI/ex.lambda; }

// n(r) inside core
function nOfR(r, Delta){
  const rr = r/ex.a;
  const inside = Math.max(0, 1 - 2*Delta*rr*rr);
  return ex.n1 * Math.sqrt(inside);
}
function betaFromRmax(rmax, Delta){
  return nOfR(rmax, Delta) * k0();
}
function gFromBeta(beta, Delta){
  return (ex.n1 * k0() / beta) * (Math.sqrt(2*Delta)/ex.a);
}

/* ---------- Render all canvases ---------- */
const cDiagram = document.getElementById('cDiagram');
const cMain = document.getElementById('cMain');
const cSecondary = document.getElementById('cSecondary');

function drawDiagram(params){
  const {rmax, Delta, beta, g, Zp} = params;
  const {ctx, w, h} = setupCanvas(cDiagram);
  clear(ctx, w, h);

  // Layout
  const pad = 14;
  const leftW = Math.min(260, Math.floor(w*0.42));
  const rightW = w - leftW - pad*3;
  const midY = h*0.52;

  // Title hint
  ctx.save();
  ctx.fillStyle = 'rgba(184,196,255,0.85)';
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText("Cross-section (index graded) + z-propagation view", pad, 18);
  ctx.restore();

  // ----- Cross-section (left) -----
  const cx = pad + leftW*0.48;
  const cy = midY;
  const R = Math.min(leftW*0.35, h*0.33);

  // radial gradient to suggest index: bright center -> darker edge
  const grad = ctx.createRadialGradient(cx, cy, 2, cx, cy, R);
  grad.addColorStop(0, 'rgba(124,214,255,0.35)');
  grad.addColorStop(0.65, 'rgba(124,214,255,0.14)');
  grad.addColorStop(1, 'rgba(184,196,255,0.08)');
  ctx.save();
  ctx.fillStyle = grad;
  ctx.strokeStyle = 'rgba(184,196,255,0.22)';
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.arc(cx, cy, R, 0, Math.PI*2);
  ctx.fill();
  ctx.stroke();

  // draw rmax ring
  const rR = R*(rmax/ex.a);
  ctx.strokeStyle = 'rgba(166,255,203,0.65)';
  ctx.setLineDash([6,5]);
  ctx.beginPath(); ctx.arc(cx, cy, rR, 0, Math.PI*2); ctx.stroke();
  ctx.setLineDash([]);

  // labels
  ctx.fillStyle = 'rgba(234,240,255,0.92)';
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText("core radius a", cx - 34, cy - R - 10);
  ctx.fillText("rmax", cx - 18, cy - rR - 10);

  // axis lines
  ctx.strokeStyle = 'rgba(184,196,255,0.18)';
  ctx.beginPath(); ctx.moveTo(cx-R-10, cy); ctx.lineTo(cx+R+10, cy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx, cy-R-10); ctx.lineTo(cx, cy+R+10); ctx.stroke();

  ctx.fillStyle = 'rgba(184,196,255,0.85)';
  ctx.fillText("r", cx+R+14, cy+4);
  ctx.fillText("x", cx+4, cy-R-14);
  ctx.restore();

  // ----- Longitudinal view (right): r(z) -----
  const x0 = pad*2 + leftW;
  const y0 = pad + 26;
  const boxW = rightW;
  const boxH = h - pad*2 - 34;

  // frame
  ctx.save();
  ctx.strokeStyle = 'rgba(184,196,255,0.18)';
  ctx.strokeRect(x0, y0, boxW, boxH);
  // centerline
  ctx.strokeStyle = 'rgba(184,196,255,0.14)';
  ctx.beginPath();
  ctx.moveTo(x0, y0+boxH/2);
  ctx.lineTo(x0+boxW, y0+boxH/2);
  ctx.stroke();

  // core boundary lines at ±a (scaled)
  ctx.strokeStyle = 'rgba(124,214,255,0.18)';
  ctx.setLineDash([5,5]);
  ctx.beginPath(); ctx.moveTo(x0, y0+boxH*0.12); ctx.lineTo(x0+boxW, y0+boxH*0.12); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x0, y0+boxH*0.88); ctx.lineTo(x0+boxW, y0+boxH*0.88); ctx.stroke();
  ctx.setLineDash([]);

  // draw ray: multiple periods
  const periods = 1.6;
  const zMax = periods*Zp;
  const Nz = 400;
  ctx.strokeStyle = 'rgba(166,255,203,0.85)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<=Nz;i++){
    const z = zMax * i/Nz;
    const rr = rmax*Math.sin(g*z);
    const X = x0 + (z/zMax)*boxW;
    // map rr in [-a,a] to [0.12..0.88] of box
    const Yn = (0.5 - 0.38*(rr/ex.a));
    const Y = y0 + Yn*boxH;
    if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  }
  ctx.stroke();

  // labels
  ctx.fillStyle = 'rgba(234,240,255,0.92)';
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText("z →", x0+boxW-32, y0+boxH-8);
  ctx.fillText("r", x0+6, y0+14);
  ctx.fillStyle = 'rgba(184,196,255,0.85)';
  ctx.fillText("±a (core edge)", x0+8, y0+boxH*0.10);
  ctx.fillText("axis", x0+8, y0+boxH/2 - 6);
  ctx.restore();

  // footer annotations
  ctx.save();
  ctx.fillStyle='rgba(184,196,255,0.88)';
  ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  const line1 = `Example: Δ=${Delta.toFixed(3)},  rmax/a=${(rmax/ex.a).toFixed(2)}`;
  const line2 = `β/(n1k0)=${(beta/(ex.n1*k0())).toFixed(4)},  Zp=${fmtMeters(Zp)}`;
  ctx.fillText(line1, pad, h-30);
  ctx.fillText(line2, pad, h-12);
  ctx.restore();
}

function drawMainPlot(params){
  const {rmax, Delta, beta, g, Zp} = params;
  const {ctx, w, h} = setupCanvas(cMain);
  clear(ctx, w, h);

  const box = {x:0,y:0,w,h,padL:56,padR:16,padT:30,padB:42};
  const periods = 3.0;
  const zMin = 0;
  const zMax = periods*Zp;

  // y-range in microns for readability (but we plot in meters, label in μm)
  const yMin = -ex.a;
  const yMax = +ex.a;

  drawAxes(ctx, box, "z (m)", "r (m)", "Ray trajectory in parabolic GRIN core: r(z)");
  drawGridTicks(ctx, box, zMin, zMax, yMin, yMax, 6, 6);

  // draw core edge lines ±a
  ctx.save();
  ctx.strokeStyle = 'rgba(124,214,255,0.22)';
  ctx.lineWidth = 1.5;
  const yA1 = mapY(box, ex.a, yMin, yMax);
  const yA2 = mapY(box, -ex.a, yMin, yMax);
  ctx.beginPath(); ctx.moveTo(box.x+box.padL, yA1); ctx.lineTo(box.x+box.w-box.padR, yA1); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(box.x+box.padL, yA2); ctx.lineTo(box.x+box.w-box.padR, yA2); ctx.stroke();
  ctx.fillStyle = 'rgba(124,214,255,0.75)';
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText("+a", box.x+box.padL+6, yA1-6);
  ctx.fillText("-a", box.x+box.padL+6, yA2+14);
  ctx.restore();

  // curve r(z)
  const N=700;
  ctx.save();
  ctx.strokeStyle = 'rgba(166,255,203,0.92)';
  ctx.lineWidth = 2.2;
  ctx.beginPath();
  for(let i=0;i<=N;i++){
    const z = zMin + (zMax-zMin)*i/N;
    const rr = rmax*Math.sin(g*z);
    const X = mapX(box, z, zMin, zMax);
    const Y = mapY(box, rr, yMin, yMax);
    if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  }
  ctx.stroke();
  ctx.restore();

  // show rmax bands
  ctx.save();
  ctx.setLineDash([7,6]);
  ctx.strokeStyle = 'rgba(184,196,255,0.20)';
  ctx.lineWidth = 1.2;
  const yR1 = mapY(box, rmax, yMin, yMax);
  const yR2 = mapY(box, -rmax, yMin, yMax);
  ctx.beginPath(); ctx.moveTo(box.x+box.padL, yR1); ctx.lineTo(box.x+box.w-box.padR, yR1); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(box.x+box.padL, yR2); ctx.lineTo(box.x+box.w-box.padR, yR2); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = 'rgba(184,196,255,0.75)';
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText("±rmax", box.x+box.w-box.padR-52, yR1-6);
  ctx.restore();

  legend(ctx, box.x+box.padL+10, box.y+box.padT+10, [
    {label:"r(z) = rmax sin(gz)", color:'rgba(166,255,203,0.92)'},
    {label:"core edges ±a", color:'rgba(124,214,255,0.22)'}
  ]);
}

function drawSecondaryPlot(params){
  const {rmax, Delta, beta, g, Zp} = params;
  const {ctx, w, h} = setupCanvas(cSecondary);
  clear(ctx, w, h);

  const box = {x:0,y:0,w,h,padL:56,padR:16,padT:30,padB:42};
  const periods = 2.0;
  const zMin = 0;
  const zMax = periods*Zp;

  // We plot normalized components: kr/(n1k0) and (n(r)k0)/(n1k0)=n(r)/n1
  // This keeps numbers ~O(1).
  const yMin = -0.9;
  const yMax = 1.1;

  drawAxes(ctx, box, "z (m)", "normalized", "Wavevector quantities along the ray");
  drawGridTicks(ctx, box, zMin, zMax, yMin, yMax, 6, 5);

  const N=650;
  const n1k0 = ex.n1*k0();

  // curve1: kr_norm(z) = kr/(n1k0) = (β g rmax / (n1k0)) cos(gz)
  // but β g = (n1 k0) * sqrt(2Δ)/a  (since g=(n1k0/β)*sqrt(2Δ)/a)
  // => β g rmax/(n1k0) = (sqrt(2Δ)/a) rmax   (nice cancellation!)
  const krAmpNorm = Math.sqrt(2*Delta) * (rmax/ex.a);

  // curve2: k_norm(z) = n(r)/n1 = sqrt(1 - 2Δ (r/a)^2)
  ctx.save();

  // k_norm
  ctx.strokeStyle = 'rgba(124,214,255,0.92)';
  ctx.lineWidth = 2.1;
  ctx.beginPath();
  for(let i=0;i<=N;i++){
    const z = zMin + (zMax-zMin)*i/N;
    const rr = rmax*Math.sin(g*z);
    const kNorm = Math.sqrt(Math.max(0, 1 - 2*Delta*(rr/ex.a)*(rr/ex.a)));
    const X = mapX(box, z, zMin, zMax);
    const Y = mapY(box, kNorm, yMin, yMax);
    if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  }
  ctx.stroke();

  // kr_norm
  ctx.strokeStyle = 'rgba(166,255,203,0.92)';
  ctx.lineWidth = 2.1;
  ctx.beginPath();
  for(let i=0;i<=N;i++){
    const z = zMin + (zMax-zMin)*i/N;
    const krNorm = krAmpNorm*Math.cos(g*z); // sign swings naturally
    const X = mapX(box, z, zMin, zMax);
    const Y = mapY(box, krNorm, yMin, yMax);
    if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  }
  ctx.stroke();

  // beta_norm constant line
  const betaNorm = beta/(n1k0);
  ctx.strokeStyle = 'rgba(255,210,124,0.88)';
  ctx.lineWidth = 1.8;
  ctx.setLineDash([6,5]);
  ctx.beginPath();
  ctx.moveTo(box.x+box.padL, mapY(box, betaNorm, yMin, yMax));
  ctx.lineTo(box.x+box.w-box.padR, mapY(box, betaNorm, yMin, yMax));
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.restore();

  legend(ctx, box.x+box.padL+10, box.y+box.padT+10, [
    {label:"k/(n1k0) = n(r)/n1", color:'rgba(124,214,255,0.92)'},
    {label:"kr/(n1k0)", color:'rgba(166,255,203,0.92)'},
    {label:"β/(n1k0) (const)", color:'rgba(255,210,124,0.88)'}
  ]);
}

/* ---------- Orchestrate updates ---------- */
const rmaxSlider = document.getElementById('rmaxSlider');
const deltaSelect = document.getElementById('deltaSelect');
const rmaxRead = document.getElementById('rmaxRead');
const resetBtn = document.getElementById('resetBtn');

const kpiBetaNorm = document.getElementById('kpiBetaNorm');
const kpiPitch = document.getElementById('kpiPitch');
const kpiG = document.getElementById('kpiG');

function computeParams(){
  const rmaxFrac = parseFloat(rmaxSlider.value);
  const Delta = parseFloat(deltaSelect.value);
  const rmax = rmaxFrac * ex.a;

  const beta = betaFromRmax(rmax, Delta);
  const g = gFromBeta(beta, Delta);
  const Zp = 2*Math.PI / g;

  return {rmaxFrac, rmax, Delta, beta, g, Zp};
}

function updateAll(){
  const p = computeParams();
  rmaxRead.textContent = p.rmaxFrac.toFixed(2);

  // KPIs
  const betaNorm = p.beta/(ex.n1*k0());
  kpiBetaNorm.textContent = betaNorm.toFixed(5);
  kpiPitch.textContent = fmtMeters(p.Zp);
  kpiG.textContent = p.g.toExponential(3);

  // Draw
  drawDiagram(p);
  drawMainPlot(p);
  drawSecondaryPlot(p);
}

rmaxSlider.addEventListener('input', updateAll);
deltaSelect.addEventListener('change', updateAll);
resetBtn.addEventListener('click', ()=>{
  rmaxSlider.value = "0.60";
  deltaSelect.value = "0.010";
  updateAll();
});

// Resize handling (responsive + crisp)
let resizeTimer = null;
window.addEventListener('resize', ()=>{
  if(resizeTimer) cancelAnimationFrame(resizeTimer);
  resizeTimer = requestAnimationFrame(updateAll);
});

// Initial render
updateAll();
</script>
</body>
</html>
