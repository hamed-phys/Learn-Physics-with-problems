<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GaAs/AlAs Quarter-Wave Bragg Grating Reflector — Reflectance & Transmittance vs Number of Periods</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#e9eefc;
      --muted:#b9c2e6;
      --faint:#92a0d6;
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#7CFFB2;
      --warn:#ffd27a;
      --bad:#ff6b8a;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.16);
      --shadow: 0 16px 50px rgba(0,0,0,.38);
      --radius: 18px;
      --radius2: 26px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 15% 8%, rgba(110,231,255,.14), transparent 60%),
        radial-gradient(700px 500px at 85% 18%, rgba(167,139,250,.14), transparent 60%),
        radial-gradient(900px 700px at 55% 90%, rgba(124,255,178,.09), transparent 60%),
        linear-gradient(180deg, var(--bg), #070a14 70%);
      line-height:1.55;
    }

    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    code, pre{ font-family:var(--mono); }
    h1,h2,h3{ line-height:1.15; letter-spacing:-0.01em; }
    h1{ font-size: clamp(1.8rem, 2.9vw, 3rem); margin:0 0 0.5rem 0; }
    h2{ font-size: clamp(1.3rem, 2.2vw, 2rem); margin:1.2rem 0 0.7rem; }
    h3{ font-size: clamp(1.05rem, 1.5vw, 1.25rem); margin:1.0rem 0 .5rem; color: var(--text); }
    p{ margin: .65rem 0; color: var(--muted); }
    ul{ margin:.55rem 0 .8rem 1.2rem; color: var(--muted); }
    li{ margin:.22rem 0; }

    header{
      padding: 28px 18px 18px;
      max-width: 1180px;
      margin: 0 auto;
    }
    .sub{
      color: var(--faint);
      max-width: 85ch;
    }

    .layout{
      max-width:1180px;
      margin: 0 auto;
      padding: 0 18px 60px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 18px;
      align-items:start;
    }

    nav.toc{
      position: sticky;
      top: 14px;
      align-self:start;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    nav.toc .title{
      font-weight: 700;
      letter-spacing: .02em;
      font-size: .95rem;
      color: var(--text);
      display:flex;
      align-items:center;
      gap:10px;
      margin-bottom: 10px;
    }
    nav.toc .dot{
      width:10px; height:10px; border-radius:99px;
      background: conic-gradient(from 180deg, var(--accent), var(--accent2), var(--good), var(--accent));
      box-shadow: 0 0 0 4px rgba(110,231,255,.12);
    }
    nav.toc a{
      display:block;
      padding: 8px 10px;
      border-radius: 12px;
      color: var(--muted);
      border: 1px solid transparent;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size: .92rem;
    }
    nav.toc a:hover{
      background: rgba(110,231,255,.10);
      border-color: rgba(110,231,255,.18);
      transform: translateX(2px);
    }
    nav.toc a.active{
      background: rgba(167,139,250,.12);
      border-color: rgba(167,139,250,.22);
      color: var(--text);
    }

    main{
      min-width: 0;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      padding: 18px 18px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 14px;
      align-items:stretch;
    }

    .callout{
      border-radius: 18px;
      border: 1px solid var(--line2);
      background: linear-gradient(180deg, rgba(17,26,51,.85), rgba(15,23,48,.65));
      padding: 12px 12px 10px;
      margin: 10px 0;
    }
    .callout h4{
      margin:0 0 6px 0;
      font-size: .95rem;
      color: var(--text);
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 4px 10px;
      border-radius:999px;
      font-size:.78rem;
      letter-spacing:.02em;
      border:1px solid var(--line2);
      color: var(--text);
      background: rgba(255,255,255,.05);
      white-space: nowrap;
    }
    .b-assume{ border-color: rgba(255,210,122,.35); background: rgba(255,210,122,.10); }
    .b-eq{ border-color: rgba(110,231,255,.35); background: rgba(110,231,255,.10); }
    .b-mist{ border-color: rgba(255,107,138,.35); background: rgba(255,107,138,.10); }
    .b-final{ border-color: rgba(124,255,178,.38); background: rgba(124,255,178,.10); }

    .eqbox{
      position:relative;
      padding: 12px 12px 12px;
      border-radius: 16px;
      border: 1px solid rgba(110,231,255,.25);
      background: rgba(110,231,255,.07);
      overflow:hidden;
      margin: 10px 0 12px;
    }
    .eqbox pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      color: var(--text);
      font-size: .93rem;
      line-height:1.5;
    }
    .copyBtn{
      position:absolute;
      top:10px;
      right:10px;
      border: 1px solid var(--line2);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 7px 10px;
      font-size: .82rem;
      cursor:pointer;
      transition: transform .10s ease, background .10s ease, border-color .10s ease;
      user-select:none;
    }
    .copyBtn:hover{ background: rgba(255,255,255,.10); transform: translateY(-1px); }
    .copyBtn:active{ transform: translateY(0px) scale(.98); }

    .viz{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .vizRow{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 12px;
      align-items:stretch;
    }

    figure{
      margin:0;
      border-radius: 18px;
      border: 1px solid var(--line);
      background: rgba(0,0,0,.16);
      overflow:hidden;
      position:relative;
    }
    figcaption{
      padding: 10px 12px 12px;
      color: var(--faint);
      font-size: .92rem;
      border-top: 1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    canvas{ display:block; width:100%; height:340px; }
    .small canvas{ height:280px; }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .9fr .9fr;
      gap: 10px;
      margin-top: 10px;
    }
    .ctrl{
      border-radius: 16px;
      border: 1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding: 10px 10px 9px;
    }
    .ctrl label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      font-size: .86rem;
      color: var(--muted);
      gap: 10px;
      margin-bottom: 7px;
    }
    .ctrl .val{
      font-family: var(--mono);
      color: var(--text);
      font-size: .85rem;
    }
    input[type="range"]{ width:100%; }
    select{
      width:100%;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid var(--line2);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline: none;
    }

    .twoCols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .muted{ color: var(--muted); }
    .tiny{ font-size:.92rem; color: var(--faint); }

    footer{
      max-width:1180px;
      margin: 0 auto;
      padding: 16px 18px 46px;
      color: var(--faint);
    }

    /* subtle animation */
    .fadeIn{
      animation: fadeUp .45s ease both;
    }
    @keyframes fadeUp{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* responsive */
    @media (max-width: 980px){
      .layout{ grid-template-columns: 1fr; }
      nav.toc{ position:relative; top:0; }
      .grid2{ grid-template-columns: 1fr; }
      .vizRow{ grid-template-columns: 1fr; }
      .controls{ grid-template-columns: 1fr; }
      canvas{ height:320px; }
      .small canvas{ height:280px; }
    }

    /* print-friendly */
    @media print{
      body{ background:#fff; color:#000; }
      nav.toc{ display:none; }
      .card, figure, .callout, .eqbox{ box-shadow:none; backdrop-filter:none; }
      .card{ border:1px solid #ddd; background:#fff; }
      figure{ border:1px solid #ddd; background:#fff; }
      .copyBtn{ display:none; }
      a{ color:#000; text-decoration:none; }
      p, ul{ color:#111; }
      header .sub{ color:#333; }
      figcaption{ color:#333; background:#fff; }
    }
  </style>
</head>
<body>
<header class="fadeIn">
  <h1>7.1-8 — GaAs/AlAs Quarter-Wave Bragg Grating Reflector</h1>
  <p class="sub">
    A distributed Bragg reflector (DBR) made from alternating GaAs (<span class="muted">n<sub>1</sub>=3.57</span>) and AlAs
    (<span class="muted">n<sub>2</sub>=2.94</span>) quarter-wave layers, embedded in an extended GaAs medium.
    We calculate and plot <strong>reflectance</strong> <span class="muted">(R)</span> and <strong>transmittance</strong>
    <span class="muted">(T)</span> versus number of periods <span class="muted">N</span> at the <strong>Bragg frequency</strong>.
  </p>
</header>

<div class="layout">
  <nav class="toc" aria-label="Table of contents">
    <div class="title"><span class="dot"></span> Table of Contents</div>
    <a href="#quick" class="toclink">Quick Summary</a>
    <a href="#part0" class="toclink">PART 0 — Concept Primer</a>
    <a href="#part1" class="toclink">PART 1 — Problem Analysis</a>
    <a href="#part2" class="toclink">PART 2 — Strategy & Tips</a>
    <a href="#part3" class="toclink">PART 3 — Full Solution</a>
    <a href="#part4" class="toclink">PART 4 — Deeper Understanding</a>
    <a href="#part5" class="toclink">PART 5 — Visualization Guide</a>
  </nav>

  <main>
    <section id="quick" class="card fadeIn">
      <h2>Quick Summary</h2>
      <ul>
        <li>This problem is about a <strong>1D periodic dielectric mirror</strong> (GaAs/AlAs) built from <strong>quarter-wave layers</strong>.</li>
        <li>Key physics: <strong>multiple reflections add in phase</strong> at the Bragg frequency, giving a strong stopband (high R).</li>
        <li>At normal incidence, we model the stack using the <strong>transfer (characteristic) matrix</strong> of each layer.</li>
        <li>Quarter-wave condition at design wavelength <span class="muted">λ<sub>B</sub></span>: <span class="muted">n<sub>i</sub>d<sub>i</sub>=λ<sub>B</sub>/4</span>, so the phase thickness is <span class="muted">δ<sub>i</sub>=π/2</span>.</li>
        <li>Governing relations (normal incidence, nonmagnetic): layer matrix <span class="muted">M<sub>i</sub></span>, total matrix <span class="muted">M</span>, then
          <span class="muted">r</span>, <span class="muted">t</span> from boundary admittances.</li>
        <li>Output type: <strong>numeric R(N), T(N)</strong> for <span class="muted">N=1…10</span> (and an interactive spectrum as a bonus).</li>
        <li>Main result: <strong>R increases rapidly with N</strong> at Bragg; <strong>T decreases</strong> (with negligible absorption, <span class="muted">R+T≈1</span>).</li>
      </ul>
    </section>

    <section id="part0" class="card fadeIn" style="margin-top:14px;">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <article>
        <h3>Core definitions</h3>
        <ul>
          <li><strong>Refractive index</strong> <span class="muted">n</span> (unitless): relates phase velocity <span class="muted">v=c/n</span>.</li>
          <li><strong>Wavelength in medium</strong> <span class="muted">λ<sub>i</sub>=λ<sub>0</sub>/n<sub>i</sub></span> (m).</li>
          <li><strong>Optical thickness</strong> <span class="muted">n d</span> (m): controls accumulated phase.</li>
          <li><strong>Phase thickness</strong> <span class="muted">δ = (2π/λ) n d</span> (radians): phase accrued across a layer at wavelength <span class="muted">λ</span>.</li>
          <li><strong>Reflectance</strong> <span class="muted">R=|r|²</span> and <strong>Transmittance</strong> <span class="muted">T</span> are power ratios (unitless).</li>
        </ul>

        <h3>Physical meaning of the key quantities</h3>
        <ul>
          <li><span class="muted">r</span> is the complex <em>field</em> reflection coefficient: includes both magnitude and phase.</li>
          <li><span class="muted">R</span> is the fraction of incident <em>power</em> reflected. In lossless stacks: <span class="muted">R+T=1</span>.</li>
          <li><span class="muted">N</span> counts the number of repeated high/low index units (periods). Larger <span class="muted">N</span> means more coherent partial reflections.</li>
        </ul>

        <div class="callout">
          <h4><span class="badge b-eq">Key Idea</span> Why quarter-wave layers make a mirror</h4>
          <p>
            At the Bragg (design) wavelength, each layer adds a phase of <span class="muted">π/2</span>.
            Reflections from successive interfaces return with phases that line up so they <strong>add constructively</strong> in reflection
            and <strong>cancel in transmission</strong> (stopband behavior).
          </p>
        </div>

        <h3>Key laws/principles and validity</h3>
        <ul>
          <li><strong>Maxwell boundary conditions</strong>: tangential <span class="muted">E</span> and <span class="muted">H</span> are continuous at each interface (valid for linear media).</li>
          <li><strong>Transfer matrix method</strong>: exact for stratified, planar layers (1D inhomogeneity), assuming:
            <ul>
              <li>plane wave incidence,</li>
              <li>linear, isotropic, nonmagnetic media (μ≈μ<sub>0</sub>),</li>
              <li>no absorption unless explicitly included (here we treat as lossless).</li>
            </ul>
          </li>
          <li><strong>Normal incidence</strong> (implicit unless stated otherwise): TE and TM behave identically.</li>
        </ul>

        <h3>Common models/approximations and why we use them</h3>
        <ul>
          <li><strong>Lossless dielectrics</strong>: GaAs/AlAs are treated as real indices → simplifies to <span class="muted">R+T=1</span>.</li>
          <li><strong>Design wavelength / Bragg frequency</strong>: evaluate at the wavelength that makes each layer quarter-wave → produces closed-form simplifications (phase <span class="muted">π/2</span>).</li>
          <li><strong>Periodic unit cell</strong>: repeating pairs lets us study how reflectivity scales with <span class="muted">N</span>.</li>
        </ul>

        <h3>Mini intuition examples</h3>
        <ul>
          <li><strong>Example A (single interface)</strong>: One GaAs/AlAs boundary reflects only modestly because the index contrast is finite.</li>
          <li><strong>Example B (many interfaces)</strong>: In a DBR, each interface reflects a little, but at Bragg all those “little” reflections are phase-aligned → the net reflection becomes large.</li>
        </ul>

        <div class="callout">
          <h4><span class="badge b-mist">What to watch for</span> Typical pitfalls</h4>
          <ul>
            <li>Mixing up <span class="muted">λ</span> in vacuum vs. in the material (quarter-wave uses <span class="muted">λ/n</span> inside each layer).</li>
            <li>Using the wrong boundary formula for <span class="muted">r</span>, <span class="muted">t</span> from the total matrix.</li>
            <li>Forgetting that the stack is embedded in GaAs: incident medium and substrate are both <span class="muted">n<sub>1</sub></span>.</li>
            <li>Confusing field transmission amplitude <span class="muted">t</span> with power transmittance <span class="muted">T</span>.</li>
          </ul>
        </div>
      </article>
    </section>

    <section id="part1" class="card fadeIn" style="margin-top:14px;">
      <h2>PART 1 — Problem Analysis (No solving yet)</h2>

      <article>
        <h3>Restate the problem (in plain words)</h3>
        <p>
          We have a multilayer Bragg reflector consisting of <span class="muted">N</span> repeated units of alternating GaAs and AlAs layers.
          Each layer is a quarter wavelength thick at the Bragg frequency. The entire stack sits inside GaAs (same index as GaAs layers).
          We must compute and plot the <strong>reflectance</strong> <span class="muted">R</span> and <strong>transmittance</strong> <span class="muted">T</span> as functions of <span class="muted">N</span>
          for <span class="muted">N=1,2,…,10</span>, evaluated at the Bragg frequency.
        </p>

        <h3>Given quantities</h3>
        <ul>
          <li>GaAs refractive index: <span class="muted">n<sub>1</sub> = 3.57</span></li>
          <li>AlAs refractive index: <span class="muted">n<sub>2</sub> = 2.94</span></li>
          <li>Quarter-wave thicknesses at Bragg wavelength <span class="muted">λ<sub>B</sub></span>:
            <span class="muted">d<sub>1</sub>=λ<sub>B</sub>/(4n<sub>1</sub>)</span>, <span class="muted">d<sub>2</sub>=λ<sub>B</sub>/(4n<sub>2</sub>)</span>
          </li>
          <li>Incident and substrate medium: extended GaAs ⇒ <span class="muted">n<sub>0</sub>=n<sub>s</sub>=n<sub>1</sub></span></li>
          <li>Evaluate at Bragg frequency (equivalently, at <span class="muted">λ=λ<sub>B</sub></span>)</li>
        </ul>

        <h3>Unknowns / what to find</h3>
        <ul>
          <li>Reflectance <span class="muted">R(N)</span> at <span class="muted">λ=λ<sub>B</sub></span> for <span class="muted">N=1…10</span></li>
          <li>Transmittance <span class="muted">T(N)</span> at <span class="muted">λ=λ<sub>B</sub></span> for <span class="muted">N=1…10</span></li>
          <li>Plots of these quantities vs <span class="muted">N</span></li>
        </ul>

        <h3>Relevant principles (and why they apply)</h3>
        <ul>
          <li><strong>1D multilayer interference</strong>: the structure is stratified along one axis, so the transfer matrix method is the natural exact tool.</li>
          <li><strong>Quarter-wave Bragg condition</strong>: ensures constructive interference of reflected waves at the design frequency.</li>
          <li><strong>Energy conservation</strong>: with real indices (no loss), <span class="muted">R+T=1</span> provides a sanity check.</li>
        </ul>

        <div class="callout">
          <h4><span class="badge b-assume">Assumptions</span></h4>
          <ul>
            <li>Normal incidence (no angle specified) ⇒ TE and TM identical.</li>
            <li>Lossless, nonmagnetic layers (μ≈μ<sub>0</sub>), refractive indices real.</li>
            <li>Perfectly flat, infinite planar layers ⇒ no scattering, only coherent interference.</li>
            <li>Bragg frequency means we set <span class="muted">λ = λ<sub>B</sub></span>, so each layer has phase thickness <span class="muted">δ=π/2</span>.</li>
          </ul>
        </div>

        <h3>Possible approaches (compare 2–3)</h3>
        <ul>
          <li><strong>(A) Transfer matrix method</strong> (exact): multiply layer matrices, compute <span class="muted">r,t</span>. <em>Best for numeric R(N), T(N) and plotting.</em></li>
          <li><strong>(B) Coupled-mode / Bloch-wave theory</strong>: elegant for bandgaps and stopband width; gives scaling insight but more abstract for a finite stack.</li>
          <li><strong>(C) Recursive Fresnel reflection</strong>: build the effective reflection iteratively; intuitive but algebra gets messy for many layers unless coded.</li>
        </ul>

        <p>
          <strong>Chosen approach:</strong> (A) the transfer matrix method, because it is exact, systematic,
          and directly produces <span class="muted">R</span> and <span class="muted">T</span> for each finite <span class="muted">N</span> (perfect for plotting).
        </p>
      </article>
    </section>

    <section id="part2" class="card fadeIn" style="margin-top:14px;">
      <h2>PART 2 — Strategy & Tips (Roadmap only)</h2>

      <article>
        <ol class="muted">
          <li><strong>Set the design condition</strong>: at Bragg, enforce quarter-wave thickness so <span class="muted">δ<sub>1</sub>=δ<sub>2</sub>=π/2</span>.
            <br><span class="tiny">Tool: phase thickness formula <span class="muted">δ=(2π/λ)nd</span>. Meaning: each layer advances phase by 90°.</span>
          </li>
          <li><strong>Write each layer’s characteristic matrix</strong> at normal incidence using admittance <span class="muted">y=n</span>.
            <br><span class="tiny">Tool: standard thin-film transfer matrix. Meaning: maps (E,H) across a layer.</span>
          </li>
          <li><strong>Multiply matrices for the full stack</strong> for a chosen ordering and number of periods <span class="muted">N</span>.
            <br><span class="tiny">Tool: matrix multiplication. Meaning: accounts for multiple internal reflections exactly.</span>
          </li>
          <li><strong>Convert the total matrix into</strong> <span class="muted">r</span> and <span class="muted">t</span> using boundary admittances
            <span class="muted">y<sub>0</sub>=y<sub>s</sub>=n<sub>1</sub></span>.
            <br><span class="tiny">Tool: boundary formula for multilayers. Meaning: net reflection/transmission at the entrance.</span>
          </li>
          <li><strong>Compute</strong> <span class="muted">R=|r|²</span> and <span class="muted">T=(y<sub>s</sub>/y<sub>0</sub>)|t|²</span> (here equals <span class="muted">|t|²</span>).
            <br><span class="tiny">Meaning: convert field coefficients to power fractions.</span>
          </li>
          <li><strong>Repeat for</strong> <span class="muted">N=1…10</span>, tabulate and plot <span class="muted">R(N),T(N)</span>.
            <br><span class="tiny">Meaning: see how the mirror “builds up” with more periods.</span>
          </li>
          <li><strong>Sanity checks</strong>: verify <span class="muted">0≤R,T≤1</span> and <span class="muted">R+T≈1</span>.
            <br><span class="tiny">Meaning: energy conservation in lossless media.</span>
          </li>
        </ol>

        <div class="callout">
          <h4><span class="badge b-mist">Common mistakes</span></h4>
          <ul>
            <li>Using <span class="muted">T=|t|²</span> without the <span class="muted">(y<sub>s</sub>/y<sub>0</sub>)</span> factor when incident/substrate indices differ.</li>
            <li>Forgetting that “Bragg frequency” implies <span class="muted">δ=π/2</span> only at <span class="muted">λ=λ<sub>B</sub></span>.</li>
            <li>Layer ordering: starting with GaAs (same as ambient) is physically different than starting with AlAs (first interface matters).</li>
          </ul>
        </div>
      </article>
    </section>

    <section id="part3" class="card fadeIn" style="margin-top:14px;">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <article>
        <h3>Qualitative expectation (before math)</h3>
        <p>
          Each GaAs/AlAs interface reflects a small portion of the wave because <span class="muted">n<sub>1</sub>≠n<sub>2</sub></span>.
          At the Bragg wavelength, the quarter-wave thickness makes reflections from successive interfaces return to the entrance
          with phases that line up, so the reflected waves add constructively. Therefore, we expect:
        </p>
        <ul>
          <li><span class="muted">R(N)</span> increases rapidly with <span class="muted">N</span> (approaching near-unity for enough periods).</li>
          <li><span class="muted">T(N)</span> decreases correspondingly; for lossless media, <span class="muted">T=1-R</span>.</li>
        </ul>

        <h3>Step 1 — Quarter-wave condition ⇒ phase thickness</h3>
        <p>
          At a wavelength <span class="muted">λ</span>, the phase thickness of layer <span class="muted">i</span> is
        </p>

        <div class="eqbox" id="eq1">
          <button class="copyBtn" data-copy="eq1">Copy</button>
          <pre>δ_i = (2π/λ) n_i d_i   (radians)</pre>
        </div>

        <p>
          At the Bragg (design) wavelength <span class="muted">λ=λ_B</span>, each layer is quarter-wave in its own medium:
          <span class="muted">n_i d_i = λ_B/4</span>. Substituting:
        </p>

        <div class="eqbox" id="eq2">
          <button class="copyBtn" data-copy="eq2">Copy</button>
          <pre>δ_i = (2π/λ_B) (λ_B/4) = π/2   for both i = 1 (GaAs) and i = 2 (AlAs)</pre>
        </div>

        <p class="tiny">
          Meaning: each layer advances the field phase by 90° at the Bragg wavelength.
        </p>

        <h3>Step 2 — Layer transfer matrix at normal incidence</h3>
        <p>
          For a nonmagnetic dielectric layer at normal incidence, it is convenient to use the
          <strong>optical admittance</strong> <span class="muted">y_i</span>, which equals the refractive index:
          <span class="muted">y_i = n_i</span>. The characteristic matrix of layer <span class="muted">i</span> is
        </p>

        <div class="eqbox" id="eq3">
          <button class="copyBtn" data-copy="eq3">Copy</button>
          <pre>M_i =
[ cos δ_i           i sin δ_i / y_i ]
[ i y_i sin δ_i     cos δ_i         ]</pre>
        </div>

        <p>
          At Bragg, <span class="muted">δ_i=π/2</span>, so <span class="muted">cos δ_i=0</span>, <span class="muted">sin δ_i=1</span>. Therefore:
        </p>

        <div class="eqbox" id="eq4">
          <button class="copyBtn" data-copy="eq4">Copy</button>
          <pre>M_i(δ=π/2) =
[ 0           i / y_i ]
[ i y_i       0       ]</pre>
        </div>

        <p class="tiny">
          Meaning: a quarter-wave layer “swaps” electric and magnetic field roles up to admittance factors—this is what makes the stack strongly reflective when repeated.
        </p>

        <h3>Step 3 — Total matrix of an N-period stack</h3>
        <p>
          Choose an ordering of the two layers in one period (unit cell). A common DBR choice on a GaAs background is to start with
          the lower-index layer (AlAs), because it creates an immediate index step at the entrance.
          We will take one period as:
        </p>
        <div class="eqbox" id="eq5">
          <button class="copyBtn" data-copy="eq5">Copy</button>
          <pre>One period: (AlAs layer, n2) then (GaAs layer, n1)
M_period = M_1 · M_2   (note: multiplication order matches propagation from left to right)</pre>
        </div>

        <p class="tiny">
          In the interactive plots below, you can switch the starting layer to see that the first interface matters for finite N.
        </p>

        <p>
          The total matrix for <span class="muted">N</span> periods is:
        </p>
        <div class="eqbox" id="eq6">
          <button class="copyBtn" data-copy="eq6">Copy</button>
          <pre>M_total(N) = (M_period)^N</pre>
        </div>

        <h3>Step 4 — Convert total matrix to reflection and transmission</h3>
        <p>
          Let the incident medium admittance be <span class="muted">y0</span> and substrate admittance be <span class="muted">ys</span>.
          Here the grating is embedded in GaAs, so:
        </p>
        <div class="eqbox" id="eq7">
          <button class="copyBtn" data-copy="eq7">Copy</button>
          <pre>y0 = ys = n1 = 3.57</pre>
        </div>

        <p>
          If
          <span class="muted">M_total = [[A, B],[C, D]]</span>,
          then the field reflection and transmission coefficients at the entrance are:
        </p>

        <div class="eqbox" id="eq8">
          <button class="copyBtn" data-copy="eq8">Copy</button>
          <pre>r = ( y0 (A + B ys) - (C + D ys) ) / ( y0 (A + B ys) + (C + D ys) )

t = ( 2 y0 ) / ( y0 (A + B ys) + (C + D ys) )</pre>
        </div>

        <p>
          Power reflectance and transmittance are:
        </p>
        <div class="eqbox" id="eq9">
          <button class="copyBtn" data-copy="eq9">Copy</button>
          <pre>R = |r|^2
T = (ys/y0) |t|^2   → here ys=y0 so T = |t|^2</pre>
        </div>

        <h3>Step 5 — Evaluate for N = 1…10 at Bragg</h3>
        <p>
          Since the indices are given and <span class="muted">δ=π/2</span> at Bragg, the calculation is purely numerical for each <span class="muted">N</span>.
          The plots below show the resulting <span class="muted">R(N)</span> and <span class="muted">T(N)</span>.
        </p>

        <div class="callout">
          <h4><span class="badge b-final">Final Answer</span> What you should report</h4>
          <p class="muted">
            Compute <span class="muted">R(N), T(N)</span> for <span class="muted">N=1…10</span> using the transfer-matrix equations above at <span class="muted">λ=λ<sub>B</sub></span>
            (so each layer has <span class="muted">δ=π/2</span>). The stack is embedded in GaAs, so <span class="muted">y0=ys=n1</span>.
            The resulting curves show <strong>monotonic growth of R</strong> and <strong>monotonic decay of T</strong> with N, with <span class="muted">R+T≈1</span>.
          </p>
          <div class="eqbox" id="finalText">
            <button class="copyBtn" data-copy="finalText">Copy</button>
            <pre>At Bragg (λ=λB): δ1=δ2=π/2, y0=ys=n1.
For each N=1..10:
1) Build M_total(N) = Π layer matrices (quarter-wave).
2) r = ( y0(A + Bys) - (C + Dys) ) / ( y0(A + Bys) + (C + Dys) )
   t = (2y0) / ( y0(A + Bys) + (C + Dys) )
3) R(N)=|r|^2,  T(N)=|t|^2 (since ys=y0).
Plot R and T versus N.</pre>
          </div>
        </div>

        <h3>Sanity checks</h3>
        <ul>
          <li><strong>Units</strong>: <span class="muted">R</span>, <span class="muted">T</span> are dimensionless power ratios.</li>
          <li><strong>Bounds</strong>: the computation should return <span class="muted">0≤R≤1</span>, <span class="muted">0≤T≤1</span>.</li>
          <li><strong>Energy conservation</strong>: for real indices, <span class="muted">R+T≈1</span> for each <span class="muted">N</span>.</li>
          <li><strong>Limiting cases</strong>:
            <ul>
              <li><span class="muted">N=0</span> (no layers): <span class="muted">R=0</span>, <span class="muted">T=1</span> (same medium on both sides).</li>
              <li>Large <span class="muted">N</span>: <span class="muted">R→1</span>, <span class="muted">T→0</span> at Bragg (ideal mirror behavior).</li>
            </ul>
          </li>
        </ul>

        <p class="tiny">
          Connection to the diagram and plots: the diagram shows the alternating quarter-wave layers; the main plot shows how the coherent addition of reflections increases R with N;
          the secondary plot shows the “stopband” around Bragg for the chosen N.
        </p>
      </article>
    </section>

    <section class="card fadeIn" style="margin-top:14px;">
      <h2>Interactive Visualizations</h2>

      <div class="viz">
        <div class="controls" role="group" aria-label="Interactive controls">
          <div class="ctrl">
            <label for="nSlider">Number of periods <span class="val" id="nVal">10</span></label>
            <input id="nSlider" type="range" min="1" max="30" step="1" value="10"/>
            <div class="tiny">Updates: diagram + highlight on R/T vs N + spectrum for chosen N.</div>
          </div>
          <div class="ctrl">
            <label for="orderSel">Start layer (entrance)</label>
            <select id="orderSel">
              <option value="Lfirst" selected>AlAs first (n2), then GaAs (n1)</option>
              <option value="Hfirst">GaAs first (n1), then AlAs (n2)</option>
            </select>
            <div class="tiny">Finite stacks depend on the first interface.</div>
          </div>
          <div class="ctrl">
            <label for="spanSel">Spectrum span (λ/λB)</label>
            <select id="spanSel">
              <option value="0.10">±10%</option>
              <option value="0.20" selected>±20%</option>
              <option value="0.35">±35%</option>
            </select>
            <div class="tiny">Secondary plot: stopband vs wavelength detuning.</div>
          </div>
        </div>

        <div class="vizRow">
          <figure>
            <canvas id="cDiagram" aria-label="Layer diagram"></canvas>
            <figcaption>
              <strong>Diagram:</strong> GaAs background with alternating quarter-wave layers.
              One period contains two layers; the slider controls the displayed period count (schematic).
            </figcaption>
          </figure>

          <figure class="small">
            <canvas id="cMain" aria-label="Reflectance and transmittance vs N"></canvas>
            <figcaption>
              <strong>Main plot:</strong> <span class="muted">R(N)</span> and <span class="muted">T(N)</span> at Bragg (<span class="muted">λ=λB</span>).
              A marker highlights the currently selected <span class="muted">N</span>.
            </figcaption>
          </figure>
        </div>

        <figure class="small">
          <canvas id="cSpec" aria-label="Reflectance spectrum around Bragg"></canvas>
          <figcaption>
            <strong>Secondary plot:</strong> Reflectance spectrum <span class="muted">R(λ/λB)</span> around Bragg for the selected <span class="muted">N</span>.
            This visualizes the stopband (high reflection region) and how it sharpens with increasing <span class="muted">N</span>.
          </figcaption>
        </figure>
      </div>
    </section>

    <section id="part4" class="card fadeIn" style="margin-top:14px;">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <article>
        <h3>Re-interpreting the formulas</h3>
        <p>
          The multilayer matrix effectively “compresses” a complicated sequence of partial reflections and transmissions into a single boundary relation.
          The terms <span class="muted">A,B,C,D</span> of <span class="muted">M_total</span> encode how the stack transforms field amplitudes.
          At Bragg, every layer is quarter-wave, which makes each layer matrix especially simple; repeated multiplication creates an overall matrix
          that grows in a way that strongly favors reflection.
        </p>

        <h3>How parameters affect the outcome (connect to plots)</h3>
        <ul>
          <li><strong>Increase N</strong>: increases coherent buildup ⇒ <span class="muted">R</span> rises, <span class="muted">T</span> falls. The spectrum stopband becomes deeper and typically more pronounced.</li>
          <li><strong>Layer ordering (start layer)</strong>: for finite N, the first and last interfaces are not symmetric; starting with AlAs creates an immediate index discontinuity from GaAs → typically boosts reflection for small N.</li>
          <li><strong>Detuning from Bragg</strong> (<span class="muted">λ/λB ≠ 1</span>): quarter-wave phase condition breaks, constructive interference weakens ⇒ <span class="muted">R</span> drops outside the stopband.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p>
          You can analyze the infinite periodic structure using <strong>Bloch waves</strong>:
          compute the unit-cell transfer matrix <span class="muted">M_period</span>, then use its trace to find passbands/stopbands via
          <span class="muted">cos(k_B Λ) = (1/2)Tr(M_period)</span>, where <span class="muted">Λ</span> is the period thickness.
          The finite stack reflectance can then be related to the Bloch attenuation inside the stopband.
          This gives strong intuition for why reflectance increases exponentially with N in the stopband.
        </p>

        <div class="callout">
          <h4><span class="badge b-eq">Concept checks (with answers)</span></h4>
          <ul>
            <li><strong>Q:</strong> Why does quarter-wave thickness matter? <strong>A:</strong> It enforces a phase condition so reflections from many interfaces return in phase at the entrance.</li>
            <li><strong>Q:</strong> If the background equals GaAs, why doesn’t a GaAs layer “do nothing”? <strong>A:</strong> It still adds phase and it provides a second interface in a period; both affect interference.</li>
            <li><strong>Q:</strong> In a lossless stack, what should <span class="muted">R+T</span> equal? <strong>A:</strong> Approximately 1 (numerical rounding aside).</li>
            <li><strong>Q:</strong> What happens far from Bragg? <strong>A:</strong> The stopband disappears and the structure transmits more (R decreases).</li>
          </ul>
        </div>
      </article>
    </section>

    <section id="part5" class="card fadeIn" style="margin-top:14px;">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <article>
        <h3>What each canvas shows</h3>
        <ul>
          <li><strong>Diagram canvas:</strong> a schematic of GaAs background and alternating AlAs/GaAs layers. The selected <span class="muted">N</span> changes how many periods are drawn (schematic, not to scale).</li>
          <li><strong>Main plot:</strong> <span class="muted">R(N)</span> and <span class="muted">T(N)</span> evaluated at <span class="muted">λ=λB</span>, for <span class="muted">N=1…30</span> (with emphasis on 1…10 per the problem). A marker highlights your chosen <span class="muted">N</span>.</li>
          <li><strong>Secondary plot:</strong> <span class="muted">R</span> versus normalized wavelength <span class="muted">λ/λB</span> around 1 for your chosen <span class="muted">N</span>. This reveals the stopband shape.</li>
        </ul>

        <h3>How the interactive controls work</h3>
        <ul>
          <li><strong>Number of periods N (slider):</strong> increases/decreases the number of unit cells. You should see <span class="muted">R</span> rise and the stopband deepen as N increases.</li>
          <li><strong>Start layer (select):</strong> switches whether the first layer is AlAs or GaAs. For small N, this changes <span class="muted">R(N)</span> because the entrance interface changes.</li>
          <li><strong>Spectrum span (select):</strong> widens/narrows the wavelength sweep around Bragg for the secondary plot.</li>
        </ul>

        <p class="tiny">
          All computations use the same constants as the text: <span class="muted">n1=3.57</span>, <span class="muted">n2=2.94</span>, embedded in GaAs so <span class="muted">y0=ys=n1</span>,
          and quarter-wave layers defined at <span class="muted">λ=λB</span>.
        </p>
      </article>
    </section>
  </main>
</div>

<footer class="fadeIn">
  <div class="tiny">
    Built with vanilla HTML/CSS/JS. Transfer-matrix method at normal incidence. Lossless dielectric assumption (R+T≈1).
  </div>
</footer>

<script>
/* =========================
   Utility: smooth scrolling + active TOC highlighting
========================= */
(function(){
  const links = Array.from(document.querySelectorAll('.toclink'));
  links.forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const id = a.getAttribute('href');
      const el = document.querySelector(id);
      if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
    });
  });

  const sections = links.map(a => document.querySelector(a.getAttribute('href'))).filter(Boolean);
  const obs = new IntersectionObserver((entries)=>{
    entries.forEach(ent=>{
      if(ent.isIntersecting){
        links.forEach(l=>l.classList.remove('active'));
        const idx = sections.indexOf(ent.target);
        if(idx>=0) links[idx].classList.add('active');
      }
    });
  }, {root:null, threshold:0.22});
  sections.forEach(s=>obs.observe(s));
})();

/* =========================
   Copy buttons
========================= */
(function(){
  function getTextFromBox(id){
    const el = document.getElementById(id);
    if(!el) return '';
    const pre = el.querySelector('pre');
    return pre ? pre.innerText.trim() : el.innerText.trim();
  }
  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      return true;
    }catch(e){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand('copy'); }catch(err){}
      document.body.removeChild(ta);
      return true;
    }
  }
  document.querySelectorAll('.copyBtn').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const id = btn.getAttribute('data-copy');
      const txt = getTextFromBox(id);
      const ok = await copyText(txt);
      const old = btn.textContent;
      btn.textContent = ok ? 'Copied!' : 'Copy failed';
      setTimeout(()=>btn.textContent = old, 900);
    });
  });
})();

/* =========================
   Complex number helper
========================= */
class C {
  constructor(re, im){ this.re = re; this.im = im; }
  static add(a,b){ return new C(a.re+b.re, a.im+b.im); }
  static sub(a,b){ return new C(a.re-b.re, a.im-b.im); }
  static mul(a,b){ return new C(a.re*b.re - a.im*b.im, a.re*b.im + a.im*b.re); }
  static div(a,b){
    const den = b.re*b.re + b.im*b.im;
    return new C((a.re*b.re + a.im*b.im)/den, (a.im*b.re - a.re*b.im)/den);
  }
  static conj(a){ return new C(a.re, -a.im); }
  static abs2(a){ return a.re*a.re + a.im*a.im; }
  static fromReal(x){ return new C(x,0); }
}
function ccos(x){ return Math.cos(x); }
function csin(x){ return Math.sin(x); }
const I = new C(0,1);

/* =========================
   2x2 matrix over complex numbers
========================= */
function matMul(M,N){
  // [ [a,b],[c,d] ] * [ [e,f],[g,h] ]
  const a=M[0][0], b=M[0][1], c=M[1][0], d=M[1][1];
  const e=N[0][0], f=N[0][1], g=N[1][0], h=N[1][1];
  return [
    [ C.add(C.mul(a,e), C.mul(b,g)), C.add(C.mul(a,f), C.mul(b,h)) ],
    [ C.add(C.mul(c,e), C.mul(d,g)), C.add(C.mul(c,f), C.mul(d,h)) ]
  ];
}
function matPow(M, n){
  let R = [[C.fromReal(1), C.fromReal(0)], [C.fromReal(0), C.fromReal(1)]];
  let A = M;
  let k = n;
  while(k>0){
    if(k&1) R = matMul(R,A);
    A = matMul(A,A);
    k >>= 1;
  }
  return R;
}

/* =========================
   Optics: transfer matrix, r/t, R/T
   Normal incidence, nonmagnetic: admittance y = n (real).
========================= */
function layerMatrix(n, delta){
  // M = [[cosδ, i sinδ / y], [i y sinδ, cosδ]]
  const y = n;
  const cd = ccos(delta);
  const sd = csin(delta);
  return [
    [ C.fromReal(cd), C.mul(I, C.fromReal(sd / y)) ],
    [ C.mul(I, C.fromReal(y * sd)), C.fromReal(cd) ]
  ];
}

function stackRT_atLambda(n1, n2, N, lambdaOverLambdaB, startOrder){
  // We define quarter-wave thicknesses at λB: d_i = λB/(4 n_i)
  // At general λ = (lambdaOverLambdaB)*λB, delta_i = (2π/λ) n_i d_i = (2π/(λB*λr))*(λB/4) = (π/2)/λr
  const lr = lambdaOverLambdaB;
  const delta = (Math.PI/2) / lr; // same for both, because nd = λB/4
  const M1 = layerMatrix(n1, delta);
  const M2 = layerMatrix(n2, delta);

  // Choose unit cell ordering by startOrder: "Lfirst" means AlAs first then GaAs
  // Total stack is 2N layers.
  let Mtot = [[C.fromReal(1),C.fromReal(0)],[C.fromReal(0),C.fromReal(1)]];
  for(let k=0;k<N;k++){
    if(startOrder === 'Lfirst'){
      // AlAs then GaAs
      Mtot = matMul(Mtot, M2);
      Mtot = matMul(Mtot, M1);
    }else{
      // GaAs then AlAs
      Mtot = matMul(Mtot, M1);
      Mtot = matMul(Mtot, M2);
    }
  }

  // boundary admittances: incident and substrate both GaAs
  const y0 = n1;
  const ys = n1;

  const A = Mtot[0][0], B = Mtot[0][1], Cc = Mtot[1][0], D = Mtot[1][1];

  // r = ( y0(A + B ys) - (C + D ys) ) / ( y0(A + B ys) + (C + D ys) )
  // t = (2 y0) / ( y0(A + B ys) + (C + D ys) )
  const AplusBys = C.add(A, C.mul(B, C.fromReal(ys)));
  const CplusDys = C.add(Cc, C.mul(D, C.fromReal(ys)));

  const num = C.sub(C.mul(C.fromReal(y0), AplusBys), CplusDys);
  const den = C.add(C.mul(C.fromReal(y0), AplusBys), CplusDys);

  const r = C.div(num, den);
  const t = C.div(C.fromReal(2*y0), den);

  const R = C.abs2(r);
  const T = (ys/y0) * C.abs2(t); // here ys=y0 -> T=|t|^2
  return {R, T, r, t};
}

/* =========================
   Canvas plotting helpers (high-DPI, grid, axes, ticks)
========================= */
function setupCanvas(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  canvas.width = Math.max(2, Math.floor(rect.width * dpr));
  canvas.height = Math.max(2, Math.floor(rect.height * dpr));
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  return {ctx, w: rect.width, h: rect.height, dpr};
}

function drawPanelBG(ctx, w, h){
  ctx.clearRect(0,0,w,h);
  // subtle vignette
  const g = ctx.createRadialGradient(w*0.25,h*0.2, 10, w*0.5,h*0.6, Math.max(w,h));
  g.addColorStop(0, 'rgba(110,231,255,0.08)');
  g.addColorStop(0.5, 'rgba(167,139,250,0.05)');
  g.addColorStop(1, 'rgba(0,0,0,0)');
  ctx.fillStyle = 'rgba(0,0,0,0.14)';
  ctx.fillRect(0,0,w,h);
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);
}

function niceTicks(min, max, n=5){
  const span = max - min;
  if(span <= 0) return [min];
  const raw = span / n;
  const pow = Math.pow(10, Math.floor(Math.log10(raw)));
  const steps = [1,2,2.5,5,10].map(s=>s*pow);
  let step = steps[0];
  for(const s of steps){ if(Math.abs(raw - s) < Math.abs(raw - step)) step = s; }
  const start = Math.ceil(min/step)*step;
  const ticks = [];
  for(let v=start; v<=max + 1e-12; v+=step) ticks.push(v);
  return ticks;
}

function drawAxes(ctx, w, h, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
  const {x, y, W, H} = box;

  // title
  ctx.save();
  ctx.fillStyle = 'rgba(233,238,252,0.92)';
  ctx.font = '600 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText(title, x+8, y+18);
  ctx.restore();

  // grid + border
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.14)';
  ctx.lineWidth = 1;
  ctx.strokeRect(x, y+26, W, H-26);

  const plotY = y+26;
  const plotH = H-26;

  // ticks
  const xt = niceTicks(xMin, xMax, 6);
  const yt = niceTicks(yMin, yMax, 5);

  // gridlines
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.fillStyle = 'rgba(185,194,230,0.9)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

  // x grid
  xt.forEach(v=>{
    const px = x + (v-xMin)/(xMax-xMin)*W;
    ctx.beginPath();
    ctx.moveTo(px, plotY);
    ctx.lineTo(px, plotY+plotH);
    ctx.stroke();
    ctx.fillText(formatTick(v), px-8, plotY+plotH+16);
  });

  // y grid
  yt.forEach(v=>{
    const py = plotY + (1-(v-yMin)/(yMax-yMin))*plotH;
    ctx.beginPath();
    ctx.moveTo(x, py);
    ctx.lineTo(x+W, py);
    ctx.stroke();
    ctx.fillText(formatTick(v), x-44, py+4);
  });

  // labels
  ctx.save();
  ctx.fillStyle = 'rgba(233,238,252,0.85)';
  ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText(xLabel, x+W-8-ctx.measureText(xLabel).width, plotY+plotH+34);

  ctx.save();
  ctx.translate(x-56, plotY+plotH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
  ctx.restore();

  ctx.restore();
  ctx.restore();

  return {plotX:x, plotY:plotY, plotW:W, plotH:plotH};
}

function formatTick(v){
  const av = Math.abs(v);
  if(av >= 1000) return v.toFixed(0);
  if(av >= 100) return v.toFixed(0);
  if(av >= 10) return v.toFixed(1).replace(/\.0$/,'');
  if(av >= 1) return v.toFixed(2).replace(/0$/,'').replace(/\.0$/,'');
  return v.toFixed(3).replace(/0+$/,'').replace(/\.$/,'');
}

function plotLine(ctx, plot, xs, ys, xMin, xMax, yMin, yMax, strokeStyle, width=2){
  const {plotX, plotY, plotW, plotH} = plot;
  ctx.save();
  ctx.strokeStyle = strokeStyle;
  ctx.lineWidth = width;
  ctx.beginPath();
  for(let i=0;i<xs.length;i++){
    const px = plotX + (xs[i]-xMin)/(xMax-xMin)*plotW;
    const py = plotY + (1-(ys[i]-yMin)/(yMax-yMin))*plotH;
    if(i===0) ctx.moveTo(px,py);
    else ctx.lineTo(px,py);
  }
  ctx.stroke();
  ctx.restore();
}

function drawLegend(ctx, x, y, items){
  ctx.save();
  ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  const pad=8, gap=10, sw=18, lineH=18;
  // compute width
  let maxW=0;
  items.forEach(it=>{
    maxW = Math.max(maxW, sw+8+ctx.measureText(it.label).width);
  });
  const W = maxW + pad*2;
  const H = items.length*lineH + pad*2;

  ctx.fillStyle = 'rgba(0,0,0,0.25)';
  ctx.strokeStyle = 'rgba(255,255,255,0.14)';
  ctx.lineWidth = 1;
  roundRect(ctx, x, y, W, H, 12);
  ctx.fill();
  ctx.stroke();

  items.forEach((it,i)=>{
    const yy = y+pad + i*lineH + 12;
    ctx.strokeStyle = it.color;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x+pad, yy-4);
    ctx.lineTo(x+pad+sw, yy-4);
    ctx.stroke();

    ctx.fillStyle = 'rgba(233,238,252,0.92)';
    ctx.fillText(it.label, x+pad+sw+8, yy);
  });

  ctx.restore();
}
function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

/* =========================
   Draw diagram canvas
========================= */
function drawDiagram(canvas, state){
  const {ctx, w, h} = setupCanvas(canvas);
  drawPanelBG(ctx, w, h);

  const margin = 18;
  const top = 26;
  const box = {x: margin, y: top, W: w-2*margin, H: h-top-margin};
  // Panel outline
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.14)';
  ctx.lineWidth = 1;
  roundRect(ctx, box.x, box.y, box.W, box.H, 18);
  ctx.stroke();
  ctx.restore();

  // Title
  ctx.save();
  ctx.fillStyle = 'rgba(233,238,252,0.92)';
  ctx.font = '700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText('Quarter-wave DBR in GaAs (schematic)', box.x+12, box.y+18);
  ctx.restore();

  // Draw wave arrow + layers
  const x0 = box.x + 18;
  const y0 = box.y + 34;
  const H = box.H - 50;
  const stackY = y0 + 10;
  const stackH = H - 20;

  // Regions: left GaAs, stack, right GaAs
  const leftW = Math.max(72, box.W*0.18);
  const rightW = Math.max(72, box.W*0.18);
  const stackW = box.W - leftW - rightW - 20;
  const stackX = x0 + leftW + 10;

  // Left region
  ctx.save();
  ctx.fillStyle = 'rgba(110,231,255,0.06)';
  roundRect(ctx, x0, stackY, leftW, stackH, 14);
  ctx.fill();
  ctx.strokeStyle = 'rgba(110,231,255,0.18)';
  ctx.stroke();
  ctx.fillStyle = 'rgba(233,238,252,0.85)';
  ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText('GaAs', x0+10, stackY+18);
  ctx.fillStyle = 'rgba(185,194,230,0.9)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
  ctx.fillText('n₀ = n₁ = 3.57', x0+10, stackY+36);
  ctx.restore();

  // Right region
  const rx = stackX + stackW + 10;
  ctx.save();
  ctx.fillStyle = 'rgba(110,231,255,0.06)';
  roundRect(ctx, rx, stackY, rightW, stackH, 14);
  ctx.fill();
  ctx.strokeStyle = 'rgba(110,231,255,0.18)';
  ctx.stroke();
  ctx.fillStyle = 'rgba(233,238,252,0.85)';
  ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText('GaAs', rx+10, stackY+18);
  ctx.fillStyle = 'rgba(185,194,230,0.9)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
  ctx.fillText('n_s = 3.57', rx+10, stackY+36);
  ctx.restore();

  // Stack background
  ctx.save();
  ctx.fillStyle = 'rgba(167,139,250,0.06)';
  roundRect(ctx, stackX, stackY, stackW, stackH, 14);
  ctx.fill();
  ctx.strokeStyle = 'rgba(167,139,250,0.20)';
  ctx.stroke();
  ctx.restore();

  // Layers: draw up to a max visual count to avoid tiny stripes
  const N = state.N;
  const maxPeriodsDraw = Math.min(N, 14);
  const layers = [];
  for(let k=0;k<maxPeriodsDraw;k++){
    if(state.order === 'Lfirst'){
      layers.push({n: state.n2, name:'AlAs'});
      layers.push({n: state.n1, name:'GaAs'});
    }else{
      layers.push({n: state.n1, name:'GaAs'});
      layers.push({n: state.n2, name:'AlAs'});
    }
  }
  const totalLayers = layers.length;
  const layerW = stackW / totalLayers;

  for(let i=0;i<totalLayers;i++){
    const lx = stackX + i*layerW;
    const isGaAs = Math.abs(layers[i].n - state.n1) < 1e-9;
    ctx.save();
    ctx.fillStyle = isGaAs ? 'rgba(110,231,255,0.12)' : 'rgba(255,210,122,0.12)';
    ctx.fillRect(lx, stackY, layerW+0.5, stackH);
    ctx.strokeStyle = 'rgba(255,255,255,0.07)';
    ctx.beginPath();
    ctx.moveTo(lx, stackY);
    ctx.lineTo(lx, stackY+stackH);
    ctx.stroke();
    ctx.restore();
  }

  // Stack label
  ctx.save();
  ctx.fillStyle = 'rgba(233,238,252,0.92)';
  ctx.font = '700 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText(`DBR stack: N = ${N} periods (shown: ${maxPeriodsDraw})`, stackX+10, stackY+18);
  ctx.fillStyle = 'rgba(185,194,230,0.9)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
  ctx.fillText(`n₁=3.57 (GaAs), n₂=2.94 (AlAs)`, stackX+10, stackY+36);
  ctx.fillText(`Quarter-wave at λB: nᵢ dᵢ = λB/4`, stackX+10, stackY+54);
  ctx.restore();

  // Incident arrow
  ctx.save();
  const ax1 = x0 + 12;
  const ax2 = stackX - 10;
  const ay  = stackY + stackH/2;
  ctx.strokeStyle = 'rgba(233,238,252,0.85)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(ax1, ay);
  ctx.lineTo(ax2, ay);
  ctx.stroke();
  // arrow head
  ctx.beginPath();
  ctx.moveTo(ax2, ay);
  ctx.lineTo(ax2-10, ay-6);
  ctx.lineTo(ax2-10, ay+6);
  ctx.closePath();
  ctx.fillStyle = 'rgba(233,238,252,0.85)';
  ctx.fill();
  ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText('incident plane wave', ax1, ay-12);
  ctx.restore();

  // Reflected arrow
  ctx.save();
  const rx2 = x0 + 12;
  const rx1 = stackX - 10;
  const ry  = ay + 34;
  ctx.strokeStyle = 'rgba(255,107,138,0.85)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(rx1, ry);
  ctx.lineTo(rx2, ry);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(rx2, ry);
  ctx.lineTo(rx2+10, ry-6);
  ctx.lineTo(rx2+10, ry+6);
  ctx.closePath();
  ctx.fillStyle = 'rgba(255,107,138,0.85)';
  ctx.fill();
  ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText('reflected', rx2+14, ry-4);
  ctx.restore();

  // Transmitted arrow
  ctx.save();
  const tx1 = stackX + stackW + 10;
  const tx2 = rx + rightW - 12;
  const ty  = ay;
  ctx.strokeStyle = 'rgba(124,255,178,0.85)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(tx1, ty);
  ctx.lineTo(tx2, ty);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(tx2, ty);
  ctx.lineTo(tx2-10, ty-6);
  ctx.lineTo(tx2-10, ty+6);
  ctx.closePath();
  ctx.fillStyle = 'rgba(124,255,178,0.85)';
  ctx.fill();
  ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText('transmitted', tx1+10, ty-12);
  ctx.restore();
}

/* =========================
   Main plot: R and T vs N at Bragg
========================= */
function drawMainPlot(canvas, state){
  const {ctx, w, h} = setupCanvas(canvas);
  drawPanelBG(ctx, w, h);

  const marginL = 64, marginR = 16, marginT = 14, marginB = 46;
  const box = {x: marginL, y: marginT, W: w - marginL - marginR, H: h - marginT - marginB};

  const Nmax = 30;
  const xs = [];
  const Rs = [];
  const Ts = [];
  for(let N=1; N<=Nmax; N++){
    const rt = stackRT_atLambda(state.n1, state.n2, N, 1.0, state.order);
    xs.push(N);
    Rs.push(rt.R);
    Ts.push(rt.T);
  }

  // y range fixed 0..1
  const xMin = 1, xMax = Nmax;
  const yMin = 0, yMax = 1;

  const plot = drawAxes(ctx, w, h, box, xMin, xMax, yMin, yMax, 'N (periods)', 'R, T (unitless)', 'Reflectance & Transmittance at Bragg (λ = λB)');

  // lines
  plotLine(ctx, plot, xs, Rs, xMin, xMax, yMin, yMax, 'rgba(110,231,255,0.95)', 2.5);
  plotLine(ctx, plot, xs, Ts, xMin, xMax, yMin, yMax, 'rgba(124,255,178,0.95)', 2.5);

  // marker at selected N
  const selN = state.N;
  const sel = stackRT_atLambda(state.n1, state.n2, selN, 1.0, state.order);
  const px = plot.plotX + (selN-xMin)/(xMax-xMin)*plot.plotW;
  const pyR = plot.plotY + (1-(sel.R-yMin)/(yMax-yMin))*plot.plotH;
  const pyT = plot.plotY + (1-(sel.T-yMin)/(yMax-yMin))*plot.plotH;

  ctx.save();
  // marker R
  ctx.fillStyle = 'rgba(110,231,255,0.95)';
  ctx.beginPath(); ctx.arc(px, pyR, 4.5, 0, Math.PI*2); ctx.fill();
  // marker T
  ctx.fillStyle = 'rgba(124,255,178,0.95)';
  ctx.beginPath(); ctx.arc(px, pyT, 4.5, 0, Math.PI*2); ctx.fill();

  // annotation box
  const txt = `N=${selN}  R=${sel.R.toFixed(4)}  T=${sel.T.toFixed(4)}  (R+T=${(sel.R+sel.T).toFixed(4)})`;
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
  const tw = ctx.measureText(txt).width;
  const bx = Math.min(plot.plotX + plot.plotW - tw - 18, px + 10);
  const by = Math.max(plot.plotY + 10, pyR - 22);

  ctx.fillStyle = 'rgba(0,0,0,0.25)';
  ctx.strokeStyle = 'rgba(255,255,255,0.14)';
  roundRect(ctx, bx, by, tw+14, 22, 10);
  ctx.fill(); ctx.stroke();
  ctx.fillStyle = 'rgba(233,238,252,0.92)';
  ctx.fillText(txt, bx+7, by+15);
  ctx.restore();

  drawLegend(ctx, plot.plotX + 10, plot.plotY + 10, [
    {label:'R (reflectance)', color:'rgba(110,231,255,0.95)'},
    {label:'T (transmittance)', color:'rgba(124,255,178,0.95)'}
  ]);
}

/* =========================
   Spectrum plot: R vs lambda/lambdaB around 1
========================= */
function drawSpectrum(canvas, state){
  const {ctx, w, h} = setupCanvas(canvas);
  drawPanelBG(ctx, w, h);

  const marginL = 64, marginR = 16, marginT = 14, marginB = 46;
  const box = {x: marginL, y: marginT, W: w - marginL - marginR, H: h - marginT - marginB};

  const span = state.span; // e.g. 0.2 means 0.8..1.2
  const xMin = 1 - span, xMax = 1 + span;
  const yMin = 0, yMax = 1;

  const plot = drawAxes(ctx, w, h, box, xMin, xMax, yMin, yMax, 'λ / λB (unitless)', 'R (unitless)', `Reflectance Spectrum for N=${state.N}`);

  const M = 360;
  const xs = [];
  const Rs = [];
  for(let i=0;i<M;i++){
    const lr = xMin + (xMax-xMin)*i/(M-1);
    const rt = stackRT_atLambda(state.n1, state.n2, state.N, lr, state.order);
    xs.push(lr);
    Rs.push(rt.R);
  }
  plotLine(ctx, plot, xs, Rs, xMin, xMax, yMin, yMax, 'rgba(167,139,250,0.95)', 2.5);

  // Bragg marker at 1
  const px = plot.plotX + (1-xMin)/(xMax-xMin)*plot.plotW;
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.20)';
  ctx.lineWidth = 1.5;
  ctx.setLineDash([6,5]);
  ctx.beginPath();
  ctx.moveTo(px, plot.plotY);
  ctx.lineTo(px, plot.plotY+plot.plotH);
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle = 'rgba(233,238,252,0.9)';
  ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
  ctx.fillText('Bragg (λ/λB = 1)', Math.min(px+8, plot.plotX+plot.plotW-140), plot.plotY+18);
  ctx.restore();

  drawLegend(ctx, plot.plotX + 10, plot.plotY + 10, [
    {label:'R(λ/λB)', color:'rgba(167,139,250,0.95)'}
  ]);
}

/* =========================
   App state + redraw
========================= */
const state = {
  n1: 3.57,
  n2: 2.94,
  N: 10,
  order: 'Lfirst',
  span: 0.20
};

const cDiagram = document.getElementById('cDiagram');
const cMain = document.getElementById('cMain');
const cSpec = document.getElementById('cSpec');

function redrawAll(){
  drawDiagram(cDiagram, state);
  drawMainPlot(cMain, state);
  drawSpectrum(cSpec, state);
}

const nSlider = document.getElementById('nSlider');
const nVal = document.getElementById('nVal');
nSlider.addEventListener('input', ()=>{
  state.N = parseInt(nSlider.value,10);
  nVal.textContent = state.N;
  redrawAll();
});

const orderSel = document.getElementById('orderSel');
orderSel.addEventListener('change', ()=>{
  state.order = orderSel.value;
  redrawAll();
});

const spanSel = document.getElementById('spanSel');
spanSel.addEventListener('change', ()=>{
  state.span = parseFloat(spanSel.value);
  redrawAll();
});

// resize
let resizeTimer = null;
window.addEventListener('resize', ()=>{
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(()=>redrawAll(), 120);
});

// initial draw
redrawAll();
</script>
</body>
</html>
