<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Off-Axis Wave in a 1D Periodic Medium (with transverse kx): Coupled-Harmonic Equations and Dispersion</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1730;
      --card:#111b38;
      --ink:#e9eefc;
      --muted:#b8c3ee;
      --faint:#7f8ac4;
      --line:rgba(255,255,255,.10);
      --accent:#7dd3fc;
      --accent2:#a7f3d0;
      --warn:#fbbf24;
      --ok:#34d399;
      --bad:#fb7185;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background: radial-gradient(1200px 800px at 20% -10%, rgba(125,211,252,.18), transparent 55%),
                  radial-gradient(900px 700px at 90% 20%, rgba(167,243,208,.14), transparent 55%),
                  linear-gradient(180deg, var(--bg), #070a16 70%);
      line-height:1.55;
    }
    header{
      padding: 36px 18px 14px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .title{
      display:grid;
      gap:10px;
    }
    h1{
      margin:0;
      font-size: clamp(1.6rem, 2.6vw, 2.45rem);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      max-width: 80ch;
    }
    .meta{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      color:var(--faint);
      font-size:.95rem;
    }
    .pill{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
      backdrop-filter: blur(6px);
    }

    main{
      max-width:1200px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      gap:18px;
      grid-template-columns: 1fr;
    }

    /* Sticky TOC */
    .layout{
      display:grid;
      gap:18px;
      grid-template-columns: 1fr;
      align-items:start;
    }
    @media (min-width: 980px){
      .layout{
        grid-template-columns: 280px 1fr;
      }
    }
    nav.toc{
      position:sticky;
      top:14px;
      border:1px solid var(--line);
      background: rgba(17,27,56,.70);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .toc-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .toc-head strong{font-size:1rem}
    .toc small{color:var(--faint)}
    .toc a{
      display:block;
      padding:10px 14px;
      text-decoration:none;
      color:var(--muted);
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .toc a:hover{background:rgba(255,255,255,.06); color:var(--ink)}
    .toc a:last-child{border-bottom:none}
    .toc .mini{
      padding:10px 14px 14px;
      color:var(--faint);
      font-size:.92rem;
    }

    section, article{
      border:1px solid var(--line);
      background: rgba(17,27,56,.58);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .sec-head{
      padding:16px 16px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:12px;
    }
    .sec-head h2{
      margin:0;
      font-size:1.2rem;
      letter-spacing:.2px;
    }
    .sec-head .hint{
      color:var(--faint);
      font-size:.92rem;
    }
    .content{
      padding: 14px 16px 18px;
    }

    .grid2{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media(min-width: 860px){
      .grid2{grid-template-columns: 1fr 1fr;}
    }

    .callouts{
      display:grid;
      gap:12px;
      grid-template-columns: 1fr;
    }
    @media(min-width: 860px){
      .callouts{grid-template-columns: repeat(3, 1fr);}
    }
    .box{
      padding:12px 12px 10px;
      border:1px solid rgba(255,255,255,.12);
      border-radius:14px;
      background: rgba(255,255,255,.04);
    }
    .box h3{
      margin:0 0 6px;
      font-size:1rem;
    }
    .box ul{margin:8px 0 0 18px; color:var(--muted)}
    .box p{margin:6px 0 0; color:var(--muted)}
    .tag{
      display:inline-block;
      font-size:.78rem;
      color: var(--ink);
      background: rgba(125,211,252,.16);
      border:1px solid rgba(125,211,252,.35);
      padding:3px 8px;
      border-radius:999px;
      margin-left:8px;
      vertical-align:middle;
    }

    .equation{
      margin:10px 0;
      padding:12px 12px;
      border-radius:14px;
      border:1px dashed rgba(125,211,252,.40);
      background: rgba(125,211,252,.07);
      position:relative;
      overflow:hidden;
    }
    .equation pre{
      margin:0;
      font-family:var(--mono);
      font-size:.95rem;
      white-space:pre-wrap;
      word-break:break-word;
      color: #dff6ff;
    }
    .eq-actions{
      position:absolute;
      top:10px;
      right:10px;
      display:flex;
      gap:8px;
    }
    button.copy{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      color: var(--ink);
      border-radius:999px;
      padding:6px 10px;
      font-size:.85rem;
      transition: transform .12s ease, background .12s ease;
    }
    button.copy:hover{background: rgba(255,255,255,.10)}
    button.copy:active{transform: translateY(1px)}
    .note{
      color: var(--muted);
      margin: 10px 0 0;
    }

    .steps{
      counter-reset: step;
      margin: 10px 0 0;
      padding:0;
      list-style:none;
      display:grid;
      gap:10px;
    }
    .steps li{
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      position:relative;
    }
    .steps li::before{
      counter-increment: step;
      content: counter(step);
      position:absolute;
      top:10px;
      left:10px;
      width:26px;
      height:26px;
      display:grid;
      place-items:center;
      border-radius:9px;
      border:1px solid rgba(125,211,252,.35);
      background: rgba(125,211,252,.10);
      color: #dff6ff;
      font-weight:700;
      font-size:.92rem;
    }
    .steps li .txt{
      padding-left:42px;
      color:var(--muted);
    }
    .steps li .txt strong{color:var(--ink)}

    /* Viz area */
    .vizWrap{
      display:grid;
      gap:14px;
      grid-template-columns: 1fr;
    }
    @media(min-width: 980px){
      .vizWrap{
        grid-template-columns: 1.05fr .95fr;
      }
    }
    .panel{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      overflow:hidden;
    }
    .panel .ph{
      padding:12px 12px 10px;
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      border-bottom:1px solid rgba(255,255,255,.10);
    }
    .panel .ph strong{font-size:1rem}
    .panel .ph span{color:var(--faint); font-size:.9rem}
    .canvasBox{
      padding:10px;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius: 12px;
      background: rgba(255,255,255,.02);
      border:1px solid rgba(255,255,255,.08);
    }
    .controls{
      display:grid;
      gap:10px;
      grid-template-columns: 1fr;
      margin-top:10px;
    }
    @media(min-width: 860px){
      .controls{
        grid-template-columns: 1.2fr .8fr;
        align-items:end;
      }
    }
    .ctrlCard{
      padding:12px;
      border-radius:16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
    }
    .row{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    label{color:var(--muted); font-size:.95rem}
    input[type="range"]{width:100%}
    select, input[type="number"]{
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.18);
      color:var(--ink);
      border-radius:12px;
      padding:8px 10px;
      outline:none;
    }
    .readout{
      font-family:var(--mono);
      color:#dff6ff;
      background: rgba(125,211,252,.10);
      border:1px solid rgba(125,211,252,.25);
      padding:6px 10px;
      border-radius: 12px;
      font-size:.92rem;
    }

    footer{
      max-width:1200px;
      margin: 0 auto;
      padding: 6px 18px 28px;
      color: var(--faint);
      font-size:.92rem;
    }

    /* Print friendly */
    @media print{
      body{background:#fff; color:#000}
      section, article, nav.toc{box-shadow:none; background:#fff; border-color:#ddd}
      .equation{background:#f6fbff}
      .toc{position:relative; top:auto}
      button.copy{display:none}
      canvas{border:1px solid #bbb}
    }

    /* Subtle motion */
    @media (prefers-reduced-motion: no-preference){
      section, article, nav.toc{
        animation: floatIn .35s ease both;
      }
      @keyframes floatIn{
        from{opacity:0; transform: translateY(6px)}
        to{opacity:1; transform: translateY(0)}
      }
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>7.2-2 — Off-Axis Wave in a 1D Periodic Medium (transverse wavevector <span style="font-family:var(--mono)">k<sub>x</sub></span>)</h1>
    <p class="subtitle">
      We extend the standard 1D “periodic-index” coupled-harmonic / Bloch analysis to an <em>off-axis</em> wave.
      The only new ingredient is a conserved transverse component <span style="font-family:var(--mono)">k<sub>x</sub></span>, which reduces the available longitudinal propagation
      and shifts the Bragg/phase-matching condition and the bandgap dispersion.
    </p>
  </div>
  <div class="meta">
    <span class="pill">Topic: 1D photonic crystals / Bragg gratings</span>
    <span class="pill">Method: Fourier (spatial-harmonic) expansion</span>
    <span class="pill">Goal: derive off-axis analogs of Eqs. (7.2-24)–(7.2-28)</span>
  </div>
</header>

<main>
  <div class="layout">
    <nav class="toc" aria-label="Table of contents">
      <div class="toc-head">
        <strong>Contents</strong>
        <small>sticky</small>
      </div>
      <a href="#qs">Quick Summary</a>
      <a href="#p0">PART 0 — Concept Primer</a>
      <a href="#p1">PART 1 — Problem Analysis</a>
      <a href="#p2">PART 2 — Strategy & Tips</a>
      <a href="#p3">PART 3 — Full Solution</a>
      <a href="#p4">PART 4 — Deeper Understanding</a>
      <a href="#p5">PART 5 — Visualization Guide</a>
      <div class="mini">
        Interactive plots: adjust <span style="font-family:var(--mono)">k<sub>x</sub>/g</span> to see how the bandgap shifts and narrows.
      </div>
    </nav>

    <div>
      <!-- Quick Summary -->
      <section id="qs">
        <div class="sec-head">
          <h2>Quick Summary</h2>
          <div class="hint">What you’ll learn + what you’ll derive</div>
        </div>
        <div class="content">
          <ul style="margin:0 0 0 18px; color:var(--muted)">
            <li><strong>Problem:</strong> derive the <em>off-axis</em> (nonzero <span style="font-family:var(--mono)">k<sub>x</sub></span>) versions of the coupled-harmonic equations and bandgap dispersion for a 1D periodic medium.</li>
            <li><strong>Key idea:</strong> transverse wavevector <span style="font-family:var(--mono)">k<sub>x</sub></span> is conserved; it effectively replaces <span style="font-family:var(--mono)">(ω n̄ / c)<sup>2</sup></span> by <span style="font-family:var(--mono)">(ω n̄ / c)<sup>2</sup> − k<sub>x</sub><sup>2</sup></span> in the 1D wave equation along <span style="font-family:var(--mono)">z</span>.</li>
            <li><strong>Governing equation:</strong> Helmholtz with periodic <span style="font-family:var(--mono)">n(z)</span> and <span style="font-family:var(--mono)">E(x,z)=U(z)e^{i kx x}</span>.</li>
            <li><strong>Main derived result type:</strong> symbolic coupled-harmonic recursion (analog of (7.2-24)), an off-axis phase-matching condition (analog of (7.2-25)), and a two-wave bandgap dispersion relation (analog of (7.2-28)).</li>
            <li><strong>Off-axis resonance:</strong> strong coupling when <span style="font-family:var(--mono)">√[(ω n̄ / c)<sup>2</sup> − kx<sup>2</sup>] ≈ |K + m g|</span>.</li>
            <li><strong>Off-axis bandgap equation:</strong> same algebraic form as on-axis, but every bracket becomes <span style="font-family:var(--mono)">[(ω n̄ / c)<sup>2</sup> − kx<sup>2</sup> − (·)<sup>2</sup>]</span>.</li>
          </ul>

          <div class="callouts" style="margin-top:14px">
            <div class="box">
              <h3>Assumptions <span class="tag">crucial</span></h3>
              <ul>
                <li>Linear, isotropic dielectric</li>
                <li>1D periodicity in <span style="font-family:var(--mono)">z</span> only</li>
                <li>Weak modulation (keep first Fourier orders near Bragg)</li>
                <li>Single polarization treated (scalar model)</li>
              </ul>
            </div>
            <div class="box">
              <h3>What changes off-axis?</h3>
              <p>
                The <em>longitudinal</em> wavenumber budget shrinks:
                <span style="font-family:var(--mono)">kz^2 = (ω n̄ / c)^2 − kx^2</span>.
                That’s the only structural change—then the standard Bloch-harmonic machinery carries through.
              </p>
            </div>
            <div class="box">
              <h3>Final result delivered</h3>
              <p>
                A set of equations analogous to (7.2-24)–(7.2-28), with
                <span style="font-family:var(--mono)">ω^2 n̄^2 / c^2</span>
                replaced by
                <span style="font-family:var(--mono)">ω^2 n̄^2 / c^2 − kx^2</span>
                in the denominators and dispersion factors.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- PART 0 -->
      <section id="p0" style="margin-top:18px">
        <div class="sec-head">
          <h2>PART 0 — Concept Primer (theory before solving)</h2>
          <div class="hint">Bloch waves + Bragg coupling with conserved transverse k</div>
        </div>
        <div class="content">
          <div class="grid2">
            <article class="box">
              <h3>Core definitions (symbols + units)</h3>
              <ul>
                <li><span style="font-family:var(--mono)">ω</span> — angular frequency (rad/s)</li>
                <li><span style="font-family:var(--mono)">c</span> — speed of light in vacuum (m/s)</li>
                <li><span style="font-family:var(--mono)">n(z)</span> — refractive index, periodic in <span style="font-family:var(--mono)">z</span> (dimensionless)</li>
                <li><span style="font-family:var(--mono)">g = 2π/Λ</span> — grating spatial frequency (rad/m)</li>
                <li><span style="font-family:var(--mono)">k<sub>x</sub></span> — transverse wavevector component (rad/m), conserved</li>
                <li><span style="font-family:var(--mono)">K</span> — Bloch wavevector component along <span style="font-family:var(--mono)">z</span> (rad/m)</li>
                <li><span style="font-family:var(--mono)">C<sub>m</sub></span> — complex amplitude of the <span style="font-family:var(--mono)">m</span>-th spatial harmonic (unit depends on field normalization)</li>
                <li><span style="font-family:var(--mono)">n̄</span> — average refractive index (dimensionless), often <span style="font-family:var(--mono)">n̄ ≈ 1/√η₀</span> in the referenced notation</li>
              </ul>
            </article>

            <article class="box">
              <h3>Physical meaning (what the quantities represent)</h3>
              <p>
                A 1D periodic medium (like a Bragg grating) couples plane-wave components whose longitudinal
                wavevectors differ by integer multiples of <span style="font-family:var(--mono)">g</span>.
                In a Bloch expansion, the field is written as a sum of <em>spatial harmonics</em>
                with longitudinal factors <span style="font-family:var(--mono)">e^{i (K + m g) z}</span>.
              </p>
              <p class="note">
                Off-axis incidence means the wavefronts tilt, so some of the total wavevector is “spent” in <span style="font-family:var(--mono)">x</span>.
                The longitudinal part available to satisfy Bragg resonance is reduced.
              </p>
            </article>
          </div>

          <div class="box" style="margin-top:14px">
            <h3>Key laws/principles (and validity)</h3>
            <ul style="margin:8px 0 0 18px; color:var(--muted)">
              <li><strong>Helmholtz equation (frequency domain):</strong> valid for linear media at a single frequency (steady-state harmonic fields).</li>
              <li><strong>Bloch theorem:</strong> valid for periodic coefficients in linear differential equations → solutions are Bloch waves.</li>
              <li><strong>Coupled-mode / two-wave truncation near Bragg:</strong> valid when modulation is weak and only a small set of harmonics are near resonance (denominators small).</li>
            </ul>
          </div>

          <div class="grid2" style="margin-top:14px">
            <div class="box">
              <h3>Common models/approximations (why we use them)</h3>
              <ul>
                <li><strong>Scalar wave model:</strong> treat one polarization; simplifies to 1D ODE in <span style="font-family:var(--mono)">z</span>.</li>
                <li><strong>Weak index modulation:</strong> keep only first Fourier components of <span style="font-family:var(--mono)">n(z)</span> or related periodic coefficient.</li>
                <li><strong>Near-Bragg truncation:</strong> keep two dominant harmonics (e.g., <span style="font-family:var(--mono)">m=0</span> and <span style="font-family:var(--mono)">m=-1</span>) to get closed-form bandgap dispersion.</li>
              </ul>
            </div>
            <div class="box">
              <h3>Mini intuition examples (no long algebra)</h3>
              <ul>
                <li><strong>On-axis:</strong> Bragg coupling is strongest when forward and backward waves satisfy <span style="font-family:var(--mono)">2k ≈ g</span>.</li>
                <li><strong>Off-axis:</strong> replace <span style="font-family:var(--mono)">k</span> by the longitudinal component <span style="font-family:var(--mono)">kz</span>. If <span style="font-family:var(--mono)">kx</span> increases, <span style="font-family:var(--mono)">kz</span> decreases → harder to meet Bragg resonance → smaller gap.</li>
              </ul>
            </div>
          </div>

          <div class="box" style="margin-top:14px; border-color: rgba(251,191,36,.35); background: rgba(251,191,36,.06)">
            <h3>What to watch for (pitfalls)</h3>
            <ul style="margin:8px 0 0 18px; color:var(--muted)">
              <li><strong>Mixing total vs longitudinal wavenumber:</strong> Bragg resonance uses <span style="font-family:var(--mono)">kz</span>, not the full magnitude.</li>
              <li><strong>Forgetting conservation of <span style="font-family:var(--mono)">kx</span>:</strong> periodicity is only in <span style="font-family:var(--mono)">z</span>, so <span style="font-family:var(--mono)">kx</span> does not change between harmonics.</li>
              <li><strong>Truncation misuse:</strong> the two-wave model is accurate only near the band edge where only two harmonics are resonant.</li>
              <li><strong>Units:</strong> <span style="font-family:var(--mono)">g, K, kx</span> are spatial frequencies (rad/m). Keep consistent.</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- PART 1 -->
      <section id="p1" style="margin-top:18px">
        <div class="sec-head">
          <h2>PART 1 — Problem Analysis (no solving yet)</h2>
          <div class="hint">Translate the request into a plan</div>
        </div>
        <div class="content">
          <div class="box">
            <h3>Problem restatement (in plain words)</h3>
            <p style="margin:8px 0 0; color:var(--muted)">
              We have a medium whose properties vary periodically along <span style="font-family:var(--mono)">z</span> with spatial frequency <span style="font-family:var(--mono)">g</span>.
              In the on-axis case, the book derived coupled equations among spatial harmonics of a Bloch wave and then,
              near Bragg resonance, obtained a two-harmonic self-consistency (bandgap) condition.
              Now we want the <strong>analogous formulas when the wave travels off-axis</strong> so it has a nonzero conserved transverse component <span style="font-family:var(--mono)">k<sub>x</sub></span>.
            </p>
          </div>

          <div class="grid2" style="margin-top:14px">
            <div class="box">
              <h3>Given</h3>
              <ul>
                <li>1D periodic medium in <span style="font-family:var(--mono)">z</span> with grating vector <span style="font-family:var(--mono)">g</span></li>
                <li>Off-axis wave with transverse wavevector <span style="font-family:var(--mono)">k<sub>x</sub></span></li>
                <li>Reference on-axis equations (7.2-24)–(7.2-28) structure</li>
              </ul>
            </div>
            <div class="box">
              <h3>Unknowns / what to produce</h3>
              <ul>
                <li>Off-axis analog of the harmonic coupling equation (like 7.2-24)</li>
                <li>Off-axis resonance / phase-matching condition (like 7.2-25)</li>
                <li>Off-axis two-wave relations (like 7.2-27) and bandgap dispersion (like 7.2-28)</li>
              </ul>
            </div>
          </div>

          <div class="box" style="margin-top:14px">
            <h3>Relevant principles (and why they apply)</h3>
            <ul style="margin:8px 0 0 18px; color:var(--muted)">
              <li><strong>Helmholtz equation:</strong> describes monochromatic propagation in spatially varying refractive index.</li>
              <li><strong>Separation in x:</strong> because the structure is invariant in <span style="font-family:var(--mono)">x</span>, we can use <span style="font-family:var(--mono)">e^{i kx x}</span>, making <span style="font-family:var(--mono)">k<sub>x</sub></span> a constant parameter.</li>
              <li><strong>Bloch/Fourier expansion in z:</strong> because coefficients are periodic in <span style="font-family:var(--mono)">z</span>.</li>
              <li><strong>Why not full vector EM here?</strong> The requested equations mirror the book’s scalar harmonic formulation; we stay consistent with that framework.</li>
            </ul>
          </div>

          <div class="box" style="margin-top:14px; border-color: rgba(52,211,153,.30); background: rgba(52,211,153,.06)">
            <h3>Assumptions (explicit)</h3>
            <ul style="margin:8px 0 0 18px; color:var(--muted)">
              <li>Time-harmonic field <span style="font-family:var(--mono)">∝ e^{-iωt}</span></li>
              <li>Medium is linear, lossless (for simplicity), and periodic only in <span style="font-family:var(--mono)">z</span></li>
              <li>Weak modulation so a two-wave truncation is meaningful near Bragg</li>
              <li>Conserved transverse wavevector <span style="font-family:var(--mono)">k<sub>x</sub></span> (no x-periodicity)</li>
            </ul>
          </div>

          <div class="box" style="margin-top:14px">
            <h3>Possible approaches (compare)</h3>
            <ul style="margin:8px 0 0 18px; color:var(--muted)">
              <li><strong>Approach A — Direct substitution:</strong> start from the on-axis derivation and replace the 1D wave equation’s “effective wavenumber” by including <span style="font-family:var(--mono)">−k<sub>x</sub><sup>2</sup></span>. <em>Fast</em> and matches the requested “analogous equations”.</li>
              <li><strong>Approach B — Full k-space geometry:</strong> use the Ewald circle/isofrequency surface and Bragg planes; derive phase matching then map to coupled equations. <em>Very physical</em> but longer algebra.</li>
              <li><strong>Approach C — Coupled-mode theory (CMT):</strong> derive differential equations for forward/backward envelopes with off-axis angle. Great for finite gratings, but the question references the harmonic algebraic equations, so it’s slightly off-target.</li>
            </ul>
            <p class="note"><strong>We choose Approach A</strong> because it preserves the exact structure of (7.2-24)–(7.2-28) and clearly shows what changes when <span style="font-family:var(--mono)">k<sub>x</sub>≠0</span>.</p>
          </div>
        </div>
      </section>

      <!-- PART 2 -->
      <section id="p2" style="margin-top:18px">
        <div class="sec-head">
          <h2>PART 2 — Strategy & Tips (roadmap only)</h2>
          <div class="hint">Short plan before the algebra</div>
        </div>
        <div class="content">
          <ol class="steps">
            <li><div class="txt"><strong>Separate the transverse dependence.</strong> Write <span style="font-family:var(--mono)">E(x,z)=U(z)e^{ikx x}</span>. Goal: reduce Helmholtz to a 1D ODE in <span style="font-family:var(--mono)">z</span>. Tool: <span style="font-family:var(--mono)">∂²/∂x² → −k<sub>x</sub>²</span>. Tip: keep <span style="font-family:var(--mono)">k<sub>x</sub></span> constant throughout (it does not get <span style="font-family:var(--mono)">+mg</span> shifts).</div></li>
            <li><div class="txt"><strong>Insert the periodic medium model.</strong> Use the same periodic coefficient used in the reference derivation (e.g., Fourier series with coefficients <span style="font-family:var(--mono)">n_m</span> or equivalent). Goal: prepare for harmonic coupling.</div></li>
            <li><div class="txt"><strong>Use a Bloch-harmonic expansion for U(z).</strong> Write <span style="font-family:var(--mono)">U(z)=∑_m C_m e^{i(K+mg)z}</span>. Goal: convert the ODE into algebraic relations among <span style="font-family:var(--mono)">C_m</span>.</div></li>
            <li><div class="txt"><strong>Derive the off-axis analog of (7.2-24).</strong> Goal: show that the on-axis denominator acquires <span style="font-family:var(--mono)">−k<sub>x</sub>²</span>. Common mistake: replacing <span style="font-family:var(--mono)">K+mg</span> itself—don’t; only the “free-space-like” term changes.</div></li>
            <li><div class="txt"><strong>Identify the resonance/phase-matching condition.</strong> Goal: determine when the denominator becomes small. Physical meaning: which harmonics strongly exchange energy.</div></li>
            <li><div class="txt"><strong>Near the first band edge, keep two harmonics.</strong> Typically <span style="font-family:var(--mono)">m=0</span> and <span style="font-family:var(--mono)">m=-1</span>. Goal: get two equations analogous to (7.2-27).</div></li>
            <li><div class="txt"><strong>Eliminate amplitudes to obtain the dispersion relation.</strong> Goal: a self-consistency equation analogous to (7.2-28), now with <span style="font-family:var(--mono)">k<sub>x</sub></span> included. Tip: check limiting case <span style="font-family:var(--mono)">k<sub>x</sub>→0</span> recovers on-axis.</div></li>
          </ol>
        </div>
      </section>

      <!-- PART 3 -->
      <section id="p3" style="margin-top:18px">
        <div class="sec-head">
          <h2>PART 3 — Full Solution (detailed + teaching)</h2>
          <div class="hint">Derive the off-axis analogs step-by-step</div>
        </div>
        <div class="content">
          <div class="box">
            <h3>Qualitative expectation (before calculating)</h3>
            <p style="margin:8px 0 0; color:var(--muted)">
              In a periodic medium, a bandgap opens when two spatial harmonics become simultaneously “allowed” by the
              dispersion and are strongly coupled by the periodic modulation.
              Off-axis propagation uses a fixed transverse <span style="font-family:var(--mono)">k<sub>x</sub></span>, which reduces the longitudinal component available:
              <span style="font-family:var(--mono)">kz = √[(ω n̄/c)² − kx²]</span>.
              Therefore we expect the Bragg (phase-matching) point to shift in frequency and typically the bandgap to shrink as <span style="font-family:var(--mono)">k<sub>x</sub></span> increases.
            </p>
          </div>

          <!-- Step 1: Helmholtz and separation -->
          <div class="box" style="margin-top:14px">
            <h3>Step 1 — Start from Helmholtz and separate transverse dependence</h3>
            <p class="note">
              We work in the same scalar framework as the referenced equations. Let the field vary as <span style="font-family:var(--mono)">e^{-iωt}</span>.
            </p>
            <div class="equation" id="eq-helm">
              <div class="eq-actions">
                <button class="copy" onclick="copyEq('eq-helm')">Copy</button>
              </div>
              <pre>Helmholtz (scalar):  (∂²/∂x² + ∂²/∂z²) E(x,z) + (ω/c)² n²(z) E(x,z) = 0</pre>
            </div>

            <p class="note">
              Because the structure is invariant in <span style="font-family:var(--mono)">x</span>, choose a plane-wave dependence:
              <span style="font-family:var(--mono)">E(x,z) = U(z) e^{i kx x}</span>.
              Then <span style="font-family:var(--mono)">∂²E/∂x² = −k<sub>x</sub>² E</span>.
            </p>

            <div class="equation" id="eq-1d">
              <div class="eq-actions">
                <button class="copy" onclick="copyEq('eq-1d')">Copy</button>
              </div>
              <pre>1D z-equation (off-axis):
d²U/dz² + [ (ω/c)² n²(z) − kx² ] U(z) = 0</pre>
            </div>

            <p class="note">
              <strong>What changed?</strong> Only the constant subtraction <span style="font-family:var(--mono)">−k<sub>x</sub>²</span>.
              This will propagate through the harmonic algebra exactly as a shift of the “effective longitudinal wavenumber.”
            </p>
          </div>

          <!-- Step 2: Periodic coefficient + Bloch expansion -->
          <div class="box" style="margin-top:14px">
            <h3>Step 2 — Bloch/harmonic expansion in a 1D periodic medium</h3>
            <p style="margin:8px 0 0; color:var(--muted)">
              Let the medium be periodic with period <span style="font-family:var(--mono)">Λ</span> and grating vector <span style="font-family:var(--mono)">g=2π/Λ</span>.
              In the notation consistent with the referenced result, the periodic coupling is represented by Fourier coefficients
              <span style="font-family:var(--mono)">n_m</span> (or equivalently coefficients of the periodic part of the wave equation).
            </p>

            <p class="note">
              Expand the Bloch solution as
              <span style="font-family:var(--mono)">U(z)=∑_m C_m e^{i(K + m g) z}</span>,
              where <span style="font-family:var(--mono)">K</span> is the Bloch wavevector in the first Brillouin zone.
            </p>

            <div class="equation" id="eq-bloch">
              <div class="eq-actions">
                <button class="copy" onclick="copyEq('eq-bloch')">Copy</button>
              </div>
              <pre>Bloch harmonic expansion:
U(z) = Σ_{m=-∞..∞} C_m exp[i (K + m g) z]</pre>
            </div>
          </div>

          <!-- Step 3: Off-axis analog of (7.2-24) -->
          <div class="box" style="margin-top:14px">
            <h3>Step 3 — Off-axis analog of the coupled-harmonic equation (like 7.2-24)</h3>
            <p style="margin:8px 0 0; color:var(--muted)">
              When you substitute the Bloch expansion into the 1D equation, each harmonic produces a factor
              <span style="font-family:var(--mono)">−(K+mg)²</span> from <span style="font-family:var(--mono)">d²/dz²</span>,
              while the “background” propagation term becomes
              <span style="font-family:var(--mono)">(ω n̄/c)² − kx²</span>.
              Therefore every on-axis denominator of the form
              <span style="font-family:var(--mono)">[(ω n̄/c)² − (K+mg)²]</span>
              becomes
              <span style="font-family:var(--mono)">[(ω n̄/c)² − kx² − (K+mg)²]</span>.
            </p>

            <div class="equation" id="eq-724-off">
              <div class="eq-actions">
                <button class="copy" onclick="copyEq('eq-724-off')">Copy</button>
              </div>
              <pre>Off-axis coupled-harmonic equation (analog of 7.2-24):

C_m = Σ_ℓ ( n_{m-ℓ} / n_0 ) * ( (K+ℓ g)(K+m g) )
      ------------------------------------------------ * C_ℓ,     m = 0, ±1, ±2, ...
       [ (ω² n̄² / c²) − kx² − (K+m g)² ]</pre>
            </div>

            <p class="note">
              <strong>What did we do and why?</strong> We used (i) separation in <span style="font-family:var(--mono)">x</span> to introduce a constant <span style="font-family:var(--mono)">kx</span>,
              and (ii) the same Fourier/Bloch projection used in the on-axis derivation.
              The periodic medium still couples harmonics by <span style="font-family:var(--mono)">±g</span>, but <span style="font-family:var(--mono)">kx</span> stays the same for all harmonics.
            </p>

            <div class="box" style="margin-top:12px; border-color: rgba(125,211,252,.25); background: rgba(125,211,252,.06)">
              <h3>Sanity check</h3>
              <ul style="margin:8px 0 0 18px; color:var(--muted)">
                <li>Set <span style="font-family:var(--mono)">kx=0</span> → exactly the on-axis structure returns.</li>
                <li>Units: numerator has <span style="font-family:var(--mono)">K²</span>; denominator has <span style="font-family:var(--mono)">K²</span>. Prefactor <span style="font-family:var(--mono)">n_{m-ℓ}/n0</span> is dimensionless → consistent.</li>
              </ul>
            </div>
          </div>

          <!-- Step 4: Off-axis resonance condition analog of (7.2-25) -->
          <div class="box" style="margin-top:14px">
            <h3>Step 4 — Off-axis phase-matching / resonance condition (like 7.2-25)</h3>
            <p style="margin:8px 0 0; color:var(--muted)">
              Strong coupling occurs when the denominator for some harmonic <span style="font-family:var(--mono)">m</span> is small:
              that means the harmonic’s longitudinal wavenumber matches the available longitudinal propagation in the average medium.
              Define the “average-medium” total wavenumber magnitude
              <span style="font-family:var(--mono)">k̄ = ω n̄ / c</span>.
              Off-axis, the longitudinal component in the average medium is
              <span style="font-family:var(--mono)">k̄z = √(k̄² − kx²)</span>.
            </p>

            <div class="equation" id="eq-725-off">
              <div class="eq-actions">
                <button class="copy" onclick="copyEq('eq-725-off')">Copy</button>
              </div>
              <pre>Off-axis resonance / phase matching (analog of 7.2-25):

√[ (ω² n̄² / c²) − kx² ]  ≈  | K + m g |</pre>
            </div>

            <p class="note">
              <strong>Interpretation:</strong> the periodicity supplies discrete longitudinal momentum shifts <span style="font-family:var(--mono)">m g</span>.
              The transverse momentum <span style="font-family:var(--mono)">kx</span> is conserved, so the “tuning knob” for resonance is the longitudinal budget.
            </p>
          </div>

          <!-- Step 5: Two-wave truncation near the first gap (analogs of 7.2-27 and 7.2-28) -->
          <div class="box" style="margin-top:14px">
            <h3>Step 5 — Two-wave approximation near the first Bragg bandgap (analogs of 7.2-27 and 7.2-28)</h3>
            <p style="margin:8px 0 0; color:var(--muted)">
              Near the first band edge, the strongest interaction is typically between the <span style="font-family:var(--mono)">m=0</span> harmonic
              with longitudinal factor <span style="font-family:var(--mono)">e^{iKz}</span> and the <span style="font-family:var(--mono)">m=-1</span> harmonic
              with factor <span style="font-family:var(--mono)">e^{i(K-g)z}</span>.
              This corresponds to Bragg scattering between two counter-propagating (or nearly counter-propagating) longitudinal components.
            </p>

            <p class="note">
              Keeping only <span style="font-family:var(--mono)">C_0</span> and <span style="font-family:var(--mono)">C_{-1}</span> yields two linear equations.
              Solving one for <span style="font-family:var(--mono)">C_{-1}</span> in terms of <span style="font-family:var(--mono)">C_0</span> gives the analog of (7.2-27),
              with the denominator modified by <span style="font-family:var(--mono)">−kx²</span>.
            </p>

            <div class="equation" id="eq-727-off">
              <div class="eq-actions">
                <button class="copy" onclick="copyEq('eq-727-off')">Copy</button>
              </div>
              <pre>Off-axis two-wave amplitude relation (analog of 7.2-27):

C_{-1} = ( n_1* i / n_0 ) * [ K (K − g) ]
         ---------------------------------------------  * C_0
         [ (ω² n̄² / c²) − kx² − (K − g)² ]</pre>
            </div>

            <p class="note">
              (Here we used the same book convention that leads to the factor <span style="font-family:var(--mono)">n_1* i</span> and <span style="font-family:var(--mono)">n_{-1}=n_1*</span>.)
              The exact prefactors depend on how the periodic coefficient is written; the <strong>structural off-axis change</strong> is the added <span style="font-family:var(--mono)">−kx²</span> in the denominator.
            </p>

            <p style="margin:10px 0 0; color:var(--muted)">
              The two-wave system is self-consistent only if its determinant is zero, which produces the bandgap dispersion relation.
              The on-axis (7.2-28) becomes:
            </p>

            <div class="equation" id="eq-728-off">
              <div class="eq-actions">
                <button class="copy" onclick="copyEq('eq-728-off')">Copy</button>
              </div>
              <pre>Off-axis bandgap dispersion (analog of 7.2-28):

(|n1|² / n0²) * K² (K − g)²
= [ (ω² n̄² / c²) − kx² − K² ] * [ (ω² n̄² / c²) − kx² − (K − g)² ]</pre>
            </div>

            <div class="box" style="margin-top:12px; border-color: rgba(52,211,153,.28); background: rgba(52,211,153,.06)">
              <h3>Sanity checks (very important)</h3>
              <ul style="margin:8px 0 0 18px; color:var(--muted)">
                <li><strong>On-axis limit:</strong> set <span style="font-family:var(--mono)">kx=0</span> → recovers the given (7.2-28).</li>
                <li><strong>Dimensional consistency:</strong> every bracket has units of <span style="font-family:var(--mono)">K²</span>. LHS also scales as <span style="font-family:var(--mono)">K⁴</span>. Good.</li>
                <li><strong>Physical limit:</strong> if <span style="font-family:var(--mono)">kx</span> becomes so large that <span style="font-family:var(--mono)">(ω n̄/c)² − kx²</span> is small or negative, there is no propagating longitudinal component → no Bragg propagation picture.</li>
              </ul>
            </div>

            <div class="equation" id="eq-final-answer" style="margin-top:14px; border-style: solid;">
              <div class="eq-actions">
                <button class="copy" onclick="copyEq('eq-final-answer')">Copy</button>
              </div>
              <pre><strong>FINAL ANSWER (collected off-axis analogs)</strong>

(1) Coupled harmonics:
C_m = Σ_ℓ ( n_{m-ℓ} / n_0 ) * ( (K+ℓ g)(K+m g) ) / [ (ω² n̄²/c²) − kx² − (K+m g)² ] * C_ℓ

(2) Resonance / phase matching:
√[(ω² n̄²/c²) − kx²] ≈ |K + m g|

(3) Two-wave relation (m=0,−1):
C_{−1} = ( n_1* i / n_0 ) * K(K−g) / [ (ω² n̄²/c²) − kx² − (K−g)² ] * C_0

(4) Dispersion (bandgap) condition:
(|n1|²/n0²) K² (K−g)² = [ (ω² n̄²/c²) − kx² − K² ] [ (ω² n̄²/c²) − kx² − (K−g)² ]</pre>
            </div>
          </div>

          <div class="box" style="margin-top:14px">
            <h3>Connect to the geometry (diagram + plots)</h3>
            <p style="margin:8px 0 0; color:var(--muted)">
              The diagram shows the wavevector split into <span style="font-family:var(--mono)">k<sub>x</sub></span> and longitudinal components.
              The periodic medium supplies only longitudinal momentum kicks <span style="font-family:var(--mono)">±g</span>, so the “meeting point” for strong coupling is controlled by the
              longitudinal isofrequency condition <span style="font-family:var(--mono)">k̄z ≈ |K + m g|</span>.
              In the plots, increasing <span style="font-family:var(--mono)">k<sub>x</sub></span> moves the system away from the Bragg plane and reduces the gap.
            </p>
          </div>
        </div>
      </section>

      <!-- PART 4 -->
      <section id="p4" style="margin-top:18px">
        <div class="sec-head">
          <h2>PART 4 — Deeper Understanding (theory around the result)</h2>
          <div class="hint">Interpretation, parameter effects, and checks</div>
        </div>
        <div class="content">
          <div class="grid2">
            <div class="box">
              <h3>Re-interpreting the bandgap formula</h3>
              <p style="margin:8px 0 0; color:var(--muted)">
                Define the “effective longitudinal squared wavenumber”
                <span style="font-family:var(--mono)">A ≡ (ω² n̄²/c²) − kx²</span>.
                Then the dispersion condition is identical in form to the on-axis one, with
                <span style="font-family:var(--mono)">A</span> replacing <span style="font-family:var(--mono)">(ω² n̄²/c²)</span>.
              </p>
              <div class="equation" id="eq-Adef">
                <div class="eq-actions">
                  <button class="copy" onclick="copyEq('eq-Adef')">Copy</button>
                </div>
                <pre>A ≡ (ω² n̄²/c²) − kx²

(|n1|²/n0²) K² (K−g)² = (A − K²)(A − (K−g)²)</pre>
              </div>
              <p class="note">
                <strong>Meaning:</strong> off-axis propagation reduces the “available” longitudinal wavenumber, so the same periodic coupling produces a smaller frequency splitting.
              </p>
            </div>

            <div class="box">
              <h3>How parameters affect the outcome (linked to plots)</h3>
              <ul style="margin:8px 0 0 18px; color:var(--muted)">
                <li><strong>Increase</strong> <span style="font-family:var(--mono)">kx</span> → decreases <span style="font-family:var(--mono)">A</span> for a given <span style="font-family:var(--mono)">ω</span> → shifts band edges upward in frequency and typically <strong>narrows</strong> the gap at a fixed <span style="font-family:var(--mono)">K</span> near <span style="font-family:var(--mono)">g/2</span>.</li>
                <li><strong>Increase</strong> coupling strength <span style="font-family:var(--mono)">|n1|/n0</span> → increases splitting between the two branches (larger bandgap).</li>
                <li><strong>Change</strong> <span style="font-family:var(--mono)">g</span> (period) → moves the Brillouin zone boundary <span style="font-family:var(--mono)">K=g/2</span> and therefore the Bragg condition.</li>
              </ul>
            </div>
          </div>

          <div class="box" style="margin-top:14px">
            <h3>Alternative derivation idea (brief)</h3>
            <p style="margin:8px 0 0; color:var(--muted)">
              In reciprocal space, consider the isofrequency circle (in 2D <span style="font-family:var(--mono)">k</span>-space) of radius <span style="font-family:var(--mono)">k̄=ω n̄/c</span>.
              The periodicity creates Bragg planes at <span style="font-family:var(--mono)">kz = ±g/2</span>.
              Off-axis means you fix <span style="font-family:var(--mono)">kx</span>, so you intersect the circle at a smaller <span style="font-family:var(--mono)">kz</span>, changing where the intersection meets the Bragg plane.
              Turning this geometric condition into algebra yields the same phase-matching condition
              <span style="font-family:var(--mono)">√(k̄²−kx²) ≈ |K+mg|</span> and the same two-wave gap equation.
            </p>
          </div>

          <div class="box" style="margin-top:14px; border-color: rgba(251,113,133,.28); background: rgba(251,113,133,.06)">
            <h3>Concept checks (quick self-test)</h3>
            <ul style="margin:8px 0 0 18px; color:var(--muted)">
              <li><strong>Q:</strong> Why doesn’t <span style="font-family:var(--mono)">kx</span> become <span style="font-family:var(--mono)">kx+mg</span> for different harmonics? <br><strong>A:</strong> The medium is periodic only in <span style="font-family:var(--mono)">z</span>, so it supplies only <span style="font-family:var(--mono)">z</span>-momentum kicks; translational symmetry in <span style="font-family:var(--mono)">x</span> conserves <span style="font-family:var(--mono)">kx</span>.</li>
              <li><strong>Q:</strong> What happens to the bandgap as the incidence angle increases? <br><strong>A:</strong> Increasing angle increases <span style="font-family:var(--mono)">kx</span>, reduces longitudinal component, and tends to narrow (and shift) the gap—see the slider.</li>
              <li><strong>Q:</strong> Does the off-axis modification change the coupling numerator <span style="font-family:var(--mono)">(K+ℓg)(K+mg)</span>? <br><strong>A:</strong> Not in this scalar harmonic framework; the change enters as <span style="font-family:var(--mono)">−kx²</span> in the “free propagation” term.</li>
              <li><strong>Q:</strong> What limiting case must your final equations satisfy? <br><strong>A:</strong> Setting <span style="font-family:var(--mono)">kx→0</span> must reproduce the on-axis results.</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- PART 5 + Visualizations -->
      <section id="p5" style="margin-top:18px">
        <div class="sec-head">
          <h2>PART 5 — Visualization Guide (how to read the plots)</h2>
          <div class="hint">Interactive: change kx and watch everything update</div>
        </div>
        <div class="content">
          <div class="vizWrap">
            <div class="panel">
              <div class="ph">
                <strong>Diagram: Off-axis wave in a 1D periodic medium</strong>
                <span>geometry + k-components</span>
              </div>
              <div class="canvasBox">
                <canvas id="cDiagram" aria-label="Diagram canvas"></canvas>
              </div>
            </div>

            <div class="panel">
              <div class="ph">
                <strong>Main plot: Band-edge dispersion near Bragg</strong>
                <span>from off-axis analog of (7.2-28)</span>
              </div>
              <div class="canvasBox">
                <canvas id="cMain" aria-label="Main plot canvas"></canvas>
              </div>
            </div>

            <div class="panel" style="grid-column: 1 / -1;">
              <div class="ph">
                <strong>Secondary plot: k-space picture (isofrequency circle & Bragg plane)</strong>
                <span>phase-matching intuition</span>
              </div>
              <div class="canvasBox">
                <canvas id="cSecondary" aria-label="Secondary plot canvas"></canvas>
              </div>
            </div>
          </div>

          <div class="controls">
            <div class="ctrlCard">
              <div class="row">
                <div style="flex:1 1 260px; min-width:220px;">
                  <label for="kxSlider"><strong>Interactive control:</strong> transverse ratio <span style="font-family:var(--mono)">k<sub>x</sub>/g</span></label>
                  <input id="kxSlider" type="range" min="0" max="0.9" step="0.001" value="0.15" />
                </div>
                <div class="readout" id="readoutKx">kx/g = 0.150</div>
              </div>
              <p class="note">
                Increasing <span style="font-family:var(--mono)">k<sub>x</sub></span> reduces longitudinal propagation, shifting the dispersion curves upward and narrowing the bandgap near <span style="font-family:var(--mono)">K≈g/2</span>.
              </p>
            </div>

            <div class="ctrlCard">
              <div class="row">
                <label for="couplingSel">Example coupling strength <span style="font-family:var(--mono)">|n1|/n0</span></label>
                <select id="couplingSel">
                  <option value="0.01">0.01 (very weak)</option>
                  <option value="0.03" selected>0.03 (weak)</option>
                  <option value="0.06">0.06 (moderate)</option>
                </select>
              </div>
              <p class="note">
                This is an <strong>example value for plotting</strong> (symbolic results above stay general). Larger coupling opens a wider gap.
              </p>
            </div>
          </div>

          <div class="box" style="margin-top:14px">
            <h3>How to read each canvas</h3>
            <ul style="margin:8px 0 0 18px; color:var(--muted)">
              <li><strong>Diagram:</strong> shows the periodic index along <span style="font-family:var(--mono)">z</span>, and the wavevector split into <span style="font-family:var(--mono)">kx</span> and longitudinal component. Only the <span style="font-family:var(--mono)">z</span>-component couples via <span style="font-family:var(--mono)">±g</span>.</li>
              <li><strong>Main plot:</strong> plots normalized frequency <span style="font-family:var(--mono)">Ω = ω n̄/(c g)</span> vs normalized Bloch wavevector <span style="font-family:var(--mono)">K/g</span>. Two branches appear near <span style="font-family:var(--mono)">K≈0.5g</span>, representing the split band edges.</li>
              <li><strong>Secondary plot:</strong> shows the isofrequency circle in (<span style="font-family:var(--mono)">kx/g</span>, <span style="font-family:var(--mono)">kz/g</span>) and the Bragg plane at <span style="font-family:var(--mono)">kz/g=0.5</span>. As you increase <span style="font-family:var(--mono)">kx/g</span>, the intersection point shifts to smaller <span style="font-family:var(--mono)">kz</span>, moving away from the Bragg plane.</li>
            </ul>
          </div>

        </div>
      </section>
    </div>
  </div>
</main>

<footer>
  Built as a self-contained learning article (vanilla HTML/CSS/JS). Copy buttons export plain text equations. Plots use example parameters for visualization only.
</footer>

<script>
  // ---------- Utilities ----------
  function copyEq(eqId){
    const el = document.querySelector('#'+eqId+' pre');
    const txt = el ? el.innerText : '';
    if(!navigator.clipboard){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = txt;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand('copy'); }catch(e){}
      document.body.removeChild(ta);
      return;
    }
    navigator.clipboard.writeText(txt);
  }

  function niceTickStep(span){
    // simple nice-step for grid/ticks
    const raw = span / 6;
    const p = Math.pow(10, Math.floor(Math.log10(raw)));
    const m = raw / p;
    let s = 1;
    if(m < 1.5) s = 1;
    else if(m < 3) s = 2;
    else if(m < 7) s = 5;
    else s = 10;
    return s * p;
  }

  function setupHiDPI(canvas){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(10, Math.floor(rect.width * dpr));
    const h = Math.max(10, Math.floor(rect.height * dpr));
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w; canvas.height = h;
    }
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
    return {ctx, w: rect.width, h: rect.height, dpr};
  }

  function drawAxes(ctx, x0,y0,w,h, xMin,xMax,yMin,yMax, xLabel,yLabel, title){
    // background
    ctx.save();
    ctx.clearRect(0,0,w,h);
    // panel frame already exists on canvas; draw interior
    const padL=54, padR=16, padT=38, padB=44;
    const ix = x0 + padL, iy = y0 + padT, iw = w - padL - padR, ih = h - padT - padB;

    // title
    ctx.fillStyle = 'rgba(233,238,252,.92)';
    ctx.font = '600 13px ui-sans-serif, system-ui';
    ctx.fillText(title, ix, y0 + 22);

    // grid + ticks
    ctx.strokeStyle = 'rgba(255,255,255,.10)';
    ctx.lineWidth = 1;

    const xSpan = xMax-xMin, ySpan = yMax-yMin;
    const xStep = niceTickStep(xSpan);
    const yStep = niceTickStep(ySpan);

    // vertical grid
    for(let xv = Math.ceil(xMin/xStep)*xStep; xv <= xMax + 1e-12; xv += xStep){
      const X = ix + (xv-xMin)/xSpan * iw;
      ctx.beginPath(); ctx.moveTo(X, iy); ctx.lineTo(X, iy+ih); ctx.stroke();
    }
    // horizontal grid
    for(let yv = Math.ceil(yMin/yStep)*yStep; yv <= yMax + 1e-12; yv += yStep){
      const Y = iy+ih - (yv-yMin)/ySpan * ih;
      ctx.beginPath(); ctx.moveTo(ix, Y); ctx.lineTo(ix+iw, Y); ctx.stroke();
    }

    // axes box
    ctx.strokeStyle = 'rgba(255,255,255,.22)';
    ctx.strokeRect(ix, iy, iw, ih);

    // tick labels
    ctx.fillStyle = 'rgba(184,195,238,.95)';
    ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

    for(let xv = Math.ceil(xMin/xStep)*xStep; xv <= xMax + 1e-12; xv += xStep){
      const X = ix + (xv-xMin)/xSpan * iw;
      ctx.fillText(xv.toFixed(2), X-16, iy+ih+18);
    }
    for(let yv = Math.ceil(yMin/yStep)*yStep; yv <= yMax + 1e-12; yv += yStep){
      const Y = iy+ih - (yv-yMin)/ySpan * ih;
      ctx.fillText(yv.toFixed(2), ix-46, Y+4);
    }

    // labels
    ctx.fillStyle = 'rgba(184,195,238,.95)';
    ctx.font = '600 12px ui-sans-serif, system-ui';
    ctx.fillText(xLabel, ix + iw/2 - ctx.measureText(xLabel).width/2, y0 + h - 12);

    // y label rotated
    ctx.save();
    ctx.translate(x0 + 16, iy + ih/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
    ctx.restore();

    ctx.restore();
    return {ix,iy,iw,ih};
  }

  function mapX(ix,iw,xMin,xMax,x){ return ix + (x-xMin)/(xMax-xMin)*iw; }
  function mapY(iy,ih,yMin,yMax,y){ return iy+ih - (y-yMin)/(yMax-yMin)*ih; }

  // ---------- Physics model for plots ----------
  // We plot the two-wave dispersion derived from:
  // (|n1|^2/n0^2) K^2 (K-g)^2 = [Ω^2 - kx^2 - K^2][Ω^2 - kx^2 - (K-g)^2]
  // where Ω = ω nbar/(c g) is normalized frequency, and kx, K are normalized by g.
  function dispersionBranches(K, kx, gamma){
    // gamma = (|n1|/n0)^2
    // Let A = Ω^2 - kx^2
    const S = K*K + (K-1)*(K-1); // since g normalized to 1, (K-g)=K-1
    const P = K*K*(K-1)*(K-1);
    // equation: P*gamma = (A-K^2)(A-(K-1)^2) = A^2 - A*S + P
    // => A^2 - A*S + P*(1-gamma) = 0
    const disc = S*S - 4*P*(1-gamma);
    if(disc < 0) return null;
    const sqrtD = Math.sqrt(disc);
    const A1 = 0.5*(S + sqrtD);
    const A2 = 0.5*(S - sqrtD);
    const Om1sq = A1 + kx*kx;
    const Om2sq = A2 + kx*kx;
    if(Om1sq <= 0 || Om2sq <= 0) return null;
    return [Math.sqrt(Om1sq), Math.sqrt(Om2sq)]; // Ω branches
  }

  // ---------- Drawing: Diagram ----------
  function drawDiagram(canvas, kxRatio){
    const {ctx, w, h} = setupHiDPI(canvas);
    ctx.clearRect(0,0,w,h);

    // Frame
    const pad=14;
    const x0=pad, y0=pad, W=w-2*pad, H=h-2*pad;

    // Title
    ctx.fillStyle = 'rgba(233,238,252,.92)';
    ctx.font = '600 13px ui-sans-serif, system-ui';
    ctx.fillText('Off-axis incidence: conserved kx, Bragg coupling in z only', x0+10, y0+18);

    // Axes
    const ox = x0+70, oy = y0+H-60;
    ctx.strokeStyle = 'rgba(255,255,255,.25)';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(ox, oy);
    ctx.lineTo(ox+W-110, oy); // x axis
    ctx.moveTo(ox, oy);
    ctx.lineTo(ox, y0+50); // z axis
    ctx.stroke();

    ctx.fillStyle='rgba(184,195,238,.95)';
    ctx.font='600 12px ui-sans-serif, system-ui';
    ctx.fillText('x', ox+W-118, oy-8);
    ctx.fillText('z', ox-14, y0+56);

    // Periodic index along z: draw sinusoidal band
    const bandX0 = ox+28, bandX1 = ox+W-140;
    const zTop = y0+58, zBot = oy-18;
    ctx.strokeStyle='rgba(125,211,252,.30)';
    ctx.lineWidth=1.2;
    for(let i=0;i<6;i++){
      const y = zTop + (i/5)*(zBot-zTop);
      ctx.beginPath();
      ctx.moveTo(bandX0, y);
      ctx.lineTo(bandX1, y);
      ctx.stroke();
    }
    // draw periodic "stripes" to suggest 1D periodicity
    ctx.strokeStyle='rgba(255,255,255,.12)';
    for(let k=0;k<18;k++){
      const zz = zTop + (k/17)*(zBot-zTop);
      const x = bandX0 + 8*Math.sin(2*Math.PI*zz/55);
      ctx.beginPath();
      ctx.moveTo(x, zz);
      ctx.lineTo(x+ (bandX1-bandX0), zz);
      ctx.stroke();
    }
    ctx.fillStyle='rgba(184,195,238,.95)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText('1D periodic medium: n(z), grating vector g along z', bandX0, zTop-10);

    // Wavevector arrow
    // Choose a normalized magnitude for drawing
    const kMag = 1.0;
    const kx = kxRatio; // normalized to g for illustration
    const kz = Math.sqrt(Math.max(0, kMag*kMag - kx*kx)); // illustrative
    const scale = 110;
    const vx = kx * scale;
    const vz = kz * scale;

    const startX = ox+26, startY = oy-6;
    const endX = startX + vx;
    const endY = startY - vz;

    function arrow(x1,y1,x2,y2, color){
      ctx.strokeStyle=color;
      ctx.lineWidth=2.2;
      ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      const ang = Math.atan2(y2-y1, x2-x1);
      const ah=10;
      ctx.beginPath();
      ctx.moveTo(x2,y2);
      ctx.lineTo(x2 - ah*Math.cos(ang-Math.PI/7), y2 - ah*Math.sin(ang-Math.PI/7));
      ctx.lineTo(x2 - ah*Math.cos(ang+Math.PI/7), y2 - ah*Math.sin(ang+Math.PI/7));
      ctx.closePath();
      ctx.fillStyle=color;
      ctx.fill();
    }

    arrow(startX,startY,endX,endY,'rgba(167,243,208,.90)');

    // Components
    ctx.setLineDash([6,6]);
    ctx.strokeStyle='rgba(167,243,208,.50)';
    ctx.lineWidth=1.5;
    ctx.beginPath();
    ctx.moveTo(startX,startY); ctx.lineTo(endX,startY); ctx.stroke(); // kx
    ctx.beginPath();
    ctx.moveTo(endX,startY); ctx.lineTo(endX,endY); ctx.stroke(); // kz
    ctx.setLineDash([]);

    ctx.fillStyle='rgba(233,238,252,.92)';
    ctx.font='600 12px ui-sans-serif, system-ui';
    ctx.fillText('k', endX+6, endY-4);
    ctx.fillStyle='rgba(184,195,238,.95)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText('kx (conserved)', (startX+endX)/2 - 22, startY+16);
    ctx.fillText('kz ≈ √(k̄²−kx²)', endX+8, (startY+endY)/2);

    // Bragg note
    ctx.fillStyle='rgba(184,195,238,.95)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText('Bragg coupling shifts kz by ±g', ox+W-315, oy-12);

    // Small badge with current kx/g
    ctx.fillStyle='rgba(125,211,252,.10)';
    ctx.strokeStyle='rgba(125,211,252,.35)';
    ctx.lineWidth=1;
    const bx=ox+W-240, by=y0+28, bw=220, bh=26;
    ctx.beginPath();
    roundRect(ctx,bx,by,bw,bh,10);
    ctx.fill(); ctx.stroke();
    ctx.fillStyle='rgba(233,238,252,.92)';
    ctx.font='600 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    ctx.fillText(`kx/g = ${kxRatio.toFixed(3)}  (example geometry)`, bx+10, by+17);

    function roundRect(ctx,x,y,w,h,r){
      const rr=Math.min(r,w/2,h/2);
      ctx.moveTo(x+rr,y);
      ctx.arcTo(x+w,y,x+w,y+h,rr);
      ctx.arcTo(x+w,y+h,x,y+h,rr);
      ctx.arcTo(x,y+h,x,y,rr);
      ctx.arcTo(x,y,x+w,y,rr);
      ctx.closePath();
    }
  }

  // ---------- Drawing: Main dispersion plot ----------
  function drawMain(canvas, kxRatio, gamma){
    const {ctx, w, h} = setupHiDPI(canvas);

    // axes ranges (normalized)
    const xMin = 0.20, xMax = 0.80;   // K/g around 0.5
    // y range depends on kx; choose a conservative range
    const yMin = 0.10, yMax = 0.95;

    const box = drawAxes(
      ctx, 0,0,w,h,
      xMin,xMax,yMin,yMax,
      "K/g (Bloch wavevector, normalized)",
      "Ω = ω n̄/(c g) (normalized)",
      "Two-wave dispersion near first band edge"
    );
    const {ix,iy,iw,ih} = box;

    // Plot the two branches
    const N = 420;
    const pts1=[], pts2=[];
    for(let i=0;i<=N;i++){
      const K = xMin + (xMax-xMin)*i/N;
      const br = dispersionBranches(K, kxRatio, gamma);
      if(!br) continue;
      const yA = Math.max(br[0], br[1]);
      const yB = Math.min(br[0], br[1]);
      pts1.push([K,yA]);
      pts2.push([K,yB]);
    }

    function strokePath(pts, color){
      ctx.strokeStyle=color;
      ctx.lineWidth=2.2;
      ctx.beginPath();
      let started=false;
      for(const [K,Om] of pts){
        const X = mapX(ix,iw,xMin,xMax,K);
        const Y = mapY(iy,ih,yMin,yMax,Om);
        if(!started){ ctx.moveTo(X,Y); started=true; }
        else ctx.lineTo(X,Y);
      }
      ctx.stroke();
    }

    // Colors (kept minimal but necessary)
    strokePath(pts1,'rgba(167,243,208,.92)');
    strokePath(pts2,'rgba(125,211,252,.92)');

    // Brillouin boundary marker at K=0.5
    const Kb=0.5;
    ctx.strokeStyle='rgba(255,255,255,.25)';
    ctx.lineWidth=1.2;
    ctx.setLineDash([5,6]);
    const Xb = mapX(ix,iw,xMin,xMax,Kb);
    ctx.beginPath(); ctx.moveTo(Xb,iy); ctx.lineTo(Xb,iy+ih); ctx.stroke();
    ctx.setLineDash([]);

    // Legend
    ctx.fillStyle='rgba(233,238,252,.92)';
    ctx.font='600 12px ui-sans-serif, system-ui';
    ctx.fillText('Legend', ix+iw-90, iy+18);

    ctx.fillStyle='rgba(167,243,208,.92)';
    ctx.fillRect(ix+iw-90, iy+26, 14, 4);
    ctx.fillStyle='rgba(184,195,238,.95)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText('Upper branch', ix+iw-70, iy+32);

    ctx.fillStyle='rgba(125,211,252,.92)';
    ctx.fillRect(ix+iw-90, iy+44, 14, 4);
    ctx.fillStyle='rgba(184,195,238,.95)';
    ctx.fillText('Lower branch', ix+iw-70, iy+50);

    // Annotate gap at K=0.5 (if possible)
    const brEdge = dispersionBranches(Kb, kxRatio, gamma);
    if(brEdge){
      const yHi = Math.max(brEdge[0], brEdge[1]);
      const yLo = Math.min(brEdge[0], brEdge[1]);
      const Yhi = mapY(iy,ih,yMin,yMax,yHi);
      const Ylo = mapY(iy,ih,yMin,yMax,yLo);
      ctx.strokeStyle='rgba(251,191,36,.85)';
      ctx.lineWidth=2;
      ctx.beginPath(); ctx.moveTo(Xb+10,Yhi); ctx.lineTo(Xb+10,Ylo); ctx.stroke();

      ctx.fillStyle='rgba(251,191,36,.92)';
      ctx.font='600 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(`ΔΩ @ K=g/2 ≈ ${(yHi-yLo).toFixed(3)}`, Xb+16, (Yhi+Ylo)/2 + 4);
    }

    // Caption line (kx)
    ctx.fillStyle='rgba(184,195,238,.95)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText(`Example: kx/g=${kxRatio.toFixed(3)},  |n1|/n0=${Math.sqrt(gamma).toFixed(3)}`, ix, iy+ih+36);
  }

  // ---------- Drawing: Secondary k-space visualization ----------
  function drawSecondary(canvas, kxRatio, gamma){
    const {ctx, w, h} = setupHiDPI(canvas);

    // axes in k-space: x axis = kx/g, y axis = kz/g
    const xMin=-1.0, xMax=1.0;
    const yMin=0.0, yMax=1.2;
    const box = drawAxes(
      ctx, 0,0,w,h,
      xMin,xMax,yMin,yMax,
      "kx/g (transverse)",
      "kz/g (longitudinal)",
      "Isofrequency circle + Bragg plane (k-space intuition)"
    );
    const {ix,iy,iw,ih} = box;

    // Choose a representative normalized frequency Ωref from the dispersion at K=0.5
    // We'll pick the midpoint between the two branches if available; else a default.
    const br = dispersionBranches(0.5, kxRatio, gamma);
    let OmRef = 0.65;
    if(br){
      OmRef = 0.5*(br[0]+br[1]);
    }

    // Isofrequency circle: kx^2 + kz^2 = Ω^2
    ctx.strokeStyle='rgba(167,243,208,.55)';
    ctx.lineWidth=2;
    ctx.beginPath();
    const M=360;
    for(let i=0;i<=M;i++){
      const t = (i/M)*Math.PI; // upper half only (kz>=0)
      const kx = OmRef*Math.cos(t);
      const kz = OmRef*Math.sin(t);
      const X = mapX(ix,iw,xMin,xMax,kx);
      const Y = mapY(iy,ih,yMin,yMax,kz);
      if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
    }
    ctx.stroke();

    // Bragg plane line kz=0.5
    ctx.strokeStyle='rgba(125,211,252,.70)';
    ctx.lineWidth=2;
    ctx.setLineDash([6,6]);
    const yB = mapY(iy,ih,yMin,yMax,0.5);
    ctx.beginPath(); ctx.moveTo(ix,yB); ctx.lineTo(ix+iw,yB); ctx.stroke();
    ctx.setLineDash([]);

    // Point representing current kx and corresponding kz on the circle (if possible)
    const kzPt = Math.sqrt(Math.max(0, OmRef*OmRef - kxRatio*kxRatio));
    const Xp = mapX(ix,iw,xMin,xMax,kxRatio);
    const Yp = mapY(iy,ih,yMin,yMax,kzPt);

    // draw point
    ctx.fillStyle='rgba(251,191,36,.95)';
    ctx.beginPath(); ctx.arc(Xp,Yp,5.2,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,.35)';
    ctx.lineWidth=2;
    ctx.stroke();

    // vertical guide
    ctx.strokeStyle='rgba(251,191,36,.35)';
    ctx.lineWidth=1.5;
    ctx.beginPath();
    ctx.moveTo(Xp, mapY(iy,ih,yMin,yMax,0));
    ctx.lineTo(Xp, Yp);
    ctx.stroke();

    // labels
    ctx.fillStyle='rgba(184,195,238,.95)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText(`Isofrequency: kx²+kz² = Ω²,  Ω≈${OmRef.toFixed(3)}`, ix, iy+ih+36);
    ctx.fillText(`Bragg plane: kz/g = 0.5`, ix+iw-160, yB-8);

    ctx.fillStyle='rgba(233,238,252,.92)';
    ctx.font='600 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    ctx.fillText(`Point: (kx/g, kz/g)=(${kxRatio.toFixed(3)}, ${kzPt.toFixed(3)})`, Xp+10, Yp-10);

    // small note: when kz approaches 0.5, phase matching
    const dist = Math.abs(kzPt - 0.5);
    ctx.fillStyle='rgba(184,195,238,.95)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText(`Distance to Bragg plane: |kz/g − 0.5| ≈ ${dist.toFixed(3)}`, ix, iy+20);
  }

  // ---------- Controller ----------
  const kxSlider = document.getElementById('kxSlider');
  const couplingSel = document.getElementById('couplingSel');
  const readoutKx = document.getElementById('readoutKx');

  const cDiagram = document.getElementById('cDiagram');
  const cMain = document.getElementById('cMain');
  const cSecondary = document.getElementById('cSecondary');

  function renderAll(){
    const kxRatio = parseFloat(kxSlider.value);
    const n1over = parseFloat(couplingSel.value);
    const gamma = n1over*n1over; // (|n1|/n0)^2
    readoutKx.textContent = `kx/g = ${kxRatio.toFixed(3)}`;

    drawDiagram(cDiagram, kxRatio);
    drawMain(cMain, kxRatio, gamma);
    drawSecondary(cSecondary, kxRatio, gamma);
  }

  // responsive redraw
  let resizeTimer=null;
  function onResize(){
    clearTimeout(resizeTimer);
    resizeTimer=setTimeout(renderAll, 60);
  }
  window.addEventListener('resize', onResize);

  kxSlider.addEventListener('input', renderAll);
  couplingSel.addEventListener('change', renderAll);

  // initial
  renderAll();
</script>
</body>
</html>
