<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>1D Photonic Crystal: Bragg Frequency & Gap–Midgap Ratio (Fourier Optics Approach)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#0f1833;
      --card2:#0c142c;
      --ink:#eaf0ff;
      --muted:#b9c4e6;
      --faint:#7f8bb6;
      --accent:#7cf0ff;
      --accent2:#b7ff7c;
      --warn:#ffd27c;
      --bad:#ff7c9a;
      --line:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(124,240,255,.14), transparent 60%),
        radial-gradient(1000px 600px at 80% 20%, rgba(183,255,124,.10), transparent 55%),
        radial-gradient(900px 600px at 50% 90%, rgba(255,210,124,.08), transparent 60%),
        linear-gradient(180deg, #070a16 0%, #0b1020 45%, #070a16 100%);
      line-height:1.55;
    }
    header{
      padding:28px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }
    header .top{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:16px;
      align-items:start;
    }
    h1{
      font-size: clamp(1.6rem, 2.4vw, 2.35rem);
      margin:0 0 10px 0;
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      max-width:70ch;
    }
    .meta{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px 14px;
      box-shadow: var(--shadow);
    }
    .meta .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
    .pill{
      font-size:.86rem;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      white-space:nowrap;
    }
    .pill b{color:var(--ink); font-weight:650}
    main{
      max-width:1200px;
      margin:0 auto;
      padding: 10px 18px 60px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      align-items:start;
    }
    nav#toc{
      position: sticky;
      top: 14px;
      align-self:start;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    nav#toc h2{
      font-size: 1rem;
      margin:0 0 10px 0;
      color: var(--ink);
      letter-spacing:.3px;
    }
    .toc-list{
      list-style:none;
      padding:0;
      margin:0;
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .toc-list a{
      text-decoration:none;
      color: var(--muted);
      border:1px solid transparent;
      padding:8px 10px;
      border-radius: 12px;
      display:block;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-size:.95rem;
    }
    .toc-list a:hover{
      background: rgba(124,240,255,.08);
      border-color: rgba(124,240,255,.18);
      transform: translateX(2px);
      color: var(--ink);
    }

    .content{
      display:flex;
      flex-direction:column;
      gap:18px;
      min-width:0;
    }
    section{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px 18px;
      box-shadow: var(--shadow);
    }
    section h2{
      margin:0 0 10px 0;
      font-size: 1.25rem;
      letter-spacing:.2px;
    }
    section h3{
      margin:16px 0 8px 0;
      font-size:1.05rem;
      color: var(--ink);
    }
    p{margin: 8px 0; color: var(--muted)}
    ul{margin:8px 0 0 18px; color: var(--muted)}
    li{margin:6px 0}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
      align-items:start;
    }
    .callout{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(0,0,0,.18);
    }
    .callout h4{
      margin:0 0 6px 0;
      font-size:.95rem;
      color: var(--ink);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .badge{
      width:10px; height:10px; border-radius:99px; display:inline-block;
      background: var(--accent);
      box-shadow: 0 0 0 4px rgba(124,240,255,.12);
    }
    .badge.warn{background: var(--warn); box-shadow:0 0 0 4px rgba(255,210,124,.12)}
    .badge.good{background: var(--accent2); box-shadow:0 0 0 4px rgba(183,255,124,.12)}
    .badge.bad{background: var(--bad); box-shadow:0 0 0 4px rgba(255,124,154,.12)}
    .eq{
      font-family: var(--mono);
      color: var(--ink);
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      padding: 10px 10px;
      border-radius: 14px;
      overflow:auto;
      position:relative;
    }
    .eq .copyBtn{
      position:absolute;
      right:8px;
      top:8px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      color: var(--ink);
      padding:6px 9px;
      border-radius: 12px;
      cursor:pointer;
      font-size:.82rem;
      transition: transform .12s ease, background .12s ease;
    }
    .eq .copyBtn:hover{transform: translateY(-1px); background: rgba(124,240,255,.10)}
    .small{font-size:.92rem; color: var(--muted)}
    .note{color: var(--faint); font-size:.92rem}
    .divider{
      height:1px;
      background: var(--line);
      margin: 12px 0;
    }
    .vizWrap{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap: 14px;
      align-items:stretch;
    }
    .vizCard{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 10px 10px 12px;
      overflow:hidden;
      min-width:0;
    }
    .vizCard h4{
      margin:0 0 8px 0;
      font-size: 1rem;
      color: var(--ink);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .vizCard h4 span{color: var(--faint); font-size:.85rem; font-weight:500}
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(10,14,30,.45);
    }
    .controls{
      display:flex;
      flex-direction:column;
      gap: 10px;
    }
    .control{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      border-radius: 14px;
      padding: 10px 10px;
    }
    .control label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      color: var(--muted);
      font-size:.92rem;
      margin-bottom:6px;
    }
    .control label b{color: var(--ink)}
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    select, button{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--ink);
      font-size:.95rem;
      cursor:pointer;
    }
    button:hover{background: rgba(124,240,255,.10)}
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px 10px;
      background: rgba(0,0,0,.18);
    }
    .kpi .box .t{color: var(--faint); font-size:.86rem}
    .kpi .box .v{color: var(--ink); font-weight:750; font-size:1.02rem; margin-top:4px}
    .finalBox{
      border:1px solid rgba(183,255,124,.25);
      background: linear-gradient(180deg, rgba(183,255,124,.10), rgba(0,0,0,.18));
      border-radius: 16px;
      padding: 12px 12px;
      position:relative;
      overflow:hidden;
    }
    .finalBox h4{
      margin:0 0 6px 0;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .finalBox .copyBtn{
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color: var(--ink);
      padding:6px 9px;
      border-radius: 12px;
      cursor:pointer;
      font-size:.82rem;
    }
    .finalBox .copyBtn:hover{background: rgba(183,255,124,.10)}
    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 18px 18px 40px;
      color: var(--faint);
      font-size:.92rem;
    }

    /* Print-friendly */
    @media print{
      body{background:#fff; color:#000}
      header, main, footer{max-width:none}
      nav#toc{display:none}
      section, .meta{box-shadow:none; background:#fff; border:1px solid #ddd}
      canvas{border:1px solid #bbb}
      .eq{background:#f7f7f7}
    }

    /* Responsive */
    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
      nav#toc{position:relative; top:auto}
      header .top{grid-template-columns: 1fr}
      .vizWrap{grid-template-columns:1fr}
      canvas{height:300px}
    }
    @media (max-width: 520px){
      .grid2, .grid3{grid-template-columns:1fr}
      canvas{height:260px}
    }
  </style>
</head>
<body>
  <header>
    <div class="top">
      <div>
        <h1>7.2-1 — Gap–Midgap Ratio of a 1D Periodic Dielectric Stack (Fourier Optics)</h1>
        <p class="subtitle">
          We model a 1D photonic crystal as a periodic permittivity function, extract its <span style="color:var(--accent)">first Fourier harmonic</span>,
          and use a Bragg/coupled-wave picture to estimate the <b>Bragg (midgap) frequency</b> and the <b>gap–midgap ratio</b> for the lowest bandgap.
        </p>
      </div>
      <aside class="meta">
        <div class="row">
          <span class="pill"><b>Structure:</b> bilayer period Λ = 2 µm</span>
          <span class="pill"><b>Propagation:</b> along periodic axis (normal incidence)</span>
          <span class="pill"><b>Key tool:</b> Fourier coefficient ε<sub>G</sub></span>
        </div>
        <div class="divider"></div>
        <div class="row">
          <span class="pill"><b>Case A:</b> n₁=1.5, n₂=3.5</span>
          <span class="pill"><b>Case B:</b> n₁=3.4, n₂=3.6</span>
        </div>
      </aside>
    </div>
  </header>

  <main>
    <nav id="toc" aria-label="Table of contents">
      <h2>On this page</h2>
      <ul class="toc-list">
        <li><a href="#qs">Quick Summary</a></li>
        <li><a href="#p0">PART 0 — Concept Primer</a></li>
        <li><a href="#p1">PART 1 — Problem Analysis</a></li>
        <li><a href="#p2">PART 2 — Strategy & Tips</a></li>
        <li><a href="#p3">PART 3 — Full Solution</a></li>
        <li><a href="#p4">PART 4 — Deeper Understanding</a></li>
        <li><a href="#p5">PART 5 — Visualization Guide</a></li>
      </ul>
      <div class="divider"></div>
      <p class="note">Tip: use the interactive controls to see how index contrast changes the bandgap.</p>
    </nav>

    <div class="content">

      <section id="qs">
        <h2>Quick Summary</h2>
        <ul>
          <li><b>What this is about:</b> estimating the <b>lowest photonic bandgap</b> of a 1D dielectric multilayer from its <b>Fourier spectrum</b>.</li>
          <li><b>Key physics idea:</b> at the Bragg condition, forward and backward waves couple via the <b>first spatial harmonic</b> of the permittivity.</li>
          <li><b>Governing wave model (normal incidence):</b> <span class="small">d²E/dz² + (ω/c)² ε(z) E = 0</span>, with ε(z+Λ)=ε(z).</li>
          <li><b>Bragg (midgap) condition (1st order):</b> 2k̄ = G, where G = 2π/Λ and k̄ = (ω/c)√ε̄.</li>
          <li><b>Fourier optics estimate:</b> midgap frequency
            <span class="small">f<sub>B</sub> = c / (2Λ√ε̄)</span> and gap–midgap ratio
            <span class="small">Δf/f<sub>mid</sub> ≈ |ε<sub>G</sub>|/ε̄</span>.</li>
          <li><b>Equal optical thickness constraint:</b> n₁d₁ = n₂d₂, with d₁+d₂=Λ ⇒ d₁ = Λ·n₂/(n₁+n₂), d₂ = Λ·n₁/(n₁+n₂).</li>
          <li><b>Numeric results (Fourier estimate):</b>
            Case A gives a <b>large</b> ratio (~0.491) and Case B a <b>small</b> ratio (~0.0364).</li>
          <li><b>Result type:</b> symbolic formulas + numeric evaluation for two parameter sets; interactive plots show band structure and parameter sweep.</li>
        </ul>
      </section>

      <section id="p0">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <div class="grid2">
          <div class="callout">
            <h4><span class="badge"></span>Core definitions (symbols & units)</h4>
            <ul>
              <li><b>Λ</b> (meters): spatial period of the structure (one bilayer).</li>
              <li><b>n(z)</b> (dimensionless): refractive index; <b>ε(z)=n(z)²</b> is relative permittivity (dimensionless).</li>
              <li><b>ω</b> (rad/s), <b>f</b> (Hz): angular frequency and ordinary frequency.</li>
              <li><b>k₀=ω/c=2π/λ₀</b> (1/m): vacuum wavenumber.</li>
              <li><b>G = 2π/Λ</b> (1/m): first reciprocal lattice vector magnitude.</li>
              <li><b>ε̄</b>: average permittivity over a period; <b>ε<sub>G</sub></b>: Fourier coefficient at spatial frequency G.</li>
              <li><b>Gap–midgap ratio</b>: typically <b>Δω/ω<sub>mid</sub></b> or <b>Δf/f<sub>mid</sub></b> (dimensionless), where Δ is bandgap width.</li>
            </ul>
          </div>

          <div class="callout">
            <h4><span class="badge good"></span>Physical meaning (what these represent)</h4>
            <ul>
              <li><b>ε̄</b> sets the “background” wave speed: waves behave <i>as if</i> the medium had index √ε̄ when the modulation is weak.</li>
              <li><b>ε<sub>G</sub></b> measures how strongly the periodic structure can <b>Bragg-scatter</b> the wave (couple forward ↔ backward).</li>
              <li>The <b>Bragg condition</b> picks the frequency where a wave accumulates <b>π phase per half-period</b>, enabling constructive reflection from many periods.</li>
              <li>The <b>gap width</b> grows with coupling strength (≈|ε<sub>G</sub>|): stronger modulation → stronger stopband.</li>
            </ul>
          </div>
        </div>

        <h3>Key laws/principles and validity</h3>
        <p>
          For a 1D, lossless, non-magnetic dielectric stack at normal incidence (wave along the periodic axis),
          a scalar Helmholtz form is adequate:
        </p>
        <div class="eq" data-copy="d^2E/dz^2 + (ω/c)^2 ε(z) E = 0   with   ε(z+Λ)=ε(z)">
          <button class="copyBtn" type="button">Copy</button>
          d²E/dz² + (ω/c)² ε(z) E = 0, &nbsp;with periodicity ε(z+Λ)=ε(z).
        </div>
        <p class="note">
          This is the simplest “Fourier optics / coupled-wave” view. It is most accurate when the modulation is not extremely strong,
          but it still gives useful intuition and often decent estimates.
        </p>

        <h3>Common models/approximations (and why we use them)</h3>
        <ul>
          <li><b>Fourier expansion:</b> ε(z) = ε̄ + Σ ε<sub>m</sub> e^{imGz}. The <b>m=±1</b> term dominates the <b>lowest</b> Bragg gap.</li>
          <li><b>Two-wave (coupled-mode) truncation:</b> keep only forward wave near k≈G/2 and its Bragg-reflected partner near k≈−G/2 (or k−G).</li>
          <li><b>Weak/moderate coupling estimate:</b> gap–midgap ratio scales like |ε<sub>G</sub>|/ε̄. This is a “first-harmonic strength / background” ratio.</li>
        </ul>

        <h3>Mini intuition examples (no long algebra)</h3>
        <ul>
          <li><b>If n₁=n₂</b>, then ε(z) is constant ⇒ ε<sub>G</sub>=0 ⇒ <b>no bandgap</b>.</li>
          <li><b>If the layers have very different indices</b>, ε(z) has strong harmonics ⇒ |ε<sub>G</sub>| larger ⇒ <b>wider bandgap</b>.</li>
        </ul>

        <div class="callout">
          <h4><span class="badge warn"></span>What to watch for (pitfalls)</h4>
          <ul>
            <li><b>Optical thickness vs physical thickness:</b> “equal optical thickness” means n₁d₁ = n₂d₂, not d₁=d₂.</li>
            <li><b>Which average?</b> Fourier approach naturally uses <b>ε̄</b> (average permittivity) in the scalar wave equation.</li>
            <li><b>Strong-contrast stacks:</b> simple Fourier estimates can shift the predicted midgap frequency; the gap ratio scaling remains insightful.</li>
          </ul>
        </div>
      </section>

      <section id="p1">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <h3>Restate the problem</h3>
        <p>
          We have a 1D periodic multilayer made of two dielectric layers (indices n₁ and n₂) repeated with period Λ = 2 µm.
          The layers have <b>equal optical thickness</b> (n₁d₁ = n₂d₂). A wave propagates along the periodic axis (normal incidence).
          Using a <b>Fourier optics approach</b>, we must find:
        </p>
        <ul>
          <li>The <b>Bragg frequency</b> (i.e., the center/midgap frequency of the lowest stopband).</li>
          <li>The <b>gap–midgap ratio</b> for the <b>lowest</b> bandgap.</li>
          <li>Repeat for two cases: (A) n₁=1.5, n₂=3.5 and (B) n₁=3.4, n₂=3.6, then compare.</li>
        </ul>

        <h3>Given quantities</h3>
        <ul>
          <li>Λ = 2 µm = 2×10⁻⁶ m</li>
          <li>Case A: n₁=1.5, n₂=3.5</li>
          <li>Case B: n₁=3.4, n₂=3.6</li>
          <li>Constraint: n₁d₁ = n₂d₂, and d₁ + d₂ = Λ</li>
        </ul>

        <h3>Unknowns</h3>
        <ul>
          <li>Bragg (midgap) frequency f<sub>B</sub> (or ω<sub>B</sub>)</li>
          <li>Gap–midgap ratio Δf/f<sub>mid</sub> (or Δω/ω<sub>mid</sub>) for the lowest gap</li>
        </ul>

        <h3>Relevant principles (and why they apply)</h3>
        <ul>
          <li><b>Periodic media → Bloch waves:</b> periodic ε(z) causes band structure; stopbands appear near Bragg planes.</li>
          <li><b>Bragg scattering:</b> strongest coupling when 2k̄ matches a reciprocal lattice vector G.</li>
          <li><b>Fourier optics:</b> coupling strength is controlled by the Fourier component ε<sub>G</sub> of the permittivity.</li>
        </ul>
        <p class="note">
          We do <i>not</i> need oblique incidence, polarization-dependent Fresnel coefficients, or magnetism because the wave travels along the periodic axis in a non-magnetic dielectric.
        </p>

        <div class="grid2">
          <div class="callout">
            <h4><span class="badge"></span>Assumptions</h4>
            <ul>
              <li>1D, infinite periodic repetition (ignore finite-size edge effects in theory).</li>
              <li>Lossless dielectrics (real n).</li>
              <li>Normal incidence (wavevector along z).</li>
              <li>Fourier/coupled-wave approximation dominated by the first harmonic (lowest bandgap).</li>
            </ul>
          </div>
          <div class="callout">
            <h4><span class="badge warn"></span>Approaches (compare & choose)</h4>
            <ul>
              <li><b>Fourier optics / coupled-wave:</b> analytic, teaches scaling; best for “why” and quick estimates (requested).</li>
              <li><b>Transfer-matrix exact band edges:</b> numerical but accurate even for strong contrast; great for checking.</li>
              <li><b>Quarter-wave stack formulas:</b> convenient special case (not exactly here because equal optical thickness ≠ quarter-wave at a specified λ).</li>
            </ul>
            <p class="small">We’ll use <b>Fourier optics</b> as the main solution, and (optionally) compare with an exact transfer-matrix check in the visualization.</p>
          </div>
        </div>
      </section>

      <section id="p2">
        <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

        <ol style="margin:8px 0 0 18px; color:var(--muted)">
          <li>
            <b>Convert “equal optical thickness” into d₁, d₂.</b><br/>
            <span class="small">Use n₁d₁=n₂d₂ and d₁+d₂=Λ → get layer fill fractions.</span><br/>
            <span class="note">Tip: don’t confuse “equal optical thickness” with “equal thickness.”</span>
          </li>
          <li>
            <b>Write ε(z) and compute its average ε̄.</b><br/>
            <span class="small">ε̄ = (1/Λ)∫ε(z)dz = (ε₁d₁+ε₂d₂)/Λ.</span>
          </li>
          <li>
            <b>Compute the first Fourier coefficient ε<sub>G</sub>.</b><br/>
            <span class="small">ε<sub>G</sub> = (1/Λ)∫₀^Λ ε(z)e^{-iGz}dz, with G=2π/Λ.</span><br/>
            <span class="note">Tip: for a step function, this reduces to a sine factor involving the fill fraction.</span>
          </li>
          <li>
            <b>Apply the Bragg condition to get f<sub>B</sub>.</b><br/>
            <span class="small">2k̄=G with k̄=(ω/c)√ε̄ → f<sub>B</sub>=c/(2Λ√ε̄).</span>
          </li>
          <li>
            <b>Relate coupling to the gap–midgap ratio.</b><br/>
            <span class="small">For the lowest gap, Δf/f<sub>mid</sub> ≈ |ε<sub>G</sub>|/ε̄ (first-harmonic estimate).</span>
          </li>
          <li>
            <b>Evaluate numerically for Case A and Case B, then compare.</b><br/>
            <span class="note">Common mistake: mixing n̄ (average index) with √ε̄ (effective index in this scalar model).</span>
          </li>
        </ol>
      </section>

      <section id="p3">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Physical intuition before calculating</h3>
        <p>
          A periodic stack reflects strongly when reflections from each period add in phase (Bragg reflection),
          producing a frequency range where propagation is forbidden (a <b>stopband</b>). The width of that stopband
          is controlled by how strongly the structure “looks periodic” to the wave—mathematically, by the magnitude
          of the first Fourier harmonic of ε(z). Therefore:
        </p>
        <ul>
          <li>Large index contrast (Case A) ⇒ large |ε<sub>G</sub>| ⇒ <b>large gap–midgap ratio</b>.</li>
          <li>Small index contrast (Case B) ⇒ small |ε<sub>G</sub>| ⇒ <b>small gap–midgap ratio</b>.</li>
        </ul>

        <div class="divider"></div>

        <h3>Step 1: Convert “equal optical thickness” to layer thicknesses</h3>
        <p>
          Equal optical thickness means:
          <span class="small">n₁d₁ = n₂d₂</span>,
          with period constraint:
          <span class="small">d₁ + d₂ = Λ</span>.
        </p>
        <div class="eq" data-copy="n1 d1 = n2 d2,   d1 + d2 = Λ  ⇒  d1 = Λ·n2/(n1+n2),   d2 = Λ·n1/(n1+n2)">
          <button class="copyBtn" type="button">Copy</button>
          n₁ d₁ = n₂ d₂, &nbsp; d₁ + d₂ = Λ &nbsp;⇒&nbsp;
          d₁ = Λ·n₂/(n₁+n₂), &nbsp; d₂ = Λ·n₁/(n₁+n₂).
        </div>
        <p class="note">
          What we did: solved two linear equations for d₁ and d₂.
          Why: the geometry (fill fraction) affects the Fourier coefficient ε<sub>G</sub>.
        </p>

        <h3>Step 2: Build ε(z) and compute the average ε̄</h3>
        <p>
          Let layer 1 (index n₁) occupy 0 ≤ z &lt; d₁, and layer 2 (index n₂) occupy d₁ ≤ z &lt; Λ.
          Then ε(z)=n(z)² is piecewise constant:
        </p>
        <div class="eq" data-copy="ε(z)=ε1 (0≤z<d1),  ε(z)=ε2 (d1≤z<Λ),  with ε1=n1^2, ε2=n2^2">
          <button class="copyBtn" type="button">Copy</button>
          ε(z)=ε₁ for 0≤z&lt;d₁, &nbsp; ε(z)=ε₂ for d₁≤z&lt;Λ, &nbsp; with ε₁=n₁², ε₂=n₂².
        </div>

        <p>
          The average permittivity over one period is:
        </p>
        <div class="eq" data-copy="ε̄ = (1/Λ)∫0^Λ ε(z)dz = (ε1 d1 + ε2 d2)/Λ">
          <button class="copyBtn" type="button">Copy</button>
          ε̄ = (1/Λ)∫₀^Λ ε(z)dz = (ε₁ d₁ + ε₂ d₂)/Λ.
        </div>
        <p class="note">
          Physical meaning: √ε̄ plays the role of an effective background index in the scalar Fourier model.
        </p>

        <h3>Step 3: Compute the first Fourier coefficient ε<sub>G</sub></h3>
        <p>
          Expand ε(z) in spatial harmonics of period Λ. The first reciprocal vector is G = 2π/Λ.
          The complex Fourier coefficient at G is:
        </p>
        <div class="eq" data-copy="ε_G = (1/Λ)∫0^Λ ε(z) e^{-iGz} dz,  with G=2π/Λ">
          <button class="copyBtn" type="button">Copy</button>
          ε<sub>G</sub> = (1/Λ)∫₀^Λ ε(z) e<sup>−iGz</sup> dz, &nbsp; with G=2π/Λ.
        </div>

        <p>
          For a two-level (step) function, this integral can be done directly. Let f = d₁/Λ (fill fraction of layer 1).
          Then:
        </p>
        <div class="eq" data-copy="|ε_G| = |ε1−ε2|/π · |sin(π f)|,   where f=d1/Λ">
          <button class="copyBtn" type="button">Copy</button>
          |ε<sub>G</sub>| = |ε₁−ε₂|/π · |sin(π f)|, &nbsp; where f=d₁/Λ.
        </div>
        <p class="note">
          What we did: evaluated the Fourier transform of a rectangular waveform.
          Why it matters: |ε<sub>G</sub>| is the “Bragg coupling strength” for the lowest gap.
        </p>

        <p>
          Under equal optical thickness, the fill fraction becomes especially simple:
        </p>
        <div class="eq" data-copy="f = d1/Λ = n2/(n1+n2),   and   d2/Λ = n1/(n1+n2)">
          <button class="copyBtn" type="button">Copy</button>
          f = d₁/Λ = n₂/(n₁+n₂), &nbsp; and &nbsp; d₂/Λ = n₁/(n₁+n₂).
        </div>

        <h3>Step 4: Bragg (midgap) frequency from the Fourier model</h3>
        <p>
          In the scalar periodic Helmholtz equation, a plane wave in the average medium has wavenumber
          k̄ = (ω/c)√ε̄. The first Bragg condition is:
        </p>
        <div class="eq" data-copy="2 k̄ = G,  with k̄=(ω/c)√ε̄ and G=2π/Λ">
          <button class="copyBtn" type="button">Copy</button>
          2k̄ = G, &nbsp; with k̄=(ω/c)√ε̄ and G=2π/Λ.
        </div>
        <p>
          Solve for ω (or f):
        </p>
        <div class="eq" data-copy="ω_B = c·(G/2)/√ε̄ = c·π/(Λ√ε̄),  so  f_B = ω_B/(2π) = c/(2Λ√ε̄)">
          <button class="copyBtn" type="button">Copy</button>
          ω<sub>B</sub> = c·(G/2)/√ε̄ = c·π/(Λ√ε̄), &nbsp; so &nbsp;
          f<sub>B</sub> = ω<sub>B</sub>/(2π) = c/(2Λ√ε̄).
        </div>

        <h3>Step 5: Gap–midgap ratio from first-harmonic coupling</h3>
        <p>
          Near the Bragg point, forward and backward waves form a coupled 2×2 eigenproblem.
          The degeneracy at the Bragg frequency splits into two band-edge frequencies whose separation scales with the coupling strength.
          To first order (first-harmonic estimate),
        </p>
        <div class="eq" data-copy="Gap–midgap ratio:  Δf / f_mid ≈ |ε_G| / ε̄   (equivalently  Δω/ω_mid ≈ |ε_G|/ε̄ )">
          <button class="copyBtn" type="button">Copy</button>
          Gap–midgap ratio: &nbsp; Δf / f<sub>mid</sub> ≈ |ε<sub>G</sub>| / ε̄
          &nbsp; (equivalently &nbsp; Δω/ω<sub>mid</sub> ≈ |ε<sub>G</sub>|/ε̄).
        </div>
        <p class="note">
          Interpretation: it’s “(periodic modulation strength) / (background level).”
          This is why weak contrast yields small gaps.
        </p>

        <div class="divider"></div>

        <h3>Numerical evaluation (Λ = 2 µm)</h3>
        <p class="note">We use c = 2.99792458×10⁸ m/s. Frequencies are reported in THz.</p>

        <div class="grid2">
          <div class="callout">
            <h4><span class="badge"></span>Case A: n₁=1.5, n₂=3.5</h4>
            <ul>
              <li>d₁ = Λ·n₂/(n₁+n₂) = 2 µm · 3.5/5.0 = <b>1.40 µm</b></li>
              <li>d₂ = 2 µm − 1.40 µm = <b>0.60 µm</b></li>
              <li>ε₁=2.25, ε₂=12.25</li>
              <li>ε̄ = (ε₁d₁+ε₂d₂)/Λ = <b>5.25</b></li>
              <li>|ε<sub>G</sub>| = |ε₁−ε₂|/π · |sin(πf)| with f=0.70 ⇒ <b>2.575</b></li>
              <li>f<sub>B</sub> = c/(2Λ√ε̄) = <b>32.71 THz</b></li>
              <li>Δf/f<sub>mid</sub> ≈ |ε<sub>G</sub>|/ε̄ = <b>0.4905</b></li>
            </ul>
          </div>

          <div class="callout">
            <h4><span class="badge good"></span>Case B: n₁=3.4, n₂=3.6</h4>
            <ul>
              <li>d₁ = 2 µm · 3.6/7.0 = <b>1.0286 µm</b></li>
              <li>d₂ = 2 µm − 1.0286 µm = <b>0.9714 µm</b></li>
              <li>ε₁=11.56, ε₂=12.96</li>
              <li>ε̄ = <b>12.24</b></li>
              <li>|ε<sub>G</sub>| = <b>0.4452</b></li>
              <li>f<sub>B</sub> = <b>21.42 THz</b></li>
              <li>Δf/f<sub>mid</sub> ≈ <b>0.03637</b></li>
            </ul>
          </div>
        </div>

        <div class="finalBox" id="finalAnswerBox">
          <h4>
            <span>Final Answer (Fourier Optics Estimate)</span>
            <button class="copyBtn" type="button" id="copyFinal">Copy</button>
          </h4>
          <div class="small" id="finalAnswerText" style="font-family:var(--mono); white-space:pre-wrap; color:var(--ink);">
Case A (n1=1.5, n2=3.5, Λ=2 µm, equal optical thickness):
d1=1.40 µm, d2=0.60 µm
ε̄=5.25, |εG|=2.575
Bragg (midgap) frequency: fB = c/(2Λ√ε̄) = 32.71 THz
Gap–midgap ratio: Δf/fmid ≈ |εG|/ε̄ = 0.4905

Case B (n1=3.4, n2=3.6, Λ=2 µm, equal optical thickness):
d1=1.0286 µm, d2=0.9714 µm
ε̄=12.24, |εG|=0.4452
Bragg (midgap) frequency: fB = 21.42 THz
Gap–midgap ratio: Δf/fmid ≈ 0.03637

Comparison:
Case A has a much wider lowest bandgap (≈49% of midgap) due to strong index contrast.
Case B has a very narrow lowest bandgap (≈3.6%) due to weak index contrast.
          </div>
          <p class="note" style="margin-top:8px">
            Sanity checks: ratios are dimensionless; larger index contrast increases |ε<sub>G</sub>| and thus the bandgap width.
          </p>
        </div>

        <div class="callout" style="margin-top:14px">
          <h4><span class="badge warn"></span>Accuracy note (important for Case A)</h4>
          <p class="small">
            Case A has very strong contrast, so the “first-harmonic” Fourier estimate can shift the predicted midgap frequency.
            The interactive plots include an <b>exact transfer-matrix band diagram</b> as a reality check.
            You should trust the <b>trend</b> (contrast → wider gap) always; absolute midgap frequency is more sensitive when the modulation is strong.
          </p>
        </div>

        <h3>Connection to the diagram and plots</h3>
        <p>
          The diagram shows the unit cell (layer 1 + layer 2) and the distances d₁, d₂ that come from equal optical thickness.
          The main plot shows the <b>band structure</b> (allowed frequencies vs Bloch wavevector) and visually reveals the lowest stopband.
          The secondary plot sweeps a parameter (n₂) to show how the <b>gap–midgap ratio</b> changes continuously.
        </p>
      </section>

      <section id="p4">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpret the formulas: what controls what?</h3>
        <ul>
          <li><b>f<sub>B</sub> = c/(2Λ√ε̄):</b> increasing Λ lowers f<sub>B</sub>; increasing ε̄ (higher overall index) also lowers f<sub>B</sub>.</li>
          <li><b>Δf/f<sub>mid</sub> ≈ |ε<sub>G</sub>|/ε̄:</b> the gap is large if the <i>relative</i> first harmonic is large.</li>
          <li><b>Fill fraction effect:</b> |ε<sub>G</sub>| has a <b>sin(πf)</b> dependence, so geometry can strengthen or weaken the first Bragg coupling.</li>
        </ul>

        <h3>How changing parameters affects outcome (connect to plots)</h3>
        <ul>
          <li>Increase index contrast (raise n₂ while keeping n₁ fixed): |ε₁−ε₂| grows → |ε<sub>G</sub>| grows → <b>wider stopband</b>.</li>
          <li>For equal optical thickness, changing n₂ also changes fill fraction f, so geometry and contrast both change together.</li>
          <li>When n₁≈n₂ (Case B), ε(z) is almost constant → ε<sub>G</sub> small → gap is tiny.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p>
          You can compute the bandgap exactly using a <b>transfer matrix</b> for one period and the Bloch condition
          cos(KΛ) = (Tr M)/2. Band edges occur when |cos(KΛ)|=1. This requires no “weak modulation” assumption and matches the main plot’s exact curve.
        </p>

        <div class="grid2">
          <div class="callout">
            <h4><span class="badge"></span>Concept checks (with answers)</h4>
            <ul>
              <li><b>Q:</b> If ε(z) has no first harmonic, do we still get a lowest bandgap? <br/><b>A:</b> Not at first order; the lowest Bragg gap is driven by ε<sub>±1</sub>. Higher harmonics could open higher-order gaps.</li>
              <li><b>Q:</b> Why does a periodic medium create a stopband? <br/><b>A:</b> Because forward and backward waves couple and form standing-wave Bloch modes separated by a frequency splitting.</li>
              <li><b>Q:</b> What happens if Λ increases? <br/><b>A:</b> Bragg condition shifts to lower frequency (longer wavelength).</li>
            </ul>
          </div>
          <div class="callout">
            <h4><span class="badge warn"></span>Common mistakes (quick fixes)</h4>
            <ul>
              <li>Using d₁=d₂ instead of n₁d₁=n₂d₂.</li>
              <li>Forgetting ε=n² when computing ε̄ and ε<sub>G</sub>.</li>
              <li>Mixing Δω/ω with Δf/f (they are identical ratios, but don’t mix ω and f numerically).</li>
              <li>Assuming Fourier estimate is exact for very high contrast; use transfer-matrix to verify.</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="p5">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <div class="vizWrap">
          <div class="vizCard">
            <h4>Diagram: Unit cell geometry <span>(alternating layers, normal incidence)</span></h4>
            <canvas id="cnvDiagram" aria-label="Diagram canvas"></canvas>
            <p class="note">
              The unit cell has thickness Λ. Layer 1 (n₁) occupies d₁, layer 2 (n₂) occupies d₂.
              The wave propagates along +z (the periodic axis).
            </p>
          </div>

          <div class="vizCard">
            <h4>Interactive Controls <span>(updates all plots live)</span></h4>

            <div class="controls">
              <div class="control">
                <label>
                  <span>Preset</span>
                  <b id="presetName">Case A</b>
                </label>
                <select id="presetSel" aria-label="Preset select">
                  <option value="A">Case A: n1=1.5, n2=3.5</option>
                  <option value="B">Case B: n1=3.4, n2=3.6</option>
                  <option value="C">Custom (keep sliders)</option>
                </select>
                <p class="note" style="margin:8px 0 0">Use presets to match the problem, or pick Custom to explore.</p>
              </div>

              <div class="control">
                <label><span>n₁ (layer 1)</span><b id="n1Val">1.50</b></label>
                <input id="n1" type="range" min="1.0" max="4.0" step="0.01" value="1.50"/>
              </div>

              <div class="control">
                <label><span>n₂ (layer 2)</span><b id="n2Val">3.50</b></label>
                <input id="n2" type="range" min="1.0" max="4.5" step="0.01" value="3.50"/>
              </div>

              <div class="control">
                <label><span>Model shown in band plot</span><b id="modelVal">Exact (transfer matrix)</b></label>
                <select id="modelSel" aria-label="Model select">
                  <option value="exact">Exact (transfer matrix)</option>
                  <option value="fourier">Fourier estimate (midgap + gap width markers)</option>
                  <option value="both">Both</option>
                </select>
              </div>

              <div class="kpi">
                <div class="box">
                  <div class="t">d₁, d₂ (µm)</div>
                  <div class="v" id="dVals">1.40, 0.60</div>
                </div>
                <div class="box">
                  <div class="t">ε̄, |εG|</div>
                  <div class="v" id="epsVals">5.250, 2.575</div>
                </div>
                <div class="box">
                  <div class="t">Fourier fB (THz)</div>
                  <div class="v" id="fBVal">32.71</div>
                </div>
                <div class="box">
                  <div class="t">Fourier Δf/fmid</div>
                  <div class="v" id="ratioVal">0.4905</div>
                </div>
              </div>

              <button id="snapToProblem" type="button">Snap sliders to selected preset</button>
              <p class="note" style="margin:0">
                The band diagram uses the exact transfer-matrix model by default; the Fourier estimate appears as markers/annotations depending on the selection above.
              </p>
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:14px">
          <div class="vizCard">
            <h4>Main Plot: Band diagram (lowest gap) <span>Bloch K vs frequency</span></h4>
            <canvas id="cnvBand" aria-label="Band diagram canvas"></canvas>
            <p class="note">
              Allowed propagation appears where Bloch K is real (bands). The lowest stopband shows as a missing frequency range.
              Axes: K (rad/m) on x, frequency f (THz) on y.
            </p>
          </div>

          <div class="vizCard">
            <h4>Secondary Plot: Parameter sweep <span>gap–midgap ratio vs n₂</span></h4>
            <canvas id="cnvSweep" aria-label="Parameter sweep canvas"></canvas>
            <p class="note">
              This sweep uses the <b>Fourier estimate</b> Δf/fmid ≈ |εG|/ε̄ while enforcing equal optical thickness at every n₂.
              The current (n₁,n₂) point is highlighted.
            </p>
          </div>
        </div>

        <div class="callout" style="margin-top:14px">
          <h4><span class="badge"></span>What the controls do</h4>
          <ul>
            <li><b>n₁, n₂ sliders:</b> change indices; d₁ and d₂ update automatically to keep <b>n₁d₁=n₂d₂</b>.</li>
            <li><b>Band plot model:</b> show exact band structure, Fourier estimate markers, or both.</li>
            <li><b>Result expectation:</b> increasing contrast (n₂ far from n₁) widens the gap and increases the sweep curve value.</li>
          </ul>
        </div>
      </section>

    </div>
  </main>

  <footer>
    <div class="divider"></div>
    <p>
      Built as a self-contained learning article (vanilla HTML/CSS/JS). The interactive plots include an exact transfer-matrix check to complement the requested Fourier optics derivation.
    </p>
  </footer>

  <script>
    // ---------- Utilities ----------
    const C0 = 299792458; // m/s
    const LAMBDA = 2e-6;  // period Λ in meters (given)

    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
    function fmt(x, d=3){ return Number(x).toFixed(d); }
    function fmt2(x, d=2){ return Number(x).toFixed(d); }

    function copyText(txt){
      if(!navigator.clipboard){
        // fallback
        const ta = document.createElement('textarea');
        ta.value = txt;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand('copy'); }catch(e){}
        document.body.removeChild(ta);
        return;
      }
      navigator.clipboard.writeText(txt).catch(()=>{});
    }

    // Attach copy buttons to equations
    document.querySelectorAll('.eq').forEach(eq=>{
      const btn = eq.querySelector('.copyBtn');
      if(!btn) return;
      btn.addEventListener('click', ()=>{
        const txt = eq.getAttribute('data-copy') || eq.textContent.trim();
        copyText(txt);
        btn.textContent = 'Copied';
        setTimeout(()=>btn.textContent='Copy', 900);
      });
    });

    // Copy final answer
    const copyFinalBtn = document.getElementById('copyFinal');
    copyFinalBtn.addEventListener('click', ()=>{
      copyText(document.getElementById('finalAnswerText').textContent.trim());
      copyFinalBtn.textContent = 'Copied';
      setTimeout(()=>copyFinalBtn.textContent='Copy', 900);
    });

    // Smooth scroll for TOC
    document.querySelectorAll('#toc a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const id = a.getAttribute('href');
        const el = document.querySelector(id);
        if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });

    // ---------- Physics: Fourier optics estimates ----------
    function equalOpticalThickness(n1,n2){
      // n1*d1 = n2*d2, d1 + d2 = Λ
      const d1 = LAMBDA * (n2/(n1+n2));
      const d2 = LAMBDA - d1;
      return {d1, d2, fFill: d1/LAMBDA};
    }

    function epsBar(n1,n2,d1,d2){
      const e1 = n1*n1, e2 = n2*n2;
      return (e1*d1 + e2*d2)/LAMBDA;
    }

    function epsGmag(n1,n2, fFill){
      // |ε_G| = |ε1-ε2|/π * |sin(π f)|
      const e1 = n1*n1, e2 = n2*n2;
      const dE = Math.abs(e1 - e2);
      return (dE/Math.PI) * Math.abs(Math.sin(Math.PI * fFill));
    }

    function fourierEstimates(n1,n2){
      const geo = equalOpticalThickness(n1,n2);
      const ebar = epsBar(n1,n2, geo.d1, geo.d2);
      const eG = epsGmag(n1,n2, geo.fFill);
      const fB = C0 / (2 * LAMBDA * Math.sqrt(ebar)); // Hz
      const ratio = eG / ebar; // Δf/fmid estimate
      return { ...geo, ebar, eG, fB, ratio };
    }

    // ---------- Exact: Transfer matrix band check (normal incidence) ----------
    function layerMatrix(n, d, fHz){
      // Characteristic matrix at normal incidence (using admittance q=n)
      const k0 = 2*Math.PI * fHz / C0;
      const phi = n * k0 * d;
      const c = Math.cos(phi);
      const s = Math.sin(phi);
      const q = n;
      // [[cosφ, i sinφ / q],[ i q sinφ, cosφ]]
      return [
        [c, 1*j(s/q)],
        [1*j(q*s), c]
      ];
    }
    // Complex helper using {re, im}
    function Cplx(re, im){ return {re, im}; }
    function cAdd(a,b){ return Cplx(a.re+b.re, a.im+b.im); }
    function cMul(a,b){ return Cplx(a.re*b.re - a.im*b.im, a.re*b.im + a.im*b.re); }
    function cScale(a,s){ return Cplx(a.re*s, a.im*s); }
    function cAbs(a){ return Math.hypot(a.re, a.im); }

    function iTimes(x){ return Cplx(0, x); }
    function oneJ(x){ return iTimes(x); }

    function matMul(A,B){
      // 2x2 complex matrices with entries as {re,im}
      const a00 = cAdd(cMul(A[0][0],B[0][0]), cMul(A[0][1],B[1][0]));
      const a01 = cAdd(cMul(A[0][0],B[0][1]), cMul(A[0][1],B[1][1]));
      const a10 = cAdd(cMul(A[1][0],B[0][0]), cMul(A[1][1],B[1][0]));
      const a11 = cAdd(cMul(A[1][0],B[0][1]), cMul(A[1][1],B[1][1]));
      return [[a00,a01],[a10,a11]];
    }

    function layerMatrixC(n,d,fHz){
      const k0 = 2*Math.PI * fHz / C0;
      const phi = n * k0 * d;
      const c = Math.cos(phi);
      const s = Math.sin(phi);
      const q = n;
      return [
        [Cplx(c,0), oneJ(s/q)],
        [oneJ(q*s), Cplx(c,0)]
      ];
    }

    function cosK_fromTransfer(n1,n2,fHz){
      const {d1,d2} = equalOpticalThickness(n1,n2);
      const M1 = layerMatrixC(n1,d1,fHz);
      const M2 = layerMatrixC(n2,d2,fHz);
      const M = matMul(M2,M1);
      // cos(KΛ) = (Tr M)/2, should be real for lossless
      const tr = cAdd(M[0][0], M[1][1]);
      return {cosK: tr.re/2, d1, d2}; // take real part
    }

    function exactMidgapAndRatio(n1,n2){
      // Find lowest stopband around Fourier Bragg frequency by scanning and locating |cosK|>1 region.
      const est = fourierEstimates(n1,n2);
      const f0 = est.fB;

      // Frequency scan window: widen for strong contrast
      const span = (Math.abs(n2-n1) > 1.0) ? 0.8 : 0.25;
      const fMin = f0*(1-span);
      const fMax = f0*(1+span);
      const N = 6000;

      let inStop = false;
      let bestSeg = null;
      let segStart = 0;
      let segs = [];

      const vals = new Array(N);
      for(let i=0;i<N;i++){
        const f = fMin + (fMax-fMin)*i/(N-1);
        const ck = cosK_fromTransfer(n1,n2,f).cosK;
        vals[i] = ck;
      }
      for(let i=0;i<N;i++){
        const stop = Math.abs(vals[i]) > 1.0000001;
        if(stop && !inStop){ inStop = true; segStart = i; }
        if(!stop && inStop){ inStop = false; segs.push([segStart, i-1]); }
      }
      if(inStop) segs.push([segStart, N-1]);

      if(segs.length===0) return null;

      // choose the segment closest to f0
      const i0 = Math.round((f0-fMin)/(fMax-fMin)*(N-1));
      bestSeg = segs.reduce((best, seg)=>{
        const mid = 0.5*(seg[0]+seg[1]);
        const d = Math.abs(mid - i0);
        return (!best || d < best.d) ? {seg, d} : best;
      }, null).seg;

      const [a,b] = bestSeg;
      // refine edges where |cosK| crosses 1 using bisection
      function g(f){ return Math.abs(cosK_fromTransfer(n1,n2,f).cosK) - 1; }
      function bisect(fL,fH, it=60){
        let lo=fL, hi=fH;
        for(let k=0;k<it;k++){
          const mid = 0.5*(lo+hi);
          if(g(mid)>0) hi=mid; else lo=mid;
        }
        return 0.5*(lo+hi);
      }
      // left edge: from pass (a-1) to stop (a)
      const fA_pass = fMin + (fMax-fMin)*Math.max(0,a-1)/(N-1);
      const fA_stop = fMin + (fMax-fMin)*a/(N-1);
      // right edge: from stop (b) to pass (b+1)
      const fB_stop = fMin + (fMax-fMin)*b/(N-1);
      const fB_pass = fMin + (fMax-fMin)*Math.min(N-1,b+1)/(N-1);

      const fHigh = bisect(fA_pass, fA_stop);
      const fLow  = bisect(fB_stop, fB_pass);
      const fMid  = 0.5*(fHigh + fLow);
      const ratio = (fHigh - fLow)/fMid;
      return {fHigh, fLow, fMid, ratio};
    }

    // ---------- Canvas drawing helpers ----------
    function setupCanvas(canvas){
      const ctx = canvas.getContext('2d');
      function resize(){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.max(2, Math.floor(rect.width * dpr));
        canvas.height = Math.max(2, Math.floor(rect.height * dpr));
        ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
        return {w: rect.width, h: rect.height, dpr};
      }
      return {ctx, resize};
    }

    function drawAxes(ctx, box, xMin,xMax,yMin,yMax, opts){
      const {xLabel, yLabel, title, grid=true} = opts || {};
      const {x,y,w,h} = box;

      // background
      ctx.save();
      ctx.fillStyle = 'rgba(10,14,30,0.30)';
      ctx.fillRect(x,y,w,h);

      // Title
      ctx.fillStyle = 'rgba(234,240,255,0.95)';
      ctx.font = '600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(title||'', x+10, y+18);

      // Plot region
      const padL=56, padR=14, padT=28, padB=44;
      const px = x+padL, py=y+padT, pw=w-padL-padR, ph=h-padT-padB;

      // grid
      if(grid){
        ctx.strokeStyle='rgba(255,255,255,0.08)';
        ctx.lineWidth=1;
        const nx=6, ny=6;
        for(let i=0;i<=nx;i++){
          const gx = px + pw*i/nx;
          ctx.beginPath(); ctx.moveTo(gx, py); ctx.lineTo(gx, py+ph); ctx.stroke();
        }
        for(let j=0;j<=ny;j++){
          const gy = py + ph*j/ny;
          ctx.beginPath(); ctx.moveTo(px, gy); ctx.lineTo(px+pw, gy); ctx.stroke();
        }
      }

      // axes
      ctx.strokeStyle='rgba(255,255,255,0.20)';
      ctx.lineWidth=1.2;
      ctx.beginPath();
      ctx.moveTo(px, py); ctx.lineTo(px, py+ph);
      ctx.lineTo(px+pw, py+ph);
      ctx.stroke();

      // ticks and labels
      ctx.fillStyle='rgba(185,196,230,0.95)';
      ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

      const nx=5, ny=5;
      for(let i=0;i<=nx;i++){
        const t = i/nx;
        const xv = xMin + (xMax-xMin)*t;
        const gx = px + pw*t;
        ctx.strokeStyle='rgba(255,255,255,0.18)';
        ctx.beginPath(); ctx.moveTo(gx, py+ph); ctx.lineTo(gx, py+ph+6); ctx.stroke();
        const s = (Math.abs(xv) >= 1000 || Math.abs(xv) < 0.01) ? xv.toExponential(2) : xv.toFixed(2);
        ctx.fillText(s, gx-18, py+ph+22);
      }
      for(let j=0;j<=ny;j++){
        const t = 1 - j/ny;
        const yv = yMin + (yMax-yMin)*t;
        const gy = py + ph*j/ny;
        ctx.strokeStyle='rgba(255,255,255,0.18)';
        ctx.beginPath(); ctx.moveTo(px-6, gy); ctx.lineTo(px, gy); ctx.stroke();
        const s = (Math.abs(yv) >= 1000 || Math.abs(yv) < 0.01) ? yv.toExponential(2) : yv.toFixed(2);
        ctx.fillText(s, px-52, gy+4);
      }

      // axis labels
      ctx.fillStyle='rgba(234,240,255,0.85)';
      ctx.font='600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      if(xLabel) ctx.fillText(xLabel, px + pw*0.5 - ctx.measureText(xLabel).width*0.5, y+h-12);
      if(yLabel){
        ctx.save();
        ctx.translate(x+14, py + ph*0.5);
        ctx.rotate(-Math.PI/2);
        ctx.fillText(yLabel, -ctx.measureText(yLabel).width*0.5, 0);
        ctx.restore();
      }

      ctx.restore();

      function xToPx(xv){ return px + (xv-xMin)/(xMax-xMin)*pw; }
      function yToPx(yv){ return py + (1-(yv-yMin)/(yMax-yMin))*ph; }

      return {plot:{x:px,y:py,w:pw,h:ph}, xToPx, yToPx};
    }

    function drawLegend(ctx, items, x, y){
      ctx.save();
      ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      let yy=y;
      items.forEach(it=>{
        ctx.fillStyle=it.color;
        ctx.fillRect(x, yy-9, 14, 6);
        ctx.fillStyle='rgba(234,240,255,0.88)';
        ctx.fillText(it.label, x+20, yy);
        yy += 16;
      });
      ctx.restore();
    }

    // ---------- Canvases ----------
    const diag = setupCanvas(document.getElementById('cnvDiagram'));
    const band = setupCanvas(document.getElementById('cnvBand'));
    const sweep = setupCanvas(document.getElementById('cnvSweep'));

    // ---------- State & UI ----------
    const ui = {
      presetSel: document.getElementById('presetSel'),
      modelSel: document.getElementById('modelSel'),
      n1: document.getElementById('n1'),
      n2: document.getElementById('n2'),
      n1Val: document.getElementById('n1Val'),
      n2Val: document.getElementById('n2Val'),
      presetName: document.getElementById('presetName'),
      modelVal: document.getElementById('modelVal'),
      dVals: document.getElementById('dVals'),
      epsVals: document.getElementById('epsVals'),
      fBVal: document.getElementById('fBVal'),
      ratioVal: document.getElementById('ratioVal'),
      snap: document.getElementById('snapToProblem')
    };

    const presets = {
      A: {n1:1.5, n2:3.5, name:'Case A'},
      B: {n1:3.4, n2:3.6, name:'Case B'}
    };

    function setSliders(n1,n2){
      ui.n1.value = n1;
      ui.n2.value = n2;
      ui.n1.dispatchEvent(new Event('input'));
      ui.n2.dispatchEvent(new Event('input'));
    }

    ui.snap.addEventListener('click', ()=>{
      const v = ui.presetSel.value;
      if(presets[v]){
        setSliders(presets[v].n1, presets[v].n2);
      }
    });

    function updatePresetLabel(){
      const v = ui.presetSel.value;
      ui.presetName.textContent = presets[v]?.name || 'Custom';
    }
    function updateModelLabel(){
      const v = ui.modelSel.value;
      const map = {exact:'Exact (transfer matrix)', fourier:'Fourier estimate', both:'Both'};
      ui.modelVal.textContent = map[v] || 'Exact (transfer matrix)';
    }

    ui.presetSel.addEventListener('change', ()=>{
      updatePresetLabel();
      if(ui.presetSel.value==='A' || ui.presetSel.value==='B'){
        const p = presets[ui.presetSel.value];
        setSliders(p.n1, p.n2);
      }
    });
    ui.modelSel.addEventListener('change', ()=>{ updateModelLabel(); renderAll(); });

    function onSliderInput(){
      // If sliders moved away from presets, set to Custom
      const n1 = parseFloat(ui.n1.value);
      const n2 = parseFloat(ui.n2.value);
      const isA = Math.abs(n1-presets.A.n1)<1e-6 && Math.abs(n2-presets.A.n2)<1e-6;
      const isB = Math.abs(n1-presets.B.n1)<1e-6 && Math.abs(n2-presets.B.n2)<1e-6;
      if(isA){ ui.presetSel.value='A'; }
      else if(isB){ ui.presetSel.value='B'; }
      else{ ui.presetSel.value='C'; }
      updatePresetLabel();
      renderAll();
    }
    ui.n1.addEventListener('input', onSliderInput);
    ui.n2.addEventListener('input', onSliderInput);

    // ---------- Drawing: Diagram ----------
    function drawDiagram(n1,n2, est){
      const {ctx, resize} = diag;
      const {w,h} = resize();
      ctx.clearRect(0,0,w,h);

      // Title strip
      ctx.save();
      ctx.fillStyle = 'rgba(255,255,255,0.06)';
      ctx.fillRect(0,0,w,30);
      ctx.fillStyle = 'rgba(234,240,255,0.92)';
      ctx.font='600 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText('Unit cell (one period Λ) with equal optical thickness', 10, 20);
      ctx.restore();

      const margin=18;
      const x0=margin, y0=44, W=w-2*margin, H=h-62;
      const cellH = Math.min(120, H*0.55);
      const cellY = y0 + (H-cellH)*0.35;

      // draw axis
      ctx.save();
      ctx.strokeStyle='rgba(255,255,255,0.25)';
      ctx.lineWidth=1.2;
      ctx.beginPath();
      ctx.moveTo(x0, cellY+cellH+28);
      ctx.lineTo(x0+W, cellY+cellH+28);
      ctx.stroke();
      ctx.fillStyle='rgba(185,196,230,0.95)';
      ctx.font='12px '+getComputedStyle(document.body).fontFamily;
      ctx.fillText('z (propagation →)', x0+8, cellY+cellH+24);
      ctx.restore();

      // cell rectangle
      const d1 = est.d1, d2=est.d2;
      const f = d1/LAMBDA;

      const x1 = x0;
      const xSplit = x0 + W*f;
      const x2 = x0 + W;

      // layer 1
      ctx.save();
      ctx.fillStyle='rgba(124,240,255,0.16)';
      ctx.strokeStyle='rgba(124,240,255,0.35)';
      ctx.lineWidth=1.2;
      ctx.fillRect(x1, cellY, xSplit-x1, cellH);
      ctx.strokeRect(x1, cellY, xSplit-x1, cellH);

      // layer 2
      ctx.fillStyle='rgba(183,255,124,0.14)';
      ctx.strokeStyle='rgba(183,255,124,0.32)';
      ctx.fillRect(xSplit, cellY, x2-xSplit, cellH);
      ctx.strokeRect(xSplit, cellY, x2-xSplit, cellH);

      // labels
      ctx.fillStyle='rgba(234,240,255,0.92)';
      ctx.font='600 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(`Layer 1: n₁ = ${n1.toFixed(2)}`, x1+10, cellY+24);
      ctx.fillText(`Layer 2: n₂ = ${n2.toFixed(2)}`, xSplit+10, cellY+24);

      // thickness braces
      ctx.strokeStyle='rgba(255,255,255,0.35)';
      ctx.lineWidth=1.1;
      const by = cellY+cellH+10;

      function brace(xa, xb, text){
        ctx.beginPath();
        ctx.moveTo(xa, by);
        ctx.lineTo(xa, by+8);
        ctx.lineTo(xb, by+8);
        ctx.lineTo(xb, by);
        ctx.stroke();
        ctx.fillStyle='rgba(185,196,230,0.95)';
        ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
        const tw = ctx.measureText(text).width;
        ctx.fillText(text, (xa+xb)/2 - tw/2, by+24);
      }
      brace(x1, xSplit, `d₁ = ${(d1*1e6).toFixed(3)} µm`);
      brace(xSplit, x2, `d₂ = ${(d2*1e6).toFixed(3)} µm`);
      brace(x1, x2, `Λ = ${(LAMBDA*1e6).toFixed(1)} µm`);

      // optical thickness note
      ctx.fillStyle='rgba(185,196,230,0.95)';
      ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(`Constraint: n₁ d₁ = n₂ d₂  →  ${(n1*d1*1e6).toFixed(3)} µm·(index) = ${(n2*d2*1e6).toFixed(3)} µm·(index)`, x0+10, y0+H-6);

      ctx.restore();
    }

    // ---------- Drawing: Band diagram ----------
    function computeBandPoints(n1,n2){
      // Sample frequency range and keep points where |cosK|<=1
      const est = fourierEstimates(n1,n2);
      const f0 = est.fB;
      const span = (Math.abs(n2-n1) > 1.0) ? 0.9 : 0.30;
      const fMin = Math.max(1e9, f0*(1-span));
      const fMax = f0*(1+span);
      const N = 2200;
      const pts = [];
      for(let i=0;i<N;i++){
        const f = fMin + (fMax-fMin)*i/(N-1);
        const ck = cosK_fromTransfer(n1,n2,f).cosK;
        if(Math.abs(ck) <= 1){
          const K = Math.acos(ck)/LAMBDA; // rad/m in [0, π/Λ]
          pts.push({K, fTHz: f/1e12});
        }
      }
      // attempt to find exact lowest gap edges for annotation
      const ex = exactMidgapAndRatio(n1,n2);
      return {pts, fMinTHz:fMin/1e12, fMaxTHz:fMax/1e12, ex};
    }

    function drawBand(n1,n2, est){
      const {ctx, resize} = band;
      const {w,h} = resize();
      ctx.clearRect(0,0,w,h);

      const model = ui.modelSel.value;

      // Compute points
      const data = computeBandPoints(n1,n2);
      const pts = data.pts;

      // Axes ranges
      const Kmin = 0;
      const Kmax = Math.PI / LAMBDA;
      // Y range from data
      const yMin = data.fMinTHz;
      const yMax = data.fMaxTHz;

      const ax = drawAxes(ctx, {x:0,y:0,w:w,h:h}, Kmin,Kmax, yMin,yMax, {
        title:'Band diagram (normal incidence): allowed Bloch K vs frequency',
        xLabel:'Bloch wavevector K (rad/m)',
        yLabel:'Frequency f (THz)',
        grid:true
      });

      // Plot allowed points (exact bands)
      if(model==='exact' || model==='both'){
        ctx.save();
        ctx.fillStyle='rgba(124,240,255,0.55)';
        for(const p of pts){
          const x = ax.xToPx(p.K);
          const y = ax.yToPx(p.fTHz);
          ctx.fillRect(x-0.7, y-0.7, 1.4, 1.4);
        }
        ctx.restore();
      }

      // Annotate stopband from exact if available
      if((model==='exact' || model==='both') && data.ex){
        const fH = data.ex.fHigh/1e12;
        const fL = data.ex.fLow/1e12;
        const y1 = ax.yToPx(fH);
        const y2 = ax.yToPx(fL);
        const px = ax.plot.x;
        const pw = ax.plot.w;

        ctx.save();
        ctx.fillStyle='rgba(255,124,154,0.10)';
        ctx.fillRect(px, y1, pw, y2-y1);
        ctx.strokeStyle='rgba(255,124,154,0.35)';
        ctx.lineWidth=1.2;
        ctx.strokeRect(px, y1, pw, y2-y1);

        ctx.fillStyle='rgba(255,210,124,0.95)';
        ctx.font='600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
        const label = `Exact lowest stopband: ${fL.toFixed(2)}–${fH.toFixed(2)} THz (Δf/fmid≈${data.ex.ratio.toFixed(3)})`;
        ctx.fillText(label, px+10, y1-6);
        ctx.restore();
      }

      // Fourier markers (midgap and edges estimate)
      if(model==='fourier' || model==='both'){
        const fmid = est.fB/1e12; // Fourier midgap
        const ratio = est.ratio;
        const fLow = fmid*(1 - ratio/2);
        const fHigh = fmid*(1 + ratio/2);

        ctx.save();
        // midline
        ctx.strokeStyle='rgba(183,255,124,0.55)';
        ctx.lineWidth=1.4;
        ctx.setLineDash([6,4]);
        ctx.beginPath();
        ctx.moveTo(ax.plot.x, ax.yToPx(fmid));
        ctx.lineTo(ax.plot.x+ax.plot.w, ax.yToPx(fmid));
        ctx.stroke();

        // edges
        ctx.strokeStyle='rgba(183,255,124,0.35)';
        ctx.lineWidth=1.1;
        ctx.setLineDash([3,4]);
        ctx.beginPath();
        ctx.moveTo(ax.plot.x, ax.yToPx(fLow));
        ctx.lineTo(ax.plot.x+ax.plot.w, ax.yToPx(fLow));
        ctx.moveTo(ax.plot.x, ax.yToPx(fHigh));
        ctx.lineTo(ax.plot.x+ax.plot.w, ax.yToPx(fHigh));
        ctx.stroke();
        ctx.setLineDash([]);

        ctx.fillStyle='rgba(234,240,255,0.92)';
        ctx.font='600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
        ctx.fillText(`Fourier estimate: fB=${fmid.toFixed(2)} THz`, ax.plot.x+10, ax.yToPx(fmid)-6);
        ctx.fillStyle='rgba(185,196,230,0.92)';
        ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
        ctx.fillText(`Δf/fmid≈${ratio.toFixed(3)} → edges ≈ ${fLow.toFixed(2)}–${fHigh.toFixed(2)} THz`, ax.plot.x+10, ax.yToPx(fHigh)-6);

        ctx.restore();
      }

      // Legend
      const items=[];
      if(model==='exact' || model==='both') items.push({label:'Allowed bands (exact)', color:'rgba(124,240,255,0.70)'});
      if(model==='fourier' || model==='both') items.push({label:'Fourier markers', color:'rgba(183,255,124,0.70)'});
      if(items.length){
        drawLegend(ctx, items, ax.plot.x+10, ax.plot.y+22);
      }
    }

    // ---------- Drawing: Sweep plot ----------
    function drawSweep(n1,n2){
      const {ctx, resize} = sweep;
      const {w,h} = resize();
      ctx.clearRect(0,0,w,h);

      // sweep n2 from 1.0 to 4.5, keeping n1 fixed and equal optical thickness enforced
      const n2min=1.0, n2max=4.5;
      const N=220;
      const xs=[], ys=[];
      let yMax = 0;
      for(let i=0;i<N;i++){
        const nn2 = n2min + (n2max-n2min)*i/(N-1);
        const est = fourierEstimates(n1, nn2);
        const y = est.ratio;
        xs.push(nn2);
        ys.push(y);
        yMax = Math.max(yMax, y);
      }
      const yMin = 0;
      yMax = Math.max(0.05, yMax*1.05);

      const ax = drawAxes(ctx, {x:0,y:0,w:w,h:h}, n2min,n2max, yMin,yMax, {
        title:'Fourier sweep: gap–midgap ratio vs n₂ (equal optical thickness)',
        xLabel:'n₂ (dimensionless)',
        yLabel:'Δf / fmid (dimensionless)',
        grid:true
      });

      // curve
      ctx.save();
      ctx.strokeStyle='rgba(124,240,255,0.75)';
      ctx.lineWidth=2;
      ctx.beginPath();
      for(let i=0;i<N;i++){
        const x = ax.xToPx(xs[i]);
        const y = ax.yToPx(ys[i]);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // current point
      const estNow = fourierEstimates(n1,n2);
      const cx = ax.xToPx(n2);
      const cy = ax.yToPx(estNow.ratio);

      ctx.fillStyle='rgba(255,210,124,0.95)';
      ctx.beginPath(); ctx.arc(cx, cy, 5.5, 0, Math.PI*2); ctx.fill();
      ctx.strokeStyle='rgba(255,210,124,0.55)';
      ctx.lineWidth=2;
      ctx.beginPath(); ctx.arc(cx, cy, 9, 0, Math.PI*2); ctx.stroke();

      ctx.fillStyle='rgba(234,240,255,0.92)';
      ctx.font='600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(`Current: n₂=${n2.toFixed(2)}, Δf/fmid≈${estNow.ratio.toFixed(4)}`, ax.plot.x+10, ax.plot.y+22);

      ctx.restore();

      drawLegend(ctx, [
        {label:'Sweep curve (Fourier)', color:'rgba(124,240,255,0.75)'},
        {label:'Current (n₁,n₂)', color:'rgba(255,210,124,0.95)'}
      ], ax.plot.x+10, ax.plot.y+40);
    }

    // ---------- Update text + final answer content ----------
    function updateKPIs(n1,n2, est){
      ui.n1Val.textContent = n1.toFixed(2);
      ui.n2Val.textContent = n2.toFixed(2);
      ui.dVals.textContent = `${(est.d1*1e6).toFixed(3)}, ${(est.d2*1e6).toFixed(3)}`;
      ui.epsVals.textContent = `${est.ebar.toFixed(3)}, ${est.eG.toFixed(3)}`;
      ui.fBVal.textContent = (est.fB/1e12).toFixed(2);
      ui.ratioVal.textContent = est.ratio.toFixed(4);
    }

    function rebuildFinalAnswer(){
      // Always show the two required cases (problem statement), with Fourier estimate values.
      const A = fourierEstimates(1.5, 3.5);
      const B = fourierEstimates(3.4, 3.6);

      const txt =
`Case A (n1=1.5, n2=3.5, Λ=2 µm, equal optical thickness):
d1=${(A.d1*1e6).toFixed(2)} µm, d2=${(A.d2*1e6).toFixed(2)} µm
ε̄=${A.ebar.toFixed(2)}, |εG|=${A.eG.toFixed(3)}
Bragg (midgap) frequency: fB = c/(2Λ√ε̄) = ${(A.fB/1e12).toFixed(2)} THz
Gap–midgap ratio: Δf/fmid ≈ |εG|/ε̄ = ${A.ratio.toFixed(4)}

Case B (n1=3.4, n2=3.6, Λ=2 µm, equal optical thickness):
d1=${(B.d1*1e6).toFixed(4)} µm, d2=${(B.d2*1e6).toFixed(4)} µm
ε̄=${B.ebar.toFixed(2)}, |εG|=${B.eG.toFixed(4)}
Bragg (midgap) frequency: fB = ${(B.fB/1e12).toFixed(2)} THz
Gap–midgap ratio: Δf/fmid ≈ ${B.ratio.toFixed(5)}

Comparison:
Case A has a much wider lowest bandgap (≈${(A.ratio*100).toFixed(1)}% of midgap) due to strong index contrast.
Case B has a very narrow lowest bandgap (≈${(B.ratio*100).toFixed(2)}% of midgap) due to weak index contrast.`;

      document.getElementById('finalAnswerText').textContent = txt;
    }

    // ---------- Render all ----------
    function renderAll(){
      const n1 = parseFloat(ui.n1.value);
      const n2 = parseFloat(ui.n2.value);

      const est = fourierEstimates(n1,n2);
      updateKPIs(n1,n2,est);

      drawDiagram(n1,n2,est);
      drawBand(n1,n2,est);
      drawSweep(n1,n2);
    }

    // Resize handling
    let resizeTimer = null;
    window.addEventListener('resize', ()=>{
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(renderAll, 80);
    });

    // Initialize
    updatePresetLabel();
    updateModelLabel();
    rebuildFinalAnswer();
    setSliders(presets.A.n1, presets.A.n2); // starts on Case A
    renderAll();
  </script>
</body>
</html>
