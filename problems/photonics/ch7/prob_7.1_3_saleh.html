<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Air Gap in Glass (Fabry–Pérot + FTIR Tunneling) — Transmittance at Normal & Beyond Critical Angle</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1733;
      --card:#111b3f;
      --muted:#9bb0ffcc;
      --text:#e9eeff;
      --soft:#cfd8ff;
      --accent:#7aa2ff;
      --accent2:#7dffcc;
      --warn:#ffcc66;
      --danger:#ff6b8a;
      --ok:#7dffcc;
      --line:#223063;
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --shadow2: 0 10px 24px rgba(0,0,0,.28);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1100px 700px at 18% 6%, rgba(122,162,255,.18), transparent 58%),
                  radial-gradient(900px 600px at 86% 12%, rgba(125,255,204,.12), transparent 55%),
                  radial-gradient(900px 800px at 50% 105%, rgba(255,204,102,.10), transparent 50%),
                  linear-gradient(180deg, var(--bg), #050816 65%, #040613);
      color:var(--text);
      line-height:1.6;
    }

    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      position:relative;
      padding: 44px 18px 22px;
      border-bottom:1px solid rgba(255,255,255,.06);
    }
    .wrap{max-width:1200px; margin:0 auto}
    .hero{
      display:grid;
      grid-template-columns: 1.6fr 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 960px){
      .hero{grid-template-columns: 1fr}
    }
    h1{
      margin:0 0 10px;
      font-size: clamp(24px, 2.6vw, 38px);
      line-height:1.15;
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      max-width: 70ch;
      margin:0;
      font-size: 1.03rem;
    }
    .meta{
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      color: rgba(233,238,255,.85);
      font-size:.95rem;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .dot{
      width:9px;height:9px;border-radius:50%;
      background: var(--accent2);
      box-shadow: 0 0 0 3px rgba(125,255,204,.12);
    }

    /* Layout */
    main{padding: 18px 18px 54px}
    .grid{
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{grid-template-columns: 1fr}
    }

    /* Sticky mini TOC */
    nav.toc{
      position: sticky;
      top: 14px;
      align-self:start;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(17,27,63,.92), rgba(15,23,51,.86));
      border: 1px solid rgba(255,255,255,.08);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .toc header{
      padding:14px 14px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .toc h2{
      margin:0;
      font-size: 1rem;
      letter-spacing:.3px;
    }
    .toc .hint{margin:6px 0 0; color: var(--muted); font-size:.88rem}
    .toc ul{
      list-style:none;
      margin:0;
      padding: 10px 10px 12px;
      display:grid;
      gap:6px;
    }
    .toc a{
      display:block;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      color: rgba(233,238,255,.92);
      background: rgba(255,255,255,.02);
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .toc a:hover{
      transform: translateY(-1px);
      background: rgba(122,162,255,.10);
      border-color: rgba(122,162,255,.25);
      text-decoration:none;
    }
    .toc a small{display:block; color: var(--muted); font-size:.78rem; margin-top:2px}

    /* Cards/sections */
    section{
      background: linear-gradient(180deg, rgba(17,27,63,.82), rgba(15,23,51,.70));
      border: 1px solid rgba(255,255,255,.08);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    section + section{margin-top: 16px}
    section > header{
      padding: 16px 16px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    section > header h2{
      margin:0;
      font-size: 1.15rem;
      letter-spacing:.3px;
    }
    section > header p{
      margin: 6px 0 0;
      color: var(--muted);
      max-width: 85ch;
      font-size:.95rem;
    }
    .content{padding: 14px 16px 16px}
    h3{
      margin: 16px 0 8px;
      font-size: 1.06rem;
      letter-spacing:.2px;
    }
    .cols{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 860px){
      .cols{grid-template-columns: 1fr}
    }
    .callout{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius: var(--radius2);
      padding: 12px 12px;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
    }
    .callout strong{color: var(--soft)}
    .callout.assumptions{border-color: rgba(122,162,255,.25); background: rgba(122,162,255,.07)}
    .callout.keyeq{border-color: rgba(125,255,204,.22); background: rgba(125,255,204,.06)}
    .callout.mistakes{border-color: rgba(255,204,102,.25); background: rgba(255,204,102,.06)}
    .callout.final{border-color: rgba(125,255,204,.28); background: rgba(125,255,204,.09)}
    .callout.warning{border-color: rgba(255,107,138,.28); background: rgba(255,107,138,.07)}

    .eq{
      font-family: var(--mono);
      font-size: .95rem;
      color: rgba(233,238,255,.95);
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.08);
      padding: 10px 10px;
      border-radius: 14px;
      overflow:auto;
      position:relative;
    }
    .eq .label{
      position:absolute;
      top:8px; right:10px;
      font-family: var(--sans);
      font-size:.75rem;
      color: var(--muted);
    }
    .copybar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    button.copy{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.05);
      color: rgba(233,238,255,.95);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      box-shadow: inset 0 1px 0 rgba(255,255,255,.06);
      font-size:.92rem;
    }
    button.copy:hover{
      transform: translateY(-1px);
      background: rgba(122,162,255,.10);
      border-color: rgba(122,162,255,.25);
    }
    button.copy:active{transform: translateY(0px) scale(.99)}
    .small{color: var(--muted); font-size:.93rem}
    ul{margin: 8px 0 0 18px}
    li{margin: 4px 0}
    .kpi{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 860px){
      .kpi{grid-template-columns: repeat(2, 1fr)}
    }
    .kpi .box{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
      border-radius: 16px;
      padding: 10px 10px;
    }
    .kpi .box .t{color: var(--muted); font-size:.82rem}
    .kpi .box .v{
      font-family: var(--mono);
      font-size: 1.02rem;
      margin-top:4px;
      color: rgba(233,238,255,.95);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    /* Visualization area */
    .vizGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    .vizCard{
      border:1px solid rgba(255,255,255,.08);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .vizHeader{
      padding: 12px 12px 10px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      border-bottom: 1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .vizHeader h3{margin:0; font-size:1rem}
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:flex-end;
      justify-content:flex-start;
    }
    .control{
      display:grid;
      gap:4px;
      min-width: 170px;
    }
    .control label{
      font-size:.82rem;
      color: var(--muted);
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    .control label span.val{
      font-family: var(--mono);
      color: rgba(233,238,255,.92);
    }
    input[type="range"]{
      width: 100%;
      accent-color: var(--accent);
    }
    select{
      width: 100%;
      background: rgba(255,255,255,.05);
      color: rgba(233,238,255,.95);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 8px 10px;
      outline:none;
    }
    .canvasWrap{
      padding: 10px;
    }
    canvas{
      width:100%;
      height: 320px;
      display:block;
      border-radius: 14px;
      background: rgba(10,14,30,.60);
      border: 1px solid rgba(255,255,255,.07);
    }
    @media (max-width: 860px){
      canvas{height: 300px}
    }
    .footNote{
      margin-top: 10px;
      color: var(--muted);
      font-size: .9rem;
    }

    footer{
      padding: 24px 18px 40px;
      color: var(--muted);
      text-align:center;
      font-size:.92rem;
    }

    /* Print-friendly */
    @media print{
      body{background:#fff; color:#000}
      section, nav.toc{box-shadow:none; background:#fff; border:1px solid #ddd}
      .eq{background:#f7f7f7; color:#000}
      a{color:#000; text-decoration:underline}
      .vizCard, canvas{display:none !important}
      header{border-bottom:1px solid #ddd}
      .pill{border:1px solid #ddd; background:#fff}
      button.copy{display:none !important}
    }

    /* Subtle animation */
    @keyframes fadeUp{
      from{opacity:0; transform: translateY(6px)}
      to{opacity:1; transform: translateY(0)}
    }
    section{animation: fadeUp .35s ease both}
  </style>
</head>
<body>
<header>
  <div class="wrap hero">
    <div>
      <h1>7.1-3 — Air Gap in Glass: Transmittance at Normal Incidence & Beyond the Critical Angle (TE)</h1>
      <p class="subtitle">
        A thin <em>air</em> layer sandwiched between two identical glass half-spaces acts like a Fabry–Pérot film at small angles,
        and like a <em>tunneling barrier</em> (frustrated total internal reflection) above the critical angle.
        We derive the transmittance formulas and connect them to intuitive wave physics.
      </p>
      <div class="meta">
        <span class="pill"><span class="dot"></span>vanilla HTML/CSS/JS</span>
        <span class="pill"><span class="dot" style="background:var(--warn)"></span>transfer-matrix results</span>
        <span class="pill"><span class="dot" style="background:var(--accent)"></span>interactive plots</span>
      </div>
    </div>
    <div class="callout assumptions">
      <strong>Problem:</strong> An air gap of thickness <span style="font-family:var(--mono)">d = λ/2 in glass (index n)</span> sits inside glass.
      Find the <strong>transmittance</strong> (a) at normal incidence and (b) for <strong>TE</strong> incidence at an angle greater than the critical angle.
      Can the wave <strong>penetrate (tunnel)</strong> through the gap?
      <div class="small" style="margin-top:8px">
        Note: “λ in glass” usually means <span style="font-family:var(--mono)">λg = λ0/n</span>, so <span style="font-family:var(--mono)">d = λg/2 = λ0/(2n)</span>.
        We keep the final result symbolic and use example values only for plotting.
      </div>
    </div>
  </div>
</header>

<main>
  <div class="wrap grid">
    <nav class="toc" aria-label="Table of contents">
      <header>
        <h2>Mini Table of Contents</h2>
        <p class="hint">Sticky navigation — click to jump.</p>
      </header>
      <ul>
        <li><a href="#quick-summary">Quick Summary<small>Result types & key equations</small></a></li>
        <li><a href="#part0">PART 0 — Concept Primer<small>Thin films, critical angle, evanescent waves</small></a></li>
        <li><a href="#part1">PART 1 — Problem Analysis<small>Given/unknowns, assumptions, approaches</small></a></li>
        <li><a href="#part2">PART 2 — Strategy & Tips<small>Roadmap before algebra</small></a></li>
        <li><a href="#part3">PART 3 — Full Solution<small>Normal incidence + TE above critical</small></a></li>
        <li><a href="#part4">PART 4 — Deeper Understanding<small>Interpretation, parameter dependence</small></a></li>
        <li><a href="#part5">PART 5 — Visualization Guide<small>How to read the canvases</small></a></li>
      </ul>
    </nav>

    <article>
      <!-- Quick Summary -->
      <section id="quick-summary">
        <header>
          <h2>Quick Summary</h2>
          <p>What the problem is about, the key physics idea, governing equations, and the final result type.</p>
        </header>
        <div class="content">
          <ul>
            <li><strong>Setup:</strong> glass (index <span style="font-family:var(--mono)">n</span>) – air gap (index 1, thickness <span style="font-family:var(--mono)">d</span>) – glass, with plane-wave incidence from glass.</li>
            <li><strong>Key idea:</strong> the air layer produces multiple reflections (Fabry–Pérot). Above the <strong>critical angle</strong>, the field in air is <strong>evanescent</strong> yet can still carry energy across if the gap is thin: <strong>frustrated total internal reflection</strong> (optical tunneling).</li>
            <li><strong>Governing tools:</strong> Fresnel coefficients + thin-film (transfer-matrix) interference; conservation of tangential wavevector <span style="font-family:var(--mono)">k<sub>x</sub></span>.</li>
            <li><strong>Normal-incidence transmittance (symbolic):</strong>
              <span style="font-family:var(--mono)">T = 1 / (1 + F sin²δ)</span>, with
              <span style="font-family:var(--mono)">F = (n²−1)²/(4n²)</span> and <span style="font-family:var(--mono)">δ = (2π/λ₀) d</span>.</li>
            <li><strong>TE transmittance above critical (symbolic):</strong>
              <span style="font-family:var(--mono)">T = 1 / (1 + A sinh²a)</span>,
              where <span style="font-family:var(--mono)">a = (2π/λ₀) d √(n² sin²θ − 1)</span> and
              <span style="font-family:var(--mono)">A = (n²−1)² / (4 n² cos²θ (n² sin²θ − 1))</span>.</li>
            <li><strong>Answer to “can it tunnel?”</strong> Yes. For <span style="font-family:var(--mono)">θ &gt; θc = arcsin(1/n)</span>, transmission is <em>nonzero</em> but decreases roughly exponentially with gap thickness via <span style="font-family:var(--mono)">sinh²a</span>.</li>
            <li><strong>For the stated thickness:</strong> if “<span style="font-family:var(--mono)">d = λ/2 in glass</span>” means <span style="font-family:var(--mono)">d = λg/2 = λ₀/(2n)</span>, then <span style="font-family:var(--mono)">δ = π/n</span> (normal incidence) and <span style="font-family:var(--mono)">a = (π/n)√(n² sin²θ − 1)</span> (above critical).</li>
          </ul>

          <div class="callout final" style="margin-top:12px">
            <strong>Final-result type:</strong> closed-form symbolic transmittance formulas (with optional numeric evaluation for any chosen <span style="font-family:var(--mono)">n, θ, d/λ₀</span>).
            <div class="copybar">
              <button class="copy" data-copy="T_normal = 1 / (1 + F*sin^2(delta)),  F = (n^2-1)^2/(4*n^2),  delta = (2*pi/lambda0)*d">
                Copy normal-incidence formula
              </button>
              <button class="copy" data-copy="For TE and theta > theta_c:  T = 1 / (1 + A*sinh^2(a)),  a = (2*pi/lambda0)*d*sqrt(n^2*sin^2(theta)-1),  A = (n^2-1)^2/(4*n^2*cos^2(theta)*(n^2*sin^2(theta)-1))">
                Copy TE tunneling formula
              </button>
            </div>
          </div>
        </div>
      </section>

      <!-- PART 0 -->
      <section id="part0">
        <header>
          <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>
          <p>A short textbook-style primer: definitions, meanings, laws, approximations, intuition, and pitfalls.</p>
        </header>
        <div class="content">
          <div class="cols">
            <div class="callout">
              <h3 style="margin-top:0">Core definitions</h3>
              <ul>
                <li><strong>Refractive index</strong> <span style="font-family:var(--mono)">n</span> (dimensionless): sets phase speed <span style="font-family:var(--mono)">v = c/n</span> and wave number <span style="font-family:var(--mono)">k = n k₀</span> with <span style="font-family:var(--mono)">k₀ = 2π/λ₀</span>.</li>
                <li><strong>Transmittance</strong> <span style="font-family:var(--mono)">T</span> (dimensionless): ratio of transmitted to incident <em>time-averaged power flux</em> normal to the interface.</li>
                <li><strong>TE polarization</strong> (a.k.a. s-polarized): electric field perpendicular to the plane of incidence.</li>
                <li><strong>Phase thickness</strong> <span style="font-family:var(--mono)">δ</span> (radians): accumulated phase through the film along its normal component:
                  <span style="font-family:var(--mono)">δ = k₀ n₂ d cosθ₂</span> for a layer with index <span style="font-family:var(--mono)">n₂</span>.</li>
              </ul>
            </div>

            <div class="callout">
              <h3 style="margin-top:0">Physical meaning of key quantities</h3>
              <ul>
                <li><span style="font-family:var(--mono)">k<sub>x</sub></span> (tangential wavevector component) is conserved across planar boundaries → determines whether the field in air is propagating or evanescent.</li>
                <li><span style="font-family:var(--mono)">θc = arcsin(1/n)</span> is the <strong>critical angle</strong> for glass→air. Above it, Snell’s law demands <span style="font-family:var(--mono)">sinθ₂ &gt; 1</span>, so <span style="font-family:var(--mono)">cosθ₂</span> becomes imaginary and the wave decays exponentially in air.</li>
                <li><span style="font-family:var(--mono)">sinh</span> in the tunneling formula reflects exponential decay across a barrier; thinner gaps transmit more.</li>
              </ul>
            </div>
          </div>

          <div class="cols">
            <div class="callout keyeq">
              <h3 style="margin-top:0">Key laws/principles (and validity)</h3>
              <ul>
                <li><strong>Maxwell boundary conditions</strong> at interfaces → Fresnel reflection/transmission coefficients.</li>
                <li><strong>Planar stratified media</strong> → transfer-matrix (thin-film) method sums infinite multiple reflections exactly (linear, time-harmonic, homogeneous layers).</li>
                <li><strong>Snell’s law</strong> <span style="font-family:var(--mono)">n sinθ = n₂ sinθ₂</span> comes from tangential <span style="font-family:var(--mono)">k</span> continuity (valid for planar boundaries).</li>
                <li><strong>Lossless media</strong> assumption here (no absorption). Then oscillations (below critical) and exponential suppression (above critical) dominate.</li>
              </ul>
            </div>

            <div class="callout">
              <h3 style="margin-top:0">Common models/approximations (why used)</h3>
              <ul>
                <li><strong>Plane-wave model</strong>: appropriate when beam is wide relative to wavelength and interfaces are flat.</li>
                <li><strong>Thin-film interference</strong>: treats the gap as a “film” with repeated internal reflections, capturing resonance/anti-resonance.</li>
                <li><strong>FTIR tunneling picture</strong>: for <span style="font-family:var(--mono)">θ &gt; θc</span>, the air region is a classically forbidden region for propagation; energy transfer occurs via overlap of evanescent fields across the finite barrier.</li>
              </ul>
            </div>
          </div>

          <div class="callout" style="margin-top:14px">
            <h3 style="margin-top:0">Mini intuition examples</h3>
            <ul>
              <li><strong>Below critical angle:</strong> the wave propagates in air; the gap behaves like a Fabry–Pérot etalon, giving oscillatory <span style="font-family:var(--mono)">T(θ)</span> vs thickness/angle.</li>
              <li><strong>Above critical angle:</strong> a single glass→air interface would totally internally reflect, but a second glass surface “close enough” allows the evanescent field to couple into it → partial transmission (like quantum tunneling).</li>
            </ul>
          </div>

          <div class="callout mistakes" style="margin-top:14px">
            <h3 style="margin-top:0">What to watch for (pitfalls)</h3>
            <ul>
              <li>Confusing <strong>free-space wavelength</strong> <span style="font-family:var(--mono)">λ₀</span> with <strong>wavelength in glass</strong> <span style="font-family:var(--mono)">λg = λ₀/n</span>.</li>
              <li>Using single-interface Fresnel formulas only — the <strong>gap requires multiple reflections</strong>.</li>
              <li>Above critical angle, trying to use <span style="font-family:var(--mono)">cosθ₂ = √(1−sin²θ₂)</span> with <span style="font-family:var(--mono)">sinθ₂ &gt; 1</span> without allowing it to become imaginary.</li>
              <li>Mixing TE and TM formulas (their “impedances/admittances” differ).</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- PART 1 -->
      <section id="part1">
        <header>
          <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>
          <p>Restate the task, identify knowns/unknowns, justify principles, list assumptions, compare approaches.</p>
        </header>
        <div class="content">
          <h3>Restate the problem (in plain words)</h3>
          <p>
            Two identical glass regions (refractive index <span style="font-family:var(--mono)">n</span>) are separated by a thin planar air gap of thickness
            <span style="font-family:var(--mono)">d</span>. A plane wave in glass hits the gap.
            We must find the <strong>power transmittance</strong> through the gap for:
            (a) normal incidence; (b) TE polarization at an incidence angle <em>greater than the critical angle</em>.
            Finally, decide whether transmission can occur (tunneling).
          </p>

          <div class="cols">
            <div class="callout">
              <h3 style="margin-top:0">Given quantities</h3>
              <ul>
                <li>Glass refractive index: <span style="font-family:var(--mono)">n</span></li>
                <li>Air gap index: <span style="font-family:var(--mono)">n₂ = 1</span></li>
                <li>Gap thickness: <span style="font-family:var(--mono)">d = λ/2 in glass</span> (commonly interpreted as <span style="font-family:var(--mono)">d = λg/2 = λ₀/(2n)</span>)</li>
                <li>Case (b): TE polarization and <span style="font-family:var(--mono)">θ &gt; θc</span></li>
              </ul>
            </div>
            <div class="callout">
              <h3 style="margin-top:0">Unknowns / what must be found</h3>
              <ul>
                <li>Transmittance <span style="font-family:var(--mono)">T</span> for normal incidence.</li>
                <li>Transmittance <span style="font-family:var(--mono)">T</span> for TE incidence with <span style="font-family:var(--mono)">θ &gt; θc</span>.</li>
                <li>Qualitative conclusion: does the wave “tunnel” through the gap?</li>
              </ul>
            </div>
          </div>

          <div class="callout keyeq" style="margin-top:14px">
            <h3 style="margin-top:0">Relevant principles (and why)</h3>
            <ul>
              <li><strong>Stratified-medium optics:</strong> the gap is a thin layer between identical media → classic thin-film interference problem (multiple reflections matter).</li>
              <li><strong>Critical angle:</strong> for glass→air, <span style="font-family:var(--mono)">θc = arcsin(1/n)</span> separates propagating vs evanescent behavior in air.</li>
              <li><strong>TE Fresnel/impedance:</strong> the effective “admittance” for TE is proportional to <span style="font-family:var(--mono)">n cosθ</span> (with μ≈μ₀).</li>
              <li><strong>Why not ray optics alone?</strong> Ray optics cannot capture evanescent penetration and interference phases; we need wave optics.</li>
            </ul>
          </div>

          <div class="callout assumptions" style="margin-top:14px">
            <h3 style="margin-top:0">Assumptions / idealizations</h3>
            <ul>
              <li>Planar, parallel interfaces; uniform gap thickness <span style="font-family:var(--mono)">d</span>.</li>
              <li>Monochromatic steady-state plane wave.</li>
              <li>Linear, isotropic, non-magnetic media (μ≈μ₀), no absorption.</li>
              <li>Coherent interference inside the gap (phase preserved).</li>
            </ul>
          </div>

          <h3>Possible approaches (compare)</h3>
          <ul>
            <li><strong>Transfer-matrix method (best here):</strong> systematic and works for both propagating and evanescent regimes; gives closed-form <span style="font-family:var(--mono)">T</span>.</li>
            <li><strong>Multiple-reflection summation:</strong> physically intuitive (infinite geometric series), excellent at normal incidence; becomes algebra-heavy at oblique TE with evanescence unless you already know the complex Fresnel coefficients.</li>
            <li><strong>Energy-flux + boundary conditions directly:</strong> possible but lengthy; essentially reproduces transfer-matrix work.</li>
          </ul>
          <p><strong>Choice:</strong> We use transfer-matrix (thin-film) results specialized to a symmetric three-layer system; it stays clean and naturally handles <span style="font-family:var(--mono)">θ &gt; θc</span> via imaginary phase thickness.</p>
        </div>
      </section>

      <!-- PART 2 -->
      <section id="part2">
        <header>
          <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>
          <p>A minimal plan of attack (no full algebra yet), with physical meaning and common mistakes.</p>
        </header>
        <div class="content">
          <ol>
            <li>
              <strong>Define geometry and angles.</strong><br/>
              <span class="small">Tool:</span> Snell’s law from tangential <span style="font-family:var(--mono)">k</span> continuity.<br/>
              <span class="small">Meaning:</span> tells whether the gap supports propagation or an evanescent decay.
            </li>
            <li>
              <strong>Pick the correct TE “admittances.”</strong><br/>
              <span class="small">Tool:</span> For TE, use <span style="font-family:var(--mono)">q = n cosθ</span> (in each medium).<br/>
              <span class="small">Meaning:</span> encodes boundary-condition matching for TE polarization.
            </li>
            <li>
              <strong>Write the thin-film transmittance form for a symmetric system.</strong><br/>
              <span class="small">Tool:</span> Standard result <span style="font-family:var(--mono)">T = 1 / (1 + F sin²δ)</span> (propagating layer).<br/>
              <span class="small">Meaning:</span> interference fringes controlled by phase thickness <span style="font-family:var(--mono)">δ</span>.
            </li>
            <li>
              <strong>Handle the above-critical case by letting the phase become imaginary.</strong><br/>
              <span class="small">Tool:</span> Replace <span style="font-family:var(--mono)">δ → i a</span>, so <span style="font-family:var(--mono)">sin²δ → -sinh²a</span>.<br/>
              <span class="small">Meaning:</span> turns oscillations into exponential suppression (tunneling behavior).
            </li>
            <li>
              <strong>Specialize to (a) normal incidence and (b) TE with θ &gt; θc.</strong><br/>
              <span class="small">Tool:</span> Substitute <span style="font-family:var(--mono)">θ=0</span> for (a), and use <span style="font-family:var(--mono)">a=(2π/λ₀)d√(n²sin²θ−1)</span> for (b).<br/>
              <span class="small">Meaning:</span> yields the requested transmittances.
            </li>
            <li>
              <strong>Insert the given thickness interpretation.</strong><br/>
              <span class="small">Tool:</span> If <span style="font-family:var(--mono)">d=λg/2=λ₀/(2n)</span>, then <span style="font-family:var(--mono)">δ=π/n</span> and <span style="font-family:var(--mono)">a=(π/n)√(n²sin²θ−1)</span>.<br/>
              <span class="small">Meaning:</span> fixes where you sit on the interference/tunneling curves.
            </li>
            <li>
              <strong>Sanity checks.</strong><br/>
              <span class="small">Tool:</span> limiting cases: <span style="font-family:var(--mono)">d→0</span> gives <span style="font-family:var(--mono)">T→1</span>; <span style="font-family:var(--mono)">d→∞</span> above critical gives <span style="font-family:var(--mono)">T→0</span>.<br/>
              <span class="small">Meaning:</span> confirm physical plausibility.
            </li>
          </ol>

          <div class="callout mistakes" style="margin-top:12px">
            <strong>Quick tips / common mistakes:</strong>
            <ul>
              <li>Use <span style="font-family:var(--mono)">λ₀</span> for phase in the air gap: <span style="font-family:var(--mono)">δ = (2π/λ₀) d cosθ₂</span>.</li>
              <li>For <span style="font-family:var(--mono)">θ &gt; θc</span>, write <span style="font-family:var(--mono)">cosθ₂ = i√(n²sin²θ−1)</span> (not “undefined”).</li>
              <li>Do not forget that <span style="font-family:var(--mono)">T</span> is <em>power</em> transmittance, not field amplitude.</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- PART 3 -->
      <section id="part3">
        <header>
          <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>
          <p>Start with qualitative expectations, then derive step-by-step with symbol definitions, checks, and interpretation.</p>
        </header>
        <div class="content">
          <h3>Physical intuition (before calculating)</h3>
          <ul>
            <li><strong>Normal incidence:</strong> the air gap is a low-index “film” between identical glass media → partial reflections at both boundaries. Multiple bounces interfere. So <span style="font-family:var(--mono)">T</span> will depend on the phase <span style="font-family:var(--mono)">δ</span> across the gap.</li>
            <li><strong>Above the critical angle (TE):</strong> each single glass→air boundary would totally internally reflect (no propagating wave in air). But a finite gap allows the evanescent field to reach the second glass interface and couple into a transmitted wave → <strong>nonzero</strong> transmission that decreases rapidly as the gap thickens.</li>
          </ul>

          <div class="callout keyeq">
            <h3 style="margin-top:0">Step 1 — Geometry, Snell’s law, and evanescence</h3>
            <p>
              Let the incident angle in glass be <span style="font-family:var(--mono)">θ</span> (measured from the normal).
              The tangential component of the wavevector is conserved:
            </p>
            <div class="eq" id="eq-kx">
              <span class="label">Key relation</span>
              kx = n k0 sinθ = n2 k0 sinθ2,  with k0 = 2π/λ0 and n2=1 (air).
            </div>
            <p class="small">
              Thus <span style="font-family:var(--mono)">sinθ₂ = n sinθ</span>.
              If <span style="font-family:var(--mono)">n sinθ &lt; 1</span>, the wave in air propagates.
              If <span style="font-family:var(--mono)">n sinθ &gt; 1</span>, then <span style="font-family:var(--mono)">θ &gt; θc = arcsin(1/n)</span> and the air field is evanescent.
            </p>
            <div class="copybar">
              <button class="copy" data-copy="Critical angle (glass->air):  theta_c = arcsin(1/n)">Copy critical angle</button>
              <button class="copy" data-copy="Snell via kx: sin(theta2) = n*sin(theta) (for air n2=1)">Copy Snell form</button>
            </div>
          </div>

          <h3>Step 2 — TE “admittances” and the symmetric-film transmittance form</h3>
          <p>
            For stratified media, it is convenient to define a TE admittance-like quantity
            (for non-magnetic media, up to common constants):
          </p>
          <div class="eq" id="eq-q">
            <span class="label">TE definition</span>
            qj = nj cosθj   (TE / s-polarization)
          </div>
          <p class="small">
            Here medium 1 is glass (index <span style="font-family:var(--mono)">n</span>), medium 2 is air (index 1), and medium 3 is glass (index <span style="font-family:var(--mono)">n</span>).
            Because media 1 and 3 are identical, the system is symmetric.
          </p>

          <div class="callout keyeq">
            <h3 style="margin-top:0">Step 3 — Thin-film transmittance (propagating layer)</h3>
            <p>
              For a lossless symmetric three-layer system (1–2–1) with a <em>propagating</em> wave in layer 2,
              the TE power transmittance can be written in the compact “Fabry–Pérot” form:
            </p>
            <div class="eq" id="eq-Tprop">
              <span class="label">Fabry–Pérot form</span>
              T = 1 / ( 1 + F sin^2(δ) ),
              where  F = (q1^2 - q2^2)^2 / (4 q1^2 q2^2),
              and  δ = k0 n2 d cosθ2 = (2π/λ0) d cosθ2  (since n2=1).
            </div>
            <p class="small">
              Interpretation: <span style="font-family:var(--mono)">F</span> measures impedance mismatch (how reflective each interface is),
              and <span style="font-family:var(--mono)">δ</span> is the phase accumulated across the gap. When <span style="font-family:var(--mono)">sin²δ=0</span>, the film is resonant and <span style="font-family:var(--mono)">T=1</span> (perfect transmission) in the ideal lossless symmetric case.
            </p>
            <div class="copybar">
              <button class="copy" data-copy="Propagating-gap (TE) transmittance for symmetric 1-2-1:  T = 1/(1 + F*sin^2(delta)),  F = (q1^2-q2^2)^2/(4*q1^2*q2^2),  qj = nj*cos(thetaj),  delta = (2*pi/lambda0)*d*cos(theta2)">
                Copy propagating-layer formula
              </button>
            </div>
          </div>

          <h3>Part (a) — Normal incidence</h3>
          <p>
            At normal incidence, <span style="font-family:var(--mono)">θ = 0</span>, so <span style="font-family:var(--mono)">cosθ = 1</span>.
            Also, Snell gives <span style="font-family:var(--mono)">θ₂ = 0</span> (if below critical—normal is always below critical).
            Therefore:
          </p>
          <ul>
            <li><span style="font-family:var(--mono)">q1 = n cos0 = n</span></li>
            <li><span style="font-family:var(--mono)">q2 = 1·cos0 = 1</span></li>
            <li><span style="font-family:var(--mono)">δ = (2π/λ₀) d</span></li>
          </ul>
          <p>Compute <span style="font-family:var(--mono)">F</span>:</p>
          <div class="eq" id="eq-Fnormal">
            <span class="label">Normal-incidence mismatch</span>
            F = (n^2 - 1)^2 / (4 n^2)
          </div>
          <p>So the normal-incidence transmittance is:</p>
          <div class="eq" id="eq-Tnormal">
            <span class="label">Answer (a)</span>
            T_normal = 1 / ( 1 + ((n^2 - 1)^2/(4 n^2)) * sin^2( (2π/λ0) d ) )
          </div>

          <div class="callout assumptions" style="margin-top:12px">
            <strong>About “d = λ/2 in glass”:</strong> If that means <span style="font-family:var(--mono)">d = λg/2 = (λ0/n)/2 = λ0/(2n)</span>, then
            <span style="font-family:var(--mono)">δ = (2π/λ0) d = π/n</span>, so
            <span style="font-family:var(--mono)">T_normal = 1 / ( 1 + ((n^2-1)^2/(4n^2)) * sin^2(π/n) )</span>.
          </div>

          <div class="copybar">
            <button class="copy" data-copy="T_normal = 1 / ( 1 + ((n^2 - 1)^2/(4 n^2)) * sin^2( (2*pi/lambda0)*d ) )">Copy final (a)</button>
            <button class="copy" data-copy="If d = lambda0/(2n):  T_normal = 1 / ( 1 + ((n^2 - 1)^2/(4 n^2)) * sin^2( pi/n ) )">Copy (a) with d=lambda0/(2n)</button>
          </div>

          <h3>Sanity checks for (a)</h3>
          <ul>
            <li><strong>Units:</strong> <span style="font-family:var(--mono)">F</span> is dimensionless, <span style="font-family:var(--mono)">δ</span> is in radians → <span style="font-family:var(--mono)">T</span> dimensionless ✔</li>
            <li><strong>Thin-gap limit:</strong> <span style="font-family:var(--mono)">d→0</span> ⇒ <span style="font-family:var(--mono)">sin²δ→0</span> ⇒ <span style="font-family:var(--mono)">T→1</span> ✔ (gap vanishes)</li>
            <li><strong>High mismatch:</strong> larger <span style="font-family:var(--mono)">n</span> increases <span style="font-family:var(--mono)">F</span> ⇒ deeper transmission minima ✔</li>
          </ul>

          <div class="callout keyeq" style="margin-top:14px">
            <h3 style="margin-top:0">Part (b) — TE incidence for θ &gt; θc (evanescent “tunneling”)</h3>
            <p>
              For <span style="font-family:var(--mono)">θ &gt; θc</span>, Snell gives <span style="font-family:var(--mono)">sinθ2 = n sinθ &gt; 1</span>.
              Define the positive decay parameter:
            </p>
            <div class="eq" id="eq-gamma">
              <span class="label">Evanescent parameter</span>
              γ = sqrt(n^2 sin^2θ - 1)   (dimensionless),  so  cosθ2 = i γ.
            </div>
            <p>
              The phase thickness in air becomes imaginary:
              <span style="font-family:var(--mono)">δ = (2π/λ0) d cosθ2 = i a</span>, where
            </p>
            <div class="eq" id="eq-a">
              <span class="label">Barrier “thickness”</span>
              a = (2π/λ0) d γ = (2π/λ0) d sqrt(n^2 sin^2θ - 1)
            </div>
            <p class="small">
              Physically, <span style="font-family:var(--mono)">a</span> counts how many decay lengths fit across the gap: larger <span style="font-family:var(--mono)">a</span> ⇒ smaller transmission.
            </p>

            <h3>Step-by-step conversion from oscillatory to tunneling form</h3>
            <p>
              Start from the propagating-film formula
              <span style="font-family:var(--mono)">T = 1/(1 + F sin²δ)</span>, but now with <span style="font-family:var(--mono)">δ = i a</span>.
              Use the identity <span style="font-family:var(--mono)">sin(i a) = i sinh(a)</span> ⇒ <span style="font-family:var(--mono)">sin²(i a) = -sinh²(a)</span>.
            </p>

            <p>
              For TE, <span style="font-family:var(--mono)">q1 = n cosθ</span> (glass), and
              <span style="font-family:var(--mono)">q2 = 1·cosθ2 = i γ</span> (air, evanescent).
              Plugging into
              <span style="font-family:var(--mono)">F = (q1² − q2²)² / (4 q1² q2²)</span> gives:
            </p>

            <div class="eq" id="eq-Fev">
              <span class="label">Algebra (key step)</span>
              q2^2 = (i γ)^2 = -γ^2
              => (q1^2 - q2^2) = (q1^2 + γ^2),
              and q1^2 q2^2 = q1^2 (-γ^2) = - q1^2 γ^2.
            </div>

            <p>
              Therefore <span style="font-family:var(--mono)">F</span> is negative, but it multiplies <span style="font-family:var(--mono)">sin²δ = -sinh²a</span>, producing a positive contribution.
              The tunneling-form transmittance becomes:
            </p>

            <div class="eq" id="eq-Ttunnel">
              <span class="label">General TE tunneling form</span>
              T_TE(θ > θc) = 1 / ( 1 + A sinh^2(a) ),
              where  A = (q1^2 + γ^2)^2 / (4 q1^2 γ^2),
              q1 = n cosθ,  γ = sqrt(n^2 sin^2θ - 1),
              a = (2π/λ0) d γ.
            </div>

            <p>
              A beautiful simplification happens here:
              <span style="font-family:var(--mono)">q1² + γ² = n² cos²θ + (n² sin²θ − 1) = n² − 1</span>.
              So <span style="font-family:var(--mono)">A</span> simplifies to:
            </p>

            <div class="eq" id="eq-Aclosed">
              <span class="label">Closed-form A</span>
              A = (n^2 - 1)^2 / ( 4 n^2 cos^2θ (n^2 sin^2θ - 1) )
            </div>

            <p><strong>Final answer for (b):</strong></p>
            <div class="eq" id="eq-finalb">
              <span class="label">Answer (b)</span>
              T_TE(θ > θc) =
              1 / ( 1 + [ (n^2 - 1)^2 / (4 n^2 cos^2θ (n^2 sin^2θ - 1)) ] *
                        sinh^2( (2π/λ0) d sqrt(n^2 sin^2θ - 1) ) )
            </div>

            <div class="callout final" style="margin-top:12px">
              <strong>Does the wave penetrate (“tunnel”) through the gap?</strong><br/>
              <span>
                Yes. Even though the air region supports only an evanescent field for <span style="font-family:var(--mono)">θ&gt;θc</span>, a finite gap allows energy to couple into the second glass region.
                Transmission is <em>nonzero</em> and decreases rapidly with gap thickness through the <span style="font-family:var(--mono)">sinh²</span> term.
              </span>
              <div class="copybar">
                <button class="copy" data-copy="T_TE(theta>theta_c)= 1/(1 + ((n^2-1)^2/(4*n^2*cos^2(theta)*(n^2*sin^2(theta)-1)))*sinh^2((2*pi/lambda0)*d*sqrt(n^2*sin^2(theta)-1)))">Copy final (b)</button>
              </div>
            </div>

            <h3>Sanity checks for (b)</h3>
            <ul>
              <li><strong>As d→0:</strong> <span style="font-family:var(--mono)">a→0</span>, <span style="font-family:var(--mono)">sinh²a≈a²→0</span> ⇒ <span style="font-family:var(--mono)">T→1</span> ✔ (interfaces coincide)</li>
              <li><strong>As d→∞:</strong> <span style="font-family:var(--mono)">sinh²a ~ (e^{2a}/4)</span> ⇒ <span style="font-family:var(--mono)">T→0</span> ✔ (decay kills coupling)</li>
              <li><strong>Close to critical angle:</strong> <span style="font-family:var(--mono)">γ→0+</span> makes coupling strong; transmission can be appreciable for thin gaps ✔</li>
            </ul>

            <div class="callout assumptions" style="margin-top:10px">
              <strong>Insert the stated thickness:</strong>
              If <span style="font-family:var(--mono)">d = λg/2 = λ0/(2n)</span>, then
              <span style="font-family:var(--mono)">a = (π/n) √(n² sin²θ − 1)</span>.
              This is the value used as the default in the interactive plots (you can also sweep <span style="font-family:var(--mono)">d/λ0</span>).
            </div>
          </div>

          <p class="small" style="margin-top:12px">
            Connection to the diagram/plots: below critical, the main plot shows oscillatory Fabry–Pérot fringes with angle.
            Above critical, the curve drops smoothly because the gap acts like a tunneling barrier; the secondary plot shows how transmission changes with thickness.
          </p>
        </div>
      </section>

      <!-- Visualization -->
      <section id="viz">
        <header>
          <h2>Interactive Visualizations</h2>
          <p>Use the controls to explore how index, angle, and gap thickness control interference (below critical) and tunneling (above critical).</p>
        </header>
        <div class="content">
          <div class="vizCard">
            <div class="vizHeader">
              <h3>Controls (update all canvases live)</h3>
              <div class="controls" aria-label="interactive controls">
                <div class="control">
                  <label for="nSlider">
                    Refractive index <span style="font-family:var(--mono)">n</span>
                    <span class="val" id="nVal">1.50</span>
                  </label>
                  <input id="nSlider" type="range" min="1.30" max="2.00" step="0.01" value="1.50"/>
                </div>
                <div class="control">
                  <label for="thetaSlider">
                    Angle in glass <span style="font-family:var(--mono)">θ</span> (deg)
                    <span class="val" id="thetaVal">50.0</span>
                  </label>
                  <input id="thetaSlider" type="range" min="0" max="85" step="0.1" value="50.0"/>
                </div>
                <div class="control">
                  <label for="dMode">
                    Gap thickness mode
                    <span class="val" id="dModeVal">d = λ0/(2n)</span>
                  </label>
                  <select id="dMode">
                    <option value="glassHalf">d = λg/2 = λ0/(2n) (given interpretation)</option>
                    <option value="fixed">d/λ0 fixed (use slider)</option>
                  </select>
                </div>
                <div class="control" id="dControl">
                  <label for="dSlider">
                    Thickness <span style="font-family:var(--mono)">d/λ0</span>
                    <span class="val" id="dVal">0.333</span>
                  </label>
                  <input id="dSlider" type="range" min="0.00" max="1.00" step="0.001" value="0.333"/>
                </div>
              </div>
            </div>
            <div class="canvasWrap">
              <div class="vizGrid">
                <div class="vizCard">
                  <div class="vizHeader"><h3>Diagram — Glass / Air Gap / Glass Geometry</h3></div>
                  <div class="canvasWrap"><canvas id="cDiagram" aria-label="setup diagram canvas"></canvas></div>
                </div>

                <div class="vizCard">
                  <div class="vizHeader"><h3>Main Plot — TE Transmittance vs Angle (0° → 85°)</h3></div>
                  <div class="canvasWrap"><canvas id="cMain" aria-label="main plot canvas"></canvas></div>
                </div>

                <div class="vizCard">
                  <div class="vizHeader"><h3>Secondary Plot — Transmittance vs Thickness (d/λ0 sweep)</h3></div>
                  <div class="canvasWrap"><canvas id="cSweep" aria-label="secondary plot canvas"></canvas></div>
                </div>
              </div>

              <div class="kpi" aria-label="live computed values">
                <div class="box">
                  <div class="t">Critical angle θc (deg)</div>
                  <div class="v" id="kpiThetaC">—</div>
                </div>
                <div class="box">
                  <div class="t">Current d/λ0</div>
                  <div class="v" id="kpiD">—</div>
                </div>
                <div class="box">
                  <div class="t">T at chosen θ (TE)</div>
                  <div class="v" id="kpiTTheta">—</div>
                </div>
                <div class="box">
                  <div class="t">Regime in air</div>
                  <div class="v" id="kpiRegime">—</div>
                </div>
              </div>

              <div class="footNote">
                Example wavelength for interpretation: <span style="font-family:var(--mono)">λ0 = 633 nm</span> (plots are normalized in <span style="font-family:var(--mono)">d/λ0</span>, so the shapes are general).
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PART 4 -->
      <section id="part4">
        <header>
          <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>
          <p>Interpret the final formulas, explore parameter dependence, alternative derivations, and concept checks.</p>
        </header>
        <div class="content">
          <h3>Re-interpreting the final formulas</h3>
          <div class="callout">
            <ul>
              <li><strong>Mismatch factor:</strong> <span style="font-family:var(--mono)">F</span> or <span style="font-family:var(--mono)">A</span> grows with index contrast (<span style="font-family:var(--mono)">n</span> vs 1). Larger contrast generally reduces transmission except at resonant conditions below critical.</li>
              <li><strong>Phase thickness (below critical):</strong> <span style="font-family:var(--mono)">δ = (2π/λ0) d cosθ2</span> controls oscillations. Changing <span style="font-family:var(--mono)">d</span> or <span style="font-family:var(--mono)">θ</span> shifts interference fringes.</li>
              <li><strong>Barrier parameter (above critical):</strong> <span style="font-family:var(--mono)">a = (2π/λ0) d √(n² sin²θ − 1)</span> controls exponential suppression; larger <span style="font-family:var(--mono)">θ</span> (deeper into TIR) increases <span style="font-family:var(--mono)">a</span> and lowers <span style="font-family:var(--mono)">T</span>.</li>
            </ul>
          </div>

          <h3>How changing parameters affects outcome (connect to plots)</h3>
          <ul>
            <li>Increase <span style="font-family:var(--mono)">n</span> → smaller <span style="font-family:var(--mono)">θc</span> (critical angle decreases) and stronger mismatch, typically lowering transmission minima and strengthening tunneling suppression for fixed <span style="font-family:var(--mono)">d/λ0</span>.</li>
            <li>Increase <span style="font-family:var(--mono)">d</span> → below critical, fringes compress in <span style="font-family:var(--mono)">θ</span>; above critical, transmission drops rapidly (roughly exponential in <span style="font-family:var(--mono)">d</span>).</li>
            <li>Move <span style="font-family:var(--mono)">θ</span> just above <span style="font-family:var(--mono)">θc</span> → <span style="font-family:var(--mono)">γ</span> is small, so tunneling can be significant if the gap is thin (you’ll see this in the main plot near the critical-angle marker).</li>
          </ul>

          <div class="callout keyeq">
            <h3 style="margin-top:0">Alternative derivation idea (brief)</h3>
            <p>
              Instead of transfer matrices, you can sum multiple reflections:
              write the transmitted field as <span style="font-family:var(--mono)">t = t12 t21 e^{iδ} Σ (r21 r21 e^{i2δ})^m</span>.
              This geometric series yields the same Fabry–Pérot denominator.
              For <span style="font-family:var(--mono)">θ&gt;θc</span>, <span style="font-family:var(--mono)">δ</span> becomes imaginary and the same sum produces hyperbolic functions (tunneling).
            </p>
          </div>

          <h3>Concept check (quick self-test)</h3>
          <ul>
            <li><strong>Q:</strong> Why can energy transmit if the field in air is evanescent?<br/>
                <strong>A:</strong> Evanescent fields store and exchange energy locally; with a second interface close enough, the field couples into a propagating mode in the second glass, producing net transmitted power (FTIR).</li>
            <li><strong>Q:</strong> What happens as the gap thickness becomes much larger than the decay length?<br/>
                <strong>A:</strong> <span style="font-family:var(--mono)">a</span> becomes large, <span style="font-family:var(--mono)">sinh²a</span> grows ~<span style="font-family:var(--mono)">e^{2a}</span>, so <span style="font-family:var(--mono)">T→0</span>.</li>
            <li><strong>Q:</strong> Below critical angle, why can <span style="font-family:var(--mono)">T</span> reach 1 even with reflections?<br/>
                <strong>A:</strong> In a symmetric lossless system, destructive interference of reflections at specific phases cancels net reflection, yielding perfect transmission (Fabry–Pérot resonance).</li>
            <li><strong>Q:</strong> Would TM polarization tunnel the same way?<br/>
                <strong>A:</strong> It tunnels too, but the prefactor analogous to <span style="font-family:var(--mono)">A</span> changes because TM “admittance” differs; TE and TM generally have different tunneling strengths.</li>
          </ul>
        </div>
      </section>

      <!-- PART 5 -->
      <section id="part5">
        <header>
          <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>
          <p>What each canvas shows, what the controls change, and what you should observe.</p>
        </header>
        <div class="content">
          <h3>Diagram canvas</h3>
          <ul>
            <li>Shows two glass half-spaces with an air gap of thickness <span style="font-family:var(--mono)">d</span>.</li>
            <li>Incident TE wave at angle <span style="font-family:var(--mono)">θ</span> in glass.</li>
            <li>Critical-angle region: if <span style="font-family:var(--mono)">θ&gt;θc</span>, the field inside air is drawn as a decaying (evanescent) wave with decay scale controlled by <span style="font-family:var(--mono)">γ</span>.</li>
          </ul>

          <h3>Main plot canvas (TE transmittance vs angle)</h3>
          <ul>
            <li><strong>x-axis:</strong> incidence angle <span style="font-family:var(--mono)">θ</span> in degrees (in glass).</li>
            <li><strong>y-axis:</strong> TE power transmittance <span style="font-family:var(--mono)">T</span> (0 to 1).</li>
            <li>A vertical marker shows <span style="font-family:var(--mono)">θc</span>. Left of it: oscillatory interference. Right of it: smooth tunneling decay.</li>
          </ul>

          <h3>Secondary plot canvas (sweep T vs thickness)</h3>
          <ul>
            <li><strong>x-axis:</strong> normalized thickness <span style="font-family:var(--mono)">d/λ0</span>.</li>
            <li><strong>y-axis:</strong> TE power transmittance at the currently selected angle <span style="font-family:var(--mono)">θ</span>.</li>
            <li>Below critical, it oscillates with thickness. Above critical, it decreases rapidly with thickness (tunneling suppression).</li>
          </ul>

          <h3>Interactive controls</h3>
          <ul>
            <li><strong>n slider:</strong> changes index contrast → shifts critical angle and mismatch strength.</li>
            <li><strong>θ slider:</strong> moves you between propagating and evanescent regimes; watch behavior change at <span style="font-family:var(--mono)">θc</span>.</li>
            <li><strong>Thickness mode:</strong> either lock to the problem’s interpretation <span style="font-family:var(--mono)">d = λ0/(2n)</span> or use a fixed <span style="font-family:var(--mono)">d/λ0</span> via the slider.</li>
          </ul>

          <div class="callout final">
            <strong>Takeaway:</strong> The air gap is a thin-film interferometer below the critical angle and an optical-tunneling barrier above it.
            The same unified thin-film mathematics produces <span style="font-family:var(--mono)">sin²</span> (oscillations) or <span style="font-family:var(--mono)">sinh²</span> (exponential suppression) depending on whether the gap supports propagation.
          </div>
        </div>
      </section>

    </article>
  </div>
</main>

<footer>
  Built for learning: theory → analysis → strategy → derivation → interpretation → visuals. (No external libraries.)
</footer>

<script>
(function(){
  // ---------- Utilities ----------
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const rad = deg => deg*Math.PI/180;
  const deg = r => r*180/Math.PI;

  function fmt(x, digits=4){
    if (!isFinite(x)) return "—";
    const ax = Math.abs(x);
    if (ax !== 0 && (ax < 1e-3 || ax >= 1e4)) return x.toExponential(3);
    return x.toFixed(digits);
  }

  // Copy buttons
  async function copyText(txt, btn){
    try{
      await navigator.clipboard.writeText(txt);
      const old = btn.textContent;
      btn.textContent = "Copied ✓";
      btn.style.borderColor = "rgba(125,255,204,.35)";
      btn.style.background = "rgba(125,255,204,.10)";
      setTimeout(()=>{ btn.textContent = old; btn.style.borderColor="rgba(255,255,255,.10)"; btn.style.background="rgba(255,255,255,.05)"; }, 900);
    }catch(e){
      const old = btn.textContent;
      btn.textContent = "Copy failed";
      setTimeout(()=>btn.textContent=old, 900);
    }
  }
  document.querySelectorAll("button.copy").forEach(btn=>{
    btn.addEventListener("click", ()=>copyText(btn.getAttribute("data-copy")||"", btn));
  });

  // ---------- Physics: TE transmittance through glass-air-glass ----------
  // We work with normalized thickness dOverLambda0 = d/λ0 (unitless).
  // k0 = 2π/λ0, so k0*d = 2π*(d/λ0).
  //
  // For incidence from glass (n) into air (1), Snell gives sinθ2 = n sinθ.
  // If n sinθ <= 1 => propagating in air:
  //   q1 = n cosθ, q2 = cosθ2
  //   delta = k0 d cosθ2 = 2π*(d/λ0)*cosθ2
  //   F = (q1^2 - q2^2)^2 / (4 q1^2 q2^2)
  //   T = 1 / (1 + F sin^2(delta))
  //
  // If n sinθ > 1 => evanescent in air:
  //   γ = sqrt(n^2 sin^2θ - 1)
  //   a = k0 d γ = 2π*(d/λ0)*γ
  //   A = (n^2 - 1)^2 / (4 n^2 cos^2θ (n^2 sin^2θ - 1))
  //   T = 1 / (1 + A sinh^2(a))
  function TE_transmittance(n, thetaDeg, dOverLambda0){
    const th = rad(thetaDeg);
    const s = Math.sin(th);
    const c = Math.cos(th);
    const ns = n*s;
    if (ns <= 1){
      const cos2 = Math.sqrt(Math.max(0, 1 - ns*ns)); // real
      const q1 = n*c;
      const q2 = cos2; // n2=1
      const delta = 2*Math.PI*dOverLambda0*cos2;
      // avoid divide by zero at grazing/critical numerical edges
      const eps = 1e-12;
      const q1s = q1*q1 + eps;
      const q2s = q2*q2 + eps;
      const F = ((q1s - q2s)*(q1s - q2s)) / (4*q1s*q2s);
      const sd = Math.sin(delta);
      const T = 1 / (1 + F*sd*sd);
      return {T, regime:"propagating", thetaC:deg(Math.asin(1/n)), cos2, gamma:0, a:0, F, A:0, delta};
    }else{
      const gamma = Math.sqrt(ns*ns - 1);
      const a = 2*Math.PI*dOverLambda0*gamma;
      const denom = 4*n*n*c*c*(ns*ns - 1);
      const A = ((n*n - 1)*(n*n - 1)) / Math.max(denom, 1e-12);
      const sh = Math.sinh(a);
      const T = 1 / (1 + A*sh*sh);
      return {T, regime:"evanescent (FTIR)", thetaC:deg(Math.asin(1/n)), cos2:0, gamma, a, F:0, A, delta:0};
    }
  }

  // ---------- Canvas helpers ----------
  function setupCanvas(canvas){
    const ctx = canvas.getContext("2d");
    function resize(){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(2, Math.floor(rect.width * dpr));
      const h = Math.max(2, Math.floor(rect.height * dpr));
      if (canvas.width !== w || canvas.height !== h){
        canvas.width = w;
        canvas.height = h;
      }
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
      return {cw: rect.width, ch: rect.height, dpr};
    }
    return {ctx, resize};
  }

  function drawAxes(ctx, x0, y0, w, h, opts){
    // opts: {xmin,xmax,ymin,ymax,xlabel,ylabel,title, xticks, yticks}
    const {xmin,xmax,ymin,ymax,xlabel,ylabel,title, xticks=5, yticks=5} = opts;
    // background
    ctx.save();
    ctx.fillStyle = "rgba(10,14,30,.45)";
    ctx.fillRect(x0, y0, w, h);

    // grid
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    for(let i=0;i<=xticks;i++){
      const x = x0 + (w*i/xticks);
      ctx.moveTo(x, y0);
      ctx.lineTo(x, y0+h);
    }
    for(let j=0;j<=yticks;j++){
      const y = y0 + (h*j/yticks);
      ctx.moveTo(x0, y);
      ctx.lineTo(x0+w, y);
    }
    ctx.stroke();

    // border
    ctx.strokeStyle = "rgba(255,255,255,.14)";
    ctx.strokeRect(x0, y0, w, h);

    // title
    ctx.fillStyle = "rgba(233,238,255,.92)";
    ctx.font = "600 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(title || "", x0+10, y0+18);

    // labels
    ctx.fillStyle = "rgba(155,176,255,.85)";
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    if (xlabel) ctx.fillText(xlabel, x0 + w - 10 - ctx.measureText(xlabel).width, y0 + h - 8);
    if (ylabel){
      ctx.save();
      ctx.translate(x0+10, y0+18);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(ylabel, 0, 0);
      ctx.restore();
    }

    // ticks
    ctx.fillStyle = "rgba(155,176,255,.80)";
    ctx.font = "11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
    for(let i=0;i<=xticks;i++){
      const x = x0 + (w*i/xticks);
      const val = xmin + (xmax-xmin)*(i/xticks);
      const s = (Math.abs(val) < 1e-9) ? "0" : (Math.abs(val) >= 100 ? val.toFixed(0) : val.toFixed(1));
      ctx.fillText(s, x - ctx.measureText(s).width/2, y0 + h + 14);
    }
    for(let j=0;j<=yticks;j++){
      const y = y0 + (h*j/yticks);
      const val = ymax - (ymax-ymin)*(j/yticks);
      const s = (Math.abs(val) < 1e-9) ? "0" : (val.toFixed(2));
      ctx.fillText(s, x0 - 6 - ctx.measureText(s).width, y + 4);
    }

    ctx.restore();

    function xMap(x){ return x0 + (x - xmin) * w/(xmax-xmin); }
    function yMap(y){ return y0 + (ymax - y) * h/(ymax-ymin); }
    return {xMap,yMap};
  }

  function drawLine(ctx, pts, stroke="rgba(122,162,255,.95)", width=2){
    if (pts.length < 2) return;
    ctx.save();
    ctx.strokeStyle = stroke;
    ctx.lineWidth = width;
    ctx.lineJoin = "round";
    ctx.lineCap = "round";
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
    ctx.stroke();
    ctx.restore();
  }

  function drawVLine(ctx, x, y0, y1, stroke="rgba(255,204,102,.9)", dash=[6,6]){
    ctx.save();
    ctx.strokeStyle = stroke;
    ctx.setLineDash(dash);
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x, y0);
    ctx.lineTo(x, y1);
    ctx.stroke();
    ctx.restore();
  }

  function drawMarker(ctx, x, y, color="rgba(125,255,204,.95)"){
    ctx.save();
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x, y, 4.2, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle = "rgba(0,0,0,.35)";
    ctx.lineWidth = 1;
    ctx.stroke();
    ctx.restore();
  }

  function legend(ctx, x, y, items){
    ctx.save();
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    let yy = y;
    items.forEach(it=>{
      ctx.fillStyle = it.color;
      ctx.fillRect(x, yy-10, 14, 10);
      ctx.fillStyle = "rgba(233,238,255,.92)";
      ctx.fillText(it.label, x+20, yy-1);
      yy += 16;
    });
    ctx.restore();
  }

  // ---------- Diagram drawing ----------
  function drawDiagram(canvasKit, state){
    const {ctx, resize} = canvasKit;
    const {cw, ch} = resize();
    ctx.clearRect(0,0,cw,ch);

    // Layout in CSS pixels
    const pad = 14;
    const w = cw - 2*pad;
    const h = ch - 2*pad;
    const x0 = pad, y0 = pad;

    // Regions
    const gapW = w*0.22;
    const leftW = (w - gapW)*0.5;
    const rightW = leftW;
    const gapX = x0 + leftW;
    const rightX = gapX + gapW;

    // Background
    ctx.save();
    ctx.fillStyle = "rgba(10,14,30,.30)";
    ctx.fillRect(x0,y0,w,h);
    ctx.restore();

    // Glass regions
    ctx.save();
    ctx.fillStyle = "rgba(122,162,255,.10)";
    ctx.fillRect(x0,y0,leftW,h);
    ctx.fillRect(rightX,y0,rightW,h);
    ctx.fillStyle = "rgba(125,255,204,.07)";
    ctx.fillRect(gapX,y0,gapW,h);
    ctx.strokeStyle = "rgba(255,255,255,.14)";
    ctx.lineWidth = 1;
    ctx.strokeRect(x0,y0,w,h);
    ctx.strokeRect(gapX,y0,gapW,h);
    ctx.restore();

    // Labels
    ctx.save();
    ctx.fillStyle = "rgba(233,238,255,.92)";
    ctx.font = "600 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText("Glass (n)", x0+10, y0+18);
    ctx.fillText("Air gap (n=1)", gapX+10, y0+18);
    ctx.fillText("Glass (n)", rightX+10, y0+18);

    // thickness label d
    ctx.strokeStyle = "rgba(255,204,102,.9)";
    ctx.lineWidth = 2;
    const yMid = y0 + h*0.20;
    ctx.beginPath();
    ctx.moveTo(gapX+8, yMid);
    ctx.lineTo(gapX+gapW-8, yMid);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(gapX+8, yMid);
    ctx.lineTo(gapX+14, yMid-6);
    ctx.moveTo(gapX+8, yMid);
    ctx.lineTo(gapX+14, yMid+6);
    ctx.moveTo(gapX+gapW-8, yMid);
    ctx.lineTo(gapX+gapW-14, yMid-6);
    ctx.moveTo(gapX+gapW-8, yMid);
    ctx.lineTo(gapX+gapW-14, yMid+6);
    ctx.stroke();

    ctx.fillStyle = "rgba(255,204,102,.95)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
    const dText = "d";
    ctx.fillText(dText, gapX + gapW/2 - ctx.measureText(dText).width/2, yMid - 8);

    // Incident ray
    const theta = rad(state.thetaDeg);
    const incStart = {x: x0 + leftW*0.18, y: y0 + h*0.78};
    const hit = {x: gapX, y: y0 + h*0.55};
    ctx.strokeStyle = "rgba(125,255,204,.92)";
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    ctx.moveTo(incStart.x, incStart.y);
    ctx.lineTo(hit.x, hit.y);
    ctx.stroke();

    // Normal line at interface
    ctx.strokeStyle = "rgba(255,255,255,.18)";
    ctx.setLineDash([5,6]);
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(hit.x, y0 + h*0.12);
    ctx.lineTo(hit.x, y0 + h*0.88);
    ctx.stroke();
    ctx.setLineDash([]);

    // Angle arc
    const arcR = 28;
    const arcCenter = hit;
    ctx.strokeStyle = "rgba(255,255,255,.25)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    // draw arc between normal (up direction) and ray direction (from interface into glass backwards)
    const rayAng = Math.atan2(hit.y - incStart.y, hit.x - incStart.x); // direction of ray
    const normalAng = -Math.PI/2; // upward
    // angle from normal to ray
    let a1 = normalAng;
    let a2 = rayAng;
    // ensure proper ordering for small positive arc
    if (a2 < a1) { const tmp=a1; a1=a2; a2=tmp; }
    ctx.arc(arcCenter.x, arcCenter.y, arcR, a1, a2);
    ctx.stroke();
    ctx.fillStyle = "rgba(233,238,255,.9)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
    ctx.fillText("θ", arcCenter.x + 10, arcCenter.y - 8);

    // Transmitted ray (if any) or evanescent decay sketch
    const res = TE_transmittance(state.n, state.thetaDeg, state.dOverLambda0);

    if (res.regime.startsWith("propagating")){
      // refracted ray in air
      const sin2 = state.n*Math.sin(theta);
      const theta2 = Math.asin(clamp(sin2, -1, 1));
      const dir2 = {x: Math.cos(theta2), y: Math.sin(theta2)};
      const midInAir = {x: gapX + gapW*0.55, y: hit.y + (gapW*0.55)*Math.tan(theta2)};
      ctx.strokeStyle = "rgba(122,162,255,.92)";
      ctx.lineWidth = 2.2;
      ctx.beginPath();
      ctx.moveTo(hit.x, hit.y);
      ctx.lineTo(midInAir.x, midInAir.y);
      ctx.stroke();

      // transmitted into second glass approximately same angle as incident
      const outEnd = {x: rightX + rightW*0.75, y: midInAir.y + (rightW*0.75)*Math.tan(theta)};
      ctx.strokeStyle = "rgba(125,255,204,.92)";
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      ctx.moveTo(gapX+gapW, midInAir.y);
      ctx.lineTo(outEnd.x, outEnd.y);
      ctx.stroke();

      ctx.fillStyle = "rgba(155,176,255,.85)";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText("propagating in air", gapX + 10, y0 + h - 12);
    }else{
      // evanescent field in air: draw decaying oscillation
      const yBase = hit.y;
      const xStart = gapX + 4;
      const xEnd = gapX + gapW - 4;
      const L = xEnd - xStart;
      const cycles = 3.2;
      const amp0 = 18;
      const decay = 3.2; // visual decay strength
      ctx.strokeStyle = "rgba(255,204,102,.95)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      for(let i=0;i<=140;i++){
        const t = i/140;
        const x = xStart + L*t;
        const amp = amp0*Math.exp(-decay*t);
        const y = yBase + amp*Math.sin(2*Math.PI*cycles*t);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // transmitted small arrow in second glass (energy coupled)
      const yOut = yBase;
      ctx.strokeStyle = "rgba(125,255,204,.80)";
      ctx.lineWidth = 2.2;
      ctx.beginPath();
      ctx.moveTo(gapX+gapW, yOut);
      ctx.lineTo(rightX + rightW*0.55, yOut + (rightW*0.55)*Math.tan(theta));
      ctx.stroke();

      ctx.fillStyle = "rgba(255,204,102,.92)";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText("evanescent (FTIR)", gapX + 10, y0 + h - 12);
    }

    // Title overlay
    ctx.fillStyle = "rgba(233,238,255,.92)";
    ctx.font = "600 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText("Setup diagram (not to scale)", x0+10, y0+34);

    ctx.restore();
  }

  // ---------- Plot: T vs angle ----------
  function drawMainPlot(canvasKit, state){
    const {ctx, resize} = canvasKit;
    const {cw, ch} = resize();
    ctx.clearRect(0,0,cw,ch);

    const padL = 56, padR = 16, padT = 34, padB = 32;
    const x0 = padL, y0 = padT, w = cw - padL - padR, h = ch - padT - padB;

    const xmin = 0, xmax = 85, ymin = 0, ymax = 1.0;
    const m = drawAxes(ctx, x0, y0, w, h, {
      xmin,xmax,ymin,ymax,
      xlabel:"θ (deg in glass)",
      ylabel:"T (unitless)",
      title:`TE Transmittance vs Angle  (n=${state.n.toFixed(2)}, d/λ0=${state.dOverLambda0.toFixed(3)})`,
      xticks:5, yticks:5
    });

    // curve
    const pts = [];
    for(let i=0;i<=400;i++){
      const th = xmin + (xmax-xmin)*i/400;
      const r = TE_transmittance(state.n, th, state.dOverLambda0);
      const T = clamp(r.T, 0, 1.2);
      pts.push({x: m.xMap(th), y: m.yMap(T)});
    }
    drawLine(ctx, pts, "rgba(122,162,255,.95)", 2.4);

    // critical angle marker
    const thetaC = deg(Math.asin(1/state.n));
    const xC = m.xMap(thetaC);
    drawVLine(ctx, xC, y0, y0+h, "rgba(255,204,102,.9)", [7,6]);

    // selected theta marker
    const rSel = TE_transmittance(state.n, state.thetaDeg, state.dOverLambda0);
    const xS = m.xMap(state.thetaDeg);
    const yS = m.yMap(clamp(rSel.T,0,1));
    drawMarker(ctx, xS, yS, "rgba(125,255,204,.95)");

    // legend
    legend(ctx, x0+10, y0+28, [
      {color:"rgba(122,162,255,.95)", label:"T_TE(θ) through gap"},
      {color:"rgba(255,204,102,.9)", label:`critical angle θc ≈ ${thetaC.toFixed(1)}°`}
    ]);

    // annotate regime
    ctx.save();
    ctx.fillStyle = "rgba(155,176,255,.85)";
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    const label = rSel.regime.startsWith("prop") ? "Air: propagating" : "Air: evanescent (FTIR)";
    ctx.fillText(label, x0+10, y0+h-10);
    ctx.restore();
  }

  // ---------- Plot: T vs thickness sweep ----------
  function drawSweepPlot(canvasKit, state){
    const {ctx, resize} = canvasKit;
    const {cw, ch} = resize();
    ctx.clearRect(0,0,cw,ch);

    const padL = 56, padR = 16, padT = 34, padB = 32;
    const x0 = padL, y0 = padT, w = cw - padL - padR, h = ch - padT - padB;

    const xmin = 0, xmax = 1.0, ymin = 0, ymax = 1.0;
    const thetaC = deg(Math.asin(1/state.n));
    const regime = (state.n*Math.sin(rad(state.thetaDeg)) <= 1) ? "below critical (interference)" : "above critical (tunneling)";
    const m = drawAxes(ctx, x0, y0, w, h, {
      xmin,xmax,ymin,ymax,
      xlabel:"d/λ0 (unitless)",
      ylabel:"T (unitless)",
      title:`Thickness sweep at θ=${state.thetaDeg.toFixed(1)}° (${regime})`,
      xticks:5, yticks:5
    });

    const pts = [];
    for(let i=0;i<=420;i++){
      const d = xmin + (xmax-xmin)*i/420;
      const r = TE_transmittance(state.n, state.thetaDeg, d);
      pts.push({x: m.xMap(d), y: m.yMap(clamp(r.T,0,1))});
    }
    drawLine(ctx, pts, "rgba(125,255,204,.92)", 2.4);

    // current thickness marker
    const xD = m.xMap(state.dOverLambda0);
    drawVLine(ctx, xD, y0, y0+h, "rgba(122,162,255,.85)", [6,6]);
    const rCur = TE_transmittance(state.n, state.thetaDeg, state.dOverLambda0);
    drawMarker(ctx, xD, m.yMap(clamp(rCur.T,0,1)), "rgba(255,204,102,.95)");

    legend(ctx, x0+10, y0+28, [
      {color:"rgba(125,255,204,.92)", label:"T_TE(d) at fixed θ"},
      {color:"rgba(122,162,255,.85)", label:`current d/λ0 = ${state.dOverLambda0.toFixed(3)}`}
    ]);

    // helpful note about given thickness
    ctx.save();
    ctx.fillStyle = "rgba(155,176,255,.85)";
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(`θc ≈ ${thetaC.toFixed(1)}°`, x0+10, y0+h-10);
    ctx.restore();
  }

  // ---------- State & UI ----------
  const nSlider = document.getElementById("nSlider");
  const thetaSlider = document.getElementById("thetaSlider");
  const dSlider = document.getElementById("dSlider");
  const dMode = document.getElementById("dMode");
  const dControl = document.getElementById("dControl");

  const nVal = document.getElementById("nVal");
  const thetaVal = document.getElementById("thetaVal");
  const dVal = document.getElementById("dVal");
  const dModeVal = document.getElementById("dModeVal");

  const kpiThetaC = document.getElementById("kpiThetaC");
  const kpiD = document.getElementById("kpiD");
  const kpiTTheta = document.getElementById("kpiTTheta");
  const kpiRegime = document.getElementById("kpiRegime");

  const diagram = setupCanvas(document.getElementById("cDiagram"));
  const mainPlot = setupCanvas(document.getElementById("cMain"));
  const sweepPlot = setupCanvas(document.getElementById("cSweep"));

  function computeDOverLambda0(n){
    if (dMode.value === "glassHalf"){
      // d = λg/2 = (λ0/n)/2 = λ0/(2n)
      return 1/(2*n);
    }else{
      return parseFloat(dSlider.value);
    }
  }

  function updateUIVisibility(){
    const fixed = (dMode.value === "fixed");
    dControl.style.opacity = fixed ? "1" : ".55";
    dSlider.disabled = !fixed;
    dModeVal.textContent = fixed ? "d/λ0 fixed" : "d = λ0/(2n)";
  }

  function render(){
    const n = parseFloat(nSlider.value);
    const thetaDeg = parseFloat(thetaSlider.value);
    const dOverLambda0 = computeDOverLambda0(n);

    nVal.textContent = n.toFixed(2);
    thetaVal.textContent = thetaDeg.toFixed(1);
    dVal.textContent = dOverLambda0.toFixed(3);

    const thetaC = deg(Math.asin(1/n));
    const res = TE_transmittance(n, thetaDeg, dOverLambda0);

    kpiThetaC.textContent = thetaC.toFixed(2) + "°";
    kpiD.textContent = dOverLambda0.toFixed(6);
    kpiTTheta.textContent = fmt(res.T, 6);
    kpiRegime.textContent = res.regime;

    const state = {n, thetaDeg, dOverLambda0};
    drawDiagram(diagram, state);
    drawMainPlot(mainPlot, state);
    drawSweepPlot(sweepPlot, state);
  }

  function onAnyChange(){
    updateUIVisibility();
    render();
  }

  [nSlider, thetaSlider, dSlider, dMode].forEach(el=>{
    el.addEventListener("input", onAnyChange);
    el.addEventListener("change", onAnyChange);
  });

  window.addEventListener("resize", ()=>render());

  updateUIVisibility();
  render();
})();
</script>
</body>
</html>
