<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Refractive Index of Air: Group Velocity and Dispersion from a Quadratic Fit</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#e9eefc;
      --muted:#b9c3e6;
      --accent:#7aa2ff;
      --accent2:#63e6be;
      --warn:#ffd43b;
      --danger:#ff6b6b;
      --grid:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.12);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 500px at 15% 10%, rgba(122,162,255,.18), transparent 55%),
        radial-gradient(800px 500px at 85% 20%, rgba(99,230,190,.12), transparent 60%),
        radial-gradient(900px 700px at 50% 110%, rgba(255,212,59,.10), transparent 60%),
        var(--bg);
      line-height:1.55;
    }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    header{
      padding:28px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }
    .topbar{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    .title{
      flex:1 1 520px;
    }
    h1{
      margin:0 0 6px;
      font-size: clamp(1.35rem, 1.05rem + 1.2vw, 2.1rem);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      max-width: 78ch;
    }
    .badgeRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:flex-end;
      flex: 0 1 auto;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 12px;
      border:1px solid var(--border);
      background:linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border-radius:999px;
      box-shadow: 0 10px 26px rgba(0,0,0,.18);
      color:var(--muted);
      font-size:.92rem;
      white-space:nowrap;
    }
    .pill b{ color:var(--text); font-weight:650; }

    main{
      max-width:1200px;
      margin:0 auto;
      padding:14px 18px 64px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
    }

    nav#toc{
      position: sticky;
      top: 12px;
      align-self:start;
      padding:14px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    @media (max-width: 980px){
      nav#toc{ position: relative; top:0; }
    }
    .tocTitle{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      margin-bottom:10px;
    }
    .tocTitle h2{
      margin:0;
      font-size:1rem;
      letter-spacing:.3px;
    }
    .tocLinks{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .tocLinks a{
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      color: var(--muted);
      background: transparent;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-size:.95rem;
    }
    .tocLinks a:hover{
      background: rgba(122,162,255,.10);
      border-color: rgba(122,162,255,.22);
      transform: translateX(2px);
      text-decoration:none;
      color: var(--text);
    }

    article{
      display:flex;
      flex-direction:column;
      gap:18px;
    }
    section{
      padding:18px;
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    section h2{
      margin:0 0 10px;
      font-size:1.22rem;
      letter-spacing:.2px;
    }
    section h3{
      margin:14px 0 8px;
      font-size:1.06rem;
      color: var(--text);
    }
    p{ margin: 10px 0; color: var(--text); }
    ul{ margin:10px 0 10px 1.2em; color: var(--text); }
    li{ margin:6px 0; color: var(--text); }
    .muted{ color: var(--muted); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    @media (max-width: 820px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .callout{
      padding:14px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(17,26,51,.55), rgba(17,26,51,.25));
    }
    .callout h4{
      margin:0 0 8px;
      font-size:1.02rem;
    }

    .kpiRow{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 820px){
      .kpiRow{ grid-template-columns: 1fr; }
    }
    .kpi{
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(0,0,0,.08), rgba(0,0,0,.02));
    }
    .kpi .label{ color: var(--muted); font-size:.9rem; }
    .kpi .value{ font-size:1.08rem; font-weight:700; margin-top:6px; font-family: var(--mono); }

    .equation{
      position:relative;
      margin:12px 0;
      padding:14px 44px 14px 14px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(0,0,0,.12), rgba(0,0,0,.04));
      font-family: var(--mono);
      color: #f3f6ff;
      overflow:auto;
      white-space:pre-wrap;
    }
    .copyBtn{
      position:absolute;
      right:10px;
      top:10px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding:8px 10px;
      cursor:pointer;
      font-size:.88rem;
      transition: transform .12s ease, background .12s ease;
      user-select:none;
    }
    .copyBtn:hover{ background: rgba(122,162,255,.14); transform: translateY(-1px); }
    .copyBtn:active{ transform: translateY(0px) scale(.99); }
    .copyNote{
      color: var(--muted);
      font-size:.88rem;
      margin-top:6px;
    }

    .figureCard{
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(17,26,51,.55), rgba(17,26,51,.25));
    }
    figure{ margin:0; }
    figcaption{
      margin-top:10px;
      color: var(--muted);
      font-size:.93rem;
    }
    canvas{
      width:100%;
      height:340px;
      display:block;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(6,10,22,.55);
    }
    .smallCanvas canvas{ height:300px; }
    .controls{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:8px;
    }
    .control{
      flex: 1 1 220px;
      padding:12px;
      border-radius: 16px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
    }
    .control label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      color: var(--muted);
      font-size:.92rem;
      margin-bottom:6px;
    }
    .control input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    .control select{
      width:100%;
      padding:9px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    .btnRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:6px;
    }
    .button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:10px 12px;
      border-radius: 14px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      font-weight:650;
      user-select:none;
    }
    .button:hover{ background: rgba(99,230,190,.12); transform: translateY(-1px); }
    .button:active{ transform: translateY(0px) scale(.99); }

    .boxedFinal{
      border-left: 4px solid var(--accent2);
      padding:14px 14px 14px 14px;
      border-radius: 14px;
      background: rgba(99,230,190,.09);
      border:1px solid rgba(99,230,190,.22);
    }
    .boxedFinal h3{ margin-top:0; }
    .hr{
      height:1px;
      background: rgba(255,255,255,.12);
      margin:14px 0;
      border:0;
    }

    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 38px;
      color: var(--muted);
    }

    /* Print-friendly */
    @media print{
      body{ background:white; color:black; }
      nav#toc{ display:none; }
      section{ box-shadow:none; background:white; border:1px solid #ddd; }
      .equation{ background:#f6f6f6; color:#111; }
      .copyBtn, .controls, .button{ display:none !important; }
      canvas{ display:none; }
      a{ color:black; text-decoration:none; }
    }
  </style>
</head>

<body>
<header>
  <div class="topbar">
    <div class="title">
      <h1>Refractive Index of Air: Group Velocity and Dispersion from Three Wavelength Measurements</h1>
      <p class="subtitle">
        We fit the measured refractive index of air at 20&nbsp;°C and 1&nbsp;atm with a quadratic model, then derive
        the <b>group velocity</b> wavelength dependence and the <b>dispersion coefficient</b> \(D_\lambda\) in ps/(km·nm).
      </p>
    </div>
    <div class="badgeRow">
      <div class="pill">Model: <b>Quadratic fit</b></div>
      <div class="pill">Outputs: <b>v<sub>g</sub>(λ), D<sub>λ</sub>(λ)</b></div>
      <div class="pill">Interactive: <b>density scale</b></div>
    </div>
  </div>
</header>

<main>
  <nav id="toc" aria-label="Table of Contents">
    <div class="tocTitle">
      <h2>Contents</h2>
      <span class="pill" style="padding:6px 10px; font-size:.85rem;">sticky</span>
    </div>
    <div class="tocLinks">
      <a href="#quick">Quick Summary</a>
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a href="#part2">PART 2 — Strategy & Tips</a>
      <a href="#part3">PART 3 — Full Solution</a>
      <a href="#viz">Interactive Visualizations</a>
      <a href="#compare">Comparison to Silica Fiber</a>
    </div>
  </nav>

  <article>
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li>Fit the given data with <span class="muted">λ in μm</span>:
          <b>n(λ) = aλ² + bλ + c</b> with <b>a = −2.0×10⁻⁵</b>, <b>b = 2.54×10⁻⁵</b>, <b>c = 1.00025945</b>.</li>
        <li>Group index: <b>n<sub>g</sub>(λ) = n − λ dn/dλ</b>. For a quadratic, this simplifies to <b>n<sub>g</sub>(λ)=c − aλ²</b>.</li>
        <li>Group velocity: <b>v<sub>g</sub>(λ)=c₀ / n<sub>g</sub>(λ)</b> (with c₀ the speed of light in vacuum).</li>
        <li>Dispersion parameter: <b>D<sub>λ</sub>(λ)= (1/c₀) d n<sub>g</sub>/dλ = −(λ/c₀) d²n/dλ²</b>.</li>
        <li>Numerically (20&nbsp;°C, 1&nbsp;atm): <b>D<sub>λ</sub> ≈ 0.1333·λ(μm)</b> ps/(km·nm), so at 0.81 μm: <b>D<sub>λ</sub> ≈ 0.108</b> ps/(km·nm).</li>
      </ul>
    </section>

    <section id="part1">
      <h2>PART 1 — Problem Analysis (no solving yet)</h2>

      <h3>Restatement (in plain language)</h3>
      <p>
        The refractive index of air (very close to 1) is measured at three wavelengths. We must:
        (a) fit these data with a quadratic function of wavelength and use it to determine how the <b>group velocity</b>
        depends on wavelength, and (b) derive a formula for the <b>dispersion coefficient</b> \(D_\lambda\) in units of
        ps/(km·nm) and compare its magnitude to that of a silica optical fiber.
      </p>

      <div class="grid2">
        <div class="callout">
          <h4>Given</h4>
          <ul>
            <li>Condition: atmospheric pressure, T = 20&nbsp;°C</li>
            <li>Data (λ in μm):</li>
            <li>λ₁ = 0.76, &nbsp; n−1 = 2.672×10⁻⁴</li>
            <li>λ₂ = 0.81, &nbsp; n−1 = 2.669×10⁻⁴</li>
            <li>λ₃ = 0.86, &nbsp; n−1 = 2.665×10⁻⁴</li>
          </ul>
        </div>

        <div class="callout">
          <h4>Unknowns / What must be found</h4>
          <ul>
            <li>Quadratic fit n(λ) (or n−1 as a function of λ)</li>
            <li>Group velocity dependence v<sub>g</sub>(λ)</li>
            <li>Dispersion coefficient D<sub>λ</sub>(λ) in ps/(km·nm)</li>
            <li>Qualitative magnitude comparison with silica fiber dispersion</li>
          </ul>
        </div>
      </div>

      <h3>Relevant principles and why they apply</h3>
      <ul>
        <li>
          <b>Group index and group velocity:</b> A narrowband pulse travels at the group velocity
          \(v_g\), related to the <i>group index</i> \(n_g\) by \(v_g=c_0/n_g\). This applies because
          the question asks for the wavelength dependence of the group velocity (dispersion).
        </li>
        <li>
          <b>Material dispersion parameter:</b> The wavelength-derivative of group delay per unit length defines
          \(D_\lambda\). This is a standard way to quantify pulse broadening in guided-wave optics and is also valid for air as a material.
        </li>
        <li>
          <b>Curve fitting:</b> With three points, a quadratic polynomial is the simplest model that can match all points exactly and
          provides smooth derivatives \(dn/d\lambda\) and \(d^2n/d\lambda^2\) needed for dispersion.
        </li>
      </ul>

      <h3>Possible approaches</h3>
      <ul>
        <li><b>Approach A (best):</b> Fit <i>n(λ)</i> to a quadratic, then compute derivatives analytically to get \(n_g(λ)\), \(v_g(λ)\), and \(D_\lambda(λ)\).</li>
        <li><b>Approach B:</b> Fit <i>n−1</i> instead (equivalent, since n = 1 + (n−1)). Same outcome, slightly cleaner numerically.</li>
        <li><b>Approach C:</b> Use finite differences to approximate derivatives directly from the three points. Fast, but less smooth and less reliable for second derivatives.</li>
      </ul>
      <p class="muted">
        We choose <b>Approach A/B</b> because the problem explicitly requests a quadratic fit and the dispersion requires clean first/second derivatives.
      </p>
    </section>

    <section id="part2">
      <h2>PART 2 — Strategy & Tips (roadmap only)</h2>

      <div class="callout">
        <h4>Plan (5–10 steps)</h4>
        <ol>
          <li><b>Fit n(λ) to a quadratic</b> \(n(λ)=aλ^2+bλ+c\) (λ in μm). <span class="muted">Tool: polynomial interpolation through 3 points.</span></li>
          <li><b>Differentiate</b> to get \(dn/dλ\) and \(d^2n/dλ^2\). <span class="muted">Tool: calculus of polynomials.</span></li>
          <li><b>Compute group index</b> \(n_g=n-λ\,dn/dλ\). <span class="muted">Principle: group velocity in dispersive media.</span></li>
          <li><b>Compute group velocity</b> \(v_g=c_0/n_g\). <span class="muted">Tool: definition of group index.</span></li>
          <li><b>Derive dispersion parameter</b> \(D_\lambda=(1/c_0)\,dn_g/dλ = -(λ/c_0)\,d^2n/dλ^2\).</li>
          <li><b>Convert units</b> to ps/(km·nm). <span class="muted">Tool: dimensional analysis and metric prefixes.</span></li>
          <li><b>Evaluate</b> \(D_\lambda\) at representative wavelengths (e.g., 0.81 μm) and compare to silica fiber order-of-magnitude.</li>
        </ol>
      </div>

      <div class="grid2">
        <div class="callout">
          <h4>Common mistakes</h4>
          <ul>
            <li>Mixing wavelength units in derivatives (μm vs m) without conversion.</li>
            <li>Forgetting the minus sign in \(D_\lambda=-(λ/c_0)\,d^2n/dλ^2\).</li>
            <li>Confusing <i>phase velocity</i> \(c_0/n\) with <i>group velocity</i> \(c_0/n_g\).</li>
          </ul>
        </div>
        <div class="callout">
          <h4>Quick tips</h4>
          <ul>
            <li>Keep λ in μm for the polynomial fit, but convert derivatives to SI when computing <i>numerical</i> D in ps/(km·nm).</li>
            <li>Check that \(n_g\) is close to 1 (air!), so \(v_g\) is close to \(c_0\).</li>
            <li>Because the fit is quadratic, \(d^2n/dλ^2\) is constant → \(D_\lambda \propto λ\).</li>
          </ul>
        </div>
      </div>
    </section>

    <section id="part3">
      <h2>PART 3 — Full Solution</h2>

      <h3>Physical intuition first</h3>
      <p>
        Air has refractive index extremely close to 1. Its dispersion is also very weak: the refractive index changes only
        in the 7th decimal place across the given wavelengths. Therefore:
      </p>
      <ul>
        <li>The <b>phase velocity</b> \(v_p=c_0/n\) is only slightly smaller than \(c_0\).</li>
        <li>The <b>group velocity</b> \(v_g=c_0/n_g\) is also extremely close to \(c_0\).</li>
        <li>The <b>dispersion parameter</b> \(D_\lambda\) will be small compared to typical guided-wave silica fibers.</li>
      </ul>

      <hr class="hr"/>

      <h3>Step 1: Quadratic fit to n(λ)</h3>
      <p>
        We fit the refractive index to a quadratic in wavelength (with <b>λ measured in μm</b>):
      </p>

      <div class="equation" id="eq_fit">
        n(λ) = a λ^2 + b λ + c   (λ in μm)
      </div>

      <p>
        Using the three data points:
        <span class="muted">n(0.76)=1.0002672, n(0.81)=1.0002669, n(0.86)=1.0002665</span>,
        the quadratic that matches all three exactly is:
      </p>

      <div class="equation" id="eq_fit_num">
        a = −2.00×10^−5
        b =  2.54×10^−5
        c =  1.00025945

        ⇒ n(λ) = 1.00025945 + (2.54×10^−5) λ − (2.00×10^−5) λ^2    (λ in μm)
      </div>

      <p class="muted">
        Equivalent “n−1” form (sometimes nicer because n−1 is what was measured):
      </p>
      <div class="equation" id="eq_fit_nminus1">
        n(λ) − 1 = 2.5945×10^−4 + (2.54×10^−5) λ − (2.00×10^−5) λ^2    (λ in μm)
      </div>

      <hr class="hr"/>

      <h3>Step 2: Group index and group velocity</h3>
      <p>
        Define the group index:
      </p>
      <div class="equation" id="eq_ng_def">
        n_g(λ) = n(λ) − λ (dn/dλ)
      </div>

      <p>
        Differentiate the quadratic:
      </p>
      <div class="equation" id="eq_derivs">
        If n(λ) = aλ^2 + bλ + c, then
        dn/dλ = 2aλ + b
        d^2n/dλ^2 = 2a  (constant)
      </div>

      <p>
        Substitute into the group index:
      </p>
      <div class="equation" id="eq_ng_simplify">
        n_g = (aλ^2 + bλ + c) − λ(2aλ + b)
            = aλ^2 + bλ + c − 2aλ^2 − bλ
            = c − aλ^2
      </div>

      <p>
        Therefore, with our fitted coefficients (still <b>λ in μm</b>):
      </p>
      <div class="equation" id="eq_ng_num">
        n_g(λ) = 1.00025945 − (−2.00×10^−5) λ^2
               = 1.00025945 + (2.00×10^−5) λ^2     (λ in μm)
      </div>

      <p>
        Finally, the group velocity is:
      </p>
      <div class="equation" id="eq_vg">
        v_g(λ) = c_0 / n_g(λ)
      </div>

      <div class="callout">
        <h4>Sanity checks (group velocity)</h4>
        <ul>
          <li><b>Units:</b> n<sub>g</sub> is dimensionless, so v<sub>g</sub> has units of m/s like c₀.</li>
          <li><b>Magnitude:</b> n<sub>g</sub> ≈ 1.00026 ⇒ v<sub>g</sub> is only ~0.026% below c₀.</li>
          <li><b>Trend:</b> n<sub>g</sub> increases slightly with λ² ⇒ v<sub>g</sub> decreases slightly with λ.</li>
        </ul>
      </div>

      <hr class="hr"/>

      <h3>Step 3: Dispersion coefficient D<sub>λ</sub> and unit conversion</h3>
      <p>
        The group delay per unit length is:
      </p>
      <div class="equation" id="eq_taug">
        τ_g/L = n_g(λ)/c_0
      </div>

      <p>
        The dispersion parameter (material dispersion) is defined as the wavelength derivative of group delay per length:
      </p>
      <div class="equation" id="eq_D_def">
        D_λ(λ) = d(τ_g/L)/dλ = (1/c_0) dn_g/dλ
      </div>

      <p>
        Using n<sub>g</sub>=n−λ dn/dλ:
      </p>
      <div class="equation" id="eq_D_alt">
        dn_g/dλ = d/dλ[n − λ dn/dλ]
                = dn/dλ − [dn/dλ + λ d^2n/dλ^2]
                = −λ d^2n/dλ^2

        ⇒ D_λ(λ) = −(λ/c_0) d^2n/dλ^2
      </div>

      <p>
        For our quadratic fit, \(d^2n/dλ^2 = 2a\) is constant. Numerically (with λ in μm in the polynomial),
      </p>
      <div class="equation" id="eq_d2num">
        d^2n/dλ^2 = 2a = 2(−2.00×10^−5) = −4.00×10^−5   per (μm)^2
      </div>

      <p>
        To compute D<sub>λ</sub> in the standard telecom unit ps/(km·nm), use the identity:
      </p>
      <div class="equation" id="eq_unitconv">
        D_λ[ps/(km·nm)] = D_λ[ s/m^2 ] × (10^12 ps/s) × (10^3 m/km) × (10^−9 m/nm)
                        = D_λ[ s/m^2 ] × 10^6
      </div>

      <p>
        If you keep λ in μm for the fit, a convenient closed form emerges:
      </p>
      <div class="equation" id="eq_D_ps_form">
        With λ in μm and (d^2n/dλ^2) in 1/(μm)^2:

        D_λ[ps/(km·nm)] = − (λ_μm / c_0) (d^2n/dλ^2)_μm × 10^12
      </div>

      <p>
        Plug in \( (d^2n/dλ^2)_μm = −4.00×10^−5\) and \(c_0≈3.00×10^8\) m/s:
      </p>
      <div class="equation" id="eq_D_final">
        D_λ(λ) ≈ −(λ_μm / 3.00×10^8) (−4.00×10^−5) × 10^12
              ≈ (4.00×10^7 / 3.00×10^8) λ_μm
              ≈ 0.1333 λ_μm    ps/(km·nm)
      </div>

      <div class="boxedFinal">
        <h3>Final Results (boxed)</h3>

        <div class="equation" id="eq_final_all">
          Quadratic fit (λ in μm):
          n(λ) = 1.00025945 + (2.54×10^−5)λ − (2.00×10^−5)λ^2

          Group index:
          n_g(λ) = n − λ dn/dλ = 1.00025945 + (2.00×10^−5)λ^2

          Group velocity:
          v_g(λ) = c_0 / n_g(λ)

          Dispersion parameter:
          D_λ(λ) = −(λ/c_0) d^2n/dλ^2  ≈ 0.1333 λ(μm)   ps/(km·nm)
        </div>
        <p class="copyNote">Use the “Copy” button on each equation block to copy plain text.</p>
      </div>

      <h3>Numerical check at a representative wavelength</h3>
      <p>
        At λ = 0.81 μm:
      </p>
      <div class="kpiRow" id="kpis">
        <div class="kpi">
          <div class="label">Group index n<sub>g</sub>(0.81 μm)</div>
          <div class="value" id="kpi_ng">—</div>
        </div>
        <div class="kpi">
          <div class="label">Group velocity v<sub>g</sub>(0.81 μm)</div>
          <div class="value" id="kpi_vg">—</div>
        </div>
        <div class="kpi">
          <div class="label">Dispersion D<sub>λ</sub>(0.81 μm)</div>
          <div class="value" id="kpi_D">—</div>
        </div>
      </div>

      <div class="callout">
        <h4>Sanity checks (dispersion)</h4>
        <ul>
          <li><b>Sign:</b> Here \(d^2n/dλ^2&lt;0\) ⇒ \(D_\lambda&gt;0\) (normal convention gives positive D).</li>
          <li><b>Scaling:</b> Because \(d^2n/dλ^2\) is constant, \(D_\lambda \propto λ\) (a straight line vs wavelength).</li>
          <li><b>Magnitude:</b> ~0.1 ps/(km·nm) is tiny: air’s material dispersion is extremely weak.</li>
        </ul>
      </div>
    </section>

    <section id="viz">
      <h2>Interactive Visualizations</h2>
      <p class="muted">
        The slider scales air “density” (think pressure/temperature changes) by multiplying <b>(n−1)</b> by a factor <b>s</b>.
        Since air’s refractivity is approximately proportional to density, this is a physically meaningful knob:
        \(n(λ;s) = 1 + s\,[n(λ;1) − 1]\). This changes both v<sub>g</sub>(λ) and D<sub>λ</sub>(λ).
      </p>

      <div class="controls" aria-label="Interactive controls">
        <div class="control">
          <label>
            <span>Density scale <b>s</b> (multiplies n−1)</span>
            <span class="pill"><b id="sVal">1.00</b></span>
          </label>
          <input id="sSlider" type="range" min="0.20" max="2.00" step="0.01" value="1.00" />
          <div class="muted" style="font-size:.88rem;margin-top:6px;">
            s≈1 corresponds to 1 atm at 20&nbsp;°C (given data). Larger s → slightly slower v<sub>g</sub> and larger |D|.
          </div>
        </div>

        <div class="control">
          <label>
            <span>Marker wavelength λ₀</span>
            <span class="pill"><b id="lamVal">0.81 μm</b></span>
          </label>
          <select id="lamSelect">
            <option value="0.76">0.76 μm</option>
            <option value="0.81" selected>0.81 μm</option>
            <option value="0.86">0.86 μm</option>
            <option value="0.80">0.80 μm (extra)</option>
            <option value="0.85">0.85 μm (extra)</option>
          </select>
          <div class="btnRow">
            <button class="button" id="btnReset">Reset to s = 1</button>
            <button class="button" id="btnSnap">Snap λ-range to data</button>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:14px;">
        <div class="figureCard">
          <figure class="smallCanvas">
            <canvas id="cDiagram" aria-label="Michelson interferometer diagram"></canvas>
            <figcaption>
              <b>Diagram:</b> Michelson interferometer concept for measuring air refractive index (a gas cell in one arm).
              A change in optical path length shifts fringes, enabling precise n measurement.
            </figcaption>
          </figure>
        </div>

        <div class="figureCard">
          <figure class="smallCanvas">
            <canvas id="cPlot1" aria-label="Group velocity vs wavelength plot"></canvas>
            <figcaption>
              <b>Main plot:</b> Group velocity v<sub>g</sub>(λ) from the fitted n(λ).
              Marker shows v<sub>g</sub>(λ₀) for the selected wavelength and density scale.
            </figcaption>
          </figure>
        </div>
      </div>

      <div class="figureCard" style="margin-top:14px;">
        <figure>
          <canvas id="cPlot2" aria-label="Dispersion parameter vs wavelength plot"></canvas>
          <figcaption>
            <b>Secondary plot:</b> Dispersion parameter D<sub>λ</sub>(λ) in ps/(km·nm).
            Because the fit is quadratic, D<sub>λ</sub> is nearly a straight line in λ.
          </figcaption>
        </figure>
      </div>
    </section>

    <section id="compare">
      <h2>Comparison to Silica Optical Fiber (order of magnitude)</h2>
      <p>
        Typical single-mode silica fiber dispersion (total waveguide + material) is often quoted around
        <b>~17 ps/(nm·km)</b> near <b>1.55 μm</b> (telecom window). Near <b>0.8 μm</b>, silica’s material dispersion is generally much larger
        (often tens to >100 ps/(nm·km), depending on composition).
      </p>
      <p>
        In contrast, this air fit gives <b>D<sub>λ</sub> ≈ 0.10 ps/(nm·km)</b> around 0.8 μm—roughly
        <b>two to three orders of magnitude smaller</b> than silica fiber values.
      </p>
      <div class="callout">
        <h4>Physical interpretation</h4>
        <ul>
          <li>Air is weakly polarizable → n is very close to 1 → its wavelength dependence is also weak → small dispersion.</li>
          <li>Silica is a dense dielectric with resonances closer (in relative terms) → stronger dispersion and much larger D.</li>
        </ul>
      </div>
    </section>
  </article>
</main>

<footer>
  <p>
    Built with vanilla HTML/CSS/JS. Interactive plots are computed from the same fitted model used in the derivation.
  </p>
</footer>

<script>
/* ---------------------------
   Copy buttons for equations
----------------------------*/
(function attachCopyButtons(){
  const blocks = document.querySelectorAll('.equation');
  blocks.forEach((block, idx) => {
    const btn = document.createElement('button');
    btn.className = 'copyBtn';
    btn.type = 'button';
    btn.textContent = 'Copy';
    btn.addEventListener('click', async () => {
      const text = block.textContent.replace(/\n[ \t]+/g, "\n").trim();
      try{
        await navigator.clipboard.writeText(text);
        btn.textContent = 'Copied!';
        setTimeout(()=>btn.textContent='Copy', 900);
      }catch(e){
        btn.textContent = 'Failed';
        setTimeout(()=>btn.textContent='Copy', 900);
      }
    });
    block.appendChild(btn);
  });
})();

/* ---------------------------
   Smooth TOC scrolling
----------------------------*/
document.querySelectorAll('#toc a').forEach(a=>{
  a.addEventListener('click', (e)=>{
    const id = a.getAttribute('href');
    if(!id || !id.startsWith('#')) return;
    const el = document.querySelector(id);
    if(!el) return;
    e.preventDefault();
    el.scrollIntoView({behavior:'smooth', block:'start'});
    history.replaceState(null, '', id);
  });
});

/* ---------------------------
   Physics model
   Base fit at s=1, λ in μm:
   n(λ)=a λ^2 + b λ + c
----------------------------*/
const model = {
  a: -2.0e-5,
  b:  2.54e-5,
  c:  1.00025945,
  c0: 299792458, // m/s
  // density scale s multiplies (n-1)
  n_um: (lam_um, s=1) => {
    const n1 = (model.a*lam_um*lam_um + model.b*lam_um + model.c);
    return 1 + s*(n1 - 1);
  },
  dn_dlam_um: (lam_um, s=1) => { // dn/dλ with λ in μm
    // derivative of base polynomial, then scaled for (n-1)
    // n = 1 + s*(n_base - 1) => dn/dλ = s * dn_base/dλ
    const dn_base = 2*model.a*lam_um + model.b;
    return s * dn_base;
  },
  d2n_dlam2_um: (s=1) => { // constant
    // d²n/dλ² = s*(2a)
    return s * (2*model.a); // per μm^2
  },
  ng_um: (lam_um, s=1) => {
    const n = model.n_um(lam_um, s);
    const dn = model.dn_dlam_um(lam_um, s);
    return n - lam_um*dn; // consistent as long as λ uses same unit as derivative
  },
  vg: (lam_um, s=1) => model.c0 / model.ng_um(lam_um, s),
  // D in ps/(km·nm)
  D_ps_km_nm: (lam_um, s=1) => {
    // D = -(λ/c0) d²n/dλ²   with λ in meters, d²n/dλ² in 1/m²
    // Convert: λ_m = λ_um * 1e-6
    // d²n/dλ²[m^-2] = d²n/dλ²[um^-2] * (1e6)^2 = *1e12
    const lam_m = lam_um * 1e-6;
    const d2_um = model.d2n_dlam2_um(s); // per um^2
    const d2_m  = d2_um * 1e12;
    const D_SI  = -(lam_m / model.c0) * d2_m; // s/m^2
    const D_ps  = D_SI * 1e6; // ps/(km·nm)
    return D_ps;
  }
};

/* ---------------------------
   Simple plotting utilities
----------------------------*/
function setupHiDPICanvas(canvas){
  const ctx = canvas.getContext('2d');
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(10, Math.floor(rect.width * dpr));
    const h = Math.max(10, Math.floor(rect.height * dpr));
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w;
      canvas.height = h;
    }
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  }
  resize();
  const ro = new ResizeObserver(()=>resize());
  ro.observe(canvas);
  return {ctx, resize, ro};
}

function drawPanelFrame(ctx, W, H){
  // subtle vignette
  ctx.save();
  ctx.fillStyle = 'rgba(0,0,0,0)';
  ctx.fillRect(0,0,W,H);
  ctx.restore();
}

function niceTicks(min, max, n=6){
  const span = max - min;
  if(span <= 0) return {step:1, start:min, ticks:[min]};
  const raw = span / (n-1);
  const pow = Math.pow(10, Math.floor(Math.log10(raw)));
  const frac = raw / pow;
  let niceFrac;
  if(frac < 1.5) niceFrac = 1;
  else if(frac < 3) niceFrac = 2;
  else if(frac < 7) niceFrac = 5;
  else niceFrac = 10;
  const step = niceFrac * pow;
  const start = Math.floor(min/step)*step;
  const end = Math.ceil(max/step)*step;
  const ticks = [];
  for(let v = start; v <= end + 0.5*step; v += step) ticks.push(v);
  return {step, start, end, ticks};
}

function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
  const {x,y,w,h,padL,padR,padT,padB} = box;
  const plotX = x + padL, plotY = y + padT, plotW = w - padL - padR, plotH = h - padT - padB;

  // background
  ctx.save();
  ctx.fillStyle = 'rgba(6,10,22,0.35)';
  ctx.fillRect(x,y,w,h);
  ctx.restore();

  // title
  ctx.save();
  ctx.fillStyle = 'rgba(233,238,252,0.95)';
  ctx.font = '600 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText(title, x+padL, y+18);
  ctx.restore();

  // grid + ticks
  const xt = niceTicks(xMin, xMax, 6);
  const yt = niceTicks(yMin, yMax, 6);

  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.10)';
  ctx.lineWidth = 1;

  // grid lines
  xt.ticks.forEach(v=>{
    const px = plotX + (v-xMin)/(xMax-xMin)*plotW;
    ctx.beginPath(); ctx.moveTo(px, plotY); ctx.lineTo(px, plotY+plotH); ctx.stroke();
  });
  yt.ticks.forEach(v=>{
    const py = plotY + plotH - (v-yMin)/(yMax-yMin)*plotH;
    ctx.beginPath(); ctx.moveTo(plotX, py); ctx.lineTo(plotX+plotW, py); ctx.stroke();
  });
  ctx.restore();

  // axes border
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.18)';
  ctx.lineWidth = 1;
  ctx.strokeRect(plotX, plotY, plotW, plotH);
  ctx.restore();

  // tick labels
  ctx.save();
  ctx.fillStyle = 'rgba(185,195,230,0.95)';
  ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';

  xt.ticks.forEach(v=>{
    if(v < xMin - 1e-12 || v > xMax + 1e-12) return;
    const px = plotX + (v-xMin)/(xMax-xMin)*plotW;
    const label = (Math.abs(v) >= 1000 || Math.abs(v) < 0.001) ? v.toExponential(2) : (+v.toFixed(3)).toString();
    ctx.fillText(label, px-10, plotY+plotH+18);
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255,255,255,0.18)';
    ctx.moveTo(px, plotY+plotH); ctx.lineTo(px, plotY+plotH+6); ctx.stroke();
  });

  yt.ticks.forEach(v=>{
    if(v < yMin - 1e-12 || v > yMax + 1e-12) return;
    const py = plotY + plotH - (v-yMin)/(yMax-yMin)*plotH;
    const label = (Math.abs(v) >= 1000 || Math.abs(v) < 0.001) ? v.toExponential(2) : (+v.toFixed(3)).toString();
    ctx.fillText(label, plotX-8-ctx.measureText(label).width, py+4);
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255,255,255,0.18)';
    ctx.moveTo(plotX-6, py); ctx.lineTo(plotX, py); ctx.stroke();
  });

  // axis labels
  ctx.fillStyle = 'rgba(233,238,252,0.95)';
  ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText(xLabel, plotX + plotW - ctx.measureText(xLabel).width, y + h - 8);

  // rotate for y label
  ctx.save();
  ctx.translate(x+14, plotY + plotH/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
  ctx.restore();

  ctx.restore();

  return {plotX, plotY, plotW, plotH};
}

function toPxX(x, xMin, xMax, ax){ return ax.plotX + (x-xMin)/(xMax-xMin)*ax.plotW; }
function toPxY(y, yMin, yMax, ax){ return ax.plotY + ax.plotH - (y-yMin)/(yMax-yMin)*ax.plotH; }

function drawLine(ctx, xs, ys, xMin, xMax, yMin, yMax, ax){
  ctx.beginPath();
  for(let i=0;i<xs.length;i++){
    const px = toPxX(xs[i], xMin, xMax, ax);
    const py = toPxY(ys[i], yMin, yMax, ax);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.stroke();
}

function drawMarker(ctx, x0, y0, xMin, xMax, yMin, yMax, ax){
  const px = toPxX(x0, xMin, xMax, ax);
  const py = toPxY(y0, yMin, yMax, ax);
  ctx.save();
  ctx.strokeStyle = 'rgba(99,230,190,0.85)';
  ctx.lineWidth = 1;
  // crosshair
  ctx.beginPath(); ctx.moveTo(px, ax.plotY); ctx.lineTo(px, ax.plotY+ax.plotH); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(ax.plotX, py); ctx.lineTo(ax.plotX+ax.plotW, py); ctx.stroke();
  // point
  ctx.fillStyle = 'rgba(99,230,190,0.95)';
  ctx.beginPath(); ctx.arc(px, py, 4, 0, Math.PI*2); ctx.fill();
  ctx.restore();
}

function drawLegendBox(ctx, x, y, lines){
  ctx.save();
  ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  const pad=10, lh=16;
  let w=0;
  lines.forEach(s => { w = Math.max(w, ctx.measureText(s).width); });
  const boxW = w + pad*2;
  const boxH = lines.length*lh + pad*2 - 4;

  ctx.fillStyle = 'rgba(0,0,0,0.35)';
  ctx.strokeStyle = 'rgba(255,255,255,0.18)';
  ctx.lineWidth=1;
  ctx.beginPath();
  const r=12;
  roundRect(ctx, x, y, boxW, boxH, r);
  ctx.fill();
  ctx.stroke();

  ctx.fillStyle = 'rgba(233,238,252,0.95)';
  lines.forEach((s,i)=>{
    ctx.fillText(s, x+pad, y+pad + (i+1)*lh - 6);
  });
  ctx.restore();
}

function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

/* ---------------------------
   Diagram: Michelson interferometer
----------------------------*/
const diag = setupHiDPICanvas(document.getElementById('cDiagram'));
function drawDiagram(){
  const canvas = document.getElementById('cDiagram');
  const ctx = diag.ctx;
  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;

  ctx.clearRect(0,0,W,H);
  drawPanelFrame(ctx, W, H);

  // Title
  ctx.save();
  ctx.fillStyle = 'rgba(233,238,252,0.95)';
  ctx.font = '600 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText('Michelson interferometer (conceptual)', 14, 20);
  ctx.restore();

  // Layout points
  const cx = W*0.42, cy = H*0.52;
  const bs = {x:cx, y:cy, s:34};
  const src = {x:W*0.10, y:cy};
  const m1  = {x:W*0.78, y:H*0.26};
  const m2  = {x:W*0.78, y:H*0.78};
  const det = {x:W*0.20, y:H*0.20};

  // beams
  function beam(x1,y1,x2,y2, alpha=0.85){
    ctx.save();
    ctx.strokeStyle = `rgba(122,162,255,${alpha})`;
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    ctx.restore();
  }
  function beam2(x1,y1,x2,y2, alpha=0.85){
    ctx.save();
    ctx.strokeStyle = `rgba(99,230,190,${alpha})`;
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
    ctx.restore();
  }

  // Source to beamsplitter
  beam(src.x, src.y, bs.x, bs.y);

  // Split arms
  beam(bs.x, bs.y, m1.x, m1.y);
  beam2(bs.x, bs.y, m2.x, m2.y);

  // Return beams
  beam(m1.x, m1.y, bs.x, bs.y, 0.55);
  beam2(m2.x, m2.y, bs.x, bs.y, 0.55);

  // Output to detector
  beam(bs.x, bs.y, det.x, det.y, 0.9);

  // Components
  // Source
  ctx.save();
  ctx.fillStyle = 'rgba(255,255,255,0.10)';
  ctx.strokeStyle = 'rgba(255,255,255,0.20)';
  ctx.lineWidth=1;
  ctx.beginPath(); ctx.arc(src.x, src.y, 12, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.fillStyle='rgba(233,238,252,0.95)';
  ctx.font='12px ui-sans-serif, system-ui';
  ctx.fillText('Laser', src.x-16, src.y-18);
  ctx.restore();

  // Beam splitter (diamond)
  ctx.save();
  ctx.translate(bs.x, bs.y);
  ctx.rotate(Math.PI/4);
  ctx.fillStyle='rgba(255,255,255,0.10)';
  ctx.strokeStyle='rgba(255,255,255,0.22)';
  ctx.lineWidth=1;
  ctx.beginPath();
  ctx.rect(-bs.s/2, -bs.s/2, bs.s, bs.s);
  ctx.fill(); ctx.stroke();
  ctx.restore();

  ctx.save();
  ctx.fillStyle='rgba(233,238,252,0.95)';
  ctx.font='12px ui-sans-serif, system-ui';
  ctx.fillText('Beam splitter', bs.x-44, bs.y+bs.s/2+18);
  ctx.restore();

  // Mirrors
  function mirror(p, label){
    ctx.save();
    ctx.strokeStyle='rgba(255,255,255,0.28)';
    ctx.lineWidth=4;
    ctx.beginPath();
    ctx.moveTo(p.x-18, p.y-18);
    ctx.lineTo(p.x+18, p.y+18);
    ctx.stroke();
    ctx.fillStyle='rgba(233,238,252,0.95)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText(label, p.x-16, p.y-24);
    ctx.restore();
  }
  mirror(m1,'M1');
  mirror(m2,'M2');

  // Gas cell on upper arm
  const cell = {x: (bs.x+m1.x)/2, y: (bs.y+m1.y)/2, w: 110, h: 30};
  ctx.save();
  ctx.translate(cell.x, cell.y);
  ctx.rotate(Math.atan2(m1.y-bs.y, m1.x-bs.x));
  ctx.fillStyle='rgba(255,212,59,0.10)';
  ctx.strokeStyle='rgba(255,212,59,0.32)';
  ctx.lineWidth=1.5;
  ctx.beginPath();
  roundRect(ctx, -cell.w/2, -cell.h/2, cell.w, cell.h, 10);
  ctx.fill(); ctx.stroke();
  ctx.fillStyle='rgba(255,212,59,0.95)';
  ctx.font='12px ui-sans-serif, system-ui';
  ctx.fillText('Air cell', -22, 4);
  ctx.restore();

  // Detector
  ctx.save();
  ctx.fillStyle='rgba(255,255,255,0.10)';
  ctx.strokeStyle='rgba(255,255,255,0.22)';
  ctx.lineWidth=1;
  ctx.beginPath();
  roundRect(ctx, det.x-28, det.y-16, 56, 32, 10);
  ctx.fill(); ctx.stroke();
  ctx.fillStyle='rgba(233,238,252,0.95)';
  ctx.font='12px ui-sans-serif, system-ui';
  ctx.fillText('Detector', det.x-24, det.y-22);
  ctx.restore();

  // Caption note
  ctx.save();
  ctx.fillStyle='rgba(185,195,230,0.95)';
  ctx.font='12px ui-sans-serif, system-ui';
  ctx.fillText('Fringe shift ↔ optical path change ↔ refractive index n(λ)', 14, H-14);
  ctx.restore();
}

/* ---------------------------
   Plots: v_g(λ) and D(λ)
----------------------------*/
const plot1 = setupHiDPICanvas(document.getElementById('cPlot1'));
const plot2 = setupHiDPICanvas(document.getElementById('cPlot2'));

let xRange = {min: 0.74, max: 0.88}; // μm default
function linspace(a,b,n){
  const arr = new Array(n);
  for(let i=0;i<n;i++) arr[i]= a + (b-a)*i/(n-1);
  return arr;
}

function drawPlotVg(s, lam0){
  const canvas = document.getElementById('cPlot1');
  const ctx = plot1.ctx;
  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;

  ctx.clearRect(0,0,W,H);

  const xs = linspace(xRange.min, xRange.max, 260);
  const ys = xs.map(l => model.vg(l, s)); // m/s

  // y range padded
  let yMin = Math.min(...ys), yMax = Math.max(...ys);
  const pad = (yMax-yMin)*0.10 || 1;
  yMin -= pad; yMax += pad;

  const box = {x:10, y:10, w:W-20, h:H-20, padL:62, padR:18, padT:34, padB:44};
  const ax = drawAxes(ctx, box, xRange.min, xRange.max, yMin, yMax,
    'Wavelength λ (μm)', 'Group velocity v_g (m/s)', 'Group velocity vs wavelength');

  // line
  ctx.save();
  ctx.strokeStyle = 'rgba(122,162,255,0.95)';
  ctx.lineWidth = 2.2;
  drawLine(ctx, xs, ys, xRange.min, xRange.max, yMin, yMax, ax);
  ctx.restore();

  // marker
  const y0 = model.vg(lam0, s);
  drawMarker(ctx, lam0, y0, xRange.min, xRange.max, yMin, yMax, ax);

  // legend box
  const lines = [
    `s = ${s.toFixed(2)} (scales n−1)`,
    `λ₀ = ${lam0.toFixed(2)} μm`,
    `v_g(λ₀) = ${y0.toFixed(0)} m/s`,
    `Δ from c₀ = ${(model.c0 - y0).toFixed(0)} m/s`
  ];
  drawLegendBox(ctx, ax.plotX + 10, ax.plotY + 10, lines);
}

function drawPlotD(s, lam0){
  const canvas = document.getElementById('cPlot2');
  const ctx = plot2.ctx;
  const W = canvas.getBoundingClientRect().width;
  const H = canvas.getBoundingClientRect().height;

  ctx.clearRect(0,0,W,H);

  const xs = linspace(xRange.min, xRange.max, 260);
  const ys = xs.map(l => model.D_ps_km_nm(l, s)); // ps/(km·nm)

  let yMin = Math.min(...ys), yMax = Math.max(...ys);
  const pad = (yMax-yMin)*0.12 || 0.01;
  yMin -= pad; yMax += pad;

  const box = {x:10, y:10, w:W-20, h:H-20, padL:72, padR:18, padT:34, padB:44};
  const ax = drawAxes(ctx, box, xRange.min, xRange.max, yMin, yMax,
    'Wavelength λ (μm)', 'D_λ (ps/(km·nm))', 'Dispersion parameter vs wavelength');

  // line
  ctx.save();
  ctx.strokeStyle = 'rgba(99,230,190,0.95)';
  ctx.lineWidth = 2.2;
  drawLine(ctx, xs, ys, xRange.min, xRange.max, yMin, yMax, ax);
  ctx.restore();

  // marker
  const y0 = model.D_ps_km_nm(lam0, s);
  drawMarker(ctx, lam0, y0, xRange.min, xRange.max, yMin, yMax, ax);

  // legend box
  const d2 = model.d2n_dlam2_um(s);
  const lines = [
    `s = ${s.toFixed(2)} ; d²n/dλ² = ${(d2).toExponential(2)} 1/μm²`,
    `λ₀ = ${lam0.toFixed(2)} μm`,
    `D_λ(λ₀) = ${y0.toFixed(4)} ps/(km·nm)`,
    `Trend: D ∝ λ (quadratic fit)`
  ];
  drawLegendBox(ctx, ax.plotX + 10, ax.plotY + 10, lines);
}

/* ---------------------------
   KPI updater
----------------------------*/
function updateKPIs(s){
  const lam = 0.81;
  const ng = model.ng_um(lam, s);
  const vg = model.vg(lam, s);
  const D  = model.D_ps_km_nm(lam, s);
  document.getElementById('kpi_ng').textContent = ng.toFixed(9);
  document.getElementById('kpi_vg').textContent = vg.toFixed(0) + ' m/s';
  document.getElementById('kpi_D').textContent  = D.toFixed(4) + ' ps/(km·nm)';
}

/* ---------------------------
   Controls wiring + render loop
----------------------------*/
const sSlider = document.getElementById('sSlider');
const sVal    = document.getElementById('sVal');
const lamSelect = document.getElementById('lamSelect');
const lamVal = document.getElementById('lamVal');

function getState(){
  const s = parseFloat(sSlider.value);
  const lam0 = parseFloat(lamSelect.value);
  return {s, lam0};
}

function renderAll(){
  const {s, lam0} = getState();
  sVal.textContent = s.toFixed(2);
  lamVal.textContent = lam0.toFixed(2) + ' μm';
  updateKPIs(s);
  drawDiagram();
  drawPlotVg(s, lam0);
  drawPlotD(s, lam0);
}

// reset button
document.getElementById('btnReset').addEventListener('click', ()=>{
  sSlider.value = '1.00';
  renderAll();
});

// snap range
document.getElementById('btnSnap').addEventListener('click', ()=>{
  xRange.min = 0.755;
  xRange.max = 0.865;
  renderAll();
});

// input listeners
sSlider.addEventListener('input', renderAll);
lamSelect.addEventListener('change', renderAll);

// initial
renderAll();

// redraw on resize (plots already have ResizeObserver, but we need re-render for scales)
window.addEventListener('resize', ()=>{
  // throttle with requestAnimationFrame
  window.requestAnimationFrame(renderAll);
});
</script>
</body>
</html>
