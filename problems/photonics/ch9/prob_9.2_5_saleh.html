<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>TE Mode Field Distribution in a Symmetric Slab Waveguide (m = 0): Field Profile, Amplitude Ratios, and Confinement Factor</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:rgba(255,255,255,0.06);
      --card2:rgba(255,255,255,0.085);
      --text:rgba(255,255,255,0.92);
      --muted:rgba(255,255,255,0.72);
      --faint:rgba(255,255,255,0.55);
      --line:rgba(255,255,255,0.16);
      --line2:rgba(255,255,255,0.10);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#86efac;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 14px 40px rgba(0,0,0,0.35);
      --shadow2: 0 10px 22px rgba(0,0,0,0.30);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 10% 10%, rgba(125,211,252,0.10), transparent 55%),
        radial-gradient(900px 600px at 90% 15%, rgba(167,139,250,0.10), transparent 55%),
        radial-gradient(900px 600px at 40% 95%, rgba(134,239,172,0.08), transparent 55%),
        linear-gradient(180deg, #070a14 0%, #0b1020 60%, #060814 100%);
      overflow-x:hidden;
    }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    header{
      padding:28px 18px 14px;
      max-width:1200px;
      margin:0 auto;
      position:relative;
    }
    .hero{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.07), rgba(255,255,255,0.04));
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hero-inner{
      padding:22px 22px 18px;
      display:grid;
      grid-template-columns: 1.25fr 0.75fr;
      gap:18px;
      align-items:start;
    }
    .title{
      font-size: clamp(22px, 2.3vw, 34px);
      letter-spacing: 0.2px;
      margin:0 0 8px 0;
      line-height:1.15;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: 14.5px;
      line-height:1.5;
    }
    .pillrow{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .pill{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line2);
      background:rgba(255,255,255,0.04);
      padding:6px 10px;
      border-radius:999px;
      display:inline-flex;
      gap:8px;
      align-items:center;
    }
    .pill b{ color:var(--text); font-weight:600; }
    .sidebox{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.18);
      border-radius:var(--radius2);
      padding:14px 14px 12px;
      box-shadow:var(--shadow2);
    }
    .sidebox h4{
      margin:0 0 10px 0;
      font-size:13px;
      color:var(--muted);
      font-weight:650;
      letter-spacing:0.3px;
      text-transform:uppercase;
    }
    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:8px 10px;
      font-size:13px;
      color:var(--muted);
      align-items:baseline;
    }
    .kv div:nth-child(2n){
      color:var(--text);
      font-family:var(--mono);
      font-size:12.5px;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding:14px 18px 40px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:16px;
      align-items:start;
    }

    nav.toc{
      position:sticky;
      top:14px;
      align-self:start;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(255,255,255,0.045);
      box-shadow:var(--shadow2);
      padding:14px 12px 12px;
      overflow:hidden;
    }
    .toc h3{
      margin:0 0 10px 0;
      font-size:13px;
      letter-spacing:0.3px;
      color:var(--muted);
      text-transform:uppercase;
    }
    .toc a{
      display:block;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid transparent;
      color:var(--text);
      font-size:13px;
      line-height:1.25;
      margin:6px 0;
      background:rgba(0,0,0,0.14);
    }
    .toc a:hover{
      border-color:var(--line);
      background:rgba(255,255,255,0.06);
      text-decoration:none;
    }
    .toc .mini{
      margin-top:10px;
      padding:10px;
      border-top:1px solid var(--line2);
      color:var(--faint);
      font-size:12.5px;
      line-height:1.45;
    }

    article.content{
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(255,255,255,0.045);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .section{
      padding:20px 22px;
      border-top:1px solid var(--line2);
    }
    .section:first-child{ border-top:none; }
    .section h2{
      margin:0 0 12px 0;
      font-size:18px;
      letter-spacing:0.2px;
    }
    .section h3{
      margin:16px 0 10px 0;
      font-size:15.5px;
      color:var(--text);
    }
    .section p{
      margin:10px 0;
      color:var(--muted);
      line-height:1.62;
      font-size:14.5px;
    }
    .section ul, .section ol{
      margin:10px 0 10px 18px;
      color:var(--muted);
      line-height:1.6;
      font-size:14.5px;
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
    }
    .callout{
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.16);
      border-radius:var(--radius2);
      padding:12px 12px 10px;
    }
    .callout h4{
      margin:0 0 8px 0;
      font-size:13px;
      color:var(--text);
      letter-spacing:0.2px;
    }
    .callout p, .callout li{ color:var(--muted); font-size:13.8px; }
    .tag{
      display:inline-block;
      font-size:11.5px;
      padding:3px 8px;
      border-radius:999px;
      margin-left:8px;
      border:1px solid var(--line2);
      color:var(--faint);
      background:rgba(255,255,255,0.035);
      vertical-align:middle;
    }

    .eq{
      border:1px solid var(--line2);
      background:rgba(255,255,255,0.03);
      border-radius:var(--radius2);
      padding:12px 12px 10px;
      margin:10px 0;
      position:relative;
      overflow:hidden;
    }
    .eq .label{
      color:var(--faint);
      font-size:12px;
      margin-bottom:6px;
      letter-spacing:0.25px;
      text-transform:uppercase;
    }
    .eq pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family:var(--mono);
      font-size:13px;
      color:rgba(255,255,255,0.88);
      line-height:1.45;
    }
    .copybtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid var(--line2);
      background:rgba(0,0,0,0.25);
      color:var(--text);
      border-radius:12px;
      padding:7px 10px;
      cursor:pointer;
      font-size:12px;
      transition: transform 140ms ease, background 140ms ease;
    }
    .copybtn:hover{ transform: translateY(-1px); background:rgba(255,255,255,0.08); }
    .copybtn:active{ transform: translateY(0px); }

    .viz{
      border:1px solid var(--line);
      background:rgba(0,0,0,0.18);
      border-radius:var(--radius);
      padding:14px;
      box-shadow:var(--shadow2);
    }
    .vizhead{
      display:flex;
      justify-content:space-between;
      align-items:flex-end;
      gap:12px;
      flex-wrap:wrap;
      margin-bottom:10px;
    }
    .vizhead h3{
      margin:0;
      font-size:15px;
    }
    .controls{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .control{
      border:1px solid var(--line2);
      border-radius:14px;
      padding:8px 10px;
      background:rgba(255,255,255,0.04);
      display:flex;
      gap:10px;
      align-items:center;
    }
    .control label{
      font-size:12px;
      color:var(--muted);
      white-space:nowrap;
    }
    .control input[type="range"]{
      width:190px;
    }
    .control .val{
      font-family:var(--mono);
      font-size:12px;
      color:var(--text);
      min-width:86px;
      text-align:right;
    }

    canvas{
      width:100%;
      height:auto;
      display:block;
      border-radius:14px;
      border:1px solid rgba(255,255,255,0.10);
      background:rgba(2,4,10,0.55);
    }
    .vizgrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .smallnote{
      font-size:12.5px;
      color:var(--faint);
      margin-top:10px;
      line-height:1.45;
    }
    .resultline{
      display:flex;
      flex-wrap:wrap;
      gap:10px 14px;
      margin-top:10px;
      color:var(--muted);
      font-size:13.5px;
      align-items:center;
    }
    .badge{
      font-family:var(--mono);
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,0.04);
      color:var(--text);
      font-size:12.5px;
    }

    footer{
      max-width:1200px;
      margin:0 auto;
      padding:18px 18px 30px;
      color:var(--faint);
      font-size:12.5px;
      line-height:1.5;
    }

    /* subtle section reveal */
    .section{ animation: fadeUp 520ms ease both; }
    @keyframes fadeUp{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0px); }
    }

    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
      nav.toc{ position:relative; top:auto; }
      .hero-inner{ grid-template-columns:1fr; }
      .grid2, .grid3{ grid-template-columns:1fr; }
      .control input[type="range"]{ width:160px; }
    }

    @media print{
      body{ background:white; color:#111; }
      header, main, footer{ max-width: 900px; }
      nav.toc{ display:none; }
      article.content, .hero{ box-shadow:none; }
      .eq, .callout, .viz{ background:white; }
      .copybtn{ display:none; }
      canvas{ border:1px solid #ccc; background:white; }
      a{ color:#111; text-decoration:underline; }
    }
  </style>
</head>

<body>
<header>
  <div class="hero">
    <div class="hero-inner">
      <div>
        <h1 class="title">9.2-5 — TE Mode Field Distribution in a Symmetric Slab Waveguide (m = 0)</h1>
        <p class="subtitle">
          We derive the ratio between the inside/outside amplitude constants by enforcing boundary conditions, then compute and plot the
          fundamental TE<sub>0</sub> (m = 0) field profile for <span class="badge">n₁ = 1.48</span>, <span class="badge">n₂ = 1.46</span>,
          <span class="badge">d = 0.5 μm</span>, <span class="badge">λ₀ = 0.85 μm</span>, and evaluate the confinement factor (power fraction in the slab).
        </p>
        <div class="pillrow">
          <span class="pill"><b>Mode:</b> TE (E ⟂ plane of incidence)</span>
          <span class="pill"><b>Geometry:</b> slab (1D transverse)</span>
          <span class="pill"><b>Outcome:</b> symbolic + numeric + interactive plots</span>
        </div>
      </div>
      <aside class="sidebox" aria-label="Quick numeric results">
        <h4>Live results (updates with slider)</h4>
        <div class="kv">
          <div>Guided?</div><div id="kvGuided">—</div>
          <div>β (propagation const.)</div><div id="kvBeta">—</div>
          <div>n<sub>eff</sub> = β/k₀</div><div id="kvNeff">—</div>
          <div>k<sub>y</sub> (core)</div><div id="kvKy">—</div>
          <div>γ (cladding decay)</div><div id="kvGam">—</div>
          <div>Confinement Γ</div><div id="kvGamma">—</div>
        </div>
      </aside>
    </div>
  </div>
</header>

<main>
  <nav class="toc" aria-label="Table of contents">
    <h3>Table of Contents</h3>
    <a href="#quick-summary">Quick Summary</a>
    <a href="#part0">PART 0 — Concept Primer</a>
    <a href="#part1">PART 1 — Problem Analysis</a>
    <a href="#part2">PART 2 — Strategy & Tips</a>
    <a href="#part3">PART 3 — Full Solution</a>
    <a href="#part4">PART 4 — Deeper Understanding</a>
    <a href="#part5">PART 5 — Visualization Guide</a>
    <div class="mini">
      Tip: change the <b>core thickness d</b> slider to see how confinement and evanescent decay change in real time.
    </div>
  </nav>

  <article class="content">
    <!-- Quick Summary -->
    <section class="section" id="quick-summary">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>Topic:</b> guided TE modes in a symmetric dielectric slab waveguide (core index n₁, cladding index n₂).</li>
        <li><b>Key physics idea:</b> the transverse field is <b>oscillatory in the core</b> and <b>evanescent in the cladding</b>, and boundary matching fixes both the <b>eigenvalue</b> (β) and amplitude ratios.</li>
        <li><b>Governing equation (transverse):</b> a 1D Helmholtz form: u″ + k<sub>y</sub><sup>2</sup>u = 0 in the core; u″ − γ<sup>2</sup>u = 0 in the cladding.</li>
        <li><b>Dispersion relations:</b> k<sub>y</sub><sup>2</sup> = n₁²k₀² − β² and γ² = β² − n₂²k₀² (guided mode requires n₂k₀ &lt; β &lt; n₁k₀).</li>
        <li><b>Eigencondition (TE, even m=0):</b> k<sub>y</sub> tan(k<sub>y</sub>a) = γ, where a = d/2.</li>
        <li><b>Amplitude ratio result:</b> matching u and u′ at y = ±a gives the <b>outside amplitude constant</b> in terms of the inside constant.</li>
        <li><b>Numeric result for given parameters (TE₀):</b> confinement factor Γ ≈ <b id="qsGamma">0.287</b> (≈ <b id="qsGammaPct">28.7%</b> of power in the slab).</li>
      </ul>
    </section>

    <!-- PART 0 -->
    <section class="section" id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div class="callout">
          <h4>Core definitions (symbols & units)</h4>
          <ul>
            <li><b>λ₀</b> (m): free-space wavelength; <b>k₀ = 2π/λ₀</b> (rad/m).</li>
            <li><b>n₁</b>, <b>n₂</b> (dimensionless): refractive indices (core, cladding), with n₁ &gt; n₂ for guiding.</li>
            <li><b>d</b> (m): core thickness; <b>a = d/2</b> (m) half-thickness.</li>
            <li><b>β</b> (rad/m): propagation constant along z; defines <b>n<sub>eff</sub> = β/k₀</b>.</li>
            <li><b>u(y)</b> (arb.): transverse mode profile for E-field complex amplitude.</li>
            <li><b>k<sub>y</sub></b> (rad/m): transverse oscillation wavenumber in the core; <b>γ</b> (rad/m): evanescent decay constant in the cladding.</li>
          </ul>
        </div>

        <div class="callout">
          <h4>Physical meaning (why these quantities matter)</h4>
          <ul>
            <li><b>β</b> sets the phase accumulation along the guide: E ∝ e<sup>−jβz</sup>. Larger β → higher effective index.</li>
            <li><b>k<sub>y</sub></b> controls <b>how quickly the field varies across the core</b> (standing-wave-like behavior).</li>
            <li><b>γ</b> controls <b>how tightly the field decays outside</b>. Larger γ → stronger confinement.</li>
            <li>The <b>confinement factor Γ</b> is the fraction of optical power (or energy) residing in the core — crucial for losses, nonlinearity, gain, and sensing.</li>
          </ul>
        </div>
      </div>

      <h3>Key laws & assumptions (when this model is valid)</h3>
      <p>
        We model a <b>planar slab waveguide</b> that is uniform along z and x (so variation is only in y).
        For time-harmonic fields e<sup>jωt</sup> in <b>linear, isotropic, non-magnetic</b> dielectrics (μ ≈ μ₀),
        Maxwell’s equations reduce to a scalar Helmholtz equation for a TE polarization component (commonly E<sub>x</sub>):
      </p>

      <div class="eq" id="eq-helm">
        <div class="label">Scalar wave equation (TE)</div>
        <button class="copybtn" data-copy="(d^2u/dy^2) + (n(y)^2 k0^2 - beta^2) u = 0">Copy</button>
        <pre>(d²u/dy²) + [ n(y)² k₀² − β² ] u = 0,
k₀ = 2π/λ₀,   E_x(y,z) = A · u(y) · e^(−jβz)</pre>
      </div>

      <p>
        Because n(y) is piecewise constant, the equation becomes:
        <b>u″ + k<sub>y</sub><sup>2</sup>u = 0</b> in the core (oscillatory) and <b>u″ − γ<sup>2</sup>u = 0</b> in the cladding (evanescent).
        A <b>guided mode</b> requires <b>β &gt; n₂k₀</b> so that γ is real and the field decays away from the core.
      </p>

      <div class="callout">
        <h4>Common approximations & why we use them</h4>
        <ul>
          <li><b>Lossless dielectrics:</b> n real → no absorption → clean confinement factor interpretation.</li>
          <li><b>Non-magnetic:</b> μ same in core/cladding → simplifies TE boundary conditions to continuity of u and u′.</li>
          <li><b>Power ∝ ∫|u|²dy:</b> for TE in a uniform medium, the z-directed power scales with |E|²; using ∫|u|² is a standard, accurate proxy for confinement in this setting.</li>
        </ul>
      </div>

      <h3>Mini intuition examples (no long algebra)</h3>
      <ul>
        <li><b>Thicker core (bigger d):</b> supports larger standing-wave region → typically increases Γ and allows more modes.</li>
        <li><b>Higher index contrast (n₁ − n₂):</b> increases γ → faster decay outside → stronger confinement.</li>
      </ul>

      <div class="callout">
        <h4>What to watch for (pitfalls)</h4>
        <ul>
          <li>Mixing <b>λ₀</b> (free-space) with <b>λ = λ₀/n₁</b> (in-core) without tracking definitions.</li>
          <li>For TE, the correct boundary conditions are continuity of <b>E<sub>t</sub></b> and <b>H<sub>t</sub></b>, which here reduce to <b>u</b> and <b>du/dy</b> continuous (μ constant).</li>
          <li>For guided modes, ensure <b>n₂k₀ &lt; β &lt; n₁k₀</b> (otherwise γ becomes imaginary → radiating/leaky behavior).</li>
        </ul>
      </div>
    </section>

    <!-- PART 1 -->
    <section class="section" id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Restating the problem</h3>
      <p>
        A symmetric slab waveguide has a TE mode whose transverse field distribution u<sub>m</sub>(y) is:
        <b>cosine or sine inside the core</b> (depending on parity) and <b>exponential outside</b>.
        You must:
      </p>
      <ul>
        <li>derive an expression for the <b>ratio of the proportionality constants</b> (inside vs. outside field amplitudes) using boundary matching;</li>
        <li>for the <b>m = 0</b> TE mode with given parameters, <b>plot u(y)</b> and compute the <b>confinement factor</b> (percent of power in the slab).</li>
      </ul>

      <div class="grid2">
        <div class="callout">
          <h4>Given</h4>
          <ul>
            <li>n₁ = 1.48 (core), n₂ = 1.46 (cladding)</li>
            <li>d = 0.5 μm (core thickness), a = d/2</li>
            <li>λ₀ = 0.85 μm → k₀ = 2π/λ₀</li>
            <li>Mode: TE, m = 0 (even symmetry)</li>
          </ul>
        </div>
        <div class="callout">
          <h4>Unknowns / required outputs</h4>
          <ul>
            <li>Amplitude ratio (external constant)/(internal constant)</li>
            <li>β (or n<sub>eff</sub>), k<sub>y</sub>, γ for TE₀</li>
            <li>Confinement factor Γ = P<sub>core</sub>/P<sub>total</sub> in %</li>
            <li>Plots: field distribution + a parameter-sweep style plot</li>
          </ul>
        </div>
      </div>

      <h3>Relevant principles (and why they apply)</h3>
      <ul>
        <li><b>Scalar Helmholtz equation</b> for TE polarization in piecewise uniform media → gives sinusoid in core and exponential in cladding.</li>
        <li><b>Boundary conditions at y = ±a:</b> tangential E is continuous; tangential H is continuous.
          For this TE slab (μ same), this becomes <b>u continuous</b> and <b>du/dy continuous</b>.</li>
        <li><b>Guidance condition:</b> field must decay outside → γ real → β &gt; n₂k₀.</li>
      </ul>

      <div class="callout">
        <h4>Assumptions (explicit)</h4>
        <ul>
          <li>1D slab (no x variation), infinite extent in x and z.</li>
          <li>Lossless, linear, isotropic dielectrics; μ = μ₀ everywhere.</li>
          <li>Time-harmonic steady-state; single-frequency solution.</li>
          <li>Symmetric cladding on both sides (same n₂ above and below).</li>
        </ul>
      </div>

      <h3>Possible approaches (compare briefly)</h3>
      <ol>
        <li><b>Direct boundary matching (best here):</b> write u(y) in each region, enforce continuity at y = ±a. Pros: transparent; yields amplitude ratio and eigencondition directly.</li>
        <li><b>Normalized slab theory (V–b diagram):</b> use normalized frequency V and solve standard transcendental equation. Pros: compact; good for mode counting. Cons: still needs numeric solve for given parameters.</li>
        <li><b>Transfer-matrix / characteristic matrix:</b> treat each layer and propagate boundary conditions. Pros: generalizes to multi-layer stacks. Cons: heavier than needed for a single symmetric slab.</li>
      </ol>
      <p>
        We choose <b>direct boundary matching</b> because the problem explicitly references the inside sinusoid and outside exponential forms and asks for the <b>ratio of proportionality constants</b>.
      </p>
    </section>

    <!-- PART 2 -->
    <section class="section" id="part2">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

      <ol>
        <li><b>Set geometry and notation:</b> define a = d/2, core region |y| ≤ a, cladding |y| &gt; a. <span class="tag">Goal</span> avoid sign mistakes.</li>
        <li><b>Write the TE mode ansatz:</b> E<sub>x</sub>(y,z) = A·u(y)·e<sup>−jβz</sup>. <span class="tag">Tool</span> separation of variables.</li>
        <li><b>Solve the transverse ODE in each region:</b> sinusoid in core, exponential decay in cladding. <span class="tag">Meaning</span> standing wave + evanescent tails.</li>
        <li><b>Choose symmetry for m=0:</b> even mode → u ∝ cos(k<sub>y</sub>y) in the core. <span class="tag">Tip</span> TE₀ is always even.</li>
        <li><b>Apply boundary conditions at y = a:</b> enforce u continuity and u′ continuity. <span class="tag">Result</span> (i) eigen-equation for β, and (ii) amplitude ratio (outside/inside constants).</li>
        <li><b>Relate k<sub>y</sub>, γ, β:</b> k<sub>y</sub><sup>2</sup> = n₁²k₀² − β², γ² = β² − n₂²k₀². <span class="tag">Meaning</span> dispersion geometry.</li>
        <li><b>Compute confinement factor Γ:</b> use Γ = ∫<sub>core</sub>|u|²dy / ∫<sub>all</sub>|u|²dy. <span class="tag">Tip</span> overall amplitude cancels.</li>
        <li><b>Plot u(y) and |u|²:</b> show core boundaries, exponential tails, and a sweep plot Γ(d). <span class="tag">Meaning</span> connect math to physical confinement.</li>
      </ol>

      <div class="callout">
        <h4>Common mistakes & quick tips</h4>
        <ul>
          <li><b>Forgetting the decay must be away from the core:</b> use u ∝ e<sup>−γ(|y|−a)</sup> outside to make decay direction obvious.</li>
          <li><b>Mixing parity:</b> even → cos; odd → sin. For m = 0 choose <b>even</b>.</li>
          <li><b>Confinement definition:</b> if you use |u|², be consistent in core and cladding and include both sides (factor of 2 for symmetric tails).</li>
        </ul>
      </div>
    </section>

    <!-- PART 3 -->
    <section class="section" id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Qualitative expectation before calculation</h3>
      <p>
        For a guided TE₀ mode, we expect the field to be <b>largest in the core</b>, vary smoothly (no nodes for the fundamental),
        and extend evanescently into the cladding. With a thin core and small index contrast (n₁−n₂ = 0.02),
        the mode should be <b>weakly confined</b>, so a noticeable fraction of power resides outside.
      </p>

      <h3>Step 1 — Set up the wave equation and region solutions</h3>
      <p>
        Let the slab extend from y = −a to y = +a where a = d/2. For TE polarization, we can write
      </p>

      <div class="eq">
        <div class="label">Field separation</div>
        <button class="copybtn" data-copy="E_x(y,z)=A u(y) exp(-j beta z),  with  u'' + (n(y)^2 k0^2 - beta^2) u = 0">Copy</button>
        <pre>Eₓ(y,z) = A · u(y) · exp(−jβ z),
u''(y) + [n(y)²k₀² − β²] u(y) = 0</pre>
      </div>

      <p>
        In the core (n = n₁) define
        <b>k<sub>y</sub>² = n₁²k₀² − β²</b>, so the ODE becomes u″ + k<sub>y</sub>²u = 0 (harmonic).
        In the cladding (n = n₂) define <b>γ² = β² − n₂²k₀²</b>, so u″ − γ²u = 0 (exponential).
      </p>

      <div class="eq" id="eq-disp">
        <div class="label">Dispersion relations (guided TE mode)</div>
        <button class="copybtn" data-copy="ky^2 = n1^2 k0^2 - beta^2,   gamma^2 = beta^2 - n2^2 k0^2,   n2 k0 < beta < n1 k0">Copy</button>
        <pre>k_y² = n₁² k₀² − β²
γ²   = β² − n₂² k₀²
Guided mode requires:  n₂ k₀ &lt; β &lt; n₁ k₀  (so k_y, γ real)</pre>
      </div>

      <h3>Step 2 — Choose the TE₀ (m=0) parity and write u(y)</h3>
      <p>
        For a symmetric slab, modes have definite parity. The <b>m = 0</b> mode is <b>even</b>, so in the core:
      </p>

      <div class="eq">
        <div class="label">Core field (even TE₀)</div>
        <button class="copybtn" data-copy="u_core(y)=C cos(k_y y),   |y|<=a">Copy</button>
        <pre>u_core(y) = C · cos(k_y y),    |y| ≤ a</pre>
      </div>

      <p>
        Outside, the field must decay away from the core. The clean symmetric way to write it is:
      </p>

      <div class="eq" id="eq-outshift">
        <div class="label">Cladding field written to decay away from the boundary</div>
        <button class="copybtn" data-copy="u_clad(y)=D exp(-gamma (|y|-a)),   |y|>=a">Copy</button>
        <pre>u_clad(y) = D · exp[ −γ (|y| − a) ],    |y| ≥ a</pre>
      </div>

      <p>
        This form ensures u_clad(a) = D and then decays as |y| increases.
        (The book’s unshifted exp(−γy) form is equivalent, but the constants differ by exp(±γa).)
      </p>

      <h3>Step 3 — Apply TE boundary conditions to get (i) eigen-equation and (ii) amplitude ratio</h3>
      <p>
        For TE with μ constant, the tangential E and H continuity at y=a reduces to:
        <b>u continuous</b> and <b>du/dy continuous</b>.
        Evaluate both at y = a (upper boundary). For the even mode:
      </p>

      <div class="eq" id="eq-bc">
        <div class="label">Boundary matching at y = a</div>
        <button class="copybtn" data-copy="Continuity at y=a:  u_core(a)=u_clad(a),  u'_core(a)=u'_clad(a)">Copy</button>
        <pre>u_core(a) = u_clad(a)
u'_core(a) = u'_clad(a)</pre>
      </div>

      <p><b>Continuity of u:</b></p>
      <div class="eq">
        <div class="label">Field continuity (even)</div>
        <pre>C cos(k_y a) = D</pre>
      </div>

      <p><b>Continuity of u′:</b> compute derivatives</p>
      <ul>
        <li>u′<sub>core</sub>(y) = −C k<sub>y</sub> sin(k<sub>y</sub>y)</li>
        <li>For y ≥ a: u<sub>clad</sub>(y) = D e^{−γ(y−a)} ⇒ u′<sub>clad</sub>(y) = −D γ e^{−γ(y−a)} ⇒ u′<sub>clad</sub>(a) = −D γ</li>
      </ul>

      <div class="eq">
        <div class="label">Derivative continuity (even)</div>
        <pre>−C k_y sin(k_y a) = −D γ</pre>
      </div>

      <p>
        Divide derivative continuity by field continuity to eliminate C and D:
      </p>

      <div class="eq" id="eq-eigen-even">
        <div class="label">TE even-mode eigencondition (TE₀ uses this)</div>
        <button class="copybtn" data-copy="k_y tan(k_y a) = gamma   (even TE modes)">Copy</button>
        <pre>k_y tan(k_y a) = γ   (even TE modes)</pre>
      </div>

      <p>
        And from field continuity we directly obtain the requested <b>ratio of proportionality constants</b> (outside vs. inside):
      </p>

      <div class="eq" id="eq-ratio-shift">
        <div class="label">Amplitude constant ratio (shifted exponential form)</div>
        <button class="copybtn" data-copy="D/C = cos(k_y a)   (with u_clad = D exp(-gamma(|y|-a)))">Copy</button>
        <pre>D/C = cos(k_y a)  (using u_clad = D exp[−γ(|y|−a)])</pre>
      </div>

      <p>
        <b>Connection to the book’s unshifted exp(−γy) form:</b>
        If instead you write the upper cladding as u = B exp(−γy) (as in the screenshot),
        then u(a)=B exp(−γa). Matching u(a)=C cos(k<sub>y</sub>a) gives:
      </p>

      <div class="eq" id="eq-ratio-unshift">
        <div class="label">Amplitude ratio in the book’s unshifted form</div>
        <button class="copybtn" data-copy="B/C = cos(k_y a) exp(gamma a)   (upper cladding u=B exp(-gamma y))">Copy</button>
        <pre>Upper cladding: u = B exp(−γ y)
Match at y=a:   C cos(k_y a) = B exp(−γ a)
⇒ B/C = cos(k_y a) · exp(+γ a)</pre>
      </div>

      <p>
        (A similar expression holds for the lower cladding with exp(+γy).)
        The key idea: <b>the eigencondition comes from matching derivatives</b>, and the <b>amplitude ratio comes from matching the field value</b>.
      </p>

      <h3>Step 4 — Confinement factor Γ (percentage of power in the slab)</h3>
      <p>
        For this TE slab (uniform in x, propagation along z), the z-directed power scales with |E<sub>x</sub>|².
        Since E<sub>x</sub> ∝ u(y), a standard confinement measure is
      </p>

      <div class="eq" id="eq-gamma-def">
        <div class="label">Confinement factor definition (TE slab)</div>
        <button class="copybtn" data-copy="Gamma = (∫_{-a}^{a} |u(y)|^2 dy) / (∫_{-∞}^{∞} |u(y)|^2 dy)">Copy</button>
        <pre>Γ =  ( ∫_{-a}^{a} |u(y)|² dy ) / ( ∫_{-∞}^{∞} |u(y)|² dy )</pre>
      </div>

      <p>
        Using u<sub>core</sub>(y)=C cos(k<sub>y</sub>y) and u<sub>clad</sub>(y)=D exp[−γ(|y|−a)] with D=C cos(k<sub>y</sub>a),
        the overall constant C cancels. Then:
      </p>

      <ul>
        <li><b>Core energy integral:</b> ∫<sub>−a</sub><sup>a</sup> cos²(k<sub>y</sub>y) dy</li>
        <li><b>Cladding energy integral:</b> 2 ∫<sub>a</sub><sup>∞</sup> cos²(k<sub>y</sub>a) e^{−2γ(y−a)} dy = cos²(k<sub>y</sub>a)/γ</li>
      </ul>

      <div class="eq" id="eq-gamma-formula">
        <div class="label">Closed-form Γ for the even TE mode (using the shifted exponential)</div>
        <button class="copybtn" data-copy="Gamma = Icore / (Icore + Iclad),  Icore = ∫_{-a}^{a} cos^2(k_y y) dy = a + sin(2 k_y a)/(2 k_y),  Iclad = cos^2(k_y a)/gamma">Copy</button>
        <pre>Γ = I_core / (I_core + I_clad)

I_core = ∫_{-a}^{a} cos²(k_y y) dy
       = a + [sin(2 k_y a)]/(2 k_y)

I_clad = cos²(k_y a)/γ</pre>
      </div>

      <h3>Step 5 — Numerical evaluation for the given parameters (TE₀)</h3>
      <p>
        With n₁=1.48, n₂=1.46, d=0.5 μm (a=0.25 μm), λ₀=0.85 μm, we solve the TE₀ eigencondition
        k<sub>y</sub>tan(k<sub>y</sub>a)=γ together with the dispersion relations to find β (and thus n<sub>eff</sub>).
        The interactive code below performs this solve via bracketing + bisection.
      </p>

      <div class="callout">
        <h4>Numerical results (for the given parameters)</h4>
        <p style="margin-top:6px">
          Using the guided TE₀ root:
        </p>
        <ul>
          <li>β ≈ <span class="badge" id="numBeta">—</span> rad/m, so n<sub>eff</sub> = β/k₀ ≈ <span class="badge" id="numNeff">—</span>.</li>
          <li>k<sub>y</sub> ≈ <span class="badge" id="numKy">—</span> rad/m, γ ≈ <span class="badge" id="numGam">—</span> rad/m.</li>
          <li>Confinement factor Γ ≈ <span class="badge" id="numGamma">—</span> (≈ <span class="badge" id="numGammaPct">—</span>).</li>
        </ul>
      </div>

      <div class="eq" id="final-answer">
        <div class="label">Final answer (copy-ready)</div>
        <button class="copybtn" data-copy="" id="copyFinal">Copy</button>
        <pre id="finalText">Loading…</pre>
      </div>

      <h3>Sanity checks</h3>
      <ul>
        <li><b>Units:</b> β, k<sub>y</sub>, γ all have units rad/m; Γ is dimensionless.</li>
        <li><b>Guidance bounds:</b> n₂ &lt; n<sub>eff</sub> &lt; n₁ should hold.</li>
        <li><b>Limiting case intuition:</b> as d → 0, confinement Γ → 0; as d increases, Γ should rise and approach 1 (for strong guidance).</li>
      </ul>

      <p>
        The plotted field should show a <b>cosine-like</b> profile across the core with <b>continuous value and slope</b> at y=±a, followed by <b>exponential tails</b>.
        The decay rate of those tails is controlled by γ.
      </p>
    </section>

    <!-- Visualization block -->
    <section class="section" id="viz">
      <h2>Interactive Visualizations</h2>
      <div class="viz" role="group" aria-label="Interactive slab waveguide plots">
        <div class="vizhead">
          <h3>Diagram + Field Profile + Confinement Sweep</h3>
          <div class="controls">
            <div class="control">
              <label for="dSlider">Core thickness d (μm)</label>
              <input id="dSlider" type="range" min="0.20" max="2.00" value="0.50" step="0.01"/>
              <div class="val" id="dVal">0.50 μm</div>
            </div>
            <div class="control">
              <label for="modeSelect">Mode</label>
              <select id="modeSelect" style="background:transparent;color:var(--text);border:1px solid var(--line2);border-radius:10px;padding:6px 8px;">
                <option value="even0" selected>TE₀ (even)</option>
                <option value="odd1">TE₁ (odd, if guided)</option>
              </select>
              <div class="val" id="modeVal">TE₀</div>
            </div>
            <div class="control">
              <label for="toggleInt">Plot</label>
              <button id="toggleInt" style="cursor:pointer;border:1px solid var(--line2);background:rgba(0,0,0,0.25);color:var(--text);border-radius:12px;padding:7px 10px;font-size:12px;">Show |u|²</button>
              <div class="val" id="plotKindVal">u(y)</div>
            </div>
          </div>
        </div>

        <div class="vizgrid">
          <canvas id="cDiagram" height="220" aria-label="Slab waveguide diagram"></canvas>
          <canvas id="cMain" height="320" aria-label="Main plot: mode field vs y"></canvas>
          <canvas id="cSweep" height="300" aria-label="Secondary plot: confinement factor vs thickness"></canvas>
        </div>

        <div class="resultline" aria-live="polite">
          <span>Current mode:</span> <span class="badge" id="liveMode">TE₀ (even)</span>
          <span>Confinement Γ:</span> <span class="badge" id="liveGamma">—</span>
          <span>Outside/core amplitude ratio:</span> <span class="badge" id="liveRatio">—</span>
        </div>

        <div class="smallnote">
          The solver enforces guided conditions and boundary matching. If a chosen mode is not guided for the current d, the plots will indicate “no guided solution”.
        </div>
      </div>
    </section>

    <!-- PART 4 -->
    <section class="section" id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpreting the final formulas: what controls what?</h3>
      <ul>
        <li><b>k<sub>y</sub>² = n₁²k₀² − β²:</b> if β increases (higher n<sub>eff</sub>), then k<sub>y</sub> decreases → slower oscillation across the core.</li>
        <li><b>γ² = β² − n₂²k₀²:</b> if β increases, γ increases → <b>faster decay</b> outside → stronger confinement.</li>
        <li><b>Eigencondition k<sub>y</sub>tan(k<sub>y</sub>a)=γ:</b> the “fit” of the standing-wave core field must be compatible with how strongly the field can decay outside.</li>
        <li><b>Amplitude ratio D/C = cos(k<sub>y</sub>a):</b> boundary value of the core solution sets the “launch amplitude” of the evanescent tails.</li>
        <li><b>Confinement Γ:</b> increases when the tails shrink (larger γ) or when the field spreads less into cladding (smaller boundary value cos(k<sub>y</sub>a) in the weak guidance regime can also matter).</li>
      </ul>

      <h3>How changing parameters affects the outcome (connect to plots)</h3>
      <ul>
        <li><b>Increase d:</b> typically increases Γ and may allow higher-order modes (TE₁, TE₂, …). In the sweep plot you should see Γ(d) trending upward.</li>
        <li><b>Decrease d:</b> Γ drops; near cutoff, γ → 0 and the tails become long (weak confinement).</li>
        <li><b>Increase index contrast (n₁−n₂):</b> increases the “guiding strength” → larger γ → higher Γ at the same d.</li>
        <li><b>Increase λ₀:</b> reduces k₀, reducing V = k₀ a √(n₁²−n₂²) and pushing the system toward cutoff (weaker confinement).</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        You can derive the same TE eigenconditions using <b>normalized variables</b>:
        define V = k₀ a √(n₁² − n₂²),
        u = k<sub>y</sub>a, w = γa, and note that u² + w² = V².
        Then the even-TE condition becomes <b>u tan u = w</b>.
        This is the standard “V–b” slab formalism used to count modes and visualize cutoffs.
      </p>

      <div class="callout">
        <h4>Concept check (quick self-test with answers)</h4>
        <ul>
          <li><b>Q:</b> Why must β &gt; n₂k₀ for a guided mode? <b>A:</b> So that γ = √(β²−n₂²k₀²) is real, giving exponential decay (no radiation to infinity).</li>
          <li><b>Q:</b> For TE₀, why choose cos in the core? <b>A:</b> Symmetric slab → even fundamental mode with no nodes; cos is even.</li>
          <li><b>Q:</b> If γ increases, what happens to confinement? <b>A:</b> Tails decay faster → more power stays in the core → Γ increases.</li>
          <li><b>Q:</b> What indicates “near cutoff” in the plots? <b>A:</b> Very long evanescent tails (small γ) and Γ dropping toward 0.</li>
        </ul>
      </div>
    </section>

    <!-- PART 5 -->
    <section class="section" id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <h3>Canvas 1 — Diagram (geometry + labels)</h3>
      <p>
        The diagram shows the slab core (index n₁) of thickness d centered at y=0, surrounded by cladding (index n₂).
        The mode propagates along +z with propagation constant β. The transverse coordinate y is the direction of confinement.
      </p>

      <h3>Canvas 2 — Main plot (field profile)</h3>
      <p>
        The main plot shows either <b>u(y)</b> or <b>|u(y)|²</b> versus y (in μm). Vertical dashed lines mark the boundaries y = ±a.
        In the core the curve is sinusoidal (for TE₀: cosine-like); outside it transitions smoothly into exponential decay.
      </p>

      <h3>Canvas 3 — Secondary plot (parameter sweep)</h3>
      <p>
        The sweep plot shows the confinement factor Γ as a function of core thickness d (μm) for the fixed indices and wavelength.
        The <b>current slider value</b> is highlighted so you can compare the current operating point to the global trend.
      </p>

      <h3>Interactive controls</h3>
      <ul>
        <li><b>Core thickness slider d:</b> changes a = d/2, which changes the eigenvalue β, the decay γ, and therefore both plots and Γ.</li>
        <li><b>Mode selector:</b> lets you attempt TE₀ (even) or TE₁ (odd). If TE₁ is not guided for the chosen d, the solver reports no solution.</li>
        <li><b>Plot toggle:</b> switches between u(y) and |u(y)|². Confinement is based on |u|², so the intensity view makes Γ visually intuitive.</li>
      </ul>
    </section>
  </article>
</main>

<footer>
  <div style="border-top:1px solid rgba(0,0,0,0); padding-top:6px;">
    Built as a self-contained learning article (vanilla HTML/CSS/JS). Numerical solving uses bracketing + bisection for the TE slab transcendental equation.
  </div>
</footer>

<script>
/* =========================
   Utilities: copy buttons
========================= */
(function(){
  function toast(msg){
    const t = document.createElement('div');
    t.textContent = msg;
    t.style.position='fixed';
    t.style.left='50%';
    t.style.bottom='18px';
    t.style.transform='translateX(-50%)';
    t.style.background='rgba(0,0,0,0.7)';
    t.style.color='white';
    t.style.padding='10px 12px';
    t.style.border='1px solid rgba(255,255,255,0.2)';
    t.style.borderRadius='14px';
    t.style.fontSize='12.5px';
    t.style.zIndex='9999';
    t.style.backdropFilter='blur(6px)';
    t.style.boxShadow='0 10px 24px rgba(0,0,0,0.35)';
    document.body.appendChild(t);
    setTimeout(()=>{ t.style.opacity='0'; t.style.transition='opacity 220ms ease'; }, 900);
    setTimeout(()=>{ t.remove(); }, 1200);
  }

  async function copyText(txt){
    try{
      await navigator.clipboard.writeText(txt);
      toast('Copied!');
    }catch(e){
      // fallback
      const ta=document.createElement('textarea');
      ta.value=txt;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      ta.remove();
      toast('Copied!');
    }
  }

  document.addEventListener('click', (ev)=>{
    const btn = ev.target.closest('.copybtn');
    if(!btn) return;
    const txt = btn.getAttribute('data-copy') ?? '';
    if(txt.trim().length===0){
      const tgt = document.getElementById('finalText');
      copyText(tgt ? tgt.textContent : '');
    }else{
      copyText(txt);
    }
  });

  // smooth scroll for toc
  document.querySelectorAll('nav.toc a').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const id = a.getAttribute('href');
      const el = document.querySelector(id);
      if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
    });
  });
})();

/* =========================
   Slab waveguide TE solver
   - symmetric slab
   - even (TE0) and odd (TE1) options
   - uses bisection on beta
========================= */

const params = {
  n1: 1.48,
  n2: 1.46,
  lambda0_um: 0.85, // μm
  d_um: 0.50,       // μm (slider)
  mode: 'even0',    // 'even0' or 'odd1'
  plotIntensity: false
};

function k0_from_lambda0_um(lambda0_um){
  const lambda0_m = lambda0_um * 1e-6;
  return 2*Math.PI / lambda0_m;
}
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

function solveTE(params){
  const n1=params.n1, n2=params.n2;
  const k0 = k0_from_lambda0_um(params.lambda0_um);
  const a = (params.d_um*1e-6)/2;

  const betaMin = n2*k0*(1+1e-10);
  const betaMax = n1*k0*(1-1e-10);

  function ky(beta){
    const v = (n1*k0)**2 - beta**2;
    return v>0 ? Math.sqrt(v) : NaN;
  }
  function gam(beta){
    const v = beta**2 - (n2*k0)**2;
    return v>0 ? Math.sqrt(v) : NaN;
  }

  function f_even(beta){
    const kyv=ky(beta), gv=gam(beta);
    if(!isFinite(kyv) || !isFinite(gv)) return NaN;
    const x = kyv*a;
    // avoid tan singularities, but TE0 root should be before first singularity
    return kyv*Math.tan(x) - gv;
  }
  function f_odd(beta){
    const kyv=ky(beta), gv=gam(beta);
    if(!isFinite(kyv) || !isFinite(gv)) return NaN;
    const x = kyv*a;
    // odd TE: -ky cot(ky a) = gamma  -> ky*(1/tan) + gamma = 0? Let's write:
    // ky*cot(x) = -gamma  -> ky*(cos/sin) + gamma = 0
    // We'll implement ky/Math.tan(x) + gv = 0
    return kyv/Math.tan(x) + gv;
  }

  const f = (params.mode==='odd1') ? f_odd : f_even;

  // Root finding: scan for sign change
  const Nscan = 900;
  let prevB = betaMin;
  let prevF = f(prevB);
  let bracket = null;

  for(let i=1;i<=Nscan;i++){
    const b = betaMin + (betaMax-betaMin)*(i/Nscan);
    const fb = f(b);
    if(!isFinite(prevF) || !isFinite(fb)){
      prevB=b; prevF=fb; continue;
    }
    if(prevF===0){
      bracket = [prevB, prevB]; break;
    }
    if(prevF*fb < 0){
      bracket = [prevB, b];
      break;
    }
    prevB=b; prevF=fb;
  }

  if(!bracket){
    return { guided:false, reason:'No sign-change root found (mode likely not guided for this d).', k0, a };
  }

  // Bisection
  let [lo,hi] = bracket;
  let flo=f(lo), fhi=f(hi);
  if(!isFinite(flo) || !isFinite(fhi)) return { guided:false, reason:'Numerical issue bracketing root.', k0, a };
  if(lo===hi){
    const beta=lo;
    const kyv=ky(beta), gv=gam(beta);
    return { guided:true, beta, ky:kyv, gam:gv, k0, a };
  }

  for(let it=0; it<80; it++){
    const mid = 0.5*(lo+hi);
    const fmid = f(mid);
    if(!isFinite(fmid)) { hi = mid; fhi = fmid; continue; }
    if(Math.abs(fmid) < 1e-11*Math.max(1,Math.abs(flo),Math.abs(fhi))) { lo=hi=mid; break; }
    if(flo*fmid < 0){ hi=mid; fhi=fmid; }
    else { lo=mid; flo=fmid; }
  }
  const beta=0.5*(lo+hi);
  const kyv=ky(beta), gv=gam(beta);
  if(!(beta>n2*k0 && beta<n1*k0) || !isFinite(kyv) || !isFinite(gv)){
    return { guided:false, reason:'Root not in guided interval or invalid ky/gamma.', k0, a };
  }
  return { guided:true, beta, ky:kyv, gam:gv, k0, a };
}

function confinementFactorEven(sol){
  // For even: u_core = C cos(ky y) ; u_clad = D exp(-gamma(|y|-a)), D = C cos(ky a)
  const ky=sol.ky, gam=sol.gam, a=sol.a;
  const Icore = a + Math.sin(2*ky*a)/(2*ky);
  const Iclad = (Math.cos(ky*a)**2)/gam;
  return Icore/(Icore+Iclad);
}
function confinementFactorOdd(sol){
  // For odd: u_core = C sin(ky y); u_clad = D exp(-gamma(|y|-a)), D = C sin(ky a)
  const ky=sol.ky, gam=sol.gam, a=sol.a;
  const Icore = a - Math.sin(2*ky*a)/(2*ky); // integral of sin^2 from -a..a = a - sin(2ky a)/(2ky)
  const Iclad = (Math.sin(ky*a)**2)/gam;
  return Icore/(Icore+Iclad);
}

function formatSI(x, sig=6){
  if(!isFinite(x)) return '—';
  // show in scientific with 3 decimals
  const exp = Math.floor(Math.log10(Math.abs(x)));
  if(Math.abs(exp) <= 3){
    return x.toPrecision(sig);
  }
  return x.toExponential(3);
}
function fmtPct(x){
  if(!isFinite(x)) return '—';
  return (100*x).toFixed(1)+'%';
}

/* =========================
   Canvas plotting helpers
========================= */
function setupCanvas(canvas){
  const ctx = canvas.getContext('2d');
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(2, Math.floor(rect.width*dpr));
    const h = Math.max(2, Math.floor(rect.height*dpr));
    if(canvas.width!==w || canvas.height!==h){
      canvas.width=w; canvas.height=h;
    }
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr,dpr);
  }
  return {ctx, resize};
}

function drawAxes(ctx, rect, xMin, xMax, yMin, yMax, opts){
  const {xLabel, yLabel, title, grid=true, ticks=6, legend=null} = opts||{};
  const x0=rect.x, y0=rect.y, w=rect.w, h=rect.h;

  // frame
  ctx.save();
  ctx.strokeStyle='rgba(255,255,255,0.16)';
  ctx.lineWidth=1;
  roundRect(ctx, x0, y0, w, h, 12);
  ctx.stroke();

  // title
  ctx.fillStyle='rgba(255,255,255,0.9)';
  ctx.font='600 13px ui-sans-serif, system-ui';
  ctx.fillText(title||'', x0+10, y0+18);

  // plot area
  const padL=52, padR=18, padT=28, padB=40;
  const px = { x: x0+padL, y:y0+padT, w: w-padL-padR, h: h-padT-padB };

  // grid + ticks
  ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
  ctx.fillStyle='rgba(255,255,255,0.70)';
  ctx.strokeStyle='rgba(255,255,255,0.10)';
  ctx.lineWidth=1;

  function xTo(u){ return px.x + (u-xMin)/(xMax-xMin)*px.w; }
  function yTo(v){ return px.y + (1-(v-yMin)/(yMax-yMin))*px.h; }

  const n=ticks;
  for(let i=0;i<=n;i++){
    const tx = xMin + (xMax-xMin)*(i/n);
    const x = xTo(tx);
    if(grid){
      ctx.beginPath(); ctx.moveTo(x, px.y); ctx.lineTo(x, px.y+px.h); ctx.stroke();
    }
    ctx.fillText(niceNum(tx), x-10, px.y+px.h+18);
  }
  for(let i=0;i<=n;i++){
    const ty = yMin + (yMax-yMin)*(i/n);
    const y = yTo(ty);
    if(grid){
      ctx.beginPath(); ctx.moveTo(px.x, y); ctx.lineTo(px.x+px.w, y); ctx.stroke();
    }
    ctx.fillText(niceNum(ty), px.x-44, y+4);
  }

  // axis labels
  ctx.fillStyle='rgba(255,255,255,0.82)';
  ctx.font='12.5px ui-sans-serif, system-ui';
  ctx.fillText(xLabel||'', px.x + px.w*0.5 - (ctx.measureText(xLabel||'').width/2), y0+h-12);

  ctx.save();
  ctx.translate(x0+14, px.y + px.h*0.5);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel||'', -ctx.measureText(yLabel||'').width/2, 0);
  ctx.restore();

  // legend
  if(legend && legend.length){
    let lx=px.x+8, ly=px.y+8;
    ctx.font='12px ui-sans-serif, system-ui';
    legend.forEach(item=>{
      ctx.fillStyle=item.color;
      ctx.fillRect(lx, ly-8, 12, 3);
      ctx.fillStyle='rgba(255,255,255,0.80)';
      ctx.fillText(item.label, lx+18, ly-3);
      ly += 16;
    });
  }

  ctx.restore();
  return {px, xTo, yTo};
}

function niceNum(x){
  if(!isFinite(x)) return '—';
  const ax=Math.abs(x);
  if(ax>=1000 || (ax>0 && ax<1e-2)) return x.toExponential(1);
  if(ax<0.1) return x.toFixed(3);
  if(ax<1) return x.toFixed(2);
  if(ax<10) return x.toFixed(2);
  if(ax<100) return x.toFixed(1);
  return x.toFixed(0);
}

function roundRect(ctx, x, y, w, h, r){
  const rr=Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

/* =========================
   Plotting + UI updates
========================= */

const cDiagram = setupCanvas(document.getElementById('cDiagram'));
const cMain = setupCanvas(document.getElementById('cMain'));
const cSweep = setupCanvas(document.getElementById('cSweep'));

let sweepCache = { key:'', data:[] };

function computeFieldSamples(sol, mode, yMax_um=2.0, N=1200){
  // Determine a plotting window that includes several decay lengths
  const a_um = (sol.a*2)*1e6/2; // not used
  const a = sol.a; // meters
  const ky = sol.ky, gam = sol.gam;
  let L = 4*a;
  if(isFinite(gam) && gam>0){
    L = Math.max(L, a + 6/gam); // include ~6 decay lengths
  }
  const L_um = L*1e6;
  const yMin = -L_um;
  const yMax = L_um;

  const ys = new Array(N);
  const u = new Array(N);
  const inten = new Array(N);

  const a_m = a;
  const a_um2 = a_m*1e6;

  // amplitude matching (shifted form): D/C = cos(ky a) for even, sin(ky a) for odd
  const ratioShift = (mode==='odd1') ? Math.sin(ky*a_m) : Math.cos(ky*a_m);

  for(let i=0;i<N;i++){
    const y_um = yMin + (yMax - yMin)*(i/(N-1));
    const y_m = y_um*1e-6;
    ys[i]=y_um;

    let val;
    if(Math.abs(y_m) <= a_m){
      if(mode==='odd1') val = Math.sin(ky*y_m);
      else val = Math.cos(ky*y_m);
    }else{
      const tail = Math.exp(-gam*(Math.abs(y_m)-a_m));
      val = ratioShift * tail;
    }
    u[i]=val;
    inten[i]=val*val;
  }
  return {ys, u, inten, yMin, yMax, a_um: a_um2, ratioShift};
}

function drawDiagram(sol){
  cDiagram.resize();
  const ctx=cDiagram.ctx;
  const W = ctx.canvas.getBoundingClientRect().width;
  const H = ctx.canvas.getBoundingClientRect().height;

  ctx.clearRect(0,0,W,H);

  // Background frame
  ctx.save();
  ctx.strokeStyle='rgba(255,255,255,0.14)';
  ctx.lineWidth=1;
  roundRect(ctx, 0.5, 0.5, W-1, H-1, 14);
  ctx.stroke();
  ctx.restore();

  // Geometry box
  const margin=18;
  const x0=margin, y0=34, w=W-2*margin, h=H-54;

  // axes
  ctx.save();
  ctx.strokeStyle='rgba(255,255,255,0.22)';
  ctx.lineWidth=1;
  // y-axis
  ctx.beginPath(); ctx.moveTo(x0+44, y0+8); ctx.lineTo(x0+44, y0+h-8); ctx.stroke();
  // z-axis (arrow to right)
  ctx.beginPath(); ctx.moveTo(x0+44, y0+h/2); ctx.lineTo(x0+w-18, y0+h/2); ctx.stroke();

  // arrowheads
  function arrowHead(x,y,dir){
    ctx.beginPath();
    if(dir==='up'){
      ctx.moveTo(x,y); ctx.lineTo(x-5,y+10); ctx.lineTo(x+5,y+10);
    }else if(dir==='right'){
      ctx.moveTo(x,y); ctx.lineTo(x-10,y-5); ctx.lineTo(x-10,y+5);
    }
    ctx.closePath();
    ctx.fillStyle='rgba(255,255,255,0.22)';
    ctx.fill();
  }
  arrowHead(x0+44, y0+8, 'up');
  arrowHead(x0+w-18, y0+h/2, 'right');

  ctx.fillStyle='rgba(255,255,255,0.82)';
  ctx.font='12.5px ui-sans-serif, system-ui';
  ctx.fillText('y', x0+30, y0+14);
  ctx.fillText('z', x0+w-20, y0+h/2-10);
  ctx.fillText('Propagation:  exp(−jβz)', x0+60, y0+h/2-10);

  // slab
  const a = sol ? sol.a*1e6 : (params.d_um/2);
  const slabMid = y0 + h/2;
  const slabHalfPx = (h*0.34);
  // map a (μm) to pixels by a consistent scale (diagram, not to real scale)
  const slabThicknessPx = Math.max(22, Math.min(h*0.55, 70 + (params.d_um-0.5)*40));
  const slabTop = slabMid - slabThicknessPx/2;
  const slabBot = slabMid + slabThicknessPx/2;

  // cladding background
  ctx.fillStyle='rgba(125,211,252,0.06)';
  ctx.fillRect(x0+70, y0+10, w-90, h-20);

  // core fill
  ctx.fillStyle='rgba(167,139,250,0.12)';
  ctx.strokeStyle='rgba(167,139,250,0.40)';
  ctx.lineWidth=1.2;
  roundRect(ctx, x0+78, slabTop, w-104, slabThicknessPx, 14);
  ctx.fill();
  ctx.stroke();

  // labels
  ctx.fillStyle='rgba(255,255,255,0.88)';
  ctx.font='600 13px ui-sans-serif, system-ui';
  ctx.fillText('core (n₁)', x0+90, slabTop+18);
  ctx.fillStyle='rgba(255,255,255,0.70)';
  ctx.font='12px ui-sans-serif, system-ui';
  ctx.fillText('cladding (n₂)', x0+90, y0+26);
  ctx.fillText('cladding (n₂)', x0+90, y0+h-10);

  // d bracket
  ctx.strokeStyle='rgba(255,255,255,0.30)';
  ctx.lineWidth=1;
  const bx = x0 + w - 28;
  ctx.beginPath();
  ctx.moveTo(bx, slabTop);
  ctx.lineTo(bx, slabBot);
  ctx.moveTo(bx-8, slabTop); ctx.lineTo(bx+8, slabTop);
  ctx.moveTo(bx-8, slabBot); ctx.lineTo(bx+8, slabBot);
  ctx.stroke();
  ctx.fillStyle='rgba(255,255,255,0.78)';
  ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
  ctx.fillText('d', bx+10, slabMid+4);

  ctx.restore();

  // title
  ctx.save();
  ctx.fillStyle='rgba(255,255,255,0.88)';
  ctx.font='600 13px ui-sans-serif, system-ui';
  ctx.fillText('Slab waveguide cross-section (TE mode, symmetric cladding)', 14, 20);
  ctx.restore();
}

function drawMainPlot(sol, samples, guided, message){
  cMain.resize();
  const ctx=cMain.ctx;
  const W = ctx.canvas.getBoundingClientRect().width;
  const H = ctx.canvas.getBoundingClientRect().height;
  ctx.clearRect(0,0,W,H);

  const rect = {x:0, y:0, w:W, h:H};

  if(!guided){
    const ax = drawAxes(ctx, rect, -2, 2, -1, 1, {
      title:'Mode profile (no guided solution)',
      xLabel:'y (μm)',
      yLabel: params.plotIntensity ? '|u(y)|² (arb.)' : 'u(y) (arb.)',
      ticks:6,
      legend:[]
    });
    ctx.save();
    ctx.fillStyle='rgba(251,191,36,0.9)';
    ctx.font='600 13px ui-sans-serif, system-ui';
    ctx.fillText(message || 'No guided solution for this mode at the chosen d.', ax.px.x+8, ax.px.y+ax.px.h/2);
    ctx.restore();
    return;
  }

  const ys = samples.ys;
  const arr = params.plotIntensity ? samples.inten : samples.u;

  // y range
  let yMin = Infinity, yMax=-Infinity;
  for(let i=0;i<arr.length;i++){
    yMin = Math.min(yMin, arr[i]);
    yMax = Math.max(yMax, arr[i]);
  }
  if(params.plotIntensity){
    yMin = 0;
    yMax = Math.max(1e-6, yMax*1.08);
  }else{
    const pad = 0.12*(yMax-yMin || 1);
    yMin -= pad; yMax += pad;
  }

  const ax = drawAxes(ctx, rect, samples.yMin, samples.yMax, yMin, yMax, {
    title: params.plotIntensity ? 'Intensity profile |u(y)|² with core boundaries' : 'Field profile u(y) with core boundaries',
    xLabel:'y (μm)',
    yLabel: params.plotIntensity ? '|u(y)|² (arb.)' : 'u(y) (arb.)',
    ticks:6,
    legend:[
      {label: params.plotIntensity ? '|u|²' : 'u', color:'rgba(125,211,252,0.95)'},
      {label:'core boundary ±a', color:'rgba(255,255,255,0.45)'}
    ]
  });

  // core boundaries
  const a = samples.a_um;
  ctx.save();
  ctx.strokeStyle='rgba(255,255,255,0.35)';
  ctx.setLineDash([6,6]);
  ctx.lineWidth=1;
  const x1 = ax.xTo(-a);
  const x2 = ax.xTo(+a);
  ctx.beginPath(); ctx.moveTo(x1, ax.px.y); ctx.lineTo(x1, ax.px.y+ax.px.h); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x2, ax.px.y); ctx.lineTo(x2, ax.px.y+ax.px.h); ctx.stroke();
  ctx.setLineDash([]);
  ctx.restore();

  // plot line
  ctx.save();
  ctx.strokeStyle='rgba(125,211,252,0.95)';
  ctx.lineWidth=2;
  ctx.beginPath();
  for(let i=0;i<ys.length;i++){
    const x=ax.xTo(ys[i]);
    const y=ax.yTo(arr[i]);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // emphasize cladding regions softly
  ctx.fillStyle='rgba(167,139,250,0.06)';
  ctx.fillRect(ax.xTo(-samples.yMax), ax.px.y, ax.xTo(-a)-ax.xTo(-samples.yMax), ax.px.h);
  ctx.fillRect(ax.xTo(a), ax.px.y, ax.xTo(samples.yMax)-ax.xTo(a), ax.px.h);

  ctx.restore();

  // annotate key numbers
  ctx.save();
  ctx.fillStyle='rgba(255,255,255,0.82)';
  ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
  const neff = sol.beta/sol.k0;
  ctx.fillText(`n_eff = ${neff.toFixed(6)}   ky=${(sol.ky/1e6).toFixed(4)}e6 rad/m   γ=${(sol.gam/1e6).toFixed(4)}e6 rad/m`, ax.px.x+8, ax.px.y+ax.px.h-8);
  ctx.restore();
}

function drawSweepPlot(data, currentD, currentGamma, guided){
  cSweep.resize();
  const ctx=cSweep.ctx;
  const W = ctx.canvas.getBoundingClientRect().width;
  const H = ctx.canvas.getBoundingClientRect().height;
  ctx.clearRect(0,0,W,H);

  const rect={x:0,y:0,w:W,h:H};

  const xMin=0.20, xMax=2.00;
  const yMin=0, yMax=1;

  const ax = drawAxes(ctx, rect, xMin, xMax, yMin, yMax, {
    title:'Confinement factor Γ vs core thickness d (fixed n₁,n₂,λ₀)',
    xLabel:'d (μm)',
    yLabel:'Γ (power fraction in core)',
    ticks:6,
    legend:[
      {label:'Γ(d) for TE₀', color:'rgba(134,239,172,0.95)'},
      {label:'current d', color:'rgba(251,191,36,0.9)'}
    ]
  });

  // draw curve
  ctx.save();
  ctx.strokeStyle='rgba(134,239,172,0.95)';
  ctx.lineWidth=2;
  ctx.beginPath();
  let started=false;
  data.forEach(pt=>{
    const x=ax.xTo(pt.d);
    const y=ax.yTo(pt.G);
    if(!pt.guided){
      started=false;
      return;
    }
    if(!started){ ctx.moveTo(x,y); started=true; }
    else ctx.lineTo(x,y);
  });
  ctx.stroke();
  ctx.restore();

  // current marker
  ctx.save();
  const x=ax.xTo(currentD);
  const y=ax.yTo(clamp(currentGamma,0,1));
  ctx.fillStyle='rgba(251,191,36,0.92)';
  ctx.strokeStyle='rgba(0,0,0,0.35)';
  ctx.lineWidth=2;
  ctx.beginPath(); ctx.arc(x,y,5.5,0,Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.restore();

  // if not guided, annotate
  if(!guided){
    ctx.save();
    ctx.fillStyle='rgba(251,113,133,0.95)';
    ctx.font='600 13px ui-sans-serif, system-ui';
    ctx.fillText('Current selection is not guided (marker shown at Γ=0).', ax.px.x+8, ax.px.y+22);
    ctx.restore();
  }
}

function computeSweepTE0(){
  const key = `${params.n1}|${params.n2}|${params.lambda0_um}|TE0`;
  if(sweepCache.key===key && sweepCache.data.length>0) return sweepCache.data;

  const pts=[];
  const N=70;
  for(let i=0;i<N;i++){
    const d = 0.20 + (2.00-0.20)*(i/(N-1));
    const p = {...params, d_um:d, mode:'even0'};
    const sol = solveTE(p);
    let G=0;
    if(sol.guided){
      G = confinementFactorEven(sol);
    }
    pts.push({d, guided:sol.guided, G});
  }
  sweepCache = { key, data: pts };
  return pts;
}

function updateAll(){
  // Update UI readouts
  document.getElementById('dVal').textContent = params.d_um.toFixed(2)+' μm';
  document.getElementById('modeVal').textContent = (params.mode==='odd1') ? 'TE₁' : 'TE₀';
  document.getElementById('plotKindVal').textContent = params.plotIntensity ? '|u(y)|²' : 'u(y)';
  document.getElementById('toggleInt').textContent = params.plotIntensity ? 'Show u(y)' : 'Show |u|²';

  // Solve
  const sol = solveTE(params);
  let guided = sol.guided;
  let G = 0;
  let ratioShift = NaN;

  if(guided){
    if(params.mode==='odd1'){
      G = confinementFactorOdd(sol);
      ratioShift = Math.sin(sol.ky*sol.a);
    }else{
      G = confinementFactorEven(sol);
      ratioShift = Math.cos(sol.ky*sol.a);
    }
  }

  // Update badges
  const k0 = sol.k0 || k0_from_lambda0_um(params.lambda0_um);

  const betaTxt = guided ? formatSI(sol.beta, 7) : '—';
  const neffTxt = guided ? (sol.beta/ k0).toFixed(6) : '—';
  const kyTxt   = guided ? formatSI(sol.ky, 7) : '—';
  const gamTxt  = guided ? formatSI(sol.gam, 7) : '—';
  const gammaTxt= guided ? (G.toFixed(6)+' ('+fmtPct(G)+')') : '—';

  document.getElementById('kvGuided').textContent = guided ? 'Yes' : 'No';
  document.getElementById('kvBeta').textContent = betaTxt;
  document.getElementById('kvNeff').textContent = neffTxt;
  document.getElementById('kvKy').textContent = kyTxt;
  document.getElementById('kvGam').textContent = gamTxt;
  document.getElementById('kvGamma').textContent = guided ? fmtPct(G) : '—';

  document.getElementById('numBeta').textContent = betaTxt;
  document.getElementById('numNeff').textContent = neffTxt;
  document.getElementById('numKy').textContent = kyTxt;
  document.getElementById('numGam').textContent = gamTxt;
  document.getElementById('numGamma').textContent = guided ? G.toFixed(6) : '—';
  document.getElementById('numGammaPct').textContent = guided ? fmtPct(G) : '—';

  // Quick summary numbers (fixed text gets updated too)
  document.getElementById('qsGamma').textContent = guided ? G.toFixed(3) : '—';
  document.getElementById('qsGammaPct').textContent = guided ? fmtPct(G) : '—';

  // Live result line
  document.getElementById('liveMode').textContent = (params.mode==='odd1') ? 'TE₁ (odd)' : 'TE₀ (even)';
  document.getElementById('liveGamma').textContent = guided ? (G.toFixed(4)+' ('+fmtPct(G)+')') : '—';
  document.getElementById('liveRatio').textContent = guided ? (`D/C = ${ratioShift.toFixed(6)}`) : '—';

  // Final answer text (copy-ready)
  const a_um = params.d_um/2;
  let final = '';
  final += `TE slab, symmetric (n1=${params.n1}, n2=${params.n2}), a=d/2.\n\n`;
  final += `Core (even): u_core(y)=C cos(ky y), |y|<=a.\n`;
  final += `Cladding (decaying): u_clad(y)=D exp[-gamma(|y|-a)], |y|>=a.\n\n`;
  final += `Amplitude ratio from continuity at y=a:\n`;
  final += `  D/C = cos(ky a)   (even TE)\n`;
  final += `Book unshifted form (upper): u=B exp(-gamma y) gives B/C = cos(ky a) exp(gamma a).\n\n`;
  final += `Eigencondition (even TE): ky tan(ky a) = gamma,\n`;
  final += `with ky^2 = n1^2 k0^2 - beta^2 and gamma^2 = beta^2 - n2^2 k0^2, k0=2π/λ0.\n\n`;
  if(guided){
    const neff = sol.beta/sol.k0;
    final += `For λ0=${params.lambda0_um} μm, d=${params.d_um.toFixed(2)} μm:\n`;
    final += `  beta = ${sol.beta.toExponential(6)} rad/m\n`;
    final += `  n_eff = ${neff.toFixed(6)}\n`;
    final += `  ky = ${sol.ky.toExponential(6)} rad/m\n`;
    final += `  gamma = ${sol.gam.toExponential(6)} rad/m\n`;
    final += `  Confinement factor Γ = ${G.toFixed(6)} = ${fmtPct(G)} power in the slab.\n`;
  }else{
    final += `For λ0=${params.lambda0_um} μm, d=${params.d_um.toFixed(2)} μm:\n`;
    final += `  No guided solution found for the selected mode.\n`;
  }
  document.getElementById('finalText').textContent = final;
  document.getElementById('copyFinal').setAttribute('data-copy', final);

  // Draw canvases
  drawDiagram(sol.guided ? sol : {a:(params.d_um*1e-6)/2});
  if(guided){
    const samples = computeFieldSamples(sol, params.mode);
    drawMainPlot(sol, samples, true, '');
  }else{
    drawMainPlot(sol, null, false, sol.reason || 'No guided solution.');
  }
  const sweep = computeSweepTE0();
  drawSweepPlot(sweep, params.d_um, guided ? G : 0, guided);
}

// UI event listeners
document.getElementById('dSlider').addEventListener('input', (e)=>{
  params.d_um = parseFloat(e.target.value);
  updateAll();
});
document.getElementById('modeSelect').addEventListener('change', (e)=>{
  params.mode = e.target.value;
  document.getElementById('modeVal').textContent = (params.mode==='odd1') ? 'TE₁' : 'TE₀';
  updateAll();
});
document.getElementById('toggleInt').addEventListener('click', ()=>{
  params.plotIntensity = !params.plotIntensity;
  updateAll();
});

window.addEventListener('resize', ()=>{
  // just redraw
  updateAll();
});

// Initialize
updateAll();
</script>
</body>
</html>
