<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Effect of Cladding: Thin-Film (Slab) Waveguide Suspended in Air (n₂ = 1)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1624;
      --panel2:#101b2d;
      --text:#e9eef7;
      --muted:#a9b4c7;
      --faint:#7e8aa3;
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#7CFFB2;
      --warn:#ffd166;
      --bad:#ff6b6b;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.16);
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:24px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 800px at 10% -10%, rgba(110,231,255,.18), transparent 55%),
        radial-gradient(1000px 700px at 110% 10%, rgba(167,139,250,.16), transparent 55%),
        radial-gradient(900px 700px at 50% 120%, rgba(124,255,178,.10), transparent 60%),
        var(--bg);
      color:var(--text);
      line-height:1.55;
    }

    header{
      position:relative;
      padding:48px 18px 22px;
      max-width:1180px;
      margin:0 auto;
    }
    .hero{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:22px 22px 18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .hero h1{
      margin:0 0 10px;
      font-weight:800;
      letter-spacing:.2px;
      line-height:1.15;
      font-size:clamp(1.6rem, 2.8vw, 2.35rem);
    }
    .hero p{
      margin:0;
      color:var(--muted);
      max-width:95ch;
    }
    .meta-row{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    .pill{
      font-size:.88rem;
      color:var(--muted);
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:7px 10px;
      border-radius:999px;
      backdrop-filter: blur(8px);
    }
    .pill strong{color:var(--text); font-weight:700}

    main{
      max-width:1180px;
      margin:0 auto;
      padding:0 18px 60px;
      display:grid;
      grid-template-columns: 330px 1fr;
      gap:16px;
    }

    nav.toc{
      position:sticky;
      top:14px;
      align-self:start;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px 14px 10px;
      box-shadow:var(--shadow);
    }
    nav.toc h2{
      margin:0 0 8px;
      font-size:1rem;
      letter-spacing:.3px;
      color:var(--text);
    }
    .toc a{
      display:block;
      padding:8px 10px;
      border-radius:12px;
      color:var(--muted);
      text-decoration:none;
      border:1px solid transparent;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size:.95rem;
    }
    .toc a:hover{
      background:rgba(110,231,255,.08);
      border-color:rgba(110,231,255,.25);
      transform: translateX(2px);
      color:var(--text);
    }
    .toc .small{
      font-size:.86rem;
      color:var(--faint);
      margin:10px 10px 6px;
    }

    article{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .content{
      padding:18px 20px 22px;
    }

    section{
      padding:18px 0;
      border-top:1px solid var(--line);
    }
    section:first-child{border-top:none}
    h2{
      margin:0 0 10px;
      font-size:1.32rem;
      letter-spacing:.2px;
    }
    h3{
      margin:18px 0 8px;
      font-size:1.08rem;
      color:var(--text);
    }
    p{margin:10px 0; color:var(--text)}
    .muted{color:var(--muted)}
    ul,ol{margin:10px 0 10px 22px; color:var(--text)}
    li{margin:6px 0}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
      nav.toc{position:relative; top:auto}
      .grid2{grid-template-columns:1fr}
    }

    .callout{
      border-radius:16px;
      border:1px solid var(--line2);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding:12px 12px 10px;
      margin:12px 0;
      position:relative;
      overflow:hidden;
    }
    .callout:before{
      content:"";
      position:absolute;
      inset:-1px;
      background: radial-gradient(900px 120px at 20% 0%, rgba(110,231,255,.14), transparent 55%),
                  radial-gradient(900px 120px at 80% 0%, rgba(167,139,250,.12), transparent 55%);
      pointer-events:none;
      opacity:.7;
    }
    .callout > *{position:relative}
    .tag{
      display:inline-block;
      font-size:.78rem;
      letter-spacing:.3px;
      text-transform:uppercase;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line2);
      background:rgba(0,0,0,.18);
      color:var(--muted);
      margin-bottom:8px;
    }
    .tag.good{color:var(--good); border-color: rgba(124,255,178,.35)}
    .tag.warn{color:var(--warn); border-color: rgba(255,209,102,.35)}
    .tag.bad{color:var(--bad); border-color: rgba(255,107,107,.35)}
    .eq{
      font-family:var(--mono);
      background:rgba(0,0,0,.22);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px;
      overflow:auto;
      position:relative;
      margin:10px 0;
      white-space:pre-wrap;
    }

    .copybar{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:8px;
      flex-wrap:wrap;
    }
    .btn{
      cursor:pointer;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.04);
      color:var(--text);
      border-radius:14px;
      padding:9px 11px;
      font-size:.92rem;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      background:rgba(110,231,255,.08);
      border-color:rgba(110,231,255,.25);
    }
    .btn:active{transform: translateY(0)}
    .btn.secondary:hover{
      background:rgba(167,139,250,.08);
      border-color:rgba(167,139,250,.25);
    }

    .vizwrap{
      display:grid;
      grid-template-columns: 1.08fr .92fr;
      gap:14px;
      margin:10px 0 2px;
    }
    @media (max-width: 980px){
      .vizwrap{grid-template-columns:1fr}
    }

    .panel{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:18px;
      padding:10px;
      overflow:hidden;
      position:relative;
      min-height:220px;
    }
    .panel h3{
      margin:4px 6px 10px;
      font-size:1rem;
      color:var(--muted);
      font-weight:700;
      letter-spacing:.15px;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius:14px;
      background:rgba(0,0,0,.18);
      border:1px solid var(--line);
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin:8px 0 2px;
    }
    @media (max-width: 700px){
      .controls{grid-template-columns:1fr}
      canvas{height:300px}
    }
    .control{
      border:1px solid var(--line);
      background:rgba(0,0,0,.16);
      border-radius:16px;
      padding:10px 10px 8px;
    }
    label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:.92rem;
      color:var(--muted);
      margin-bottom:6px;
    }
    .val{
      font-family:var(--mono);
      color:var(--text);
    }
    input[type="range"]{width:100%}
    select{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:9px 10px;
      outline:none;
    }
    footer{
      max-width:1180px;
      margin:0 auto;
      padding:0 18px 26px;
      color:var(--muted);
      font-size:.92rem;
    }
    .kbd{
      font-family:var(--mono);
      font-size:.88rem;
      padding:2px 6px;
      border:1px solid var(--line2);
      border-bottom-color:rgba(255,255,255,.28);
      border-radius:8px;
      background:rgba(0,0,0,.2);
      color:var(--text);
    }
    @media print{
      body{background:#fff; color:#000}
      nav.toc{display:none}
      article, .hero, .panel, .callout{box-shadow:none}
      canvas{border:1px solid #ccc}
      .btn{display:none}
      .pill{border-color:#ddd}
    }
  </style>
</head>

<body>
<header>
  <div class="hero">
    <h1>9.2-4 — Effect of Cladding: Redo Prob. 9.2-3 with the Film Suspended in Air (n₂ = 1)</h1>
    <p>
      We analyze a <strong>symmetric dielectric slab waveguide</strong> (thin film index <em>n₁</em>) surrounded by a
      <strong>cladding</strong> (index <em>n₂</em>). The question asks you to redo the guided-mode result from Prob. 9.2-3
      when the cladding is <strong>air</strong> (<em>n₂ = 1</em>), and then compare to the earlier cladding.
      Since the exact numeric data from 9.2-3 is not shown here, the solution is given <strong>symbolically</strong>,
      plus clearly labeled <strong>example values</strong> used only for plotting.
    </p>
    <div class="meta-row">
      <div class="pill"><strong>Model:</strong> planar slab waveguide</div>
      <div class="pill"><strong>Case:</strong> symmetric cladding (air–film–air)</div>
      <div class="pill"><strong>Outputs:</strong> dispersion, mode count, confinement trends</div>
    </div>
  </div>
</header>

<main>
  <nav class="toc" aria-label="Table of contents">
    <h2>On this page</h2>
    <div class="small">Sticky mini Table of Contents</div>
    <a href="#qs">Quick Summary</a>
    <a href="#p0">PART 0 — Concept Primer</a>
    <a href="#p1">PART 1 — Problem Analysis</a>
    <a href="#p2">PART 2 — Strategy & Tips</a>
    <a href="#p3">PART 3 — Full Solution</a>
    <a href="#p4">PART 4 — Deeper Understanding</a>
    <a href="#p5">PART 5 — Visualization Guide</a>
    <div class="small">Interactive section</div>
    <a href="#viz">Interactive Diagram & Plots</a>
  </nav>

  <article>
    <div class="content">

      <section id="qs">
        <h2>Quick Summary</h2>
        <ul>
          <li><strong>What this is about:</strong> how the <em>cladding index</em> changes guided modes of a thin-film (slab) waveguide.</li>
          <li><strong>Key idea:</strong> guidance requires <em>n₂ &lt; n<sub>eff</sub> &lt; n₁</em> and total internal reflection in the film; lower <em>n₂</em> increases index contrast and confinement.</li>
          <li><strong>Governing quantity:</strong> the <strong>normalized frequency</strong> (V-number) for a symmetric slab,
            <span class="kbd">V = k₀ a √(n₁² − n₂²)</span>, with half-thickness <span class="kbd">a = t/2</span> and <span class="kbd">k₀ = 2π/λ</span>.</li>
          <li><strong>Dispersion (TE):</strong> even modes satisfy <span class="kbd">u tan u = w</span>, odd modes satisfy <span class="kbd">−u cot u = w</span>, where <span class="kbd">u² + w² = V²</span>.</li>
          <li><strong>Air cladding:</strong> set <span class="kbd">n₂ = 1</span> everywhere → <span class="kbd">V_air = k₀ a √(n₁² − 1)</span>.</li>
          <li><strong>Comparison:</strong> for the same <em>n₁, t, λ</em>, air typically gives <span class="kbd">V_air &gt; V_old</span> (unless the old cladding was also ~1), so you get <strong>more guided modes</strong> and <strong>stronger confinement</strong>.</li>
          <li><strong>Final result type:</strong> symbolic dispersion relations + mode count scaling; plots give numeric examples.</li>
        </ul>
      </section>

      <section id="p0">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <h3>Core definitions (symbols & units)</h3>
        <ul>
          <li><strong>Film (core) refractive index:</strong> <span class="kbd">n₁</span> (dimensionless).</li>
          <li><strong>Cladding refractive index:</strong> <span class="kbd">n₂</span> (dimensionless). Here: <span class="kbd">n₂ = 1</span> (air).</li>
          <li><strong>Free-space wavelength:</strong> <span class="kbd">λ</span> (m), and <strong>vacuum wavenumber</strong> <span class="kbd">k₀ = 2π/λ</span> (rad/m).</li>
          <li><strong>Film thickness:</strong> <span class="kbd">t</span> (m). Often we use <span class="kbd">a = t/2</span> (half-thickness).</li>
          <li><strong>Propagation constant along the guide:</strong> <span class="kbd">β</span> (rad/m).</li>
          <li><strong>Effective index:</strong> <span class="kbd">n_eff = β/k₀</span> (dimensionless).</li>
          <li><strong>Transverse constants:</strong> in the film <span class="kbd">h = √(n₁²k₀² − β²)</span>, in the cladding <span class="kbd">q = √(β² − n₂²k₀²)</span> (both rad/m).</li>
        </ul>

        <h3>Physical meaning (what these quantities represent)</h3>
        <ul>
          <li><span class="kbd">β</span> tells you how fast the phase advances <em>along</em> the waveguide (z direction).</li>
          <li><span class="kbd">n_eff</span> is the “index the mode feels”; it must lie between core and cladding indices for guided modes.</li>
          <li><span class="kbd">q</span> controls the <strong>evanescent decay</strong> into the cladding: larger <span class="kbd">q</span> → tighter confinement.</li>
          <li>The <span class="kbd">V</span>-number measures “how many transverse half-wavelengths fit” inside the core; larger <span class="kbd">V</span> → more modes.</li>
        </ul>

        <div class="callout">
          <div class="tag good">Key law</div>
          <p>
            Guided modes in a dielectric slab come from solving <strong>Maxwell’s equations</strong> with boundary
            conditions at the interfaces. The result is a <strong>transcendental dispersion relation</strong>
            (not a simple polynomial).
          </p>
        </div>

        <h3>Key principles & validity (assumptions/conditions)</h3>
        <ul>
          <li><strong>Linear, isotropic, lossless dielectrics</strong> (real indices).</li>
          <li><strong>Planar geometry:</strong> infinite in y and z; index varies only with x.</li>
          <li><strong>Time-harmonic fields</strong> <span class="kbd">∝ e^{i(βz − ωt)}</span>.</li>
          <li><strong>Symmetric slab</strong> (same cladding above and below): air–film–air.</li>
        </ul>

        <h3>Common models/approximations (and why we use them)</h3>
        <ul>
          <li><strong>Normalized variables</strong> (<span class="kbd">u, w, V</span>) simplify the algebra and reveal scaling with thickness and index contrast.</li>
          <li><strong>Mode count estimate</strong> uses the fact that each mode occupies roughly <span class="kbd">~π</span> of phase in <span class="kbd">u</span>-space.</li>
          <li><strong>TE vs TM</strong>: TE modes have electric field transverse to the plane of incidence; TM differs by boundary-condition weighting. (We derive TE in detail and state TM form.)</li>
        </ul>

        <h3>Mini intuition examples (quick, conceptual)</h3>
        <ul>
          <li>If you lower the cladding index (e.g., from glass to air), total internal reflection becomes “easier,” and the field leaks less—so <strong>confinement improves</strong>.</li>
          <li>If you make the film thicker, more standing-wave patterns fit in x, so you get <strong>more guided modes</strong>.</li>
        </ul>

        <h3>What to watch for (pitfalls)</h3>
        <ul>
          <li>Confusing thickness <span class="kbd">t</span> with half-thickness <span class="kbd">a=t/2</span> in the V-number.</li>
          <li>For guided modes you must have <span class="kbd">n₂ &lt; n_eff &lt; n₁</span>. If <span class="kbd">n_eff ≤ n₂</span>, the mode radiates.</li>
          <li>Even/odd mode conditions use <span class="kbd">tan</span> vs <span class="kbd">cot</span>; mixing them shifts mode indexing.</li>
          <li>TM dispersion differs (an extra factor involving <span class="kbd">n₁²/n₂²</span>); don’t reuse TE equations blindly for TM.</li>
        </ul>
      </section>

      <section id="p1">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <h3>Restate the problem</h3>
        <p>
          Redo the result of Prob. 9.2-3 for a thin dielectric film waveguide, but now the film is
          <strong>suspended in air</strong>, meaning the cladding refractive index is <strong><span class="kbd">n₂ = 1</span></strong>.
          Then compare the air-cladded result to the earlier cladding case.
        </p>

        <div class="grid2">
          <div class="callout">
            <div class="tag">Given</div>
            <ul>
              <li>Film index <span class="kbd">n₁</span></li>
              <li>Film thickness <span class="kbd">t</span> (or half-thickness <span class="kbd">a=t/2</span>)</li>
              <li>Wavelength <span class="kbd">λ</span></li>
              <li>New cladding index: <span class="kbd">n₂ = 1</span></li>
            </ul>
          </div>
          <div class="callout">
            <div class="tag">Unknowns / what to find</div>
            <ul>
              <li>Guided-mode dispersion relation with <span class="kbd">n₂=1</span></li>
              <li>How many modes exist (scaling with <span class="kbd">t, λ, n₁</span>)</li>
              <li>Qualitative and quantitative comparison to the old cladding (index <span class="kbd">n₂,old</span>)</li>
            </ul>
          </div>
        </div>

        <h3>Relevant principles (and why)</h3>
        <ul>
          <li><strong>Maxwell + boundary conditions:</strong> slab modes are eigenmodes determined by continuity of tangential <span class="kbd">E</span> and <span class="kbd">H</span> at interfaces.</li>
          <li><strong>Total internal reflection &amp; evanescence:</strong> guidance requires oscillatory fields in the film and exponentially decaying fields in the cladding, i.e., real <span class="kbd">h</span> and real <span class="kbd">q</span>.</li>
          <li><strong>Why not geometrical optics only:</strong> ray bounces give intuition, but the exact condition is wave interference + boundary phases → transcendental equation.</li>
        </ul>

        <div class="callout">
          <div class="tag warn">Assumptions</div>
          <ul>
            <li>Lossless dielectrics (indices are real; no absorption).</li>
            <li>Symmetric cladding: air on both sides (no substrate asymmetry).</li>
            <li>Uniform film index; sharp planar interfaces.</li>
            <li>We treat <strong>TE modes</strong> explicitly; TM noted for comparison.</li>
          </ul>
        </div>

        <h3>Possible approaches (compare briefly)</h3>
        <ol>
          <li><strong>Full waveguide eigenmode derivation (best):</strong> yields exact dispersion <span class="kbd">u tan u = w</span>, etc. <em>Pros:</em> correct and general. <em>Cons:</em> transcendental solving.</li>
          <li><strong>Ray/phase condition approximation:</strong> bounce angle + phase shift gives a near-equivalent condition. <em>Pros:</em> intuition. <em>Cons:</em> must handle phase shifts carefully.</li>
          <li><strong>Normalized-frequency scaling + mode count estimate:</strong> quick comparison of “how many modes change” when <span class="kbd">n₂</span> changes. <em>Pros:</em> fast comparison. <em>Cons:</em> not the exact <span class="kbd">n_eff</span> values.</li>
        </ol>
        <p>
          <strong>We choose Approach 1</strong> (exact symmetric-slab dispersion) and use Approach 3 to make the comparison
          clean and transparent.
        </p>
      </section>

      <section id="p2">
        <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

        <ol>
          <li>
            <strong>Set up the geometry</strong> (film thickness <span class="kbd">t</span>, half-thickness <span class="kbd">a=t/2</span>).
            <br><span class="muted">Tool:</span> coordinate definition and region indices.
            <br><span class="muted">Meaning:</span> fixes where fields oscillate vs decay.
          </li>
          <li>
            <strong>Write the TE wave equation</strong> in each region for a mode <span class="kbd">∝ e^{iβz}</span>.
            <br><span class="muted">Tool:</span> Helmholtz equation.
            <br><span class="muted">Meaning:</span> gives <span class="kbd">h</span> (core) and <span class="kbd">q</span> (cladding).
          </li>
          <li>
            <strong>Impose guided-mode conditions</strong> (<span class="kbd">h</span> and <span class="kbd">q</span> real).
            <br><span class="muted">Tool:</span> inequalities on <span class="kbd">β</span>.
            <br><span class="muted">Meaning:</span> ensures confinement.
          </li>
          <li>
            <strong>Apply boundary conditions</strong> at <span class="kbd">x=±a</span>.
            <br><span class="muted">Tool:</span> continuity of tangential <span class="kbd">E</span> and <span class="kbd">H</span>.
            <br><span class="muted">Meaning:</span> quantizes the allowed <span class="kbd">β</span>.
          </li>
          <li>
            <strong>Convert to normalized variables</strong> <span class="kbd">u=ha</span>, <span class="kbd">w=qa</span>, <span class="kbd">V=k₀a√(n₁²−n₂²)</span>.
            <br><span class="muted">Tool:</span> nondimensionalization.
            <br><span class="muted">Meaning:</span> exposes how thickness/index contrast control modes.
          </li>
          <li>
            <strong>Insert air cladding</strong> by setting <span class="kbd">n₂=1</span>.
            <br><span class="muted">Tool:</span> substitution.
            <br><span class="muted">Meaning:</span> increases <span class="kbd">V</span> relative to typical higher-index claddings.
          </li>
          <li>
            <strong>Compare to old cladding</strong> via the ratio of V-numbers and mode count scaling.
            <br><span class="muted">Tool:</span> <span class="kbd">V</span> and approximate mode count <span class="kbd">M ≈ ⌊V/π⌋ + 1</span>.
            <br><span class="muted">Meaning:</span> predicts more modes and tighter confinement in air.
          </li>
          <li>
            <strong>Sanity checks</strong>: limits <span class="kbd">t→0</span>, <span class="kbd">n₂→n₁</span>, units, and ordering <span class="kbd">n₂ &lt; n_eff &lt; n₁</span>.
          </li>
        </ol>

        <div class="callout">
          <div class="tag bad">Common mistakes</div>
          <ul>
            <li>Using <span class="kbd">t</span> where the standard formulas use <span class="kbd">a=t/2</span>.</li>
            <li>Counting “modes” without checking the guided condition <span class="kbd">n_eff &gt; n₂</span>.</li>
            <li>Comparing two cases at different <span class="kbd">λ</span> or <span class="kbd">t</span> and attributing changes to the cladding.</li>
          </ul>
        </div>
      </section>

      <section id="p3">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Physical intuition (before math)</h3>
        <p>
          Lowering the cladding index from some <span class="kbd">n₂,old</span> to air (<span class="kbd">n₂=1</span>) increases
          the index contrast <span class="kbd">Δn</span> and increases the critical angle margin for total internal reflection.
          That should (i) increase the number of guided modes for a given thickness and wavelength, and (ii) reduce
          the evanescent penetration depth into the cladding (tighter confinement).
        </p>

        <h3>Step 1: Geometry and fields</h3>
        <p>
          Consider a symmetric slab (film) of refractive index <span class="kbd">n₁</span> occupying
          <span class="kbd">|x| ≤ a</span> with <span class="kbd">a=t/2</span>, surrounded by cladding of index <span class="kbd">n₂</span>
          for <span class="kbd">|x| &gt; a</span>. Propagation is along <span class="kbd">z</span>.
        </p>

        <div class="callout">
          <div class="tag good">Guided-mode condition</div>
          <div class="eq" id="eq-guided">n₂ k₀ &lt; β &lt; n₁ k₀  ⇔  n₂ &lt; n_eff &lt; n₁</div>
          <div class="copybar">
            <div class="muted">Copy this inequality (plain text).</div>
            <button class="btn" data-copy="#eq-guided">Copy</button>
          </div>
        </div>

        <h3>Step 2: Define transverse propagation constants</h3>
        <p>
          For TE modes (electric field polarized along <span class="kbd">y</span>), the scalar field component
          <span class="kbd">E_y(x)</span> satisfies a 1D Helmholtz equation in each region.
          Define:
        </p>
        <div class="eq" id="eq-hq">h = √(n₁² k₀² − β²),   q = √(β² − n₂² k₀²)</div>
        <div class="copybar">
          <div class="muted">Copy definitions of h and q.</div>
          <button class="btn" data-copy="#eq-hq">Copy</button>
        </div>

        <p class="muted">
          Explanation: In the film, <span class="kbd">β &lt; n₁ k₀</span> so <span class="kbd">h</span> is real and the field oscillates.
          In the cladding, <span class="kbd">β &gt; n₂ k₀</span> so <span class="kbd">q</span> is real and the field decays exponentially.
        </p>

        <h3>Step 3: Apply boundary conditions (symmetric slab)</h3>
        <p>
          Because the structure is symmetric, TE modes separate into:
          <strong>even</strong> (cos-like in the core) and <strong>odd</strong> (sin-like in the core).
          Enforcing continuity of tangential <span class="kbd">E_y</span> and <span class="kbd">H_z</span> at <span class="kbd">x=±a</span>
          yields the classic TE dispersion:
        </p>

        <div class="callout">
          <div class="tag good">TE dispersion relations</div>
          <div class="eq" id="eq-te">
Even (TE₀, TE₂, ...):   h tan(h a) = q
Odd  (TE₁, TE₃, ...):  −h cot(h a) = q
          </div>
          <div class="copybar">
            <div class="muted">Copy TE dispersion (plain text).</div>
            <button class="btn" data-copy="#eq-te">Copy</button>
          </div>
        </div>

        <p class="muted">
          What we did and why: the boundary conditions force the oscillatory core field to “match” an exponentially decaying
          tail. Only certain <span class="kbd">β</span> values make that match possible.
        </p>

        <h3>Step 4: Normalize (u, w, V) to make the scaling obvious</h3>
        <p>
          Define the dimensionless quantities:
        </p>
        <div class="eq" id="eq-uvw">
u = h a,   w = q a,   V = k₀ a √(n₁² − n₂²)
and they satisfy:  u² + w² = V²
        </div>
        <div class="copybar">
          <div class="muted">Copy normalized variables.</div>
          <button class="btn" data-copy="#eq-uvw">Copy</button>
        </div>

        <p class="muted">
          Physical meaning: <span class="kbd">V</span> is the “strength” of the waveguide. Increasing <span class="kbd">t</span> (hence <span class="kbd">a</span>)
          or increasing contrast <span class="kbd">√(n₁²−n₂²)</span> increases <span class="kbd">V</span>.
        </p>

        <h3>Step 5: Insert the new condition — air cladding (n₂ = 1)</h3>
        <p>
          For Prob. 9.2-4, the film is suspended in air, so:
        </p>

        <div class="callout">
          <div class="tag good">Air-cladded slab</div>
          <div class="eq" id="eq-air">
n₂ = 1  ⇒  V_air = k₀ a √(n₁² − 1) = (2π/λ)(t/2) √(n₁² − 1)
TE even: u tan u = √(V_air² − u²)
TE odd : −u cot u = √(V_air² − u²)
n_eff = β/k₀ with 1 &lt; n_eff &lt; n₁
          </div>
          <div class="copybar">
            <div class="muted">Copy the air-cladded final formulas.</div>
            <button class="btn secondary" data-copy="#eq-air">Copy</button>
          </div>
        </div>

        <p class="muted">
          Explanation: we changed only one ingredient—<span class="kbd">n₂</span>—but because it sits inside <span class="kbd">V</span> and inside
          the guided condition <span class="kbd">n₂ &lt; n_eff</span>, the entire dispersion and mode inventory shift.
        </p>

        <h3>Step 6: Compare to the previous cladding</h3>
        <p>
          Let the old cladding index in Prob. 9.2-3 be <span class="kbd">n₂,old</span>. Then the ratio of normalized frequencies is:
        </p>

        <div class="eq" id="eq-compareV">V_air / V_old = √( (n₁² − 1) / (n₁² − n₂,old²) )</div>
        <div class="copybar">
          <div class="muted">Copy the V-number comparison ratio.</div>
          <button class="btn" data-copy="#eq-compareV">Copy</button>
        </div>

        <p>
          If the old cladding had <span class="kbd">n₂,old &gt; 1</span> (typical), then <span class="kbd">n₁² − 1 &gt; n₁² − n₂,old²</span>,
          so <span class="kbd">V_air &gt; V_old</span>. That means:
        </p>
        <ul>
          <li><strong>More guided modes</strong> can exist in air for the same <span class="kbd">t</span> and <span class="kbd">λ</span>.</li>
          <li><strong>Each mode is more confined</strong> (larger decay constant <span class="kbd">q</span>, smaller penetration depth <span class="kbd">1/q</span>).</li>
        </ul>

        <h3>Mode-count estimate (useful for comparison)</h3>
        <p>
          For a symmetric slab, the approximate number of guided TE modes is:
        </p>
        <div class="eq" id="eq-modecount">M_TE ≈ ⌊ V/π ⌋ + 1   (for V &gt; 0)</div>
        <div class="copybar">
          <div class="muted">Copy the mode-count estimate.</div>
          <button class="btn" data-copy="#eq-modecount">Copy</button>
        </div>

        <p class="muted">
          Sanity: if <span class="kbd">V &lt; π</span>, only the fundamental (<span class="kbd">TE₀</span>) exists; as <span class="kbd">V</span> grows past
          <span class="kbd">π</span>, higher-order modes appear.
        </p>

        <div class="callout">
          <div class="tag good">Final answer (boxed)</div>
          <div class="eq" id="final-answer">
Air cladding (n₂ = 1):
V_air = (2π/λ)(t/2) √(n₁² − 1)

TE dispersion (symmetric slab):
Even modes: u tan u = √(V_air² − u²)
Odd  modes: −u cot u = √(V_air² − u²)
with 0 &lt; u &lt; V_air, and n_eff satisfies 1 &lt; n_eff &lt; n₁ via:
n_eff = √( 1 + b (n₁² − 1) ),   where b = (w² / V_air²) = 1 − (u² / V_air²)

Comparison to old cladding n₂,old:
V_air / V_old = √( (n₁² − 1) / (n₁² − n₂,old²) )
⇒ typically V_air &gt; V_old → more modes and stronger confinement in air.
          </div>
          <div class="copybar">
            <div class="muted">Copy the final answer (plain text).</div>
            <button class="btn secondary" data-copy="#final-answer">Copy</button>
          </div>
        </div>

        <h3>Sanity checks</h3>
        <ul>
          <li><strong>Units:</strong> <span class="kbd">k₀</span> is 1/m, <span class="kbd">a</span> is m, so <span class="kbd">V</span> is dimensionless (good).</li>
          <li><strong>Limit t → 0:</strong> <span class="kbd">V → 0</span>, so no guided modes (or only vanishingly weak guidance) — physically reasonable.</li>
          <li><strong>Limit n₂ → n₁:</strong> <span class="kbd">V → 0</span>, guidance disappears — correct.</li>
          <li><strong>Ordering:</strong> computed modes always satisfy <span class="kbd">n₂ &lt; n_eff &lt; n₁</span> (guided) — required.</li>
        </ul>

        <p class="muted">
          Connection to the diagram & plots: the diagram shows the film and evanescent tails. The plots show how changing
          <span class="kbd">t</span>, <span class="kbd">λ</span>, and especially <span class="kbd">n₂</span> changes <span class="kbd">V</span>,
          the number of guided modes, and their effective indices.
        </p>
      </section>

      <section id="p4">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpreting the final formulas</h3>
        <ul>
          <li><span class="kbd">V = (2π/λ)(t/2) √(n₁² − n₂²)</span> says guidance strengthens when the film is thicker, wavelength is shorter, or the index contrast is larger.</li>
          <li>Lowering <span class="kbd">n₂</span> increases <span class="kbd">√(n₁² − n₂²)</span>, so <span class="kbd">V</span> rises and more solutions of the dispersion equations exist.</li>
          <li>The decay constant <span class="kbd">q</span> grows as <span class="kbd">β</span> moves farther above <span class="kbd">n₂k₀</span>; with air cladding, the same <span class="kbd">β</span> is typically “farther above” the cladding light line → tighter decay.</li>
        </ul>

        <h3>How changing parameters affects outcomes (link to plots)</h3>
        <ul>
          <li><strong>Increase thickness t:</strong> increases <span class="kbd">V</span> linearly → more modes; <span class="kbd">n_eff</span> of each mode tends upward toward <span class="kbd">n₁</span>.</li>
          <li><strong>Increase wavelength λ:</strong> decreases <span class="kbd">V</span> → modes cut off; <span class="kbd">n_eff</span> drops toward <span class="kbd">n₂</span>.</li>
          <li><strong>Change cladding from old to air:</strong> increases <span class="kbd">V</span> and shifts <span class="kbd">n_eff</span> upward; mode count increases and confinement improves.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p>
          A near-equivalent viewpoint uses a <strong>ray bounce</strong> picture: a plane wave in the core reflects
          at the boundaries with a phase shift; requiring constructive interference after a round trip gives a
          quantization condition. That method reproduces the transcendental equations when the reflection phase
          is treated correctly (Fresnel phase for TE/TM).
        </p>

        <h3>Concept checks (quick self-test)</h3>
        <ul>
          <li><strong>Q:</strong> Why must <span class="kbd">n_eff &gt; n₂</span> for a guided mode? <strong>A:</strong> Otherwise the field in the cladding is propagating (radiative) rather than evanescent (decaying).</li>
          <li><strong>Q:</strong> If you suspend the film in air, does the fundamental mode always exist? <strong>A:</strong> For an ideal symmetric slab with any positive contrast (<span class="kbd">n₁&gt;n₂</span>), the fundamental TE mode exists for arbitrarily small <span class="kbd">V</span>, though it becomes weakly confined as <span class="kbd">V→0</span>.</li>
          <li><strong>Q:</strong> What happens to mode count when <span class="kbd">λ</span> doubles? <strong>A:</strong> <span class="kbd">V</span> halves, so fewer modes fit; higher-order modes may cut off.</li>
          <li><strong>Q:</strong> Why does lowering <span class="kbd">n₂</span> increase confinement? <strong>A:</strong> The cladding light line <span class="kbd">β=n₂k₀</span> moves down, increasing <span class="kbd">q=√(β²−n₂²k₀²)</span> for guided modes.</li>
        </ul>
      </section>

      <section id="viz">
        <h2>Interactive Diagram & Plots</h2>

        <div class="controls" aria-label="interactive controls">
          <div class="control">
            <label for="tSlider">
              Film thickness <span class="kbd">t</span> (µm)
              <span class="val" id="tVal"></span>
            </label>
            <input id="tSlider" type="range" min="0.10" max="5.00" step="0.01" value="1.00"/>
          </div>

          <div class="control">
            <label for="lambdaSlider">
              Wavelength <span class="kbd">λ</span> (µm)
              <span class="val" id="lambdaVal"></span>
            </label>
            <input id="lambdaSlider" type="range" min="0.40" max="1.80" step="0.01" value="1.00"/>
          </div>

          <div class="control">
            <label for="n1Slider">
              Film index <span class="kbd">n₁</span>
              <span class="val" id="n1Val"></span>
            </label>
            <input id="n1Slider" type="range" min="1.20" max="2.20" step="0.01" value="1.50"/>
          </div>

          <div class="control">
            <label for="cladSelect">
              Compare claddings
              <span class="val" id="cladVal"></span>
            </label>
            <select id="cladSelect">
              <option value="air_vs_example">Air (n₂=1) vs Example old (n₂,old=1.45)</option>
              <option value="air_only">Air only (n₂=1)</option>
              <option value="air_vs_water">Air (n₂=1) vs Water (n₂,old=1.33)</option>
            </select>
            <p class="muted" style="margin:8px 2px 0;font-size:.9rem">
              Note: the “old cladding” is not provided in the prompt image; we use typical example values for comparison plots.
            </p>
          </div>
        </div>

        <div class="vizwrap">
          <div class="panel">
            <h3>Diagram: Symmetric slab waveguide (air–film–air)</h3>
            <canvas id="cDiagram" aria-label="waveguide diagram"></canvas>
          </div>
          <div class="panel">
            <h3>Main plot: Effective indices n<sub>eff</sub> of guided TE modes vs thickness t</h3>
            <canvas id="cMain" aria-label="main plot"></canvas>
          </div>
        </div>

        <div class="vizwrap">
          <div class="panel">
            <h3>Secondary plot: Mode count M<sub>TE</sub> vs thickness t</h3>
            <canvas id="cSecondary" aria-label="secondary plot"></canvas>
          </div>
          <div class="panel">
            <h3>Computed values at the current slider settings</h3>
            <div class="callout" style="margin:10px">
              <div class="tag">Live readout</div>
              <div class="eq" id="liveOut" style="margin:10px 0 0"></div>
            </div>
            <div class="callout" style="margin:10px">
              <div class="tag warn">How the solver works</div>
              <p class="muted" style="margin:8px 0 0">
                For each thickness in the sweep, we compute <span class="kbd">V</span> and then locate roots of the TE
                dispersion in the allowed <span class="kbd">u</span>-intervals using bisection. This yields
                <span class="kbd">u</span>, then <span class="kbd">w=√(V²−u²)</span>, then
                <span class="kbd">b=(w/V)²</span>, and finally <span class="kbd">n_eff</span>.
              </p>
            </div>
          </div>
        </div>
      </section>

      <section id="p5">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <h3>What each canvas shows</h3>
        <ul>
          <li><strong>Diagram canvas:</strong> the film (index <span class="kbd">n₁</span>, thickness <span class="kbd">t</span>) between two air regions (index <span class="kbd">n₂=1</span>), with a sketched guided ray and evanescent tails.</li>
          <li><strong>Main plot:</strong> for a thickness sweep, it plots the first few TE-mode effective indices <span class="kbd">n_eff</span> as curves versus <span class="kbd">t</span>. You can compare air to an “old cladding” example when selected.</li>
          <li><strong>Secondary plot:</strong> mode count estimate (and the solver-based count) versus <span class="kbd">t</span>, showing how air cladding typically supports more modes at the same thickness.</li>
        </ul>

        <h3>Interactive controls</h3>
        <ul>
          <li><strong>Thickness t slider:</strong> changes the current operating point (vertical marker) and the computed live readout; it also changes <span class="kbd">V</span> linearly.</li>
          <li><strong>Wavelength λ slider:</strong> changes <span class="kbd">k₀</span> and therefore <span class="kbd">V</span> inversely; longer λ reduces guidance.</li>
          <li><strong>Film index n₁ slider:</strong> changes contrast; higher n₁ raises <span class="kbd">V</span> and lifts <span class="kbd">n_eff</span>.</li>
          <li><strong>Compare claddings select:</strong> overlays air (n₂=1) with a typical “old” cladding value to visualize the requested comparison.</li>
        </ul>

        <div class="callout">
          <div class="tag good">What you should see (and why)</div>
          <ul>
            <li>Switching to air cladding increases <span class="kbd">V</span> → additional mode curves appear and existing curves shift upward.</li>
            <li>At fixed t, air gives larger separation from the cladding light line (<span class="kbd">n_eff − n₂</span>) → stronger confinement.</li>
          </ul>
        </div>
      </section>

    </div>
  </article>
</main>

<footer>
  <p>
    Tip: Use the copy buttons to grab equations for your notes. In the plots, the <span class="kbd">air</span> case always uses
    <span class="kbd">n₂=1</span>. Any “old cladding” value is explicitly labeled as an example because the original 9.2-3 numeric
    cladding value is not included in the prompt image.
  </p>
</footer>

<script>
/* ------------------------ Copy buttons ------------------------ */
function copyTextFromSelector(sel){
  const el = document.querySelector(sel);
  if(!el) return;
  const text = el.innerText.replace(/\u00A0/g,' ').trim();
  navigator.clipboard.writeText(text).then(()=>{
    // tiny, non-intrusive feedback
    const btns = document.querySelectorAll(`[data-copy="${sel}"]`);
    btns.forEach(b=>{
      const old = b.textContent;
      b.textContent = "Copied!";
      setTimeout(()=>b.textContent = old, 850);
    });
  });
}
document.addEventListener('click', (e)=>{
  const b = e.target.closest('[data-copy]');
  if(!b) return;
  copyTextFromSelector(b.getAttribute('data-copy'));
});

/* ------------------------ Math helpers ------------------------ */
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function linspace(a,b,n){
  const arr = new Array(n);
  const step=(b-a)/(n-1);
  for(let i=0;i<n;i++) arr[i]=a+i*step;
  return arr;
}

/* ------------------------ TE slab solver (symmetric) ------------------------
   Given n1, n2, lambda, thickness t:
   a=t/2, k0=2π/λ
   V = k0*a*sqrt(n1^2-n2^2)
   Find roots in u of:
     even: f(u) = u tan u - sqrt(V^2 - u^2) = 0, with u in (mπ, mπ+π/2)
     odd : g(u) = -u cot u - sqrt(V^2 - u^2) = 0, with u in (mπ+π/2, (m+1)π)
   For each root u: w=sqrt(V^2-u^2), b=(w/V)^2, n_eff=sqrt(n2^2 + b*(n1^2-n2^2)).
-------------------------------------------------------------------------- */
function bisectionRoot(fn, x1, x2, maxIter=80){
  let f1 = fn(x1), f2 = fn(x2);
  if(!isFinite(f1) || !isFinite(f2)) return null;
  if(f1===0) return x1;
  if(f2===0) return x2;
  if(f1*f2>0) return null;
  let a=x1,b=x2,fa=f1,fb=f2;
  for(let i=0;i<maxIter;i++){
    const m=(a+b)/2;
    const fm=fn(m);
    if(!isFinite(fm)) { // shrink away from singularities
      const eps = (b-a)*1e-6;
      return bisectionRoot(fn, a+eps, b-eps, maxIter);
    }
    if(Math.abs(fm) < 1e-10) return m;
    if(fa*fm<=0){ b=m; fb=fm; } else { a=m; fa=fm; }
  }
  return (a+b)/2;
}

function solveTEModes(n1,n2,lambda_um,t_um,maxModes=6){
  const lambda = lambda_um*1e-6;
  const t = t_um*1e-6;
  const a = t/2;
  const k0 = 2*Math.PI/lambda;
  const disc = n1*n1 - n2*n2;
  if(disc<=0) return {V:0, modes:[]};
  const V = k0*a*Math.sqrt(disc);

  if(V<=0) return {V, modes:[]};

  function wOf(u){
    const val = V*V - u*u;
    return val>0 ? Math.sqrt(val) : 0;
  }
  function fEven(u){
    // avoid tan singularities; caller ensures interval away from poles
    return u*Math.tan(u) - wOf(u);
  }
  function fOdd(u){
    // -u cot u = -u*(cos/sin) = -u / tan(u)
    return (-u/Math.tan(u)) - wOf(u);
  }

  const modes = [];
  const pi = Math.PI;

  // Scan intervals; stop when u interval starts beyond V.
  let m=0;
  while(modes.length < maxModes){
    const leftEven = m*pi + 1e-6;
    const rightEven = m*pi + pi/2 - 1e-6;
    if(leftEven >= V) break;
    const re = Math.min(rightEven, V-1e-7);
    if(re > leftEven){
      const r = bisectionRoot(fEven, leftEven, re);
      if(r!==null && r>0 && r<V){
        const w = wOf(r);
        const b = (V>0) ? (w*w)/(V*V) : 0;
        const neff = Math.sqrt(n2*n2 + b*(n1*n1 - n2*n2));
        modes.push({m: modes.length, parity:"even", u:r, w:w, b:b, neff:neff});
      }
    }

    // odd interval
    const leftOdd = m*pi + pi/2 + 1e-6;
    const rightOdd = (m+1)*pi - 1e-6;
    if(leftOdd >= V) { m++; continue; }
    const ro = Math.min(rightOdd, V-1e-7);
    if(ro > leftOdd){
      const r2 = bisectionRoot(fOdd, leftOdd, ro);
      if(r2!==null && r2>0 && r2<V){
        const w = wOf(r2);
        const b = (V>0) ? (w*w)/(V*V) : 0;
        const neff = Math.sqrt(n2*n2 + b*(n1*n1 - n2*n2));
        modes.push({m: modes.length, parity:"odd", u:r2, w:w, b:b, neff:neff});
      }
    }
    m++;
    // In practice for small V only the first exists; this loop ends quickly.
    if(m>60) break;
  }

  return {V, modes};
}

function modeCountEstimate(V){
  if(V<=0) return 0;
  return Math.floor(V/Math.PI) + 1;
}

/* ------------------------ Plotting (canvas) ------------------------ */
function setupCanvas(canvas){
  const ctx = canvas.getContext('2d');
  function resize(){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    canvas.width = Math.max(2, Math.floor(rect.width * dpr));
    canvas.height = Math.max(2, Math.floor(rect.height * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
    return {w: rect.width, h: rect.height, dpr};
  }
  return {ctx, resize};
}

function drawAxes(ctx, box, xMin,xMax,yMin,yMax, opts){
  const {x,y,w,h} = box;
  ctx.save();
  ctx.translate(x,y);

  // background
  ctx.fillStyle = "rgba(0,0,0,0.10)";
  ctx.fillRect(0,0,w,h);

  // grid
  const gridColor = "rgba(255,255,255,0.08)";
  const axisColor = "rgba(255,255,255,0.18)";
  const textColor = "rgba(233,238,247,0.85)";
  ctx.strokeStyle = gridColor;
  ctx.lineWidth = 1;

  const nx = 6, ny = 5;
  for(let i=0;i<=nx;i++){
    const xx = (i/nx)*w;
    ctx.beginPath(); ctx.moveTo(xx,0); ctx.lineTo(xx,h); ctx.stroke();
  }
  for(let j=0;j<=ny;j++){
    const yy = (j/ny)*h;
    ctx.beginPath(); ctx.moveTo(0,yy); ctx.lineTo(w,yy); ctx.stroke();
  }

  // axes border
  ctx.strokeStyle = axisColor;
  ctx.strokeRect(0,0,w,h);

  // ticks + labels
  ctx.fillStyle = textColor;
  ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="center";
  ctx.textBaseline="top";

  for(let i=0;i<=nx;i++){
    const xx = (i/nx)*w;
    const val = xMin + (i/nx)*(xMax-xMin);
    ctx.fillText((opts.xTickFmt?opts.xTickFmt(val):val.toFixed(2)), xx, h+6);
  }

  ctx.textAlign="right";
  ctx.textBaseline="middle";
  for(let j=0;j<=ny;j++){
    const yy = h - (j/ny)*h;
    const val = yMin + (j/ny)*(yMax-yMin);
    ctx.fillText((opts.yTickFmt?opts.yTickFmt(val):val.toFixed(2)), -6, yy);
  }

  // axis labels
  ctx.fillStyle = "rgba(233,238,247,0.9)";
  ctx.font = "13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="center";
  ctx.textBaseline="bottom";
  ctx.fillText(opts.xLabel || "", w/2, h + 34);

  ctx.save();
  ctx.translate(-44, h/2);
  ctx.rotate(-Math.PI/2);
  ctx.textAlign="center";
  ctx.textBaseline="top";
  ctx.fillText(opts.yLabel || "", 0, 0);
  ctx.restore();

  // title
  if(opts.title){
    ctx.fillStyle = "rgba(233,238,247,0.92)";
    ctx.font = "14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.textAlign="left";
    ctx.textBaseline="top";
    ctx.fillText(opts.title, 6, 6);
  }

  ctx.restore();
}

function xyToPix(box, xMin,xMax,yMin,yMax, xv,yv){
  const px = box.x + (xv - xMin)/(xMax-xMin)*box.w;
  const py = box.y + box.h - (yv - yMin)/(yMax-yMin)*box.h;
  return {px,py};
}

function drawLine(ctx, box, xMin,xMax,yMin,yMax, xs, ys, strokeStyle, lineWidth=2){
  ctx.save();
  ctx.strokeStyle = strokeStyle;
  ctx.lineWidth = lineWidth;
  ctx.beginPath();
  for(let i=0;i<xs.length;i++){
    const {px,py} = xyToPix(box,xMin,xMax,yMin,yMax,xs[i],ys[i]);
    if(i===0) ctx.moveTo(px,py);
    else ctx.lineTo(px,py);
  }
  ctx.stroke();
  ctx.restore();
}

function drawMarkerVline(ctx, box, xMin,xMax, xVal, style){
  const x = box.x + (xVal - xMin)/(xMax-xMin)*box.w;
  ctx.save();
  ctx.strokeStyle = style || "rgba(110,231,255,0.9)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x, box.y);
  ctx.lineTo(x, box.y + box.h);
  ctx.stroke();
  ctx.restore();
}

function drawLegend(ctx, box, items){
  ctx.save();
  const pad=8;
  const x0 = box.x + pad;
  const y0 = box.y + box.h - 10 - items.length*18;
  ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="left";
  ctx.textBaseline="middle";
  for(let i=0;i<items.length;i++){
    const y = y0 + i*18;
    ctx.strokeStyle = items[i].color;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x0, y);
    ctx.lineTo(x0+22, y);
    ctx.stroke();
    ctx.fillStyle = "rgba(233,238,247,0.88)";
    ctx.fillText(items[i].label, x0+30, y);
  }
  ctx.restore();
}

/* ------------------------ Diagram ------------------------ */
function drawDiagram(ctx, W, H, params){
  ctx.clearRect(0,0,W,H);

  const pad=18;
  const x0=pad, y0=pad, w=W-2*pad, h=H-2*pad;

  // region boundaries
  const filmH = h*0.34;
  const filmY = y0 + (h-filmH)/2;

  // background grid faint
  ctx.save();
  ctx.strokeStyle="rgba(255,255,255,0.06)";
  ctx.lineWidth=1;
  const gx=8, gy=6;
  for(let i=0;i<=gx;i++){
    const x=x0+(i/gx)*w;
    ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y0+h); ctx.stroke();
  }
  for(let j=0;j<=gy;j++){
    const y=y0+(j/gy)*h;
    ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x0+w,y); ctx.stroke();
  }
  ctx.restore();

  // claddings
  ctx.save();
  ctx.fillStyle="rgba(110,231,255,0.08)";
  ctx.fillRect(x0, y0, w, filmY-y0);
  ctx.fillRect(x0, filmY+filmH, w, (y0+h)-(filmY+filmH));
  ctx.restore();

  // film
  ctx.save();
  ctx.fillStyle="rgba(167,139,250,0.14)";
  ctx.strokeStyle="rgba(255,255,255,0.18)";
  ctx.lineWidth=1.5;
  roundRect(ctx, x0+8, filmY, w-16, filmH, 14, true, true);
  ctx.restore();

  // labels
  ctx.save();
  ctx.fillStyle="rgba(233,238,247,0.9)";
  ctx.font="13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="left";
  ctx.textBaseline="top";
  ctx.fillText(`Upper cladding: n₂ = 1 (air)`, x0+14, y0+10);
  ctx.fillText(`Film (core): n₁ = ${params.n1.toFixed(2)}`, x0+14, filmY+8);
  ctx.fillText(`Lower cladding: n₂ = 1 (air)`, x0+14, filmY+filmH+10);
  ctx.restore();

  // thickness bracket
  ctx.save();
  const bx = x0 + w - 34;
  ctx.strokeStyle="rgba(255,255,255,0.55)";
  ctx.lineWidth=1.5;
  ctx.beginPath();
  ctx.moveTo(bx, filmY);
  ctx.lineTo(bx+10, filmY);
  ctx.moveTo(bx, filmY+filmH);
  ctx.lineTo(bx+10, filmY+filmH);
  ctx.moveTo(bx+5, filmY);
  ctx.lineTo(bx+5, filmY+filmH);
  ctx.stroke();

  ctx.fillStyle="rgba(233,238,247,0.9)";
  ctx.font="12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="right";
  ctx.textBaseline="middle";
  ctx.fillText(`t = ${params.t.toFixed(2)} µm`, bx-6, filmY+filmH/2);
  ctx.restore();

  // propagation arrow
  ctx.save();
  const ax = x0 + w*0.18;
  const ay = filmY + filmH*0.55;
  const L = w*0.56;
  ctx.strokeStyle="rgba(110,231,255,0.9)";
  ctx.lineWidth=2.5;
  ctx.beginPath();
  ctx.moveTo(ax, ay);
  ctx.lineTo(ax+L, ay);
  ctx.stroke();
  // arrowhead
  ctx.fillStyle="rgba(110,231,255,0.9)";
  ctx.beginPath();
  ctx.moveTo(ax+L, ay);
  ctx.lineTo(ax+L-12, ay-6);
  ctx.lineTo(ax+L-12, ay+6);
  ctx.closePath();
  ctx.fill();
  ctx.fillStyle="rgba(233,238,247,0.9)";
  ctx.font="12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="left";
  ctx.textBaseline="bottom";
  ctx.fillText("Propagation: β (along z)", ax+4, ay-8);
  ctx.restore();

  // evanescent tails sketch
  ctx.save();
  ctx.strokeStyle="rgba(255,255,255,0.42)";
  ctx.lineWidth=1.3;
  const centerX = x0 + w*0.42;
  // top tail
  for(let i=0;i<24;i++){
    const x = centerX + i*8;
    const amp = Math.exp(-i/6)*10;
    const y = filmY - 10 - amp*Math.sin(i*0.65);
    if(i===0) ctx.beginPath(), ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
  // bottom tail
  for(let i=0;i<24;i++){
    const x = centerX + i*8;
    const amp = Math.exp(-i/6)*10;
    const y = filmY + filmH + 10 + amp*Math.sin(i*0.65);
    if(i===0) ctx.beginPath(), ctx.moveTo(x, y);
    else ctx.lineTo(x, y);
  }
  ctx.stroke();
  ctx.restore();

  // caption
  ctx.save();
  ctx.fillStyle="rgba(169,180,199,0.95)";
  ctx.font="12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="left";
  ctx.textBaseline="bottom";
  ctx.fillText("Evanescent decay into claddings (q sets the decay length 1/q).", x0+14, y0+h-8);
  ctx.restore();
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

/* ------------------------ Main plot + secondary plot ------------------------ */
const cDiagram = setupCanvas(document.getElementById("cDiagram"));
const cMain = setupCanvas(document.getElementById("cMain"));
const cSecondary = setupCanvas(document.getElementById("cSecondary"));

/* ------------------------ UI state ------------------------ */
const tSlider = document.getElementById("tSlider");
const lambdaSlider = document.getElementById("lambdaSlider");
const n1Slider = document.getElementById("n1Slider");
const cladSelect = document.getElementById("cladSelect");

const tVal = document.getElementById("tVal");
const lambdaVal = document.getElementById("lambdaVal");
const n1Val = document.getElementById("n1Val");
const cladVal = document.getElementById("cladVal");
const liveOut = document.getElementById("liveOut");

function getOldCladding(){
  const mode = cladSelect.value;
  if(mode==="air_vs_example") return 1.45;
  if(mode==="air_vs_water") return 1.33;
  return null;
}

function updateLabels(){
  const t = parseFloat(tSlider.value);
  const lam = parseFloat(lambdaSlider.value);
  const n1 = parseFloat(n1Slider.value);
  tVal.textContent = t.toFixed(2);
  lambdaVal.textContent = lam.toFixed(2);
  n1Val.textContent = n1.toFixed(2);

  const old = getOldCladding();
  if(old===null) cladVal.textContent = "Air only";
  else cladVal.textContent = `Old cladding n₂,old = ${old.toFixed(2)}`;
}

/* ------------------------ Compute sweeps ------------------------ */
function computeSweep(n1, n2, lambda_um, tMin, tMax, nT){
  const ts = linspace(tMin, tMax, nT);
  const out = [];
  let maxModesFound = 0;

  for(const t of ts){
    const sol = solveTEModes(n1,n2,lambda_um,t,6);
    maxModesFound = Math.max(maxModesFound, sol.modes.length);
    out.push({t, V: sol.V, modes: sol.modes});
  }
  return {ts, out, maxModesFound};
}

function render(){
  updateLabels();
  const tNow = parseFloat(tSlider.value);
  const lambda_um = parseFloat(lambdaSlider.value);
  const n1 = parseFloat(n1Slider.value);

  // Always air case (n2=1)
  const n2_air = 1.0;
  const n2_old = getOldCladding();

  // Determine sweep limits (cover beyond current t)
  const tMin = 0.10;
  const tMax = 5.00;
  const nT = 160;

  const sweepAir = computeSweep(n1, n2_air, lambda_um, tMin, tMax, nT);
  const sweepOld = (n2_old!==null && n2_old < n1) ? computeSweep(n1, n2_old, lambda_um, tMin, tMax, nT) : null;

  // Draw diagram
  const d = cDiagram.resize();
  drawDiagram(cDiagram.ctx, d.w, d.h, {n1:n1, t:tNow});

  // Draw main plot: n_eff vs t for first few modes (air and old)
  const mp = cMain.resize();
  const ctxM = cMain.ctx;
  ctxM.clearRect(0,0,mp.w,mp.h);

  const left=62, right=18, top=34, bottom=52;
  const plotBox = {x:left, y:top, w:mp.w-left-right, h:mp.h-top-bottom};

  // y-range: between min cladding and n1
  let yMin = (n2_old!==null ? Math.min(n2_air, n2_old) : n2_air);
  let yMax = n1;
  yMin = Math.max(1.0, yMin);
  yMax = Math.max(yMin+0.05, yMax);

  drawAxes(ctxM, plotBox, tMin, tMax, yMin, yMax, {
    title: "n_eff(t) for TE modes",
    xLabel: "Thickness t (µm)",
    yLabel: "Effective index n_eff",
    xTickFmt: v=>v.toFixed(1),
    yTickFmt: v=>v.toFixed(2)
  });

  // Color palette (no fixed styles requested; but we must use some colors; keep minimal)
  const colAir = "rgba(110,231,255,0.95)";
  const colOld = "rgba(167,139,250,0.95)";
  const colAir2 = "rgba(110,231,255,0.55)";
  const colOld2 = "rgba(167,139,250,0.55)";

  // Determine max modes to plot
  const maxModes = Math.min(5, sweepAir.maxModesFound, 5);
  const maxModesOld = sweepOld ? Math.min(5, sweepOld.maxModesFound, 5) : 0;
  const modesToPlot = Math.max(maxModes, maxModesOld);

  // For each mode index, build curve arrays for air/old
  for(let m=0;m<modesToPlot;m++){
    const xs=[], ys=[];
    for(const item of sweepAir.out){
      if(item.modes.length>m){
        xs.push(item.t);
        ys.push(item.modes[m].neff);
      }
    }
    if(xs.length>1){
      drawLine(ctxM, plotBox, tMin,tMax,yMin,yMax, xs, ys, (m===0?colAir:colAir2), m===0?2.6:1.8);
    }

    if(sweepOld){
      const xs2=[], ys2=[];
      for(const item of sweepOld.out){
        if(item.modes.length>m){
          xs2.push(item.t);
          ys2.push(item.modes[m].neff);
        }
      }
      if(xs2.length>1){
        drawLine(ctxM, plotBox, tMin,tMax,yMin,yMax, xs2, ys2, (m===0?colOld:colOld2), m===0?2.6:1.8);
      }
    }
  }

  // Current thickness marker
  drawMarkerVline(ctxM, plotBox, tMin,tMax, tNow, "rgba(255,255,255,0.65)");

  // Legend
  const legItems = [{label:"Air (n₂=1)", color:colAir}];
  if(sweepOld){
    legItems.push({label:`Old (n₂=${n2_old.toFixed(2)})`, color:colOld});
  }
  drawLegend(ctxM, plotBox, legItems);

  // Secondary plot: mode counts vs thickness
  const sp = cSecondary.resize();
  const ctxS = cSecondary.ctx;
  ctxS.clearRect(0,0,sp.w,sp.h);
  const sb = {x:left, y:top, w:sp.w-left-right, h:sp.h-top-bottom};

  // compute counts
  const countsAir = sweepAir.out.map(o=>o.modes.length);
  const countsOld = sweepOld ? sweepOld.out.map(o=>o.modes.length) : null;

  let yCMax = 1;
  for(const c of countsAir) yCMax=Math.max(yCMax,c);
  if(countsOld) for(const c of countsOld) yCMax=Math.max(yCMax,c);
  yCMax = Math.max(2, yCMax);

  drawAxes(ctxS, sb, tMin, tMax, 0, yCMax, {
    title: "Guided TE mode count vs thickness",
    xLabel: "Thickness t (µm)",
    yLabel: "Number of TE modes (solver count)",
    xTickFmt: v=>v.toFixed(1),
    yTickFmt: v=>v.toFixed(0)
  });

  // plot counts as lines (step-like but line is fine)
  drawLine(ctxS, sb, tMin,tMax,0,yCMax, sweepAir.ts, countsAir, colAir, 2.6);
  if(countsOld){
    drawLine(ctxS, sb, tMin,tMax,0,yCMax, sweepOld.ts, countsOld, colOld, 2.6);
  }
  drawMarkerVline(ctxS, sb, tMin,tMax, tNow, "rgba(255,255,255,0.65)");
  drawLegend(ctxS, sb, legItems);

  // Live output at current t
  const solAir = solveTEModes(n1,n2_air,lambda_um,tNow,6);
  const estAir = modeCountEstimate(solAir.V);
  let txt = "";
  txt += `Current settings:\n`;
  txt += `t = ${tNow.toFixed(2)} µm,  λ = ${lambda_um.toFixed(2)} µm,  n₁ = ${n1.toFixed(2)}\n\n`;
  txt += `Air cladding (n₂=1):\n`;
  txt += `V_air = ${solAir.V.toFixed(3)}\n`;
  txt += `Mode count (solver) = ${solAir.modes.length},   estimate ⌊V/π⌋+1 = ${estAir}\n`;
  if(solAir.modes.length){
    txt += `n_eff (first modes): ${solAir.modes.map(m=>m.neff.toFixed(4)).join(", ")}\n`;
  } else {
    txt += `No guided TE modes found (this can happen if contrast is zero).\n`;
  }

  if(n2_old!==null && n2_old < n1){
    const solOld = solveTEModes(n1,n2_old,lambda_um,tNow,6);
    const estOld = modeCountEstimate(solOld.V);
    txt += `\nOld cladding (example) n₂,old = ${n2_old.toFixed(2)}:\n`;
    txt += `V_old = ${solOld.V.toFixed(3)}\n`;
    txt += `V_air/V_old = ${(solOld.V>0 ? (solAir.V/solOld.V) : NaN).toFixed(3)}\n`;
    txt += `Mode count (solver) = ${solOld.modes.length},   estimate = ${estOld}\n`;
    if(solOld.modes.length){
      txt += `n_eff (first modes): ${solOld.modes.map(m=>m.neff.toFixed(4)).join(", ")}\n`;
    }
  }

  liveOut.textContent = txt;
}

[tSlider, lambdaSlider, n1Slider, cladSelect].forEach(el=>{
  el.addEventListener('input', render);
});
window.addEventListener('resize', render);

// initial render
render();
</script>
</body>
</html>
