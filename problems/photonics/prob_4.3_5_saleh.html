<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fraunhofer Diffraction with an Obliquely Incident Wave (Small Angle)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --card2:#0f1730;
      --text:#eaf0ff;
      --muted:#b9c4e6;
      --faint:#7f8bb3;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --border: rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.45);
      --shadow2: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(900px 450px at 15% 10%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(800px 420px at 85% 12%, rgba(167,139,250,.14), transparent 60%),
        radial-gradient(700px 420px at 55% 95%, rgba(52,211,153,.10), transparent 60%),
        linear-gradient(180deg, #070a14 0%, #0b1020 60%, #070a14 100%);
      line-height: 1.55;
    }

    header{
      padding: 28px 18px 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 980px){
      .hero{ grid-template-columns: 1fr; }
    }

    h1{
      margin:0 0 10px;
      letter-spacing: -0.02em;
      font-size: clamp(1.55rem, 2.1vw + 1rem, 2.35rem);
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      max-width: 74ch;
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .card .pad{ padding: 16px; }
    .chiprow{
      display:flex;
      flex-wrap:wrap;
      gap: 8px;
      margin-top: 12px;
    }
    .chip{
      font-size: 12.5px;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid var(--border);
      color: var(--muted);
      background: rgba(0,0,0,.15);
      backdrop-filter: blur(6px);
    }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 8px 18px 44px;
      display:grid;
      grid-template-columns: 290px 1fr;
      gap: 16px;
      align-items: start;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
    }

    nav#toc{
      position: sticky;
      top: 12px;
      align-self: start;
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(17,26,51,.75);
      box-shadow: var(--shadow2);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    nav#toc .pad{ padding: 14px 14px 10px; }
    nav#toc h2{
      font-size: 13px;
      margin:0 0 10px;
      color: var(--muted);
      letter-spacing: .08em;
      text-transform: uppercase;
    }
    nav#toc a{
      display:block;
      padding: 9px 10px;
      border-radius: 12px;
      text-decoration:none;
      color: var(--text);
      border: 1px solid transparent;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-size: 14px;
    }
    nav#toc a:hover{
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.22);
      transform: translateX(2px);
    }

    section{
      scroll-margin-top: 16px;
    }

    .content{
      display:flex;
      flex-direction:column;
      gap: 16px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 16px;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .callout{
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(17,26,51,.55);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .callout .pad{ padding: 16px; }
    .callout h3{
      margin:0 0 8px;
      font-size: 16px;
      letter-spacing: -0.01em;
    }
    .bullets{
      margin: 8px 0 0;
      padding-left: 18px;
      color: var(--muted);
    }
    .bullets li{ margin: 6px 0; }

    .kbox{
      margin-top: 12px;
      padding: 12px 12px 10px;
      border-radius: 14px;
      border: 1px solid rgba(125,211,252,.24);
      background: rgba(125,211,252,.08);
    }

    .eq{
      font-family: var(--mono);
      font-size: 13.5px;
      line-height: 1.45;
      color: #f0f6ff;
      background: rgba(0,0,0,.25);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      position: relative;
      overflow:auto;
    }

    .eqrow{
      display:flex;
      gap: 10px;
      align-items: stretch;
      margin-top: 10px;
      flex-wrap: wrap;
    }
    .copybtn{
      appearance:none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size: 13px;
      display:inline-flex;
      gap: 8px;
      align-items:center;
      user-select:none;
    }
    .copybtn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.09);
      border-color: rgba(125,211,252,.25);
    }
    .copybtn:active{ transform: translateY(0px); }
    .copybtn small{ color: var(--muted); font-size: 12px; }

    .plotCard{
      border-radius: var(--radius);
      border: 1px solid var(--border);
      background: rgba(17,26,51,.48);
      box-shadow: var(--shadow2);
      overflow:hidden;
    }
    .plotCard header{
      padding: 12px 14px 10px;
      border-bottom: 1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:center;
      justify-content: space-between;
      gap: 10px;
      max-width:none;
      margin:0;
    }
    .plotCard header h3{
      margin:0;
      font-size: 14.5px;
      letter-spacing: -0.01em;
      color: var(--text);
    }
    .plotCard header .meta{
      font-size: 12px;
      color: var(--muted);
      white-space: nowrap;
    }
    .plotCard .body{ padding: 12px 14px 14px; }

    canvas{
      width: 100%;
      height: 340px;
      display:block;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.20);
    }
    .smallCanvas{ height: 300px; }

    .controls{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 10px;
      margin-top: 12px;
    }
    @media (max-width: 980px){
      .controls{ grid-template-columns: 1fr; }
    }

    .control{
      border-radius: 14px;
      border: 1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding: 10px 12px;
    }
    .control label{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      font-size: 12.5px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .control input[type="range"]{ width:100%; }
    .val{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
    }

    .boxFinal{
      border: 1px solid rgba(52,211,153,.25);
      background: rgba(52,211,153,.08);
      border-radius: var(--radius);
      padding: 14px;
    }
    .boxFinal h3{ margin:0 0 8px; }
    .boxFinal .eq{ border-color: rgba(52,211,153,.25); }

    footer{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 18px 34px;
      color: var(--faint);
      font-size: 12.5px;
    }

    .fadeIn{
      animation: fadeUp .55s ease both;
    }
    @keyframes fadeUp{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }

    @media print{
      body{ background:#fff; color:#000; }
      nav#toc{ display:none; }
      .card, .callout, .plotCard, .boxFinal, .eq{ box-shadow:none; }
      canvas{ border:1px solid #999; background:#fff; }
      .copybtn{ display:none; }
    }
  </style>
</head>

<body>
<header class="fadeIn">
  <div class="hero">
    <div class="card">
      <div class="pad">
        <h1>Fraunhofer Diffraction with an Obliquely Incident Plane Wave (Small Angle)</h1>
        <p class="subtitle">
          How a small tilt of the incident wave in the <span style="color:var(--accent)">x‚Äìz</span> plane modifies the far-field diffraction pattern:
          it multiplies the aperture by a linear phase ramp, which <em>shifts</em> the Fourier transform (and thus the intensity) in the observation plane.
        </p>
        <div class="chiprow">
          <span class="chip">Fraunhofer regime</span>
          <span class="chip">Fourier optics</span>
          <span class="chip">Small-angle approximation</span>
          <span class="chip">Shift theorem</span>
        </div>
      </div>
    </div>

    <div class="callout">
      <div class="pad">
        <h3>Quick Summary</h3>
        <ul class="bullets">
          <li>Oblique incidence adds a phase factor: <span style="font-family:var(--mono)">exp(i k x sinŒ∏x)</span> across the aperture.</li>
          <li>Multiplying by a phase ramp <em>shifts</em> the aperture‚Äôs Fourier transform (shift theorem).</li>
          <li>In screen coordinates: the pattern is shifted by <span style="font-family:var(--mono)">ŒîX ‚âà d Œ∏x</span> (for small Œ∏x).</li>
          <li>Intensity keeps the same shape: only the center moves (no change in envelope, ignoring obliquity factors).</li>
          <li>For a rectangular aperture, the usual sinc¬≤ lobes shift rigidly along x.</li>
        </ul>
      </div>
    </div>
  </div>
</header>

<main>
  <nav id="toc" class="fadeIn" aria-label="Table of Contents">
    <div class="pad">
      <h2>Contents</h2>
      <a href="#viz">Interactive Visualizations</a>
      <a href="#part1">PART 1 ‚Äî Problem Analysis</a>
      <a href="#part2">PART 2 ‚Äî Strategy & Tips</a>
      <a href="#part3">PART 3 ‚Äî Full Solution</a>
      <a href="#final">Final Result</a>
      <a href="#checks">Sanity Checks</a>
    </div>
  </nav>

  <div class="content">

    <!-- VISUALIZATIONS -->
    <section id="viz" class="fadeIn">
      <div class="plotCard">
        <header>
          <h3>Interactive: Geometry + Far-Field Pattern Shift</h3>
          <div class="meta">Slider updates all canvases</div>
        </header>
        <div class="body">
          <div class="grid2">
            <div>
              <canvas id="cDiagram" aria-label="Diagram canvas"></canvas>
              <div class="kbox">
                <div style="color:var(--muted); font-size:13px;">
                  The incident plane wave is tilted by a small angle <span style="font-family:var(--mono)">Œ∏x</span> in the x‚Äìz plane,
                  adding a linear phase ramp across the aperture. The far-field intensity shifts by <span style="font-family:var(--mono)">ŒîX ‚âà d Œ∏x</span>.
                </div>
              </div>
            </div>
            <div>
              <canvas id="cMain" aria-label="Main plot canvas"></canvas>
              <div class="kbox">
                <div style="color:var(--muted); font-size:13px;">
                  Main plot: normalized intensity along the screen line <span style="font-family:var(--mono)">Y=0</span>.
                  Dashed marker indicates the predicted shift <span style="font-family:var(--mono)">X0 = d sinŒ∏x ‚âà d Œ∏x</span>.
                </div>
              </div>
            </div>
          </div>

          <div style="height:14px"></div>

          <div class="grid2">
            <div>
              <canvas id="cSecondary" class="smallCanvas" aria-label="Secondary plot canvas"></canvas>
              <div class="kbox">
                <div style="color:var(--muted); font-size:13px;">
                  Secondary visualization: 2D screen intensity map. The whole pattern slides in x as <span style="font-family:var(--mono)">Œ∏x</span> changes.
                </div>
              </div>
            </div>
            <div class="callout">
              <div class="pad">
                <h3>Example values used for plots</h3>
                <ul class="bullets">
                  <li>Wavelength: <span style="font-family:var(--mono)">Œª = 633 nm</span> (HeNe red)</li>
                  <li>Screen distance: <span style="font-family:var(--mono)">d = 1.0 m</span></li>
                  <li>Rectangular aperture: <span style="font-family:var(--mono)">a √ó b</span> with defaults <span style="font-family:var(--mono)">a=0.20 mm, b=0.20 mm</span></li>
                  <li>Angle: small <span style="font-family:var(--mono)">Œ∏x</span> in degrees (converted internally to radians)</li>
                </ul>

                <div class="controls" role="group" aria-label="Interactive controls">
                  <div class="control">
                    <label>
                      <span>Incident tilt Œ∏x (deg)</span>
                      <span class="val" id="vTheta">0.40¬∞</span>
                    </label>
                    <input id="sTheta" type="range" min="-2" max="2" step="0.01" value="0.40" />
                  </div>
                  <div class="control">
                    <label>
                      <span>Aperture width a (mm)</span>
                      <span class="val" id="vA">0.20 mm</span>
                    </label>
                    <input id="sA" type="range" min="0.05" max="0.60" step="0.01" value="0.20" />
                  </div>
                  <div class="control">
                    <label>
                      <span>Distance d (m)</span>
                      <span class="val" id="vD">1.00 m</span>
                    </label>
                    <input id="sD" type="range" min="0.3" max="2.0" step="0.01" value="1.00" />
                  </div>
                </div>

                <div class="eqrow" style="margin-top:12px;">
                  <button class="copybtn" data-copy="k = 2œÄ/Œª">
                    <span>üìã Copy</span><span>k = 2œÄ/Œª</span> <small>(wavenumber)</small>
                  </button>
                  <button class="copybtn" data-copy="ŒîX = d sin(Œ∏x) ‚âà d Œ∏x  (Œ∏x in radians)">
                    <span>üìã Copy</span><span>ŒîX ‚âà d Œ∏x</span> <small>(shift)</small>
                  </button>
                </div>

              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- PART 1 -->
    <section id="part1" class="fadeIn">
      <article class="callout">
        <div class="pad">
          <h2 style="margin:0 0 8px;">PART 1 ‚Äî Problem Analysis (no solving yet)</h2>

          <h3>Problem restatement (in my own words)</h3>
          <p style="color:var(--muted); margin-top:0;">
            In Fraunhofer diffraction, the far-field intensity from an aperture with transmission function
            <span style="font-family:var(--mono)">p(x,y)</span> is proportional to the squared magnitude of the
            Fourier transform of <span style="font-family:var(--mono)">p</span>, evaluated at spatial frequencies set by the observation point
            on a screen a distance <span style="font-family:var(--mono)">d</span> away. The question asks: if the incident plane wave is not normal
            but comes in at a small angle <span style="font-family:var(--mono)">Œ∏x ‚â™ 1</span> relative to the z-axis, in the x‚Äìz plane,
            how does the diffraction pattern change?
          </p>

          <div class="grid2">
            <div>
              <h3>Given</h3>
              <ul class="bullets">
                <li>Aperture (complex) transmission: <span style="font-family:var(--mono)">p(x,y)</span></li>
                <li>Fraunhofer regime relation: intensity <span style="font-family:var(--mono)">I ‚àù |P(ŒΩx,ŒΩy)|¬≤</span></li>
                <li>Mapping to screen: <span style="font-family:var(--mono)">ŒΩx = X/(Œª d)</span>, <span style="font-family:var(--mono)">ŒΩy = Y/(Œª d)</span></li>
                <li>Incident wave direction tilted by <span style="font-family:var(--mono)">Œ∏x</span> in x‚Äìz plane; <span style="font-family:var(--mono)">Œ∏x ‚â™ 1</span></li>
              </ul>
            </div>
            <div>
              <h3>Unknowns</h3>
              <ul class="bullets">
                <li>The new far-field complex amplitude pattern (and intensity) under oblique incidence</li>
                <li>How the pattern relates to the original Fourier transform <span style="font-family:var(--mono)">P</span></li>
              </ul>

              <h3 style="margin-top:14px;">What must be found</h3>
              <ul class="bullets">
                <li>Express the oblique-incidence diffraction pattern in terms of <span style="font-family:var(--mono)">P</span></li>
                <li>Use the small-angle approximation to interpret the result (shift amount)</li>
              </ul>
            </div>
          </div>

          <h3>Relevant principles and why they apply</h3>
          <ul class="bullets">
            <li><strong>Fraunhofer diffraction</strong>: in the far field (or focal plane of a lens), the diffracted field is proportional to the Fourier transform of the complex field at the aperture.</li>
            <li><strong>Plane-wave tilt produces a phase ramp</strong>: changing the incidence angle multiplies the aperture field by <span style="font-family:var(--mono)">exp(i k x sinŒ∏x)</span>, because the plane wave has transverse wavevector component <span style="font-family:var(--mono)">k sinŒ∏x</span>.</li>
            <li><strong>Fourier shift theorem</strong>: multiplying by <span style="font-family:var(--mono)">exp(i 2œÄ f0 x)</span> shifts the Fourier transform by <span style="font-family:var(--mono)">f0</span>. This directly predicts a shifted diffraction pattern.</li>
          </ul>

          <h3>Possible approaches</h3>
          <ul class="bullets">
            <li><strong>Fourier-optics approach (best)</strong>: write the aperture field under oblique incidence and apply the shift theorem. Fast, general for any <span style="font-family:var(--mono)">p(x,y)</span>.</li>
            <li><strong>Angular spectrum / k-vector mapping</strong>: interpret far-field angles as transverse k-components; oblique incidence offsets the transverse k by <span style="font-family:var(--mono)">k sinŒ∏x</span>. Gives strong physical insight.</li>
            <li><strong>Huygens‚ÄìFresnel integral</strong>: start from the full integral, insert the tilted incident wave, and take the Fraunhofer approximation. More algebra, same result.</li>
          </ul>

          <p style="color:var(--muted); margin-bottom:0;">
            <strong>Chosen approach:</strong> Fourier-optics + shift theorem. It is the most direct, stays symbolic, and matches the given statement about <span style="font-family:var(--mono)">P</span>.
          </p>
        </div>
      </article>
    </section>

    <!-- PART 2 -->
    <section id="part2" class="fadeIn">
      <article class="callout">
        <div class="pad">
          <h2 style="margin:0 0 8px;">PART 2 ‚Äî Strategy & Tips (roadmap only)</h2>

          <h3>Step-by-step plan (no algebra yet)</h3>
          <ol class="bullets">
            <li><strong>Model the incident field at the aperture</strong>: represent a tilted plane wave and extract its transverse phase factor. <span style="font-family:var(--mono)">Einc ‚àù exp(i k x sinŒ∏x)</span>.</li>
            <li><strong>Form the complex field just after the aperture</strong>: multiply transmission by incident field. Tool: linearity of field. </li>
            <li><strong>Write the Fraunhofer field as a Fourier transform</strong>: far-field amplitude is FT of the aperture field evaluated at frequencies set by <span style="font-family:var(--mono)">X,Y</span>. Tool: Fraunhofer diffraction formula.</li>
            <li><strong>Apply the Fourier shift theorem</strong>: multiplication by a phase ramp ‚Üí shift in Fourier domain. Tool: FT property.</li>
            <li><strong>Convert shift to screen coordinates</strong>: express the shift in terms of <span style="font-family:var(--mono)">X</span> and <span style="font-family:var(--mono)">d</span>, then use <span style="font-family:var(--mono)">sinŒ∏x ‚âà Œ∏x</span> for small angles.</li>
            <li><strong>Square magnitude for intensity</strong>: show that intensity is the same shape but displaced.</li>
          </ol>

          <h3>Common mistakes & quick tips</h3>
          <ul class="bullets">
            <li><strong>Using degrees inside small-angle formulas</strong>: <span style="font-family:var(--mono)">Œ∏x</span> must be in radians in <span style="font-family:var(--mono)">sinŒ∏x ‚âà Œ∏x</span>.</li>
            <li><strong>Wrong sign for the shift</strong>: the direction depends on your FT convention; be consistent (we state ours explicitly).</li>
            <li><strong>Confusing screen coordinate shift vs frequency shift</strong>: the FT shift is in spatial frequency; converting to <span style="font-family:var(--mono)">X</span> introduces the <span style="font-family:var(--mono)">Œª d</span> factor.</li>
            <li><strong>Forgetting that intensity ignores overall phase</strong>: any global phase factor from propagation does not affect <span style="font-family:var(--mono)">|U|¬≤</span>.</li>
          </ul>
        </div>
      </article>
    </section>

    <!-- PART 3 -->
    <section id="part3" class="fadeIn">
      <article class="callout">
        <div class="pad">
          <h2 style="margin:0 0 8px;">PART 3 ‚Äî Full Solution</h2>

          <h3>Physical intuition</h3>
          <p style="color:var(--muted); margin-top:0;">
            A tilted plane wave hits different parts of the aperture at different phases: points with larger <span style="font-family:var(--mono)">x</span>
            see a phase advance proportional to <span style="font-family:var(--mono)">x</span>. In the far field, diffraction ‚Äúreads out‚Äù the spatial
            frequencies present in the aperture field. Adding a linear phase ramp is equivalent to adding a constant transverse wavevector component,
            so the far-field pattern (in transverse k-space) is shifted. On a screen, that becomes a lateral displacement of the entire intensity pattern.
          </p>

          <h3>Define conventions</h3>
          <p style="color:var(--muted);">
            Let the aperture lie in the plane <span style="font-family:var(--mono)">z = 0</span>. The observation screen is at <span style="font-family:var(--mono)">z = d</span>,
            with transverse coordinates <span style="font-family:var(--mono)">(X, Y)</span>.
            We use the 2D Fourier transform convention:
          </p>

          <div class="eq" id="eqFT">
P(ŒΩx, ŒΩy) = ‚à¨ p(x,y) ¬∑ exp[-i 2œÄ (ŒΩx x + ŒΩy y)] dx dy
          </div>

          <div class="eqrow">
            <button class="copybtn" data-copy="P(ŒΩx,ŒΩy)=‚à¨ p(x,y) exp[-i2œÄ(ŒΩx x+ŒΩy y)] dx dy">
              <span>üìã Copy</span><span>Fourier transform definition</span>
            </button>
          </div>

          <h3>Fraunhofer diffraction (normal incidence reminder)</h3>
          <p style="color:var(--muted);">
            In the Fraunhofer regime, the complex field on the screen is proportional to the Fourier transform of the aperture field evaluated at
            spatial frequencies
            <span style="font-family:var(--mono)">ŒΩx = X/(Œª d)</span>, <span style="font-family:var(--mono)">ŒΩy = Y/(Œª d)</span>.
            Ignoring overall phase and constant prefactors, the intensity is:
          </p>
          <div class="eq" id="eqNormal">
I(X,Y) ‚àù | P( X/(Œª d),  Y/(Œª d) ) |¬≤
          </div>

          <h3>Step 1: incident tilted plane wave at the aperture</h3>
          <p style="color:var(--muted);">
            A plane wave of wavenumber <span style="font-family:var(--mono)">k = 2œÄ/Œª</span> propagating at angle <span style="font-family:var(--mono)">Œ∏x</span>
            from the z-axis in the x‚Äìz plane has unit propagation direction
            <span style="font-family:var(--mono)">≈ù ‚âà (sinŒ∏x, 0, cosŒ∏x)</span>.
            Its field can be written as:
          </p>
          <div class="eq" id="eqInc">
E_inc(x,y,z) = E0 ¬∑ exp[i k ( x sinŒ∏x + z cosŒ∏x )]
          </div>
          <p style="color:var(--muted);">
            At the aperture plane <span style="font-family:var(--mono)">z=0</span>, this becomes a pure transverse phase factor:
          </p>
          <div class="eq" id="eqIncAtAperture">
E_inc(x,y,0) = E0 ¬∑ exp[i k x sinŒ∏x]
          </div>

          <h3>Step 2: field immediately after the aperture</h3>
          <p style="color:var(--muted);">
            The complex field just after the aperture is the incident field multiplied by the aperture transmission:
          </p>
          <div class="eq" id="eqApertureField">
U_A(x,y) = p(x,y) ¬∑ E0 ¬∑ exp[i k x sinŒ∏x]
          </div>

          <h3>Step 3: Fraunhofer field as Fourier transform</h3>
          <p style="color:var(--muted);">
            Fraunhofer diffraction says the screen field is proportional to the Fourier transform of <span style="font-family:var(--mono)">U_A</span>
            evaluated at <span style="font-family:var(--mono)">ŒΩx = X/(Œª d)</span>, <span style="font-family:var(--mono)">ŒΩy = Y/(Œª d)</span>:
          </p>

          <div class="eq" id="eqFraunhoferAmp">
U(X,Y) ‚àù ‚à¨ U_A(x,y) ¬∑ exp[-i 2œÄ (ŒΩx x + ŒΩy y)] dx dy
     with  ŒΩx = X/(Œª d),  ŒΩy = Y/(Œª d)
          </div>

          <h3>Step 4: Apply the shift theorem (key step)</h3>
          <p style="color:var(--muted);">
            Insert <span style="font-family:var(--mono)">U_A(x,y)=p(x,y)E0 exp(i k x sinŒ∏x)</span>. Note that:
          </p>
          <div class="eq" id="eqRampTo2pi">
exp[i k x sinŒ∏x] = exp[i (2œÄ/Œª) x sinŒ∏x] = exp[i 2œÄ ( (sinŒ∏x)/Œª ) x]
          </div>
          <p style="color:var(--muted);">
            So the aperture is multiplied by <span style="font-family:var(--mono)">exp[i 2œÄ ŒΩ0 x]</span> with
            <span style="font-family:var(--mono)">ŒΩ0 = (sinŒ∏x)/Œª</span>.
            The Fourier transform shift theorem (with our convention) states:
          </p>
          <div class="eq" id="eqShiftTheorem">
FT{ p(x,y) ¬∑ exp[i 2œÄ ŒΩ0 x] } = P( ŒΩx - ŒΩ0, ŒΩy )
          </div>

          <p style="color:var(--muted);">
            Therefore the Fraunhofer field becomes:
          </p>
          <div class="eq" id="eqFieldShifted">
U(X,Y) ‚àù P( ŒΩx - sinŒ∏x/Œª ,  ŒΩy )
     where  ŒΩx = X/(Œª d),  ŒΩy = Y/(Œª d)
          </div>

          <h3>Step 5: Convert to a shift on the screen</h3>
          <p style="color:var(--muted);">
            Substitute <span style="font-family:var(--mono)">ŒΩx = X/(Œª d)</span>. The argument in <span style="font-family:var(--mono)">P</span> is:
          </p>
          <div class="eq" id="eqArgConvert">
ŒΩx - sinŒ∏x/Œª = X/(Œª d) - sinŒ∏x/Œª = (X - d sinŒ∏x)/(Œª d)
          </div>

          <p style="color:var(--muted);">
            So, up to overall constants and phases, the <em>screen</em> field is:
          </p>
          <div class="eq" id="eqScreenShift">
U(X,Y) ‚àù P( (X - d sinŒ∏x)/(Œª d),  Y/(Œª d) )
          </div>

          <h3>Intensity pattern</h3>
          <p style="color:var(--muted);">
            Intensity is the squared magnitude:
          </p>
          <div class="eq" id="eqIntensityShift">
I(X,Y) ‚àù | P( (X - d sinŒ∏x)/(Œª d),  Y/(Œª d) ) |¬≤
          </div>

          <p style="color:var(--muted);">
            For a small angle <span style="font-family:var(--mono)">Œ∏x ‚â™ 1</span>, <span style="font-family:var(--mono)">sinŒ∏x ‚âà Œ∏x</span> (radians), giving a simple lateral shift:
          </p>
          <div class="eq" id="eqSmallAngle">
I(X,Y) ‚àù | P( (X - d Œ∏x)/(Œª d),  Y/(Œª d) ) |¬≤
‚áí the pattern is shifted by  ŒîX ‚âà d Œ∏x  along +x
          </div>
        </div>
      </article>
    </section>

    <!-- FINAL RESULT -->
    <section id="final" class="fadeIn">
      <div class="boxFinal">
        <h3>Final Result (boxed)</h3>
        <div class="eq" id="eqFinal">
For incidence tilted by Œ∏x in the x‚Äìz plane:

U(X,Y) ‚àù P( (X - d sinŒ∏x)/(Œª d) ,  Y/(Œª d) )

I(X,Y) ‚àù | P( (X - d sinŒ∏x)/(Œª d) ,  Y/(Œª d) ) |¬≤

Small-angle (Œ∏x ‚â™ 1 rad): replace sinŒ∏x ‚Üí Œ∏x, so ŒîX ‚âà d Œ∏x.
        </div>
        <div class="eqrow">
          <button class="copybtn" data-copy="U(X,Y) ‚àù P((X - d sinŒ∏x)/(Œª d), Y/(Œª d));  I(X,Y) ‚àù |P((X - d sinŒ∏x)/(Œª d), Y/(Œª d))|^2;  small angle: ŒîX ‚âà d Œ∏x (Œ∏x in rad).">
            <span>üìã Copy</span><span>Final answer (plain text)</span>
          </button>
        </div>
      </div>
    </section>

    <!-- SANITY CHECKS -->
    <section id="checks" class="fadeIn">
      <article class="callout">
        <div class="pad">
          <h2 style="margin:0 0 8px;">Sanity Checks</h2>

          <h3>Units</h3>
          <ul class="bullets">
            <li><span style="font-family:var(--mono)">X</span> and <span style="font-family:var(--mono)">d</span> have units of length, so <span style="font-family:var(--mono)">X/(Œª d)</span> has units of 1/length (spatial frequency), matching the FT argument.</li>
            <li><span style="font-family:var(--mono)">d sinŒ∏x</span> has units of length, so the shift <span style="font-family:var(--mono)">ŒîX</span> is a length as expected.</li>
          </ul>

          <h3>Limiting cases</h3>
          <ul class="bullets">
            <li><strong>Œ∏x ‚Üí 0:</strong> <span style="font-family:var(--mono)">sinŒ∏x ‚Üí 0</span>, so the formula reduces to the standard normal-incidence Fraunhofer pattern.</li>
            <li><strong>Very small angle:</strong> <span style="font-family:var(--mono)">sinŒ∏x ‚âà Œ∏x</span> gives a rigid translation; the envelope does not change.</li>
          </ul>

          <h3>Physical interpretation</h3>
          <ul class="bullets">
            <li>Oblique incidence adds transverse momentum <span style="font-family:var(--mono)">k_x = k sinŒ∏x</span>, so the far-field distribution in <span style="font-family:var(--mono)">k_x</span>-space is shifted by that amount.</li>
            <li>On a screen, transverse angle maps to position: <span style="font-family:var(--mono)">X ‚âà d tanŒ± ‚âà d Œ±</span> for small angles, hence the shift <span style="font-family:var(--mono)">ŒîX ‚âà d Œ∏x</span>.</li>
          </ul>
        </div>
      </article>
    </section>

  </div>
</main>

<footer class="fadeIn">
  <div>
    Tip: If you use a lens and observe in the back focal plane (Fourier plane), replace <span style="font-family:var(--mono)">d</span> by the focal length <span style="font-family:var(--mono)">f</span>.
    The same shift logic applies: <span style="font-family:var(--mono)">ŒîX ‚âà f Œ∏x</span> (small angles).
  </div>
</footer>

<script>
(function(){
  "use strict";

  // ---------- Utilities ----------
  const $ = (id)=>document.getElementById(id);

  function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
  function lerp(a,b,t){ return a + (b-a)*t; }
  function niceNum(x){
    // for tick selection
    const exp = Math.floor(Math.log10(x));
    const f = x / Math.pow(10, exp);
    let nf;
    if (f < 1.5) nf = 1;
    else if (f < 3) nf = 2;
    else if (f < 7) nf = 5;
    else nf = 10;
    return nf * Math.pow(10, exp);
  }

  function setDPR(canvas, cssW, cssH){
    const dpr = window.devicePixelRatio || 1;
    canvas.style.width = cssW + "px";
    canvas.style.height = cssH + "px";
    canvas.width = Math.round(cssW * dpr);
    canvas.height = Math.round(cssH * dpr);
    const ctx = canvas.getContext("2d");
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {ctx, dpr};
  }

  function getCSSSize(canvas){
    const r = canvas.getBoundingClientRect();
    return {w: Math.max(10, r.width), h: Math.max(10, r.height)};
  }

  function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title, opts={}){
    const {x=box.x, y=box.y, w=box.w, h=box.h} = box;
    const padL = 56, padR = 14, padT = 30, padB = 42;
    const px = x + padL, py = y + padT;
    const pw = w - padL - padR, ph = h - padT - padB;

    // background
    ctx.save();
    ctx.clearRect(x,y,w,h);
    ctx.fillStyle = "rgba(0,0,0,0.0)";
    ctx.fillRect(x,y,w,h);

    // title
    ctx.fillStyle = "rgba(234,240,255,0.95)";
    ctx.font = "600 13.5px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(title, x+12, y+18);

    // frame
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.lineWidth = 1;
    ctx.strokeRect(px, py, pw, ph);

    // ticks
    const xRange = xMax - xMin;
    const yRange = yMax - yMin;
    const xStep = niceNum(xRange / 6);
    const yStep = niceNum(yRange / 5);

    function xToPx(xv){ return px + (xv - xMin) * pw / xRange; }
    function yToPx(yv){ return py + ph - (yv - yMin) * ph / yRange; }

    // gridlines + tick labels
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    ctx.fillStyle = "rgba(185,196,230,0.90)";
    ctx.strokeStyle = "rgba(255,255,255,0.08)";
    ctx.lineWidth = 1;

    // x grid
    let xStart = Math.ceil(xMin / xStep) * xStep;
    for(let xv = xStart; xv <= xMax + 1e-12; xv += xStep){
      const X = xToPx(xv);
      ctx.beginPath();
      ctx.moveTo(X, py);
      ctx.lineTo(X, py+ph);
      ctx.stroke();

      ctx.fillStyle = "rgba(185,196,230,0.90)";
      const s = formatTick(xv);
      ctx.fillText(s, X - ctx.measureText(s).width/2, py + ph + 18);
    }

    // y grid
    let yStart = Math.ceil(yMin / yStep) * yStep;
    for(let yv = yStart; yv <= yMax + 1e-12; yv += yStep){
      const Y = yToPx(yv);
      ctx.beginPath();
      ctx.moveTo(px, Y);
      ctx.lineTo(px+pw, Y);
      ctx.stroke();

      ctx.fillStyle = "rgba(185,196,230,0.90)";
      const s = formatTick(yv);
      ctx.fillText(s, px - 10 - ctx.measureText(s).width, Y + 4);
    }

    // axis labels
    ctx.fillStyle = "rgba(234,240,255,0.92)";
    ctx.font = "600 12.5px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(xLabel, px + pw/2 - ctx.measureText(xLabel).width/2, py + ph + 36);

    ctx.save();
    ctx.translate(x+16, py + ph/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
    ctx.restore();

    // return mapping
    ctx.restore();
    return {plot:{x:px,y:py,w:pw,h:ph}, xToPx, yToPx};
  }

  function formatTick(v){
    const av = Math.abs(v);
    if(av >= 1000 || (av > 0 && av < 0.001)) return v.toExponential(1).replace("+",""); // compact
    const s = (Math.round(v*1000)/1000).toString();
    return s;
  }

  function sinc(x){
    // normalized sinc = sin(x)/x
    if (Math.abs(x) < 1e-8) return 1;
    return Math.sin(x)/x;
  }

  // ---------- Physics model (example aperture: rectangular) ----------
  // Rectangular aperture: p(x,y)=1 for |x|<=a/2 and |y|<=b/2, else 0.
  // Fraunhofer intensity: I ‚àù sinc^2(œÄ a ŒΩx) * sinc^2(œÄ b ŒΩy).
  // Under oblique incidence: ŒΩx -> ŒΩx - sinŒ∏/Œª, equivalent to X -> X - d sinŒ∏.
  const state = {
    lambda: 633e-9, // m
    b_mm: 0.20,     // fixed b in mm for visuals
    theta_deg: 0.40,
    a_mm: 0.20,
    d_m: 1.00,
    // plot window ranges (screen coordinates)
    Xmax_mm: 18,
    Ymax_mm: 18
  };

  function thetaRad(){ return state.theta_deg * Math.PI/180; }
  function a_m(){ return state.a_mm * 1e-3; }
  function b_m(){ return state.b_mm * 1e-3; }

  function intensityRect(X, Y){
    // X,Y in meters (screen coordinates)
    const lam = state.lambda;
    const d = state.d_m;
    const th = thetaRad();
    const shift = d * Math.sin(th);

    const nuX = (X - shift) / (lam * d);
    const nuY = (Y) / (lam * d);

    const ax = a_m();
    const by = b_m();

    const argX = Math.PI * ax * nuX;
    const argY = Math.PI * by * nuY;

    const I = Math.pow(sinc(argX),2) * Math.pow(sinc(argY),2);
    return I;
  }

  // ---------- Draw: Diagram ----------
  function drawDiagram(){
    const c = $("cDiagram");
    const {w,h} = getCSSSize(c);
    const {ctx} = setDPR(c, w, h);

    const W = w, H = h;
    ctx.clearRect(0,0,W,H);

    // soft panel
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,0.02)";
    ctx.fillRect(0,0,W,H);
    ctx.restore();

    // Coordinate system
    const ox = 76, oy = H - 70;

    ctx.strokeStyle = "rgba(255,255,255,0.18)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(ox, oy);
    ctx.lineTo(ox + 64, oy); // x
    ctx.moveTo(ox, oy);
    ctx.lineTo(ox, oy - 64); // z
    ctx.stroke();

    ctx.fillStyle = "rgba(234,240,255,0.92)";
    ctx.font = "600 12.5px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.fillText("x", ox + 70, oy + 4);
    ctx.fillText("z", ox - 8, oy - 70);

    // Aperture plane (z=0) as a vertical rectangle centered
    const apX = W*0.38;
    const apY = H*0.54;
    const apW = 18;
    const apH = H*0.52;

    ctx.fillStyle = "rgba(125,211,252,0.10)";
    ctx.strokeStyle = "rgba(125,211,252,0.45)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.roundRect(apX - apW/2, apY - apH/2, apW, apH, 10);
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = "rgba(185,196,230,0.92)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    ctx.fillText("aperture (z=0)", apX - 54, apY - apH/2 - 10);

    // Screen plane (z=d) on the right
    const scX = W*0.82;
    const scY = H*0.54;
    const scW = 18;
    const scH = H*0.52;

    ctx.fillStyle = "rgba(167,139,250,0.08)";
    ctx.strokeStyle = "rgba(167,139,250,0.40)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.roundRect(scX - scW/2, scY - scH/2, scW, scH, 10);
    ctx.fill();
    ctx.stroke();

    ctx.fillStyle = "rgba(185,196,230,0.92)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    ctx.fillText("screen (z=d)", scX - 46, scY - scH/2 - 10);

    // Incident plane wave arrows (tilted)
    const th = thetaRad();
    const tilt = clamp(th, -0.5, 0.5);

    // Draw several rays approaching aperture
    ctx.strokeStyle = "rgba(234,240,255,0.30)";
    ctx.lineWidth = 2;
    const rayCount = 5;
    for(let i=0;i<rayCount;i++){
      const yy = lerp(apY - apH*0.35, apY + apH*0.35, i/(rayCount-1));
      const x0 = apX - 160;
      const y0 = yy + 50*tilt;
      const x1 = apX - apW/2;
      const y1 = yy;
      ctx.beginPath();
      ctx.moveTo(x0,y0);
      ctx.lineTo(x1,y1);
      ctx.stroke();

      // arrow head
      const ang = Math.atan2(y1-y0, x1-x0);
      const ah = 10;
      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(x1 - ah*Math.cos(ang-0.35), y1 - ah*Math.sin(ang-0.35));
      ctx.lineTo(x1 - ah*Math.cos(ang+0.35), y1 - ah*Math.sin(ang+0.35));
      ctx.closePath();
      ctx.fillStyle = "rgba(234,240,255,0.35)";
      ctx.fill();
    }

    // Propagation from aperture to screen: central ray
    const cx0 = apX + apW/2;
    const cy0 = apY;
    const cx1 = scX - scW/2;
    const cy1 = apY + (cx1 - cx0) * Math.tan(tilt); // approximate
    ctx.strokeStyle = "rgba(52,211,153,0.42)";
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    ctx.moveTo(cx0, cy0);
    ctx.lineTo(cx1, cy1);
    ctx.stroke();

    // Mark shift on screen: ŒîX ‚âà d sinŒ∏
    const shift = state.d_m * Math.sin(th); // meters
    const shift_mm = shift * 1e3;

    // draw reference center and shifted center on screen
    const scCenterY = apY;
    const pxPerMm = (scH*0.7) / (state.Ymax_mm*2); // rough mapping
    const yRef = scCenterY;
    const yShift = scCenterY + (-shift_mm) * 0.6 * pxPerMm; // schematic
    ctx.strokeStyle = "rgba(255,255,255,0.18)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(scX - 28, yRef);
    ctx.lineTo(scX + 28, yRef);
    ctx.stroke();

    ctx.strokeStyle = "rgba(52,211,153,0.65)";
    ctx.beginPath();
    ctx.moveTo(scX - 28, yShift);
    ctx.lineTo(scX + 28, yShift);
    ctx.stroke();

    ctx.fillStyle = "rgba(234,240,255,0.92)";
    ctx.font = "600 12.5px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.fillText("Œ∏x", apX - 40, apY - apH*0.38);

    // small angle arc near aperture
    ctx.strokeStyle = "rgba(234,240,255,0.35)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    const arcR = 36;
    const arcCx = apX - 6;
    const arcCy = apY - apH*0.33;
    ctx.arc(arcCx, arcCy, arcR, -0.10, -0.10 + tilt, tilt<0);
    ctx.stroke();

    // annotation
    ctx.fillStyle = "rgba(185,196,230,0.95)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    const info1 = `Œ∏x = ${state.theta_deg.toFixed(2)}¬∞`;
    const info2 = `ŒîX ‚âà d sinŒ∏x = ${(shift_mm).toFixed(2)} mm`;
    ctx.fillText(info1, 16, 26);
    ctx.fillText(info2, 16, 44);

    // legend-ish
    ctx.fillStyle = "rgba(52,211,153,0.85)";
    ctx.fillRect(16, 60, 12, 12);
    ctx.fillStyle = "rgba(185,196,230,0.95)";
    ctx.fillText("central ray / shift", 34, 70);

    ctx.fillStyle = "rgba(125,211,252,0.65)";
    ctx.fillRect(16, 80, 12, 12);
    ctx.fillStyle = "rgba(185,196,230,0.95)";
    ctx.fillText("aperture plane", 34, 90);

    ctx.fillStyle = "rgba(167,139,250,0.60)";
    ctx.fillRect(16, 100, 12, 12);
    ctx.fillStyle = "rgba(185,196,230,0.95)";
    ctx.fillText("screen plane", 34, 110);
  }

  // ---------- Draw: Main plot (I vs X at Y=0) ----------
  function drawMain(){
    const c = $("cMain");
    const {w,h} = getCSSSize(c);
    const {ctx} = setDPR(c, w, h);

    // Range in mm for plot
    const Xmax = state.Xmax_mm;
    const xMin = -Xmax, xMax = Xmax;
    const yMin = 0, yMax = 1.05;

    const axes = drawAxes(
      ctx,
      {x:0,y:0,w:w,h:h},
      xMin, xMax, yMin, yMax,
      "Screen position X (mm)",
      "Normalized intensity I/Imax",
      "Main Plot: Far-field intensity along Y = 0"
    );

    const {plot, xToPx, yToPx} = axes;

    // Compute curve
    const n = 900;
    let maxI = 0;
    const Xs = new Array(n);
    const Is = new Array(n);

    for(let i=0;i<n;i++){
      const Xmm = lerp(xMin, xMax, i/(n-1));
      const Xm = Xmm * 1e-3;
      const I = intensityRect(Xm, 0);
      Xs[i] = Xmm;
      Is[i] = I;
      if(I > maxI) maxI = I;
    }
    // Normalize to peak within window
    const eps = 1e-12;
    maxI = Math.max(maxI, eps);

    // Curve
    ctx.save();
    ctx.beginPath();
    for(let i=0;i<n;i++){
      const x = xToPx(Xs[i]);
      const y = yToPx(Is[i]/maxI);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.lineWidth = 2.2;
    ctx.strokeStyle = "rgba(125,211,252,0.95)";
    ctx.stroke();
    ctx.restore();

    // Predicted shift marker: X0 = d sinŒ∏
    const th = thetaRad();
    const x0m = state.d_m * Math.sin(th);
    const x0mm = x0m * 1e3;

    // marker line
    ctx.save();
    ctx.setLineDash([6,6]);
    ctx.strokeStyle = "rgba(52,211,153,0.85)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(xToPx(x0mm), plot.y);
    ctx.lineTo(xToPx(x0mm), plot.y + plot.h);
    ctx.stroke();
    ctx.restore();

    // legend
    ctx.save();
    const lx = plot.x + 12, ly = plot.y + 10;
    ctx.fillStyle = "rgba(0,0,0,0.35)";
    ctx.strokeStyle = "rgba(255,255,255,0.12)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.roundRect(lx, ly, 240, 54, 12);
    ctx.fill(); ctx.stroke();

    ctx.fillStyle = "rgba(125,211,252,0.95)";
    ctx.fillRect(lx+12, ly+14, 18, 4);
    ctx.fillStyle = "rgba(234,240,255,0.92)";
    ctx.font = "12.5px system-ui, -apple-system, Segoe UI, Roboto";
    ctx.fillText("I(X,0) for rectangular aperture", lx+38, ly+20);

    ctx.save();
    ctx.setLineDash([6,6]);
    ctx.strokeStyle = "rgba(52,211,153,0.85)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(lx+12, ly+38);
    ctx.lineTo(lx+30, ly+38);
    ctx.stroke();
    ctx.restore();
    ctx.fillStyle = "rgba(234,240,255,0.92)";
    ctx.fillText(`predicted center shift X0 = ${(x0mm).toFixed(2)} mm`, lx+38, ly+42);
    ctx.restore();

    // note: show a and d, theta
    ctx.save();
    ctx.fillStyle = "rgba(185,196,230,0.92)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    const txt = `Œª=633 nm, a=${state.a_mm.toFixed(2)} mm, b=${state.b_mm.toFixed(2)} mm, d=${state.d_m.toFixed(2)} m, Œ∏x=${state.theta_deg.toFixed(2)}¬∞`;
    ctx.fillText(txt, plot.x, plot.y + plot.h + 16);
    ctx.restore();
  }

  // ---------- Draw: Secondary 2D intensity map ----------
  function drawSecondary(){
    const c = $("cSecondary");
    const {w,h} = getCSSSize(c);
    const {ctx} = setDPR(c, w, h);

    // We'll render a heatmap inside the plot area with axes.
    const Xmax = state.Xmax_mm;
    const Ymax = state.Ymax_mm;

    const axes = drawAxes(
      ctx,
      {x:0,y:0,w:w,h:h},
      -Xmax, Xmax, -Ymax, Ymax,
      "X (mm)",
      "Y (mm)",
      "Secondary: 2D far-field intensity map"
    );

    const {plot, xToPx, yToPx} = axes;

    // Heatmap resolution (balanced for speed)
    const nx = 150, ny = 110;
    let maxI = 0;
    const Igrid = new Float32Array(nx*ny);

    for(let j=0;j<ny;j++){
      const ymm = lerp(Ymax, -Ymax, j/(ny-1)); // top to bottom
      const ym = ymm * 1e-3;
      for(let i=0;i<nx;i++){
        const xmm = lerp(-Xmax, Xmax, i/(nx-1));
        const xm = xmm * 1e-3;
        const I = intensityRect(xm, ym);
        Igrid[j*nx+i] = I;
        if(I > maxI) maxI = I;
      }
    }
    maxI = Math.max(maxI, 1e-12);

    // Draw pixels as imageData
    const imgW = nx, imgH = ny;
    const imageData = ctx.createImageData(imgW, imgH);
    for(let p=0;p<imgW*imgH;p++){
      // normalize and apply gentle gamma for contrast
      let v = Igrid[p]/maxI;
      v = Math.pow(v, 0.45);
      const r = Math.round(lerp(10, 180, v));
      const g = Math.round(lerp(12, 235, v));
      const b = Math.round(lerp(25, 255, v*0.85));
      const a = Math.round(lerp(25, 255, v));
      imageData.data[p*4+0] = r;
      imageData.data[p*4+1] = g;
      imageData.data[p*4+2] = b;
      imageData.data[p*4+3] = a;
    }

    // put to offscreen canvas to scale neatly
    const off = document.createElement("canvas");
    off.width = imgW; off.height = imgH;
    off.getContext("2d").putImageData(imageData,0,0);

    ctx.save();
    // clip to plot area
    ctx.beginPath();
    ctx.rect(plot.x, plot.y, plot.w, plot.h);
    ctx.clip();

    ctx.imageSmoothingEnabled = true;
    ctx.drawImage(off, plot.x, plot.y, plot.w, plot.h);

    // Overlay predicted center cross at (X0,0)
    const th = thetaRad();
    const x0mm = (state.d_m * Math.sin(th))*1e3;
    const cx = xToPx(x0mm);
    const cy = yToPx(0);

    ctx.strokeStyle = "rgba(255,255,255,0.75)";
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.moveTo(cx-10, cy);
    ctx.lineTo(cx+10, cy);
    ctx.moveTo(cx, cy-10);
    ctx.lineTo(cx, cy+10);
    ctx.stroke();

    ctx.restore();

    // Colorbar-esque legend
    ctx.save();
    const bx = plot.x + plot.w - 26;
    const by = plot.y + 12;
    const bw = 10, bh = plot.h - 24;

    // gradient
    const grd = ctx.createLinearGradient(0, by+bh, 0, by);
    grd.addColorStop(0, "rgba(10,12,25,0.25)");
    grd.addColorStop(0.25, "rgba(70,120,210,0.55)");
    grd.addColorStop(0.55, "rgba(125,211,252,0.80)");
    grd.addColorStop(1, "rgba(234,240,255,0.95)");
    ctx.fillStyle = grd;
    ctx.fillRect(bx, by, bw, bh);

    ctx.strokeStyle = "rgba(255,255,255,0.18)";
    ctx.strokeRect(bx, by, bw, bh);

    ctx.fillStyle = "rgba(185,196,230,0.95)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
    ctx.fillText("low", bx-26, by+bh+2);
    ctx.fillText("high", bx-30, by+10);
    ctx.restore();
  }

  // ---------- UI wiring ----------
  function syncUI(){
    $("vTheta").textContent = `${state.theta_deg.toFixed(2)}¬∞`;
    $("vA").textContent = `${state.a_mm.toFixed(2)} mm`;
    $("vD").textContent = `${state.d_m.toFixed(2)} m`;
  }

  function renderAll(){
    syncUI();
    drawDiagram();
    drawMain();
    drawSecondary();
  }

  function bindControls(){
    $("sTheta").addEventListener("input", (e)=>{
      state.theta_deg = parseFloat(e.target.value);
      renderAll();
    });
    $("sA").addEventListener("input", (e)=>{
      state.a_mm = parseFloat(e.target.value);
      renderAll();
    });
    $("sD").addEventListener("input", (e)=>{
      state.d_m = parseFloat(e.target.value);
      renderAll();
    });
  }

  // Copy buttons
  function bindCopy(){
    document.addEventListener("click", async (ev)=>{
      const btn = ev.target.closest(".copybtn");
      if(!btn) return;
      const text = btn.getAttribute("data-copy") || "";
      try{
        await navigator.clipboard.writeText(text);
        const old = btn.innerHTML;
        btn.innerHTML = "‚úÖ Copied";
        setTimeout(()=>btn.innerHTML = old, 900);
      }catch(err){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); }catch(e){}
        document.body.removeChild(ta);
        const old = btn.innerHTML;
        btn.innerHTML = "‚úÖ Copied";
        setTimeout(()=>btn.innerHTML = old, 900);
      }
    });
  }

  // Smooth scrolling TOC
  function bindTOC(){
    $("toc").addEventListener("click", (ev)=>{
      const a = ev.target.closest("a");
      if(!a) return;
      const href = a.getAttribute("href");
      if(!href || !href.startsWith("#")) return;
      ev.preventDefault();
      const el = document.querySelector(href);
      if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
    });
  }

  // Resize observer for crisp responsiveness
  function bindResize(){
    const canvases = ["cDiagram","cMain","cSecondary"].map(id=>$(id));
    const ro = new ResizeObserver(()=>renderAll());
    canvases.forEach(c=>ro.observe(c));
    window.addEventListener("orientationchange", ()=>setTimeout(renderAll, 200));
  }

  // polyfill for roundRect (older browsers)
  if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function (x, y, w, h, r) {
      const rr = Array.isArray(r) ? r : [r, r, r, r];
      const [r1,r2,r3,r4] = rr.map(v=>Math.max(0, Math.min(v, Math.min(w,h)/2)));
      this.beginPath();
      this.moveTo(x+r1, y);
      this.lineTo(x+w-r2, y);
      this.quadraticCurveTo(x+w, y, x+w, y+r2);
      this.lineTo(x+w, y+h-r3);
      this.quadraticCurveTo(x+w, y+h, x+w-r3, y+h);
      this.lineTo(x+r4, y+h);
      this.quadraticCurveTo(x, y+h, x, y+h-r4);
      this.lineTo(x, y+r1);
      this.quadraticCurveTo(x, y, x+r1, y);
      this.closePath();
      return this;
    };
  }

  // Init
  bindControls();
  bindCopy();
  bindTOC();
  bindResize();
  renderAll();

})();
</script>
</body>
</html>
