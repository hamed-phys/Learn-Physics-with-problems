<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Peak Gain Coefficient of a Semiconductor Optical Amplifier at T = 0 K</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#101a33;
      --ink:#e9eefc;
      --muted:#b7c2e6;
      --faint:#7f8ab8;
      --line:rgba(255,255,255,.10);
      --accent:#7cf7d4;
      --accent2:#7aa7ff;
      --warn:#ffcc66;
      --bad:#ff6b8a;
      --good:#7cf7d4;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(900px 500px at 20% 10%, rgba(122,167,255,.18), transparent 60%),
        radial-gradient(800px 500px at 85% 25%, rgba(124,247,212,.14), transparent 60%),
        radial-gradient(900px 700px at 50% 110%, rgba(255,204,102,.10), transparent 55%),
        var(--bg);
      line-height:1.55;
    }
    a{color:var(--accent2); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding:34px 18px 18px;
      max-width:1200px;
      margin:0 auto;
    }
    .title{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px 22px 18px;
      overflow:hidden;
      position:relative;
    }
    .title:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 120px at 20% 0%, rgba(124,247,212,.25), transparent 60%),
        radial-gradient(600px 120px at 80% 0%, rgba(122,167,255,.22), transparent 60%);
      filter: blur(8px);
      opacity:.8;
      pointer-events:none;
    }
    .title > *{position:relative; z-index:1}
    h1{
      margin:0;
      font-size: clamp(22px, 2.3vw, 34px);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      max-width: 90ch;
      font-size: 14.8px;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 60px;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:18px;
      align-items:start;
    }

    nav#toc{
      position:sticky;
      top:14px;
      align-self:start;
      background: rgba(16,26,51,.78);
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px 14px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    #toc h2{
      margin:2px 0 10px;
      font-size:13px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
    }
    #toc a{
      display:block;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid transparent;
      color:var(--ink);
      font-size:13.5px;
      line-height:1.2;
      opacity:.94;
    }
    #toc a:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.08);
      text-decoration:none;
    }
    #toc .mini{
      margin-top:10px;
      padding:10px;
      border-radius:14px;
      background: rgba(255,255,255,.04);
      border:1px dashed rgba(255,255,255,.10);
      color:var(--muted);
      font-size:12.5px;
    }

    article{
      display:flex;
      flex-direction:column;
      gap:14px;
      min-width:0;
    }

    section{
      background: rgba(16,26,51,.70);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px 18px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    section h2{
      margin:0 0 10px;
      font-size: 18px;
      letter-spacing:.2px;
    }
    section h3{
      margin:14px 0 8px;
      font-size: 15.5px;
      color: var(--ink);
    }
    p{margin: 8px 0; color: var(--ink)}
    ul{margin:8px 0 10px 22px; color: var(--ink)}
    li{margin:6px 0}
    .muted{color:var(--muted)}
    .faint{color:var(--faint)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
      nav#toc{position:relative; top:auto}
      .grid2,.grid3{grid-template-columns: 1fr}
    }

    .callout{
      border-radius:16px;
      padding:12px 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .callout strong{color:var(--muted)}
    .callout.assump{border-color: rgba(124,247,212,.22); background: rgba(124,247,212,.06)}
    .callout.keyeq{border-color: rgba(122,167,255,.22); background: rgba(122,167,255,.06)}
    .callout.mist{border-color: rgba(255,204,102,.24); background: rgba(255,204,102,.06)}
    .callout.final{border-color: rgba(124,247,212,.30); background: rgba(124,247,212,.08)}
    .badge{
      display:inline-block;
      font-size:11px;
      letter-spacing:.12em;
      text-transform:uppercase;
      padding:6px 9px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.05);
      color:var(--muted);
      margin-bottom:8px;
    }

    .eq{
      font-family: var(--mono);
      font-size: 13px;
      line-height:1.45;
      padding: 10px 10px;
      border-radius: 14px;
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      overflow:auto;
      position:relative;
    }
    .eq .copyBtn{
      position:absolute;
      right:8px; top:8px;
      font-family: var(--sans);
      font-size: 12px;
      padding:6px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      cursor:pointer;
      user-select:none;
    }
    .eq .copyBtn:hover{background: rgba(255,255,255,.10)}
    .eq .copied{
      position:absolute;
      right:8px; bottom:8px;
      font-family: var(--sans);
      font-size: 12px;
      color: var(--good);
      opacity:0;
      transform: translateY(4px);
      transition: .25s ease;
      pointer-events:none;
    }
    .eq.copiedShow .copied{opacity:1; transform: translateY(0)}

    figure{
      margin: 10px 0 0;
      padding: 10px 10px 12px;
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    figcaption{
      margin-top:10px;
      color: var(--muted);
      font-size: 12.5px;
    }

    .controls{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap:12px;
      align-items:start;
      margin: 8px 0 0;
    }
    @media (max-width: 980px){
      .controls{grid-template-columns:1fr}
    }
    .controlCard{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 12px;
    }
    .controlRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      margin: 10px 0;
    }
    label{
      font-size: 13px;
      color: var(--muted);
    }
    input[type="range"]{width:100%}
    select, button{
      font-family: var(--sans);
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      padding: 9px 10px;
    }
    button{cursor:pointer}
    button:hover{background: rgba(255,255,255,.10)}
    .tiny{
      font-size: 12px;
      color: var(--muted);
      margin-top: 6px;
    }
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top: 8px;
    }
    @media (max-width: 980px){ .kpi{grid-template-columns:1fr} }
    .kpi .box{
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      padding: 10px 10px;
    }
    .kpi .box .h{
      font-size: 11px;
      letter-spacing:.12em;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 4px;
    }
    .kpi .box .v{
      font-family: var(--mono);
      font-size: 13px;
      color: var(--ink);
      word-break: break-word;
    }

    footer{
      max-width:1200px;
      margin: 18px auto 0;
      padding: 0 18px 40px;
      color: var(--muted);
      font-size: 12.5px;
    }

    /* Print-friendly */
    @media print{
      body{background:#fff;color:#000}
      header,main,footer{max-width: 900px}
      nav#toc{display:none}
      section, .title{box-shadow:none; background:#fff; border:1px solid #ddd}
      .eq{background:#f7f7f7; border:1px solid #ddd}
      figure{background:#fff;border:1px solid #ddd}
      .eq .copyBtn{display:none}
    }

    /* subtle motion */
    @media (prefers-reduced-motion: no-preference){
      section{animation: fadeIn .35s ease both}
      @keyframes fadeIn{from{opacity:0; transform: translateY(6px)}to{opacity:1; transform: translateY(0)}}
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>18.2-2 — Peak Gain Coefficient of a Semiconductor Optical Amplifier at <span style="white-space:nowrap;">T = 0 K</span></h1>
    <p class="subtitle">
      We derive where the <span class="muted">material gain spectrum</span> peaks at zero temperature, obtain an analytical peak-gain formula versus injected carrier density,
      and reproduce the qualitative trends of the referenced figure using an interactive band-to-band gain model for InGaAsP at 1.3&nbsp;µm.
    </p>
  </div>
</header>

<main>
  <nav id="toc" aria-label="Table of contents">
    <h2>Contents</h2>
    <a href="#quick">Quick Summary</a>
    <a href="#part0">PART 0 — Concept Primer</a>
    <a href="#part1">PART 1 — Problem Analysis</a>
    <a href="#part2">PART 2 — Strategy & Tips</a>
    <a href="#part3">PART 3 — Full Solution</a>
    <a href="#part4">PART 4 — Deeper Understanding</a>
    <a href="#part5">PART 5 — Visualization Guide</a>
    <div class="mini">
      <div><span class="faint">Interactive:</span> change Δn and model scaling → all plots update.</div>
      <div class="faint" style="margin-top:6px">Tip: the peak occurs at the <b>gain cutoff edge</b> set by quasi-Fermi separation.</div>
    </div>
  </nav>

  <article>
    <section id="quick">
      <div class="badge">Quick Summary</div>
      <ul>
        <li><b>Problem:</b> Find where the <span class="muted">0 K gain spectrum</span> peaks, derive an analytic <b>peak gain</b> γ<sub>p</sub>(Δn), and plot γ<sub>p</sub> for InGaAsP (1.3&nbsp;µm).</li>
        <li><b>Key idea:</b> At <b>T = 0</b>, Fermi–Dirac functions become <b>step functions</b>. The gain is nonzero only up to a sharp cutoff set by the <b>quasi-Fermi level separation</b>.</li>
        <li><b>Governing structure:</b> For parabolic bands, band-to-band gain has the form
          <span class="muted">γ(ħω) ∝ √(ħω−E<sub>g</sub>) × (population inversion factor)</span>.</li>
        <li><b>Peak location:</b> The maximum occurs at the <b>upper edge</b> of the inversion window:
          <span class="muted">ν<sub>p</sub> = (E<sub>fc</sub>−E<sub>fv</sub>)/h</span>.</li>
        <li><b>Carrier-density link:</b> At 0 K,
          <span class="muted">E<sub>fc</sub>−E<sub>c</sub> ∝ Δn<sup>2/3</sup></span> and
          <span class="muted">E<sub>v</sub>−E<sub>fv</sub> ∝ Δn<sup>2/3</sup></span>,
          so the peak excess energy scales as Δn<sup>2/3</sup>, hence <b>γ<sub>p</sub> grows roughly like Δn<sup>1/3</sup></b> in this idealized model.</li>
        <li><b>Result type:</b> Symbolic expressions for ν<sub>p</sub> and γ<sub>p</sub>(Δn) + numerical interactive plots using the given InGaAsP parameters.</li>
      </ul>
    </section>

    <section id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <h3>Core definitions (symbols + units)</h3>
      <ul>
        <li><b>Material gain coefficient</b> γ(ν) [m<sup>−1</sup> or cm<sup>−1</sup>]: exponential amplification per length for an optical field at frequency ν.</li>
        <li><b>Photon energy</b> ħω = hν [J or eV].</li>
        <li><b>Bandgap</b> E<sub>g</sub> [J or eV], with reference wavelength λ<sub>0</sub> ≈ hc/E<sub>g</sub>.</li>
        <li><b>Quasi-Fermi levels</b> E<sub>fc</sub>, E<sub>fv</sub> [J or eV]: effective chemical potentials for electrons (conduction) and holes (valence) under injection.</li>
        <li><b>Effective masses</b> m<sub>c</sub>, m<sub>v</sub> [kg]; <b>reduced mass</b> m<sub>r</sub> = (m<sub>c</sub>m<sub>v</sub>)/(m<sub>c</sub>+m<sub>v</sub>).</li>
        <li><b>Injected carrier concentration</b> Δn [cm<sup>−3</sup>]: excess electrons ≈ excess holes in a (nearly) charge-neutral active region.</li>
      </ul>

      <h3>Physical meaning: what sets gain vs. photon energy?</h3>
      <p>
        Stimulated emission for a direct bandgap semiconductor requires an electron in a conduction state and an empty
        valence electron state (i.e., a hole). For each optical frequency ω, only transitions satisfying energy conservation
        contribute. Two things multiply:
      </p>
      <ul>
        <li><b>How many transitions exist</b> at that energy: the <b>joint density of states</b> (JDOS), which rises like √(ħω−E<sub>g</sub>) for 3D parabolic bands.</li>
        <li><b>How inverted those transitions are</b>: the occupation difference (population inversion factor) built from Fermi–Dirac functions.</li>
      </ul>

      <h3>Key laws / validity conditions</h3>
      <div class="callout assump">
        <strong>Model validity (what we assume in this problem):</strong>
        <ul>
          <li><b>Direct-gap</b> semiconductor (InGaAsP) with <b>parabolic</b> conduction and valence bands near k≈0.</li>
          <li><b>Quasi-equilibrium</b> under injection: electrons and holes each described by their own quasi-Fermi levels.</li>
          <li><b>T = 0 K idealization</b>: Fermi functions become sharp step functions (strongest “edge” behavior).</li>
          <li>We focus on <b>material gain spectrum shape</b>; absolute scale needs an optical matrix element / broadening model.
              The interactive plots use the standard √(ħω−E<sub>g</sub>) spectral shape and are scaled to match the referenced peak value at high injection.</li>
        </ul>
      </div>

      <h3>Common approximations and why we use them</h3>
      <ul>
        <li><b>Parabolic bands</b> → analytic JDOS ∝ √(ħω−E<sub>g</sub>).</li>
        <li><b>Charge neutrality</b> → Δn ≈ Δp, so E<sub>fc</sub> and E<sub>fv</sub> are both determined by one density parameter.</li>
        <li><b>0 K step occupations</b> → the inversion factor becomes a <b>hard energy window</b> (on/off), making peak location easy to prove.</li>
      </ul>

      <h3>Mini intuition examples</h3>
      <ul>
        <li><b>No injection:</b> valence band full, conduction band empty → absorption only (γ&lt;0).</li>
        <li><b>Strong injection:</b> conduction band filled up to E<sub>fc</sub>, holes fill the top of the valence band up to E<sub>fv</sub> → transitions are inverted up to energy <b>E<sub>fc</sub>−E<sub>fv</sub></b>, creating a gain band.</li>
      </ul>

      <h3>What to watch for (pitfalls)</h3>
      <div class="callout mist">
        <strong>Typical pitfalls:</strong>
        <ul>
          <li>Mixing <b>electron</b> occupancy in the valence band with <b>hole</b> occupancy (they are complements).</li>
          <li>Forgetting that a photon energy selects a single k via energy conservation in parabolic bands.</li>
          <li>Assuming the gain peak is at E<sub>g</sub>—it is not; it is controlled by the <b>quasi-Fermi separation</b>.</li>
          <li>At T=0 the spectrum has a sharp edge; real devices have temperature and broadening that smooth it.</li>
        </ul>
      </div>
    </section>

    <section id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Restatement (in plain words)</h3>
      <p>
        For a semiconductor optical amplifier (SOA) at <b>T = 0 K</b>, the gain spectrum γ<sub>0</sub>(ν) depends on the
        electron and hole quasi-Fermi levels. You must:
      </p>
      <ol>
        <li>Show that the <b>peak</b> of γ<sub>0</sub>(ν) occurs at <b>ν = (E<sub>fc</sub>−E<sub>fv</sub>)/h</b>.</li>
        <li>Derive an analytic expression for the <b>peak value</b> γ<sub>p</sub> as a function of injected carrier density Δn.</li>
        <li>Plot γ<sub>p</sub>(Δn) for InGaAsP at λ<sub>0</sub>=1300 nm with given n, τ<sub>r</sub>, m<sub>c</sub>, m<sub>v</sub>.</li>
        <li>Compare the trend to the provided figure (peak ~270 cm<sup>−1</sup> at the largest Δn shown).</li>
      </ol>

      <div class="grid2">
        <div class="callout">
          <strong>Given (for plotting):</strong>
          <ul>
            <li>λ<sub>0</sub> = 1300 nm  → E<sub>g</sub> ≈ hc/λ<sub>0</sub></li>
            <li>Refractive index n = 3.5</li>
            <li>Radiative lifetime parameter τ<sub>r</sub> = 2.5 ns</li>
            <li>m<sub>c</sub> = 0.06 m<sub>0</sub>, m<sub>v</sub> = 0.4 m<sub>0</sub></li>
            <li>Δn range: 1×10<sup>18</sup> to 2×10<sup>18</sup> cm<sup>−3</sup></li>
          </ul>
        </div>
        <div class="callout">
          <strong>Unknowns / outputs:</strong>
          <ul>
            <li>Peak frequency ν<sub>p</sub></li>
            <li>Peak gain γ<sub>p</sub>(Δn)</li>
            <li>Numerical plot γ<sub>p</sub> vs Δn</li>
            <li>Comparison commentary vs the figure trend</li>
          </ul>
        </div>
      </div>

      <h3>Relevant principles (and why)</h3>
      <ul>
        <li><b>Energy-conserving direct transitions:</b> ħω = E<sub>g</sub> + E<sub>e</sub>(k) + E<sub>h</sub>(k). This maps each ω to a k and thus to a JDOS.</li>
        <li><b>Fermi occupation factors:</b> stimulated emission ∝ (f<sub>c</sub> − f<sub>v</sub>) (equivalently f<sub>c</sub> + f<sub>h</sub> − 1).</li>
        <li><b>0 K limit:</b> f becomes a step → inversion becomes a sharp window in ħω; the gain peak becomes the window edge.</li>
      </ul>

      <h3>Assumptions (explicit)</h3>
      <div class="callout assump">
        <ul>
          <li>3D bulk-like JDOS with parabolic bands; no excitons; no many-body bandgap renormalization.</li>
          <li>Charge neutrality under injection: Δn ≈ Δp, so conduction and valence quasi-Fermi shifts are linked to the same Δn.</li>
          <li>At T=0, the population inversion factor is <b>1</b> inside the allowed window and <b>0</b> outside (ideal step).</li>
          <li>For plotting absolute γ, we use the standard √(ħω−E<sub>g</sub>) dependence and set the overall scale to match the figure’s stated peak value at the top of the Δn range (since the optical matrix element / broadening is not explicitly given).</li>
        </ul>
      </div>

      <h3>Possible approaches (compare)</h3>
      <ul>
        <li><b>Approach A: JDOS × inversion window (best for 0 K peak location)</b><br>
          Pros: clean, analytic, shows immediately why ν<sub>p</sub> is at E<sub>fc</sub>−E<sub>fv</sub>. Cons: absolute scaling needs a matrix element/broadening.</li>
        <li><b>Approach B: Detailed balance via absorption/spontaneous emission</b><br>
          Pros: can connect scale to recombination parameters. Cons: requires additional material parameters and a careful spectral model.</li>
        <li><b>Approach C: Full numerical gain from k-space integration</b><br>
          Pros: most realistic. Cons: heavy; defeats the “analytical at 0 K” goal.</li>
      </ul>
      <p><b>We choose Approach A</b> because the question’s core is the <b>peak location</b> and the <b>Δn dependence</b> at 0 K, both captured transparently by the inversion window + parabolic DOS model.</p>
    </section>

    <section id="part2">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>
      <ol>
        <li>
          <b>Write the band-to-band transition energy</b> for parabolic bands.<br>
          <span class="muted">Tool:</span> E(k)=ħ²k²/2m. <span class="muted">Meaning:</span> photon energy selects a single k-shell.
        </li>
        <li>
          <b>Write the gain spectrum structure</b> as JDOS × inversion factor.<br>
          <span class="muted">Tool:</span> JDOS for 3D parabolic bands ∝ √(ħω−E<sub>g</sub>). <span class="muted">Meaning:</span> available transitions increase with energy above bandgap.
        </li>
        <li>
          <b>Take the T = 0 limit</b> of Fermi factors → step functions.<br>
          <span class="muted">Tool:</span> f(E)=Θ(E<sub>F</sub>−E). <span class="muted">Meaning:</span> inversion becomes an “on/off” window in ω.
        </li>
        <li>
          <b>Identify the inversion window edge</b> and show the gain increases up to that edge.<br>
          <span class="muted">Tool:</span> monotonic √(ħω−E<sub>g</sub>). <span class="muted">Meaning:</span> maximum at the cutoff frequency.
        </li>
        <li>
          <b>Relate quasi-Fermi shifts to Δn</b> using 0 K electron and hole densities in 3D.<br>
          <span class="muted">Tool:</span> n = k<sub>F</sub>³/(3π²), E<sub>F</sub>=ħ²k<sub>F</sub>²/(2m). <span class="muted">Meaning:</span> quasi-Fermi separation grows with Δn.
        </li>
        <li>
          <b>Evaluate γ at the peak</b>: γ<sub>p</sub> = γ(ν<sub>p</sub>).<br>
          <span class="muted">Meaning:</span> peak depends on √(ε<sub>c</sub>+ε<sub>v</sub>) and a material scale factor.
        </li>
        <li>
          <b>Plot and compare</b> with the provided curve’s magnitude/trend.<br>
          <span class="muted">Tip:</span> the ideal 0 K model produces a sharp spectral edge; real data are smoother.
        </li>
      </ol>

      <div class="callout mist">
        <strong>Quick tips:</strong>
        <ul>
          <li>Keep a consistent energy reference: measure ε<sub>c</sub> from the conduction band edge and ε<sub>v</sub> from the valence band edge.</li>
          <li>The peak occurs at the <b>largest photon energy that is still inverted</b>, not necessarily where DOS is largest (DOS keeps increasing, but inversion shuts off).</li>
          <li>Convert units carefully: 1 m<sup>−1</sup> = 0.01 cm<sup>−1</sup>.</li>
        </ul>
      </div>
    </section>

    <section id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Physical intuition first (what we expect)</h3>
      <p>
        In a 3D direct-gap semiconductor, the number of available optical transitions grows with photon energy above E<sub>g</sub>.
        If the medium is inverted, higher-energy transitions would seem to give more gain. But inversion does <b>not</b> extend forever:
        once the photon energy exceeds the quasi-Fermi separation E<sub>fc</sub>−E<sub>fv</sub>, there are no longer both an occupied
        conduction state and an available valence empty state that satisfy energy conservation. So γ(ν) rises with ν and then
        <b>drops to zero</b> at a sharp cutoff. Therefore, the peak should sit at that cutoff.
      </p>

      <h3>Step 1 — Transition energy for parabolic bands</h3>
      <p>
        Let the conduction band edge be E<sub>c</sub> and valence band edge be E<sub>v</sub>, so E<sub>g</sub> = E<sub>c</sub> − E<sub>v</sub>.
        For a direct transition at wavevector k:
      </p>
      <div class="eq" data-copy="hν = Eg + Ee(k) + Eh(k),  with  Ee(k)=ħ²k²/(2mc),  Eh(k)=ħ²k²/(2mv).">
        <button class="copyBtn" title="Copy equation">Copy</button>
        hν = E_g + E_e(k) + E_h(k) <br/>
        with &nbsp; E_e(k)= ħ²k²/(2m_c), &nbsp; E_h(k)= ħ²k²/(2m_v)
        <div class="copied">Copied ✓</div>
      </div>
      <p class="muted">
        This means each photon energy selects a single k-shell (a single magnitude k) because E_e+E_h depends only on k².
      </p>

      <h3>Step 2 — The gain spectrum structure</h3>
      <p>
        The (material) gain spectrum for band-to-band transitions can be written as:
      </p>
      <div class="eq" data-copy="γ0(ν) = C(ν) · ρJ(ħω) · [fc(kω) − fv(kω)],   where ρJ ∝ √(ħω−Eg) for 3D parabolic bands.">
        <button class="copyBtn" title="Copy equation">Copy</button>
        γ₀(ν) = C(ν) · ρ_J(ħω) · [ f_c(k_ω) − f_v(k_ω) ] <br/>
        where ρ_J(ħω) ∝ √(ħω − E_g) &nbsp; (3D parabolic JDOS)
        <div class="copied">Copied ✓</div>
      </div>
      <p class="muted">
        Here C(ν) is a slowly varying prefactor containing optical matrix elements and refractive-index factors,
        and the bracketed term is the population inversion factor.
      </p>

      <h3>Step 3 — Evaluate the inversion factor at T = 0 K</h3>
      <p>
        At zero temperature, the Fermi–Dirac occupation becomes a step function:
        f(E)=Θ(E<sub>F</sub>−E). Under injection we have quasi-Fermi levels E<sub>fc</sub> (electrons) and E<sub>fv</sub> (holes).
      </p>

      <p>
        For a given k (hence a given photon energy), define:
      </p>
      <ul>
        <li>Conduction electron energy: E<sub>c</sub>(k) = E<sub>c</sub> + E<sub>e</sub>(k)</li>
        <li>Valence electron energy: E<sub>v</sub>(k) = E<sub>v</sub> − E<sub>h</sub>(k)</li>
      </ul>

      <p>
        At T=0:
      </p>
      <div class="eq" data-copy="fc = Θ(Efc − [Ec + Ee(k)]).   Valence-electron occupancy fv = Θ([Ev − Eh(k)] − Efv).   Inversion factor (fc − fv).">
        <button class="copyBtn" title="Copy equation">Copy</button>
        f_c(k) = Θ( E_fc − [E_c + E_e(k)] ) <br/>
        f_v(k) = Θ( [E_v − E_h(k)] − E_fv ) <br/>
        inversion factor: &nbsp; f_c(k) − f_v(k)
        <div class="copied">Copied ✓</div>
      </div>

      <p>
        Gain requires an <b>occupied</b> conduction state and an <b>empty</b> valence-electron state (i.e., a hole).
        At T=0, that means:
      </p>
      <ul>
        <li>Occupied conduction state: E<sub>c</sub>+E<sub>e</sub>(k) ≤ E<sub>fc</sub></li>
        <li>Empty valence electron state: E<sub>v</sub>−E<sub>h</sub>(k) ≥ E<sub>fv</sub></li>
      </ul>

      <p>
        Combine them:
      </p>
      <div class="eq" data-copy="Ec + Ee(k) ≤ Efc  and  Ev − Eh(k) ≥ Efv  ⇒  Eg + Ee(k) + Eh(k) ≤ Efc − Efv.">
        <button class="copyBtn" title="Copy equation">Copy</button>
        E_c + E_e(k) ≤ E_fc  and  E_v − E_h(k) ≥ E_fv <br/>
        ⇒ (E_c − E_v) + E_e(k) + E_h(k) ≤ E_fc − E_fv <br/>
        ⇒ E_g + E_e(k) + E_h(k) ≤ E_fc − E_fv
        <div class="copied">Copied ✓</div>
      </div>

      <p>
        But by energy conservation, the left-hand side equals hν. Therefore the inversion factor is nonzero only when:
      </p>
      <div class="eq" data-copy="hν ≤ Efc − Efv.  Thus the gain spectrum is truncated at νp = (Efc − Efv)/h.">
        <button class="copyBtn" title="Copy equation">Copy</button>
        hν ≤ (E_fc − E_fv) <br/>
        ⇒ ν ≤ ν_p = (E_fc − E_fv)/h
        <div class="copied">Copied ✓</div>
      </div>

      <div class="callout final">
        <strong>(a) Peak location:</strong>
        <p style="margin:8px 0 0">
          At <b>T = 0 K</b>, γ₀(ν) increases with ν through the √(ħω−E_g) JDOS factor but then <b>cuts off sharply</b> when ν exceeds the
          inversion limit. Therefore the peak occurs at the cutoff:
        </p>
        <div class="eq" data-copy="νp = (Efc − Efv)/h.">
          <button class="copyBtn" title="Copy final answer">Copy</button>
          <b>ν_p = (E_fc − E_fv)/h</b>
          <div class="copied">Copied ✓</div>
        </div>
      </div>

      <h3>Step 4 — Relate E<sub>fc</sub> and E<sub>fv</sub> to Δn at T = 0 K</h3>
      <p>
        Define the conduction quasi-Fermi shift (measured upward from the conduction band edge) and the valence quasi-Fermi shift
        (measured downward from the valence band edge):
      </p>
      <div class="eq" data-copy="εc ≡ Efc − Ec ≥ 0,   εv ≡ Ev − Efv ≥ 0.   Then Efc − Efv = Eg + εc + εv.">
        <button class="copyBtn">Copy</button>
        ε_c ≡ E_fc − E_c ≥ 0, &nbsp; ε_v ≡ E_v − E_fv ≥ 0 <br/>
        ⇒ E_fc − E_fv = E_g + ε_c + ε_v
        <div class="copied">Copied ✓</div>
      </div>

      <p>
        At T=0, the carrier density in a 3D parabolic band is determined by the Fermi wavevector:
        n = k<sub>F</sub><sup>3</sup>/(3π²), and the Fermi energy is ε = ħ²k<sub>F</sub>²/(2m).
        Assuming charge neutrality under injection: n ≈ p ≈ Δn, we get:
      </p>
      <div class="eq" data-copy="kF = (3π²Δn)^(1/3).  εc = ħ²kF²/(2mc).  εv = ħ²kF²/(2mv).">
        <button class="copyBtn">Copy</button>
        k_F = (3π² Δn)^(1/3) <br/>
        ε_c = ħ² k_F² / (2 m_c), &nbsp; ε_v = ħ² k_F² / (2 m_v)
        <div class="copied">Copied ✓</div>
      </div>

      <p>
        So the quasi-Fermi separation (and thus the peak photon energy) is:
      </p>
      <div class="eq" data-copy="hνp = Eg + εc + εv = Eg + (ħ²/2)(3π²Δn)^(2/3)(1/mc + 1/mv).">
        <button class="copyBtn">Copy</button>
        hν_p = E_g + ε_c + ε_v <br/>
        = E_g + (ħ²/2) (3π² Δn)^(2/3) ( 1/m_c + 1/m_v )
        <div class="copied">Copied ✓</div>
      </div>

      <h3>Step 5 — Peak gain value γ<sub>p</sub>(Δn)</h3>
      <p>
        In the ideal 0 K, parabolic-band model the gain spectrum inside the inversion window has the characteristic shape:
      </p>
      <div class="eq" data-copy="γ0(ħω) = A · √(ħω − Eg)  for  Eg ≤ ħω ≤ (Efc − Efv),  and  γ0 = 0 above that.">
        <button class="copyBtn">Copy</button>
        γ₀(ħω) = A · √(ħω − E_g) &nbsp;&nbsp; for &nbsp; E_g ≤ ħω ≤ (E_fc − E_fv) <br/>
        γ₀(ħω) = 0 &nbsp;&nbsp; for &nbsp; ħω &gt; (E_fc − E_fv)
        <div class="copied">Copied ✓</div>
      </div>

      <p class="muted">
        Here A collects the optical matrix element, refractive index factors, and any assumed (implicit) lineshape/broadening model.
        The question provides n and τ<sub>r</sub>, but the optical matrix element/broadening needed to predict absolute gain without ambiguity is not fully specified in the prompt.
        Therefore, for the numeric plots we use the standard spectral dependence and set A such that γ<sub>p</sub> matches the figure’s stated peak (≈270 cm⁻¹) at Δn = 2×10¹⁸ cm⁻³.
      </p>

      <p>
        The peak occurs at ħω = hν<sub>p</sub> = E<sub>g</sub> + ε<sub>c</sub> + ε<sub>v</sub>, so:
      </p>
      <div class="callout final">
        <strong>(b) Analytical peak-gain expression (0 K parabolic-band shape):</strong>
        <div class="eq" data-copy="γp(Δn) = A · √(εc + εv) = A · √[ (ħ²/2)(3π²Δn)^(2/3)(1/mc + 1/mv) ].">
          <button class="copyBtn">Copy</button>
          <b>γ_p(Δn) = A · √(ε_c + ε_v)</b> <br/>
          = A · √[ (ħ²/2) (3π²Δn)^(2/3) ( 1/m_c + 1/m_v ) ]
          <div class="copied">Copied ✓</div>
        </div>
        <p class="muted" style="margin:8px 0 0">
          Scaling insight: since (ε_c+ε_v) ∝ Δn^(2/3), we have <b>γ_p ∝ Δn^(1/3)</b> in this idealized 0 K model.
        </p>
      </div>

      <h3>Sanity checks</h3>
      <ul>
        <li><b>Units:</b> √(energy) carries √J; A must therefore carry (length⁻¹)/√J to make γ in length⁻¹.</li>
        <li><b>Limiting case Δn → 0:</b> ε_c, ε_v → 0, so γ_p → 0 (no inversion window beyond the band edge).</li>
        <li><b>Sign:</b> within the inversion window the spectrum is positive (gain); above it drops to zero at 0 K.</li>
        <li><b>Physical interpretation:</b> increasing Δn pushes E_fc up and E_fv down, widening the inversion window and increasing the highest-energy inverted transitions, which raises the peak.</li>
      </ul>
    </section>

    <section id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpreting the final formulas</h3>
      <ul>
        <li><b>ν<sub>p</sub> = (E<sub>fc</sub>−E<sub>fv</sub>)/h</b>: the peak sits at the <b>edge</b> of allowed stimulated transitions. It is a “Fermi-edge peak,” not a resonance peak.</li>
        <li><b>hν<sub>p</sub> = E<sub>g</sub> + ε<sub>c</sub> + ε<sub>v</sub></b>: injection shifts both quasi-Fermi levels into their bands; both contribute to the emitted photon energy at the cutoff.</li>
        <li><b>γ<sub>p</sub>(Δn) = A √(ε<sub>c</sub>+ε<sub>v</sub>)</b>: the JDOS growth (√excess energy) controls the peak height in this model; the inversion factor is already “maxed out” (1) inside the window at 0 K.</li>
      </ul>

      <h3>How parameters affect outcomes (connect to plots)</h3>
      <ul>
        <li>Increasing <b>Δn</b> increases k<sub>F</sub> ∝ Δn<sup>1/3</sup>, hence ε<sub>c</sub>, ε<sub>v</sub> ∝ Δn<sup>2/3</sup>. The gain curve’s cutoff moves to higher energy, and the peak rises.</li>
        <li>Larger <b>m<sub>c</sub></b> (heavier electrons) reduces ε<sub>c</sub> for the same Δn → smaller ν<sub>p</sub> and γ<sub>p</sub>.</li>
        <li>Larger <b>m<sub>v</sub></b> similarly reduces ε<sub>v</sub>.</li>
        <li>The prefactor A depends on optical matrix elements, refractive index, and broadening; it sets the <b>absolute gain scale</b> but not the <b>peak-location logic</b>.</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        One can derive the cutoff condition by requiring simultaneously:
        (i) energy conservation for transitions at k, and (ii) Pauli-allowed stimulated emission:
        f<sub>c</sub>(k)=1 and (1−f<sub>v</sub>(k))=1 at T=0. This directly yields
        E<sub>g</sub>+E<sub>e</sub>(k)+E<sub>h</sub>(k) ≤ E<sub>fc</sub>−E<sub>fv</sub>, hence ν≤(E<sub>fc</sub>−E<sub>fv</sub>)/h.
      </p>

      <h3>Concept checks (with answers)</h3>
      <ul>
        <li><b>Q:</b> Why doesn’t the peak occur at the maximum JDOS? <b>A:</b> JDOS keeps increasing, but inversion ends sharply at hν = E<sub>fc</sub>−E<sub>fv</sub>, truncating the spectrum.</li>
        <li><b>Q:</b> What changes at finite temperature? <b>A:</b> Step functions smear into smooth Fermi tails; the cutoff becomes a roll-off, and the “peak” becomes less sharp and may shift slightly depending on broadening.</li>
        <li><b>Q:</b> If m<sub>c</sub> decreases, what happens to ν<sub>p</sub>? <b>A:</b> ε<sub>c</sub> increases for the same Δn, so ν<sub>p</sub> increases.</li>
        <li><b>Q:</b> Does ν<sub>p</sub> depend on refractive index n? <b>A:</b> Not in the cutoff condition; n affects the gain scale (prefactor) but not the quasi-Fermi separation.</li>
      </ul>

      <h3>(d) Comparison with the provided figure</h3>
      <p>
        The referenced Fig. 18.2-3(b) shows peak gain rising strongly with Δn, reaching about <b>270 cm<sup>−1</sup></b> near
        Δn ≈ 2×10<sup>18</sup> cm<sup>−3</sup>. The ideal 0 K parabolic-band model predicts a monotonic increase and a
        “convex upward” behavior when plotted over a limited Δn range (because ν<sub>p</sub> and γ<sub>p</sub> depend on Δn through powers of Δn).
        In real materials, additional effects (bandgap renormalization, many-body gain enhancement, nonparabolicity, broadening, Auger processes)
        alter both the spectral shape and scaling; this is why practical curves can look more strongly curved than a pure Δn<sup>1/3</sup> trend.
      </p>
      <div class="callout">
        <strong>How we make the numeric comparison here:</strong>
        <p style="margin:8px 0 0" class="muted">
          Because the prompt does not explicitly provide the interband momentum matrix element (or an equivalent parameter like Kane energy E<sub>p</sub>)
          and a linewidth model, the plots use the correct <b>0 K cutoff/peak logic</b> and the √(ħω−E<sub>g</sub>) JDOS shape, while scaling the amplitude so that
          γ<sub>p</sub>(2×10<sup>18</sup> cm<sup>−3</sup>) ≈ 270 cm<sup>−1</sup> (matching the figure caption). You can change this scaling with the control below.
        </p>
      </div>
    </section>

    <section id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <div class="controls">
        <div class="controlCard">
          <div class="badge">Interactive Controls</div>

          <div class="controlRow">
            <div>
              <label for="dnSlider">Injected carrier concentration Δn (×10<sup>18</sup> cm<sup>−3</sup>)</label>
              <div class="tiny">Moves quasi-Fermi levels → shifts cutoff energy and raises/lowers the peak gain.</div>
            </div>
            <div style="font-family:var(--mono); font-size:13px;" id="dnRead">1.50</div>
          </div>
          <input id="dnSlider" type="range" min="1.0" max="2.0" step="0.01" value="1.50"/>

          <div class="controlRow">
            <div>
              <label for="scaleMode">Gain scale mode</label>
              <div class="tiny">Either match the figure at Δn=2×10<sup>18</sup> (auto), or choose A manually.</div>
            </div>
            <select id="scaleMode">
              <option value="auto" selected>Auto-calibrate to γp(2e18)=270 cm⁻¹</option>
              <option value="manual">Manual A (relative scale)</option>
            </select>
          </div>

          <div class="controlRow" id="aRow" style="opacity:.6">
            <div>
              <label for="aSlider">Manual amplitude A (relative)</label>
              <div class="tiny">This multiplies the whole γ(ħω) curve (shape unchanged).</div>
            </div>
            <div style="font-family:var(--mono); font-size:13px;" id="aRead">1.00</div>
          </div>
          <input id="aSlider" type="range" min="0.3" max="2.2" step="0.01" value="1.00" style="opacity:.6" />

          <div class="controlRow">
            <div>
              <label for="unitsSel">Gain units</label>
              <div class="tiny">Switch between cm⁻¹ and m⁻¹ (plots update labels).</div>
            </div>
            <select id="unitsSel">
              <option value="cm" selected>cm⁻¹</option>
              <option value="m">m⁻¹</option>
            </select>
          </div>

          <div class="tiny">
            Notes: λ<sub>0</sub>, n, τ<sub>r</sub>, m<sub>c</sub>, m<sub>v</sub> are fixed to the values in the prompt for this visualization.
            τ<sub>r</sub> is displayed in the KPI box for reference; in this simplified spectral-shape model it does not uniquely determine the amplitude without an explicit matrix element/linewidth parameter.
          </div>
        </div>

        <div class="controlCard">
          <div class="badge">Live Computed Values</div>
          <div class="kpi">
            <div class="box">
              <div class="h">E<sub>g</sub> from λ<sub>0</sub></div>
              <div class="v" id="egOut">—</div>
            </div>
            <div class="box">
              <div class="h">Peak photon energy hν<sub>p</sub></div>
              <div class="v" id="hvpOut">—</div>
            </div>
            <div class="box">
              <div class="h">Peak gain γ<sub>p</sub></div>
              <div class="v" id="gpOut">—</div>
            </div>
            <div class="box">
              <div class="h">ε<sub>c</sub>, ε<sub>v</sub> (Fermi shifts)</div>
              <div class="v" id="epsOut">—</div>
            </div>
            <div class="box">
              <div class="h">ν<sub>p</sub></div>
              <div class="v" id="vpOut">—</div>
            </div>
            <div class="box">
              <div class="h">Parameters (fixed)</div>
              <div class="v" id="paramOut">—</div>
            </div>
          </div>
        </div>
      </div>

      <figure>
        <canvas id="diag" style="width:100%; height:320px; display:block;"></canvas>
        <figcaption>
          <b>Diagram:</b> SOA active region band diagram showing E<sub>c</sub>, E<sub>v</sub>, quasi-Fermi levels E<sub>fc</sub>, E<sub>fv</sub>, and the peak transition
          energy hν<sub>p</sub> = E<sub>fc</sub> − E<sub>fv</sub>.
        </figcaption>
      </figure>

      <div class="grid2">
        <figure>
          <canvas id="plotMain" style="width:100%; height:320px; display:block;"></canvas>
          <figcaption>
            <b>Main plot:</b> peak gain γ<sub>p</sub> versus injected carrier density Δn in the range 1–2×10<sup>18</sup> cm<sup>−3</sup>.
          </figcaption>
        </figure>

        <figure>
          <canvas id="plotSpec" style="width:100%; height:320px; display:block;"></canvas>
          <figcaption>
            <b>Secondary plot:</b> gain spectrum γ(ħω) vs photon energy for the selected Δn, showing the sharp 0 K cutoff/peak at hν<sub>p</sub>.
          </figcaption>
        </figure>
      </div>

      <h3>What each canvas shows</h3>
      <ul>
        <li><b>Band diagram:</b> illustrates why the maximum photon energy for inverted transitions is E<sub>fc</sub>−E<sub>fv</sub>.</li>
        <li><b>γ<sub>p</sub> vs Δn:</b> shows how increasing injection raises the peak gain in this idealized model.</li>
        <li><b>Spectrum γ(ħω):</b> shows the √(ħω−E<sub>g</sub>) rise and the abrupt cutoff at the quasi-Fermi separation.</li>
      </ul>

      <h3>How the interactive controls affect the plots</h3>
      <ul>
        <li><b>Δn slider:</b> changes ε<sub>c</sub>, ε<sub>v</sub> (via 0 K Fermi relations), so the cutoff energy hν<sub>p</sub> shifts and γ<sub>p</sub> changes.</li>
        <li><b>Scale mode / A slider:</b> changes the overall gain magnitude (vertical scaling) but preserves the theoretical peak location result.</li>
        <li><b>Unit selector:</b> converts between cm⁻¹ and m⁻¹ consistently on axes and KPI values.</li>
      </ul>
    </section>
  </article>
</main>

<footer>
  <p>
    Built as a self-contained learning article (vanilla HTML/CSS/JS). The interactive plots implement the <b>0 K inversion-window + 3D parabolic JDOS</b> model,
    which rigorously proves the peak location ν<sub>p</sub> = (E<sub>fc</sub>−E<sub>fv</sub>)/h. Absolute gain magnitude generally requires an explicit optical matrix element and linewidth model;
    here it is scaled to match the provided figure’s peak value at the top of the Δn range for visual comparison.
  </p>
</footer>

<script>
/* =========================
   Utilities
========================= */
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function lerp(a,b,t){ return a + (b-a)*t; }
function niceStep(span){
  // very small "nice tick step" helper
  const p = Math.pow(10, Math.floor(Math.log10(span)));
  const n = span/p;
  if(n<2) return 0.2*p;
  if(n<5) return 0.5*p;
  return 1*p;
}
function formatSI(x, unit){
  if(!isFinite(x)) return "—";
  const ax = Math.abs(x);
  if(ax===0) return "0 " + unit;
  const prefixes = [
    {p:1e-12,s:"p"}, {p:1e-9,s:"n"}, {p:1e-6,s:"µ"}, {p:1e-3,s:"m"},
    {p:1,s:""}, {p:1e3,s:"k"}, {p:1e6,s:"M"}, {p:1e9,s:"G"}, {p:1e12,s:"T"}
  ];
  let best = prefixes[4];
  for(const pr of prefixes){
    if(ax/pr.p >= 0.9 && ax/pr.p < 900){ best = pr; break; }
    best = pr;
  }
  const v = x/best.p;
  const digits = (Math.abs(v) < 10) ? 3 : (Math.abs(v) < 100 ? 2 : 1);
  return v.toFixed(digits) + " " + best.s + unit;
}
function toFixedSmart(x){
  if(!isFinite(x)) return "—";
  const ax = Math.abs(x);
  if(ax>=1000) return x.toFixed(0);
  if(ax>=100) return x.toFixed(1);
  if(ax>=10) return x.toFixed(2);
  return x.toFixed(3);
}
function J_to_eV(J){ return J / 1.602176634e-19; }
function eV_to_J(eV){ return eV * 1.602176634e-19; }

/* HiDPI canvas setup */
function setupCanvas(canvas){
  const ctx = canvas.getContext("2d");
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(2, Math.floor(rect.width * dpr));
    canvas.height = Math.max(2, Math.floor(rect.height * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {w: rect.width, h: rect.height, dpr};
  }
  return {ctx, resize};
}

/* =========================
   Physics model (idealized 0 K shape)
========================= */
const constants = {
  h: 6.62607015e-34,
  hbar: 1.054571817e-34,
  c: 299792458,
  m0: 9.1093837015e-31,
  e: 1.602176634e-19
};

const params = {
  lambda0: 1300e-9,
  n: 3.5,
  tau_r: 2.5e-9,
  mc: 0.06 * constants.m0,
  mv: 0.4 * constants.m0
};

function Eg_J(){
  return constants.h * constants.c / params.lambda0;
}

function fermiShiftsFromDn(dn_cm3){
  // dn in cm^-3 -> m^-3
  const dn_m3 = dn_cm3 * 1e6;
  const kF = Math.pow(3*Math.PI*Math.PI*dn_m3, 1/3);
  const eps_c = constants.hbar*constants.hbar * kF*kF / (2*params.mc);
  const eps_v = constants.hbar*constants.hbar * kF*kF / (2*params.mv);
  return {kF, eps_c, eps_v};
}

function peakPhotonEnergy_J(dn_cm3){
  const Eg = Eg_J();
  const {eps_c, eps_v} = fermiShiftsFromDn(dn_cm3);
  return Eg + eps_c + eps_v;
}

function peakFrequency_Hz(dn_cm3){
  return peakPhotonEnergy_J(dn_cm3) / constants.h;
}

/* Gain model:
   γ(ħω) = A * sqrt(ħω - Eg) for Eg <= ħω <= hνp, else 0.
   γp = A * sqrt(εc + εv).
*/
function modelGainSpectrum(dn_cm3, A_SI, energies_J){
  const Eg = Eg_J();
  const {eps_c, eps_v} = fermiShiftsFromDn(dn_cm3);
  const Emax = Eg + eps_c + eps_v;
  const out = [];
  for(const E of energies_J){
    if(E < Eg) out.push(0);
    else if(E <= Emax) out.push(A_SI * Math.sqrt(Math.max(0, E - Eg)));
    else out.push(0);
  }
  return {out, Eg, Emax, eps_c, eps_v};
}

function computeA_auto(targetGp_cmInv){
  // choose A so that γp(dn_ref)=target
  const dn_ref = 2.0e18; // cm^-3
  const {eps_c, eps_v} = fermiShiftsFromDn(dn_ref);
  const root = Math.sqrt(eps_c + eps_v); // sqrt(J)
  // γp = A * root
  const targetGp_mInv = targetGp_cmInv * 100; // cm^-1 -> m^-1
  return targetGp_mInv / root; // (m^-1)/sqrt(J)
}

/* =========================
   Plotting helpers
========================= */
function drawAxes(ctx, x0,y0,w,h, xMin,xMax,yMin,yMax, xLabel,yLabel, title){
  ctx.save();
  // panel
  ctx.fillStyle = "rgba(0,0,0,0.18)";
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 1;
  roundRect(ctx,x0,y0,w,h,14,true,true);

  // title
  ctx.fillStyle = "rgba(233,238,252,0.95)";
  ctx.font = "600 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText(title, x0+12, y0+18);

  const padL=52, padR=16, padT=30, padB=44;
  const px0 = x0+padL, py0 = y0+padT;
  const pw = w - padL - padR, ph = h - padT - padB;

  // grid + ticks
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.fillStyle = "rgba(183,194,230,0.9)";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas";
  ctx.lineWidth = 1;

  const xSpan = xMax-xMin, ySpan = yMax-yMin;
  const xStep = niceStep(xSpan/5);
  const yStep = niceStep(ySpan/5);

  // vertical grid
  for(let x = Math.ceil(xMin/xStep)*xStep; x<=xMax+1e-12; x+=xStep){
    const t = (x-xMin)/xSpan;
    const X = px0 + t*pw;
    ctx.beginPath();
    ctx.moveTo(X, py0);
    ctx.lineTo(X, py0+ph);
    ctx.stroke();

    // tick label
    ctx.fillText(toFixedSmart(x), X-10, py0+ph+16);
  }
  // horizontal grid
  for(let y = Math.ceil(yMin/yStep)*yStep; y<=yMax+1e-12; y+=yStep){
    const t = (y-yMin)/ySpan;
    const Y = py0+ph - t*ph;
    ctx.beginPath();
    ctx.moveTo(px0, Y);
    ctx.lineTo(px0+pw, Y);
    ctx.stroke();

    ctx.fillText(toFixedSmart(y), x0+10, Y+4);
  }

  // axes lines
  ctx.strokeStyle = "rgba(255,255,255,0.35)";
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.moveTo(px0, py0+ph);
  ctx.lineTo(px0+pw, py0+ph);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(px0, py0);
  ctx.lineTo(px0, py0+ph);
  ctx.stroke();

  // labels
  ctx.fillStyle = "rgba(183,194,230,0.95)";
  ctx.font = "12.5px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText(xLabel, px0 + pw/2 - ctx.measureText(xLabel).width/2, y0 + h - 14);

  ctx.save();
  ctx.translate(x0+16, py0 + ph/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
  ctx.restore();

  ctx.restore();
  return {px0, py0, pw, ph};
}
function roundRect(ctx,x,y,w,h,r,fill,stroke){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}
function plotLine(ctx, frame, xs, ys, xMin,xMax,yMin,yMax, style){
  const {px0,py0,pw,ph} = frame;
  const xSpan=xMax-xMin, ySpan=yMax-yMin;
  ctx.save();
  ctx.strokeStyle = style.stroke || "rgba(124,247,212,0.95)";
  ctx.lineWidth = style.width || 2.0;
  ctx.beginPath();
  for(let i=0;i<xs.length;i++){
    const tX = (xs[i]-xMin)/xSpan;
    const tY = (ys[i]-yMin)/ySpan;
    const X = px0 + tX*pw;
    const Y = py0 + ph - tY*ph;
    if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  }
  ctx.stroke();
  ctx.restore();
}
function drawLegend(ctx, x, y, items){
  ctx.save();
  ctx.font = "12.5px ui-sans-serif, system-ui";
  let yy=y;
  for(const it of items){
    ctx.strokeStyle = it.color;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x, yy);
    ctx.lineTo(x+18, yy);
    ctx.stroke();
    ctx.fillStyle = "rgba(233,238,252,0.92)";
    ctx.fillText(it.label, x+24, yy+4);
    yy += 16;
  }
  ctx.restore();
}

/* =========================
   Canvases
========================= */
const diagC = setupCanvas(document.getElementById("diag"));
const mainC = setupCanvas(document.getElementById("plotMain"));
const specC = setupCanvas(document.getElementById("plotSpec"));

/* =========================
   UI
========================= */
const dnSlider = document.getElementById("dnSlider");
const dnRead = document.getElementById("dnRead");
const scaleMode = document.getElementById("scaleMode");
const aSlider = document.getElementById("aSlider");
const aRead = document.getElementById("aRead");
const unitsSel = document.getElementById("unitsSel");
const aRow = document.getElementById("aRow");

const egOut = document.getElementById("egOut");
const hvpOut = document.getElementById("hvpOut");
const gpOut = document.getElementById("gpOut");
const epsOut = document.getElementById("epsOut");
const vpOut = document.getElementById("vpOut");
const paramOut = document.getElementById("paramOut");

/* =========================
   Copy buttons
========================= */
function installCopyButtons(){
  document.querySelectorAll(".eq").forEach(eq=>{
    const btn = eq.querySelector(".copyBtn");
    if(!btn) return;
    btn.addEventListener("click", async ()=>{
      const text = eq.getAttribute("data-copy") || eq.innerText.replace(/\s+\n/g,"\n").trim();
      try{
        await navigator.clipboard.writeText(text);
        eq.classList.add("copiedShow");
        setTimeout(()=>eq.classList.remove("copiedShow"), 900);
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        eq.classList.add("copiedShow");
        setTimeout(()=>eq.classList.remove("copiedShow"), 900);
      }
    });
  });
}
installCopyButtons();

/* =========================
   Drawing: band diagram
========================= */
function drawBandDiagram(state){
  const {ctx, resize} = diagC;
  const {w,h} = resize();
  ctx.clearRect(0,0,w,h);

  // background panel
  ctx.fillStyle = "rgba(0,0,0,0.18)";
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 1;
  roundRect(ctx, 10, 10, w-20, h-20, 16, true, true);

  const pad=30;
  const x0=pad, y0=pad+10, W=w-2*pad, H=h-2*pad-10;

  // axes-esque frame
  ctx.strokeStyle = "rgba(255,255,255,0.12)";
  ctx.beginPath();
  ctx.moveTo(x0+50, y0);
  ctx.lineTo(x0+50, y0+H);
  ctx.stroke();

  // energy scale mapping (eV)
  const Eg_eV = J_to_eV(state.Eg);
  const epsc_eV = J_to_eV(state.eps_c);
  const epsv_eV = J_to_eV(state.eps_v);
  const sep_eV = Eg_eV + epsc_eV + epsv_eV;

  // choose plotted energy window
  const Etop = Eg_eV + epsc_eV + 0.35;
  const Ebot = - (epsv_eV + 0.35);

  function yFromE(EeV){
    const t = (EeV - Ebot)/(Etop - Ebot);
    return y0 + H - t*H;
  }

  const yEc = yFromE(Eg_eV/2);
  const yEv = yFromE(-Eg_eV/2);
  const yEfc = yFromE(Eg_eV/2 + epsc_eV);
  const yEfv = yFromE(-Eg_eV/2 - epsv_eV);

  // bands
  ctx.lineWidth = 3;
  ctx.strokeStyle = "rgba(122,167,255,0.95)";
  ctx.beginPath();
  ctx.moveTo(x0+80, yEc);
  ctx.lineTo(x0+W-10, yEc);
  ctx.stroke();
  ctx.strokeStyle = "rgba(124,247,212,0.95)";
  ctx.beginPath();
  ctx.moveTo(x0+80, yEv);
  ctx.lineTo(x0+W-10, yEv);
  ctx.stroke();

  // quasi-Fermi levels
  ctx.setLineDash([6,5]);
  ctx.lineWidth = 2;
  ctx.strokeStyle = "rgba(255,255,255,0.65)";
  ctx.beginPath(); ctx.moveTo(x0+80, yEfc); ctx.lineTo(x0+W-10, yEfc); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x0+80, yEfv); ctx.lineTo(x0+W-10, yEfv); ctx.stroke();
  ctx.setLineDash([]);

  // labels
  ctx.fillStyle = "rgba(233,238,252,0.95)";
  ctx.font = "600 13px ui-sans-serif, system-ui";
  ctx.fillText("SOA band diagram (0 K quasi-Fermi levels)", 22, 28);

  ctx.font = "12.5px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas";
  ctx.fillStyle = "rgba(233,238,252,0.92)";
  ctx.fillText("E_c", x0+60, yEc+4);
  ctx.fillText("E_v", x0+60, yEv+4);
  ctx.fillText("E_fc", x0+56, yEfc+4);
  ctx.fillText("E_fv", x0+56, yEfv+4);

  // show transition arrow for peak photon energy
  const xArrow = x0 + W*0.75;
  ctx.strokeStyle = "rgba(255,204,102,0.95)";
  ctx.lineWidth = 2.6;
  ctx.beginPath();
  ctx.moveTo(xArrow, yEfv);
  ctx.lineTo(xArrow, yEfc);
  ctx.stroke();

  // arrow heads
  ctx.fillStyle = "rgba(255,204,102,0.95)";
  ctx.beginPath();
  ctx.moveTo(xArrow, yEfc);
  ctx.lineTo(xArrow-6, yEfc+10);
  ctx.lineTo(xArrow+6, yEfc+10);
  ctx.closePath();
  ctx.fill();
  ctx.beginPath();
  ctx.moveTo(xArrow, yEfv);
  ctx.lineTo(xArrow-6, yEfv-10);
  ctx.lineTo(xArrow+6, yEfv-10);
  ctx.closePath();
  ctx.fill();

  ctx.fillStyle = "rgba(255,204,102,0.95)";
  ctx.font = "12.5px ui-sans-serif, system-ui";
  ctx.fillText("hν_p = E_fc − E_fv", xArrow-70, (yEfc+yEfv)/2 - 8);

  // annotate energies
  ctx.fillStyle = "rgba(183,194,230,0.92)";
  ctx.font = "12px ui-sans-serif, system-ui";
  ctx.fillText(`E_g ≈ ${Eg_eV.toFixed(3)} eV`, x0+80, yEc-10);
  ctx.fillText(`ε_c ≈ ${epsc_eV.toFixed(3)} eV`, x0+80, yEfc-10);
  ctx.fillText(`ε_v ≈ ${epsv_eV.toFixed(3)} eV`, x0+80, yEfv+16);
  ctx.fillText(`E_fc−E_fv ≈ ${sep_eV.toFixed(3)} eV`, x0+80, yEfc+18);

  // energy ticks
  ctx.strokeStyle="rgba(255,255,255,0.12)";
  ctx.fillStyle="rgba(183,194,230,0.9)";
  ctx.font="11px ui-monospace, SFMono-Regular, Menlo";
  const ticks=[Ebot, -Eg_eV/2, 0, Eg_eV/2, Etop].filter(v=>v>=Ebot && v<=Etop);
  for(const tE of ticks){
    const yy=yFromE(tE);
    ctx.beginPath();
    ctx.moveTo(x0+44, yy);
    ctx.lineTo(x0+56, yy);
    ctx.stroke();
    ctx.fillText(tE.toFixed(2)+" eV", x0+4, yy+4);
  }
}

/* =========================
   Drawing: γp vs Δn
========================= */
function drawMainPlot(state, unitMode){
  const {ctx, resize} = mainC;
  const {w,h} = resize();
  ctx.clearRect(0,0,w,h);

  // generate curve over range
  const dnMin=1.0e18, dnMax=2.0e18;
  const N=140;
  const xs=[], ys=[];
  for(let i=0;i<N;i++){
    const dn = dnMin + (dnMax-dnMin)*(i/(N-1));
    const {eps_c, eps_v} = fermiShiftsFromDn(dn);
    const gp_mInv = state.A * Math.sqrt(eps_c+eps_v);
    let y = gp_mInv;
    if(unitMode==="cm") y = gp_mInv/100;
    xs.push(dn/1e18);
    ys.push(y);
  }

  // y-limits with padding
  const yMax = Math.max(...ys)*1.12;
  const yMin = Math.min(...ys)*0.0;

  const frame = drawAxes(
    ctx, 10, 10, w-20, h-20,
    1.0, 2.0, yMin, yMax,
    "Δn (×10^18 cm⁻³)",
    unitMode==="cm" ? "γp (cm⁻¹)" : "γp (m⁻¹)",
    "Peak gain vs injected carrier density"
  );

  plotLine(ctx, frame, xs, ys, 1.0,2.0,yMin,yMax, {stroke:"rgba(124,247,212,0.95)", width:2.2});

  // mark current point
  const xNow = state.dn/1e18;
  const yNow = unitMode==="cm" ? state.gp_mInv/100 : state.gp_mInv;
  const {px0,py0,pw,ph} = frame;
  const X = px0 + (xNow-1.0)/(1.0)*pw;
  const Y = py0 + ph - (yNow - yMin)/(yMax-yMin)*ph;
  ctx.fillStyle="rgba(255,204,102,0.95)";
  ctx.beginPath(); ctx.arc(X,Y,4.5,0,Math.PI*2); ctx.fill();

  // legend
  drawLegend(ctx, px0+10, py0+18, [
    {color:"rgba(124,247,212,0.95)", label:"Model γp(Δn)"},
    {color:"rgba(255,204,102,0.95)", label:"Current Δn"}
  ]);

  // reference line for 270 cm^-1 if in cm units
  if(unitMode==="cm"){
    const yRef=270;
    ctx.save();
    ctx.strokeStyle="rgba(122,167,255,0.70)";
    ctx.setLineDash([6,6]);
    ctx.lineWidth=1.6;
    const Yref = py0 + ph - (yRef-yMin)/(yMax-yMin)*ph;
    ctx.beginPath(); ctx.moveTo(px0,Yref); ctx.lineTo(px0+pw,Yref); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle="rgba(122,167,255,0.90)";
    ctx.font="12px ui-sans-serif, system-ui";
    ctx.fillText("Reference: 270 cm⁻¹", px0+pw-130, Yref-6);
    ctx.restore();
  }
}

/* =========================
   Drawing: spectrum γ(ħω)
========================= */
function drawSpectrumPlot(state, unitMode){
  const {ctx, resize} = specC;
  const {w,h} = resize();
  ctx.clearRect(0,0,w,h);

  const Eg = state.Eg;
  const Emax = state.Emax;

  // energy axis (eV): show around Eg to Eg+0.20 eV
  const Eg_eV = J_to_eV(Eg);
  const Emax_eV = J_to_eV(Emax);
  const xMin = Eg_eV - 0.03;
  const xMax = Eg_eV + 0.22;

  const M=220;
  const xs=[], ys=[];
  const energies=[];
  for(let i=0;i<M;i++){
    const EeV = xMin + (xMax-xMin)*(i/(M-1));
    const EJ = eV_to_J(EeV);
    energies.push(EJ);
    xs.push(EeV);
  }
  const spec = modelGainSpectrum(state.dn, state.A, energies);
  for(let i=0;i<M;i++){
    let y = spec.out[i]; // m^-1
    if(unitMode==="cm") y = y/100;
    ys.push(y);
  }
  const yMax = Math.max(...ys)*1.14 + 1e-9;
  const yMin = 0;

  const frame = drawAxes(
    ctx, 10, 10, w-20, h-20,
    xMin, xMax, yMin, yMax,
    "Photon energy hν (eV)",
    unitMode==="cm" ? "γ(hν) (cm⁻¹)" : "γ(hν) (m⁻¹)",
    "0 K gain spectrum (ideal cutoff model)"
  );

  plotLine(ctx, frame, xs, ys, xMin,xMax,yMin,yMax, {stroke:"rgba(122,167,255,0.95)", width:2.1});

  // vertical line at peak energy
  const xPk = Emax_eV; // peak at cutoff
  const {px0,py0,pw,ph} = frame;
  const Xpk = px0 + (xPk-xMin)/(xMax-xMin)*pw;
  ctx.save();
  ctx.strokeStyle="rgba(255,204,102,0.95)";
  ctx.setLineDash([6,6]);
  ctx.lineWidth=1.8;
  ctx.beginPath(); ctx.moveTo(Xpk, py0); ctx.lineTo(Xpk, py0+ph); ctx.stroke();
  ctx.setLineDash([]);
  ctx.fillStyle="rgba(255,204,102,0.95)";
  ctx.font="12px ui-sans-serif, system-ui";
  ctx.fillText("peak at cutoff", Xpk-34, py0+16);
  ctx.restore();

  // legend
  drawLegend(ctx, px0+10, py0+18, [
    {color:"rgba(122,167,255,0.95)", label:"γ(hν) = A√(hν−Eg) (inversion window)"},
    {color:"rgba(255,204,102,0.95)", label:"hνp = Efc−Efv"}
  ]);

  // annotate Eg, Emax
  ctx.save();
  ctx.fillStyle="rgba(183,194,230,0.92)";
  ctx.font="12px ui-monospace, SFMono-Regular, Menlo";
  ctx.fillText(`Eg=${Eg_eV.toFixed(3)} eV`, px0+pw-120, py0+ph-10);
  ctx.fillText(`hνp=${Emax_eV.toFixed(3)} eV`, px0+pw-120, py0+ph-26);
  ctx.restore();
}

/* =========================
   State update
========================= */
function getState(){
  const dn = parseFloat(dnSlider.value) * 1e18; // cm^-3
  const Aauto = computeA_auto(270);
  const mode = scaleMode.value;
  const A = (mode==="auto") ? Aauto : Aauto * parseFloat(aSlider.value);
  const {eps_c, eps_v} = fermiShiftsFromDn(dn);
  const Eg = Eg_J();
  const Emax = Eg + eps_c + eps_v;
  const gp_mInv = A * Math.sqrt(eps_c + eps_v);
  return {dn, A, Aauto, eps_c, eps_v, Eg, Emax, gp_mInv};
}

function updateUI(state){
  dnRead.textContent = (state.dn/1e18).toFixed(2);
  aRead.textContent = parseFloat(aSlider.value).toFixed(2);

  const unitMode = unitsSel.value;
  const Eg_eV = J_to_eV(state.Eg);
  const hvp_eV = J_to_eV(state.Emax);
  const vp = peakFrequency_Hz(state.dn);
  const epsc_eV = J_to_eV(state.eps_c);
  const epsv_eV = J_to_eV(state.eps_v);

  egOut.textContent = `${Eg_eV.toFixed(3)} eV  (λ0=${(params.lambda0*1e9).toFixed(0)} nm)`;
  hvpOut.textContent = `${hvp_eV.toFixed(3)} eV`;
  vpOut.textContent = `${formatSI(vp, "Hz")}  (≈ ${(params.lambda0*1e9 * Eg_eV / hvp_eV).toFixed(0)} nm if using hc/E)`;

  let gpTxt;
  if(unitMode==="cm"){
    gpTxt = `${(state.gp_mInv/100).toFixed(1)} cm⁻¹`;
  }else{
    gpTxt = `${formatSI(state.gp_mInv, "m⁻¹")}`;
  }
  gpOut.textContent = gpTxt;

  epsOut.textContent = `εc=${epsc_eV.toFixed(3)} eV,  εv=${epsv_eV.toFixed(3)} eV`;

  paramOut.textContent =
    `n=${params.n}, τr=${(params.tau_r*1e9).toFixed(2)} ns, mc=${(params.mc/constants.m0).toFixed(2)} m0, mv=${(params.mv/constants.m0).toFixed(2)} m0`;

  // enable/disable manual A
  if(scaleMode.value==="manual"){
    aRow.style.opacity = "1";
    aSlider.style.opacity = "1";
    aSlider.disabled = false;
  }else{
    aRow.style.opacity = ".6";
    aSlider.style.opacity = ".6";
    aSlider.disabled = true;
  }
}

function render(){
  const state = getState();
  const unitMode = unitsSel.value;

  updateUI(state);
  drawBandDiagram(state);
  drawMainPlot(state, unitMode);
  drawSpectrumPlot(state, unitMode);
}

/* =========================
   Events
========================= */
dnSlider.addEventListener("input", render);
aSlider.addEventListener("input", render);
scaleMode.addEventListener("change", render);
unitsSel.addEventListener("change", render);
window.addEventListener("resize", render);

/* First render */
render();
</script>
</body>
</html>
