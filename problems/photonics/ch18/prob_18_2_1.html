<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bandwidth of an InGaAsP Semiconductor Optical Amplifier (SOA) vs Injected-Carrier Concentration</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#101a33;
      --ink:#eaf0ff;
      --muted:#b8c4ff;
      --faint:#7f8bba;
      --accent:#7cf6ff;
      --accent2:#a7ff7c;
      --warn:#ffcf6e;
      --danger:#ff6e8a;
      --line:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 800px at 10% 10%, rgba(124,246,255,.15), transparent 55%),
        radial-gradient(900px 650px at 95% 15%, rgba(167,255,124,.10), transparent 50%),
        radial-gradient(900px 650px at 60% 105%, rgba(255,207,110,.10), transparent 45%),
        linear-gradient(180deg, #070a14, #0b1020 30%, #070a14 100%);
      line-height:1.55;
    }
    header{
      padding:28px 18px 18px;
      max-width:1200px;
      margin:0 auto;
    }
    header .top{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      align-items:start;
    }
    h1{
      margin:0 0 10px;
      font-size: clamp(24px, 2.6vw, 40px);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      max-width:70ch;
      margin:0;
      font-size: clamp(14px, 1.25vw, 16px);
    }
    .badgeRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
      align-items:center;
      padding-top:6px;
    }
    .badge{
      border:1px solid var(--line);
      background:rgba(255,255,255,.04);
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      backdrop-filter: blur(8px);
    }
    .badge b{color:var(--ink); font-weight:650}
    main{
      max-width:1200px;
      margin:0 auto;
      padding: 10px 18px 50px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      align-items:start;
    }
    nav.toc{
      position: sticky;
      top: 12px;
      align-self:start;
      border:1px solid var(--line);
      background:rgba(16,26,51,.75);
      border-radius: var(--radius);
      padding:14px 14px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    nav.toc h2{
      font-size:14px;
      margin:0 0 10px;
      color:var(--muted);
      letter-spacing:.4px;
      text-transform:uppercase;
    }
    nav.toc a{
      display:block;
      padding:9px 10px;
      border-radius:12px;
      color:var(--ink);
      text-decoration:none;
      font-size:13px;
      border:1px solid transparent;
    }
    nav.toc a:hover{
      background:rgba(124,246,255,.08);
      border-color:rgba(124,246,255,.18);
    }
    nav.toc .small{
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--line);
      color:var(--faint);
      font-size:12px;
    }

    article{
      border:1px solid var(--line);
      background:rgba(16,26,51,.55);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    section{
      padding:18px 18px;
      border-top:1px solid var(--line);
    }
    section:first-child{border-top:none}
    h2{
      margin:0 0 10px;
      font-size: clamp(18px, 1.5vw, 24px);
    }
    h3{
      margin:14px 0 8px;
      font-size: 16px;
      color: var(--muted);
    }
    p{margin: 8px 0}
    ul{margin:8px 0 8px 18px}
    li{margin:6px 0}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
    }
    .card{
      border:1px solid var(--line);
      border-radius:16px;
      padding:14px;
      background: rgba(0,0,0,.14);
    }
    .callout{
      border-left: 4px solid var(--accent);
      background: rgba(124,246,255,.08);
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(124,246,255,.18);
    }
    .warn{
      border-left-color: var(--warn);
      background: rgba(255,207,110,.08);
      border-color: rgba(255,207,110,.18);
    }
    .danger{
      border-left-color: var(--danger);
      background: rgba(255,110,138,.08);
      border-color: rgba(255,110,138,.18);
    }
    .eq{
      font-family: var(--mono);
      background: rgba(255,255,255,.06);
      border: 1px solid var(--line);
      padding: 10px 10px;
      border-radius: 12px;
      overflow:auto;
      position: relative;
    }
    .eq .label{
      font-size:12px;
      color:var(--muted);
      margin-bottom:6px;
      letter-spacing:.3px;
    }
    .copyBtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      border-radius: 10px;
      padding:6px 8px;
      cursor:pointer;
      font-size:12px;
    }
    .copyBtn:hover{
      border-color: rgba(124,246,255,.35);
      background: rgba(124,246,255,.10);
    }
    .kbd{
      font-family: var(--mono);
      font-size: 12px;
      padding:2px 6px;
      border-radius:8px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--muted);
    }
    .vizWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .vizRow{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    .canvasCard{
      border:1px solid var(--line);
      border-radius: 18px;
      background: rgba(0,0,0,.20);
      overflow:hidden;
      padding: 12px;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
      border:1px solid rgba(255,255,255,.08);
    }
    .canvasTall canvas{height:360px}
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top:10px;
    }
    .controlGroup{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
    }
    input[type="range"]{
      width:min(420px, 100%);
      accent-color: var(--accent);
    }
    .readout{
      font-family: var(--mono);
      color: var(--muted);
      font-size: 12.5px;
      white-space: nowrap;
    }
    table{
      width:100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;
      font-size: 13px;
    }
    th{
      color:var(--muted);
      font-weight:650;
      background: rgba(255,255,255,.04);
    }
    tr:last-child td{border-bottom:none}
    footer{
      max-width:1200px;
      margin:18px auto 50px;
      padding: 0 18px;
      color: var(--faint);
      font-size: 12.5px;
    }
    .pulse{
      display:inline-block;
      width:10px;height:10px;border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 rgba(124,246,255,.0);
      animation: pulse 2.2s infinite;
      vertical-align: middle;
      margin-right:8px;
    }
    @keyframes pulse{
      0%{ box-shadow: 0 0 0 0 rgba(124,246,255,.35); }
      70%{ box-shadow: 0 0 0 14px rgba(124,246,255,0); }
      100%{ box-shadow: 0 0 0 0 rgba(124,246,255,0); }
    }

    /* Print-friendly */
    @media print{
      body{background:#fff;color:#000}
      nav.toc{display:none}
      main{grid-template-columns:1fr}
      article, .canvasCard{box-shadow:none; backdrop-filter:none}
      canvas{border:1px solid #aaa}
      .copyBtn{display:none}
      .badgeRow{display:none}
      .eq, .card, .callout{background:#f6f6f6;color:#000}
      .subtitle, .muted{color:#222}
    }

    @media (max-width: 980px){
      main{grid-template-columns:1fr}
      nav.toc{position:relative; top:auto}
      header .top{grid-template-columns:1fr}
      .badgeRow{justify-content:flex-start}
      .vizRow{grid-template-columns:1fr}
      canvas{height:300px}
    }
  </style>
</head>

<body>
  <header>
    <div class="top">
      <div>
        <h1>Bandwidth of an InGaAsP SOA vs Injected Carrier Concentration Δn</h1>
        <p class="subtitle">
          Using the information in Fig. 18.2-3: (a) extract the <b>full bandwidth</b> of the amplifier vs injected-carrier
          concentration Δn, find an approximate <b>linear bandwidth law</b>, and (b) combine with the peak gain data to plot
          <b>peak gain coefficient</b> versus <b>bandwidth</b>.
        </p>
      </div>
      <div class="badgeRow">
        <div class="badge"><b>Topic</b>: semiconductor optical amplifiers</div>
        <div class="badge"><b>Key idea</b>: gain spectrum widens with Δn</div>
        <div class="badge"><b>Outputs</b>: B(Δn) fit + γ<sub>p</sub>(B) plot</div>
      </div>
    </div>
  </header>

  <main>
    <nav class="toc" aria-label="Table of contents">
      <h2>Contents</h2>
      <a href="#quick" data-scroll>Quick Summary</a>
      <a href="#part0" data-scroll>PART 0 — Concept Primer</a>
      <a href="#part1" data-scroll>PART 1 — Problem Analysis</a>
      <a href="#part2" data-scroll>PART 2 — Strategy & Tips</a>
      <a href="#part3" data-scroll>PART 3 — Full Solution</a>
      <a href="#part4" data-scroll>PART 4 — Deeper Understanding</a>
      <a href="#part5" data-scroll>PART 5 — Visualization Guide</a>
      <div class="small">
        <span class="pulse"></span>
        Interactive slider updates <b>all</b> canvases live.
      </div>
    </nav>

    <article>
      <section id="quick">
        <h2>Quick Summary</h2>
        <ul>
          <li><b>What this is</b>: An InGaAsP semiconductor optical amplifier (SOA) has a gain spectrum g(ν) that depends on injected carrier density Δn.</li>
          <li><b>Key physics</b>: Increasing Δn increases population inversion and changes the quasi-Fermi levels, which both <b>raises the peak gain</b> and <b>widens the frequency band</b> with positive gain.</li>
          <li><b>Bandwidth definition used here</b>: The figure’s caption states a <b>FWHM gain bandwidth</b> of 10 THz at the largest Δn; we treat “full bandwidth” as this <b>FWHM bandwidth B</b>.</li>
          <li><b>Governing conversion</b>: photon-energy width ΔE and frequency width B are related by <span class="kbd">B = ΔE / h</span> (with h = 4.1357×10<sup>−15</sup> eV·s).</li>
          <li><b>Data extraction</b>: We approximate FWHM widths from Fig. 18.2-3(a) for the labeled Δn curves, and read peak gain γ<sub>p</sub> vs Δn from Fig. 18.2-3(b) (approximate digitization).</li>
          <li><b>Linear fit result</b> (approx.): <span class="kbd">B(THz) ≈ 12.5 · (Δn/10<sup>18</sup> − 1)</span> for Δn ≳ 10<sup>18</sup> cm<sup>−3</sup>.</li>
          <li><b>Second plot</b>: Using γ<sub>p</sub>(Δn) and B(Δn), we plot γ<sub>p</sub> versus B (peak gain coefficient vs bandwidth).</li>
        </ul>
        <div class="callout warn">
          <b>Important:</b> The original plot is low-resolution in the prompt. The numeric points here are <b>approximate</b> (visual digitization),
          but the method (extract → convert → fit → replot) is exactly what the problem asks for.
        </div>
      </section>

      <section id="part0">
        <h2>PART 0 — Concept Primer (theory before solving)</h2>

        <div class="grid2">
          <div class="card">
            <h3>Core definitions (symbols & units)</h3>
            <ul>
              <li><b>Injected carrier concentration</b>: Δn (cm<sup>−3</sup>) — excess electron-hole density above transparency/steady baseline.</li>
              <li><b>Material gain coefficient</b>: g(ν) (cm<sup>−1</sup>) — exponential gain per unit length for optical intensity inside the active region.</li>
              <li><b>Peak gain coefficient</b>: γ<sub>p</sub> (cm<sup>−1</sup>) — the maximum of g(ν) over frequency (or photon energy).</li>
              <li><b>Gain bandwidth</b>: B (Hz or THz) — width of the gain spectrum. Here we use <b>FWHM</b> (full width at half maximum) as indicated by the figure caption.</li>
              <li><b>Photon energy</b>: E = hν (eV). (Often plotted instead of frequency.)</li>
            </ul>
          </div>

          <div class="card">
            <h3>Physical meaning</h3>
            <p>
              An SOA amplifies light by <b>stimulated emission</b> in a semiconductor. Injecting carriers shifts quasi-Fermi levels,
              increasing inversion. Two things happen as Δn rises:
            </p>
            <ul>
              <li><b>Higher gain</b> at frequencies near the bandgap transition → γ<sub>p</sub> increases.</li>
              <li><b>Broader gain spectrum</b> because a larger range of transition energies has net stimulated emission > absorption → B increases.</li>
            </ul>
          </div>
        </div>

        <div class="grid2">
          <div class="callout">
            <h3 style="margin-top:0">Key principle & validity</h3>
            <p>
              The spectral gain can be modeled (conceptually) as a lineshape determined by joint density of states and Fermi occupation factors.
              For a teaching-level fit, we often treat the gain spectrum near its peak as roughly bell-shaped, so its width can be summarized by a
              single number (FWHM).
            </p>
            <ul>
              <li>Valid when the gain spectrum has a single dominant peak and is not strongly multi-peaked.</li>
              <li>Assumes temperature fixed (here T = 300 K in the caption).</li>
            </ul>
          </div>

          <div class="callout warn">
            <h3 style="margin-top:0">Common approximations</h3>
            <ul>
              <li><b>FWHM bandwidth</b> used as “full bandwidth” because the caption explicitly gives a FWHM in THz.</li>
              <li><b>Linear fit B(Δn)</b> over the limited Δn range shown (about 1.0–1.8×10<sup>18</sup> cm<sup>−3</sup>).</li>
              <li><b>Digitized points</b> from a printed graph are approximate; trends matter more than last-digit accuracy.</li>
            </ul>
          </div>
        </div>

        <div class="grid2">
          <div class="card">
            <h3>Mini intuition examples</h3>
            <ul>
              <li><b>Example 1:</b> If the peak gain doubles while the width stays fixed, you get more amplification but not a wider usable wavelength band.</li>
              <li><b>Example 2:</b> If the width increases (larger B), the amplifier can boost more channels/wavelengths — valuable for WDM systems.</li>
            </ul>
          </div>
          <div class="card">
            <h3>What to watch for (pitfalls)</h3>
            <ul>
              <li>Confusing “positive-gain region” width with <b>FWHM</b>. The problem’s figure caption strongly hints FWHM.</li>
              <li>Mixing energy-width (eV) and frequency-width (Hz/THz) without converting using Planck’s constant.</li>
              <li>Fitting outside the shown Δn range: a linear fit is a local approximation, not a universal law.</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="part1">
        <h2>PART 1 — Problem Analysis (no solving yet)</h2>

        <h3>Problem restatement</h3>
        <p>
          From Fig. 18.2-3(a), estimate the SOA gain-spectrum FWHM bandwidth <b>B</b> for several injected-carrier concentrations <b>Δn</b>,
          then plot <b>B versus Δn</b> and find an approximate <b>linear formula</b> B(Δn).
          Next, using Fig. 18.2-3(b), take the peak gain coefficient <b>γ<sub>p</sub></b> versus Δn and replot it as <b>γ<sub>p</sub> versus B</b>.
        </p>

        <div class="grid2">
          <div class="card">
            <h3>Given (from the figure/caption)</h3>
            <ul>
              <li>Gain spectra g(hν) for Δn labeled around 1.2, 1.4, 1.6, 1.8 ×10<sup>18</sup> cm<sup>−3</sup>.</li>
              <li>At the largest Δn, the <b>FWHM bandwidth</b> is <b>10 THz</b> (caption).</li>
              <li>Peak gain at largest Δn is about <b>γ<sub>p</sub> ≈ 270 cm<sup>−1</sup></b> (caption).</li>
            </ul>
          </div>

          <div class="card">
            <h3>Unknowns / required outputs</h3>
            <ul>
              <li>Estimated data points B(Δn) and a plot of B vs Δn.</li>
              <li>A linear approximation B(Δn) ≈ a(Δn − Δn<sub>0</sub>) (or equivalent form).</li>
              <li>Plot of γ<sub>p</sub> vs B using γ<sub>p</sub>(Δn) from (b) and B(Δn) from (a).</li>
            </ul>
          </div>
        </div>

        <div class="callout">
          <h3 style="margin-top:0">Relevant physics & why it applies</h3>
          <ul>
            <li>The figure directly provides the gain spectrum vs photon energy, so <b>bandwidth is a spectral measurement</b>.</li>
            <li>Bandwidth conversion relies only on <b>E = hν</b>, so once a width in energy is estimated, B follows.</li>
            <li>No device-level waveguide modeling is needed because the problem focuses on the <b>material gain spectrum</b> shapes already computed in the figure.</li>
          </ul>
        </div>

        <div class="grid2">
          <div class="card">
            <h3>Assumptions (explicit)</h3>
            <ul>
              <li>“Full bandwidth” refers to <b>FWHM bandwidth B</b> (as used in the caption).</li>
              <li>The labeled spectra correspond to Δn ≈ {1.2, 1.4, 1.6, 1.8}×10<sup>18</sup> cm<sup>−3</sup>.</li>
              <li>At Δn = 1.0×10<sup>18</sup> cm<sup>−3</sup> the amplifier is near threshold → bandwidth ~ 0 (no net gain peak).</li>
              <li>Digitized values are approximate, used to produce the requested plots and fit.</li>
            </ul>
          </div>

          <div class="card">
            <h3>Possible approaches</h3>
            <ul>
              <li><b>Approach A (direct FWHM reading):</b> read the two half-maximum intercepts on each g(hν) curve → best physical match to “FWHM”.</li>
              <li><b>Approach B (positive-gain width):</b> read where g crosses zero → easier, but not what the caption calls “FWHM”.</li>
              <li><b>Approach C (fit a Gaussian/Lorentzian):</b> fit each spectrum to a lineshape, then compute FWHM from fit → best if you have high-res data.</li>
            </ul>
            <p>
              <b>Chosen:</b> Approach A + caption anchor (10 THz at largest Δn), because it matches the wording and is robust even with rough digitization.
            </p>
          </div>
        </div>
      </section>

      <section id="part2">
        <h2>PART 2 — Strategy & Tips (roadmap only)</h2>

        <ol>
          <li>
            <b>Identify Δn values</b> used in Fig. 18.2-3(a).
            <span class="muted">Goal:</span> know the x-values for the bandwidth plot.
          </li>
          <li>
            <b>For each curve, estimate FWHM in energy</b>, ΔE<sub>FWHM</sub> (eV).
            <span class="muted">Tool:</span> half-maximum rule on g(hν).
          </li>
          <li>
            <b>Convert energy-width to frequency-width</b> using B = ΔE/h.
            <span class="muted">Meaning:</span> converts the plotted photon-energy domain to the requested THz domain.
          </li>
          <li>
            <b>Plot B vs Δn</b> (scatter) and add a <b>linear fit</b>.
            <span class="muted">Meaning:</span> an engineering rule-of-thumb bandwidth law.
          </li>
          <li>
            <b>Read/approximate γ<sub>p</sub> vs Δn</b> from Fig. 18.2-3(b).
            <span class="muted">Meaning:</span> peak gain rises with injection.
          </li>
          <li>
            <b>Eliminate Δn</b>: pair each γ<sub>p</sub>(Δn) with B(Δn), and plot γ<sub>p</sub> vs B.
            <span class="muted">Meaning:</span> directly shows the gain–bandwidth trade/relationship for this SOA family.
          </li>
        </ol>

        <div class="callout warn">
          <b>Quick tips</b>
          <ul>
            <li>Use the caption’s anchor point (B ≈ 10 THz at the largest Δn) to keep your scale consistent.</li>
            <li>Keep units explicit: Δn in cm<sup>−3</sup>, γ<sub>p</sub> in cm<sup>−1</sup>, B in THz.</li>
            <li>Linear fit is only justified over the limited plotted range.</li>
          </ul>
        </div>
      </section>

      <section id="part3">
        <h2>PART 3 — Full Solution (detailed + teaching)</h2>

        <h3>Physical intuition first</h3>
        <p>
          As Δn increases, the SOA transitions from near-transparency (little net gain) to strong inversion.
          Stronger inversion produces <b>larger stimulated emission</b> and shifts the spectral region of net gain.
          Because the quasi-Fermi levels separate more, a <b>wider range</b> of photon energies sees net gain:
          we therefore expect <b>B to increase with Δn</b>, roughly monotonically and approximately linearly over a modest injection range.
        </p>

        <div class="eq" id="eq-conv">
          <div class="label">Key conversion (energy width → frequency width)</div>
          <button class="copyBtn" data-copy="#eq-conv-text">Copy</button>
          <div id="eq-conv-text" style="font-family:var(--mono); white-space:pre-wrap;">
B = Δν_FWHM = ΔE_FWHM / h
h = 4.135667696×10^-15 eV·s
1 THz = 10^12 Hz  ⇒  1 THz ↔ (h)(1 THz) ≈ 4.1357 meV
          </div>
        </div>

        <h3>Step 1: Approximate digitized points from Fig. 18.2-3(a)</h3>
        <p>
          The caption states that at the largest Δn (the top curve), the FWHM bandwidth is about <b>10 THz</b>.
          Visually, the sequence of spectra widens in an approximately uniform way as Δn increases from 1.2 to 1.8×10<sup>18</sup> cm<sup>−3</sup>.
          Using the spacing between the curves and the given anchor, we estimate:
        </p>

        <div class="card">
          <table aria-label="Digitized bandwidth vs injected carrier concentration">
            <thead>
              <tr>
                <th>Δn (×10<sup>18</sup> cm<sup>−3</sup>)</th>
                <th>Estimated FWHM bandwidth B (THz)</th>
                <th>Implied ΔE<sub>FWHM</sub> (eV) via ΔE = hB</th>
              </tr>
            </thead>
            <tbody id="tableBw">
              <!-- Filled by JS for consistency -->
            </tbody>
          </table>
          <p style="margin-top:10px;color:var(--faint);font-size:12.5px">
            Note: ΔE values are included to show the conversion; the problem asks for bandwidth in THz.
          </p>
        </div>

        <h3>Step 2: Linear fit B(Δn)</h3>
        <p>
          A simple linear law that respects the near-threshold behavior is to fit bandwidth to an offset form:
        </p>

        <div class="eq" id="eq-fit">
          <div class="label">Approximate linear bandwidth law (fit over the plotted range)</div>
          <button class="copyBtn" data-copy="#eq-fit-text">Copy</button>
          <div id="eq-fit-text" style="font-family:var(--mono); white-space:pre-wrap;">
Let n18 = Δn / (10^18 cm^-3)

B(THz) ≈ 12.5 · (n18 − 1)
      = 12.5 · (Δn/10^18 − 1)

Equivalent slope form:
B(THz) ≈ (12.5 THz per 10^18 cm^-3) · (Δn − 1.0×10^18 cm^-3)/(10^18 cm^-3)
          </div>
        </div>

        <p>
          <b>What did we do and why?</b> We used the visually monotonic widening of the spectra and the caption’s anchor point
          (10 THz at the maximum Δn) to define a straight-line rule of thumb across the displayed Δn range.
        </p>

        <div class="callout">
          <b>Sanity checks</b>
          <ul>
            <li><b>Units:</b> Δn/10<sup>18</sup> is dimensionless, so B has units of THz as desired.</li>
            <li><b>Limiting case:</b> at Δn = 1.0×10<sup>18</sup> cm<sup>−3</sup>, B ≈ 0 THz (near threshold) — reasonable.</li>
            <li><b>Anchor:</b> at Δn = 1.8×10<sup>18</sup> cm<sup>−3</sup>, B ≈ 12.5·0.8 = 10 THz — matches the caption.</li>
          </ul>
        </div>

        <h3>Step 3: Peak gain coefficient γ<sub>p</sub> vs Δn from Fig. 18.2-3(b)</h3>
        <p>
          From Fig. 18.2-3(b), γ<sub>p</sub> rises from ~0 near 1.0×10<sup>18</sup> cm<sup>−3</sup> to ~270 cm<sup>−1</sup> near 1.8×10<sup>18</sup> cm<sup>−3</sup>.
          Using approximate read-offs consistent with the curve shape:
        </p>

        <div class="card">
          <table aria-label="Digitized peak gain vs injected carrier concentration">
            <thead>
              <tr>
                <th>Δn (×10<sup>18</sup> cm<sup>−3</sup>)</th>
                <th>Estimated peak gain γ<sub>p</sub> (cm<sup>−1</sup>)</th>
              </tr>
            </thead>
            <tbody id="tableGp">
              <!-- Filled by JS -->
            </tbody>
          </table>
        </div>

        <h3>Step 4: Plot γ<sub>p</sub> versus bandwidth B (eliminate Δn)</h3>
        <p>
          Pair each Δn point with its corresponding bandwidth B(Δn). This produces the requested relationship γ<sub>p</sub>(B).
          This is not a universal “gain–bandwidth product” law; it is a <b>mapping for this specific SOA material model</b>
          and operating temperature.
        </p>

        <div class="eq" id="eq-final">
          <div class="label">Final result (what the problem ultimately wants)</div>
          <button class="copyBtn" data-copy="#eq-final-text">Copy</button>
          <div id="eq-final-text" style="font-family:var(--mono); white-space:pre-wrap;">
(1) Bandwidth vs injection (approx. linear, from Fig. 18.2-3a):
B(THz) ≈ 12.5 · (Δn/10^18 − 1),  for  Δn ≳ 10^18 cm^-3

(2) Peak gain vs bandwidth (from Fig. 18.2-3b combined with (1)):
Plot points (B, γ_p) for corresponding Δn values (shown in the interactive plot).
          </div>
        </div>

        <div class="callout warn">
          <b>Connection to the diagram & plots:</b> The SOA diagram shows carrier injection creating gain. The main plot shows how the <b>usable spectral width</b>
          (bandwidth) increases with Δn; the secondary plot shows what peak gain you get at the same time.
        </div>

      </section>

      <section id="part4">
        <h2>PART 4 — Deeper Understanding (theory around the result)</h2>

        <h3>Re-interpreting the linear bandwidth law</h3>
        <p>
          The fit <span class="kbd">B(THz) ≈ 12.5 · (Δn/10<sup>18</sup> − 1)</span> says:
        </p>
        <ul>
          <li>The SOA is near “spectral-onset” around Δn ≈ 10<sup>18</sup> cm<sup>−3</sup> (bandwidth ~ 0 by extrapolation).</li>
          <li>Every additional 1×10<sup>18</sup> cm<sup>−3</sup> of injected carriers increases the FWHM gain bandwidth by ~12.5 THz (in this modeled device).</li>
          <li>Because the relation is empirical/graph-based, it’s best used as an <b>engineering estimate</b> over the plotted range.</li>
        </ul>

        <h3>How parameters affect the outcome (tie to the interactive plots)</h3>
        <ul>
          <li>Increasing <b>Δn</b> moves the highlighted point up in the bandwidth plot and also moves the γ<sub>p</sub> point upward in the gain–bandwidth plot.</li>
          <li>The γ<sub>p</sub> curve is <b>nonlinear</b> in Δn (accelerating upward), so γ<sub>p</sub> versus B also curves upward.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p>
          If you had the underlying semiconductor gain model, you could compute g(E) from the joint density of states and quasi-Fermi levels
          and then directly compute FWHM(B) from the modeled spectra for each Δn (no digitization). The current problem instead uses
          the <b>already-computed spectra</b> in Fig. 18.2-3 as “data.”
        </p>

        <div class="card">
          <h3 style="margin-top:0">Concept checks (with answers)</h3>
          <ul>
            <li><b>Q:</b> Why does B grow with Δn? <b>A:</b> Larger inversion makes net gain positive over a wider range of transition energies.</li>
            <li><b>Q:</b> Why do we convert eV to THz? <b>A:</b> The figure shows spectra versus photon energy, but bandwidth is requested as a frequency width.</li>
            <li><b>Q:</b> Is B(Δn) truly linear? <b>A:</b> Not necessarily—linear is a local approximation over the shown Δn range.</li>
            <li><b>Q:</b> Does higher bandwidth always mean lower peak gain? <b>A:</b> Not here—both increase with Δn in this SOA model.</li>
          </ul>
        </div>
      </section>

      <section id="part5">
        <h2>PART 5 — Visualization Guide (how to read the plots)</h2>

        <div class="vizWrap">
          <div class="vizRow">
            <div class="canvasCard canvasTall">
              <canvas id="cDiagram" aria-label="SOA setup diagram"></canvas>
              <div class="controls">
                <div class="controlGroup">
                  <span class="kbd">Δn slider</span>
                  <input id="dnSlider" type="range" min="1.0" max="1.8" step="0.01" value="1.40" />
                </div>
                <div class="readout" id="readout"></div>
              </div>
            </div>

            <div class="canvasCard">
              <canvas id="cMain" aria-label="Main plot: bandwidth vs injected carrier concentration"></canvas>
              <p style="margin:10px 2px 0;color:var(--faint);font-size:12.5px">
                <b>Main plot:</b> B vs Δn. Markers are digitized points; line is the linear fit; bright point is the slider value.
              </p>
            </div>
          </div>

          <div class="canvasCard">
            <canvas id="cSecondary" aria-label="Secondary plot: peak gain vs bandwidth"></canvas>
            <p style="margin:10px 2px 0;color:var(--faint);font-size:12.5px">
              <b>Secondary plot:</b> γ<sub>p</sub> vs B constructed by pairing (Δn → B) from (a) with (Δn → γ<sub>p</sub>) from (b).
              The slider selects a working point.
            </p>
          </div>
        </div>

        <div class="callout">
          <b>Interactive control:</b> The slider changes Δn (in units of ×10<sup>18</sup> cm<sup>−3</sup>). The page then:
          <ul>
            <li>computes <b>B</b> using the linear fit,</li>
            <li>computes <b>γ<sub>p</sub></b> by interpolating the digitized γ<sub>p</sub>(Δn) data,</li>
            <li>updates the highlighted points on both plots and updates the diagram annotations.</li>
          </ul>
        </div>
      </section>
    </article>
  </main>

  <footer>
    <p>
      <b>Data note:</b> Because the prompt provides a raster image of the figure, values used here are approximate digitizations
      designed to reproduce the plotted trends and the caption’s anchor points (10 THz at the highest Δn; γ<sub>p</sub> ≈ 270 cm<sup>−1</sup>).
      If you have the original textbook/PDF, you can refine points and the same code will update automatically.
    </p>
  </footer>

  <script>
    // ---------------------------
    // Smooth scrolling for TOC
    // ---------------------------
    document.querySelectorAll('[data-scroll]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const id = a.getAttribute('href');
        const el = document.querySelector(id);
        if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });

    // ---------------------------
    // Copy buttons
    // ---------------------------
    document.querySelectorAll('.copyBtn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const sel = btn.getAttribute('data-copy');
        const el = document.querySelector(sel);
        if(!el) return;
        const text = el.innerText.trim();
        try{
          await navigator.clipboard.writeText(text);
          const old = btn.textContent;
          btn.textContent = "Copied!";
          setTimeout(()=>btn.textContent=old, 900);
        }catch{
          // Fallback
          const ta = document.createElement('textarea');
          ta.value = text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          const old = btn.textContent;
          btn.textContent = "Copied!";
          setTimeout(()=>btn.textContent=old, 900);
        }
      });
    });

    // ---------------------------
    // "Digitized" data (approx.)
    // ---------------------------
    // Units:
    // dn18: Δn in units of 1e18 cm^-3
    // B: THz (FWHM bandwidth)
    // gp: cm^-1 (peak gain coefficient)
    const data = {
      dn18: [1.00, 1.20, 1.40, 1.60, 1.80],
      B_THz:[0.00, 3.80, 6.00, 8.00, 10.00],
      gp_cm:[0.00, 40.0, 90.0, 160.0, 270.0]
    };

    // Planck constant in eV*s for energy-width conversion
    const h_eVs = 4.135667696e-15;

    // Fill tables for consistency with JS
    function fillTables(){
      const tbw = document.getElementById('tableBw');
      const tgp = document.getElementById('tableGp');
      tbw.innerHTML = '';
      tgp.innerHTML = '';
      for(let i=0;i<data.dn18.length;i++){
        const dn = data.dn18[i];
        const B = data.B_THz[i];
        const dE = (h_eVs * (B*1e12)); // eV
        const tr1 = document.createElement('tr');
        tr1.innerHTML = `
          <td>${dn.toFixed(2)}</td>
          <td>${B.toFixed(2)}</td>
          <td>${dE.toFixed(4)}</td>
        `;
        tbw.appendChild(tr1);

        const tr2 = document.createElement('tr');
        tr2.innerHTML = `
          <td>${dn.toFixed(2)}</td>
          <td>${data.gp_cm[i].toFixed(1)}</td>
        `;
        tgp.appendChild(tr2);
      }
    }
    fillTables();

    // ---------------------------
    // Linear bandwidth fit B(THz) ≈ 12.5*(dn18 - 1)
    // anchored to (1.0,0) and (1.8,10)
    // ---------------------------
    function Bfit(dn18){
      return Math.max(0, 12.5*(dn18 - 1.0));
    }

    // Piecewise linear interpolation for gp(dn18)
    function interp1(xArr, yArr, x){
      if(x <= xArr[0]) return yArr[0];
      if(x >= xArr[xArr.length-1]) return yArr[yArr.length-1];
      for(let i=0;i<xArr.length-1;i++){
        const x0 = xArr[i], x1 = xArr[i+1];
        if(x >= x0 && x <= x1){
          const t = (x - x0)/(x1 - x0);
          return yArr[i]*(1-t) + yArr[i+1]*t;
        }
      }
      return yArr[yArr.length-1];
    }

    // ---------------------------
    // Canvas utilities (HiDPI + responsive)
    // ---------------------------
    function setupCanvas(canvas){
      const ctx = canvas.getContext('2d');
      function resize(){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.round(rect.width * dpr);
        canvas.height = Math.round(rect.height * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
        return {w:rect.width, h:rect.height, dpr};
      }
      return {ctx, resize};
    }

    function drawAxes(ctx, box, xMin, xMax, yMin, yMax, opts){
      const {
        xLabel="", yLabel="", title="",
        grid=true, ticks=5, tickSize=6
      } = opts || {};
      const {x,y,w,h} = box;

      // Background subtle panel
      ctx.save();
      ctx.fillStyle = 'rgba(0,0,0,0.10)';
      ctx.fillRect(x,y,w,h);

      // Title
      ctx.fillStyle = 'rgba(234,240,255,0.92)';
      ctx.font = '600 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText(title, x+10, y+18);

      // Plot region
      const padL = 55, padR = 18, padT = 28, padB = 46;
      const px = x + padL, py = y + padT, pw = w - padL - padR, ph = h - padT - padB;

      // Grid + ticks
      ctx.strokeStyle = 'rgba(255,255,255,0.12)';
      ctx.lineWidth = 1;

      const n = ticks;
      for(let i=0;i<=n;i++){
        const tx = px + (pw*i/n);
        const ty = py + (ph*i/n);

        if(grid){
          ctx.beginPath(); ctx.moveTo(tx, py); ctx.lineTo(tx, py+ph); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(px, ty); ctx.lineTo(px+pw, ty); ctx.stroke();
        }
      }

      // Axes frame
      ctx.strokeStyle = 'rgba(255,255,255,0.35)';
      ctx.lineWidth = 1.2;
      ctx.strokeRect(px, py, pw, ph);

      // Tick labels
      ctx.fillStyle = 'rgba(184,196,255,0.95)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

      // x ticks
      for(let i=0;i<=n;i++){
        const val = xMin + (xMax-xMin)*i/n;
        const tx = px + (pw*i/n);
        ctx.beginPath();
        ctx.moveTo(tx, py+ph);
        ctx.lineTo(tx, py+ph+tickSize);
        ctx.strokeStyle = 'rgba(255,255,255,0.35)';
        ctx.stroke();
        const s = (Math.abs(val) >= 1000 || Math.abs(val) < 0.01) ? val.toExponential(1) : val.toFixed(2);
        ctx.fillText(s, tx-14, py+ph+tickSize+14);
      }

      // y ticks
      for(let i=0;i<=n;i++){
        const val = yMax - (yMax-yMin)*i/n;
        const ty = py + (ph*i/n);
        ctx.beginPath();
        ctx.moveTo(px, ty);
        ctx.lineTo(px-tickSize, ty);
        ctx.strokeStyle = 'rgba(255,255,255,0.35)';
        ctx.stroke();
        const s = (Math.abs(val) >= 1000 || Math.abs(val) < 0.01) ? val.toExponential(1) : val.toFixed(1);
        ctx.fillText(s, px-50, ty+4);
      }

      // Axis labels
      ctx.fillStyle = 'rgba(234,240,255,0.85)';
      ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText(xLabel, px + pw/2 - ctx.measureText(xLabel).width/2, y + h - 12);

      // y label (rotated)
      ctx.save();
      ctx.translate(x+14, py + ph/2);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
      ctx.restore();

      ctx.restore();

      return {
        plot:{x:px, y:py, w:pw, h:ph},
        mapX:(vx)=> px + (vx - xMin) * (pw/(xMax-xMin)),
        mapY:(vy)=> py + (yMax - vy) * (ph/(yMax-yMin))
      };
    }

    function drawLegend(ctx, items, x, y){
      ctx.save();
      ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      let yy = y;
      items.forEach(it=>{
        ctx.fillStyle = it.color;
        ctx.fillRect(x, yy-9, 12, 12);
        ctx.fillStyle = 'rgba(234,240,255,0.9)';
        ctx.fillText(it.label, x+18, yy);
        yy += 16;
      });
      ctx.restore();
    }

    function drawPolyline(ctx, pts, color, width){
      if(pts.length<2) return;
      ctx.save();
      ctx.strokeStyle = color;
      ctx.lineWidth = width || 2;
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
      ctx.stroke();
      ctx.restore();
    }

    function drawPoint(ctx, x, y, color, r){
      ctx.save();
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(x,y,r||4,0,Math.PI*2);
      ctx.fill();
      ctx.restore();
    }

    // ---------------------------
    // Draw SOA diagram
    // ---------------------------
    const diag = setupCanvas(document.getElementById('cDiagram'));
    function renderDiagram(dn18, B, gp){
      const {ctx} = diag;
      const {w,h} = diag.resize();
      ctx.clearRect(0,0,w,h);

      // Title bar
      ctx.fillStyle = 'rgba(234,240,255,0.92)';
      ctx.font = '700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Diagram: InGaAsP SOA (carrier injection → gain spectrum)', 12, 20);

      // Draw waveguide block
      const margin = 18;
      const x0 = margin, y0 = 40;
      const ww = w - 2*margin, hh = h - 70;

      // device body
      const devX = x0 + ww*0.18;
      const devY = y0 + hh*0.30;
      const devW = ww*0.64;
      const devH = hh*0.38;

      // subtle background frame
      ctx.strokeStyle = 'rgba(255,255,255,0.14)';
      ctx.strokeRect(x0, y0, ww, hh);

      // waveguide rails
      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x0+10, devY+devH*0.25);
      ctx.lineTo(devX, devY+devH*0.25);
      ctx.moveTo(devX+devW, devY+devH*0.25);
      ctx.lineTo(x0+ww-10, devY+devH*0.25);
      ctx.moveTo(x0+10, devY+devH*0.75);
      ctx.lineTo(devX, devY+devH*0.75);
      ctx.moveTo(devX+devW, devY+devH*0.75);
      ctx.lineTo(x0+ww-10, devY+devH*0.75);
      ctx.stroke();

      // SOA block
      ctx.fillStyle = 'rgba(124,246,255,0.10)';
      ctx.strokeStyle = 'rgba(124,246,255,0.35)';
      ctx.lineWidth = 2;
      roundRect(ctx, devX, devY, devW, devH, 14, true, true);

      // labels
      ctx.fillStyle = 'rgba(234,240,255,0.92)';
      ctx.font = '700 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Active region (InGaAsP)', devX+14, devY+22);

      // injection arrow (top)
      const injX = devX + devW*0.70;
      const injY0 = y0 + 18;
      const injY1 = devY;
      ctx.strokeStyle = 'rgba(167,255,124,0.55)';
      ctx.lineWidth = 3;
      arrow(ctx, injX, injY0, injX, injY1, 10);
      ctx.fillStyle = 'rgba(167,255,124,0.95)';
      ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Carrier injection', injX-56, injY0+12);

      // input/output arrows (light)
      const inY = devY + devH*0.50;
      ctx.strokeStyle = 'rgba(124,246,255,0.60)';
      ctx.lineWidth = 3;
      arrow(ctx, x0+18, inY, devX, inY, 10);
      arrow(ctx, devX+devW, inY, x0+ww-18, inY, 10);

      ctx.fillStyle = 'rgba(184,196,255,0.95)';
      ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Input signal', x0+18, inY-12);
      ctx.fillText('Amplified output', x0+ww-130, inY-12);

      // Annotate current operating point
      const boxX = x0 + 12;
      const boxY = y0 + hh - 64;
      const boxW = ww - 24;
      const boxH = 52;
      ctx.fillStyle = 'rgba(0,0,0,0.22)';
      ctx.strokeStyle = 'rgba(255,255,255,0.14)';
      roundRect(ctx, boxX, boxY, boxW, boxH, 14, true, true);

      ctx.fillStyle = 'rgba(234,240,255,0.92)';
      ctx.font = '600 12.5px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(`Δn = ${dn18.toFixed(2)}×10^18 cm^-3   →   B ≈ ${B.toFixed(2)} THz   ,   γp ≈ ${gp.toFixed(1)} cm^-1`, boxX+12, boxY+32);
    }

    // Helper: rounded rect
    function roundRect(ctx, x, y, w, h, r, fill, stroke){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
      if(fill) ctx.fill();
      if(stroke) ctx.stroke();
    }
    function arrow(ctx, x0,y0,x1,y1, head){
      const dx = x1-x0, dy=y1-y0;
      const L = Math.hypot(dx,dy) || 1;
      const ux = dx/L, uy = dy/L;
      ctx.beginPath();
      ctx.moveTo(x0,y0);
      ctx.lineTo(x1,y1);
      ctx.stroke();
      // head
      const hx = x1 - ux*head, hy = y1 - uy*head;
      const px = -uy, py = ux;
      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(hx + px*head*0.55, hy + py*head*0.55);
      ctx.lineTo(hx - px*head*0.55, hy - py*head*0.55);
      ctx.closePath();
      ctx.fillStyle = ctx.strokeStyle;
      ctx.fill();
    }

    // ---------------------------
    // Main plot: B vs Δn
    // ---------------------------
    const main = setupCanvas(document.getElementById('cMain'));
    function renderMainPlot(dn18_current){
      const {ctx} = main;
      const {w,h} = main.resize();
      ctx.clearRect(0,0,w,h);

      const xMin=1.0, xMax=1.8;
      const yMin=0, yMax=11;

      const ax = drawAxes(ctx, {x:0,y:0,w,h}, xMin,xMax,yMin,yMax, {
        title: 'Bandwidth vs injected carrier concentration',
        xLabel: 'Δn (×10^18 cm^-3)',
        yLabel: 'B (THz)',
        ticks:5,
        grid:true
      });

      // Scatter points (digitized)
      const pts = data.dn18.map((dn,i)=>({
        x: ax.mapX(dn),
        y: ax.mapY(data.B_THz[i])
      }));
      pts.forEach(p=>drawPoint(ctx,p.x,p.y,'rgba(124,246,255,0.9)',4.2));

      // Fit line
      const linePts = [];
      for(let i=0;i<=80;i++){
        const dn = xMin + (xMax-xMin)*i/80;
        linePts.push({x: ax.mapX(dn), y: ax.mapY(Bfit(dn))});
      }
      drawPolyline(ctx, linePts, 'rgba(167,255,124,0.85)', 2.5);

      // Current point highlight
      const Bc = Bfit(dn18_current);
      drawPoint(ctx, ax.mapX(dn18_current), ax.mapY(Bc), 'rgba(255,207,110,0.95)', 6);

      // Legend
      drawLegend(ctx, [
        {label:'Digitized from Fig. 18.2-3(a)', color:'rgba(124,246,255,0.9)'},
        {label:'Linear fit: B ≈ 12.5(Δn/10^18 − 1)', color:'rgba(167,255,124,0.85)'},
        {label:'Slider operating point', color:'rgba(255,207,110,0.95)'}
      ], ax.plot.x + 10, ax.plot.y + 22);
    }

    // ---------------------------
    // Secondary plot: γp vs B
    // ---------------------------
    const sec = setupCanvas(document.getElementById('cSecondary'));
    function renderSecondaryPlot(dn18_current){
      const {ctx} = sec;
      const {w,h} = sec.resize();
      ctx.clearRect(0,0,w,h);

      const xMin=0, xMax=11;   // B in THz
      const yMin=0, yMax=300;  // gamma in cm^-1

      const ax = drawAxes(ctx, {x:0,y:0,w,h}, xMin,xMax,yMin,yMax, {
        title: 'Peak gain coefficient vs bandwidth',
        xLabel: 'B (THz)',
        yLabel: 'γp (cm^-1)',
        ticks:5,
        grid:true
      });

      // Construct paired points from digitized Δn data: (B_i, gp_i)
      const pts = data.B_THz.map((B,i)=>({
        x: ax.mapX(B),
        y: ax.mapY(data.gp_cm[i])
      }));
      pts.forEach(p=>drawPoint(ctx,p.x,p.y,'rgba(124,246,255,0.9)',4.2));

      // Draw a smooth-ish polyline through the points (piecewise linear in underlying variables)
      drawPolyline(ctx, pts, 'rgba(124,246,255,0.65)', 2);

      // Current point from slider: Bfit(dn), gp interpolated from gp(dn)
      const Bc = Bfit(dn18_current);
      const gpc = interp1(data.dn18, data.gp_cm, dn18_current);
      drawPoint(ctx, ax.mapX(Bc), ax.mapY(gpc), 'rgba(255,207,110,0.95)', 6);

      // Legend
      drawLegend(ctx, [
        {label:'Paired points from Fig. (a)+(b)', color:'rgba(124,246,255,0.9)'},
        {label:'Polyline guide', color:'rgba(124,246,255,0.65)'},
        {label:'Slider operating point', color:'rgba(255,207,110,0.95)'}
      ], ax.plot.x + 10, ax.plot.y + 22);

      // Annotation
      ctx.save();
      ctx.fillStyle = 'rgba(234,240,255,0.92)';
      ctx.font = '600 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      const text = `At Δn=${dn18_current.toFixed(2)}:  B≈${Bc.toFixed(2)} THz,  γp≈${gpc.toFixed(1)} cm^-1`;
      ctx.fillText(text, ax.plot.x + 10, ax.plot.y + ax.plot.h - 10);
      ctx.restore();
    }

    // ---------------------------
    // Slider wiring + readout + render all
    // ---------------------------
    const slider = document.getElementById('dnSlider');
    const readout = document.getElementById('readout');

    function renderAll(){
      const dn18 = parseFloat(slider.value);
      const B = Bfit(dn18);
      const gp = interp1(data.dn18, data.gp_cm, dn18);

      // Update readout (also show implied ΔE)
      const dE = h_eVs * (B*1e12);
      readout.textContent = `Δn=${dn18.toFixed(2)}×10^18 cm^-3   |   B=${B.toFixed(2)} THz   |   γp=${gp.toFixed(1)} cm^-1   |   ΔE≈${dE.toFixed(4)} eV`;

      renderDiagram(dn18, B, gp);
      renderMainPlot(dn18);
      renderSecondaryPlot(dn18);
    }

    slider.addEventListener('input', renderAll);
    window.addEventListener('resize', renderAll);

    // Initial render
    renderAll();
  </script>
</body>
</html>
