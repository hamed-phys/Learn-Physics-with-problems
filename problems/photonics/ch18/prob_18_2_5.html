<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>GaAs Semiconductor Optical Amplifier: Gain Spectrum, Center Frequency, and Bandwidth (Worked Lesson)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#121a2a;
      --card2:#0f1626;
      --ink:#e9eefc;
      --muted:#b7c0da;
      --faint:#7f8aac;
      --accent:#7dd3fc;
      --accent2:#a7f3d0;
      --warn:#fbbf24;
      --ok:#34d399;
      --bad:#fb7185;
      --line:rgba(255,255,255,0.10);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(125,211,252,0.12), transparent 60%),
                  radial-gradient(900px 700px at 85% 20%, rgba(167,243,208,0.10), transparent 55%),
                  var(--bg);
      color:var(--ink);
      line-height:1.55;
    }

    header{
      padding: 28px 18px 10px 18px;
      border-bottom: 1px solid var(--line);
      background: linear-gradient(180deg, rgba(18,26,42,0.85), rgba(11,15,23,0.2));
      position: relative;
      overflow:hidden;
    }
    header .wrap{
      max-width: 1200px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 18px;
      align-items: start;
    }
    h1{
      margin:0 0 10px 0;
      font-weight: 800;
      letter-spacing: -0.02em;
      font-size: clamp(1.45rem, 2.2vw, 2.2rem);
    }
    header p{
      margin: 0;
      color: var(--muted);
      max-width: 70ch;
    }
    .meta{
      background: rgba(18,26,42,0.7);
      border: 1px solid var(--line);
      border-radius: 16px;
      padding: 12px 14px;
      box-shadow: var(--shadow);
    }
    .meta .k{
      display:flex;
      justify-content: space-between;
      gap: 10px;
      padding: 6px 0;
      border-bottom: 1px dashed rgba(255,255,255,0.12);
      font-size: 0.95rem;
    }
    .meta .k:last-child{ border-bottom:none; }
    .meta span{ color: var(--muted); }
    .meta b{ color: var(--ink); font-weight: 700; }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 18px;
    }

    nav.toc{
      position: sticky;
      top: 14px;
      align-self: start;
      background: rgba(18,26,42,0.75);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 14px 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    nav.toc h2{
      margin:0 0 8px 0;
      font-size: 0.95rem;
      color: var(--muted);
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    nav.toc a{
      display:block;
      padding: 8px 10px;
      border-radius: 12px;
      color: var(--ink);
      text-decoration:none;
      border: 1px solid transparent;
      font-size: 0.96rem;
      transition: transform 120ms ease, background 120ms ease, border-color 120ms ease;
    }
    nav.toc a:hover{
      background: rgba(125,211,252,0.10);
      border-color: rgba(125,211,252,0.20);
      transform: translateX(2px);
    }

    article{
      min-width: 0;
    }

    section{
      background: rgba(18,26,42,0.55);
      border: 1px solid var(--line);
      border-radius: 18px;
      padding: 16px 16px;
      margin-bottom: 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    section h2{
      margin: 0 0 8px 0;
      font-size: 1.25rem;
      letter-spacing: -0.01em;
    }
    section h3{
      margin: 14px 0 6px 0;
      font-size: 1.05rem;
      color: var(--accent);
    }
    section p, section li{
      color: var(--muted);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
      nav.toc{ position: relative; top:0; }
      header .wrap{ grid-template-columns: 1fr; }
      .grid2, .grid3{ grid-template-columns: 1fr; }
    }

    .callout{
      border-radius: 16px;
      padding: 12px 12px;
      border: 1px solid var(--line);
      background: rgba(15,22,38,0.65);
    }
    .callout strong{ color: var(--ink); }
    .callout.assump{ border-left: 4px solid var(--warn); }
    .callout.eq{ border-left: 4px solid var(--accent); }
    .callout.mist{ border-left: 4px solid var(--bad); }
    .callout.ans{ border-left: 4px solid var(--ok); }

    .eqline{
      font-family: var(--mono);
      color: var(--ink);
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 10px 10px;
      border-radius: 14px;
      overflow:auto;
      white-space: nowrap;
      margin: 8px 0;
    }
    .eqwrap{
      display:flex;
      gap: 10px;
      align-items: flex-start;
    }
    .copybtn{
      appearance:none;
      border:none;
      background: rgba(125,211,252,0.18);
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      border: 1px solid rgba(125,211,252,0.30);
      font-weight: 650;
      transition: transform 120ms ease, background 120ms ease;
      min-width: 86px;
    }
    .copybtn:hover{ transform: translateY(-1px); background: rgba(125,211,252,0.24); }
    .copybtn:active{ transform: translateY(0px) scale(0.99); }
    .small{ font-size: 0.92rem; color: var(--faint); }

    figure{
      margin: 0;
      padding: 0;
    }
    .canvasCard{
      border: 1px solid var(--line);
      border-radius: 18px;
      overflow:hidden;
      background: rgba(10,14,22,0.6);
    }
    .canvasHeader{
      padding: 10px 12px;
      border-bottom: 1px solid rgba(255,255,255,0.10);
      display:flex;
      justify-content: space-between;
      align-items: center;
      gap: 12px;
      flex-wrap: wrap;
    }
    .canvasHeader .title{
      font-weight: 750;
      color: var(--ink);
    }
    .controls{
      display:flex;
      gap: 10px;
      align-items: center;
      flex-wrap: wrap;
    }
    label{
      color: var(--muted);
      font-size: 0.95rem;
    }
    input[type="range"]{
      width: min(320px, 60vw);
      accent-color: var(--accent);
    }
    .pill{
      font-family: var(--mono);
      font-size: 0.92rem;
      color: var(--ink);
      background: rgba(125,211,252,0.10);
      border: 1px solid rgba(125,211,252,0.25);
      padding: 6px 8px;
      border-radius: 999px;
    }

    footer{
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 18px 30px 18px;
      color: var(--faint);
    }

    @media print{
      body{ background: #fff; color:#000; }
      header, section, nav.toc{ box-shadow:none; backdrop-filter:none; background:#fff; }
      nav.toc{ display:none; }
      .eqline{ background:#f5f5f5; color:#000; }
      .copybtn{ display:none; }
      canvas{ display:none; }
    }

    /* Subtle motion */
    @media (prefers-reduced-motion: no-preference){
      section{
        animation: fadeUp 240ms ease both;
      }
      @keyframes fadeUp{
        from{ opacity:0; transform: translateY(6px); }
        to{ opacity:1; transform: translateY(0); }
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div>
        <h1>GaAs Amplifier Gain & Bandwidth (T = 0 K): Center Frequency, Bandwidth, and Peak Net Gain</h1>
        <p>
          A mini-lecture + fully worked solution for a GaAs semiconductor optical amplifier (SOA) model using
          parabolic bands, quasi-Fermi levels, and the joint density of states. Includes interactive plots you can
          control by changing the drive current.
        </p>
      </div>
      <aside class="meta" aria-label="Problem snapshot">
        <div class="k"><span>Material</span><b>GaAs</b></div>
        <div class="k"><span>Device</span><b>l = 200 μm, w = 10 μm, t = 2 μm</b></div>
        <div class="k"><span>Drive</span><b>I = 1 mA</b></div>
        <div class="k"><span>Assumption</span><b>T = 0 K (step-like Fermi functions)</b></div>
      </aside>
    </div>
  </header>

  <main>
    <nav class="toc" aria-label="Table of contents">
      <h2>Table of Contents</h2>
      <a href="#quick">Quick Summary</a>
      <a href="#part0">PART 0 — Concept Primer</a>
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a href="#part2">PART 2 — Strategy & Tips</a>
      <a href="#part3">PART 3 — Full Solution</a>
      <a href="#part4">PART 4 — Deeper Understanding</a>
      <a href="#part5">PART 5 — Visualization Guide</a>
    </nav>

    <article>

      <!-- Quick Summary -->
      <section id="quick">
        <h2>Quick Summary</h2>
        <ul>
          <li><b>What this is about:</b> a GaAs <i>interband</i> semiconductor optical amplifier’s <b>gain spectrum</b> and <b>gain bandwidth</b> under carrier injection.</li>
          <li><b>Key physics idea:</b> injected carriers create <b>population inversion</b>; at <b>T = 0 K</b> the inversion window is set by the <b>Fermi wavevector</b> of the electron/hole gases.</li>
          <li><b>Carrier density from current:</b> steady state uses <span class="small">(injection = recombination)</span> → <b>N = I τ / (q V)</b>.</li>
          <li><b>Gain bandwidth:</b> positive gain extends from <b>E = E<sub>g</sub></b> up to <b>E = E<sub>g</sub> + ΔE</b>, with <b>ΔE = ħ²k<sub>F</sub>²/(2m<sub>r</sub>)</b>.</li>
          <li><b>Center/peak frequency:</b> band-edge frequency <b>f<sub>g</sub> = E<sub>g</sub>/h</b>; the gain window spans <b>Δf = ΔE/h</b>; we use <b>f<sub>center</sub> = (E<sub>g</sub> + ΔE/2)/h</b> and <b>f<sub>peak</sub> = (E<sub>g</sub> + ΔE)/h</b>.</li>
          <li><b>Peak net gain:</b> from a simple two-band k·p model and joint DOS, <b>g(E) ∝ √(E − E<sub>g</sub>)</b> in the gain window, so the <b>peak occurs at the high-energy edge</b>.</li>
          <li><b>Final result type:</b> numeric center frequency, bandwidth, and peak gain; then channel count and bitrate from the bandwidth.</li>
        </ul>
      </section>

      <!-- PART 0 -->
      <section id="part0">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <h3>Core definitions (symbols & units)</h3>
        <ul>
          <li><b>E<sub>g</sub></b> (eV or J): semiconductor <b>bandgap energy</b>, minimum photon energy for interband transitions.</li>
          <li><b>N</b> (cm<sup>−3</sup> or m<sup>−3</sup>): injected <b>electron density</b> (and ≈ hole density) in the active region.</li>
          <li><b>τ</b> (s): effective <b>carrier recombination lifetime</b> (how quickly carriers recombine).</li>
          <li><b>k<sub>F</sub></b> (m<sup>−1</sup>): <b>Fermi wavevector</b> of a 3D electron (or hole) gas, related to density by <b>k<sub>F</sub> = (3π²N)<sup>1/3</sup></b>.</li>
          <li><b>m<sub>c</sub>, m<sub>v</sub></b> (kg): effective masses in conduction/valence bands; reduced mass <b>m<sub>r</sub> = (m<sub>c</sub>m<sub>v</sub>)/(m<sub>c</sub>+m<sub>v</sub>)</b>.</li>
          <li><b>g(ω)</b> (m<sup>−1</sup> or cm<sup>−1</sup>): <b>material gain coefficient</b> (net stimulated emission per length for optical intensity in a simple model).</li>
          <li><b>Bandwidth Δf</b> (Hz): frequency span where <b>net gain &gt; 0</b>.</li>
        </ul>

        <h3>Physical meaning (what the quantities “feel like”)</h3>
        <ul>
          <li><b>Injection current I</b> sets how many carriers are stored in the active region before they recombine.</li>
          <li><b>At T = 0 K</b>, carriers fill states sharply up to a Fermi energy (step function). That makes the gain spectrum have a sharp cutoff.</li>
          <li><b>Gain exists</b> for photon energies where the conduction band states are occupied (electrons available to fall) while the corresponding valence states are empty (holes available to accept the transition).</li>
        </ul>

        <h3>Key principles and validity</h3>
        <div class="callout assump">
          <strong>Model assumptions (valid when…)</strong>
          <ul>
            <li>Direct-gap GaAs, <b>parabolic bands</b> near the band edges.</li>
            <li><b>3D carrier gas</b> in a bulk-like active region (not a quantum well).</li>
            <li><b>Steady-state</b>: injected carriers balance recombination.</li>
            <li><b>T = 0 K</b>: Fermi-Dirac → step functions (sharp spectral edges).</li>
            <li>We treat the optical transition matrix element using a <b>simple two-band k·p relation</b> from the given effective mass.</li>
          </ul>
        </div>

        <h3>Common approximations and why we use them</h3>
        <ul>
          <li><b>Steady-state carrier storage:</b> instead of detailed transport, we use a “bucket” model: carriers stored = injection rate × lifetime.</li>
          <li><b>Joint density of states (JDOS):</b> the number of allowed interband transitions grows like √(E−E<sub>g</sub>) in 3D parabolic bands.</li>
          <li><b>Two-band matrix element estimate:</b> effective mass and bandgap give a reasonable order-of-magnitude coupling strength.</li>
        </ul>

        <h3>Mini intuition examples (quick)</h3>
        <ul>
          <li>If you <b>double the current</b>, you raise N, which raises k<sub>F</sub> ∝ N<sup>1/3</sup>. So the <b>gain bandwidth grows slowly</b> (cube-root law).</li>
          <li>If m<sub>r</sub> were smaller (lighter carriers), then ΔE = ħ²k<sub>F</sub>²/(2m<sub>r</sub>) would be larger → <b>wider gain bandwidth</b>.</li>
        </ul>

        <h3>What to watch for (pitfalls)</h3>
        <div class="callout mist">
          <strong>Typical mistakes</strong>
          <ul>
            <li>Forgetting to use the <b>active volume</b> V = l·w·t when converting current to carrier density.</li>
            <li>Mixing units: cm<sup>−3</sup> vs m<sup>−3</sup>, eV vs J.</li>
            <li>Confusing “center frequency” (midband) with “peak gain frequency” (often near the high-energy edge in this idealized model).</li>
            <li>Assuming bandwidth scales linearly with current—here it scales roughly as <b>I<sup>2/3</sup></b>.</li>
          </ul>
        </div>
      </section>

      <!-- PART 1 -->
      <section id="part1">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <h3>Restate the problem</h3>
        <p>
          We have a GaAs optical amplifier of known dimensions. A DC current of 1 mA injects carriers.
          Assuming T = 0 K and given effective masses and bandgap, we must find:
          (a) the gain spectrum characteristics: <b>center frequency</b>, <b>bandwidth</b>, and <b>peak net gain</b>;
          (b) the number of 4 kHz voice channels that fit in that bandwidth;
          (c) the total bit rate if each voice channel needs 64 kb/s.
        </p>

        <h3>Given quantities</h3>
        <ul>
          <li>Intrinsic carrier concentration: n<sub>i</sub> = 1.8×10<sup>6</sup> cm<sup>−3</sup> (provided; at T=0 K, injection dominates anyway)</li>
          <li>Recombination lifetime: τ = 50 ns</li>
          <li>Bandgap: E<sub>g</sub> = 1.42 eV</li>
          <li>Effective masses: m<sub>c</sub> = 0.07 m<sub>0</sub>, m<sub>v</sub> = 0.50 m<sub>0</sub></li>
          <li>Dimensions: l = 200 μm, w = 10 μm, thickness = 2 μm</li>
          <li>Current: I = 1 mA</li>
          <li>Temperature: T = 0 K</li>
        </ul>

        <h3>Unknowns</h3>
        <ul>
          <li>Center frequency f<sub>center</sub> (Hz) and/or peak frequency f<sub>peak</sub> (Hz)</li>
          <li>Bandwidth Δf (Hz)</li>
          <li>Peak net gain g<sub>peak</sub> (m<sup>−1</sup> or cm<sup>−1</sup>)</li>
          <li>Number of voice channels N<sub>ch</sub></li>
          <li>Total bit rate R (b/s)</li>
        </ul>

        <h3>Relevant principles (and why they apply)</h3>
        <ul>
          <li><b>Carrier rate balance:</b> In steady state, injection supplies carriers at rate I/q and they disappear at rate N·V/τ → gives N.</li>
          <li><b>Degenerate carrier statistics at T=0:</b> occupancy is a step; inversion window is limited by k<sub>F</sub>.</li>
          <li><b>Interband transition energy:</b> for parabolic bands with same k, photon energy is E = E<sub>g</sub> + ħ²k²/(2m<sub>r</sub>).</li>
          <li><b>Gain spectrum shape:</b> in 3D, JDOS gives g(E) ∝ √(E−E<sub>g</sub>) times an inversion factor (here idealized to 1 within the allowed k window).</li>
        </ul>

        <h3>Assumptions (explicit)</h3>
        <div class="callout assump">
          <strong>Assumptions used in the solution</strong>
          <ul>
            <li>Uniform carrier density in the active volume V = l·w·t.</li>
            <li>n ≈ p ≈ N from injection (intrinsic n<sub>i</sub> negligible compared to injected N).</li>
            <li>T = 0 K → sharp gain cutoff; no broadening, no many-body effects.</li>
            <li>Peak net gain ≈ material gain (no internal loss given, so we do not subtract α).</li>
            <li>To compute an absolute gain number, we adopt a simple two-band k·p estimate for the optical matrix element and use a typical GaAs refractive index <b>n<sub>r</sub> ≈ 3.6</b> (not provided in the statement). The bandwidth and center frequency do <i>not</i> depend on n<sub>r</sub>.</li>
          </ul>
        </div>

        <h3>Possible approaches (compare)</h3>
        <ol>
          <li><b>Bucket (rate-equation) + T=0 k-space window + JDOS gain</b><br/>
            <span class="small">Pros: uses only given τ, geometry, masses, E<sub>g</sub>; yields bandwidth cleanly. Cons: idealized sharp edges; absolute gain needs an estimated matrix element.</span></li>
          <li><b>Empirical gain model g = g<sub>0</sub>(N − N<sub>tr</sub>)</b><br/>
            <span class="small">Pros: simple; Cons: requires differential gain g<sub>0</sub> and transparency density N<sub>tr</sub>, not given.</span></li>
          <li><b>Full semiconductor Bloch / many-body model</b><br/>
            <span class="small">Pros: realistic spectra; Cons: far beyond given data and not intended here.</span></li>
        </ol>

        <p><b>Chosen approach:</b> Approach (1) is best: it uses the given physics inputs directly and matches the explicit T = 0 K hint (sharp Fermi surfaces).</p>
      </section>

      <!-- PART 2 -->
      <section id="part2">
        <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

        <ol>
          <li><b>Compute active volume</b><br/>
            Goal: find V = l·w·t. Tool: geometry. Meaning: physical storage region for carriers.</li>
          <li><b>Convert current to carrier density</b><br/>
            Goal: find N from steady-state balance. Tool: N = Iτ/(qV). Meaning: how “degenerate” the carrier gas is.</li>
          <li><b>Find Fermi wavevector</b><br/>
            Goal: compute k<sub>F</sub> = (3π²N)<sup>1/3</sup>. Meaning: radius of the filled k-space sphere at T=0.</li>
          <li><b>Map k-window to photon-energy window</b><br/>
            Goal: compute ΔE = ħ²k<sub>F</sub>²/(2m<sub>r</sub>). Tool: parabolic band transition energy. Meaning: gain bandwidth in energy.</li>
          <li><b>Convert energy window to frequency bandwidth</b><br/>
            Goal: Δf = ΔE/h. Meaning: how much spectrum supports net gain.</li>
          <li><b>Compute center and peak frequency</b><br/>
            Goal: f<sub>g</sub>=E<sub>g</sub>/h, f<sub>center</sub>=(E<sub>g</sub>+ΔE/2)/h, f<sub>peak</sub>=(E<sub>g</sub>+ΔE)/h. Meaning: where the band lies in the optical spectrum.</li>
          <li><b>Compute peak gain (absolute)</b><br/>
            Goal: g(E) using JDOS and a matrix element estimate; peak at E = E<sub>g</sub>+ΔE. Meaning: maximum stimulated emission per length in this ideal model.</li>
          <li><b>Communications parts</b><br/>
            Goal: channels = Δf/(4 kHz), bitrate = channels·(64 kb/s). Meaning: capacity if you could slice the optical bandwidth into independent voice channels.</li>
        </ol>

        <div class="callout mist">
          <strong>Quick tips</strong>
          <ul>
            <li>Do all physics in SI, then convert at the end (eV ↔ J, m<sup>−3</sup> ↔ cm<sup>−3</sup>).</li>
            <li>Bandwidth comes from <b>k-space filling</b>; it scales as <b>N<sup>2/3</sup></b> → as <b>I<sup>2/3</sup></b>.</li>
            <li>For the absolute gain, remember: JDOS ~ √(E−E<sub>g</sub>) and there is also a 1/ω factor in many dipole-coupling forms.</li>
          </ul>
        </div>
      </section>

      <!-- PART 3 -->
      <section id="part3">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Physical intuition first (what to expect)</h3>
        <p>
          Injecting 1 mA into a tiny volume creates a substantial carrier density.
          At T = 0 K, those carriers fill a sphere in k-space up to k<sub>F</sub>. Interband transitions with the same
          k are allowed. Therefore, gain will exist from the bandgap energy E<sub>g</sub> (k=0) up to the transition energy
          at the Fermi surface (k=k<sub>F</sub>). Because the 3D density of states increases with √(E−E<sub>g</sub>),
          this idealized gain spectrum rises with energy until it abruptly stops at the high-energy edge: the <b>peak gain occurs at the top of the gain window</b>.
        </p>

        <h3>Step 1: Active volume</h3>
        <p>Convert dimensions to meters:</p>
        <ul>
          <li>l = 200 μm = 200×10<sup>−6</sup> m</li>
          <li>w = 10 μm = 10×10<sup>−6</sup> m</li>
          <li>t = 2 μm = 2×10<sup>−6</sup> m</li>
        </ul>

        <div class="eqwrap">
          <div class="eqline" id="eqV">V = l · w · t</div>
          <button class="copybtn" data-copy="#eqV">Copy</button>
        </div>

        <p>Compute:</p>
        <div class="eqline" id="eqVnum">
          V = (200×10^-6)(10×10^-6)(2×10^-6) m^3 = 4.0×10^-15 m^3
        </div>
        <div class="small">Explanation: this is the “carrier storage tank” volume for recombination balance.</div>

        <h3>Step 2: Carrier density from steady-state injection–recombination balance</h3>
        <p>
          In steady state, the injection rate of carriers is I/q (carriers per second),
          and the recombination rate is (N·V)/τ. Setting them equal:
        </p>

        <div class="eqwrap">
          <div class="eqline" id="eqN">I/q = (N · V)/τ  ⇒  N = (I τ)/(q V)</div>
          <button class="copybtn" data-copy="#eqN">Copy</button>
        </div>

        <p>Insert numbers: I = 1 mA = 1×10<sup>−3</sup> A, τ = 50 ns = 50×10<sup>−9</sup> s, q = 1.602×10<sup>−19</sup> C, V = 4.0×10<sup>−15</sup> m<sup>3</sup>.</p>

        <div class="eqline" id="eqNnum">
          N = (1×10^-3 · 50×10^-9) / (1.602×10^-19 · 4.0×10^-15)  ≈ 7.80×10^22 m^-3  = 7.80×10^16 cm^-3
        </div>

        <div class="small">
          What we did: used a simple rate balance. Why it works: the problem provides τ and asks for steady-state gain properties, implying steady storage.
        </div>

        <h3>Step 3: Fermi wavevector at T = 0 K</h3>
        <p>
          For a 3D (spin-degenerate) electron gas at T=0 K:
        </p>
        <div class="eqwrap">
          <div class="eqline" id="eqkF">k_F = (3π^2 N)^(1/3)</div>
          <button class="copybtn" data-copy="#eqkF">Copy</button>
        </div>

        <p>Compute k<sub>F</sub> using N = 7.80×10<sup>22</sup> m<sup>−3</sup>:</p>
        <div class="eqline" id="eqkFnum">
          k_F ≈ (3π^2 · 7.80×10^22)^(1/3) ≈ 1.32×10^8 m^-1
        </div>

        <div class="small">
          Interpretation: k<sub>F</sub> sets the maximum crystal momentum (and therefore maximum transition energy) that still has inversion.
        </div>

        <h3>Step 4: Convert k-window to gain window in photon energy</h3>
        <p>
          For direct interband transitions with the same k in parabolic bands, the photon energy is
        </p>
        <div class="eqwrap">
          <div class="eqline" id="eqEofk">E_ph(k) = E_g + (ħ^2 k^2)/(2 m_r),  where  m_r = (m_c m_v)/(m_c + m_v)</div>
          <button class="copybtn" data-copy="#eqEofk">Copy</button>
        </div>

        <p>Compute reduced mass (m<sub>0</sub> is free electron mass):</p>
        <div class="eqline" id="eqmr">
          m_c = 0.07 m_0,  m_v = 0.50 m_0  ⇒  m_r = (0.07·0.50)/(0.07+0.50) m_0 ≈ 0.0614 m_0
        </div>

        <p>
          At T=0, inversion (and therefore gain) exists up to k = k<sub>F</sub>. Thus the <b>energy width</b> of the gain window is:
        </p>

        <div class="eqwrap">
          <div class="eqline" id="eqdE">ΔE = (ħ^2 k_F^2)/(2 m_r)</div>
          <button class="copybtn" data-copy="#eqdE">Copy</button>
        </div>

        <p>Compute ΔE:</p>
        <div class="eqline" id="eqdEnum">
          ΔE ≈ (ħ^2 (1.32×10^8)^2)/(2 · 0.0614 m_0) ≈ 1.74×10^-21 J ≈ 0.01084 eV
        </div>

        <div class="small">
          What we did: translated “filled k-space sphere” into a maximum transition energy. Why: transition energy increases with k².
        </div>

        <h3>Step 5: Bandwidth in frequency</h3>
        <p>Frequency bandwidth is energy bandwidth divided by Planck’s constant:</p>

        <div class="eqwrap">
          <div class="eqline" id="eqdf">Δf = ΔE / h</div>
          <button class="copybtn" data-copy="#eqdf">Copy</button>
        </div>

        <div class="eqline" id="eqdfnum">
          Δf ≈ (1.74×10^-21 J)/(6.626×10^-34 J·s) ≈ 2.62×10^12 Hz  = 2.62 THz
        </div>

        <h3>Step 6: Center frequency and peak (high-edge) frequency</h3>
        <p>
          The band-edge optical frequency is f<sub>g</sub> = E<sub>g</sub>/h. The gain window spans from E<sub>g</sub> to E<sub>g</sub>+ΔE.
          A natural “center” is the midband:
        </p>

        <div class="eqwrap">
          <div class="eqline" id="eqfcenter">f_g = E_g/h,  f_center = (E_g + ΔE/2)/h,  f_peak = (E_g + ΔE)/h</div>
          <button class="copybtn" data-copy="#eqfcenter">Copy</button>
        </div>

        <p>Compute with E<sub>g</sub> = 1.42 eV:</p>
        <div class="eqline" id="eqfnum">
          f_g ≈ 3.4335×10^14 Hz (343.35 THz)
          <br/>f_center ≈ 3.4467×10^14 Hz (344.67 THz)
          <br/>f_peak ≈ 3.4598×10^14 Hz (345.98 THz)
        </div>

        <div class="small">
          Interpretation: this is near λ ≈ c/f ≈ 870–875 nm (near GaAs band edge), and the gain window is a few THz wide.
        </div>

        <h3>Step 7: Peak net gain (absolute value in this ideal model)</h3>
        <p>
          The problem asks for peak net gain “within the bandwidth.” To estimate an absolute number (not just proportionality),
          we use a standard dipole-coupling form for direct-gap semiconductors:
        </p>

        <div class="callout eq">
          <strong>Key gain model (3D, direct gap, parabolic bands)</strong>
          <div class="eqwrap" style="margin-top:8px;">
            <div class="eqline" id="eqgain">
g(E) = [π e^2 |p_cv|^2 /(n_r ε0 m0^2 c ω)] · ρ_j(E) · (f_c - f_v)
            </div>
            <button class="copybtn" data-copy="#eqgain">Copy</button>
          </div>
          <div class="small">
            Here: E = ħω is photon energy; ρ<sub>j</sub>(E) is the joint density of states; (f<sub>c</sub>−f<sub>v</sub>) is the inversion factor.
            At T=0 K, inside the gain window we take (f<sub>c</sub>−f<sub>v</sub>) ≈ 1.
          </div>
        </div>

        <p>The 3D joint density of states for parabolic bands is:</p>
        <div class="eqwrap">
          <div class="eqline" id="eqjdos">
ρ_j(E) = (1/(2π^2)) · (2 m_r/ħ^2)^(3/2) · sqrt(E - E_g)   (for E ≥ E_g)
          </div>
          <button class="copybtn" data-copy="#eqjdos">Copy</button>
        </div>

        <p>
          We still need |p<sub>cv</sub>|². Using a simple two-band k·p relation between effective mass and momentum matrix element:
        </p>
        <div class="eqwrap">
          <div class="eqline" id="eqp2">
1/m_c = 1/m0 + 2|p_cv|^2/(m0^2 E_g)  ⇒  |p_cv|^2 = (m0^2 E_g/2)·(1/m_c - 1/m0)
          </div>
          <button class="copybtn" data-copy="#eqp2">Copy</button>
        </div>

        <p>
          Using E<sub>g</sub>=1.42 eV and m<sub>c</sub>=0.07 m<sub>0</sub> gives |p<sub>cv</sub>|² ≈ 1.38×10<sup>−48</sup> (SI units).
          Taking a typical GaAs refractive index <b>n<sub>r</sub> ≈ 3.6</b>, the gain increases with √(E−E<sub>g</sub>) inside the window,
          so the <b>peak</b> occurs at the high-energy edge: E = E<sub>g</sub> + ΔE.
        </p>

        <div class="eqline" id="eqgpeaknum">
          g_peak ≈ 4.34×10^5 m^-1  = 4.34×10^3 cm^-1  (at E = E_g + ΔE)
        </div>

        <div class="small">
          Note: this is an idealized “material gain” estimate (no loss, no spectral broadening). Real devices have lower net gain due to internal losses and broadened spectra.
        </div>

        <h3>Part (b): Number of 4 kHz voice messages</h3>
        <p>
          If each message occupies 4 kHz of bandwidth, then the number of channels is:
        </p>
        <div class="eqwrap">
          <div class="eqline" id="eqNch">N_ch = Δf / (4 kHz)</div>
          <button class="copybtn" data-copy="#eqNch">Copy</button>
        </div>
        <div class="eqline" id="eqNchnum">
          N_ch ≈ (2.62×10^12 Hz) / (4.0×10^3 Hz) ≈ 6.55×10^8 voice channels
        </div>

        <h3>Part (c): Total bit rate at 64 kb/s per channel</h3>
        <p>
          Total bit rate:
        </p>
        <div class="eqwrap">
          <div class="eqline" id="eqR">R = N_ch · (64 kb/s)</div>
          <button class="copybtn" data-copy="#eqR">Copy</button>
        </div>
        <div class="eqline" id="eqRnum">
          R ≈ (6.55×10^8) · (6.4×10^4 b/s) ≈ 4.19×10^13 b/s  ≈ 41.9 Tb/s
        </div>

        <h3>Sanity checks</h3>
        <ul>
          <li><b>Units:</b> N from Iτ/(qV) → (A·s)/(C·m³) = 1/m³ ✓. ΔE has J ✓. Δf = J/(J·s) = Hz ✓. g has 1/m ✓.</li>
          <li><b>Limiting case:</b> If I → 0, then N → 0 → k<sub>F</sub> → 0 → Δf → 0: the gain window collapses to the band edge ✓.</li>
          <li><b>Scaling:</b> k<sub>F</sub> ∝ N<sup>1/3</sup>, so ΔE ∝ k<sub>F</sub>² ∝ N<sup>2/3</sup> ∝ I<sup>2/3</sup>: slow growth of bandwidth ✓.</li>
          <li><b>Interpretation:</b> A few-THz bandwidth around ~345 THz is physically consistent with a GaAs band-edge (~870 nm) optical transition ✓.</li>
        </ul>

        <div class="callout ans">
          <strong>Final answers (for I = 1 mA)</strong>
          <div class="eqline" id="finalAnswer">
(a) Gain window: from f_g = 343.35 THz to f_peak = 345.98 THz
    Bandwidth: Δf = 2.62 THz
    Center frequency (midband): f_center = 344.67 THz
    Peak net gain (idealized): g_peak ≈ 4.34×10^5 m^-1 = 4.34×10^3 cm^-1

(b) Number of 4 kHz voice channels: N_ch ≈ 6.55×10^8

(c) Total bit rate at 64 kb/s per channel: R ≈ 4.19×10^13 b/s ≈ 41.9 Tb/s
          </div>
          <button class="copybtn" data-copy="#finalAnswer">Copy</button>
          <div class="small">“Center frequency” here is taken as the midband; “peak” is the high-energy edge where this idealized spectrum is largest.</div>
        </div>
      </section>

      <!-- VISUALS -->
      <section id="viz">
        <h2>Interactive Visualizations</h2>
        <p class="small">
          Use the current slider to see how carrier density, bandwidth, and gain spectrum change. The plots update live.
        </p>

        <div class="canvasCard">
          <div class="canvasHeader">
            <div class="title">Control Panel</div>
            <div class="controls">
              <label for="cur">Drive current I (mA)</label>
              <input id="cur" type="range" min="0.1" max="5.0" value="1.0" step="0.1" />
              <span class="pill" id="curRead">1.0 mA</span>
              <span class="pill" id="bwRead">Δf ≈ —</span>
              <span class="pill" id="gRead">g_peak ≈ —</span>
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <figure class="canvasCard">
            <div class="canvasHeader">
              <div class="title">Diagram: SOA Geometry & Carrier Injection</div>
              <div class="small">Not to scale — shows l, w, t and current I</div>
            </div>
            <canvas id="diag" style="width:100%; height:320px; display:block;"></canvas>
          </figure>

          <figure class="canvasCard">
            <div class="canvasHeader">
              <div class="title">Main Plot: Gain Spectrum g(f)</div>
              <div class="small">Idealized T=0 K window: rises ~ √(f−f_g) and cuts off at f_peak</div>
            </div>
            <canvas id="mainPlot" style="width:100%; height:320px; display:block;"></canvas>
          </figure>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <figure class="canvasCard">
            <div class="canvasHeader">
              <div class="title">Secondary Plot: Bandwidth Δf vs Current I</div>
              <div class="small">Shows Δf ∝ I^(2/3) trend from the model</div>
            </div>
            <canvas id="sweepPlot" style="width:100%; height:320px; display:block;"></canvas>
          </figure>

          <figure class="canvasCard">
            <div class="canvasHeader">
              <div class="title">Readouts (Computed from the Same Equations)</div>
              <div class="small">Matches the symbols used in the text</div>
            </div>
            <div style="padding:12px;">
              <div class="callout eq" style="margin-bottom:10px;">
                <strong>Core computed quantities</strong>
                <div class="eqline" id="readouts" style="margin-bottom:0;">
I = 1.0 mA
V = 4.0×10^-15 m^3
N = 7.80×10^22 m^-3
k_F = 1.32×10^8 m^-1
ΔE = 0.01084 eV
f_g = 343.35 THz
Δf = 2.62 THz
f_center = 344.67 THz
f_peak = 345.98 THz
g_peak = 4.34×10^5 m^-1 (idealized)
                </div>
                <button class="copybtn" data-copy="#readouts" style="margin-top:10px;">Copy</button>
              </div>

              <div class="callout assump">
                <strong>Note on absolute gain</strong>
                <p class="small" style="margin:8px 0 0 0;">
                  Bandwidth and frequencies come directly from N and effective masses. The absolute g uses a simple
                  two-band k·p estimate and a typical GaAs refractive index (n<sub>r</sub>≈3.6). If you change n<sub>r</sub>,
                  the plotted gain rescales, but Δf and f-values do not.
                </p>
              </div>
            </div>
          </figure>
        </div>
      </section>

      <!-- PART 4 -->
      <section id="part4">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpreting the formulas: what controls what?</h3>
        <ul>
          <li><b>N = Iτ/(qV):</b> increasing I or τ increases stored carriers; increasing V reduces density (spreads carriers out).</li>
          <li><b>k<sub>F</sub> = (3π²N)<sup>1/3</sup>:</b> degeneracy grows slowly with density (cube root).</li>
          <li><b>ΔE = ħ²k<sub>F</sub>²/(2m<sub>r</sub>):</b> lighter reduced mass → larger bandwidth; larger density → larger bandwidth.</li>
          <li><b>g(E) ∝ ρ<sub>j</sub>(E) ∝ √(E−E<sub>g</sub>):</b> in 3D the transition count grows with √excess energy, so the ideal spectrum rises until cutoff.</li>
        </ul>

        <h3>How changing parameters affects outcomes (connect to plots)</h3>
        <ul>
          <li>Increasing <b>I</b> increases <b>N</b>, which increases <b>Δf</b> approximately like <b>I<sup>2/3</sup></b> → the sweep plot bends downward (sublinear growth).</li>
          <li>Since the peak gain in this ideal model occurs at the high-energy edge, higher I pushes that edge to higher energy and typically increases g<sub>peak</sub>.</li>
          <li>Changing device dimensions changes V and therefore N strongly (inverse proportional), which strongly affects bandwidth and gain.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p>
          Instead of using k<sub>F</sub> and the transition energy E(k), you can compute the electron and hole
          quasi-Fermi energies (E<sub>Fn</sub>, E<sub>Fp</sub>) from N using the 3D T=0 density-of-states integrals.
          Then the maximum photon energy supporting inversion is roughly tied to the quasi-Fermi separation. For equal densities,
          both methods are consistent because the same k<sub>F</sub> sets both the carrier energies and the transition energies.
        </p>

        <h3>Concept checks (with answers)</h3>
        <ul>
          <li><b>Q:</b> Why does Δf grow like I<sup>2/3</sup> instead of I?<br/>
              <b>A:</b> Because Δf ∝ ΔE ∝ k<sub>F</sub>², and k<sub>F</sub> ∝ N<sup>1/3</sup> ∝ I<sup>1/3</sup>.</li>
          <li><b>Q:</b> Why is the gain spectrum not flat inside the window?<br/>
              <b>A:</b> The number of available transitions (JDOS) increases with √(E−E<sub>g</sub>) in 3D.</li>
          <li><b>Q:</b> What physical effect would smooth the sharp cutoff at f<sub>peak</sub>?<br/>
              <b>A:</b> Finite temperature, collision broadening, bandgap renormalization, and inhomogeneous effects.</li>
          <li><b>Q:</b> Which results here are least sensitive to uncertain parameters like n<sub>r</sub>?<br/>
              <b>A:</b> Bandwidth and frequencies (they come from N and effective masses). Absolute gain depends on optical coupling and n<sub>r</sub>.</li>
        </ul>
      </section>

      <!-- PART 5 -->
      <section id="part5">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <h3>Diagram canvas</h3>
        <ul>
          <li>Shows the rectangular active region with labeled <b>length l</b>, <b>width w</b>, and <b>thickness t</b>.</li>
          <li>The arrow indicates injected current <b>I</b>, which sets the carrier density via N = Iτ/(qV).</li>
        </ul>

        <h3>Main plot: Gain spectrum g(f)</h3>
        <ul>
          <li><b>x-axis:</b> optical frequency f in THz near the GaAs band edge.</li>
          <li><b>y-axis:</b> material gain g in cm<sup>−1</sup> (idealized).</li>
          <li>Gain is nonzero only from <b>f<sub>g</sub></b> to <b>f<sub>peak</sub> = f<sub>g</sub> + Δf</b>.</li>
          <li>The curve rises like √(f−f<sub>g</sub>) then drops to zero abruptly at the cutoff (T=0 K idealization).</li>
        </ul>

        <h3>Secondary plot: Bandwidth Δf vs current</h3>
        <ul>
          <li>Shows how Δf changes with I for this device, keeping τ and geometry fixed.</li>
          <li>You should see a <b>sublinear</b> increase: doubling I increases Δf by less than 2×.</li>
          <li>The highlighted point corresponds to your current slider value.</li>
        </ul>

        <h3>Interactive control</h3>
        <ul>
          <li><b>Slider:</b> changes current I (mA).</li>
          <li><b>What updates:</b> carrier density N, k<sub>F</sub>, ΔE, f<sub>g</sub>/f<sub>center</sub>/f<sub>peak</sub>, Δf, and the plotted gain spectrum and bandwidth sweep marker.</li>
          <li><b>Why:</b> all these quantities are chained through N = Iτ/(qV) and the parabolic-band transition energy.</li>
        </ul>
      </section>

    </article>
  </main>

  <footer>
    <div>
      <b>Disclaimer:</b> This is a pedagogical T = 0 K, idealized bulk (3D) SOA model. Real GaAs amplifiers have finite-temperature broadening,
      internal loss, nonuniform carrier distributions, and often quantum-well confinement.
    </div>
  </footer>

  <script>
    // ---------- Copy buttons ----------
    (function(){
      function copyTextFromSelector(sel){
        const el = document.querySelector(sel);
        if(!el) return;
        const txt = el.innerText.replace(/\u00a0/g,' ');
        navigator.clipboard.writeText(txt).then(()=>{
          // tiny feedback by toggling button text briefly
        }).catch(()=>{});
      }
      document.addEventListener('click', (e)=>{
        const btn = e.target.closest('.copybtn');
        if(!btn) return;
        const sel = btn.getAttribute('data-copy');
        if(!sel) return;
        const original = btn.textContent;
        copyTextFromSelector(sel);
        btn.textContent = 'Copied!';
        setTimeout(()=>btn.textContent = original, 850);
      });
    })();

    // ---------- Physics constants ----------
    const CONST = {
      q: 1.602176634e-19,
      h: 6.62607015e-34,
      hbar: 1.054571817e-34,
      eps0: 8.8541878128e-12,
      c: 299792458,
      m0: 9.1093837015e-31
    };

    // Given device + material
    const GIVEN = {
      Eg_eV: 1.42,
      mc_rel: 0.07,
      mv_rel: 0.50,
      tau: 50e-9, // s
      l: 200e-6,  // m
      w: 10e-6,   // m
      t: 2e-6,    // m
      nr: 3.6     // typical GaAs refractive index (used only for absolute gain scaling)
    };

    function computeAll(I_mA){
      const I = I_mA * 1e-3; // A
      const V = GIVEN.l * GIVEN.w * GIVEN.t; // m^3
      const N = (I * GIVEN.tau) / (CONST.q * V); // m^-3
      const mc = GIVEN.mc_rel * CONST.m0;
      const mv = GIVEN.mv_rel * CONST.m0;
      const mr = (mc*mv)/(mc+mv);

      const kF = Math.cbrt(3*Math.PI*Math.PI*N); // (3π^2 N)^(1/3)
      const dE_J = (CONST.hbar*CONST.hbar*kF*kF)/(2*mr);
      const dE_eV = dE_J / CONST.q;

      const Eg_J = GIVEN.Eg_eV * CONST.q;
      const f_g = Eg_J / CONST.h;
      const df = dE_J / CONST.h;
      const f_center = (Eg_J + 0.5*dE_J)/CONST.h;
      const f_peak = (Eg_J + dE_J)/CONST.h;

      // Two-band k·p estimate for |p_cv|^2:
      // 1/mc = 1/m0 + 2 p^2 /(m0^2 Eg)  =>  p^2 = (m0^2 Eg/2)(1/mc - 1/m0)
      const p2 = (CONST.m0*CONST.m0*Eg_J/2) * (1/mc - 1/CONST.m0);

      function rhoj(E_J){
        if(E_J < Eg_J) return 0;
        const x = E_J - Eg_J;
        return (1/(2*Math.PI*Math.PI)) * Math.pow((2*mr)/(CONST.hbar*CONST.hbar), 1.5) * Math.sqrt(x);
      }

      function gainAtE(E_J){
        if(E_J < Eg_J) return 0;
        const omega = E_J / CONST.hbar;
        const pref = (Math.PI*CONST.q*CONST.q * p2) / (GIVEN.nr * CONST.eps0 * CONST.m0*CONST.m0 * CONST.c * omega);
        // inversion factor ~1 within window (T=0 ideal)
        return pref * rhoj(E_J); // 1/m
      }

      const Epeak_J = Eg_J + dE_J;
      const g_peak_m = gainAtE(Epeak_J);
      const g_peak_cm = g_peak_m / 100;

      return {
        I_mA, I, V, N, kF, dE_J, dE_eV, Eg_J,
        f_g, df, f_center, f_peak,
        mc, mv, mr, p2,
        g_peak_m, g_peak_cm,
        gainAtE
      };
    }

    // ---------- Canvas helpers ----------
    function setupHiDPICanvas(canvas){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(2, Math.floor(rect.width * dpr));
      const h = Math.max(2, Math.floor(rect.height * dpr));
      if(canvas.width !== w || canvas.height !== h){
        canvas.width = w; canvas.height = h;
      }
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
      return {ctx, w: rect.width, h: rect.height, dpr};
    }

    function drawAxes(ctx, x0,y0,w,h, opts){
      // opts: {xLabel,yLabel, xMin,xMax,yMin,yMax, xTicks,yTicks, title}
      const {
        xLabel,yLabel,xMin,xMax,yMin,yMax,
        xTicks=6,yTicks=5,title=''
      } = opts;

      // Background
      ctx.save();
      ctx.clearRect(0,0, w,h);

      // Panel background
      ctx.fillStyle = 'rgba(10,14,22,0.55)';
      ctx.fillRect(0,0,w,h);

      // Plot area
      const padL=52, padR=18, padT=34, padB=44;
      const px0 = padL, py0 = padT;
      const pw = w - padL - padR;
      const ph = h - padT - padB;

      // Grid
      ctx.strokeStyle = 'rgba(255,255,255,0.10)';
      ctx.lineWidth = 1;

      for(let i=0;i<=xTicks;i++){
        const x = px0 + (pw*i/xTicks);
        ctx.beginPath();
        ctx.moveTo(x, py0);
        ctx.lineTo(x, py0+ph);
        ctx.stroke();
      }
      for(let j=0;j<=yTicks;j++){
        const y = py0 + (ph*j/yTicks);
        ctx.beginPath();
        ctx.moveTo(px0, y);
        ctx.lineTo(px0+pw, y);
        ctx.stroke();
      }

      // Axes box
      ctx.strokeStyle = 'rgba(255,255,255,0.18)';
      ctx.strokeRect(px0, py0, pw, ph);

      // Title
      ctx.fillStyle = 'rgba(233,238,252,0.95)';
      ctx.font = '700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(title, px0, 18);

      // Tick labels
      ctx.fillStyle = 'rgba(183,192,218,0.95)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

      function fmt(v){
        // smart formatting
        const av = Math.abs(v);
        if(av>=1000 || (av>0 && av<0.01)) return v.toExponential(2);
        return (Math.round(v*100)/100).toString();
      }

      for(let i=0;i<=xTicks;i++){
        const x = px0 + (pw*i/xTicks);
        const v = xMin + (xMax-xMin)*i/xTicks;
        const s = fmt(v);
        ctx.fillText(s, x- (s.length*3.2), py0+ph+18);
      }
      for(let j=0;j<=yTicks;j++){
        const y = py0 + (ph*j/yTicks);
        const v = yMax - (yMax-yMin)*j/yTicks;
        const s = fmt(v);
        ctx.fillText(s, 8, y+4);
      }

      // Axis labels
      ctx.fillStyle = 'rgba(233,238,252,0.88)';
      ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(xLabel, px0 + pw/2 - xLabel.length*3.0, py0+ph+36);

      // y label rotated
      ctx.save();
      ctx.translate(14, py0 + ph/2);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, -yLabel.length*3.0, 0);
      ctx.restore();

      ctx.restore();

      return {px0,py0,pw,ph, xMin,xMax,yMin,yMax};
    }

    function mapX(x, ax){ return ax.px0 + ax.pw*( (x-ax.xMin)/(ax.xMax-ax.xMin) ); }
    function mapY(y, ax){ return ax.py0 + ax.ph*( 1 - (y-ax.yMin)/(ax.yMax-ax.yMin) ); }

    // ---------- Draw diagram ----------
    function drawDiagram(canvas, data){
      const {ctx, w, h} = setupHiDPICanvas(canvas);

      // Background
      ctx.clearRect(0,0,w,h);
      ctx.fillStyle = 'rgba(10,14,22,0.55)';
      ctx.fillRect(0,0,w,h);

      // Title
      ctx.fillStyle = 'rgba(233,238,252,0.95)';
      ctx.font = '700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText('SOA active region (rectangular prism)', 14, 22);

      const pad = 18;
      const cx = pad, cy = 42;
      const bw = w - 2*pad;
      const bh = h - cy - pad;

      // Draw a pseudo-3D box
      const boxW = bw*0.62;
      const boxH = bh*0.46;
      const depth = Math.min(bw, bh)*0.14;

      const x0 = cx + bw*0.12;
      const y0 = cy + bh*0.28;

      // Faces
      ctx.lineWidth = 2;

      // front face
      ctx.fillStyle = 'rgba(125,211,252,0.10)';
      ctx.strokeStyle = 'rgba(125,211,252,0.35)';
      ctx.beginPath();
      ctx.rect(x0, y0, boxW, boxH);
      ctx.fill();
      ctx.stroke();

      // top face
      ctx.fillStyle = 'rgba(167,243,208,0.08)';
      ctx.strokeStyle = 'rgba(167,243,208,0.30)';
      ctx.beginPath();
      ctx.moveTo(x0, y0);
      ctx.lineTo(x0+depth, y0-depth);
      ctx.lineTo(x0+boxW+depth, y0-depth);
      ctx.lineTo(x0+boxW, y0);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // side face
      ctx.fillStyle = 'rgba(233,238,252,0.05)';
      ctx.strokeStyle = 'rgba(233,238,252,0.22)';
      ctx.beginPath();
      ctx.moveTo(x0+boxW, y0);
      ctx.lineTo(x0+boxW+depth, y0-depth);
      ctx.lineTo(x0+boxW+depth, y0+boxH-depth);
      ctx.lineTo(x0+boxW, y0+boxH);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // Dimension arrows
      ctx.strokeStyle = 'rgba(255,255,255,0.65)';
      ctx.fillStyle = 'rgba(233,238,252,0.92)';
      ctx.lineWidth = 1.5;
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

      // length arrow (along boxW)
      const yL = y0 + boxH + 26;
      ctx.beginPath();
      ctx.moveTo(x0, yL);
      ctx.lineTo(x0+boxW, yL);
      ctx.stroke();
      arrowHead(ctx, x0, yL, x0+10, yL);
      arrowHead(ctx, x0+boxW, yL, x0+boxW-10, yL);
      ctx.fillText(`l = ${(GIVEN.l*1e6).toFixed(0)} μm`, x0 + boxW*0.35, yL - 8);

      // width arrow (vertical boxH)
      const xW = x0 - 18;
      ctx.beginPath();
      ctx.moveTo(xW, y0);
      ctx.lineTo(xW, y0+boxH);
      ctx.stroke();
      arrowHead(ctx, xW, y0, xW, y0+10);
      arrowHead(ctx, xW, y0+boxH, xW, y0+boxH-10);
      ctx.save();
      ctx.translate(xW-10, y0+boxH*0.55);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(`w = ${(GIVEN.w*1e6).toFixed(0)} μm`, 0, 0);
      ctx.restore();

      // thickness arrow (depth)
      const xT0 = x0 + boxW + 12;
      const yT0 = y0 + boxH*0.25;
      ctx.beginPath();
      ctx.moveTo(xT0, yT0);
      ctx.lineTo(xT0+depth, yT0-depth);
      ctx.stroke();
      arrowHead(ctx, xT0, yT0, xT0+8, yT0-2);
      arrowHead(ctx, xT0+depth, yT0-depth, xT0+depth-8, yT0-depth+2);
      ctx.fillText(`t = ${(GIVEN.t*1e6).toFixed(0)} μm`, xT0+depth+8, yT0-depth-2);

      // Current arrow
      ctx.strokeStyle = 'rgba(251,191,36,0.85)';
      ctx.fillStyle = 'rgba(251,191,36,0.95)';
      ctx.lineWidth = 3;
      const ax0 = x0 + boxW*0.25;
      const ay0 = y0 - 42;
      const ax1 = x0 + boxW*0.25;
      const ay1 = y0 - 6;
      ctx.beginPath();
      ctx.moveTo(ax0, ay0);
      ctx.lineTo(ax1, ay1);
      ctx.stroke();
      arrowHead(ctx, ax1, ay1, ax1, ay1-12, 8, 'rgba(251,191,36,0.95)');
      ctx.font = '700 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(`I = ${data.I_mA.toFixed(1)} mA`, ax0 + 12, ay0 + 20);

      // N label
      ctx.fillStyle = 'rgba(183,192,218,0.95)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(`N ≈ ${(data.N/1e6).toExponential(2)} cm^-3`, x0, y0 + boxH + 58);
    }

    function arrowHead(ctx, x0,y0,x1,y1, size=6, color=null){
      const ang = Math.atan2(y1-y0, x1-x0);
      const a1 = ang + Math.PI*0.85;
      const a2 = ang - Math.PI*0.85;
      ctx.save();
      if(color) ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(x0,y0);
      ctx.lineTo(x0 + size*Math.cos(a1), y0 + size*Math.sin(a1));
      ctx.lineTo(x0 + size*Math.cos(a2), y0 + size*Math.sin(a2));
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    // ---------- Main plot: gain spectrum ----------
    function drawMainPlot(canvas, data){
      const {ctx, w, h} = setupHiDPICanvas(canvas);

      // Frequency range around band edge in THz
      const fg = data.f_g;
      const fp = data.f_peak;
      const df = data.df;

      // choose view range: slightly below fg and above fp
      const fMin = (fg - 0.6*df);
      const fMax = (fp + 0.6*df);

      // compute g range for scaling
      const nSamp = 300;
      let gMax = 0;
      for(let i=0;i<nSamp;i++){
        const f = fMin + (fMax-fMin)*i/(nSamp-1);
        const E = CONST.h * f;
        let g = 0;
        // Idealized: only within [fg, fp]
        if(f >= fg && f <= fp) g = data.gainAtE(E);
        gMax = Math.max(gMax, g);
      }
      if(gMax === 0) gMax = 1;

      // Convert gain to cm^-1 for plotting
      const yMax = (gMax/100) * 1.15;
      const yMin = 0;

      const ax = drawAxes(ctx, 0,0,w,h, {
        title: 'Material gain spectrum (idealized)',
        xLabel: 'Frequency f (THz)',
        yLabel: 'Gain g (cm^-1)',
        xMin: fMin/1e12,
        xMax: fMax/1e12,
        yMin: yMin,
        yMax: yMax,
        xTicks: 6,
        yTicks: 5
      });

      // Plot curve
      ctx.save();
      ctx.strokeStyle = 'rgba(125,211,252,0.95)';
      ctx.lineWidth = 2.2;

      let started = false;
      for(let i=0;i<nSamp;i++){
        const f = fMin + (fMax-fMin)*i/(nSamp-1);
        const E = CONST.h * f;
        let g = 0;
        if(f >= fg && f <= fp) g = data.gainAtE(E); // 1/m
        const g_cm = g/100;
        const x = mapX(f/1e12, ax);
        const y = mapY(g_cm, ax);
        if(!started){
          ctx.beginPath();
          ctx.moveTo(x,y);
          started = true;
        }else{
          ctx.lineTo(x,y);
        }
      }
      ctx.stroke();

      // Vertical lines for fg and fp
      function vline(fTHz, label, color){
        const x = mapX(fTHz, ax);
        ctx.strokeStyle = color;
        ctx.lineWidth = 1.6;
        ctx.setLineDash([6,4]);
        ctx.beginPath();
        ctx.moveTo(x, ax.py0);
        ctx.lineTo(x, ax.py0 + ax.ph);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = 'rgba(233,238,252,0.95)';
        ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
        ctx.fillText(label, Math.min(x+6, ax.px0+ax.pw-120), ax.py0+14);
      }

      vline(fg/1e12, 'f_g', 'rgba(167,243,208,0.85)');
      vline(fp/1e12, 'f_peak', 'rgba(251,191,36,0.85)');

      // Legend
      ctx.fillStyle = 'rgba(233,238,252,0.92)';
      ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      const lx = ax.px0 + ax.pw - 190;
      const ly = ax.py0 + 12;
      ctx.fillText('Legend', lx, ly);
      // line sample
      ctx.strokeStyle = 'rgba(125,211,252,0.95)';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(lx, ly+10);
      ctx.lineTo(lx+34, ly+10);
      ctx.stroke();
      ctx.fillStyle = 'rgba(183,192,218,0.95)';
      ctx.fillText('g(f)', lx+44, ly+14);

      ctx.restore();
    }

    // ---------- Secondary plot: bandwidth vs current ----------
    function drawSweep(canvas, data){
      const {ctx, w, h} = setupHiDPICanvas(canvas);

      const Imin = 0.1, Imax = 5.0;
      const n = 100;
      const xs = [];
      const ys = [];
      let yMax = 0;
      for(let i=0;i<n;i++){
        const I = Imin + (Imax-Imin)*i/(n-1);
        const d = computeAll(I);
        const dfTHz = d.df/1e12;
        xs.push(I);
        ys.push(dfTHz);
        yMax = Math.max(yMax, dfTHz);
      }
      yMax *= 1.15;

      const ax = drawAxes(ctx, 0,0,w,h, {
        title: 'Gain bandwidth Δf vs current (same device)',
        xLabel: 'Current I (mA)',
        yLabel: 'Bandwidth Δf (THz)',
        xMin: Imin,
        xMax: Imax,
        yMin: 0,
        yMax: yMax,
        xTicks: 6,
        yTicks: 5
      });

      // Curve
      ctx.save();
      ctx.strokeStyle = 'rgba(167,243,208,0.95)';
      ctx.lineWidth = 2.2;
      ctx.beginPath();
      for(let i=0;i<n;i++){
        const x = mapX(xs[i], ax);
        const y = mapY(ys[i], ax);
        if(i===0) ctx.moveTo(x,y);
        else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // Marker for current
      const xM = mapX(data.I_mA, ax);
      const yM = mapY(data.df/1e12, ax);
      ctx.fillStyle = 'rgba(251,191,36,0.95)';
      ctx.beginPath();
      ctx.arc(xM, yM, 5.5, 0, Math.PI*2);
      ctx.fill();

      // Label
      ctx.fillStyle = 'rgba(233,238,252,0.95)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(`(${data.I_mA.toFixed(1)} mA, ${(data.df/1e12).toFixed(2)} THz)`, Math.min(xM+10, ax.px0+ax.pw-210), Math.max(yM-10, ax.py0+16));

      // Legend
      ctx.fillStyle = 'rgba(233,238,252,0.92)';
      ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      const lx = ax.px0 + ax.pw - 220;
      const ly = ax.py0 + 12;
      ctx.fillText('Legend', lx, ly);
      ctx.strokeStyle = 'rgba(167,243,208,0.95)';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(lx, ly+10);
      ctx.lineTo(lx+34, ly+10);
      ctx.stroke();
      ctx.fillStyle = 'rgba(183,192,218,0.95)';
      ctx.fillText('Δf(I)', lx+44, ly+14);
      ctx.fillStyle = 'rgba(251,191,36,0.95)';
      ctx.beginPath();
      ctx.arc(lx+14, ly+30, 5, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = 'rgba(183,192,218,0.95)';
      ctx.fillText('current', lx+44, ly+34);

      ctx.restore();
    }

    // ---------- Update all UI + plots ----------
    const elCur = document.getElementById('cur');
    const curRead = document.getElementById('curRead');
    const bwRead = document.getElementById('bwRead');
    const gRead = document.getElementById('gRead');
    const readouts = document.getElementById('readouts');

    const diag = document.getElementById('diag');
    const mainPlot = document.getElementById('mainPlot');
    const sweepPlot = document.getElementById('sweepPlot');

    function fmtExp(x, digits=2){
      return x.toExponential(digits).replace('e+','e').replace('e0','e0');
    }

    function update(){
      const I_mA = parseFloat(elCur.value);
      const d = computeAll(I_mA);

      curRead.textContent = `${I_mA.toFixed(1)} mA`;
      bwRead.textContent = `Δf ≈ ${(d.df/1e12).toFixed(2)} THz`;
      gRead.textContent = `g_peak ≈ ${fmtExp(d.g_peak_m,2)} m^-1`;

      // Update readout block
      const V = d.V;
      const Ncm = d.N/1e6;
      const lines = [
        `I = ${I_mA.toFixed(1)} mA`,
        `V = ${V.toExponential(2)} m^3`,
        `N = ${Ncm.toExponential(2)} cm^-3`,
        `k_F = ${d.kF.toExponential(2)} m^-1`,
        `ΔE = ${d.dE_eV.toFixed(5)} eV`,
        `f_g = ${(d.f_g/1e12).toFixed(2)} THz`,
        `Δf = ${(d.df/1e12).toFixed(2)} THz`,
        `f_center = ${(d.f_center/1e12).toFixed(2)} THz`,
        `f_peak = ${(d.f_peak/1e12).toFixed(2)} THz`,
        `g_peak = ${d.g_peak_m.toExponential(2)} m^-1 (idealized)`
      ];
      readouts.textContent = lines.join('\n');

      drawDiagram(diag, d);
      drawMainPlot(mainPlot, d);
      drawSweep(sweepPlot, d);
    }

    // Initial + responsive redraw
    elCur.addEventListener('input', update);
    window.addEventListener('resize', ()=>{ update(); });

    update();
  </script>
</body>
</html>
