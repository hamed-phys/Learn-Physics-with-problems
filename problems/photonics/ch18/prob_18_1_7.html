<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Coupling Light from an LED into a Step-Index Optical Fiber (NA-limited)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0f1730;
      --text:#eaf0ff;
      --muted:#b8c4ef;
      --faint:#7f8ab5;
      --accent:#7dd3fc;
      --accent2:#a7f3d0;
      --warn:#fbbf24;
      --ok:#86efac;
      --bad:#fb7185;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --shadow2: 0 10px 30px rgba(0,0,0,.25);
      --radius: 18px;
      --radius2: 14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(125,211,252,.16), transparent 60%),
        radial-gradient(1000px 600px at 85% 25%, rgba(167,243,208,.12), transparent 55%),
        radial-gradient(900px 600px at 40% 95%, rgba(251,191,36,.10), transparent 60%),
        linear-gradient(180deg, #070a14, var(--bg));
      line-height:1.55;
    }
    a{ color:var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    header{
      padding: 28px 18px 10px;
      max-width: 1180px;
      margin: 0 auto;
    }
    .hero{
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap: 18px;
      align-items:stretch;
    }
    .titleCard{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 14px;
      overflow:hidden;
      position:relative;
    }
    .titleCard::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(500px 200px at 20% 0%, rgba(125,211,252,.22), transparent 60%),
                  radial-gradient(420px 180px at 80% 20%, rgba(167,243,208,.18), transparent 60%);
      filter: blur(0px);
      pointer-events:none;
      opacity:.8;
    }
    .titleCard > *{ position:relative; }
    h1{
      margin:0 0 10px;
      font-size: clamp(1.35rem, 2.2vw, 2.1rem);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: .98rem;
      max-width: 72ch;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 12px;
    }
    .pill{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(16,26,51,.55);
      padding: 6px 10px;
      border-radius: 999px;
      color: var(--muted);
      font-size: .86rem;
      display:flex;
      align-items:center;
      gap:8px;
      box-shadow: var(--shadow2);
    }
    .pill b{ color:var(--text); font-weight:600; }
    .tocWrap{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 14px 14px 10px;
      position: sticky;
      top: 14px;
      height: fit-content;
    }
    .tocTitle{
      margin: 0 0 8px;
      font-size: .95rem;
      letter-spacing:.25px;
      color: var(--muted);
    }
    nav ul{
      list-style:none;
      margin:0;
      padding:0;
      display:grid;
      gap: 7px;
    }
    nav a{
      display:block;
      padding: 7px 10px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,.08);
      background: rgba(15,23,48,.45);
      color: var(--text);
      font-size: .9rem;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    nav a:hover{
      transform: translateY(-1px);
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.25);
      text-decoration:none;
    }

    main{
      max-width: 1180px;
      margin: 0 auto;
      padding: 10px 18px 42px;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap: 18px;
      align-items:start;
    }
    article{
      display:grid;
      gap: 16px;
    }
    section{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025));
      border: 1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow2);
      padding: 16px 16px 14px;
    }
    section h2{
      margin: 0 0 10px;
      font-size: 1.2rem;
      letter-spacing:.2px;
    }
    section h3{
      margin: 14px 0 8px;
      font-size: 1.02rem;
      color: var(--accent2);
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    .callout{
      border-radius: var(--radius2);
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(15,23,48,.55);
      padding: 12px 12px 10px;
    }
    .callout h4{
      margin: 0 0 6px;
      font-size: .95rem;
      color: var(--muted);
      letter-spacing:.2px;
    }
    ul{ margin: 8px 0 0 18px; }
    li{ margin: 6px 0; color: var(--text); }
    .muted{ color: var(--muted); }
    .faint{ color: var(--faint); }
    .eqBox{
      background: rgba(7,10,20,.55);
      border: 1px solid rgba(125,211,252,.18);
      border-radius: var(--radius2);
      padding: 12px;
      position: relative;
      overflow:hidden;
    }
    .eqTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 6px;
    }
    .eqTitle span{
      color: var(--muted);
      font-size: .9rem;
      letter-spacing:.2px;
    }
    .eq{
      font-family: var(--mono);
      font-size: .95rem;
      white-space: pre-wrap;
      line-height: 1.45;
    }
    button.copyBtn{
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(16,26,51,.75);
      color: var(--text);
      border-radius: 12px;
      padding: 7px 10px;
      cursor:pointer;
      font-size: .86rem;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      box-shadow: var(--shadow2);
    }
    button.copyBtn:hover{
      transform: translateY(-1px);
      background: rgba(125,211,252,.12);
      border-color: rgba(125,211,252,.30);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(15,23,48,.55);
      color: var(--muted);
      font-size: .86rem;
      margin-right: 8px;
    }
    .badge b{ color:var(--text); font-weight:650; }
    .resultBox{
      border: 1px solid rgba(134,239,172,.22);
      background: rgba(134,239,172,.08);
    }
    .warnBox{
      border: 1px solid rgba(251,191,36,.26);
      background: rgba(251,191,36,.10);
    }
    .mistBox{
      border: 1px solid rgba(251,113,133,.22);
      background: rgba(251,113,133,.08);
    }

    aside{
      display:grid;
      gap: 14px;
    }
    .vizCard{
      padding: 14px;
    }
    .controls{
      display:grid;
      gap: 10px;
      margin-top: 10px;
    }
    .controlRow{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(15,23,48,.55);
      border-radius: 14px;
      padding: 10px 10px 8px;
    }
    .controlRow label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: .9rem;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    select{
      width:100%;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(16,26,51,.75);
      color: var(--text);
      padding: 8px 10px;
      font-size: .9rem;
      outline:none;
    }

    figure{
      margin:0;
      border-radius: var(--radius);
      overflow:hidden;
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(7,10,20,.40);
      box-shadow: var(--shadow2);
    }
    figcaption{
      padding: 10px 12px 12px;
      color: var(--muted);
      font-size: .88rem;
      border-top: 1px solid rgba(255,255,255,.08);
      background: rgba(16,26,51,.35);
    }
    canvas{
      width: 100%;
      height: 260px;
      display:block;
      background: rgba(7,10,20,.25);
    }
    .smallCanvas canvas{ height: 240px; }
    .footer{
      max-width:1180px;
      margin: 0 auto;
      padding: 0 18px 36px;
      color: var(--faint);
      font-size: .9rem;
    }

    .kpiGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    .kpi{
      border: 1px solid rgba(255,255,255,.10);
      background: rgba(15,23,48,.55);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .kpi .label{ color: var(--muted); font-size: .84rem; }
    .kpi .value{ font-size: 1.1rem; margin-top: 2px; font-weight: 650; letter-spacing:.2px; }
    .kpi .sub{ color: var(--faint); font-size:.82rem; margin-top: 2px; }
    .note{
      font-size: .9rem;
      color: var(--muted);
    }

    @media (max-width: 980px){
      .hero, main{ grid-template-columns: 1fr; }
      .tocWrap{ position: relative; top: 0; }
      canvas{ height: 250px; }
      .kpiGrid{ grid-template-columns:1fr 1fr; }
    }
    @media (max-width: 560px){
      .grid2, .grid3{ grid-template-columns: 1fr; }
      .kpiGrid{ grid-template-columns:1fr; }
    }
    @media print{
      body{ background:white; color:#111; }
      section, .tocWrap, .titleCard, figure{ box-shadow:none; }
      .tocWrap{ position: static; }
      button.copyBtn, .controls{ display:none !important; }
      a{ color:#111; text-decoration:underline; }
      canvas{ background:white; }
    }

    /* subtle entrance */
    .fadeIn{ animation: fadeIn .55s ease both; }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }
  </style>
</head>
<body>
  <header class="fadeIn">
    <div class="hero">
      <div class="titleCard">
        <h1>Coupling Light from an LED into a Step-Index Optical Fiber (NA-limited)</h1>
        <p class="subtitle">
          We compute what fraction of an LED’s emitted optical power is accepted by a step-index fiber when the LED is
          bonded directly to the fiber core. The key is <b>angular acceptance</b> and how it transforms with refractive index.
        </p>
        <div class="meta">
          <div class="pill"><b>Given</b> NA (in air) = 0.1</div>
          <div class="pill"><b>Fiber core index</b> n<sub>core</sub> = 1.46</div>
          <div class="pill"><b>LED index</b> n<sub>LED</sub> = 3.6</div>
          <div class="pill"><b>Emission</b> ∝ cos<sup>4</sup>(θ)</div>
        </div>
      </div>

      <aside class="tocWrap" aria-label="Table of contents">
        <div class="tocTitle">Table of Contents</div>
        <nav>
          <ul>
            <li><a href="#quick">Quick Summary</a></li>
            <li><a href="#part0">PART 0 — Concept Primer</a></li>
            <li><a href="#part1">PART 1 — Problem Analysis</a></li>
            <li><a href="#part2">PART 2 — Strategy & Tips</a></li>
            <li><a href="#part3">PART 3 — Full Solution</a></li>
            <li><a href="#part4">PART 4 — Deeper Understanding</a></li>
            <li><a href="#part5">PART 5 — Visualization Guide</a></li>
          </ul>
        </nav>
      </aside>
    </div>
  </header>

  <main class="fadeIn">
    <article>
      <section id="quick">
        <h2>Quick Summary</h2>
        <ul>
          <li>This problem asks for the <b>fraction of LED optical power</b> that enters a step-index fiber and is guided.</li>
          <li>Key physics idea: the fiber only accepts rays within an <b>acceptance cone</b> defined by its <b>numerical aperture</b> (NA).</li>
          <li>Governing relation for an external medium of index n<sub>ext</sub>: <span class="badge"><b>Acceptance condition</b> n<sub>ext</sub> sin θ<sub>max</sub> = NA</span>.</li>
          <li>LED emission pattern is <b>non-uniform</b>: power per solid angle ∝ cos<sup>4</sup>(θ) (θ from the surface normal).</li>
          <li>Fraction captured (angular only): <span class="badge"><b>η</b> = 1 − cos<sup>5</sup>(θ<sub>max</sub>)</span> (for cos<sup>4</sup> pattern).</li>
          <li>With bonding (no air gap), n<sub>ext</sub> = n<sub>LED</sub>, which <b>shrinks</b> θ<sub>max</sub> dramatically.</li>
          <li>Numeric result here is a <b>single number</b> (with a clear symbolic formula): η ≈ 1.93×10<sup>−3</sup> (≈0.193%) ignoring Fresnel reflection.</li>
          <li>Optional refinement: multiply by Fresnel transmission at LED–fiber interface, giving ≈0.158%.</li>
        </ul>
      </section>

      <section id="part0">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <div class="grid2">
          <div class="callout">
            <h4>Core definitions (symbols & units)</h4>
            <ul>
              <li><b>Numerical aperture (NA)</b> (dimensionless): measures the fiber’s angular acceptance. Intrinsic to the fiber: NA = √(n<sub>core</sub><sup>2</sup> − n<sub>clad</sub><sup>2</sup>).</li>
              <li><b>Acceptance half-angle</b> θ<sub>max</sub> (radians or degrees): maximum external ray angle (from axis/normal) that can be guided.</li>
              <li><b>External refractive index</b> n<sub>ext</sub> (dimensionless): refractive index of the medium from which light enters the fiber (air, gel, LED, etc.).</li>
              <li><b>Radiation pattern</b> I(θ): angular distribution of emitted power per unit solid angle (W/sr up to a constant).</li>
            </ul>
          </div>

          <div class="callout">
            <h4>Physical meaning</h4>
            <ul>
              <li>NA sets a <b>cone of directions</b>: rays too “steep” miss total internal reflection in the core and leak into cladding.</li>
              <li>When the surrounding medium has higher n, the same NA corresponds to a <b>smaller external angle</b> because <b>n sinθ</b> is what matters.</li>
              <li>LEDs are not isotropic emitters; a cos<sup>m</sup> law means emission is strongest near the normal.</li>
            </ul>
          </div>
        </div>

        <h3>Key laws / principles (and validity)</h3>
        <ul>
          <li><b>Geometric optics ray acceptance</b> (step-index, weakly guiding, meridional rays): guided if the external incident angle satisfies
            <b>n<sub>ext</sub> sin θ ≤ NA</b>.
            Valid when the core is much larger than wavelength so rays are meaningful.
          </li>
          <li><b>Power in an angular distribution</b>:
            for an axisymmetric emitter, differential power into a ring of directions is dP ∝ I(θ) dΩ with dΩ = 2π sinθ dθ.
          </li>
          <li><b>Snell’s law</b>: when relating angles across an interface, n sinθ is conserved (for the transmitted ray).</li>
        </ul>

        <h3>Common models/approximations and why we use them</h3>
        <ul>
          <li><b>“Small source area”</b> compared to core: ignores lateral overlap and focuses purely on <b>angular coupling</b>.</li>
          <li><b>Perfect bonding</b>: no air gap; external medium for acceptance is the LED material itself, n<sub>ext</sub> = n<sub>LED</sub>.</li>
          <li><b>Ignore Fresnel reflection</b> unless explicitly included; many textbook coupling problems focus on geometry/NA first.</li>
        </ul>

        <h3>Mini intuition examples</h3>
        <ul>
          <li>If NA increases, θ<sub>max</sub> increases ⇒ a larger slice of the LED’s angular emission is captured ⇒ coupling fraction rises rapidly.</li>
          <li>If n<sub>ext</sub> increases (e.g., from air to a high-index LED), θ<sub>max</sub> decreases because sin θ<sub>max</sub> = NA / n<sub>ext</sub> ⇒ coupling fraction drops.</li>
        </ul>

        <div class="callout warnBox">
          <h4>What to watch for (typical pitfalls)</h4>
          <ul>
            <li><b>Using the air acceptance angle</b> even when the LED is bonded. The external medium is not air anymore.</li>
            <li>Confusing <b>intensity</b> I(θ) with <b>power into angle</b> dP: you must multiply by the solid angle factor sinθ.</li>
            <li>Dropping the correct power-law exponent: for I ∝ cos<sup>4</sup>θ, the final fraction becomes 1 − cos<sup>5</sup>θ<sub>max</sub>, not 1 − cos<sup>4</sup>.</li>
          </ul>
        </div>
      </section>

      <section id="part1">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <h3>Problem restatement (in plain language)</h3>
        <p class="muted">
          An LED with a planar emitting surface (refractive index n<sub>LED</sub> = 3.6) is bonded directly to the core of a step-index optical fiber
          (core index n<sub>core</sub> = 1.46). The fiber has numerical aperture NA = 0.1 specified in air.
          The LED emits into the fiber with angular dependence proportional to cos<sup>4</sup>(θ).
          The emitting area is smaller than the fiber core, so spatial overlap is not limiting.
          Find the fraction of the LED’s emitted optical power that the fiber accepts (i.e., within the fiber acceptance cone).
        </p>

        <div class="grid2">
          <div class="callout">
            <h4>Given</h4>
            <ul>
              <li>NA (in air): NA = 0.1</li>
              <li>Fiber core index: n<sub>core</sub> = 1.46</li>
              <li>LED index (external medium): n<sub>LED</sub> = 3.6</li>
              <li>Emission pattern: I(θ) ∝ cos<sup>4</sup>(θ), θ measured from surface normal (≈ fiber axis)</li>
              <li>Bonded LED-to-core; emission area &lt; core area (no geometrical area loss)</li>
            </ul>
          </div>
          <div class="callout">
            <h4>Unknowns / target</h4>
            <ul>
              <li>Acceptance half-angle in LED: θ<sub>max</sub></li>
              <li>Fraction of emitted power captured: η (dimensionless), possibly with optional Fresnel factor</li>
            </ul>
          </div>
        </div>

        <h3>Which principles apply (and why)</h3>
        <ul>
          <li><b>Fiber NA acceptance</b> applies because whether a ray is guided depends on its entrance angle relative to the fiber axis.</li>
          <li><b>Angular power integration</b> applies because we are asked for a <b>fraction of total emitted power</b> under an angular distribution.</li>
          <li>We do <b>not</b> need mode-overlap or diffraction integrals because the problem explicitly makes the source area smaller than the core and focuses on NA-based acceptance.</li>
        </ul>

        <div class="callout">
          <h4>Assumptions (explicit)</h4>
          <ul>
            <li>Geometric optics (ray) picture is adequate.</li>
            <li>LED emits into the forward hemisphere only (0 ≤ θ ≤ π/2).</li>
            <li>Emission is axisymmetric about the surface normal (aligned with fiber axis).</li>
            <li>Bonding means the external medium for acceptance is n<sub>ext</sub> = n<sub>LED</sub> (no air gap).</li>
            <li>Unless otherwise stated, ignore Fresnel reflection; we will also show the optional correction.</li>
          </ul>
        </div>

        <h3>Possible approaches (compare briefly)</h3>
        <ul>
          <li><b>Approach A (best):</b> Use NA to get θ<sub>max</sub> in the LED, then integrate I(θ) over solid angle to get η. <span class="muted">Fast, exact for given angular law.</span></li>
          <li><b>Approach B:</b> Convert the LED emission to radiance and use étendue conservation. <span class="muted">More general but heavier than needed here.</span></li>
          <li><b>Approach C:</b> Treat the LED as Lambertian-ish and use small-angle approximations. <span class="muted">May be okay for tiny θ but loses clarity and generality.</span></li>
        </ul>
        <p class="muted">
          We choose <b>Approach A</b> because the problem directly gives NA and an explicit angular dependence, making the integral clean and instructive.
        </p>
      </section>

      <section id="part2">
        <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

        <ol>
          <li>
            <b>Convert NA to acceptance angle in the LED medium.</b><br/>
            Tool: acceptance condition n<sub>ext</sub> sinθ<sub>max</sub> = NA.<br/>
            Meaning: defines the cone of ray directions that will be guided.
          </li>
          <li>
            <b>Write the LED angular power element.</b><br/>
            Tool: dP ∝ I(θ) dΩ, with dΩ = 2π sinθ dθ (axisymmetry).<br/>
            Meaning: accounts for both the intensity pattern and available solid angle.
          </li>
          <li>
            <b>Compute total emitted power into the hemisphere.</b><br/>
            Tool: integrate from θ=0 to π/2.<br/>
            Meaning: normalization for the “fraction”.
          </li>
          <li>
            <b>Compute accepted power within θ ≤ θ<sub>max</sub>.</b><br/>
            Tool: integrate from θ=0 to θ<sub>max</sub>.<br/>
            Meaning: the part within the fiber’s NA.
          </li>
          <li>
            <b>Form the ratio η = P<sub>acc</sub>/P<sub>tot</sub>.</b><br/>
            Tool: division cancels unknown proportionality constants.<br/>
            Meaning: final coupling fraction due to angular acceptance.
          </li>
          <li>
            <b>(Optional) Apply Fresnel transmission.</b><br/>
            Tool: normal-incidence reflection R = ((n<sub>LED</sub>−n<sub>core</sub>)/(n<sub>LED</sub>+n<sub>core</sub>))<sup>2</sup>.<br/>
            Meaning: accounts for power lost to reflection at the bonded interface.
          </li>
        </ol>

        <div class="callout mistBox">
          <h4>Common mistakes & quick tips</h4>
          <ul>
            <li><b>Tip:</b> Always use the correct external index: here n<sub>ext</sub> = n<sub>LED</sub>, not 1.</li>
            <li><b>Mistake:</b> Integrating cos<sup>4</sup>θ dθ without the sinθ factor—this undercounts high angles.</li>
            <li><b>Tip:</b> Use substitution u = cosθ to make the integral one line.</li>
          </ul>
        </div>
      </section>

      <section id="part3">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Physical intuition first</h3>
        <p class="muted">
          Because the LED is high-index (n<sub>LED</sub>=3.6), the same fiber NA corresponds to a very small
          acceptance half-angle inside the LED: sinθ<sub>max</sub> = NA/n<sub>LED</sub>.
          Even though the LED emits strongly near θ=0 (cos<sup>4</sup> favors small angles),
          the cone is so narrow that only a small fraction of the hemisphere is captured—on the order of 10<sup>−3</sup>.
        </p>

        <div class="eqBox" id="eq1box">
          <div class="eqTitle">
            <span><b>Key Equation 1:</b> Acceptance angle in an external medium</span>
            <button class="copyBtn" data-copy="eq1">Copy</button>
          </div>
          <div class="eq" id="eq1">n_ext * sin(theta_max) = NA
=> theta_max = asin( NA / n_ext )</div>
        </div>

        <h3>Step 1 — Find the acceptance half-angle inside the LED</h3>
        <p>
          The fiber’s numerical aperture is an intrinsic property of the fiber (set by n<sub>core</sub> and n<sub>clad</sub>).
          The <b>external</b> acceptance half-angle depends on the surrounding refractive index n<sub>ext</sub> through:
          n<sub>ext</sub> sinθ<sub>max</sub> = NA.
          Because the LED is bonded directly to the core, the surrounding medium is the LED:
          n<sub>ext</sub> = n<sub>LED</sub>.
        </p>
        <p class="eq" style="font-family:var(--mono); background:rgba(7,10,20,.35); padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.08);">
          n_LED sinθ_max = NA  ⇒  sinθ_max = NA / n_LED
        </p>
        <p>
          Insert numbers:
          NA = 0.1, n<sub>LED</sub> = 3.6.
        </p>
        <p class="eq" style="font-family:var(--mono); background:rgba(7,10,20,.35); padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.08);">
          sinθ_max = 0.1 / 3.6 = 0.027777...
          ⇒ θ_max ≈ 1.59°  (≈ 0.0278 rad)
        </p>
        <p class="muted">
          Explanation: bonding to a high-index medium shrinks the angular cone in that medium because the product n sinθ is what the NA constrains.
        </p>

        <div class="eqBox" id="eq2box" style="margin-top:12px;">
          <div class="eqTitle">
            <span><b>Key Equation 2:</b> Power fraction for I(θ) ∝ cos^4(θ)</span>
            <button class="copyBtn" data-copy="eq2">Copy</button>
          </div>
          <div class="eq" id="eq2">Given I(θ) ∝ cos^4(θ), and dΩ = 2π sinθ dθ:

η = ( ∫[0→θmax] cos^4(θ) sin(θ) dθ ) / ( ∫[0→π/2] cos^4(θ) sin(θ) dθ )
Let u = cosθ ⇒ du = -sinθ dθ

∫ cos^4(θ) sin(θ) dθ = -∫ u^4 du

η = 1 - cos^5(θmax)</div>
        </div>

        <h3>Step 2 — Write the emitted power element and set up the fraction</h3>
        <p>
          The LED is axisymmetric about the surface normal. If its emitted intensity (per unit solid angle) is
          proportional to cos<sup>4</sup>(θ), then the power going into a differential ring of directions is:
        </p>
        <p class="eq" style="font-family:var(--mono); background:rgba(7,10,20,.35); padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.08);">
          dP ∝ I(θ) dΩ,   I(θ) ∝ cos^4(θ),   dΩ = 2π sinθ dθ
          ⇒ dP ∝ cos^4(θ) sinθ dθ
        </p>
        <p>
          Total emitted power into the forward hemisphere is proportional to:
        </p>
        <p class="eq" style="font-family:var(--mono); background:rgba(7,10,20,.35); padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.08);">
          P_tot ∝ ∫[0→π/2] cos^4(θ) sinθ dθ
        </p>
        <p>
          Accepted power (rays within the fiber acceptance cone) is:
        </p>
        <p class="eq" style="font-family:var(--mono); background:rgba(7,10,20,.35); padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.08);">
          P_acc ∝ ∫[0→θmax] cos^4(θ) sinθ dθ
        </p>
        <p class="muted">
          The proportionality constants cancel in the ratio η = P<sub>acc</sub>/P<sub>tot</sub>.
        </p>

        <h3>Step 3 — Evaluate the integrals (no jumps)</h3>
        <p>
          Compute the generic integral:
        </p>
        <p class="eq" style="font-family:var(--mono); background:rgba(7,10,20,.35); padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.08);">
          ∫ cos^4(θ) sinθ dθ
        </p>
        <p>
          Substitute u = cosθ. Then du = −sinθ dθ, so sinθ dθ = −du:
        </p>
        <p class="eq" style="font-family:var(--mono); background:rgba(7,10,20,.35); padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.08);">
          ∫ cos^4(θ) sinθ dθ = ∫ u^4 (sinθ dθ) = ∫ u^4 (−du) = −∫ u^4 du
          = −(u^5 / 5) + C = −(cos^5 θ)/5 + C
        </p>
        <p>
          Now apply limits.
        </p>

        <div class="grid2">
          <div class="callout">
            <h4>Total power (hemisphere)</h4>
            <p class="eq" style="font-family:var(--mono); margin:0;">
              P_tot ∝ [ −cos^5 θ / 5 ] from 0 to π/2
              = ( −0/5 ) − ( −1/5 ) = 1/5
            </p>
            <p class="muted" style="margin:8px 0 0;">
              Because cos(π/2)=0 and cos(0)=1.
            </p>
          </div>
          <div class="callout">
            <h4>Accepted power (cone)</h4>
            <p class="eq" style="font-family:var(--mono); margin:0;">
              P_acc ∝ [ −cos^5 θ / 5 ] from 0 to θ_max
              = ( −cos^5 θ_max / 5 ) − ( −1/5 )
              = (1 − cos^5 θ_max)/5
            </p>
            <p class="muted" style="margin:8px 0 0;">
              This is the portion within θ ≤ θ<sub>max</sub>.
            </p>
          </div>
        </div>

        <h3>Step 4 — Form the fraction η</h3>
        <p>
          Divide the accepted power by the total:
        </p>
        <p class="eq" style="font-family:var(--mono); background:rgba(7,10,20,.35); padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.08);">
          η = P_acc / P_tot
            = [(1 − cos^5 θ_max)/5] / (1/5)
            = 1 − cos^5 θ_max
        </p>
        <p class="muted">
          Explanation: the cos<sup>4</sup> emission law leads to a simple “one minus a power of cosine” result.
        </p>

        <h3>Step 5 — Plug in θ<sub>max</sub> from NA and n<sub>LED</sub></h3>
        <p>
          We already found sinθ<sub>max</sub> = NA/n<sub>LED</sub>. Therefore:
        </p>
        <p class="eq" style="font-family:var(--mono); background:rgba(7,10,20,.35); padding:10px; border-radius:14px; border:1px solid rgba(255,255,255,.08);">
          cosθ_max = sqrt(1 − sin^2 θ_max)
                 = sqrt(1 − (NA/n_LED)^2)

          ⇒ η = 1 − [ sqrt(1 − (NA/n_LED)^2) ]^5
              = 1 − (1 − (NA/n_LED)^2)^(5/2)
        </p>

        <div class="eqBox resultBox" id="finalBox" style="margin-top:12px;">
          <div class="eqTitle">
            <span><b>Final Answer (Angular acceptance)</b></span>
            <button class="copyBtn" data-copy="final">Copy</button>
          </div>
          <div class="eq" id="final">θ_max = asin(NA / n_LED)

η = 1 − cos^5(θ_max)
  = 1 − (1 − (NA/n_LED)^2)^(5/2)

With NA=0.1, n_LED=3.6:
θ_max ≈ 1.59°
η ≈ 1.93×10^(-3) ≈ 0.193%  (ignoring Fresnel reflection)</div>
        </div>

        <h3>(Optional) Fresnel reflection correction (bonded LED → fiber core)</h3>
        <p class="muted">
          If you want the fraction of LED power that actually transmits through the interface,
          you can multiply by an approximate transmission (1−R). For a quick estimate, use normal-incidence Fresnel reflection:
        </p>
        <div class="eqBox" id="eq3box">
          <div class="eqTitle">
            <span><b>Optional:</b> Fresnel reflection (normal incidence estimate)</span>
            <button class="copyBtn" data-copy="eq3">Copy</button>
          </div>
          <div class="eq" id="eq3">R ≈ ((n_LED − n_core) / (n_LED + n_core))^2
T ≈ 1 − R
η_total ≈ η * T</div>
        </div>
        <p class="muted">
          With n<sub>LED</sub>=3.6 and n<sub>core</sub>=1.46, this gives R≈0.179, T≈0.821, so η·T ≈ 0.00158 (≈0.158%).
          This is a rough estimate because real rays are not all at normal incidence, but it shows the correct scale of reflection loss.
        </p>

        <h3>Sanity checks</h3>
        <div class="grid3">
          <div class="callout">
            <h4>Units / dimensions</h4>
            <ul>
              <li>NA is dimensionless, n is dimensionless ⇒ sinθ<sub>max</sub> dimensionless ⇒ θ<sub>max</sub> is an angle. ✅</li>
              <li>η is a ratio of powers ⇒ dimensionless. ✅</li>
            </ul>
          </div>
          <div class="callout">
            <h4>Limiting cases</h4>
            <ul>
              <li>If NA → 0 ⇒ θ<sub>max</sub> → 0 ⇒ cosθ<sub>max</sub>→1 ⇒ η→0. ✅</li>
              <li>If θ<sub>max</sub> → 90° ⇒ cosθ<sub>max</sub>→0 ⇒ η→1. ✅</li>
              <li>If n<sub>LED</sub> increases at fixed NA ⇒ θ<sub>max</sub> decreases ⇒ η decreases. ✅</li>
            </ul>
          </div>
          <div class="callout">
            <h4>Physical interpretation</h4>
            <ul>
              <li>The fiber “accepts” only a tiny angular cone inside the high-index LED, so most LED power exits at angles that the fiber cannot guide.</li>
              <li>The cos<sup>4</sup> pattern helps somewhat (more weight near θ=0), but the cone is still extremely narrow.</li>
            </ul>
          </div>
        </div>

        <p class="muted" style="margin-top:10px;">
          Connection to the diagram/plots: the diagram shows the acceptance cone half-angle θ<sub>max</sub> inside the LED.
          The plots show how η depends on θ and how η changes when you sweep NA and n<sub>LED</sub>.
        </p>
      </section>

      <section id="part4">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpreting the final formula</h3>
        <p class="muted">
          For a general axisymmetric pattern I(θ) ∝ cos<sup>m</sup>(θ), the same integration gives:
          η = 1 − cos<sup>m+1</sup>(θ<sub>max</sub>).
          Here m=4 ⇒ η = 1 − cos<sup>5</sup>(θ<sub>max</sub>).
        </p>
        <ul>
          <li><b>NA</b> controls θ<sub>max</sub> linearly through sinθ<sub>max</sub> = NA/n<sub>LED</sub>.</li>
          <li><b>n<sub>LED</sub></b> appears in the denominator, shrinking θ<sub>max</sub> as n<sub>LED</sub> grows.</li>
          <li>The exponent <b>5</b> makes η very sensitive: even small changes in θ<sub>max</sub> can noticeably change η.</li>
        </ul>

        <h3>Parameter effects (tie to interactive plots)</h3>
        <ul>
          <li>Increase NA ⇒ the “accepted cone” widens ⇒ η increases. In the secondary plot, the curve rises steeply with NA.</li>
          <li>Increase n<sub>LED</sub> (keeping NA fixed) ⇒ θ<sub>max</sub> decreases ⇒ η decreases. You’ll see the marker shift left in the main plot.</li>
          <li>Change emission exponent m (optional selector) ⇒ higher m concentrates emission near θ=0, increasing η for a given θ<sub>max</sub>.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p class="muted">
          You can also reason using <b>étendue (optical invariant)</b>: the product of area and solid angle (weighted by n<sup>2</sup>)
          is conserved in lossless optics. The fiber supports only a limited angular extent set by NA, so only a fraction of
          the source’s angular phase space can be transferred. For this problem, the direct angular integral is simplest and exact.
        </p>

        <h3>Concept check (quick self-test)</h3>
        <ul>
          <li><b>Q:</b> If the LED were in air (n<sub>ext</sub>=1) instead of bonded, what happens to θ<sub>max</sub>?<br/>
              <b>A:</b> It increases to asin(NA/1) ≈ asin(0.1) ≈ 5.74°, so η becomes much larger.</li>
          <li><b>Q:</b> Why do we multiply by sinθ in the integral?<br/>
              <b>A:</b> Because power is distributed over <b>solid angle</b>; the ring at polar angle θ has area dΩ = 2π sinθ dθ.</li>
          <li><b>Q:</b> Why does a higher-index surrounding medium reduce external acceptance angle?<br/>
              <b>A:</b> Because the guiding condition is on n sinθ, not just θ; increasing n forces sinθ to be smaller.</li>
          <li><b>Q:</b> If the emission were isotropic in the hemisphere (I constant), what would the captured fraction be?<br/>
              <b>A:</b> η = (1 − cosθ<sub>max</sub>) / (1 − cos(90°)) = 1 − cosθ<sub>max</sub>, which is much smaller for small θ than the cos<sup>4</sup> case.</li>
        </ul>
      </section>

      <section id="part5">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>
        <ul>
          <li><b>Diagram canvas:</b> shows an LED slab bonded to a fiber core. The highlighted cone is the fiber’s acceptance cone inside the LED,
              with half-angle θ<sub>max</sub>. When you change NA or n<sub>LED</sub>, the cone angle updates.</li>
          <li><b>Main plot:</b> η(θ) = 1 − cos<sup>m+1</sup>(θ) vs θ (degrees) for the selected exponent m (default m=4).
              A marker shows θ<sub>max</sub>, and the readout shows the resulting η.</li>
          <li><b>Secondary plot (parameter sweep):</b> η vs NA (in air) while holding n<sub>LED</sub> and m fixed.
              A marker shows the currently selected NA.</li>
          <li><b>Interactive controls:</b>
            <ul>
              <li><b>NA (in air) slider:</b> changes the fiber acceptance (intrinsic NA). This updates θ<sub>max</sub>, both plots, and the diagram.</li>
              <li><b>n<sub>LED</sub> slider:</b> changes the external refractive index (bonded medium). Higher n<sub>LED</sub> shrinks θ<sub>max</sub>.</li>
              <li><b>Emission exponent m selector:</b> lets you explore other cos<sup>m</sup> patterns; higher m concentrates emission near normal.</li>
            </ul>
          </li>
        </ul>
        <p class="note">
          The plots and readouts use the same symbols as the solution: NA, n<sub>LED</sub>, θ<sub>max</sub>, and η.
        </p>
      </section>
    </article>

    <aside class="fadeIn">
      <section class="vizCard">
        <h2>Interactive Visualizations</h2>

        <figure>
          <canvas id="diagCanvas" aria-label="Diagram of LED bonded to fiber with acceptance cone"></canvas>
          <figcaption>
            Labeled setup: LED (n<sub>LED</sub>) bonded to fiber core (n<sub>core</sub>). The acceptance cone half-angle is θ<sub>max</sub>.
          </figcaption>
        </figure>

        <div class="controls" aria-label="Interactive controls">
          <div class="controlRow">
            <label for="naSlider">
              <span>Numerical Aperture (in air): <b>NA</b></span>
              <span id="naVal" class="muted">0.100</span>
            </label>
            <input id="naSlider" type="range" min="0.02" max="0.35" step="0.001" value="0.10"/>
            <div class="faint" style="font-size:.82rem; margin-top:6px;">Changes acceptance: sinθ<sub>max</sub> = NA / n<sub>LED</sub></div>
          </div>

          <div class="controlRow">
            <label for="nLedSlider">
              <span>Bonded external index: <b>n</b><sub>LED</sub></span>
              <span id="nLedVal" class="muted">3.60</span>
            </label>
            <input id="nLedSlider" type="range" min="1.00" max="4.00" step="0.01" value="3.60"/>
            <div class="faint" style="font-size:.82rem; margin-top:6px;">Higher n<sub>LED</sub> shrinks θ<sub>max</sub> for fixed NA.</div>
          </div>

          <div class="controlRow">
            <label for="mSelect">
              <span>Emission pattern exponent (I ∝ cos<sup>m</sup>θ): <b>m</b></span>
              <span id="mVal" class="muted">4</span>
            </label>
            <select id="mSelect">
              <option value="0">0 (isotropic in hemisphere)</option>
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="4" selected>4 (given)</option>
              <option value="6">6</option>
              <option value="8">8</option>
            </select>
          </div>
        </div>

        <div class="kpiGrid" aria-label="Key numerical readouts">
          <div class="kpi">
            <div class="label">Acceptance half-angle</div>
            <div class="value" id="thetaDegOut">1.59°</div>
            <div class="sub">θ<sub>max</sub> = asin(NA / n<sub>LED</sub>)</div>
          </div>
          <div class="kpi">
            <div class="label">Captured fraction (angular)</div>
            <div class="value" id="etaOut">0.00193</div>
            <div class="sub">η = 1 − cos<sup>m+1</sup>(θ<sub>max</sub>)</div>
          </div>
          <div class="kpi">
            <div class="label">Fresnel transmission (optional)</div>
            <div class="value" id="Tout">0.821</div>
            <div class="sub">T ≈ 1 − ((n<sub>LED</sub>−n<sub>core</sub>)/(n<sub>LED</sub>+n<sub>core</sub>))²</div>
          </div>
          <div class="kpi">
            <div class="label">Captured × transmission</div>
            <div class="value" id="etaTOut">0.00158</div>
            <div class="sub">η·T (rough interface-corrected)</div>
          </div>
        </div>

        <figure style="margin-top:14px;">
          <canvas id="mainPlot" aria-label="Main plot: eta(theta) with marker at theta_max"></canvas>
          <figcaption>
            Main plot: η(θ) = 1 − cos<sup>m+1</sup>(θ) vs θ. Marker shows the current θ<sub>max</sub>.
          </figcaption>
        </figure>

        <figure class="smallCanvas" style="margin-top:14px;">
          <canvas id="sweepPlot" aria-label="Secondary plot: eta vs NA parameter sweep"></canvas>
          <figcaption>
            Secondary plot: η vs NA (in air) for fixed n<sub>LED</sub> and exponent m. Marker shows selected NA.
          </figcaption>
        </figure>

        <p class="note" style="margin-top:10px;">
          Example values are used only where necessary for plotting; the symbolic solution in the article remains general.
        </p>
      </section>
    </aside>
  </main>

  <footer class="footer fadeIn">
    <p>
      Built as a self-contained learning article (vanilla HTML/CSS/JS). Copy buttons provide plain-text equations and the final result.
    </p>
  </footer>

  <script>
    // ---------- Copy buttons ----------
    function copyText(text){
      navigator.clipboard.writeText(text).then(()=>{
        // tiny user feedback without intrusive alerts
      }).catch(()=>{});
    }
    document.addEventListener("click", (e)=>{
      const btn = e.target.closest(".copyBtn");
      if(!btn) return;
      const key = btn.getAttribute("data-copy");
      const el = document.getElementById(key);
      if(!el) return;
      copyText(el.textContent.trim());
      btn.textContent = "Copied";
      setTimeout(()=>btn.textContent="Copy", 850);
    });

    // ---------- Math helpers ----------
    const DEG = Math.PI/180;
    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
    function fmt(x, digits=3){
      if(!isFinite(x)) return "—";
      return x.toFixed(digits);
    }
    function fmtSci(x){
      if(!isFinite(x)) return "—";
      const ax = Math.abs(x);
      if(ax === 0) return "0";
      if(ax >= 0.001 && ax < 1000) return x.toFixed(5).replace(/0+$/,'').replace(/\.$/,'');
      const p = Math.floor(Math.log10(ax));
      const m = x / Math.pow(10,p);
      return m.toFixed(3) + "×10^(" + p + ")";
    }

    // ---------- Plotting utilities (canvas) ----------
    function setupCanvas(canvas){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(10, Math.floor(rect.width * dpr));
      const h = Math.max(10, Math.floor(rect.height * dpr));
      if(canvas.width !== w || canvas.height !== h){
        canvas.width = w;
        canvas.height = h;
      }
      const ctx = canvas.getContext("2d");
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr);
      return {ctx, w: rect.width, h: rect.height, dpr};
    }

    function drawAxes(ctx, x0, y0, w, h, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
      // Background
      ctx.save();
      ctx.fillStyle = "rgba(7,10,20,0.18)";
      ctx.fillRect(x0, y0, w, h);

      // Title
      ctx.fillStyle = "rgba(234,240,255,0.95)";
      ctx.font = "600 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(title, x0 + 10, y0 + 18);

      // Plot area margins
      const left = x0 + 52, right = x0 + w - 16;
      const top = y0 + 28, bottom = y0 + h - 44;

      // Grid & ticks
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 1;

      const nx = 6, ny = 5;
      for(let i=0;i<=nx;i++){
        const x = left + (right-left)*i/nx;
        ctx.beginPath(); ctx.moveTo(x, top); ctx.lineTo(x, bottom); ctx.stroke();
      }
      for(let j=0;j<=ny;j++){
        const y = top + (bottom-top)*j/ny;
        ctx.beginPath(); ctx.moveTo(left, y); ctx.lineTo(right, y); ctx.stroke();
      }

      // Axes outline
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.beginPath();
      ctx.rect(left, top, right-left, bottom-top);
      ctx.stroke();

      // Tick labels
      ctx.fillStyle = "rgba(184,196,239,0.95)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";

      for(let i=0;i<=nx;i++){
        const xv = xMin + (xMax-xMin)*i/nx;
        const x = left + (right-left)*i/nx;
        const t = (Math.abs(xv) < 1e-12) ? "0" : (Math.abs(xv) >= 100 ? xv.toFixed(0) : xv.toFixed(2));
        ctx.fillText(t, x-10, bottom+18);
      }
      for(let j=0;j<=ny;j++){
        const yv = yMax - (yMax-yMin)*j/ny;
        const y = top + (bottom-top)*j/ny;
        const t = (Math.abs(yv) < 1e-12) ? "0" : (Math.abs(yv) >= 10 ? yv.toFixed(1) : yv.toFixed(3));
        ctx.fillText(t, x0+10, y+4);
      }

      // Axis labels
      ctx.fillStyle = "rgba(184,196,239,0.95)";
      ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(xLabel, (left+right)/2 - 40, y0 + h - 16);

      ctx.save();
      ctx.translate(x0 + 14, (top+bottom)/2 + 40);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();

      ctx.restore();
      return {left, right, top, bottom};
    }

    function toXY(x, y, box, xMin, xMax, yMin, yMax){
      const px = box.left + (x - xMin) / (xMax - xMin) * (box.right - box.left);
      const py = box.bottom - (y - yMin) / (yMax - yMin) * (box.bottom - box.top);
      return {px, py};
    }

    function plotLine(ctx, data, box, xMin, xMax, yMin, yMax){
      ctx.save();
      ctx.strokeStyle = "rgba(125,211,252,0.95)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      data.forEach((p, i)=>{
        const {px, py} = toXY(p.x, p.y, box, xMin, xMax, yMin, yMax);
        if(i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
      });
      ctx.stroke();
      ctx.restore();
    }

    function plotMarker(ctx, x, y, box, xMin, xMax, yMin, yMax, label){
      const {px, py} = toXY(x, y, box, xMin, xMax, yMin, yMax);
      ctx.save();
      ctx.fillStyle = "rgba(167,243,208,0.95)";
      ctx.strokeStyle = "rgba(7,10,20,0.9)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(px, py, 5.5, 0, Math.PI*2);
      ctx.fill();
      ctx.stroke();

      // label
      ctx.fillStyle = "rgba(234,240,255,0.95)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
      ctx.fillText(label, px + 10, py - 10);
      ctx.restore();
    }

    function legend(ctx, x, y, items){
      ctx.save();
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      let yy = y;
      items.forEach(it=>{
        ctx.fillStyle = it.color;
        ctx.fillRect(x, yy-10, 14, 4);
        ctx.fillStyle = "rgba(234,240,255,0.95)";
        ctx.fillText(it.text, x+20, yy-6);
        yy += 16;
      });
      ctx.restore();
    }

    // ---------- Physics model ----------
    const nCoreFixed = 1.46;

    function thetaMaxRad(NA, nExt){
      const s = clamp(NA / nExt, 0, 0.999999);
      return Math.asin(s);
    }
    function etaAngular(thetaRad, m){
      // η = 1 - cos^(m+1)(θmax)
      return 1 - Math.pow(Math.cos(thetaRad), m+1);
    }
    function fresnelT(n1, n2){
      const R = Math.pow((n1 - n2)/(n1 + n2), 2);
      return 1 - R;
    }

    // ---------- Diagram drawing ----------
    function drawDiagram(canvas, params){
      const {ctx, w, h} = setupCanvas(canvas);
      ctx.clearRect(0,0,w,h);

      const pad = 14;
      const x0 = pad, y0 = pad, W = w - 2*pad, H = h - 2*pad;

      // regions
      const ledW = W*0.40;
      const gap = W*0.02;
      const fiberW = W - ledW - gap;

      // LED block
      ctx.fillStyle = "rgba(125,211,252,0.10)";
      ctx.strokeStyle = "rgba(125,211,252,0.28)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.roundRect(x0, y0, ledW, H, 16);
      ctx.fill();
      ctx.stroke();

      // Fiber core block
      const fx = x0 + ledW + gap;
      ctx.fillStyle = "rgba(167,243,208,0.10)";
      ctx.strokeStyle = "rgba(167,243,208,0.28)";
      ctx.beginPath();
      ctx.roundRect(fx, y0, fiberW, H, 16);
      ctx.fill();
      ctx.stroke();

      // Interface line
      ctx.strokeStyle = "rgba(234,240,255,0.30)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(fx, y0+10);
      ctx.lineTo(fx, y0+H-10);
      ctx.stroke();

      // Labels
      ctx.fillStyle = "rgba(234,240,255,0.92)";
      ctx.font = "700 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("LED", x0+14, y0+24);
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillStyle = "rgba(184,196,239,0.95)";
      ctx.fillText("n_LED = " + params.nLED.toFixed(2), x0+14, y0+44);

      ctx.fillStyle = "rgba(234,240,255,0.92)";
      ctx.font = "700 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Fiber core", fx+14, y0+24);
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillStyle = "rgba(184,196,239,0.95)";
      ctx.fillText("n_core = " + nCoreFixed.toFixed(2), fx+14, y0+44);

      // Emission point and axis
      const cx = fx; // at interface
      const cy = y0 + H/2;

      // axis line (normal)
      ctx.strokeStyle = "rgba(234,240,255,0.30)";
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(cx-70, cy);
      ctx.lineTo(cx+140, cy);
      ctx.stroke();

      // acceptance cone inside LED (to the left), symmetric about normal
      const th = params.thetaMax;
      const len = 110;
      const xTip = cx - len;

      const yTop = cy - Math.tan(th)*len;
      const yBot = cy + Math.tan(th)*len;

      ctx.fillStyle = "rgba(251,191,36,0.10)";
      ctx.strokeStyle = "rgba(251,191,36,0.60)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(cx, cy);
      ctx.lineTo(xTip, yTop);
      ctx.lineTo(xTip, yBot);
      ctx.closePath();
      ctx.fill();
      ctx.stroke();

      // show rays in fiber region (accepted)
      ctx.strokeStyle = "rgba(251,191,36,0.70)";
      ctx.lineWidth = 2;
      const rayLen = 140;
      for(let k=-2;k<=2;k++){
        const frac = k/2;
        const ang = frac*th;
        const rx1 = cx + 5;
        const ry1 = cy;
        const rx2 = rx1 + rayLen*Math.cos(ang);
        const ry2 = ry1 + rayLen*Math.sin(ang);
        ctx.beginPath();
        ctx.moveTo(rx1, ry1);
        ctx.lineTo(rx2, ry2);
        ctx.stroke();
      }

      // angle arc & label
      ctx.strokeStyle = "rgba(251,191,36,0.85)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(cx-6, cy, 34, Math.PI, Math.PI + th, false);
      ctx.stroke();

      ctx.fillStyle = "rgba(234,240,255,0.95)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, monospace";
      ctx.fillText("θ_max = " + (params.thetaMax/DEG).toFixed(2) + "°", cx-68, cy-18);

      // note NA relation
      ctx.fillStyle = "rgba(184,196,239,0.95)";
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Acceptance: n_LED·sinθ_max = NA", x0+14, y0+H-16);
    }

    // ---------- Main plot: eta vs theta ----------
    function drawMainPlot(canvas, params){
      const {ctx, w, h} = setupCanvas(canvas);
      ctx.clearRect(0,0,w,h);

      // Domain in degrees
      const xMin = 0;
      const xMax = 25; // show small angles clearly
      const yMin = 0;
      const yMax = 1;

      const box = drawAxes(
        ctx, 10, 10, w-20, h-20,
        xMin, xMax, yMin, yMax,
        "θ (degrees)", "η (fraction)", "Captured fraction vs angle"
      );

      // data
      const data = [];
      for(let i=0;i<=400;i++){
        const thDeg = xMin + (xMax-xMin)*i/400;
        const th = thDeg*DEG;
        const y = etaAngular(th, params.m);
        data.push({x: thDeg, y});
      }
      plotLine(ctx, data, box, xMin, xMax, yMin, yMax);

      // marker at thetaMax
      const tDeg = params.thetaMax/DEG;
      const yMark = etaAngular(params.thetaMax, params.m);
      plotMarker(ctx, tDeg, yMark, box, xMin, xMax, yMin, yMax, "θ_max");

      // legend
      legend(ctx, box.left + 10, box.top + 28, [
        {color:"rgba(125,211,252,0.95)", text:"η(θ) = 1 − cos^(m+1)(θ)"},
        {color:"rgba(167,243,208,0.95)", text:"current θ_max marker"}
      ]);
    }

    // ---------- Secondary plot: eta vs NA sweep ----------
    function drawSweepPlot(canvas, params){
      const {ctx, w, h} = setupCanvas(canvas);
      ctx.clearRect(0,0,w,h);

      const xMin = 0.02;
      const xMax = 0.35;
      const yMin = 0;
      const yMax = 0.25; // typical scale for these parameters; auto-ish

      const box = drawAxes(
        ctx, 10, 10, w-20, h-20,
        xMin, xMax, yMin, yMax,
        "NA (in air)", "η (fraction)", "Parameter sweep: η vs NA"
      );

      // data for sweep
      const data = [];
      for(let i=0;i<=400;i++){
        const NA = xMin + (xMax-xMin)*i/400;
        const th = thetaMaxRad(NA, params.nLED);
        const y = etaAngular(th, params.m);
        data.push({x: NA, y});
      }
      plotLine(ctx, data, box, xMin, xMax, yMin, yMax);

      // marker at current NA
      const thNow = params.thetaMax;
      const yNow = etaAngular(thNow, params.m);
      plotMarker(ctx, params.NA, yNow, box, xMin, xMax, yMin, yMax, "current");

      // legend
      legend(ctx, box.left + 10, box.top + 28, [
        {color:"rgba(125,211,252,0.95)", text:"n_LED fixed, vary NA"},
        {color:"rgba(167,243,208,0.95)", text:"selected NA marker"}
      ]);
    }

    // ---------- Update loop ----------
    const naSlider = document.getElementById("naSlider");
    const nLedSlider = document.getElementById("nLedSlider");
    const mSelect = document.getElementById("mSelect");

    const naVal = document.getElementById("naVal");
    const nLedVal = document.getElementById("nLedVal");
    const mVal = document.getElementById("mVal");

    const thetaDegOut = document.getElementById("thetaDegOut");
    const etaOut = document.getElementById("etaOut");
    const Tout = document.getElementById("Tout");
    const etaTOut = document.getElementById("etaTOut");

    const diagCanvas = document.getElementById("diagCanvas");
    const mainPlot = document.getElementById("mainPlot");
    const sweepPlot = document.getElementById("sweepPlot");

    function getParams(){
      const NA = parseFloat(naSlider.value);
      const nLED = parseFloat(nLedSlider.value);
      const m = parseInt(mSelect.value, 10);
      const thetaMax = thetaMaxRad(NA, nLED);
      const eta = etaAngular(thetaMax, m);
      const T = fresnelT(nLED, nCoreFixed);
      return {NA, nLED, m, thetaMax, eta, T};
    }

    function updateUI(){
      const p = getParams();

      naVal.textContent = p.NA.toFixed(3);
      nLedVal.textContent = p.nLED.toFixed(2);
      mVal.textContent = String(p.m);

      const thDeg = p.thetaMax/DEG;
      thetaDegOut.textContent = thDeg.toFixed(2) + "°";

      etaOut.textContent = fmtSci(p.eta);
      Tout.textContent = fmt(p.T, 3);
      etaTOut.textContent = fmtSci(p.eta * p.T);

      // draw all canvases
      drawDiagram(diagCanvas, {nLED:p.nLED, thetaMax:p.thetaMax});
      drawMainPlot(mainPlot, {thetaMax:p.thetaMax, m:p.m});
      drawSweepPlot(sweepPlot, {thetaMax:p.thetaMax, NA:p.NA, nLED:p.nLED, m:p.m});
    }

    // resize handling
    let resizeTimer = null;
    window.addEventListener("resize", ()=>{
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(updateUI, 120);
    });

    naSlider.addEventListener("input", updateUI);
    nLedSlider.addEventListener("input", updateUI);
    mSelect.addEventListener("change", updateUI);

    // polyfill for roundRect if needed
    if(!CanvasRenderingContext2D.prototype.roundRect){
      CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
        const rr = Math.min(r, w/2, h/2);
        this.beginPath();
        this.moveTo(x+rr, y);
        this.arcTo(x+w, y, x+w, y+h, rr);
        this.arcTo(x+w, y+h, x, y+h, rr);
        this.arcTo(x, y+h, x, y, rr);
        this.arcTo(x, y, x+w, y, rr);
        this.closePath();
        return this;
      }
    }

    // initial render
    updateUI();
  </script>
</body>
</html>
