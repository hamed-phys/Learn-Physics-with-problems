<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Bandgap Reduction from Band-Tail States (InGaAsP & GaAs) — Worked Problem + Interactive Plots</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1624;
      --panel2:#0c1220;
      --text:#e9eefc;
      --muted:#aab6d6;
      --faint:#6f7aa3;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.16);
      --accent:#7bd3ff;
      --accent2:#a7ffb0;
      --warn:#ffd27b;
      --danger:#ff7b9a;
      --shadow: 0 18px 55px rgba(0,0,0,.45);
      --shadow2: 0 10px 25px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1100px 700px at 20% 10%, rgba(123,211,255,.10), transparent 60%),
        radial-gradient(900px 600px at 85% 15%, rgba(167,255,176,.08), transparent 60%),
        radial-gradient(900px 650px at 55% 95%, rgba(255,123,154,.06), transparent 60%),
        linear-gradient(180deg, var(--bg), #070a11 60%, #05070d);
      line-height:1.55;
    }

    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}

    header{
      padding:36px 18px 18px;
      max-width:1200px;
      margin:0 auto;
    }
    .title{
      display:grid;
      gap:10px;
      align-items:start;
    }
    h1{
      margin:0;
      font-weight:800;
      letter-spacing:.2px;
      font-size: clamp(1.55rem, 2.5vw, 2.25rem);
    }
    .subtitle{
      color:var(--muted);
      max-width:80ch;
      font-size:1.02rem;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding:0 18px 48px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
    }

    /* Sticky TOC */
    nav{
      position:sticky;
      top:14px;
      align-self:start;
      background: linear-gradient(180deg, rgba(15,22,36,.88), rgba(12,18,32,.86));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow2);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    .toc-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .toc-head strong{
      font-size:.95rem;
      letter-spacing:.3px;
    }
    .pill{
      font-size:.75rem;
      color:var(--muted);
      border:1px solid var(--line);
      padding:3px 8px;
      border-radius:999px;
      background: rgba(255,255,255,.03);
      white-space:nowrap;
    }
    .toc{
      list-style:none;
      margin:0;
      padding:10px 10px 12px;
      display:grid;
      gap:6px;
    }
    .toc a{
      display:block;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid transparent;
      color:var(--text);
      font-size:.93rem;
      background: rgba(255,255,255,.02);
      transition: transform .15s ease, border-color .15s ease, background .15s ease;
    }
    .toc a:hover{
      transform: translateY(-1px);
      border-color: var(--line2);
      background: rgba(123,211,255,.06);
      text-decoration:none;
    }

    /* Content */
    article{
      background: linear-gradient(180deg, rgba(15,22,36,.65), rgba(12,18,32,.55));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    section{
      padding:22px 20px;
      border-top:1px solid var(--line);
    }
    section:first-child{border-top:none}
    h2{
      margin:0 0 10px;
      font-size: clamp(1.15rem, 1.7vw, 1.45rem);
      letter-spacing:.2px;
    }
    h3{
      margin:16px 0 8px;
      font-size:1.06rem;
      color: #dfe7ff;
    }
    p{margin:10px 0}
    ul{margin:10px 0 0 18px}
    li{margin:6px 0}
    .muted{color:var(--muted)}
    .faint{color:var(--faint)}

    .grid2{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:14px;
      align-items:start;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
      nav{position:relative; top:auto}
      .grid2{grid-template-columns:1fr}
      .grid3{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px 14px 12px;
    }
    .callout{
      border-left: 4px solid var(--accent);
      background: rgba(123,211,255,.06);
    }
    .warn{
      border-left:4px solid var(--warn);
      background: rgba(255,210,123,.06);
    }
    .danger{
      border-left:4px solid var(--danger);
      background: rgba(255,123,154,.07);
    }
    .ok{
      border-left:4px solid var(--accent2);
      background: rgba(167,255,176,.06);
    }

    .eqbox{
      background: rgba(0,0,0,.25);
      border:1px solid var(--line2);
      border-radius:14px;
      padding:12px 12px 10px;
      overflow:auto;
      position:relative;
    }
    .eq{
      font-family: var(--mono);
      font-size:.95rem;
      line-height:1.45;
      white-space:pre;
      margin:0;
    }
    .copybtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      color:var(--text);
      padding:6px 10px;
      border-radius: 999px;
      font-size:.78rem;
      cursor:pointer;
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .copybtn:hover{
      transform: translateY(-1px);
      border-color: var(--line2);
      background: rgba(255,255,255,.06);
    }
    .copybtn:active{transform: translateY(0px) scale(.98)}
    .copyhint{
      font-size:.82rem;
      color:var(--muted);
      margin-top:8px;
    }

    .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed rgba(255,255,255,.12);
    }
    .kv .big{
      font-family: var(--mono);
      font-size: .98rem;
      color:#f1f6ff;
    }

    /* Visualization */
    figure{
      margin:0;
      padding:0;
    }
    .vizwrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .controls{
      display:grid;
      grid-template-columns: 1.3fr 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 980px){
      .controls{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-size:.86rem;
      color:var(--muted);
      margin-bottom:6px;
    }
    select, input[type="range"], button.vbtn{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      padding:10px 10px;
      outline:none;
    }
    input[type="range"]{padding:10px 0}
    button.vbtn{
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    button.vbtn:hover{
      transform: translateY(-1px);
      border-color: var(--line2);
      background: rgba(123,211,255,.08);
    }
    .readout{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:10px;
      margin-top:8px;
    }
    @media (max-width: 980px){
      .readout{grid-template-columns:1fr}
    }
    .chip{
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 10px 8px;
      background: rgba(0,0,0,.18);
    }
    .chip .k{color:var(--muted); font-size:.8rem}
    .chip .v{font-family:var(--mono); font-size:.96rem; margin-top:4px}
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius:16px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.12));
    }
    .canvasTall{height:360px}
    .foot{
      padding:16px 20px 22px;
      color:var(--muted);
      border-top:1px solid var(--line);
      font-size:.9rem;
    }

    /* Print-friendly */
    @media print{
      body{background:white; color:black}
      nav{display:none}
      article, .card, .eqbox{box-shadow:none; background:white}
      canvas{border:1px solid #bbb}
      .copybtn{display:none}
      a{color:black; text-decoration:underline}
    }

    /* Subtle animation */
    @keyframes floatIn{
      from{opacity:0; transform: translateY(8px)}
      to{opacity:1; transform: translateY(0)}
    }
    header, nav, article{animation: floatIn .35s ease both}
    nav{animation-delay:.06s}
    article{animation-delay:.12s}
  </style>
</head>

<body>
<header>
  <div class="title">
    <h1>Bandgap Reduction from Band-Tail States (InGaAsP &amp; GaAs)</h1>
    <div class="subtitle">
      We use an empirical bandgap-shrinkage law to find the doping/injection level that produces a target reduction
      (here, <span class="muted">~0.02 eV</span>), then compare the predicted shifted band edge to the photon energy where optical gain turns on.
    </div>
  </div>
</header>

<main>
  <nav aria-label="Table of contents">
    <div class="toc-head">
      <strong>Table of Contents</strong>
      <span class="pill">sticky</span>
    </div>
    <ul class="toc">
      <li><a href="#quick">Quick Summary</a></li>
      <li><a href="#p0">PART 0 — Concept Primer</a></li>
      <li><a href="#p1">PART 1 — Problem Analysis</a></li>
      <li><a href="#p2">PART 2 — Strategy &amp; Tips</a></li>
      <li><a href="#p3">PART 3 — Full Solution</a></li>
      <li><a href="#p4">PART 4 — Deeper Understanding</a></li>
      <li><a href="#p5">PART 5 — Visualization Guide</a></li>
      <li><a href="#viz">Interactive Visualizations</a></li>
    </ul>
  </nav>

  <article>
    <!-- Quick Summary -->
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>What this problem is about:</b> estimating how <b>band-tail states</b> (disorder/impurities/high carrier densities) reduce the semiconductor bandgap in <b>InGaAsP</b> and <b>GaAs</b>.</li>
        <li><b>Key physics idea:</b> high carrier concentrations modify the band edge (many-body + tail states), producing a <b>negative bandgap shift</b> &Delta;E<sub>g</sub> (&lt; 0).</li>
        <li><b>Governing empirical law:</b> &Delta;E<sub>g</sub>(eV) &asymp; &minus;1.6&times;10<sup>&minus;8</sup> &nbsp;[ p<sup>1/3</sup> + n<sup>1/3</sup> ], with <span class="muted">n, p in cm<sup>&minus;3</sup></span>.</li>
        <li><b>Part (a) result type:</b> numeric hole concentration <b>p</b> for <b>p-type</b> material giving |&Delta;E<sub>g</sub>| &approx; 0.02 eV.</li>
        <li><b>Part (b) result type:</b> numeric injected carrier density <b>&Delta;n</b> in <b>undoped</b> material (n = p = &Delta;n) giving |&Delta;E<sub>g</sub>| &approx; 0.02 eV.</li>
        <li><b>Key numeric outcomes:</b> p &approx; <b>2.0&times;10<sup>18</sup> cm<sup>&minus;3</sup></b>, &Delta;n &approx; <b>2.4&times;10<sup>17</sup> cm<sup>&minus;3</sup></b>.</li>
        <li><b>Comparison idea (c):</b> shifted edge E<sub>g</sub> + &Delta;E<sub>g</sub> should align with the <b>low-frequency gain turn-on</b> energy (for GaAs, around <b>~1.40 eV</b> in the provided plot).</li>
      </ul>
    </section>

    <!-- PART 0 -->
    <section id="p0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div>
          <h3>Core definitions (symbols + units)</h3>
          <ul>
            <li><b>E<sub>g</sub></b> (eV): bandgap energy (conduction band edge minus valence band edge).</li>
            <li><b>&Delta;E<sub>g</sub></b> (eV): bandgap change due to band-tail states / high carrier density. Here &Delta;E<sub>g</sub> is <b>negative</b> (gap reduction).</li>
            <li><b>n</b> (cm<sup>&minus;3</sup>): electron concentration (in conduction band / quasi-Fermi population).</li>
            <li><b>p</b> (cm<sup>&minus;3</sup>): hole concentration (in valence band / quasi-Fermi population).</li>
            <li><b>&Delta;n</b> (cm<sup>&minus;3</sup>): injected carrier density in undoped material; typically n = p = &Delta;n under steady injection.</li>
            <li><b>h&nu;</b> (eV): photon energy; optical transitions occur when h&nu; roughly exceeds the effective gap.</li>
          </ul>

          <h3>Physical meaning: “band-tail states” and why they shrink the gap</h3>
          <p>
            Real semiconductors are not perfectly periodic: alloy disorder (InGaAsP), impurities (doping), and high carrier densities
            smear out the band edges. The density of states acquires <b>tails</b> into the gap and many-body interactions shift band edges.
            The practical outcome is that the <b>effective optical band edge</b> moves to a <b>lower energy</b>, i.e. E<sub>g</sub> &rarr; E<sub>g</sub> + &Delta;E<sub>g</sub>
            with &Delta;E<sub>g</sub> &lt; 0.
          </p>

          <div class="card callout">
            <b>When the empirical law is valid</b>
            <ul>
              <li>Moderately to heavily doped or strongly injected regimes where band tails / many-body effects matter.</li>
              <li>The given formula is <b>empirical</b>: it fits measurements for InGaAsP and GaAs under typical device conditions.</li>
              <li>Use it for <b>order-of-magnitude</b> estimates (device design intuition), not for precision bandstructure modeling.</li>
            </ul>
          </div>
        </div>

        <div>
          <h3>Key model used here</h3>
          <div class="eqbox">
            <button class="copybtn" data-copy="eq1">Copy</button>
<pre class="eq" id="eq1">ΔEg(eV) ≈ −1.6×10^−8 · ( p^(1/3) + n^(1/3) )
n, p in cm^−3</pre>
            <div class="copyhint">Copy gives plain text (useful for notes/code).</div>
          </div>

          <h3>Mini intuition examples (no heavy algebra)</h3>
          <ul>
            <li>If only one carrier type dominates (say p-type), then ΔE<sub>g</sub> scales like −p<sup>1/3</sup>: <b>doubling p</b> does <b>not</b> double the shrinkage; it increases it by 2<sup>1/3</sup>.</li>
            <li>If you inject equally (n = p), you effectively get a factor of 2 inside the parentheses, making the same |ΔE<sub>g</sub>| happen at <b>lower</b> per-carrier concentration than the one-carrier case.</li>
          </ul>

          <div class="card warn">
            <b>What to watch for (pitfalls)</b>
            <ul>
              <li><b>Units:</b> n and p must be in cm<sup>−3</sup> for the constant 1.6×10<sup>−8</sup> to work.</li>
              <li><b>Sign:</b> ΔE<sub>g</sub> is negative (gap reduction). The problem often reports the magnitude (e.g., “reduces by 0.02 eV”).</li>
              <li><b>Undoped injection:</b> if n = p = Δn, don’t forget the factor of 2 in (p<sup>1/3</sup> + n<sup>1/3</sup>).</li>
              <li><b>Material Eg:</b> E<sub>g</sub> depends on temperature and composition (especially InGaAsP). Use provided/assumed reference values carefully.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PART 1 -->
    <section id="p1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Rewrite the problem in plain words</h3>
      <p>
        An empirical relation gives how the semiconductor bandgap shifts due to band-tail states as a function of electron and hole
        concentrations. We want to find:
        (a) the <b>p-type hole concentration</b> that reduces the bandgap by about 0.02 eV,
        (b) the <b>injected carrier density</b> in undoped material that reduces the bandgap by about 0.02 eV (assuming intrinsic carriers are negligible),
        and (c) the shifted band edge <b>E<sub>g</sub> + ΔE<sub>g</sub></b> and compare it with the photon energy where the provided <b>GaAs gain curve</b> crosses zero on the low-frequency side.
      </p>

      <div class="grid2">
        <div class="card">
          <b>Given</b>
          <ul>
            <li>Empirical law: ΔE<sub>g</sub>(eV) ≈ −1.6×10<sup>−8</sup>[p<sup>1/3</sup> + n<sup>1/3</sup>]</li>
            <li>Target gap reduction magnitude: |ΔE<sub>g</sub>| ≈ 0.02 eV</li>
            <li>For part (b): undoped, injected; assume n<sub>i</sub> negligible ⇒ n ≈ p ≈ Δn</li>
            <li>For part (c): compare to gain plot (GaAs SOA): low-frequency gain ~0 near hν ≈ 1.40 eV (read from figure)</li>
          </ul>
        </div>

        <div class="card">
          <b>Unknowns</b>
          <ul>
            <li>(a) p (cm<sup>−3</sup>) for p-type material (take n negligible)</li>
            <li>(b) Δn (cm<sup>−3</sup>) for undoped injection (n = p = Δn)</li>
            <li>(c) E<sub>g</sub> + ΔE<sub>g</sub> (eV) and a qualitative comparison to the plotted zero-gain energy</li>
          </ul>
        </div>
      </div>

      <h3>What physics principles apply (and why)</h3>
      <ul>
        <li><b>Empirical bandgap shrinkage model:</b> the problem explicitly instructs us to use the given law; we treat it as the governing relationship.</li>
        <li><b>Charge neutrality under injection (undoped):</b> in steady injection with negligible intrinsic carriers, electrons and holes are created in pairs ⇒ n ≈ p.</li>
        <li><b>Optical gain turn-on near the band edge:</b> gain becomes positive only when photon energy exceeds the effective optical transition edge; the low-frequency zero crossing is a practical proxy for E<sub>g</sub> + ΔE<sub>g</sub> (plus details of quasi-Fermi separation).</li>
      </ul>

      <div class="card callout">
        <b>Assumptions we will use (explicit)</b>
        <ul>
          <li><b>(a)</b> p-type: p ≫ n, so n<sup>1/3</sup> term is negligible.</li>
          <li><b>(b)</b> undoped injection: n = p = Δn, and n<sub>i</sub> is negligible compared with Δn.</li>
          <li><b>(c)</b> Use a standard GaAs room-temperature reference bandgap <span class="muted">(example value)</span> E<sub>g</sub> ≈ 1.424 eV to compute E<sub>g</sub> + ΔE<sub>g</sub>.</li>
          <li>The figure-based comparison is approximate because reading exact values from a plot is limited by resolution.</li>
        </ul>
      </div>

      <h3>Possible approaches (compare)</h3>
      <ol>
        <li><b>Direct algebra (best here):</b> Solve the empirical equation for p or Δn by isolating the cube-root and cubing. <span class="muted">Fast, exact within model.</span></li>
        <li><b>Log-scale reasoning:</b> Convert to log10 to estimate orders of magnitude quickly. <span class="muted">Good for intuition, less precise.</span></li>
        <li><b>Numerical sweep/plot:</b> Plot ΔE<sub>g</sub> vs concentration and read off where it equals −0.02 eV. <span class="muted">Visual, robust, ideal for design exploration.</span></li>
      </ol>
      <p><b>Chosen approach:</b> Direct algebra for the required numeric answers, plus plots for intuition and verification.</p>
    </section>

    <!-- PART 2 -->
    <section id="p2">
      <h2>PART 2 — Strategy &amp; Tips (Roadmap Only)</h2>

      <ol>
        <li>
          <b>Goal:</b> Translate “reduces by 0.02 eV” into an equation. <br/>
          <b>Tool:</b> Set ΔE<sub>g</sub> = −0.02 eV. <br/>
          <b>Meaning:</b> We’re using the model to match a target shrinkage magnitude.
        </li>
        <li>
          <b>(a) Goal:</b> Simplify for p-type. <br/>
          <b>Tool:</b> Assume n ≈ 0 ⇒ ΔE<sub>g</sub> ≈ −1.6×10<sup>−8</sup> p<sup>1/3</sup>. <br/>
          <b>Meaning:</b> Only holes significantly contribute to tail-induced shrinkage.
        </li>
        <li>
          <b>(a) Goal:</b> Solve for p. <br/>
          <b>Tool:</b> p<sup>1/3</sup> = 0.02 / (1.6×10<sup>−8</sup>), then cube. <br/>
          <b>Meaning:</b> The required doping level is set by a cube scaling.
        </li>
        <li>
          <b>(b) Goal:</b> Express n and p in terms of Δn. <br/>
          <b>Tool:</b> Undoped injection ⇒ n = p = Δn. <br/>
          <b>Meaning:</b> Pair generation forces equal electron/hole densities.
        </li>
        <li>
          <b>(b) Goal:</b> Solve for Δn. <br/>
          <b>Tool:</b> ΔE<sub>g</sub> = −1.6×10<sup>−8</sup>(2Δn<sup>1/3</sup>) = −3.2×10<sup>−8</sup>Δn<sup>1/3</sup>. <br/>
          <b>Meaning:</b> Two carrier types contribute, so the needed Δn is lower.
        </li>
        <li>
          <b>(c) Goal:</b> Compute shifted edge energy. <br/>
          <b>Tool:</b> E<sub>g</sub> + ΔE<sub>g</sub>. <br/>
          <b>Meaning:</b> This is the approximate photon energy where absorption/gain switches behavior.
        </li>
        <li>
          <b>(c) Goal:</b> Compare to the gain plot’s low-frequency zero crossing. <br/>
          <b>Tool:</b> Read hν at which gain ≈ 0 on the low-energy side. <br/>
          <b>Meaning:</b> A consistency check: the optical edge should be near that energy.
        </li>
      </ol>

      <div class="grid3">
        <div class="card danger">
          <b>Common mistakes</b>
          <ul>
            <li>Using m<sup>−3</sup> instead of cm<sup>−3</sup> (off by 10<sup>6</sup> in cube-root).</li>
            <li>Forgetting the factor of 2 when n = p.</li>
            <li>Setting ΔE<sub>g</sub> = +0.02 eV (wrong sign) instead of −0.02 eV.</li>
          </ul>
        </div>
        <div class="card ok">
          <b>Quick tips</b>
          <ul>
            <li>Compute cube-roots first, then cube only once at the end.</li>
            <li>Do a sanity check: results should fall in ~10<sup>17</sup>–10<sup>19</sup> cm<sup>−3</sup> for typical heavy injection/doping.</li>
            <li>Remember: doubling concentration increases |ΔE<sub>g</sub>| only by 2<sup>1/3</sup> ≈ 1.26.</li>
          </ul>
        </div>
        <div class="card">
          <b>Physical meaning checkpoints</b>
          <ul>
            <li>Higher n/p ⇒ stronger band tails ⇒ smaller effective gap.</li>
            <li>Injected (n and p both large) shrinks the gap more efficiently than only one carrier type.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- PART 3 -->
    <section id="p3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Qualitative expectation (before calculating)</h3>
      <p>
        Because ΔE<sub>g</sub> scales with the <b>cube-root</b> of carrier density, achieving a modest shrinkage like 0.02 eV
        typically requires <b>very high</b> densities (10<sup>17</sup>–10<sup>19</sup> cm<sup>−3</sup>).
        Also, in undoped injection (n = p), both terms contribute, so the required per-carrier density should be <b>smaller</b> than in pure p-type doping.
      </p>

      <div class="card callout">
        <b>Key equation (we will solve twice)</b>
        <div class="eqbox" style="margin-top:10px">
          <button class="copybtn" data-copy="eq2">Copy</button>
<pre class="eq" id="eq2">ΔEg(eV) ≈ −1.6×10^−8 · ( p^(1/3) + n^(1/3) )</pre>
        </div>
      </div>

      <h3>(a) p-type InGaAsP and GaAs: find p for a ~0.02 eV reduction</h3>
      <p>
        <b>Step 1 — Define the target:</b> “reduces by 0.02 eV” means
        <span class="muted">ΔE<sub>g</sub> ≈ −0.02 eV</span>.
      </p>
      <p>
        <b>Step 2 — Apply p-type assumption:</b> in strongly p-type material, holes dominate:
        n ≪ p ⇒ n<sup>1/3</sup> is negligible.
        So the model becomes
      </p>

      <div class="eqbox">
        <button class="copybtn" data-copy="eq3">Copy</button>
<pre class="eq" id="eq3">ΔEg ≈ −1.6×10^−8 · p^(1/3)</pre>
      </div>

      <p>
        <b>Step 3 — Solve for p:</b>
      </p>
      <div class="eqbox">
        <button class="copybtn" data-copy="eq4">Copy</button>
<pre class="eq" id="eq4">−0.02 = −1.6×10^−8 · p^(1/3)
p^(1/3) = 0.02 / (1.6×10^−8) = (2.0×10^−2)/(1.6×10^−8) = 1.25×10^6
p = (1.25×10^6)^3 = 1.953×10^18 cm^−3</pre>
      </div>

      <div class="card ok">
        <b>(a) Result</b>
        <div class="kv">
          <div class="big">p ≈ 2.0×10<sup>18</sup> cm<sup>−3</sup></div>
          <button class="copybtn" style="position:static" data-copy="ansA">Copy</button>
        </div>
<pre class="eq" id="ansA" style="display:none">Part (a): p ≈ 2.0×10^18 cm^−3 (for ΔEg ≈ −0.02 eV, p-type, n negligible)</pre>
        <p class="muted" style="margin:10px 0 0">
          <b>Interpretation:</b> this is a <b>very heavy</b> p-type concentration, consistent with the idea that band-tail shrinkage becomes significant only at high densities.
        </p>
      </div>

      <h3>(b) Undoped InGaAsP and GaAs: find injected Δn for a ~0.02 eV reduction (n<sub>i</sub> negligible)</h3>
      <p>
        <b>Step 1 — Use injection neutrality:</b> in undoped material under injection (and with n<sub>i</sub> negligible),
        we take
        <span class="muted">n = p = Δn</span>.
      </p>

      <p>
        <b>Step 2 — Substitute into the empirical law:</b>
      </p>
      <div class="eqbox">
        <button class="copybtn" data-copy="eq5">Copy</button>
<pre class="eq" id="eq5">ΔEg ≈ −1.6×10^−8 · ( Δn^(1/3) + Δn^(1/3) )
    = −1.6×10^−8 · ( 2Δn^(1/3) )
    = −3.2×10^−8 · Δn^(1/3)</pre>
      </div>

      <p>
        <b>Step 3 — Solve for Δn:</b>
      </p>
      <div class="eqbox">
        <button class="copybtn" data-copy="eq6">Copy</button>
<pre class="eq" id="eq6">−0.02 = −3.2×10^−8 · Δn^(1/3)
Δn^(1/3) = 0.02 / (3.2×10^−8) = (2.0×10^−2)/(3.2×10^−8) = 6.25×10^5
Δn = (6.25×10^5)^3 = 2.441×10^17 cm^−3</pre>
      </div>

      <div class="card ok">
        <b>(b) Result</b>
        <div class="kv">
          <div class="big">Δn ≈ 2.4×10<sup>17</sup> cm<sup>−3</sup></div>
          <button class="copybtn" style="position:static" data-copy="ansB">Copy</button>
        </div>
<pre class="eq" id="ansB" style="display:none">Part (b): Δn ≈ 2.4×10^17 cm^−3 (for ΔEg ≈ −0.02 eV, undoped injection, n=p=Δn)</pre>
        <p class="muted" style="margin:10px 0 0">
          <b>Interpretation:</b> compared to part (a), the required density is lower because <b>both</b> electrons and holes contribute to bandgap shrinkage.
        </p>
      </div>

      <h3>(c) Compute E<sub>g</sub> + ΔE<sub>g</sub> and compare to the gain turn-on energy</h3>
      <p>
        The shifted band edge is simply:
      </p>
      <div class="eqbox">
        <button class="copybtn" data-copy="eq7">Copy</button>
<pre class="eq" id="eq7">Effective edge energy:  E_edge ≈ Eg + ΔEg</pre>
      </div>

      <p>
        For a concrete comparison to the provided <b>GaAs gain curve</b>, we need a reference GaAs bandgap.
        A standard room-temperature value is <span class="muted">(example reference)</span>:
        E<sub>g</sub>(GaAs, 300 K) ≈ 1.424 eV.
        Using ΔE<sub>g</sub> ≈ −0.02 eV gives:
      </p>

      <div class="eqbox">
        <button class="copybtn" data-copy="eq8">Copy</button>
<pre class="eq" id="eq8">Eg + ΔEg ≈ 1.424 eV − 0.020 eV = 1.404 eV</pre>
      </div>

      <div class="card callout">
        <b>Comparison to the figure (qualitative)</b>
        <p class="muted" style="margin:8px 0 0">
          In the provided GaAs SOA gain plot, the gain on the low-frequency side crosses near
          <b>hν ≈ 1.40 eV</b> (reading approximately from the axis). Our predicted edge
          <b>E<sub>g</sub> + ΔE<sub>g</sub> ≈ 1.404 eV</b> is consistent with that turn-on energy to within plot-reading accuracy.
        </p>
      </div>

      <div class="card ok">
        <b>Final boxed answers (a–c)</b>
        <div class="eqbox" style="margin-top:10px">
          <button class="copybtn" data-copy="finalAll">Copy</button>
<pre class="eq" id="finalAll">Given: ΔEg(eV) ≈ −1.6×10^−8 (p^(1/3) + n^(1/3)),  n,p in cm^−3.

(a) p-type (n negligible):  p ≈ (0.02 / 1.6×10^−8)^3 ≈ 2.0×10^18 cm^−3.
(b) Undoped injection (n=p=Δn): Δn ≈ (0.02 / 3.2×10^−8)^3 ≈ 2.4×10^17 cm^−3.
(c) Example GaAs (Eg≈1.424 eV): Eg+ΔEg ≈ 1.404 eV, consistent with low-energy zero-gain near ~1.40 eV in the figure.</pre>
        </div>

        <h3>Sanity checks</h3>
        <ul>
          <li><b>Units:</b> constant 1.6×10<sup>−8</sup> expects n,p in cm<sup>−3</sup>; the results are in cm<sup>−3</sup> as required.</li>
          <li><b>Limiting behavior:</b> if n,p → 0, then ΔE<sub>g</sub> → 0 (no shrinkage). If n,p increase, ΔE<sub>g</sub> becomes more negative.</li>
          <li><b>Magnitude:</b> 0.02 eV shrinkage requiring ~10<sup>17</sup>–10<sup>18</sup> cm<sup>−3</sup> is plausible for heavy injection/doping regimes in optoelectronic devices.</li>
          <li><b>Sign reasoning:</b> the negative sign means the gap reduces (edge shifts to lower photon energy), matching the gain turn-on moving leftward.</li>
        </ul>
      </div>

      <p class="muted">
        Connection to the plots/diagram: the diagram below shows E<sub>g</sub> shrinking to E<sub>g</sub>+ΔE<sub>g</sub>.
        The plots show how ΔE<sub>g</sub> and the shifted edge depend on carrier concentration, with markers for the 0.02 eV target.
      </p>
    </section>

    <!-- PART 4 -->
    <section id="p4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Reinterpreting the formula</h3>
      <p>
        The empirical result
        ΔE<sub>g</sub> ∝ −(p<sup>1/3</sup> + n<sup>1/3</sup>)
        says the gap shrinkage is driven by <b>carrier density</b> but with a <b>sublinear</b> cube-root dependence.
        That sublinearity is why you need very large densities to shift the gap by only a few tens of meV.
      </p>

      <div class="grid2">
        <div class="card">
          <b>Parameter sensitivity (connect to the interactive plots)</b>
          <ul>
            <li>Increase p (p-type): ΔE<sub>g</sub> becomes more negative like −p<sup>1/3</sup>.</li>
            <li>Increase injection (n=p=Δn): ΔE<sub>g</sub> becomes more negative like −2Δn<sup>1/3</sup>.</li>
            <li>Because of the 1/3 power, changing density by a factor of 8 changes |ΔE<sub>g</sub>| by a factor of 2.</li>
            <li>The shifted optical edge E<sub>edge</sub>=E<sub>g</sub>+ΔE<sub>g</sub> moves downward (left on an hν axis), consistent with earlier gain turn-on.</li>
          </ul>
        </div>

        <div class="card callout">
          <b>Alternative derivation idea (brief)</b>
          <p class="muted" style="margin:8px 0 0">
            A more microscopic route is to compute band edge renormalization from many-body interactions
            (exchange-correlation) and disorder-induced Urbach tails, then fit the result to a power law.
            The empirical 1/3 scaling is a compact way to capture that behavior over device-relevant ranges.
          </p>
        </div>
      </div>

      <h3>Concept checks (self-test)</h3>
      <ul>
        <li><b>Q:</b> If carrier density increases by 1000×, how does |ΔE<sub>g</sub>| change (roughly)? <b>A:</b> by 1000<sup>1/3</sup>=10×.</li>
        <li><b>Q:</b> Why is Δn in part (b) lower than p in part (a) for the same shrinkage? <b>A:</b> both n and p contribute (two cube-root terms).</li>
        <li><b>Q:</b> If ΔE<sub>g</sub> is −0.02 eV, does the absorption edge move to higher or lower photon energy? <b>A:</b> lower photon energy.</li>
        <li><b>Q:</b> What is the biggest practical pitfall when using the empirical law? <b>A:</b> mixing units (cm<sup>−3</sup> vs m<sup>−3</sup>) or forgetting n=p under injection.</li>
      </ul>
    </section>

    <!-- PART 5 -->
    <section id="p5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <div class="grid2">
        <div class="card">
          <b>What each canvas shows</b>
          <ul>
            <li><b>Diagram (Band edges):</b> A simple energy-band picture showing E<sub>g</sub> and the reduced gap E<sub>g</sub>+ΔE<sub>g</sub>.</li>
            <li><b>Main plot:</b> ΔE<sub>g</sub> vs carrier concentration (log scale), with curves for:
              <span class="muted">p-type (n≈0)</span> and <span class="muted">undoped injection (n=p)</span>.</li>
            <li><b>Secondary plot:</b> E<sub>edge</sub>=E<sub>g</sub>+ΔE<sub>g</sub> vs carrier concentration.
              For GaAs, a reference line near <span class="muted">~1.40 eV</span> is shown to mimic the gain turn-on energy from the provided figure.</li>
          </ul>
        </div>

        <div class="card callout">
          <b>Interactive controls</b>
          <ul>
            <li><b>Material select:</b> switches the reference E<sub>g</sub> used in the secondary plot (example values for visualization).</li>
            <li><b>Case select:</b> choose <span class="muted">p-type</span> or <span class="muted">undoped injection</span> for the live marker.</li>
            <li><b>Carrier slider:</b> changes the carrier concentration (log scale). The marker moves on <b>both</b> plots and the band diagram updates.</li>
            <li><b>“Snap to 0.02 eV”:</b> jumps the slider to the concentration that yields ΔE<sub>g</sub>≈−0.02 eV for the chosen case.</li>
          </ul>
          <p class="muted" style="margin-top:10px">
            As you increase concentration, you should see ΔE<sub>g</sub> become more negative and E<sub>edge</sub> shift downward.
            The injection case shrinks the gap faster than the p-type case.
          </p>
        </div>
      </div>
    </section>

    <!-- Visualizations -->
    <section id="viz">
      <h2>Interactive Visualizations</h2>

      <div class="vizwrap">
        <div class="controls card">
          <div>
            <label for="matSel">Material (sets reference E<sub>g</sub> for E<sub>edge</sub> plot)</label>
            <select id="matSel">
              <option value="GaAs">GaAs (example Eg = 1.424 eV @ ~300 K)</option>
              <option value="InGaAsP">InGaAsP (example Eg = 1.30 eV — composition-dependent)</option>
            </select>
          </div>
          <div>
            <label for="caseSel">Case for live marker</label>
            <select id="caseSel">
              <option value="ptype">p-type (n ≈ 0)</option>
              <option value="inj">Undoped injection (n = p = Δn)</option>
            </select>
          </div>
          <div>
            <label for="logN">Carrier concentration (log<sub>10</sub>, cm<sup>−3</sup>)</label>
            <input id="logN" type="range" min="15" max="19.2" step="0.01" value="17.4"/>
          </div>
          <div style="grid-column:1/-1; display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-top:10px">
            <button class="vbtn" id="snapBtn" type="button">Snap to |ΔE<sub>g</sub>| = 0.02 eV (chosen case)</button>
            <button class="vbtn" id="resetBtn" type="button">Reset to mid-range</button>
          </div>

          <div class="readout" style="grid-column:1/-1">
            <div class="chip">
              <div class="k">Carrier concentration</div>
              <div class="v" id="nRead">—</div>
            </div>
            <div class="chip">
              <div class="k">ΔE<sub>g</sub> (model)</div>
              <div class="v" id="dEgRead">—</div>
            </div>
            <div class="chip">
              <div class="k">E<sub>edge</sub> = E<sub>g</sub> + ΔE<sub>g</sub></div>
              <div class="v" id="eEdgeRead">—</div>
            </div>
          </div>
        </div>

        <figure class="card">
          <canvas id="bandCanvas" class="canvasTall" aria-label="Band diagram canvas"></canvas>
          <div class="muted" style="margin-top:10px">
            Diagram: conduction/valence bands and the shrinking gap due to band-tail states (illustrative, not to scale).
          </div>
        </figure>

        <figure class="card">
          <canvas id="mainCanvas" aria-label="Main plot canvas"></canvas>
          <div class="muted" style="margin-top:10px">
            Main plot: ΔE<sub>g</sub> vs carrier concentration (log scale). Curves show p-type and injection cases; marker shows current slider setting.
          </div>
        </figure>

        <figure class="card">
          <canvas id="secCanvas" aria-label="Secondary plot canvas"></canvas>
          <div class="muted" style="margin-top:10px">
            Secondary plot: E<sub>edge</sub>=E<sub>g</sub>+ΔE<sub>g</sub> vs concentration. A GaAs reference line (~1.40 eV) indicates the figure’s low-energy zero-gain region.
          </div>
        </figure>
      </div>
    </section>

    <div class="foot">
      Built with vanilla HTML/CSS/JS. Numerical values for E<sub>g</sub> used in plots are labeled as <b>example</b> reference values for visualization;
      the core answers (p and Δn) come directly from the given empirical law and the target ΔE<sub>g</sub>.
    </div>
  </article>
</main>

<footer style="max-width:1200px; margin:0 auto; padding:0 18px 26px; color:var(--muted); font-size:.9rem">
  <div class="card" style="padding:14px 16px">
    <b class="muted">Note:</b>
    The comparison in part (c) is approximate because the gain turn-on energy is read visually from the provided figure.
    In real devices, gain also depends on quasi-Fermi level separation, temperature, and broadening mechanisms.
  </div>
</footer>

<script>
(function(){
  // ---------- Copy buttons ----------
  function copyTextFrom(id){
    const el = document.getElementById(id);
    if(!el) return;
    const text = el.innerText || el.textContent || "";
    navigator.clipboard.writeText(text).then(()=>flashCopied(id)).catch(()=>fallbackCopy(text, id));
  }
  function fallbackCopy(text, id){
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand('copy'); flashCopied(id); }catch(e){}
    document.body.removeChild(ta);
  }
  function flashCopied(id){
    const btns = document.querySelectorAll('.copybtn[data-copy="'+id+'"]');
    btns.forEach(btn=>{
      const old = btn.textContent;
      btn.textContent = "Copied ✓";
      btn.style.borderColor = "rgba(167,255,176,.45)";
      btn.style.background = "rgba(167,255,176,.10)";
      setTimeout(()=>{
        btn.textContent = old;
        btn.style.borderColor = "";
        btn.style.background = "";
      }, 900);
    });
  }
  document.querySelectorAll('.copybtn[data-copy]').forEach(btn=>{
    btn.addEventListener('click', ()=>copyTextFrom(btn.getAttribute('data-copy')));
  });

  // ---------- Model functions ----------
  // Empirical law: ΔEg = −1.6e−8 (p^(1/3) + n^(1/3)), n,p in cm^-3
  const K = 1.6e-8;

  function dEg_pType(p){
    return -K * Math.cbrt(p);
  }
  function dEg_inj(dn){
    return -K * (Math.cbrt(dn) + Math.cbrt(dn)); // n=p=dn
  }
  function fmtSci(x, sig=3){
    if(x === 0) return "0";
    const sign = x < 0 ? "-" : "";
    x = Math.abs(x);
    const exp = Math.floor(Math.log10(x));
    const mant = x / Math.pow(10, exp);
    const m = mant.toFixed(Math.max(0, sig-1));
    return `${sign}${m}×10^${exp}`;
  }
  function fmtE(x, digits=4){
    return (x>=0? "" : "−") + Math.abs(x).toFixed(digits) + " eV";
  }

  // ---------- State ----------
  const matSel = document.getElementById('matSel');
  const caseSel = document.getElementById('caseSel');
  const logN = document.getElementById('logN');
  const snapBtn = document.getElementById('snapBtn');
  const resetBtn = document.getElementById('resetBtn');

  const nRead = document.getElementById('nRead');
  const dEgRead = document.getElementById('dEgRead');
  const eEdgeRead = document.getElementById('eEdgeRead');

  const mats = {
    "GaAs": { Eg: 1.424, refLine: 1.400, refLabel: "≈1.40 eV (from gain plot, approx.)" },
    "InGaAsP": { Eg: 1.300, refLine: null, refLabel: "" } // composition-dependent; example only
  };

  // ---------- Canvas utilities ----------
  function setupCanvas(canvas){
    const ctx = canvas.getContext('2d');
    function resize(){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(2, Math.floor(rect.width * dpr));
      const h = Math.max(2, Math.floor(rect.height * dpr));
      if(canvas.width !== w || canvas.height !== h){
        canvas.width = w;
        canvas.height = h;
      }
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
    }
    return {canvas, ctx, resize};
  }

  function drawGrid(ctx, x0,y0,w,h, nx=10, ny=6){
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    ctx.lineWidth = 1;
    for(let i=0;i<=nx;i++){
      const x = x0 + (w*i/nx);
      ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y0+h); ctx.stroke();
    }
    for(let j=0;j<=ny;j++){
      const y = y0 + (h*j/ny);
      ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x0+w,y); ctx.stroke();
    }
    ctx.restore();
  }

  function niceTicks(min, max, n=6){
    // simple linear ticks
    const span = max-min;
    if(span<=0) return [min];
    const rawStep = span/(n-1);
    const pow = Math.pow(10, Math.floor(Math.log10(rawStep)));
    const steps = [1,2,2.5,5,10].map(s=>s*pow);
    let step = steps[0];
    for(const s of steps){ if(Math.abs(rawStep-s) < Math.abs(rawStep-step)) step=s; }
    const start = Math.ceil(min/step)*step;
    const out = [];
    for(let v=start; v<=max+1e-9; v+=step) out.push(v);
    return out;
  }

  // ---------- Plotting helpers ----------
  function plotAxes(ctx, box, xLabel, yLabel, title){
    const {x,y,w,h} = box;
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,.92)";
    ctx.font = "600 14px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText(title, x, y-10);

    ctx.strokeStyle = "rgba(255,255,255,.20)";
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.rect(x,y,w,h);
    ctx.stroke();

    ctx.fillStyle = "rgba(255,255,255,.80)";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    // x label
    ctx.textAlign = "center";
    ctx.fillText(xLabel, x + w/2, y + h + 34);
    // y label (rotated)
    ctx.save();
    ctx.translate(x - 38, y + h/2);
    ctx.rotate(-Math.PI/2);
    ctx.textAlign = "center";
    ctx.fillText(yLabel, 0, 0);
    ctx.restore();
    ctx.restore();
  }

  function legend(ctx, items, x, y){
    ctx.save();
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    ctx.textAlign = "left";
    let yy = y;
    items.forEach(it=>{
      ctx.strokeStyle = it.color;
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      ctx.moveTo(x, yy);
      ctx.lineTo(x+18, yy);
      ctx.stroke();
      ctx.fillStyle = "rgba(255,255,255,.85)";
      ctx.fillText(it.label, x+26, yy+4);
      yy += 18;
    });
    ctx.restore();
  }

  // ---------- Canvases ----------
  const band = setupCanvas(document.getElementById('bandCanvas'));
  const main = setupCanvas(document.getElementById('mainCanvas'));
  const sec  = setupCanvas(document.getElementById('secCanvas'));

  // ---------- Draw band diagram ----------
  function drawBandDiagram(Eg, dEg){
    const ctx = band.ctx;
    band.resize();
    const W = band.canvas.getBoundingClientRect().width;
    const H = band.canvas.getBoundingClientRect().height;

    ctx.clearRect(0,0,W,H);

    // Layout
    const pad = 18;
    const left = pad, top = 48, w = W - 2*pad, h = H - top - 18;

    // Background grid
    drawGrid(ctx, left, top, w, h, 10, 8);

    // Energy axis
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,.25)";
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.moveTo(left+34, top);
    ctx.lineTo(left+34, top+h);
    ctx.stroke();
    ctx.fillStyle = "rgba(255,255,255,.85)";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText("Energy (arb.)", left+6, top-12);
    ctx.restore();

    // Map energies to vertical positions
    const Eg2 = Eg + dEg; // reduced bandgap
    const Emax = Eg + 0.12;
    const Emin = Math.max(0, Eg2 - 0.10);
    function yOf(E){
      const t = (E - Emin) / (Emax - Emin);
      return top + h*(1 - t);
    }

    const yV = yOf(0.15);          // valence band reference (arb.)
    const yC = yOf(0.15 + Eg);     // conduction band reference
    const yC2 = yOf(0.15 + Eg2);   // reduced conduction edge

    // Draw valence band
    ctx.save();
    ctx.strokeStyle = "rgba(167,255,176,.85)";
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(left+70, yV);
    ctx.lineTo(left+w-10, yV);
    ctx.stroke();
    ctx.fillStyle = "rgba(167,255,176,.95)";
    ctx.font = "600 13px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText("Valence band edge", left+70, yV-10);
    ctx.restore();

    // Draw conduction band (original)
    ctx.save();
    ctx.strokeStyle = "rgba(123,211,255,.85)";
    ctx.lineWidth = 3;
    ctx.setLineDash([6,4]);
    ctx.beginPath();
    ctx.moveTo(left+70, yC);
    ctx.lineTo(left+w-10, yC);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = "rgba(123,211,255,.95)";
    ctx.font = "600 13px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText("Conduction band edge (Eg)", left+70, yC-10);
    ctx.restore();

    // Draw conduction band (reduced)
    ctx.save();
    ctx.strokeStyle = "rgba(255,210,123,.92)";
    ctx.lineWidth = 3.2;
    ctx.beginPath();
    ctx.moveTo(left+70, yC2);
    ctx.lineTo(left+w-10, yC2);
    ctx.stroke();
    ctx.fillStyle = "rgba(255,210,123,.95)";
    ctx.font = "600 13px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText("Shifted edge (Eg + ΔEg)", left+70, yC2-10);
    ctx.restore();

    // Gap arrows
    function arrow(x, y1, y2, color, label){
      ctx.save();
      ctx.strokeStyle = color;
      ctx.fillStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x, y1);
      ctx.lineTo(x, y2);
      ctx.stroke();
      // arrowheads
      const ah = 7;
      ctx.beginPath();
      ctx.moveTo(x, y1);
      ctx.lineTo(x-ah, y1+ah);
      ctx.lineTo(x+ah, y1+ah);
      ctx.closePath();
      ctx.fill();
      ctx.beginPath();
      ctx.moveTo(x, y2);
      ctx.lineTo(x-ah, y2-ah);
      ctx.lineTo(x+ah, y2-ah);
      ctx.closePath();
      ctx.fill();

      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText(label, x+10, (y1+y2)/2 + 4);
      ctx.restore();
    }

    arrow(left+50, yC, yV, "rgba(123,211,255,.9)", `Eg = ${Eg.toFixed(3)} eV`);
    arrow(left+16, yC2, yV, "rgba(255,210,123,.92)", `Eg+ΔEg = ${(Eg2).toFixed(3)} eV`);

    // Band-tail illustration
    ctx.save();
    ctx.fillStyle = "rgba(255,123,154,.12)";
    ctx.strokeStyle = "rgba(255,123,154,.35)";
    ctx.lineWidth = 1.5;
    const tailX = left + w - 140;
    const tailW = 110;
    const tailTop = Math.min(yC2, yC) - 5;
    const tailBot = yV + 5;
    ctx.beginPath();
    ctx.roundRect(tailX, tailTop, tailW, tailBot - tailTop, 14);
    ctx.fill();
    ctx.stroke();
    ctx.fillStyle = "rgba(255,123,154,.85)";
    ctx.font = "600 12px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText("Band-tail /", tailX+10, tailTop+20);
    ctx.fillText("broadening", tailX+10, tailTop+36);
    ctx.restore();

    // Title + numeric readout
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,.92)";
    ctx.font = "700 14px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText("Bandgap reduction picture", left, 26);

    ctx.fillStyle = "rgba(255,255,255,.78)";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
    const s = `ΔEg = ${dEg.toFixed(4)} eV  (negative = shrinkage)`;
    ctx.fillText(s, left, 42);
    ctx.restore();
  }

  // ---------- Draw main plot: ΔEg vs concentration ----------
  function drawMainPlot(materialKey, markerCase, markerN){
    const ctx = main.ctx;
    main.resize();
    const W = main.canvas.getBoundingClientRect().width;
    const H = main.canvas.getBoundingClientRect().height;
    ctx.clearRect(0,0,W,H);

    const padL = 64, padR = 18, padT = 44, padB = 56;
    const box = {x:padL, y:padT, w:W-padL-padR, h:H-padT-padB};

    drawGrid(ctx, box.x, box.y, box.w, box.h, 10, 6);
    plotAxes(ctx, box, "Carrier concentration (cm⁻³, log₁₀ scale)", "ΔEg (eV)", "ΔEg vs carrier concentration (empirical model)");

    // x log10 range
    const xMin = 15, xMax = 19.2;
    // y range (negative)
    const yMin = -0.08, yMax = 0.005;

    function X(log10n){ return box.x + (log10n - xMin)/(xMax-xMin)*box.w; }
    function Y(val){ return box.y + (yMax - val)/(yMax-yMin)*box.h; }

    // ticks
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,.75)";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;

    // x ticks (integers)
    ctx.textAlign="center";
    for(let t=15; t<=19; t++){
      const xx = X(t);
      ctx.strokeStyle="rgba(255,255,255,.22)";
      ctx.beginPath(); ctx.moveTo(xx, box.y+box.h); ctx.lineTo(xx, box.y+box.h+6); ctx.stroke();
      ctx.fillText(String(t), xx, box.y+box.h+22);
    }

    // y ticks
    ctx.textAlign="right";
    const yt = niceTicks(yMin, yMax, 6);
    yt.forEach(v=>{
      const yy = Y(v);
      ctx.strokeStyle="rgba(255,255,255,.22)";
      ctx.beginPath(); ctx.moveTo(box.x-6, yy); ctx.lineTo(box.x, yy); ctx.stroke();
      ctx.fillText((v).toFixed(2), box.x-10, yy+4);
    });
    ctx.restore();

    // curves
    const colP = "rgba(123,211,255,.95)";
    const colI = "rgba(167,255,176,.95)";

    function drawCurve(fn, color){
      ctx.save();
      ctx.strokeStyle=color;
      ctx.lineWidth=2.4;
      ctx.beginPath();
      let first=true;
      for(let lx=xMin; lx<=xMax+1e-9; lx+=0.02){
        const n = Math.pow(10,lx);
        const y = fn(n);
        const xx = X(lx), yy = Y(y);
        if(first){ctx.moveTo(xx,yy); first=false;}
        else ctx.lineTo(xx,yy);
      }
      ctx.stroke();
      ctx.restore();
    }
    drawCurve(dEg_pType, colP);
    drawCurve(dEg_inj, colI);

    // target line ΔEg=-0.02
    const target = -0.02;
    ctx.save();
    ctx.strokeStyle="rgba(255,210,123,.55)";
    ctx.lineWidth=1.6;
    ctx.setLineDash([6,5]);
    ctx.beginPath();
    ctx.moveTo(box.x, Y(target));
    ctx.lineTo(box.x+box.w, Y(target));
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle="rgba(255,210,123,.85)";
    ctx.font="12px " + getComputedStyle(document.body).fontFamily;
    ctx.fillText("target ΔEg = −0.02 eV", box.x+8, Y(target)-8);
    ctx.restore();

    // marker point
    const logM = Math.log10(markerN);
    const yM = (markerCase==="ptype") ? dEg_pType(markerN) : dEg_inj(markerN);
    ctx.save();
    ctx.fillStyle = (markerCase==="ptype") ? colP : colI;
    ctx.strokeStyle = "rgba(0,0,0,.35)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(X(logM), Y(yM), 5.5, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();
    ctx.restore();

    // legend
    legend(ctx, [
      {color: colP, label:"p-type (n≈0): ΔEg=−K p^(1/3)"},
      {color: colI, label:"injection (n=p): ΔEg=−2K (Δn)^(1/3)"}
    ], box.x + 10, box.y + 18);
  }

  // ---------- Draw secondary plot: E_edge vs concentration ----------
  function drawSecPlot(materialKey, markerCase, markerN){
    const ctx = sec.ctx;
    sec.resize();
    const W = sec.canvas.getBoundingClientRect().width;
    const H = sec.canvas.getBoundingClientRect().height;
    ctx.clearRect(0,0,W,H);

    const mat = mats[materialKey];
    const Eg = mat.Eg;

    const padL = 64, padR = 18, padT = 44, padB = 56;
    const box = {x:padL, y:padT, w:W-padL-padR, h:H-padT-padB};

    drawGrid(ctx, box.x, box.y, box.w, box.h, 10, 6);
    plotAxes(ctx, box, "Carrier concentration (cm⁻³, log₁₀ scale)", "Eedge = Eg + ΔEg (eV)", "Shifted optical edge vs concentration");

    // x range
    const xMin = 15, xMax = 19.2;

    // y range set around Eg
    const yMax = Eg + 0.01;
    const yMin = Eg - 0.09;

    function X(log10n){ return box.x + (log10n - xMin)/(xMax-xMin)*box.w; }
    function Y(val){ return box.y + (yMax - val)/(yMax-yMin)*box.h; }

    // ticks
    ctx.save();
    ctx.fillStyle = "rgba(255,255,255,.75)";
    ctx.font = "12px " + getComputedStyle(document.body).fontFamily;

    // x ticks
    ctx.textAlign="center";
    for(let t=15; t<=19; t++){
      const xx = X(t);
      ctx.strokeStyle="rgba(255,255,255,.22)";
      ctx.beginPath(); ctx.moveTo(xx, box.y+box.h); ctx.lineTo(xx, box.y+box.h+6); ctx.stroke();
      ctx.fillText(String(t), xx, box.y+box.h+22);
    }

    // y ticks
    ctx.textAlign="right";
    const yt = niceTicks(yMin, yMax, 6);
    yt.forEach(v=>{
      const yy = Y(v);
      ctx.strokeStyle="rgba(255,255,255,.22)";
      ctx.beginPath(); ctx.moveTo(box.x-6, yy); ctx.lineTo(box.x, yy); ctx.stroke();
      ctx.fillText((v).toFixed(2), box.x-10, yy+4);
    });
    ctx.restore();

    const colP = "rgba(123,211,255,.95)";
    const colI = "rgba(167,255,176,.95)";

    function drawCurve(fn, color){
      ctx.save();
      ctx.strokeStyle=color;
      ctx.lineWidth=2.4;
      ctx.beginPath();
      let first=true;
      for(let lx=xMin; lx<=xMax+1e-9; lx+=0.02){
        const n = Math.pow(10,lx);
        const d = fn(n);
        const e = Eg + d;
        const xx = X(lx), yy = Y(e);
        if(first){ctx.moveTo(xx,yy); first=false;}
        else ctx.lineTo(xx,yy);
      }
      ctx.stroke();
      ctx.restore();
    }

    drawCurve(dEg_pType, colP);
    drawCurve(dEg_inj, colI);

    // reference line for GaAs figure (~1.40 eV)
    if(mat.refLine !== null){
      ctx.save();
      ctx.strokeStyle="rgba(255,123,154,.55)";
      ctx.lineWidth=1.6;
      ctx.setLineDash([6,5]);
      ctx.beginPath();
      ctx.moveTo(box.x, Y(mat.refLine));
      ctx.lineTo(box.x+box.w, Y(mat.refLine));
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle="rgba(255,123,154,.85)";
      ctx.font="12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText(mat.refLabel, box.x+8, Y(mat.refLine)-8);
      ctx.restore();
    }

    // marker
    const logM = Math.log10(markerN);
    const dEg = (markerCase==="ptype") ? dEg_pType(markerN) : dEg_inj(markerN);
    const eM = Eg + dEg;
    ctx.save();
    ctx.fillStyle = (markerCase==="ptype") ? colP : colI;
    ctx.strokeStyle = "rgba(0,0,0,.35)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(X(logM), Y(eM), 5.5, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();
    ctx.restore();

    // legend
    legend(ctx, [
      {color: colP, label:"p-type: Eg + (−K p^(1/3))"},
      {color: colI, label:"injection: Eg + (−2K (Δn)^(1/3))"}
    ], box.x + 10, box.y + 18);
  }

  // ---------- Compute snap values for target ΔEg = −0.02 ----------
  function solveForN(targetAbs, which){
    // targetAbs = 0.02 for magnitude, but model uses negative
    if(which === "ptype"){
      const c = targetAbs / K; // p^(1/3)
      return Math.pow(c, 3);
    }else{
      const c = targetAbs / (2*K); // Δn^(1/3)
      return Math.pow(c, 3);
    }
  }

  // ---------- Update ----------
  function update(){
    const materialKey = matSel.value;
    const which = caseSel.value;
    const n = Math.pow(10, parseFloat(logN.value));

    const dEg = (which==="ptype") ? dEg_pType(n) : dEg_inj(n);
    const Eg = mats[materialKey].Eg;
    const eEdge = Eg + dEg;

    // readouts
    nRead.textContent = `${fmtSci(n,3)} cm^−3`;
    dEgRead.textContent = `${(dEg>=0?"+":"")}${dEg.toFixed(5)} eV`;
    eEdgeRead.textContent = `${eEdge.toFixed(5)} eV`;

    drawBandDiagram(Eg, dEg);
    drawMainPlot(materialKey, which, n);
    drawSecPlot(materialKey, which, n);
  }

  // events
  matSel.addEventListener('change', update);
  caseSel.addEventListener('change', update);
  logN.addEventListener('input', update);

  snapBtn.addEventListener('click', ()=>{
    const which = caseSel.value;
    const nTarget = solveForN(0.02, which);
    const logTarget = Math.log10(nTarget);
    logN.value = Math.min(parseFloat(logN.max), Math.max(parseFloat(logN.min), logTarget));
    update();
  });

  resetBtn.addEventListener('click', ()=>{
    logN.value = 17.4;
    update();
  });

  // Resize handling (responsive + crisp)
  let rAF = null;
  window.addEventListener('resize', ()=>{
    if(rAF) cancelAnimationFrame(rAF);
    rAF = requestAnimationFrame(()=>update());
  });

  // initial
  update();
})();
</script>
</body>
</html>
