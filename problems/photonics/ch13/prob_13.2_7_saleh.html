<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Photon-Number Statistics for Multimode Thermal Light in a Cavity</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f1630;
      --text:#eaf0ff;
      --muted:#b8c3e6;
      --faint:#7f8ab5;
      --accent:#7cf0c5;
      --accent2:#9aa7ff;
      --warn:#ffd37c;
      --danger:#ff7ca8;
      --line:rgba(255,255,255,0.10);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f8ff;
        --card:#ffffff;
        --card2:#f3f5ff;
        --text:#101427;
        --muted:#2b355c;
        --faint:#5a668f;
        --line:rgba(16,20,39,0.12);
        --shadow: 0 10px 25px rgba(16,20,39,0.10);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 600px at 15% 10%, rgba(124,240,197,0.15), transparent 55%),
                  radial-gradient(900px 700px at 85% 15%, rgba(154,167,255,0.17), transparent 60%),
                  linear-gradient(180deg, var(--bg), var(--bg));
      line-height:1.55;
      letter-spacing:0.1px;
    }

    header{
      padding: 42px 18px 22px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .titleWrap{
      display:grid;
      grid-template-columns: 1.15fr 0.85fr;
      gap:16px;
      align-items:end;
    }
    @media (max-width: 980px){
      .titleWrap{grid-template-columns:1fr}
    }
    h1{
      margin:0;
      font-size: clamp(1.6rem, 2.6vw, 2.5rem);
      line-height:1.15;
      letter-spacing:0.2px;
    }
    .subtitle{
      margin:10px 0 0;
      color:var(--muted);
      max-width: 70ch;
      font-size: 1.02rem;
    }

    .metaCard{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px 12px;
    }
    .metaGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      font-size:0.95rem;
    }
    .metaItem{
      padding:10px 10px;
      background: rgba(0,0,0,0.12);
      border:1px solid var(--line);
      border-radius: 14px;
    }
    @media (prefers-color-scheme: light){
      .metaItem{background: rgba(16,20,39,0.03);}
    }
    .metaItem b{display:block; font-weight:700; margin-bottom:4px}
    .metaItem span{color:var(--muted)}
    .pillRow{
      margin-top:10px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .pill{
      font-size:0.86rem;
      padding:7px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(124,240,197,0.10);
      color: var(--text);
      white-space:nowrap;
    }
    .pill.alt{background: rgba(154,167,255,0.12);}
    .pill.warn{background: rgba(255,211,124,0.14);}

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 60px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr;}
    }

    nav.toc{
      position: sticky;
      top: 14px;
      align-self:start;
      border-radius: var(--radius);
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      box-shadow: var(--shadow);
      padding: 14px 14px 10px;
    }
    @media (max-width: 980px){
      nav.toc{position:relative; top:auto;}
    }
    .toc h2{
      margin:0 0 10px;
      font-size: 1.0rem;
      letter-spacing:0.2px;
    }
    .toc a{
      display:block;
      padding:7px 10px;
      border-radius: 12px;
      color: var(--muted);
      text-decoration:none;
      border:1px solid transparent;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size: 0.95rem;
    }
    .toc a:hover{
      background: rgba(124,240,197,0.10);
      border-color: var(--line);
      transform: translateX(2px);
      color: var(--text);
    }

    article{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    section.card{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      overflow:hidden;
    }
    section.card h2{
      margin:0 0 10px;
      font-size: 1.35rem;
      letter-spacing:0.2px;
    }
    section.card h3{
      margin: 16px 0 8px;
      font-size: 1.12rem;
      color: var(--text);
    }
    p{margin: 10px 0; color: var(--muted)}
    ul{margin: 10px 0 10px 20px; color: var(--muted)}
    li{margin: 7px 0}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){ .grid2{grid-template-columns:1fr;} }

    .callout{
      border-radius: 16px;
      border:1px solid var(--line);
      padding: 12px 12px;
      background: rgba(0,0,0,0.12);
    }
    @media (prefers-color-scheme: light){
      .callout{background: rgba(16,20,39,0.03);}
    }
    .callout h4{
      margin:0 0 6px;
      font-size: 0.98rem;
      letter-spacing:0.2px;
      display:flex;
      align-items:center;
      gap:8px;
      color: var(--text);
    }
    .badge{
      display:inline-flex;
      align-items:center;
      justify-content:center;
      width:22px;height:22px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(124,240,197,0.15);
      font-weight:800;
      font-size: 0.85rem;
      color: var(--text);
    }
    .badge.warn{background: rgba(255,211,124,0.18);}
    .badge.danger{background: rgba(255,124,168,0.16);}
    .eq{
      font-family: var(--mono);
      font-size: 0.98rem;
      color: var(--text);
      background: rgba(0,0,0,0.22);
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 10px;
      overflow:auto;
      white-space: pre-wrap;
      word-break: break-word;
      margin: 10px 0;
      position:relative;
    }
    @media (prefers-color-scheme: light){
      .eq{background: rgba(16,20,39,0.05);}
    }

    .copyRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:8px;
    }
    button.copyBtn{
      appearance:none;
      border:none;
      cursor:pointer;
      padding: 9px 12px;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(124,240,197,0.14);
      color: var(--text);
      font-weight:700;
      transition: transform .12s ease, background .12s ease;
    }
    button.copyBtn:hover{transform: translateY(-1px); background: rgba(124,240,197,0.20);}
    button.copyBtn:active{transform: translateY(0px);}
    .toast{
      display:inline-block;
      padding: 7px 10px;
      border-radius: 999px;
      border:1px solid var(--line);
      background: rgba(154,167,255,0.12);
      color: var(--text);
      font-size: 0.9rem;
      opacity:0;
      transform: translateY(6px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform: translateY(0px);}

    figure{
      margin:0;
      border-radius: var(--radius);
      overflow:hidden;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.10);
    }
    @media (prefers-color-scheme: light){
      figure{background: rgba(16,20,39,0.03);}
    }
    figcaption{
      padding: 10px 12px;
      color: var(--faint);
      font-size: 0.92rem;
      border-top:1px solid var(--line);
    }
    canvas{
      width:100%;
      height: 320px;
      display:block;
    }
    .canvasTall{height: 360px;}
    .canvasShort{height: 280px;}

    .controls{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){ .controls{grid-template-columns:1fr;} }

    .controlCard{
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,0.12);
      padding: 12px 12px;
    }
    @media (prefers-color-scheme: light){
      .controlCard{background: rgba(16,20,39,0.03);}
    }
    label{
      display:block;
      font-weight:800;
      color: var(--text);
      margin-bottom: 6px;
      letter-spacing:0.2px;
    }
    .hint{
      color: var(--faint);
      font-size: 0.92rem;
      margin-top: 6px;
    }
    input[type="range"]{
      width:100%;
      accent-color: #7cf0c5;
    }
    .readout{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      margin-top:6px;
      color: var(--muted);
      font-size: 0.98rem;
    }
    .readout b{color: var(--text);}
    .miniTable{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      margin-top:8px;
      font-size:0.95rem;
    }
    .miniTable th, .miniTable td{
      padding:8px 10px;
      border-bottom:1px solid var(--line);
      text-align:left;
      color: var(--muted);
    }
    .miniTable th{color: var(--text); background: rgba(154,167,255,0.10);}
    .miniTable tr:last-child td{border-bottom:none;}

    .finalBox{
      border-radius: 18px;
      border: 1px solid rgba(124,240,197,0.35);
      background: linear-gradient(180deg, rgba(124,240,197,0.14), rgba(124,240,197,0.06));
      padding: 14px 12px;
    }
    .finalBox h4{
      margin:0 0 8px;
      display:flex;
      align-items:center;
      gap:10px;
      color: var(--text);
    }

    .printNote{
      margin-top:10px;
      color: var(--faint);
      font-size:0.92rem;
    }

    footer{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 18px 36px;
      color: var(--faint);
      font-size: 0.92rem;
    }

    @media print{
      body{background:#fff}
      nav.toc{display:none}
      section.card, .metaCard{box-shadow:none}
      canvas{height:260px !important}
      button.copyBtn{display:none}
      .toast{display:none}
    }

    /* subtle entrance */
    .fadeIn{
      animation: fadeInUp .55s ease both;
    }
    @keyframes fadeInUp{
      from{opacity:0; transform: translateY(8px)}
      to{opacity:1; transform: translateY(0)}
    }
  </style>
</head>

<body>
  <header class="fadeIn">
    <div class="titleWrap">
      <div>
        <h1>Photon-Number Statistics for Multimode Thermal Light in a Cavity</h1>
        <p class="subtitle">
          We derive how the <b>variance</b> of the <b>total photon number</b> changes when thermal radiation occupies
          <b>M independent cavity modes</b>, and why adding modes “averages down” the noise compared to single-mode thermal light.
        </p>
      </div>
      <div class="metaCard">
        <div class="metaGrid">
          <div class="metaItem">
            <b>System</b>
            <span>Cavity with M thermal modes</span>
          </div>
          <div class="metaItem">
            <b>Statistics</b>
            <span>Bose–Einstein (geometric)</span>
          </div>
          <div class="metaItem">
            <b>Key output</b>
            <span>Var(total) vs Mean(total)</span>
          </div>
          <div class="metaItem">
            <b>Noise intuition</b>
            <span>More modes → less relative noise</span>
          </div>
        </div>
        <div class="pillRow">
          <span class="pill">Independence of modes</span>
          <span class="pill alt">Sum of random variables</span>
          <span class="pill warn">Thermal bunching</span>
        </div>
      </div>
    </div>
  </header>

  <main class="fadeIn">
    <nav class="toc" aria-label="Table of contents">
      <h2>On this page</h2>
      <a href="#quick" data-scroll>Quick Summary</a>
      <a href="#part0" data-scroll>PART 0 — Concept Primer</a>
      <a href="#part1" data-scroll>PART 1 — Problem Analysis</a>
      <a href="#part2" data-scroll>PART 2 — Strategy & Tips</a>
      <a href="#part3" data-scroll>PART 3 — Full Solution</a>
      <a href="#part4" data-scroll>PART 4 — Deeper Understanding</a>
      <a href="#part5" data-scroll>PART 5 — Visualization Guide</a>
      <a href="#viz" data-scroll>Interactive Visualizations</a>
    </nav>

    <article>
      <section id="quick" class="card">
        <h2>Quick Summary</h2>
        <ul>
          <li><b>What this is about:</b> photon-number fluctuations of <b>thermal light</b> spread across <b>M modes</b> in a cavity.</li>
          <li><b>Key physics idea:</b> each mode has <b>Bose–Einstein</b> (geometric) statistics; independent modes add like independent random variables.</li>
          <li><b>Per-mode mean photon number:</b> <span class="eq" style="margin:6px 0;">n̄ = 1 / (exp(hν/kT) − 1)</span></li>
          <li><b>Per-mode variance (thermal):</b> <span class="eq" style="margin:6px 0;">Var(n_i) = n̄ + n̄²</span></li>
          <li><b>Total photons:</b> <span class="eq" style="margin:6px 0;">n = Σ_{i=1..M} n_i</span></li>
          <li><b>Final symbolic result:</b> <span class="eq" style="margin:6px 0;">Var(n) = ⟨n⟩ + ⟨n⟩² / M</span></li>
          <li><b>Interpretation:</b> multimode thermal light has <b>less excess noise</b> than single-mode thermal light at the same mean total photon number.</li>
        </ul>

        <div class="grid2">
          <div class="callout">
            <h4><span class="badge">≡</span> Key equation to copy</h4>
            <div class="eq" id="eqKey">Var(n) = ⟨n⟩ + ⟨n⟩² / M</div>
            <div class="copyRow">
              <button class="copyBtn" data-copy="#eqKey">Copy equation</button>
              <span class="toast" id="toast1">Copied!</span>
            </div>
          </div>

          <div class="finalBox">
            <h4><span class="badge">✓</span> Final Answer (plain text)</h4>
            <div class="eq" id="finalAnswerText">For M independent thermal modes with identical mean per mode n̄, the total photon number n = Σ n_i has mean ⟨n⟩ = M n̄ and variance Var(n) = M(n̄ + n̄²) = ⟨n⟩ + ⟨n⟩² / M.</div>
            <div class="copyRow">
              <button class="copyBtn" data-copy="#finalAnswerText">Copy final answer</button>
              <span class="toast" id="toast2">Copied!</span>
            </div>
          </div>
        </div>
      </section>

      <section id="part0" class="card">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <h3>Core definitions (symbols & units)</h3>
        <ul>
          <li><b>Photon number</b> in a mode: <b>n</b> (dimensionless integer: 0,1,2,...).</li>
          <li><b>Mean photon number</b>: <b>⟨n⟩</b> (dimensionless).</li>
          <li><b>Variance</b>: <b>Var(n) = σ² = ⟨(n − ⟨n⟩)²⟩</b> (dimensionless², but effectively dimensionless).</li>
          <li><b>Frequency</b>: <b>ν</b> (Hz). Photon energy <b>hν</b> (J).</li>
          <li><b>Temperature</b>: <b>T</b> (K). Thermal energy scale <b>kT</b> (J).</li>
          <li><b>Number of modes</b>: <b>M</b> (dimensionless count of independent modes).</li>
        </ul>

        <h3>Physical meaning of key quantities</h3>
        <div class="grid2">
          <div class="callout">
            <h4><span class="badge">◎</span> Mean photon number ⟨n⟩</h4>
            <p>
              The average occupancy of a given electromagnetic mode. In thermal equilibrium, low-frequency modes
              (small hν/kT) have larger ⟨n⟩, while high-frequency modes have ⟨n⟩ ≈ 0.
            </p>
          </div>
          <div class="callout">
            <h4><span class="badge">◎</span> Variance Var(n)</h4>
            <p>
              Measures how “noisy” the photon count is. Thermal light is <b>super-Poissonian</b>:
              its variance exceeds its mean due to <b>bunching</b> (correlations in arrival times).
            </p>
          </div>
        </div>

        <h3>Key laws/principles & validity</h3>
        <ul>
          <li><b>Bose–Einstein statistics</b> for photons in thermal equilibrium (chemical potential μ = 0):
            <span class="eq">n̄ = 1 / (exp(hν/kT) − 1)</span>
            Valid when the field is in equilibrium at temperature T (or well-modeled as such) and the mode is approximately harmonic.
          </li>
          <li><b>Independent modes add:</b> if modes are statistically independent, then for
            <span class="eq">n = Σ n_i</span>
            we have <span class="eq">Var(n) = Σ Var(n_i)</span>.
          </li>
        </ul>

        <h3>Common models/approximations (why we use them)</h3>
        <div class="callout">
          <h4><span class="badge warn">!</span> Mode independence + identical mean</h4>
          <ul>
            <li>We assume the M modes are close in frequency so each has the <b>same</b> mean occupancy n̄.</li>
            <li>We assume they are distinct, orthogonal cavity modes with no coupling → <b>independent</b> photon-number fluctuations.</li>
            <li>This lets us reduce the problem to a clean statistics identity: “sum of i.i.d. thermal mode occupancies.”</li>
          </ul>
        </div>

        <h3>Mini intuition examples (quick conceptual)</h3>
        <ul>
          <li><b>Single-mode thermal light:</b> at fixed mean ⟨n⟩, the variance is large: Var(n)=⟨n⟩+⟨n⟩² → strong bunching.</li>
          <li><b>Many modes:</b> the same total mean photons spread across many independent modes reduces the <i>excess</i> variance; relative noise shrinks.</li>
        </ul>

        <h3>What to watch for (pitfalls & misconceptions)</h3>
        <ul>
          <li><b>Confusing Poisson with thermal:</b> Poisson has Var=Mean; thermal has Var=Mean+Mean² (per mode).</li>
          <li><b>Forgetting independence:</b> Var(Σ n_i) = Σ Var(n_i) only if cross-covariances vanish.</li>
          <li><b>Mixing “per-mode mean” and “total mean”:</b> be explicit whether ⟨n⟩ refers to a mode or the sum.</li>
        </ul>
      </section>

      <section id="part1" class="card">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <h3>Restating the problem in plain language</h3>
        <p>
          We have <b>M cavity modes</b> of thermal radiation, close in frequency so each mode can be treated as having the
          <b>same Bose–Einstein mean photon number</b> <b>n̄</b>. Let <b>n</b> be the <b>total photon number</b> across all modes.
          Show how <b>Var(n)</b> relates to <b>⟨n⟩</b>, and conclude that multimode thermal light is less noisy than single-mode thermal light.
        </p>

        <div class="grid2">
          <div class="callout">
            <h4><span class="badge">G</span> Given</h4>
            <ul>
              <li>M modes, each thermal (Bose–Einstein) at temperature T.</li>
              <li>Same mean per mode:
                <span class="eq">n̄ = 1/(exp(hν/kT) − 1)</span>
              </li>
              <li>Total photon number:
                <span class="eq">n = Σ_{i=1..M} n_i</span>
              </li>
            </ul>
          </div>
          <div class="callout">
            <h4><span class="badge">?</span> Unknowns / what to prove</h4>
            <ul>
              <li>Express <b>Var(n)</b> in terms of <b>⟨n⟩</b> and <b>M</b>.</li>
              <li>Show:
                <span class="eq">Var(n) = ⟨n⟩ + ⟨n⟩² / M</span>
              </li>
              <li>Interpret why increasing M reduces noise compared with M=1.</li>
            </ul>
          </div>
        </div>

        <h3>Relevant principles and why they apply</h3>
        <ul>
          <li><b>Thermal mode statistics:</b> each mode is a harmonic oscillator in thermal equilibrium → photon number is geometric (Bose–Einstein) distributed.</li>
          <li><b>Additivity of mean and variance for independent modes:</b> cavity modes are orthogonal degrees of freedom; under the model they fluctuate independently.</li>
        </ul>
        <p class="printNote">
          Why not other laws? We do not need wave optics, field correlations in time, or detector models—this is a pure photon-number statistics exercise.
        </p>

        <div class="callout">
          <h4><span class="badge warn">A</span> Assumptions (explicit)</h4>
          <ul>
            <li>Modes are <b>independent</b>: Cov(n_i, n_j)=0 for i≠j.</li>
            <li>Modes are sufficiently close in frequency that each has the <b>same mean</b> n̄.</li>
            <li>Thermal equilibrium (or an equivalent thermal state) with μ=0 (photons not conserved).</li>
          </ul>
        </div>

        <h3>Possible approaches (compare 2–3)</h3>
        <ul>
          <li><b>Approach 1 (best):</b> Use known thermal (geometric) distribution moments: Var(n_i)=n̄+n̄², then sum variances. Fast and transparent.</li>
          <li><b>Approach 2:</b> Use the partition function of a harmonic oscillator to compute ⟨n⟩ and ⟨n²⟩, then derive variance and sum. More “stat mech” heavy but fundamental.</li>
          <li><b>Approach 3:</b> Use generating functions: probability-generating function for geometric distribution; total is negative binomial; extract moments. Elegant and general.</li>
        </ul>

        <p>
          <b>We choose Approach 1</b> because it is shortest while still teaching the key physical/statistical idea:
          thermal variance has an extra n̄² term, and independent modes average that excess down by 1/M when expressed in terms of total mean.
        </p>
      </section>

      <section id="part2" class="card">
        <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

        <ol style="margin:10px 0 10px 20px; color: var(--muted);">
          <li><b>Goal:</b> write total photons as a sum <span class="eq" style="margin:6px 0;">n = Σ n_i</span>
              <br/><b>Tool:</b> definition of total photon number.
              <br/><b>Meaning:</b> total photons come from contributions of M modes.
          </li>
          <li><b>Goal:</b> recall mean per mode <span class="eq" style="margin:6px 0;">⟨n_i⟩ = n̄</span>
              <br/><b>Tool:</b> Bose–Einstein occupancy formula (given).
              <br/><b>Meaning:</b> each mode has the same average occupancy.
          </li>
          <li><b>Goal:</b> write variance per mode for thermal light:
              <span class="eq" style="margin:6px 0;">Var(n_i) = n̄ + n̄²</span>
              <br/><b>Tool:</b> known moment of geometric distribution (or derive quickly from a standard identity).
              <br/><b>Meaning:</b> thermal light has “excess noise” beyond Poisson.
          </li>
          <li><b>Goal:</b> compute total mean:
              <span class="eq" style="margin:6px 0;">⟨n⟩ = Σ ⟨n_i⟩ = M n̄</span>
              <br/><b>Tool:</b> linearity of expectation.
              <br/><b>Meaning:</b> total average scales with number of modes.
          </li>
          <li><b>Goal:</b> compute total variance:
              <span class="eq" style="margin:6px 0;">Var(n) = Σ Var(n_i)</span>
              <br/><b>Tool:</b> independence (zero covariances).
              <br/><b>Meaning:</b> independent fluctuations add in variance.
          </li>
          <li><b>Goal:</b> eliminate n̄ in favor of ⟨n⟩:
              <span class="eq" style="margin:6px 0;">n̄ = ⟨n⟩/M</span>
              <br/><b>Tool:</b> substitution.
              <br/><b>Meaning:</b> expresses noise in terms of observable total mean and M.
          </li>
          <li><b>Goal:</b> sanity-check limits (M=1 and large M) and interpret.</li>
        </ol>

        <div class="grid2">
          <div class="callout">
            <h4><span class="badge danger">×</span> Common mistakes</h4>
            <ul>
              <li>Using Var(n_i)=n̄ (Poisson) instead of thermal Var(n_i)=n̄+n̄².</li>
              <li>Forgetting covariance terms when modes are not independent.</li>
              <li>Mixing the symbol n̄ (per mode) with ⟨n⟩ (total).</li>
            </ul>
          </div>
          <div class="callout">
            <h4><span class="badge">✓</span> Quick tips</h4>
            <ul>
              <li>Write everything first in terms of n̄, then convert to ⟨n⟩ at the end.</li>
              <li>Check M=1: you should recover single-mode thermal variance.</li>
              <li>Check large M: the “excess” part should shrink like 1/M.</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="part3" class="card">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Physical intuition (before math)</h3>
        <p>
          A single thermal mode exhibits strong photon bunching: once the mode happens to have many photons,
          it tends to keep fluctuating widely (large variance). If instead the same total energy is spread across
          many independent modes, then the total is a sum of many independent random contributions. Sums “smooth out”
          fluctuations: the <i>relative</i> noise should decrease as M increases. We expect a variance that still has a Poisson-like term (∝⟨n⟩)
          plus an “excess” term that is reduced by mode averaging.
        </p>

        <h3>Step 1: Define the per-mode photon number and its mean</h3>
        <p>
          Let <b>n_i</b> be the photon number in mode <b>i</b>, for i = 1,…,M. The problem states each mode is thermal at temperature T,
          and sufficiently close in frequency that each has the same mean photon number
        </p>
        <div class="eq" id="eq1">⟨n_i⟩ = n̄ = 1 / (exp(hν/kT) − 1).</div>
        <div class="copyRow">
          <button class="copyBtn" data-copy="#eq1">Copy</button>
          <span class="toast" id="toast3">Copied!</span>
        </div>
        <p>
          <b>Meaning:</b> n̄ is the average occupancy of one mode at frequency ν in thermal equilibrium.
        </p>

        <h3>Step 2: Thermal (Bose–Einstein) variance for one mode</h3>
        <p>
          For a single thermal mode, the photon-number distribution is geometric:
          <span class="eq">P(n_i = n) = (1/(1+n̄)) (n̄/(1+n̄))^n,  n=0,1,2,...</span>
          A standard result for this distribution is:
        </p>
        <div class="eq" id="eq2">Var(n_i) = ⟨(n_i − ⟨n_i⟩)²⟩ = n̄ + n̄².</div>
        <div class="copyRow">
          <button class="copyBtn" data-copy="#eq2">Copy</button>
          <span class="toast" id="toast4">Copied!</span>
        </div>
        <p>
          <b>What we did and why:</b> We used the known moments of the thermal (geometric) photon statistics.
          The extra term <b>n̄²</b> is the hallmark of thermal bunching: fluctuations grow quadratically with the mean.
        </p>

        <h3>Step 3: Define total photon number and compute its mean</h3>
        <p>
          The total photon number across all modes is
        </p>
        <div class="eq" id="eq3">n = Σ_{i=1..M} n_i.</div>
        <p>
          Taking the mean and using linearity of expectation:
        </p>
        <div class="eq" id="eq4">⟨n⟩ = ⟨Σ n_i⟩ = Σ ⟨n_i⟩ = Σ n̄ = M n̄.</div>
        <p>
          <b>Meaning:</b> total average photon number grows linearly with the number of occupied modes.
        </p>

        <h3>Step 4: Compute total variance using independence</h3>
        <p>
          For any sum, the exact identity is
        </p>
        <div class="eq">Var(Σ n_i) = Σ Var(n_i) + 2 Σ_{i&lt;j} Cov(n_i, n_j).</div>
        <p>
          Under the stated assumption that the M cavity modes fluctuate independently,
          <span class="eq">Cov(n_i, n_j)=0</span> for i≠j. Therefore:
        </p>
        <div class="eq" id="eq5">Var(n) = Var(Σ n_i) = Σ Var(n_i) = M (n̄ + n̄²).</div>
        <p>
          <b>What we did and why:</b> independence lets us add variances directly (no covariance corrections).
        </p>

        <h3>Step 5: Express the result in terms of the total mean ⟨n⟩</h3>
        <p>
          We want a relation between Var(n) and ⟨n⟩ (the mean of the total). From ⟨n⟩ = M n̄ we have:
          <span class="eq">n̄ = ⟨n⟩/M</span>.
          Substitute into Var(n) = M(n̄ + n̄²):
        </p>

        <div class="eq" id="eq6">Var(n) = M(⟨n⟩/M + (⟨n⟩/M)²)
       = ⟨n⟩ + ⟨n⟩² / M.</div>

        <div class="finalBox" style="margin-top:12px;">
          <h4><span class="badge">★</span> Boxed final result</h4>
          <div class="eq" id="eqFinal">σ_n² = Var(n) = ⟨n⟩ + ⟨n⟩² / M.</div>
          <div class="copyRow">
            <button class="copyBtn" data-copy="#eqFinal">Copy boxed result</button>
            <span class="toast" id="toast5">Copied!</span>
          </div>
        </div>

        <h3>Sanity checks</h3>
        <div class="grid2">
          <div class="callout">
            <h4><span class="badge">1</span> Units / dimensions</h4>
            <p>
              Photon numbers are dimensionless counts, so ⟨n⟩ and Var(n) are dimensionless. The formula combines dimensionless terms
              ⟨n⟩ and ⟨n⟩²/M (also dimensionless) → consistent.
            </p>
          </div>
          <div class="callout">
            <h4><span class="badge">2</span> Limiting cases</h4>
            <ul>
              <li><b>M = 1:</b> Var(n)=⟨n⟩+⟨n⟩² → single-mode thermal result.</li>
              <li><b>M → ∞</b> at fixed ⟨n⟩: Var(n)→⟨n⟩ → approaches Poisson-like scaling (excess noise vanishes).</li>
            </ul>
          </div>
        </div>

        <h3>Physical interpretation (plain language)</h3>
        <p>
          The variance has two parts:
          <b>⟨n⟩</b> behaves like shot noise (Poisson-like), while <b>⟨n⟩²/M</b> is the thermal “bunching” excess.
          Increasing the number of independent modes divides that excess by M—this is the statistical averaging that makes
          multimode thermal light less noisy than single-mode thermal light at the same total mean.
        </p>

        <p>
          Connection to the plots below: the main plot draws Var(n) vs ⟨n⟩ for the chosen M, showing how the curve approaches the Poisson line
          Var=⟨n⟩ as M increases. The secondary plot shows the <b>Fano factor</b> (Var/Mean), which quantifies “how super-Poissonian” the light is.
        </p>
      </section>

      <section id="part4" class="card">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpreting the final formula term-by-term</h3>
        <div class="callout">
          <h4><span class="badge">↯</span> What controls what?</h4>
          <ul>
            <li><b>⟨n⟩ term:</b> baseline counting noise that grows linearly with brightness.</li>
            <li><b>⟨n⟩²/M term:</b> thermal bunching (excess fluctuations) that grows quadratically with brightness, but is <b>suppressed by 1/M</b>.</li>
            <li><b>M:</b> “number of independent averages.” More modes → smaller fractional contribution of bunching to total variance.</li>
          </ul>
        </div>

        <h3>How changing parameters affects the outcome (connect to interactivity)</h3>
        <ul>
          <li>Increase <b>M</b> (slider): the Var vs Mean curve drops toward the Poisson line, especially at larger ⟨n⟩ where ⟨n⟩²/M dominates.</li>
          <li>At fixed M, increasing ⟨n⟩ makes the gap between thermal and Poisson grow like ⟨n⟩²/M.</li>
          <li>The Fano factor <span class="eq" style="margin:6px 0;">F = Var(n)/⟨n⟩ = 1 + ⟨n⟩/M</span> increases linearly with ⟨n⟩, but with slope reduced by 1/M.</li>
        </ul>

        <h3>An alternative derivation idea (brief)</h3>
        <p>
          The sum of M independent geometric random variables is a <b>negative binomial</b> distribution.
          You can write the probability-generating function for one mode, raise it to the Mth power for the sum,
          and then compute the first two derivatives at 1 to obtain the mean and variance—leading again to
          Var(n) = ⟨n⟩ + ⟨n⟩²/M.
        </p>

        <h3>Concept check (self-test)</h3>
        <ul>
          <li><b>Q:</b> If M doubles while ⟨n⟩ stays fixed, what happens to the excess variance? <b>A:</b> ⟨n⟩²/M halves.</li>
          <li><b>Q:</b> For M→∞ at fixed per-mode n̄, does Var(n) approach ⟨n⟩? <b>A:</b> No—because ⟨n⟩=M n̄ also grows; the excess term remains large in absolute size. The Poisson-like limit holds for fixed ⟨n⟩.</li>
          <li><b>Q:</b> Is thermal light ever sub-Poissonian? <b>A:</b> No; Var(n) ≥ ⟨n⟩ for thermal states.</li>
          <li><b>Q:</b> What assumption is critical for Var(n)=Σ Var(n_i)? <b>A:</b> Independence (zero covariance) between modes.</li>
        </ul>
      </section>

      <section id="part5" class="card">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>
        <div class="grid2">
          <div class="callout">
            <h4><span class="badge">①</span> Diagram canvas</h4>
            <p>
              Shows a stylized cavity and <b>M independent modes</b> contributing photon numbers n₁,…,n_M to the total n.
              It emphasizes that the total is a <b>sum over modes</b>.
            </p>
          </div>
          <div class="callout">
            <h4><span class="badge">②</span> Main plot</h4>
            <p>
              Plots <b>Var(n)</b> versus <b>⟨n⟩</b> using the derived law:
              <span class="eq" style="margin:6px 0;">Var(n)=⟨n⟩+⟨n⟩²/M</span>
              The Poisson reference line Var=⟨n⟩ is included for comparison.
            </p>
          </div>
        </div>

        <div class="grid2">
          <div class="callout">
            <h4><span class="badge">③</span> Secondary plot</h4>
            <p>
              Plots the <b>Fano factor</b> <span class="eq" style="margin:6px 0;">F = Var(n)/⟨n⟩ = 1 + ⟨n⟩/M</span>
              which equals 1 for Poisson and exceeds 1 for thermal light. Increasing M reduces the slope.
            </p>
          </div>
          <div class="callout">
            <h4><span class="badge">⛭</span> Interactive control</h4>
            <p>
              The slider changes <b>M</b> live. As M increases, both plots update:
              the variance curve moves downward toward Poisson, and the Fano factor curve flattens (less excess noise).
            </p>
          </div>
        </div>
      </section>

      <section id="viz" class="card">
        <h2>Interactive Visualizations</h2>

        <div class="controls">
          <div class="controlCard">
            <label for="mSlider">Number of modes, M</label>
            <input id="mSlider" type="range" min="1" max="50" step="1" value="5" />
            <div class="readout">
              <span>Current value:</span>
              <b id="mReadout">5</b>
            </div>
            <div class="hint">
              Use this to see how “mode averaging” reduces the excess thermal noise term ⟨n⟩²/M.
              (Plots use <b>example values</b> for ⟨n⟩ range to visualize the formula.)
            </div>

            <table class="miniTable" aria-label="Derived relations">
              <thead>
                <tr><th>Quantity</th><th>Formula</th></tr>
              </thead>
              <tbody>
                <tr><td>Total mean</td><td style="font-family:var(--mono); color:var(--text);">⟨n⟩ = M n̄</td></tr>
                <tr><td>Total variance</td><td style="font-family:var(--mono); color:var(--text);">Var(n) = ⟨n⟩ + ⟨n⟩²/M</td></tr>
                <tr><td>Fano factor</td><td style="font-family:var(--mono); color:var(--text);">F = 1 + ⟨n⟩/M</td></tr>
              </tbody>
            </table>
          </div>

          <div class="controlCard">
            <label>What you should notice</label>
            <ul style="margin:8px 0 0 18px;">
              <li>At low ⟨n⟩, Var(n) ≈ ⟨n⟩ for any M.</li>
              <li>At higher ⟨n⟩, the excess term dominates unless M is large.</li>
              <li>Fano factor starts at 1 and grows linearly with ⟨n⟩, with slope 1/M.</li>
            </ul>
          </div>
        </div>

        <div class="grid2" style="margin-top:12px;">
          <figure>
            <canvas id="diagCanvas" class="canvasShort" aria-label="Cavity modes diagram"></canvas>
            <figcaption>
              Labeled diagram: a cavity supporting M thermal modes whose photon numbers add to a total n.
            </figcaption>
          </figure>

          <figure>
            <canvas id="mainPlot" class="canvasTall" aria-label="Variance vs mean plot"></canvas>
            <figcaption>
              Main plot: Var(n) vs ⟨n⟩. Compare multimode thermal (selected M) to the Poisson reference Var=⟨n⟩.
            </figcaption>
          </figure>
        </div>

        <figure style="margin-top:12px;">
          <canvas id="secondaryPlot" class="canvasTall" aria-label="Fano factor plot"></canvas>
          <figcaption>
            Secondary plot: Fano factor F = Var(n)/⟨n⟩ = 1 + ⟨n⟩/M. Thermal light is super-Poissonian (F&gt;1); larger M reduces excess noise.
          </figcaption>
        </figure>
      </section>
    </article>
  </main>

  <footer>
    <div class="callout" style="max-width:1200px; margin:0 auto;">
      <h4><span class="badge">ℹ</span> Note on “example values”</h4>
      <p style="margin:6px 0 0;">
        The derivation is fully symbolic. The plots sweep a chosen range of <b>⟨n⟩</b> (dimensionless mean photon number) to visualize the relationship.
        No specific ν or T is required to prove the result.
      </p>
    </div>
  </footer>

<script>
/* ---------- Smooth scroll for TOC ---------- */
document.querySelectorAll('[data-scroll]').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    const id = a.getAttribute('href');
    const el = document.querySelector(id);
    if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
  });
});

/* ---------- Copy buttons ---------- */
function showToast(toastEl){
  toastEl.classList.add('show');
  setTimeout(()=>toastEl.classList.remove('show'), 900);
}
async function copyFromSelector(sel, toastId){
  const el = document.querySelector(sel);
  const toast = document.getElementById(toastId);
  if(!el || !navigator.clipboard) return;
  const text = el.innerText.replace(/\u00A0/g,' ');
  try{
    await navigator.clipboard.writeText(text);
    if(toast) showToast(toast);
  }catch(err){
    // fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand('copy'); if(toast) showToast(toast); }catch(e){}
    document.body.removeChild(ta);
  }
}
document.querySelectorAll('button.copyBtn').forEach((btn, idx)=>{
  btn.addEventListener('click', ()=>{
    const sel = btn.getAttribute('data-copy');
    // map toasts by nearby known ids (simple heuristic)
    const known = ["toast1","toast2","toast3","toast4","toast5"];
    const tId = known[Math.min(idx, known.length-1)];
    copyFromSelector(sel, tId);
  });
});

/* ---------- HiDPI canvas helpers ---------- */
function setupCanvas(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(2, Math.floor(rect.width * dpr));
  const h = Math.max(2, Math.floor(rect.height * dpr));
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w; canvas.height = h;
  }
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  return {ctx, w: rect.width, h: rect.height, dpr};
}
function clear(ctx, w, h){
  ctx.clearRect(0,0,w,h);
}

/* ---------- Simple drawing primitives ---------- */
function roundRect(ctx, x,y,w,h,r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}
function drawArrow(ctx, x1,y1,x2,y2, head=8){
  const dx = x2-x1, dy = y2-y1;
  const ang = Math.atan2(dy, dx);
  ctx.beginPath();
  ctx.moveTo(x1,y1); ctx.lineTo(x2,y2);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x2,y2);
  ctx.lineTo(x2 - head*Math.cos(ang) + head*0.45*Math.sin(ang), y2 - head*Math.sin(ang) - head*0.45*Math.cos(ang));
  ctx.lineTo(x2 - head*Math.cos(ang) - head*0.45*Math.sin(ang), y2 - head*Math.sin(ang) + head*0.45*Math.cos(ang));
  ctx.closePath();
  ctx.fill();
}
function gridAxes(ctx, x0,y0, w,h, xMin,xMax,yMin,yMax, xLabel, yLabel, title, tickCount=6){
  // background
  ctx.save();
  ctx.fillStyle = 'rgba(0,0,0,0.08)';
  roundRect(ctx, x0,y0,w,h,14);
  ctx.fill();
  ctx.strokeStyle = 'rgba(255,255,255,0.12)';
  ctx.lineWidth = 1;
  roundRect(ctx, x0,y0,w,h,14);
  ctx.stroke();

  // title
  ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--text').trim() || '#fff';
  ctx.font = '700 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText(title, x0+12, y0+20);

  // plot area
  const padL=52, padR=14, padT=34, padB=44;
  const px0 = x0+padL, py0 = y0+padT;
  const pw = w - padL - padR, ph = h - padT - padB;

  // gridlines + ticks
  ctx.strokeStyle = 'rgba(255,255,255,0.10)';
  ctx.lineWidth = 1;

  function xMap(x){ return px0 + (x - xMin) * pw / (xMax - xMin); }
  function yMap(y){ return py0 + ph - (y - yMin) * ph / (yMax - yMin); }

  // vertical grid
  for(let i=0;i<=tickCount;i++){
    const t = i/tickCount;
    const x = px0 + t*pw;
    ctx.beginPath(); ctx.moveTo(x, py0); ctx.lineTo(x, py0+ph); ctx.stroke();
  }
  // horizontal grid
  for(let i=0;i<=tickCount;i++){
    const t = i/tickCount;
    const y = py0 + t*ph;
    ctx.beginPath(); ctx.moveTo(px0, y); ctx.lineTo(px0+pw, y); ctx.stroke();
  }

  // axes
  ctx.strokeStyle = 'rgba(255,255,255,0.22)';
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.moveTo(px0, py0+ph); ctx.lineTo(px0+pw, py0+ph);
  ctx.moveTo(px0, py0); ctx.lineTo(px0, py0+ph);
  ctx.stroke();

  // tick labels
  ctx.fillStyle = 'rgba(232,240,255,0.85)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

  for(let i=0;i<=tickCount;i++){
    const t = i/tickCount;
    const xv = xMin + t*(xMax-xMin);
    const x = px0 + t*pw;
    const s = (Math.abs(xv) < 1e-10) ? '0' : (xv.toFixed(0));
    ctx.fillText(s, x-6, py0+ph+18);
  }
  for(let i=0;i<=tickCount;i++){
    const t = i/tickCount;
    const yv = yMin + (1-t)*(yMax-yMin);
    const y = py0 + t*ph;
    const s = (Math.abs(yv) < 1e-10) ? '0' : (yv.toFixed(0));
    ctx.fillText(s, px0-36, y+4);
  }

  // axis labels
  ctx.fillStyle = getComputedStyle(document.body).getPropertyValue('--muted').trim() || '#b8c3e6';
  ctx.font = '700 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText(xLabel, px0 + pw/2 - ctx.measureText(xLabel).width/2, y0 + h - 14);

  // y label (rotated)
  ctx.save();
  ctx.translate(x0+16, py0 + ph/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
  ctx.restore();

  ctx.restore();
  return {xMap,yMap, px0,py0,pw,ph, padL, padR, padT, padB};
}

function drawLegend(ctx, x, y, items){
  ctx.save();
  const textColor = getComputedStyle(document.body).getPropertyValue('--muted').trim() || '#b8c3e6';
  ctx.font = '12.5px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  let maxW=0;
  items.forEach(it=> maxW = Math.max(maxW, ctx.measureText(it.label).width));
  const boxW = 18 + 10 + maxW + 18;
  const boxH = 10 + items.length*18 + 8;
  ctx.fillStyle = 'rgba(0,0,0,0.18)';
  ctx.strokeStyle = 'rgba(255,255,255,0.12)';
  roundRect(ctx, x, y, boxW, boxH, 12);
  ctx.fill(); ctx.stroke();
  items.forEach((it, i)=>{
    const yy = y + 18 + i*18;
    ctx.strokeStyle = it.stroke;
    ctx.lineWidth = 2.4;
    ctx.beginPath(); ctx.moveTo(x+12, yy-4); ctx.lineTo(x+30, yy-4); ctx.stroke();
    if(it.dash){
      ctx.setLineDash(it.dash);
      ctx.beginPath(); ctx.moveTo(x+12, yy-4); ctx.lineTo(x+30, yy-4); ctx.stroke();
      ctx.setLineDash([]);
    }
    ctx.fillStyle = textColor;
    ctx.fillText(it.label, x+38, yy);
  });
  ctx.restore();
}

/* ---------- Model functions ---------- */
function varThermal(meanTotal, M){
  return meanTotal + (meanTotal*meanTotal)/M;
}
function fano(meanTotal, M){
  return 1 + meanTotal/M;
}

/* ---------- Draw: Diagram ---------- */
function drawDiagram(M){
  const canvas = document.getElementById('diagCanvas');
  const {ctx, w, h} = setupCanvas(canvas);
  clear(ctx, w, h);

  const text = getComputedStyle(document.body).getPropertyValue('--text').trim() || '#fff';
  const muted = getComputedStyle(document.body).getPropertyValue('--muted').trim() || '#b8c3e6';
  const line = 'rgba(255,255,255,0.14)';
  const accent = getComputedStyle(document.body).getPropertyValue('--accent').trim() || '#7cf0c5';
  const accent2 = getComputedStyle(document.body).getPropertyValue('--accent2').trim() || '#9aa7ff';

  // card background
  ctx.fillStyle = 'rgba(0,0,0,0.06)';
  roundRect(ctx, 10, 10, w-20, h-20, 18);
  ctx.fill();
  ctx.strokeStyle = line;
  ctx.lineWidth = 1;
  roundRect(ctx, 10, 10, w-20, h-20, 18);
  ctx.stroke();

  // cavity box
  const cx = 26, cy = 58, cw = w*0.52, ch = h*0.62;
  ctx.fillStyle = 'rgba(154,167,255,0.08)';
  ctx.strokeStyle = 'rgba(154,167,255,0.28)';
  ctx.lineWidth = 1.4;
  roundRect(ctx, cx, cy, cw, ch, 18);
  ctx.fill(); ctx.stroke();

  // mirrors
  ctx.strokeStyle = 'rgba(255,255,255,0.22)';
  ctx.lineWidth = 4;
  ctx.beginPath(); ctx.moveTo(cx+8, cy+14); ctx.lineTo(cx+8, cy+ch-14); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx+cw-8, cy+14); ctx.lineTo(cx+cw-8, cy+ch-14); ctx.stroke();

  // mode "standing waves"
  const modesToDraw = Math.min(6, M);
  for(let i=0;i<modesToDraw;i++){
    const y = cy + 30 + i*(ch-60)/(Math.max(1,modesToDraw-1));
    ctx.strokeStyle = i%2===0 ? 'rgba(124,240,197,0.65)' : 'rgba(154,167,255,0.65)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    const amp = 10 + 4*(i%2);
    const xStart = cx+18, xEnd = cx+cw-18;
    const N = 50;
    for(let k=0;k<=N;k++){
      const t = k/N;
      const x = xStart + t*(xEnd-xStart);
      const yy = y + amp*Math.sin(2*Math.PI*(i+1)*t);
      if(k===0) ctx.moveTo(x,yy); else ctx.lineTo(x,yy);
    }
    ctx.stroke();
  }

  // sum arrow to "total"
  const tx = cx+cw+28, ty = cy+36;
  ctx.fillStyle = text;
  ctx.font = '700 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText('M thermal modes', cx+18, cy-12);

  ctx.fillStyle = muted;
  ctx.font = '13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText('n₁, n₂, …, n_M fluctuate', cx+18, cy+ch+22);

  // Arrow
  ctx.strokeStyle = accent;
  ctx.fillStyle = accent;
  ctx.lineWidth = 2.2;
  drawArrow(ctx, cx+cw+6, cy+ch/2, tx+20, cy+ch/2, 9);

  // Total box
  const bx = tx+28, by = cy+ch/2 - 42, bw = w - (tx+28) - 26, bh = 84;
  ctx.fillStyle = 'rgba(124,240,197,0.10)';
  ctx.strokeStyle = 'rgba(124,240,197,0.35)';
  ctx.lineWidth = 1.4;
  roundRect(ctx, bx, by, bw, bh, 16);
  ctx.fill(); ctx.stroke();

  ctx.fillStyle = text;
  ctx.font = '800 15px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText('Total photons', bx+14, by+26);

  ctx.fillStyle = muted;
  ctx.font = '13px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
  ctx.fillText('n = Σ n_i', bx+14, by+50);
  ctx.fillText('⟨n⟩ = M n̄', bx+14, by+70);

  // M readout
  ctx.fillStyle = accent2;
  ctx.font = '800 14px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
  ctx.fillText(`M = ${M}`, w-92, 30);
}

/* ---------- Draw: Main plot (Variance vs Mean) ---------- */
function drawMainPlot(M){
  const canvas = document.getElementById('mainPlot');
  const {ctx, w, h} = setupCanvas(canvas);
  clear(ctx, w, h);

  const meanMax = 60; // example sweep
  const xMin=0, xMax=meanMax;

  // yMax depends on M: varThermal(meanMax,M)
  const yMax = Math.max(meanMax, varThermal(meanMax, M)) * 1.05;
  const yMin = 0;

  const title = `Variance vs Mean for Multimode Thermal Light (M = ${M})`;
  const axes = gridAxes(
    ctx, 10, 10, w-20, h-20,
    xMin, xMax, yMin, yMax,
    'Mean total photon number ⟨n⟩ (dimensionless)',
    'Variance Var(n) (dimensionless)',
    title, 6
  );

  const text = getComputedStyle(document.body).getPropertyValue('--text').trim() || '#fff';
  const accent = getComputedStyle(document.body).getPropertyValue('--accent').trim() || '#7cf0c5';
  const muted = getComputedStyle(document.body).getPropertyValue('--muted').trim() || '#b8c3e6';

  // Poisson reference line y=x
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.45)';
  ctx.lineWidth = 2;
  ctx.setLineDash([6,6]);
  ctx.beginPath();
  ctx.moveTo(axes.xMap(0), axes.yMap(0));
  ctx.lineTo(axes.xMap(xMax), axes.yMap(Math.min(yMax, xMax)));
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.restore();

  // Thermal multimode curve
  ctx.save();
  ctx.strokeStyle = accent;
  ctx.lineWidth = 2.6;
  ctx.beginPath();
  const N=220;
  for(let i=0;i<=N;i++){
    const x = xMin + (xMax-xMin)*i/N;
    const y = varThermal(x, M);
    const X = axes.xMap(x), Y = axes.yMap(y);
    if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  }
  ctx.stroke();
  ctx.restore();

  // annotate equation
  ctx.save();
  ctx.fillStyle = muted;
  ctx.font = '700 13px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
  const eq = 'Var(n) = ⟨n⟩ + ⟨n⟩²/M';
  ctx.fillText(eq, 26, h-34);
  ctx.restore();

  // legend
  drawLegend(ctx, 22, 38, [
    {label:'Thermal (multimode)', stroke: accent},
    {label:'Poisson reference', stroke:'rgba(255,255,255,0.45)', dash:[6,6]}
  ]);

  // marker at a representative mean
  const x0 = 30;
  const y0 = varThermal(x0, M);
  ctx.save();
  ctx.fillStyle = text;
  ctx.strokeStyle = 'rgba(0,0,0,0.0)';
  ctx.beginPath();
  ctx.arc(axes.xMap(x0), axes.yMap(y0), 4.5, 0, Math.PI*2);
  ctx.fill();
  ctx.fillStyle = muted;
  ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText(`Example point: ⟨n⟩=${x0.toFixed(0)}, Var≈${y0.toFixed(1)}`, axes.xMap(x0)+10, axes.yMap(y0)-8);
  ctx.restore();
}

/* ---------- Draw: Secondary plot (Fano factor) ---------- */
function drawSecondaryPlot(M){
  const canvas = document.getElementById('secondaryPlot');
  const {ctx, w, h} = setupCanvas(canvas);
  clear(ctx, w, h);

  const meanMax = 60; // same sweep
  const xMin=0, xMax=meanMax;

  // Fano factor from 1 to 1+meanMax/M
  const yMin = 0.9;
  const yMax = (1 + meanMax/Math.max(1,M)) * 1.06;

  const title = `Fano Factor (Super-Poissonian Noise) (M = ${M})`;
  const axes = gridAxes(
    ctx, 10, 10, w-20, h-20,
    xMin, xMax, yMin, yMax,
    'Mean total photon number ⟨n⟩ (dimensionless)',
    'F = Var(n)/⟨n⟩ (dimensionless)',
    title, 6
  );

  const accent2 = getComputedStyle(document.body).getPropertyValue('--accent2').trim() || '#9aa7ff';
  const muted = getComputedStyle(document.body).getPropertyValue('--muted').trim() || '#b8c3e6';

  // Poisson baseline F=1
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.45)';
  ctx.lineWidth = 2;
  ctx.setLineDash([6,6]);
  ctx.beginPath();
  ctx.moveTo(axes.xMap(xMin), axes.yMap(1));
  ctx.lineTo(axes.xMap(xMax), axes.yMap(1));
  ctx.stroke();
  ctx.setLineDash([]);
  ctx.restore();

  // Fano curve
  ctx.save();
  ctx.strokeStyle = accent2;
  ctx.lineWidth = 2.6;
  ctx.beginPath();
  const N=220;
  for(let i=0;i<=N;i++){
    const x = xMin + (xMax-xMin)*i/N;
    const y = (x===0) ? 1 : fano(x, M); // define at 0 as limit -> 1
    const X = axes.xMap(x), Y = axes.yMap(y);
    if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  }
  ctx.stroke();
  ctx.restore();

  // legend
  drawLegend(ctx, 22, 38, [
    {label:'Thermal Fano factor', stroke: accent2},
    {label:'Poisson (F=1)', stroke:'rgba(255,255,255,0.45)', dash:[6,6]}
  ]);

  // annotate
  ctx.save();
  ctx.fillStyle = muted;
  ctx.font = '700 13px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
  ctx.fillText('F = 1 + ⟨n⟩/M', 26, h-34);
  ctx.restore();
}

/* ---------- Update / resize loop ---------- */
let currentM = 5;
function renderAll(){
  drawDiagram(currentM);
  drawMainPlot(currentM);
  drawSecondaryPlot(currentM);
}

const mSlider = document.getElementById('mSlider');
const mReadout = document.getElementById('mReadout');

mSlider.addEventListener('input', ()=>{
  currentM = parseInt(mSlider.value,10);
  mReadout.textContent = currentM;
  renderAll();
});

window.addEventListener('resize', ()=>{
  // Debounce-ish via rAF
  window.requestAnimationFrame(renderAll);
});

// initial
mReadout.textContent = currentM;
renderAll();
</script>
</body>
</html>
