<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Exponential Decay of Mean Photon Number in an Absorber (Beer–Lambert Law + Photon Statistics)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0e1730;
      --text:#e8ecff;
      --muted:#b7c0ff;
      --faint:#7f8ad6;
      --accent:#7cf7c5;
      --accent2:#7db7ff;
      --warn:#ffcc66;
      --danger:#ff6b8a;
      --ok:#79ffa8;
      --border:rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --radius: 18px;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(125,183,255,.18), transparent 60%),
        radial-gradient(900px 650px at 80% 20%, rgba(124,247,197,.14), transparent 55%),
        radial-gradient(800px 600px at 50% 100%, rgba(255,107,138,.12), transparent 55%),
        var(--bg);
      line-height:1.55;
    }

    header{
      padding:28px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }
    header .titleCard{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:22px 22px 18px;
      position:relative;
      overflow:hidden;
    }
    header .titleCard:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 120px at 20% 10%, rgba(124,247,197,.20), transparent 60%),
                  radial-gradient(700px 140px at 90% 0%, rgba(125,183,255,.20), transparent 60%);
      filter: blur(10px);
      opacity:.9;
      pointer-events:none;
    }
    header h1{
      margin:0 0 8px;
      font-size: clamp(1.35rem, 2.2vw, 2.05rem);
      letter-spacing:.2px;
      position:relative;
    }
    header p{
      margin:0;
      color:var(--muted);
      position:relative;
      max-width: 72ch;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 12px 18px 40px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 16px;
      align-items:start;
    }

    nav#toc{
      position:sticky;
      top:14px;
      align-self:start;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px 12px;
    }
    #toc .tocTitle{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    #toc h2{
      font-size:1rem;
      margin:0;
      letter-spacing:.3px;
    }
    #toc .pill{
      font-size:.78rem;
      color:var(--muted);
      border:1px solid var(--border);
      padding:4px 8px;
      border-radius:999px;
      background: rgba(0,0,0,.18);
      white-space:nowrap;
    }
    #toc a{
      display:block;
      padding:8px 10px;
      margin:6px 0;
      border-radius:12px;
      color:var(--text);
      text-decoration:none;
      border:1px solid transparent;
      background: rgba(0,0,0,.10);
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
      font-size:.95rem;
    }
    #toc a:hover{
      transform: translateY(-1px);
      border-color: rgba(125,183,255,.45);
      background: rgba(125,183,255,.10);
    }

    article{
      display:flex;
      flex-direction:column;
      gap: 14px;
      min-width:0;
    }

    section{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      overflow:hidden;
    }

    section h2{
      margin:0 0 10px;
      font-size:1.2rem;
      letter-spacing:.2px;
    }
    section h3{
      margin:14px 0 8px;
      font-size:1.04rem;
      letter-spacing:.2px;
      color: #f0f2ff;
    }
    p{margin:8px 0; color: var(--text)}
    .muted{color:var(--muted)}
    .faint{color:var(--faint)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1.2fr .9fr .9fr;
      gap: 12px;
    }
    .callout{
      border:1px solid var(--border);
      border-radius: 16px;
      padding:12px 12px 10px;
      background: rgba(0,0,0,.18);
    }
    .callout strong{color: #ffffff}
    .callout.assumptions{border-color: rgba(124,247,197,.35)}
    .callout.keyeq{border-color: rgba(125,183,255,.40)}
    .callout.mistakes{border-color: rgba(255,204,102,.45)}
    .callout.answer{border-color: rgba(121,255,168,.45)}
    .badgeRow{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
    }
    .badge{
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
      padding:6px 10px;
      border-radius:999px;
      font-size:.85rem;
      color:var(--muted);
    }

    .eqBox{
      position:relative;
      border:1px solid rgba(125,183,255,.45);
      background: rgba(125,183,255,.10);
      border-radius: 16px;
      padding:12px 12px 10px;
      margin:10px 0;
    }
    .eqBox code{
      font-family: var(--mono);
      font-size: .95rem;
      color: #ffffff;
      display:block;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .copyBtn{
      position:absolute;
      top:10px; right:10px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.25);
      color:var(--text);
      padding:6px 10px;
      border-radius: 999px;
      font-size:.8rem;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .copyBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(124,247,197,.55);
      background: rgba(124,247,197,.10);
    }

    .vizWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .controls{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr 1fr;
      gap: 10px;
      align-items:end;
    }
    .ctrl{
      border:1px solid var(--border);
      border-radius: 16px;
      padding:10px;
      background: rgba(0,0,0,.18);
    }
    .ctrl label{
      display:flex;
      justify-content:space-between;
      gap:8px;
      font-size:.88rem;
      color: var(--muted);
      margin-bottom:6px;
    }
    .ctrl .val{
      font-family: var(--mono);
      color:#ffffff;
      font-size:.9rem;
      white-space:nowrap;
    }
    input[type="range"]{width:100%}

    .canvasCard{
      border:1px solid var(--border);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding: 10px;
      overflow:hidden;
    }
    .canvasTop{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:10px;
      padding: 2px 2px 8px;
    }
    .canvasTop .title{
      font-weight:700;
      letter-spacing:.2px;
    }
    .canvasTop .subtitle{
      font-size:.85rem;
      color: var(--muted);
    }
    canvas{
      width:100%;
      height: 320px;
      display:block;
      border-radius: 12px;
      background: rgba(12,18,40,.35);
      border: 1px solid rgba(255,255,255,.08);
    }
    .smallCanvas canvas{height: 260px;}

    .twoCanv{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }

    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 12px 0;
    }

    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 28px;
      color: var(--muted);
      font-size:.92rem;
    }

    /* subtle animation */
    @keyframes floatIn{
      from{transform: translateY(6px); opacity:0}
      to{transform: translateY(0); opacity:1}
    }
    section{animation: floatIn .22s ease both}

    /* responsive */
    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
      nav#toc{position:relative; top:auto}
      .controls{grid-template-columns: 1fr 1fr}
      .twoCanv{grid-template-columns: 1fr}
    }

    /* print-friendly */
    @media print{
      body{background:white; color:black}
      header,main,footer{max-width:none}
      nav#toc{display:none}
      section{box-shadow:none; border:1px solid #ccc; background:white}
      canvas{border:1px solid #999; background:white}
      .copyBtn{display:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="titleCard">
      <h1>Exponential Decay of Mean Photon Number in an Absorber</h1>
      <p>
        We derive the Beer–Lambert exponential decay law for the <em>mean photon number</em> inside an absorbing slab,
        connect it to classical electromagnetic attenuation, and (for coherent light) obtain the full photon-number
        distribution at any depth.
      </p>
      <div class="badgeRow">
        <span class="badge">Absorption coefficient: <span style="font-family:var(--mono)">α</span> (cm⁻¹)</span>
        <span class="badge">Thickness: <span style="font-family:var(--mono)">d</span> (cm)</span>
        <span class="badge">Depth coordinate: <span style="font-family:var(--mono)">x</span> (cm)</span>
        <span class="badge">Mean photon number: <span style="font-family:var(--mono)">n̄(x)</span></span>
      </div>
    </div>
  </header>

  <main>
    <nav id="toc" aria-label="Table of contents">
      <div class="tocTitle">
        <h2>Table of Contents</h2>
        <span class="pill">sticky</span>
      </div>
      <a href="#quick">Quick Summary</a>
      <a href="#part0">PART 0 — Concept Primer</a>
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a href="#part2">PART 2 — Strategy & Tips</a>
      <a href="#part3">PART 3 — Full Solution</a>
      <a href="#part4">PART 4 — Deeper Understanding</a>
      <a href="#part5">PART 5 — Visualization Guide</a>
      <a href="#viz">Interactive Visualizations</a>
    </nav>

    <article>
      <section id="quick">
        <h2>Quick Summary</h2>
        <ul>
          <li><strong>What this is about:</strong> how light (as photons) is attenuated as it propagates through an absorbing material of thickness <span style="font-family:var(--mono)">d</span>.</li>
          <li><strong>Key physics idea:</strong> absorption is a <em>memoryless (local) loss process</em>: in a thin slice <span style="font-family:var(--mono)">dx</span>, a fraction <span style="font-family:var(--mono)">α dx</span> of photons are removed on average.</li>
          <li><strong>Governing differential equation:</strong> <span style="font-family:var(--mono)">d n̄(x)/dx = −α n̄(x)</span>.</li>
          <li><strong>Mean photon number vs depth:</strong> <span style="font-family:var(--mono)">n̄(x) = n̄(0) e^{−α x}</span> (Beer–Lambert law).</li>
          <li><strong>Why it matches classical optics:</strong> intensity <span style="font-family:var(--mono)">I(x)</span> is proportional to photon flux, so it obeys the same exponential attenuation.</li>
          <li><strong>Coherent-light statistics:</strong> the photon-number distribution remains Poisson with depth-dependent mean:
            <span style="font-family:var(--mono)">p(n;x)=e^{−n̄(x)} n̄(x)^n/n!</span>.
          </li>
          <li><strong>Single-photon survival through the slab:</strong> <span style="font-family:var(--mono)">P_survive = e^{−α d}</span>.</li>
        </ul>
      </section>

      <section id="part0">
        <h2>PART 0 — Concept Primer (THEORY BEFORE SOLVING)</h2>

        <div class="grid2">
          <div class="callout keyeq">
            <strong>Core definitions</strong>
            <ul class="muted">
              <li><span style="font-family:var(--mono)">x</span> = depth into absorber (cm), with <span style="font-family:var(--mono)">0 ≤ x ≤ d</span>.</li>
              <li><span style="font-family:var(--mono)">d</span> = thickness of absorber (cm).</li>
              <li><span style="font-family:var(--mono)">α</span> = absorption coefficient (cm⁻¹): sets <em>loss per unit length</em>.</li>
              <li><span style="font-family:var(--mono)">n̄(x)</span> = mean photon number (or mean photon flux through a reference plane) at depth <span style="font-family:var(--mono)">x</span>.</li>
              <li><span style="font-family:var(--mono)">p(n;x)</span> = probability of having <span style="font-family:var(--mono)">n</span> photons (in a chosen mode/time window) at depth <span style="font-family:var(--mono)">x</span>.</li>
            </ul>
          </div>

          <div class="callout assumptions">
            <strong>Physical meaning (intuition)</strong>
            <p class="muted">
              Think of absorption as a probabilistic “photon removal” process that happens continuously as the field
              propagates. If the material is uniform and linear, each tiny slice of thickness <span style="font-family:var(--mono)">dx</span>
              removes the same <em>fraction</em> of whatever light reaches it. When the fractional loss per slice is constant,
              repeated multiplication of fractions produces an exponential.
            </p>
          </div>
        </div>

        <h3>Key laws & when they are valid</h3>
        <ul class="muted">
          <li><strong>Beer–Lambert attenuation:</strong> <span style="font-family:var(--mono)">dI/dx = −α I</span> for a uniform, linear absorber (no gain, no saturation).</li>
          <li><strong>Photon picture:</strong> if absorption events are independent and local, the <em>mean</em> photon number obeys the same first-order loss law as intensity.</li>
          <li><strong>Coherent states under loss:</strong> linear loss maps a coherent state to another coherent state with reduced amplitude. Therefore photon statistics remain Poisson, only the mean changes.</li>
        </ul>

        <h3>Common models/approximations (and why we use them)</h3>
        <ul class="muted">
          <li><strong>Uniform medium:</strong> <span style="font-family:var(--mono)">α</span> constant → simplest and standard for a homogeneous absorber.</li>
          <li><strong>No reflections / scattering:</strong> we focus purely on absorption; otherwise additional terms appear.</li>
          <li><strong>Linear (unsaturated) absorption:</strong> absorption probability per unit length does not depend on intensity.</li>
          <li><strong>1D propagation:</strong> only the variation along <span style="font-family:var(--mono)">x</span> matters for the mean attenuation.</li>
        </ul>

        <h3>Mini intuition examples</h3>
        <ul class="muted">
          <li><strong>“Fraction per slice”:</strong> if each 1 mm slice transmits 90%, then after many slices transmission is <span style="font-family:var(--mono)">0.9^N</span> → exponential in distance.</li>
          <li><strong>Mean-free-path idea:</strong> <span style="font-family:var(--mono)">1/α</span> is a characteristic length: after traveling about <span style="font-family:var(--mono)">1/α</span>, the mean drops by a factor <span style="font-family:var(--mono)">e</span>.</li>
        </ul>

        <div class="callout mistakes">
          <strong>What to watch for (pitfalls)</strong>
          <ul class="muted">
            <li>Mixing up <span style="font-family:var(--mono)">α</span> (intensity attenuation) with field-amplitude attenuation (which would be <span style="font-family:var(--mono)">α/2</span> in some conventions).</li>
            <li>Forgetting units: if <span style="font-family:var(--mono)">α</span> is in cm⁻¹, then <span style="font-family:var(--mono)">x</span> and <span style="font-family:var(--mono)">d</span> must be in cm.</li>
            <li>Assuming all photon-number distributions are Poisson; that’s specific to coherent light (and some other cases under linear loss).</li>
          </ul>
        </div>
      </section>

      <section id="part1">
        <h2>PART 1 — Problem Analysis (no solving yet)</h2>

        <h3>Restating the problem in plain words</h3>
        <p class="muted">
          A uniform absorbing slab of thickness <span style="font-family:var(--mono)">d</span> has absorption coefficient <span style="font-family:var(--mono)">α</span>.
          If the mean photon number entering at <span style="font-family:var(--mono)">x=0</span> is <span style="font-family:var(--mono)">n̄(0)=n̄</span>,
          (a) write a differential equation for the mean photon number at depth <span style="font-family:var(--mono)">x</span>;
          (b) solve it and relate it to the classical exponential decay law; (c) for coherent incident light, write the photon-number
          distribution <span style="font-family:var(--mono)">p(n;x)</span>; (d) find the survival probability for a single photon through the slab.
        </p>

        <div class="grid2">
          <div class="callout">
            <strong>Given</strong>
            <ul class="muted">
              <li>Thickness: <span style="font-family:var(--mono)">d</span> (cm)</li>
              <li>Absorption coefficient: <span style="font-family:var(--mono)">α</span> (cm⁻¹)</li>
              <li>Input mean photon number: <span style="font-family:var(--mono)">n̄(0)=n̄</span></li>
            </ul>
          </div>
          <div class="callout">
            <strong>Unknowns / asked for</strong>
            <ul class="muted">
              <li>Differential equation for <span style="font-family:var(--mono)">n̄(x)</span></li>
              <li>Solution <span style="font-family:var(--mono)">n̄(x)</span> and interpretation</li>
              <li><span style="font-family:var(--mono)">p(n;x)</span> for coherent light</li>
              <li>Single-photon survival probability through thickness <span style="font-family:var(--mono)">d</span></li>
            </ul>
          </div>
        </div>

        <h3>Relevant principles and why they apply</h3>
        <ul class="muted">
          <li><strong>Local linear loss:</strong> absorption removes a constant fraction per unit length in a uniform medium, so a first-order linear ODE applies.</li>
          <li><strong>Photon–intensity proportionality:</strong> in a fixed mode/time window, intensity (energy flux) is proportional to photon number (or photon flux), so the same decay law appears in classical optics.</li>
          <li><strong>Coherent-state invariance under loss:</strong> linear absorption acts like a beam splitter with transmission <span style="font-family:var(--mono)">η=e^{−α x}</span>, mapping Poisson statistics to Poisson statistics with reduced mean.</li>
        </ul>

        <div class="callout assumptions">
          <strong>Assumptions (explicit)</strong>
          <ul class="muted">
            <li>Uniform absorber: <span style="font-family:var(--mono)">α</span> is constant in <span style="font-family:var(--mono)">x</span>.</li>
            <li>Linear (unsaturated) absorption; no gain.</li>
            <li>Negligible reflections/scattering (pure absorption model).</li>
            <li>Steady propagation in 1D along <span style="font-family:var(--mono)">x</span>.</li>
          </ul>
        </div>

        <h3>Possible approaches (compare briefly)</h3>
        <ol class="muted">
          <li><strong>Continuum rate equation (best here):</strong> write <span style="font-family:var(--mono)">dn̄ = −(fraction lost)×n̄</span> over <span style="font-family:var(--mono)">dx</span> → immediate ODE and exponential solution.</li>
          <li><strong>Discrete slicing:</strong> treat slab as many thin layers each transmitting <span style="font-family:var(--mono)">1−αΔx</span>; take <span style="font-family:var(--mono)">Δx→0</span> to get the exponential. More intuitive but longer.</li>
          <li><strong>Quantum-channel (beam-splitter) model:</strong> represent absorption as a loss channel with transmissivity <span style="font-family:var(--mono)">η</span>; directly gives coherent-state transformation and Poisson distribution. Powerful for part (c).</li>
        </ol>

        <p class="muted">
          We will use the <strong>continuum rate equation</strong> for (a,b,d) because it is shortest and directly matches Beer–Lambert,
          and then use the <strong>loss-channel view</strong> to justify the Poisson distribution in (c).
        </p>
      </section>

      <section id="part2">
        <h2>PART 2 — Strategy & Tips (roadmap only)</h2>
        <ol class="muted">
          <li><strong>Model a thin slice:</strong> for thickness <span style="font-family:var(--mono)">dx</span>, write the mean loss <span style="font-family:var(--mono)">d n̄</span> proportional to <span style="font-family:var(--mono)">n̄</span> and to <span style="font-family:var(--mono)">dx</span>.</li>
          <li><strong>Write the ODE:</strong> turn that proportionality into <span style="font-family:var(--mono)">d n̄/dx = −α n̄</span>.</li>
          <li><strong>Solve the ODE:</strong> separate variables and integrate; enforce boundary condition <span style="font-family:var(--mono)">n̄(0)=n̄</span>.</li>
          <li><strong>Connect to classical optics:</strong> argue that <span style="font-family:var(--mono)">I ∝ n̄</span> (photon flux × photon energy) so both obey the same exponential.</li>
          <li><strong>Coherent light distribution:</strong> use the fact that coherent states have Poisson photon-number distribution; under loss, the mean scales by the transmission factor <span style="font-family:var(--mono)">e^{−α x}</span>.</li>
          <li><strong>Single-photon survival:</strong> set <span style="font-family:var(--mono)">n̄(0)=1</span> in the mean-survival factor, or interpret survival as transmission probability <span style="font-family:var(--mono)">η=e^{−α d}</span>.</li>
        </ol>

        <div class="callout mistakes">
          <strong>Quick tips + common mistakes</strong>
          <ul class="muted">
            <li>Keep <span style="font-family:var(--mono)">αx</span> dimensionless: check your length units.</li>
            <li>For part (c), don’t “invent” a new distribution: coherent light → Poisson, with mean replaced by <span style="font-family:var(--mono)">n̄(x)</span>.</li>
            <li>Distinguish: mean photon number at depth vs probability a particular photon survives to that depth (they coincide for a single photon).</li>
          </ul>
        </div>
      </section>

      <section id="part3">
        <h2>PART 3 — Full Solution (DETAILED + TEACHING)</h2>

        <h3>Physical intuition first (before math)</h3>
        <p class="muted">
          In a uniform absorber, every additional centimeter of travel “gives the material another chance” to absorb photons.
          If each small slice removes the same <em>fraction</em> of whatever remains, then the remaining mean must decrease
          multiplicatively with distance. Multiplicative decay over continuous distance is exactly what an exponential describes.
        </p>

        <div class="hr"></div>

        <h3>(a) Differential equation for the mean photon number</h3>
        <p class="muted">
          Consider a thin slab slice between <span style="font-family:var(--mono)">x</span> and <span style="font-family:var(--mono)">x+dx</span>.
          For a uniform medium with absorption coefficient <span style="font-family:var(--mono)">α</span>, the <em>fraction</em> of photons absorbed
          over thickness <span style="font-family:var(--mono)">dx</span> is approximately <span style="font-family:var(--mono)">α dx</span> (for small <span style="font-family:var(--mono)">dx</span>).
        </p>
        <p class="muted">
          Therefore the mean change in photon number is
        </p>

        <div class="eqBox" id="eq-a">
          <button class="copyBtn" data-copy="eq-a-text">Copy</button>
          <code id="eq-a-text">d n̄(x) = − (α dx) n̄(x)</code>
        </div>

        <p class="muted">
          Divide by <span style="font-family:var(--mono)">dx</span> and take the limit <span style="font-family:var(--mono)">dx→0</span> to obtain the differential equation:
        </p>

        <div class="eqBox" id="eq-ode">
          <button class="copyBtn" data-copy="eq-ode-text">Copy</button>
          <code id="eq-ode-text">d n̄(x) / dx = − α n̄(x),   with boundary condition n̄(0)=n̄</code>
        </div>

        <p class="muted">
          <strong>What we did and why:</strong> we encoded “constant fractional loss per unit length” into an ODE. The minus sign
          enforces decay (absorption removes photons).
        </p>

        <div class="hr"></div>

        <h3>(b) Solve the ODE and connect to the exponential decay law</h3>
        <p class="muted">
          Start from
          <span style="font-family:var(--mono)">d n̄/dx = −α n̄</span>.
          Separate variables (move all <span style="font-family:var(--mono)">n̄</span> to one side, all <span style="font-family:var(--mono)">x</span> to the other):
        </p>

        <div class="eqBox" id="eq-sep">
          <button class="copyBtn" data-copy="eq-sep-text">Copy</button>
          <code id="eq-sep-text">(1 / n̄) d n̄ = −α dx</code>
        </div>

        <p class="muted">
          Integrate from the entrance (<span style="font-family:var(--mono)">x=0</span>, mean <span style="font-family:var(--mono)">n̄(0)=n̄</span>)
          to a general depth <span style="font-family:var(--mono)">x</span>:
        </p>

        <div class="eqBox" id="eq-int">
          <button class="copyBtn" data-copy="eq-int-text">Copy</button>
          <code id="eq-int-text">∫_{n̄(0)=n̄}^{n̄(x)} (1/n̄') d n̄' = −α ∫_{0}^{x} dx'</code>
        </div>

        <p class="muted">
          The left integral is a logarithm; the right integral is just <span style="font-family:var(--mono)">x</span>:
        </p>

        <div class="eqBox" id="eq-log">
          <button class="copyBtn" data-copy="eq-log-text">Copy</button>
          <code id="eq-log-text">ln[n̄(x)] − ln[n̄] = −α x</code>
        </div>

        <p class="muted">
          Exponentiate both sides to solve for <span style="font-family:var(--mono)">n̄(x)</span>:
        </p>

        <div class="eqBox" id="eq-sol">
          <button class="copyBtn" data-copy="eq-sol-text">Copy</button>
          <code id="eq-sol-text">n̄(x) = n̄ e^{−α x}</code>
        </div>

        <div class="callout answer">
          <strong>Result (b): Exponential decay of mean photon number</strong>
          <div class="eqBox" style="margin:10px 0 0" id="eq-final-mean">
            <button class="copyBtn" data-copy="eq-final-mean-text">Copy</button>
            <code id="eq-final-mean-text">n̄(x) = n̄(0) e^{−α x},  0 ≤ x ≤ d</code>
          </div>
        </div>

        <h3>Why this matches electromagnetic optics (Beer–Lambert law)</h3>
        <p class="muted">
          In classical optics, the intensity (power per area) obeys <span style="font-family:var(--mono)">dI/dx = −α I</span> in a uniform absorber.
          In the photon picture, intensity is proportional to photon flux times photon energy:
          <span style="font-family:var(--mono)">I ∝ (photon flux) × (ħω)</span>. For fixed frequency <span style="font-family:var(--mono)">ω</span>,
          <span style="font-family:var(--mono)">ħω</span> is constant, so the same first-order loss law applies to the mean photon number (or flux).
          Thus <span style="font-family:var(--mono)">I(x)</span> and <span style="font-family:var(--mono)">n̄(x)</span> share the same exponential form.
        </p>

        <div class="hr"></div>

        <h3>(c) Photon-number distribution for coherent incident light</h3>
        <p class="muted">
          A coherent state has Poisson photon-number statistics at the input:
          <span style="font-family:var(--mono)">p(n;0) = e^{−n̄} n̄^n / n!</span>.
          Linear loss (absorption) is equivalent to a beam splitter that transmits a fraction
          <span style="font-family:var(--mono)">η(x)=e^{−α x}</span> of the optical power (and hence of the mean photon number).
          Coherent states remain coherent under such loss, so the distribution remains Poisson but with reduced mean
          <span style="font-family:var(--mono)">n̄(x)=n̄ e^{−α x}</span>.
        </p>

        <div class="eqBox" id="eq-poisson">
          <button class="copyBtn" data-copy="eq-poisson-text">Copy</button>
          <code id="eq-poisson-text">p(n; x) = exp(−n̄(x)) [n̄(x)]^n / n!   where  n̄(x)=n̄ e^{−α x}</code>
        </div>

        <div class="hr"></div>

        <h3>(d) Probability a single photon survives through the absorber</h3>
        <p class="muted">
          For a <em>single</em> photon entering the slab, “survival” means it is not absorbed over length <span style="font-family:var(--mono)">d</span>.
          The same local-loss logic gives the transmission (survival) probability:
        </p>

        <div class="eqBox" id="eq-survive">
          <button class="copyBtn" data-copy="eq-survive-text">Copy</button>
          <code id="eq-survive-text">P_survive(d) = e^{−α d}</code>
        </div>

        <div class="callout answer">
          <strong>Final answers (all parts)</strong>
          <div class="eqBox" style="margin:10px 0 0" id="eq-final-all">
            <button class="copyBtn" data-copy="eq-final-all-text">Copy</button>
            <code id="eq-final-all-text">(a) d n̄/dx = −α n̄,  n̄(0)=n̄
(b) n̄(x)=n̄ e^{−α x}
(c) coherent: p(n;x)=exp(−n̄ e^{−α x}) (n̄ e^{−α x})^n / n!
(d) single-photon survival through thickness d: P_survive=e^{−α d}</code>
          </div>
        </div>

        <h3>Sanity checks</h3>
        <ul class="muted">
          <li><strong>Units:</strong> <span style="font-family:var(--mono)">α</span> has units cm⁻¹ and <span style="font-family:var(--mono)">x</span> has cm, so <span style="font-family:var(--mono)">αx</span> is dimensionless → OK.</li>
          <li><strong>Limiting cases:</strong> if <span style="font-family:var(--mono)">α=0</span>, then <span style="font-family:var(--mono)">n̄(x)=n̄</span> (no absorption). If <span style="font-family:var(--mono)">x→∞</span>, <span style="font-family:var(--mono)">n̄(x)→0</span>.</li>
          <li><strong>Sign reasoning:</strong> <span style="font-family:var(--mono)">α&gt;0</span> gives decay; negative <span style="font-family:var(--mono)">α</span> would represent gain, not absorption.</li>
          <li><strong>Physical meaning:</strong> <span style="font-family:var(--mono)">1/α</span> is the distance over which the mean drops by a factor <span style="font-family:var(--mono)">e</span>.</li>
        </ul>

        <p class="muted">
          <strong>Connection to the diagram/plots:</strong> the slab diagram labels <span style="font-family:var(--mono)">x</span> and <span style="font-family:var(--mono)">d</span>,
          while the main plot shows the exponential <span style="font-family:var(--mono)">n̄(x)</span> curve. The secondary plot visualizes
          the Poisson distribution at a chosen depth, making part (c) tangible.
        </p>
      </section>

      <section id="part4">
        <h2>PART 4 — Deeper Understanding (THEORY AROUND THE RESULT)</h2>

        <h3>Re-interpreting the final formula</h3>
        <p class="muted">
          The solution <span style="font-family:var(--mono)">n̄(x)=n̄(0)e^{−αx}</span> has two “knobs”:
        </p>
        <ul class="muted">
          <li><span style="font-family:var(--mono)">n̄(0)</span> sets the overall scale (how many photons you start with).</li>
          <li><span style="font-family:var(--mono)">α</span> sets the decay rate (how quickly photons are removed per unit length).</li>
        </ul>
        <p class="muted">
          The survival probability for a single photon is the same exponential because a single photon is either transmitted or absorbed,
          and the medium applies the same constant “hazard rate” per unit length. In probability language, absorption along <span style="font-family:var(--mono)">x</span>
          behaves like an exponential survival process with rate <span style="font-family:var(--mono)">α</span>.
        </p>

        <h3>How changing parameters affects outcomes (connect to plots)</h3>
        <ul class="muted">
          <li>Increase <span style="font-family:var(--mono)">α</span> → the main decay curve drops faster; the Poisson mean at any fixed <span style="font-family:var(--mono)">x</span> decreases, shifting the distribution toward small <span style="font-family:var(--mono)">n</span>.</li>
          <li>Increase <span style="font-family:var(--mono)">d</span> → longer propagation; output mean <span style="font-family:var(--mono)">n̄(d)</span> decreases and single-photon survival <span style="font-family:var(--mono)">e^{−αd}</span> drops.</li>
          <li>Move the “probe depth” <span style="font-family:var(--mono)">x</span> deeper → you sample a smaller mean and a more “vacuum-dominated” Poisson distribution.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p class="muted">
          <strong>Discrete-layer derivation:</strong> divide the slab into <span style="font-family:var(--mono)">N</span> layers of thickness <span style="font-family:var(--mono)">Δx=d/N</span>.
          If each layer transmits <span style="font-family:var(--mono)">T ≈ 1−αΔx</span>, then after <span style="font-family:var(--mono)">N</span> layers:
          <span style="font-family:var(--mono)">n̄(d) ≈ n̄(0) (1−αd/N)^N → n̄(0) e^{−αd}</span> as <span style="font-family:var(--mono)">N→∞</span>.
          This explicitly shows how exponentials arise from repeated small fractional losses.
        </p>

        <h3>Concept check (quick self-test)</h3>
        <ul class="muted">
          <li><strong>Q:</strong> What length makes <span style="font-family:var(--mono)">n̄</span> drop to half? <strong>A:</strong> Solve <span style="font-family:var(--mono)">e^{−αx}=1/2</span> → <span style="font-family:var(--mono)">x=(ln 2)/α</span>.</li>
          <li><strong>Q:</strong> If <span style="font-family:var(--mono)">α</span> doubles, what happens to <span style="font-family:var(--mono)">P_survive</span> at fixed <span style="font-family:var(--mono)">d</span>? <strong>A:</strong> It squares: <span style="font-family:var(--mono)">e^{−2αd}=(e^{−αd})^2</span>.</li>
          <li><strong>Q:</strong> Does coherent light remain coherent after absorption? <strong>A:</strong> Under ideal linear loss, yes—still coherent but with reduced amplitude (mean photon number decays).</li>
          <li><strong>Q:</strong> What breaks this model? <strong>A:</strong> Saturable absorption, strong scattering/reflections, spatially varying <span style="font-family:var(--mono)">α(x)</span>, or nonlinear processes.</li>
        </ul>
      </section>

      <section id="part5">
        <h2>PART 5 — Visualization Guide (HOW TO READ THE PLOTS)</h2>
        <div class="grid2">
          <div class="callout">
            <strong>Diagram canvas</strong>
            <p class="muted">
              Shows the absorbing slab of thickness <span style="font-family:var(--mono)">d</span>, the propagation direction <span style="font-family:var(--mono)">x</span>,
              and labels the mean photon number at the entrance <span style="font-family:var(--mono)">n̄(0)</span>, at a probe depth <span style="font-family:var(--mono)">x</span>, and at the exit <span style="font-family:var(--mono)">n̄(d)</span>.
            </p>
          </div>
          <div class="callout">
            <strong>Main + secondary plots</strong>
            <ul class="muted">
              <li><strong>Main plot:</strong> <span style="font-family:var(--mono)">n̄(x)</span> vs <span style="font-family:var(--mono)">x</span> showing exponential decay.</li>
              <li><strong>Secondary plot:</strong> Poisson photon-number distribution <span style="font-family:var(--mono)">p(n;x)</span> at the selected depth <span style="font-family:var(--mono)">x</span>.</li>
            </ul>
          </div>
        </div>

        <div class="callout assumptions" style="margin-top:12px;">
          <strong>Interactive controls (what changes and why)</strong>
          <ul class="muted">
            <li><span style="font-family:var(--mono)">α</span> slider changes absorption strength → steeper/shallower exponential and shifts the Poisson distribution.</li>
            <li><span style="font-family:var(--mono)">d</span> slider changes slab thickness → extends the domain of the exponential and changes exit transmission.</li>
            <li><span style="font-family:var(--mono)">n̄(0)</span> slider sets input mean → rescales the decay curve and the Poisson mean.</li>
            <li><span style="font-family:var(--mono)">x</span> slider selects the depth where you “sample” the distribution → deeper means smaller <span style="font-family:var(--mono)">n̄(x)</span>.</li>
          </ul>
          <p class="muted">
            Any control update redraws <strong>all</strong> canvases (diagram, main plot, secondary plot) so the math and visuals stay consistent.
          </p>
        </div>
      </section>

      <section id="viz">
        <h2>Interactive Visualizations</h2>

        <div class="controls" aria-label="Interactive controls">
          <div class="ctrl">
            <label for="alpha">
              <span>Absorption α (cm⁻¹)</span>
              <span class="val" id="alphaVal">1.00</span>
            </label>
            <input id="alpha" type="range" min="0" max="5" step="0.01" value="1.00"/>
          </div>
          <div class="ctrl">
            <label for="d">
              <span>Thickness d (cm)</span>
              <span class="val" id="dVal">2.00</span>
            </label>
            <input id="d" type="range" min="0.2" max="6" step="0.01" value="2.00"/>
          </div>
          <div class="ctrl">
            <label for="n0">
              <span>Input mean n̄(0)</span>
              <span class="val" id="n0Val">10.0</span>
            </label>
            <input id="n0" type="range" min="0.5" max="60" step="0.1" value="10.0"/>
          </div>
          <div class="ctrl">
            <label for="xprobe">
              <span>Probe depth x (cm)</span>
              <span class="val" id="xVal">1.00</span>
            </label>
            <input id="xprobe" type="range" min="0" max="2.00" step="0.01" value="1.00"/>
          </div>
        </div>

        <div class="vizWrap" style="margin-top:12px;">
          <div class="canvasCard">
            <div class="canvasTop">
              <div>
                <div class="title">Geometry Diagram (Absorbing Slab)</div>
                <div class="subtitle">Labeled setup: x-axis, thickness d, and mean photon number at key positions</div>
              </div>
              <div class="subtitle" id="diagNote" style="text-align:right;"></div>
            </div>
            <canvas id="diagram" aria-label="Absorber diagram"></canvas>
          </div>

          <div class="twoCanv">
            <div class="canvasCard">
              <div class="canvasTop">
                <div>
                  <div class="title">Main Plot: Mean Photon Number vs Depth</div>
                  <div class="subtitle">n̄(x) = n̄(0) e^{−αx}</div>
                </div>
                <div class="subtitle" id="mainNote" style="text-align:right;"></div>
              </div>
              <canvas id="mainPlot" aria-label="Main plot of mean photon number vs depth"></canvas>
            </div>

            <div class="canvasCard smallCanvas">
              <div class="canvasTop">
                <div>
                  <div class="title">Secondary Plot: Photon-Number Distribution at Depth x</div>
                  <div class="subtitle">Coherent light → Poisson with mean n̄(x)</div>
                </div>
                <div class="subtitle" id="distNote" style="text-align:right;"></div>
              </div>
              <canvas id="distPlot" aria-label="Poisson photon number distribution"></canvas>
            </div>
          </div>
        </div>

        <div class="callout keyeq" style="margin-top:12px;">
          <strong>Live readout (based on current sliders)</strong>
          <p class="muted" style="margin:8px 0 0;">
            <span style="font-family:var(--mono)">n̄(d) = </span><span id="nOut" style="font-family:var(--mono); color:#fff;">—</span>
            <span class="faint"> &nbsp;|&nbsp; </span>
            <span style="font-family:var(--mono)">P_survive(single photon through d) = </span><span id="pSurv" style="font-family:var(--mono); color:#fff;">—</span>
            <span class="faint"> &nbsp;|&nbsp; </span>
            <span style="font-family:var(--mono)">n̄(x_probe) = </span><span id="nProbe" style="font-family:var(--mono); color:#fff;">—</span>
          </p>
        </div>
      </section>
    </article>
  </main>

  <footer>
    <p>
      Notes: The plots use example values from the sliders (no specific numeric values were provided in the problem).
      The symbolic results in the solution remain general.
    </p>
  </footer>

  <script>
    // ---------- Utilities ----------
    function clamp(v, a, b){ return Math.max(a, Math.min(b, v)); }

    function formatNum(x, digits=3){
      if (!isFinite(x)) return "—";
      const ax = Math.abs(x);
      if (ax !== 0 && (ax < 1e-3 || ax >= 1e4)) return x.toExponential(digits);
      return x.toFixed(digits);
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        // Fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        let ok = false;
        try{ ok = document.execCommand("copy"); }catch(_){}
        document.body.removeChild(ta);
        return ok;
      }
    }

    // high-DPI canvas resize
    function resizeCanvas(canvas, cssHeight){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(2, Math.floor(rect.width * dpr));
      const h = Math.max(2, Math.floor((cssHeight ?? rect.height) * dpr));
      if (canvas.width !== w || canvas.height !== h){
        canvas.width = w; canvas.height = h;
      }
      return {w, h, dpr};
    }

    function clear(ctx, w, h){
      ctx.clearRect(0,0,w,h);
    }

    // Draw a nice axis with ticks/grid
    function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
      const {x, y, w, h} = box;
      // background
      ctx.save();
      ctx.fillStyle = "rgba(12,18,40,0.15)";
      ctx.fillRect(x,y,w,h);

      // title
      ctx.fillStyle = "rgba(232,236,255,0.92)";
      ctx.font = `${Math.max(12, Math.floor(h*0.06))}px ui-sans-serif, system-ui`;
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillText(title, x+10, y+8);

      // plot area
      const padL = 56, padR = 16, padT = 34, padB = 44;
      const px = x + padL, py = y + padT, pw = w - padL - padR, ph = h - padT - padB;

      // grid + ticks
      const nXTicks = 6, nYTicks = 6;
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 1;

      // vertical grid
      for(let i=0;i<=nXTicks;i++){
        const gx = px + (pw*i/nXTicks);
        ctx.beginPath();
        ctx.moveTo(gx, py);
        ctx.lineTo(gx, py+ph);
        ctx.stroke();
      }
      // horizontal grid
      for(let j=0;j<=nYTicks;j++){
        const gy = py + (ph*j/nYTicks);
        ctx.beginPath();
        ctx.moveTo(px, gy);
        ctx.lineTo(px+pw, gy);
        ctx.stroke();
      }

      // axes lines
      ctx.strokeStyle = "rgba(255,255,255,0.35)";
      ctx.lineWidth = 1.25;
      ctx.beginPath();
      ctx.moveTo(px, py);
      ctx.lineTo(px, py+ph);
      ctx.lineTo(px+pw, py+ph);
      ctx.stroke();

      // tick labels
      ctx.fillStyle = "rgba(183,192,255,0.95)";
      ctx.font = `12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace`;
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      for(let i=0;i<=nXTicks;i++){
        const val = xMin + (xMax-xMin)*(i/nXTicks);
        const gx = px + (pw*i/nXTicks);
        ctx.fillText(formatNum(val,2), gx, py+ph+8);
      }
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      for(let j=0;j<=nYTicks;j++){
        const val = yMax - (yMax-yMin)*(j/nYTicks);
        const gy = py + (ph*j/nYTicks);
        ctx.fillText(formatNum(val,2), px-8, gy);
      }

      // axis labels
      ctx.fillStyle = "rgba(232,236,255,0.92)";
      ctx.font = `13px ui-sans-serif, system-ui`;
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.fillText(xLabel, px + pw/2, y + h - 8);

      ctx.save();
      ctx.translate(x + 14, py + ph/2);
      ctx.rotate(-Math.PI/2);
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();

      ctx.restore();

      function X(v){ return px + (v-xMin)*pw/(xMax-xMin); }
      function Y(v){ return py + ph - (v-yMin)*ph/(yMax-yMin); }
      return {px,py,pw,ph,X,Y};
    }

    // ---------- Physics ----------
    function nbarAt(x, alpha, n0){
      return n0 * Math.exp(-alpha * x);
    }
    function poissonP(n, mu){
      // stable enough for moderate n with direct recursion outside, but fine here with exp and factorial recursion
      return Math.exp(-mu) * Math.pow(mu, n) / factorial(n);
    }
    const factCache = [1];
    function factorial(n){
      n = Math.floor(n);
      if (n < 0) return NaN;
      for(let k=factCache.length; k<=n; k++){
        factCache[k] = factCache[k-1] * k;
      }
      return factCache[n];
    }

    // ---------- Canvases ----------
    const canvDiagram = document.getElementById("diagram");
    const canvMain = document.getElementById("mainPlot");
    const canvDist = document.getElementById("distPlot");

    const ctxD = canvDiagram.getContext("2d");
    const ctxM = canvMain.getContext("2d");
    const ctxP = canvDist.getContext("2d");

    function drawDiagram(state){
      const {alpha, d, n0, xProbe} = state;
      const {w,h,dpr} = resizeCanvas(canvDiagram);
      clear(ctxD,w,h);

      // Layout
      const margin = 22*dpr;
      const slabX = margin;
      const slabY = 70*dpr;
      const slabW = w - 2*margin;
      const slabH = h - slabY - 60*dpr;

      // slab
      ctxD.save();
      ctxD.fillStyle = "rgba(125,183,255,0.08)";
      ctxD.strokeStyle = "rgba(125,183,255,0.45)";
      ctxD.lineWidth = 2*dpr;
      ctxD.fillRect(slabX, slabY, slabW, slabH);
      ctxD.strokeRect(slabX, slabY, slabW, slabH);

      // x-axis along slab
      const axisY = slabY + slabH + 18*dpr;
      ctxD.strokeStyle = "rgba(255,255,255,0.35)";
      ctxD.lineWidth = 1.5*dpr;
      ctxD.beginPath();
      ctxD.moveTo(slabX, axisY);
      ctxD.lineTo(slabX + slabW, axisY);
      ctxD.stroke();

      // ticks and labels 0, xProbe, d
      function xToPx(x){
        return slabX + (x/d)*slabW;
      }
      const x0 = xToPx(0);
      const xp = xToPx(xProbe);
      const xd = xToPx(d);

      const tickH = 8*dpr;
      ctxD.strokeStyle = "rgba(255,255,255,0.35)";
      ctxD.lineWidth = 1.5*dpr;

      function tick(px){
        ctxD.beginPath();
        ctxD.moveTo(px, axisY - tickH);
        ctxD.lineTo(px, axisY + tickH);
        ctxD.stroke();
      }
      tick(x0); tick(xp); tick(xd);

      ctxD.fillStyle = "rgba(232,236,255,0.95)";
      ctxD.font = `${Math.max(12, Math.floor(14*dpr))}px ${getComputedStyle(document.body).fontFamily}`;
      ctxD.textAlign = "center";
      ctxD.textBaseline = "top";
      ctxD.fillText("x = 0", x0, axisY + 10*dpr);
      ctxD.fillText("x", xp, axisY + 10*dpr);
      ctxD.fillText("x = d", xd, axisY + 10*dpr);

      // incoming arrow + labels
      const midY = slabY + slabH*0.35;
      ctxD.strokeStyle = "rgba(124,247,197,0.8)";
      ctxD.lineWidth = 3*dpr;
      ctxD.beginPath();
      ctxD.moveTo(slabX - 46*dpr, midY);
      ctxD.lineTo(slabX + 20*dpr, midY);
      ctxD.stroke();
      // arrow head
      ctxD.beginPath();
      ctxD.moveTo(slabX + 20*dpr, midY);
      ctxD.lineTo(slabX + 8*dpr, midY - 7*dpr);
      ctxD.lineTo(slabX + 8*dpr, midY + 7*dpr);
      ctxD.closePath();
      ctxD.fillStyle = "rgba(124,247,197,0.85)";
      ctxD.fill();

      // outgoing arrow
      ctxD.strokeStyle = "rgba(125,183,255,0.75)";
      ctxD.lineWidth = 3*dpr;
      ctxD.beginPath();
      ctxD.moveTo(slabX + slabW - 20*dpr, midY);
      ctxD.lineTo(slabX + slabW + 46*dpr, midY);
      ctxD.stroke();
      ctxD.beginPath();
      ctxD.moveTo(slabX + slabW + 46*dpr, midY);
      ctxD.lineTo(slabX + slabW + 34*dpr, midY - 7*dpr);
      ctxD.lineTo(slabX + slabW + 34*dpr, midY + 7*dpr);
      ctxD.closePath();
      ctxD.fillStyle = "rgba(125,183,255,0.85)";
      ctxD.fill();

      // mean labels
      const nProbe = nbarAt(xProbe, alpha, n0);
      const nOut = nbarAt(d, alpha, n0);

      ctxD.fillStyle = "rgba(183,192,255,0.98)";
      ctxD.font = `${Math.max(12, Math.floor(13*dpr))}px ${getComputedStyle(document.body).fontFamily}`;
      ctxD.textAlign = "left";
      ctxD.textBaseline = "bottom";
      ctxD.fillText(`n̄(0) = ${formatNum(n0,2)}`, slabX - 50*dpr, midY - 10*dpr);

      ctxD.textAlign = "center";
      ctxD.textBaseline = "top";
      ctxD.fillText(`n̄(x) = ${formatNum(nProbe,2)}`, xp, midY + 20*dpr);

      ctxD.textAlign = "right";
      ctxD.textBaseline = "bottom";
      ctxD.fillText(`n̄(d) = ${formatNum(nOut,2)}`, slabX + slabW + 50*dpr, midY - 10*dpr);

      // absorption label inside slab
      ctxD.save();
      ctxD.fillStyle = "rgba(255,204,102,0.95)";
      ctxD.font = `${Math.max(12, Math.floor(14*dpr))}px ${getComputedStyle(document.body).fontFamily}`;
      ctxD.textAlign = "center";
      ctxD.textBaseline = "middle";
      ctxD.fillText(`absorber: α = ${formatNum(alpha,2)} cm⁻¹`, slabX + slabW/2, slabY + slabH*0.72);
      ctxD.restore();

      // title corner note
      ctxD.fillStyle = "rgba(183,192,255,0.90)";
      ctxD.font = `${Math.max(12, Math.floor(12*dpr))}px ui-monospace, Menlo, Consolas, monospace`;
      ctxD.textAlign = "left";
      ctxD.textBaseline = "top";
      ctxD.fillText(`Transmission to depth x: η(x)=e^{−αx}`, slabX + 10*dpr, slabY + 10*dpr);

      ctxD.restore();
    }

    function drawMainPlot(state){
      const {alpha, d, n0} = state;
      const {w,h,dpr} = resizeCanvas(canvMain);
      clear(ctxM,w,h);

      // dynamic y max based on n0
      const yMax = Math.max(1, n0 * 1.05);
      const yMin = 0;

      const axes = drawAxes(
        ctxM,
        {x:0, y:0, w, h},
        0, d,
        yMin, yMax,
        "Depth x (cm)",
        "Mean photon number n̄(x)",
        "Exponential attenuation in a uniform absorber"
      );

      const {X,Y,px,py,pw,ph} = axes;

      // curve
      ctxM.save();
      ctxM.strokeStyle = "rgba(124,247,197,0.95)";
      ctxM.lineWidth = 2.5*dpr;
      ctxM.beginPath();
      const N = 300;
      for(let i=0;i<=N;i++){
        const x = d*i/N;
        const y = nbarAt(x, alpha, n0);
        const cx = X(x), cy = Y(y);
        if (i===0) ctxM.moveTo(cx, cy);
        else ctxM.lineTo(cx, cy);
      }
      ctxM.stroke();

      // highlight at xProbe and at d
      const xProbe = state.xProbe;
      const nProbe = nbarAt(xProbe, alpha, n0);
      const nOut = nbarAt(d, alpha, n0);

      // vertical marker xProbe
      ctxM.strokeStyle = "rgba(125,183,255,0.85)";
      ctxM.lineWidth = 1.75*dpr;
      ctxM.setLineDash([6*dpr, 6*dpr]);
      ctxM.beginPath();
      ctxM.moveTo(X(xProbe), py);
      ctxM.lineTo(X(xProbe), py+ph);
      ctxM.stroke();
      ctxM.setLineDash([]);

      // point markers
      function dot(x,y, col){
        ctxM.fillStyle = col;
        ctxM.beginPath();
        ctxM.arc(X(x), Y(y), 4.5*dpr, 0, Math.PI*2);
        ctxM.fill();
      }
      dot(xProbe, nProbe, "rgba(125,183,255,0.95)");
      dot(d, nOut, "rgba(255,204,102,0.95)");

      // legend
      const lx = px + 10*dpr, ly = py + 42*dpr;
      ctxM.fillStyle = "rgba(232,236,255,0.92)";
      ctxM.font = `${Math.max(11, Math.floor(12*dpr))}px ui-sans-serif, system-ui`;
      ctxM.textAlign = "left";
      ctxM.textBaseline = "top";

      // legend lines
      ctxM.fillText("Legend:", lx, ly);
      ctxM.strokeStyle = "rgba(124,247,197,0.95)";
      ctxM.lineWidth = 3*dpr;
      ctxM.beginPath(); ctxM.moveTo(lx, ly+20*dpr); ctxM.lineTo(lx+28*dpr, ly+20*dpr); ctxM.stroke();
      ctxM.fillText("n̄(x)", lx+36*dpr, ly+12*dpr);

      ctxM.fillStyle = "rgba(125,183,255,0.95)";
      ctxM.beginPath(); ctxM.arc(lx+14*dpr, ly+44*dpr, 4.5*dpr, 0, Math.PI*2); ctxM.fill();
      ctxM.fillStyle = "rgba(232,236,255,0.92)";
      ctxM.fillText(`probe at x = ${formatNum(xProbe,2)} cm`, lx+36*dpr, ly+36*dpr);

      ctxM.fillStyle = "rgba(255,204,102,0.95)";
      ctxM.beginPath(); ctxM.arc(lx+14*dpr, ly+68*dpr, 4.5*dpr, 0, Math.PI*2); ctxM.fill();
      ctxM.fillStyle = "rgba(232,236,255,0.92)";
      ctxM.fillText(`output at d = ${formatNum(d,2)} cm`, lx+36*dpr, ly+60*dpr);

      ctxM.restore();
    }

    function drawDistPlot(state){
      const {alpha, n0, xProbe} = state;
      const {w,h,dpr} = resizeCanvas(canvDist);
      clear(ctxP,w,h);

      const mu = nbarAt(xProbe, alpha, n0);

      // choose nMax based on mu
      const nMax = clamp(Math.ceil(mu + 6*Math.sqrt(Math.max(mu,1))), 10, 45);
      // compute probabilities
      const probs = new Array(nMax+1).fill(0);
      for(let n=0;n<=nMax;n++){
        probs[n] = poissonP(n, mu);
      }
      // yMax for plot
      const pMax = Math.max(...probs) * 1.18;
      const axes = drawAxes(
        ctxP,
        {x:0, y:0, w, h},
        0, nMax,
        0, Math.max(0.02, pMax),
        "Photon number n (count)",
        "Probability p(n;x)",
        "Poisson distribution at depth x"
      );
      const {X,Y,px,py,pw,ph} = axes;

      // bars
      ctxP.save();
      const barW = pw/(nMax+1) * 0.85;
      for(let n=0;n<=nMax;n++){
        const xC = X(n);
        const xL = xC - barW/2;
        const y0 = Y(0);
        const y1 = Y(probs[n]);
        const height = y0 - y1;

        // color emphasis near mean
        const near = Math.abs(n - mu) <= Math.sqrt(Math.max(mu,1));
        ctxP.fillStyle = near ? "rgba(124,247,197,0.80)" : "rgba(125,183,255,0.55)";
        ctxP.fillRect(xL, y1, barW, height);
      }

      // mean marker
      ctxP.strokeStyle = "rgba(255,204,102,0.90)";
      ctxP.lineWidth = 2*dpr;
      ctxP.setLineDash([6*dpr, 6*dpr]);
      ctxP.beginPath();
      ctxP.moveTo(X(mu), py);
      ctxP.lineTo(X(mu), py+ph);
      ctxP.stroke();
      ctxP.setLineDash([]);

      ctxP.fillStyle = "rgba(232,236,255,0.92)";
      ctxP.font = `${Math.max(11, Math.floor(12*dpr))}px ui-sans-serif, system-ui`;
      ctxP.textAlign = "left";
      ctxP.textBaseline = "top";
      ctxP.fillText(`mean μ = n̄(x) = ${formatNum(mu,3)}`, px+10*dpr, py+42*dpr);

      ctxP.fillStyle = "rgba(255,204,102,0.92)";
      ctxP.fillText("dashed line = μ", px+10*dpr, py+62*dpr);

      ctxP.restore();
    }

    // ---------- State + UI ----------
    const ui = {
      alpha: document.getElementById("alpha"),
      d: document.getElementById("d"),
      n0: document.getElementById("n0"),
      xprobe: document.getElementById("xprobe"),
      alphaVal: document.getElementById("alphaVal"),
      dVal: document.getElementById("dVal"),
      n0Val: document.getElementById("n0Val"),
      xVal: document.getElementById("xVal"),
      nOut: document.getElementById("nOut"),
      pSurv: document.getElementById("pSurv"),
      nProbe: document.getElementById("nProbe"),
      diagNote: document.getElementById("diagNote"),
      mainNote: document.getElementById("mainNote"),
      distNote: document.getElementById("distNote"),
    };

    function getState(){
      return {
        alpha: parseFloat(ui.alpha.value),
        d: parseFloat(ui.d.value),
        n0: parseFloat(ui.n0.value),
        xProbe: parseFloat(ui.xprobe.value),
      };
    }

    function syncLabels(state){
      ui.alphaVal.textContent = formatNum(state.alpha, 2);
      ui.dVal.textContent = formatNum(state.d, 2);
      ui.n0Val.textContent = formatNum(state.n0, 1);
      ui.xVal.textContent = formatNum(state.xProbe, 2);

      const nOut = nbarAt(state.d, state.alpha, state.n0);
      const pSurv = Math.exp(-state.alpha * state.d);
      const nProbe = nbarAt(state.xProbe, state.alpha, state.n0);

      ui.nOut.textContent = formatNum(nOut, 4);
      ui.pSurv.textContent = formatNum(pSurv, 6);
      ui.nProbe.textContent = formatNum(nProbe, 4);

      ui.diagNote.textContent = `η(d)=e^{−αd} = ${formatNum(pSurv, 5)}`;
      ui.mainNote.textContent = `n̄(d) = ${formatNum(nOut, 4)}`;
      ui.distNote.textContent = `x = ${formatNum(state.xProbe,2)} cm`;
    }

    function redraw(){
      // enforce xProbe within [0,d]
      const d = parseFloat(ui.d.value);
      ui.xprobe.max = d.toFixed(2);
      if (parseFloat(ui.xprobe.value) > d) ui.xprobe.value = d.toFixed(2);

      const state = getState();
      syncLabels(state);
      drawDiagram(state);
      drawMainPlot(state);
      drawDistPlot(state);
    }

    // Events
    ["input","change"].forEach(evt=>{
      ui.alpha.addEventListener(evt, redraw);
      ui.d.addEventListener(evt, redraw);
      ui.n0.addEventListener(evt, redraw);
      ui.xprobe.addEventListener(evt, redraw);
    });

    // Copy buttons for equations
    document.querySelectorAll(".copyBtn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const id = btn.getAttribute("data-copy");
        const el = document.getElementById(id);
        const text = (el?.textContent ?? "").trim();
        if (!text) return;
        const ok = await copyText(text);
        const old = btn.textContent;
        btn.textContent = ok ? "Copied" : "Copy failed";
        setTimeout(()=>btn.textContent = old, 900);
      });
    });

    // Resize handling
    let resizeTimer = null;
    window.addEventListener("resize", ()=>{
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(redraw, 50);
    });

    // initial
    redraw();
  </script>
</body>
</html>
