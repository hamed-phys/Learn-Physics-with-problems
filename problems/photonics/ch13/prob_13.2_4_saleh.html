<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Photon Statistics of a Coherent Gaussian Beam (TEM00)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#101a33;
      --card2:#0f1730;
      --text:#eaf0ff;
      --muted:#b8c3e6;
      --soft:#94a3d6;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --warn:#fbbf24;
      --ok:#34d399;
      --bad:#fb7185;
      --line: rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --radius: 18px;
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 15%, rgba(167,139,250,.16), transparent 55%),
        radial-gradient(800px 600px at 55% 90%, rgba(52,211,153,.10), transparent 60%),
        linear-gradient(180deg, #070a14 0%, var(--bg) 60%, #070a14 100%);
      line-height:1.55;
      overflow-x:hidden;
    }
    a{color:var(--accent); text-decoration:none;}
    a:hover{text-decoration:underline;}
    header{
      padding:28px 18px 8px;
      max-width:1180px;
      margin:0 auto;
    }
    .title{
      display:flex;
      gap:14px;
      align-items:flex-end;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size:clamp(1.6rem, 2.6vw, 2.4rem);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      font-size:clamp(.95rem, 1.5vw, 1.1rem);
      margin:6px 0 0;
      max-width:70ch;
    }
    .layout{
      max-width:1180px;
      margin:0 auto;
      padding:14px 18px 40px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr;}
    }
    nav.toc{
      position:sticky;
      top:14px;
      align-self:start;
      background:linear-gradient(180deg, rgba(16,26,51,.92), rgba(16,26,51,.72));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px 10px;
      backdrop-filter: blur(10px);
    }
    nav.toc h2{
      font-size:1rem;
      margin:0 0 10px;
      color:var(--text);
      letter-spacing:.2px;
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .toc small{color:var(--muted); font-weight:500;}
    .toc a{
      display:block;
      padding:8px 10px;
      border-radius:12px;
      color:var(--muted);
      border:1px solid transparent;
      transition: .18s ease;
      font-size:.95rem;
    }
    .toc a:hover{
      color:var(--text);
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.08);
      text-decoration:none;
      transform: translateX(1px);
    }
    main{
      min-width:0;
    }
    section, article{
      background: linear-gradient(180deg, rgba(16,26,51,.86), rgba(15,23,48,.72));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      margin-bottom:16px;
      backdrop-filter: blur(10px);
    }
    section h2, section h3, article h2, article h3{
      margin:0 0 10px;
      letter-spacing:.2px;
    }
    section h2, article h2{font-size:1.25rem;}
    section h3, article h3{font-size:1.05rem; color:var(--text); margin-top:14px;}
    .grid2{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 900px){
      .grid2{grid-template-columns:1fr;}
    }
    .callouts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){
      .callouts{grid-template-columns:1fr;}
    }
    .box{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.18);
      padding:12px 12px 10px;
    }
    .box h4{
      margin:0 0 6px;
      font-size:.98rem;
      letter-spacing:.2px;
      display:flex;
      gap:10px;
      align-items:center;
    }
    .tag{
      font-size:.78rem;
      padding:3px 8px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      background: rgba(255,255,255,.04);
    }
    .assump .tag{border-color: rgba(251,191,36,.35); color: #ffe7a3;}
    .keyeq .tag{border-color: rgba(125,211,252,.35); color:#c7f0ff;}
    .mist .tag{border-color: rgba(251,113,133,.35); color:#ffd0da;}
    .final .tag{border-color: rgba(52,211,153,.35); color:#c7ffe8;}
    .eq{
      font-family: var(--mono);
      font-size:.96rem;
      color:#e8f1ff;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      padding:10px 10px 8px;
      border-radius: 14px;
      overflow:auto;
      position:relative;
    }
    .copyRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    button.copy{
      appearance:none;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:.9rem;
      transition:.18s ease;
      user-select:none;
    }
    button.copy:hover{transform: translateY(-1px); background: rgba(255,255,255,.10);}
    button.copy:active{transform: translateY(0px); opacity:.9;}
    .muted{color:var(--muted);}
    ul{margin:8px 0 0 20px;}
    li{margin:4px 0;}
    .kpi{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 900px){
      .kpi{grid-template-columns: repeat(2, 1fr);}
    }
    .kpi .pill{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.14);
      padding:10px 10px 8px;
    }
    .kpi .pill .label{color:var(--muted); font-size:.85rem;}
    .kpi .pill .value{font-family:var(--mono); font-size:1.05rem; margin-top:4px;}
    .controls{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-end;
      margin:10px 0 6px;
      padding:12px;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.14);
    }
    .ctrl{
      min-width: 200px;
      flex: 1 1 240px;
    }
    .ctrl label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-bottom:6px;
      color:var(--muted);
      font-size:.9rem;
    }
    .ctrl .readout{
      font-family: var(--mono);
      color: var(--text);
      font-size:.92rem;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    .canvasGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .canvasGrid{grid-template-columns:1fr;}
    }
    figure{
      margin:0;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 16px;
      background: rgba(0,0,0,.14);
      overflow:hidden;
    }
    figcaption{
      padding:10px 12px 12px;
      color:var(--muted);
      font-size:.92rem;
      border-top:1px solid rgba(255,255,255,.10);
    }
    canvas{
      width:100%;
      height:340px;
      display:block;
    }
    .smallCanvas canvas{height:300px;}
    .foot{
      max-width:1180px;
      margin:0 auto;
      padding:12px 18px 40px;
      color:var(--muted);
      font-size:.92rem;
    }
    .printNote{
      display:none;
    }
    @media print{
      body{background:white; color:black;}
      nav.toc{display:none;}
      section,article{box-shadow:none; backdrop-filter:none; background:white; border:1px solid #ddd;}
      .printNote{display:block; color:#333;}
      button.copy{display:none;}
      .eq{background:#f7f7f7; border-color:#ddd; color:#111;}
      canvas{display:none;}
      figcaption{border-top:none;}
    }
    .fadeIn{
      animation: fade .6s ease both;
    }
    @keyframes fade{
      from{opacity:0; transform: translateY(6px);}
      to{opacity:1; transform: translateY(0);}
    }
  </style>
</head>

<body>
<header class="fadeIn">
  <div class="title">
    <h1>Photon Statistics of a Coherent Gaussian Beam (TEM<sub>00</sub>)</h1>
  </div>
  <p class="subtitle">
    A 100&nbsp;pW single-mode He–Ne laser at 633&nbsp;nm produces a TEM<sub>00</sub> Gaussian beam.
    We compute how many photons cross a circular aperture of radius equal to the waist radius <span class="eq" style="display:inline; padding:2px 6px;">w<sub>0</sub></span> in
    <span class="eq" style="display:inline; padding:2px 6px;">T = 100&nbsp;ns</span>, and use coherent-state (Poisson) photon statistics.
  </p>
</header>

<div class="layout fadeIn">
  <nav class="toc" aria-label="Table of contents">
    <h2>Contents <small>sticky</small></h2>
    <a href="#quick" data-scroll>Quick Summary</a>
    <a href="#part0" data-scroll>PART 0 — Concept Primer</a>
    <a href="#part1" data-scroll>PART 1 — Problem Analysis</a>
    <a href="#part2" data-scroll>PART 2 — Strategy & Tips</a>
    <a href="#part3" data-scroll>PART 3 — Full Solution</a>
    <a href="#part4" data-scroll>PART 4 — Deeper Understanding</a>
    <a href="#part5" data-scroll>PART 5 — Visualization Guide</a>
  </nav>

  <main>

    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>What this is:</b> Photon counting from a weak laser beam through a circular region in a short time window.</li>
        <li><b>Key physics idea:</b> Energy flow (power) determines the <i>mean</i> photon number; a coherent laser field has <b>Poisson</b> photon statistics.</li>
        <li><b>Gaussian beam fact:</b> Fraction of power inside radius <span class="eq" style="display:inline; padding:2px 6px;">r</span> at the waist is
          <span class="eq" style="display:inline; padding:2px 6px;">f(r)=1-e^{-2r^2/w_0^2}</span>.</li>
        <li><b>Photon energy:</b> <span class="eq" style="display:inline; padding:2px 6px;">E_\gamma = hc/\lambda</span>.</li>
        <li><b>Mean photons:</b> <span class="eq" style="display:inline; padding:2px 6px;">\bar N = (P\,T\,f)/E_\gamma</span> (numeric result below).</li>
        <li><b>Statistics:</b> For Poisson, <span class="eq" style="display:inline; padding:2px 6px;">\mathrm{Var}(N)=\bar N</span>, so the RMS number is
          <span class="eq" style="display:inline; padding:2px 6px;">N_\mathrm{rms}=\sqrt{\langle N^2\rangle}=\sqrt{\bar N^2+\bar N}</span>.</li>
        <li><b>Zero-count probability:</b> <span class="eq" style="display:inline; padding:2px 6px;">P(N=0)=e^{-\bar N}</span> (tiny for this case).</li>
      </ul>

      <div class="callouts" style="margin-top:12px;">
        <div class="box keyeq">
          <h4><span class="tag">Key equations</span></h4>
          <div class="copyRow">
            <div class="muted">Copy-ready plain text:</div>
            <button class="copy" data-copy="keyeq">Copy</button>
          </div>
          <pre class="eq" id="keyeq">Gaussian power fraction (waist):  f(r) = 1 - exp(-2 r^2 / w0^2)
Photon energy:                    Eγ = h c / λ
Mean photons in time T:           N̄ = (P T f) / Eγ
Poisson stats (coherent):         P(N=n) = exp(-N̄) N̄^n / n!
Std dev:                          σN = sqrt(N̄)
RMS number:                       Nrms = sqrt(N̄^2 + N̄)
Zero-count probability:           P0 = exp(-N̄)</pre>
        </div>

        <div class="box final">
          <h4><span class="tag">Final numeric results (for r = w0)</span></h4>
          <div class="copyRow">
            <div class="muted">Copy the final answers:</div>
            <button class="copy" data-copy="finalans">Copy</button>
          </div>
          <pre class="eq" id="finalans">Given: P = 100 pW, λ = 633 nm, T = 100 ns, aperture radius r = w0

Power fraction inside r = w0:
f = 1 - exp(-2) = 0.8646647

Photon energy:
Eγ = h c / λ = 3.138145e-19 J

(a) Mean photons:
N̄ = (P T f)/Eγ = 27.55  photons

(b) RMS number (sqrt(<N^2>)):
Nrms = sqrt(N̄^2 + N̄) = 28.05  photons
(standard deviation would be σ = sqrt(N̄) = 5.25 photons)

(c) Probability of zero photons:
P(N=0) = exp(-N̄) = 1.08e-12</pre>
        </div>
      </div>
    </section>

    <article id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div>
          <h3>Core definitions</h3>
          <ul>
            <li><b>Optical power</b> <span class="eq" style="display:inline; padding:2px 6px;">P</span> (W = J/s): energy transported per unit time.</li>
            <li><b>Photon energy</b> <span class="eq" style="display:inline; padding:2px 6px;">E_\gamma</span> (J):
              <span class="eq" style="display:inline; padding:2px 6px;">E_\gamma = h c / \lambda</span>,
              where <span class="eq" style="display:inline; padding:2px 6px;">h</span> is Planck’s constant and <span class="eq" style="display:inline; padding:2px 6px;">c</span> is the speed of light.</li>
            <li><b>Photon rate</b> (photons/s): <span class="eq" style="display:inline; padding:2px 6px;">\dot N = P/E_\gamma</span>.</li>
            <li><b>Mean photon number in a time window</b> <span class="eq" style="display:inline; padding:2px 6px;">T</span>:
              <span class="eq" style="display:inline; padding:2px 6px;">\bar N = \dot N\,T</span> (possibly times a spatial fraction).</li>
            <li><b>TEM<sub>00</sub> Gaussian beam intensity (waist plane)</b>:
              <span class="eq" style="display:inline; padding:2px 6px;">I(r)=I_0 \exp(-2r^2/w_0^2)</span>, where <span class="eq" style="display:inline; padding:2px 6px;">w_0</span> is the waist radius.</li>
          </ul>

          <h3>Physical meaning</h3>
          <ul>
            <li><span class="eq" style="display:inline; padding:2px 6px;">w_0</span> sets the transverse size of the beam: at <span class="eq" style="display:inline; padding:2px 6px;">r=w_0</span>, intensity drops to <span class="eq" style="display:inline; padding:2px 6px;">e^{-2}\approx 0.135</span> of its peak.</li>
            <li>The photon number you count depends on <b>(i)</b> how much energy passes your region (power × time × spatial fraction), and <b>(ii)</b> how much energy each photon carries.</li>
          </ul>

          <h3>Key laws/principles & validity</h3>
          <ul>
            <li><b>Energy conservation / Poynting flux:</b> optical power through an aperture equals the area integral of intensity. Valid for steady propagation in linear optics.</li>
            <li><b>Coherent-state photon statistics:</b> an ideal single-mode laser field is well modeled by a coherent state with <b>Poisson</b> counts:
              <span class="eq" style="display:inline; padding:2px 6px;">P(N=n)=e^{-\bar N}\bar N^n/n!</span>.
              This holds when technical noise is negligible and you measure within a fixed mode/time window.</li>
          </ul>
        </div>

        <div>
          <div class="box assump">
            <h4><span class="tag">Common models/approximations</span></h4>
            <ul>
              <li><b>Single-mode:</b> the beam occupies one spatial mode (TEM<sub>00</sub>) and one frequency (633 nm).</li>
              <li><b>Waist plane snapshot:</b> use the waist intensity profile to compute enclosed power fraction.</li>
              <li><b>Ideal coherent statistics:</b> Poisson distribution (no excess intensity noise).</li>
            </ul>
          </div>

          <h3>Mini intuition examples</h3>
          <ul>
            <li>If you double <span class="eq" style="display:inline; padding:2px 6px;">P</span> or <span class="eq" style="display:inline; padding:2px 6px;">T</span>, you double <span class="eq" style="display:inline; padding:2px 6px;">\bar N</span>.</li>
            <li>Shorter wavelength (higher photon energy) at fixed power gives <b>fewer photons</b> per second.</li>
          </ul>

          <div class="box mist" style="margin-top:12px;">
            <h4><span class="tag">What to watch for</span></h4>
            <ul>
              <li>Don’t confuse the <b>waist radius</b> <span class="eq" style="display:inline; padding:2px 6px;">w_0</span> with a hard beam edge—Gaussian beams have infinite tails.</li>
              <li>Counts in a region require a <b>power fraction</b>, not simply “area × peak intensity.”</li>
              <li>For Poisson, the <b>standard deviation</b> is <span class="eq" style="display:inline; padding:2px 6px;">\sqrt{\bar N}</span>, while the <b>RMS number</b> is <span class="eq" style="display:inline; padding:2px 6px;">\sqrt{\bar N^2+\bar N}</span>.</li>
            </ul>
          </div>
        </div>
      </div>
    </article>

    <article id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Restate the problem</h3>
      <p>
        A 100&nbsp;pW He–Ne laser at 633&nbsp;nm emits a TEM<sub>00</sub> Gaussian beam. Consider the beam waist plane.
        We look at a circular region centered on the beam axis with radius equal to the waist radius <span class="eq" style="display:inline; padding:2px 6px;">w_0</span>.
        Over a time window <span class="eq" style="display:inline; padding:2px 6px;">T=100&nbsp;ns</span>:
        (a) find the mean number of photons crossing that circle,
        (b) find the RMS value of that photon number,
        (c) find the probability that zero photons cross (in that window).
      </p>

      <div class="callouts">
        <div class="box">
          <h4><span class="tag">Given</span></h4>
          <ul>
            <li><span class="eq" style="display:inline; padding:2px 6px;">P = 100&nbsp;pW = 1.0\times10^{-10}\,\text{W}</span></li>
            <li><span class="eq" style="display:inline; padding:2px 6px;">\lambda = 633\,\text{nm}</span></li>
            <li><span class="eq" style="display:inline; padding:2px 6px;">T = 100\,\text{ns} = 1.0\times10^{-7}\,\text{s}</span></li>
            <li>Aperture radius <span class="eq" style="display:inline; padding:2px 6px;">r = w_0</span> (at the waist)</li>
          </ul>
        </div>
        <div class="box">
          <h4><span class="tag">Unknowns</span></h4>
          <ul>
            <li>(a) <span class="eq" style="display:inline; padding:2px 6px;">\bar N</span> (mean photon count)</li>
            <li>(b) <span class="eq" style="display:inline; padding:2px 6px;">N_\mathrm{rms}</span> (RMS of the random variable <span class="eq" style="display:inline; padding:2px 6px;">N</span>)</li>
            <li>(c) <span class="eq" style="display:inline; padding:2px 6px;">P(N=0)</span></li>
          </ul>
        </div>
      </div>

      <h3>Relevant principles & why they apply</h3>
      <ul>
        <li><b>Gaussian spatial power distribution:</b> The TEM<sub>00</sub> profile sets what fraction of the total power passes through a circle of radius <span class="eq" style="display:inline; padding:2px 6px;">r</span>.</li>
        <li><b>Energy-to-photon conversion:</b> In time <span class="eq" style="display:inline; padding:2px 6px;">T</span> the energy through the region is <span class="eq" style="display:inline; padding:2px 6px;">P_\text{region}T</span>; dividing by <span class="eq" style="display:inline; padding:2px 6px;">E_\gamma</span> gives mean photons.</li>
        <li><b>Coherent-state statistics:</b> A (single-mode) ideal laser is modeled as a coherent state, leading to Poisson photon counts in any fixed detection window.</li>
      </ul>

      <div class="box assump" style="margin-top:12px;">
        <h4><span class="tag">Assumptions</span></h4>
        <ul>
          <li>Single spatial mode TEM<sub>00</sub> and narrowband at 633 nm.</li>
          <li>We interpret “crossing a circle” as the power passing through a circular aperture in a plane normal to propagation.</li>
          <li>Stationary power during the 100 ns interval.</li>
          <li>Photon counting is ideal and shot-noise-limited (Poisson).</li>
        </ul>
      </div>

      <h3>Possible approaches (and why one is best)</h3>
      <ul>
        <li><b>Approach A (best):</b> Use known Gaussian enclosed-power fraction <span class="eq" style="display:inline; padding:2px 6px;">f(r)=1-e^{-2r^2/w_0^2}</span>, then compute <span class="eq" style="display:inline; padding:2px 6px;">\bar N</span>, then Poisson stats. <span class="muted">Fast, clean, minimal algebra.</span></li>
        <li><b>Approach B:</b> Start from <span class="eq" style="display:inline; padding:2px 6px;">I(r)=I_0 e^{-2r^2/w_0^2}</span>, integrate over area to get enclosed power, solve for <span class="eq" style="display:inline; padding:2px 6px;">I_0</span> using total power, then proceed. <span class="muted">More steps; same physics.</span></li>
        <li><b>Approach C:</b> Quantum-optical derivation: relate coherent amplitude to mean photon number directly. <span class="muted">Overkill for this numeric photon-count question.</span></li>
      </ul>
      <p><b>We choose Approach A</b> because it isolates the only geometric ingredient (the enclosed-power fraction) and then uses standard coherent-state counting statistics.</p>
    </article>

    <article id="part2">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>
      <ol>
        <li><b>Compute photon energy</b> <span class="eq" style="display:inline; padding:2px 6px;">E_\gamma=hc/\lambda</span>.
          <span class="muted">Goal: convert energy flow into photon flow.</span></li>
        <li><b>Find Gaussian power fraction inside radius</b> <span class="eq" style="display:inline; padding:2px 6px;">r</span>:
          <span class="eq" style="display:inline; padding:2px 6px;">f(r)=1-\exp(-2r^2/w_0^2)</span>.
          <span class="muted">Goal: determine what part of the total power crosses the circle.</span></li>
        <li><b>Compute energy through the circle in time</b> <span class="eq" style="display:inline; padding:2px 6px;">T</span>:
          <span class="eq" style="display:inline; padding:2px 6px;">E_\text{circle}=P\,f\,T</span>.
          <span class="muted">Goal: total Joules in the counting window.</span></li>
        <li><b>Mean photon count</b>:
          <span class="eq" style="display:inline; padding:2px 6px;">\bar N = E_\text{circle}/E_\gamma</span>.
          <span class="muted">Goal: expected number of arrivals.</span></li>
        <li><b>Use Poisson statistics (coherent light)</b>:
          <span class="eq" style="display:inline; padding:2px 6px;">\mathrm{Var}(N)=\bar N</span>,
          <span class="eq" style="display:inline; padding:2px 6px;">P(N=0)=e^{-\bar N}</span>.
          <span class="muted">Goal: quantify fluctuations and the zero-count probability.</span></li>
        <li><b>Interpret “RMS value” carefully</b>:
          <span class="eq" style="display:inline; padding:2px 6px;">N_\mathrm{rms}=\sqrt{\langle N^2\rangle}=\sqrt{\bar N^2+\bar N}</span>.
          <span class="muted">Tip: some texts loosely say “RMS fluctuation” meaning <span class="eq" style="display:inline; padding:2px 6px;">\sigma=\sqrt{\bar N}</span>.</span></li>
      </ol>

      <div class="box mist" style="margin-top:10px;">
        <h4><span class="tag">Common mistakes & quick tips</span></h4>
        <ul>
          <li><b>Mistake:</b> Using total power <span class="eq" style="display:inline; padding:2px 6px;">P</span> instead of the <i>enclosed</i> power <span class="eq" style="display:inline; padding:2px 6px;">P f</span>. <b>Tip:</b> Always multiply by <span class="eq" style="display:inline; padding:2px 6px;">f(r)</span>.</li>
          <li><b>Mistake:</b> Confusing <span class="eq" style="display:inline; padding:2px 6px;">N_\mathrm{rms}</span> with <span class="eq" style="display:inline; padding:2px 6px;">\sigma</span>. <b>Tip:</b> RMS of the random variable includes the mean.</li>
          <li><b>Mistake:</b> Dropping unit conversions (pW, ns, nm). <b>Tip:</b> Convert first; then compute.</li>
        </ul>
      </div>
    </article>

    <article id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Qualitative expectation (before calculating)</h3>
      <p>
        A 100&nbsp;pW beam is extremely weak. Over 100&nbsp;ns the total energy is
        <span class="eq" style="display:inline; padding:2px 6px;">P T = 10^{-10}\times10^{-7}=10^{-17}\,\text{J}</span>.
        A red photon at 633&nbsp;nm has energy on the order of <span class="eq" style="display:inline; padding:2px 6px;">10^{-19}\,\text{J}</span>,
        so we expect on the order of <span class="eq" style="display:inline; padding:2px 6px;">10^{2}</span> photons total, and somewhat fewer through a finite radius.
        Because laser light is well approximated as coherent, the counts should fluctuate with Poisson shot noise:
        relative noise <span class="eq" style="display:inline; padding:2px 6px;">\sigma/\bar N \sim 1/\sqrt{\bar N}</span>.
      </p>

      <div class="callouts">
        <div class="box keyeq">
          <h4><span class="tag">Step 1 — Photon energy</span></h4>
          <p class="muted" style="margin:6px 0 8px;">Define all constants and compute the energy per photon.</p>
          <div class="copyRow">
            <div class="muted">Equation:</div>
            <button class="copy" data-copy="eqE">Copy</button>
          </div>
          <pre class="eq" id="eqE">Eγ = h c / λ</pre>
          <p style="margin:10px 0 0;">
            Using <span class="eq" style="display:inline; padding:2px 6px;">h=6.62607015×10^-34 J·s</span>,
            <span class="eq" style="display:inline; padding:2px 6px;">c=2.99792458×10^8 m/s</span>,
            <span class="eq" style="display:inline; padding:2px 6px;">λ=633×10^-9 m</span>:
          </p>
          <pre class="eq">Eγ = (6.62607015×10^-34)(2.99792458×10^8) / (633×10^-9)
   = 3.138145×10^-19 J</pre>
          <p class="muted">Meaning: each photon “costs” ~3.14×10^-19 joules of energy flow.</p>
        </div>

        <div class="box keyeq">
          <h4><span class="tag">Step 2 — Gaussian enclosed-power fraction</span></h4>
          <p class="muted" style="margin:6px 0 8px;">
            At the waist, intensity is <span class="eq" style="display:inline; padding:2px 6px;">I(r)=I0 exp(-2r^2/w0^2)</span>.
            The power inside radius <span class="eq" style="display:inline; padding:2px 6px;">r</span> is the area integral of intensity.
            The well-known result is:
          </p>
          <div class="copyRow">
            <div class="muted">Equation:</div>
            <button class="copy" data-copy="eqF">Copy</button>
          </div>
          <pre class="eq" id="eqF">f(r) = P(r)/Ptotal = 1 - exp(-2 r^2 / w0^2)</pre>
          <p style="margin:10px 0 0;">
            For the specific aperture <span class="eq" style="display:inline; padding:2px 6px;">r = w0</span>:
          </p>
          <pre class="eq">f(w0) = 1 - exp(-2) = 0.8646647</pre>
          <p class="muted">Meaning: about 86.5% of the total beam power passes through the circle of radius w0 at the waist.</p>
        </div>
      </div>

      <h3>(a) Mean number of photons crossing r = w0 in time T</h3>
      <p>
        The power through the circle is <span class="eq" style="display:inline; padding:2px 6px;">P_\text{circle}=P f</span>.
        The energy in time <span class="eq" style="display:inline; padding:2px 6px;">T</span> is <span class="eq" style="display:inline; padding:2px 6px;">E_\text{circle}=P f T</span>.
        Dividing by the photon energy gives the mean number of photons:
      </p>

      <div class="box keyeq">
        <h4><span class="tag">Mean photon number</span></h4>
        <div class="copyRow">
          <div class="muted">Copy-ready:</div>
          <button class="copy" data-copy="eqNbar">Copy</button>
        </div>
        <pre class="eq" id="eqNbar">N̄ = (P T f) / (h c / λ) = (P T f λ) / (h c)</pre>
      </div>

      <p>Now substitute the numbers (with unit conversions already done):</p>
      <pre class="eq">P = 1.0×10^-10 W
T = 1.0×10^-7  s
f = 0.8646647
Eγ = 3.138145×10^-19 J

Ecircle = P f T = (1.0×10^-10)(0.8646647)(1.0×10^-7) = 8.646647×10^-18 J

N̄ = Ecircle / Eγ = (8.646647×10^-18) / (3.138145×10^-19) = 27.553</pre>

      <div class="box final">
        <h4><span class="tag">Answer (a)</span></h4>
        <p style="margin:8px 0 0;">
          <b>Mean photons through radius <span class="eq" style="display:inline; padding:2px 6px;">w0</span> in <span class="eq" style="display:inline; padding:2px 6px;">100 ns</span>:</b>
          <span class="eq" style="display:inline; padding:2px 6px;">\bar N \approx 27.6</span>.
        </p>
      </div>

      <h3>(b) Root-mean-square value of the photon number</h3>
      <p>
        For a coherent (laser) field, photon counts in a fixed window are Poisson-distributed.
        For Poisson with mean <span class="eq" style="display:inline; padding:2px 6px;">\bar N</span>:
      </p>
      <ul>
        <li><span class="eq" style="display:inline; padding:2px 6px;">\mathrm{Var}(N)=\bar N</span></li>
        <li><span class="eq" style="display:inline; padding:2px 6px;">\langle N^2\rangle = \mathrm{Var}(N) + \langle N\rangle^2 = \bar N + \bar N^2</span></li>
        <li><b>RMS of the number</b> (as asked): <span class="eq" style="display:inline; padding:2px 6px;">N_\mathrm{rms}=\sqrt{\langle N^2\rangle}=\sqrt{\bar N^2+\bar N}</span></li>
      </ul>

      <pre class="eq">N̄ = 27.553
Nrms = sqrt(N̄^2 + N̄) = sqrt(27.553^2 + 27.553) = 28.049</pre>

      <div class="box final">
        <h4><span class="tag">Answer (b)</span></h4>
        <p style="margin:8px 0 0;">
          <b>RMS number:</b> <span class="eq" style="display:inline; padding:2px 6px;">N_\mathrm{rms} \approx 28.05</span>.
          <span class="muted"> (For reference, the standard deviation is <span class="eq" style="display:inline; padding:2px 6px;">\sigma=\sqrt{\bar N}\approx 5.25</span>.)</span>
        </p>
      </div>

      <h3>(c) Probability the photon number is zero</h3>
      <p>
        For a Poisson distribution, the probability of observing exactly zero events is simply:
        <span class="eq" style="display:inline; padding:2px 6px;">P(N=0)=e^{-\bar N}</span>.
      </p>
      <pre class="eq">P0 = exp(-N̄) = exp(-27.553) = 1.0807×10^-12</pre>

      <div class="box final">
        <h4><span class="tag">Answer (c)</span></h4>
        <p style="margin:8px 0 0;">
          <b>Zero-count probability:</b> <span class="eq" style="display:inline; padding:2px 6px;">P(N=0) \approx 1.1\times 10^{-12}</span>.
          <span class="muted">Interpretation: essentially never zero in 100 ns for this power and aperture size.</span>
        </p>
      </div>

      <h3>Sanity checks</h3>
      <ul>
        <li><b>Units:</b> <span class="eq" style="display:inline; padding:2px 6px;">P T</span> has units J; dividing by J/photon gives photons ✔</li>
        <li><b>Limiting cases:</b> If <span class="eq" style="display:inline; padding:2px 6px;">r→0</span>, then <span class="eq" style="display:inline; padding:2px 6px;">f→0</span> and <span class="eq" style="display:inline; padding:2px 6px;">\bar N→0</span> ✔</li>
        <li><b>Large aperture:</b> If <span class="eq" style="display:inline; padding:2px 6px;">r≫w0</span>, then <span class="eq" style="display:inline; padding:2px 6px;">f→1</span> and you count essentially all photons ✔</li>
        <li><b>Order-of-magnitude:</b> Total photons in 100 ns if you captured all power would be
          <span class="eq" style="display:inline; padding:2px 6px;">(PT)/Eγ ≈ 10^-17/3.1×10^-19 ≈ 32</span>.
          Capturing 86.5% gives ~28—consistent with our ~27.6 ✔</li>
      </ul>

      <p class="muted">
        Connection to diagram/plots: the circle at radius <span class="eq" style="display:inline; padding:2px 6px;">r</span> selects a fraction of the Gaussian power.
        Changing <span class="eq" style="display:inline; padding:2px 6px;">r/w0</span> moves the circle and changes <span class="eq" style="display:inline; padding:2px 6px;">f(r)</span>,
        which changes <span class="eq" style="display:inline; padding:2px 6px;">\bar N</span> and therefore the Poisson distribution shown.
      </p>
    </article>

    <article id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpreting the final formulas</h3>
      <ul>
        <li><span class="eq" style="display:inline; padding:2px 6px;">\bar N = (P T/Eγ)\,f(r)</span>:
          <b>P</b> and <b>T</b> scale the total energy in the window; <b>λ</b> sets photon energy; <b>f(r)</b> is purely geometry/mode-shape.</li>
        <li><span class="eq" style="display:inline; padding:2px 6px;">f(r)=1-e^{-2r^2/w0^2}</span>:
          only the dimensionless ratio <span class="eq" style="display:inline; padding:2px 6px;">r/w0</span> matters at the waist.</li>
        <li>Poisson shot noise:
          <span class="eq" style="display:inline; padding:2px 6px;">\sigma=\sqrt{\bar N}</span> means the <i>relative</i> fluctuations are
          <span class="eq" style="display:inline; padding:2px 6px;">\sigma/\bar N = 1/\sqrt{\bar N}</span>. With <span class="eq" style="display:inline; padding:2px 6px;">\bar N≈28</span>,
          relative noise is ~19%.</li>
      </ul>

      <h3>How changing parameters affects outcomes (linked to the interactive plots)</h3>
      <ul>
        <li>Increase <span class="eq" style="display:inline; padding:2px 6px;">r/w0</span> → <span class="eq" style="display:inline; padding:2px 6px;">f</span> rises toward 1 → <span class="eq" style="display:inline; padding:2px 6px;">\bar N</span> increases → Poisson distribution shifts to larger counts and becomes relatively narrower.</li>
        <li>Decrease <span class="eq" style="display:inline; padding:2px 6px;">r/w0</span> → <span class="eq" style="display:inline; padding:2px 6px;">f</span> falls → <span class="eq" style="display:inline; padding:2px 6px;">\bar N</span> drops → probability of small counts (including zero) rises.</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        Instead of using the enclosed-power fraction directly, you can integrate the intensity:
        <span class="eq" style="display:inline; padding:2px 6px;">P(r)=\int_0^r 2\pi r' I_0 e^{-2r'^2/w0^2}\,dr'</span>,
        and use the fact that the total power is
        <span class="eq" style="display:inline; padding:2px 6px;">P=\int_0^\infty 2\pi r' I(r')\,dr'</span>.
        Taking the ratio cancels <span class="eq" style="display:inline; padding:2px 6px;">I_0</span> and yields the same
        <span class="eq" style="display:inline; padding:2px 6px;">f(r)=1-e^{-2r^2/w0^2}</span>.
      </p>

      <h3>Concept checks (with answers)</h3>
      <ul>
        <li><b>Q:</b> If the power doubles, what happens to <span class="eq" style="display:inline; padding:2px 6px;">\bar N</span>?
          <b>A:</b> It doubles (linear in <span class="eq" style="display:inline; padding:2px 6px;">P</span>).</li>
        <li><b>Q:</b> For coherent light, is <span class="eq" style="display:inline; padding:2px 6px;">\sigma</span> larger or smaller than <span class="eq" style="display:inline; padding:2px 6px;">\bar N</span>?
          <b>A:</b> Smaller when <span class="eq" style="display:inline; padding:2px 6px;">\bar N&gt;1</span> because <span class="eq" style="display:inline; padding:2px 6px;">\sigma=\sqrt{\bar N}</span>.</li>
        <li><b>Q:</b> Why is <span class="eq" style="display:inline; padding:2px 6px;">f(w0)</span> not 0.5?
          <b>A:</b> Because Gaussian profiles concentrate most power near the center; the “waist radius” is not a half-power radius.</li>
        <li><b>Q:</b> When can <span class="eq" style="display:inline; padding:2px 6px;">P(N=0)</span> be sizable?
          <b>A:</b> When <span class="eq" style="display:inline; padding:2px 6px;">\bar N \lesssim 1</span> (tiny mean counts).</li>
      </ul>
    </article>

    <article id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <p class="printNote"><b>Print note:</b> canvases are hidden in print view.</p>

      <div class="controls" aria-label="Interactive controls">
        <div class="ctrl">
          <label for="radiusSlider">
            Aperture radius ratio <span class="eq" style="display:inline; padding:2px 6px;">a = r/w0</span>
            <span class="readout" id="aReadout">1.00</span>
          </label>
          <input id="radiusSlider" type="range" min="0" max="2" step="0.01" value="1.00" />
          <div class="muted" style="margin-top:6px;">
            The original problem corresponds to <b>a = 1</b>. Move the slider to explore other radii.
          </div>
        </div>
      </div>

      <div class="kpi" aria-label="Live computed values">
        <div class="pill">
          <div class="label">Power fraction <span class="eq" style="display:inline; padding:2px 6px;">f(a)</span></div>
          <div class="value" id="fVal">0.8647</div>
        </div>
        <div class="pill">
          <div class="label">Mean photons <span class="eq" style="display:inline; padding:2px 6px;">N̄</span></div>
          <div class="value" id="nbarVal">27.55</div>
        </div>
        <div class="pill">
          <div class="label">Std dev <span class="eq" style="display:inline; padding:2px 6px;">σ=√N̄</span></div>
          <div class="value" id="sigmaVal">5.25</div>
        </div>
        <div class="pill">
          <div class="label">Zero prob <span class="eq" style="display:inline; padding:2px 6px;">P0=e^{-N̄}</span></div>
          <div class="value" id="p0Val">1.08e-12</div>
        </div>
      </div>

      <div class="canvasGrid" style="margin-top:12px;">
        <figure>
          <canvas id="diagCanvas" aria-label="Gaussian beam diagram"></canvas>
          <figcaption>
            <b>Diagram:</b> Beam waist cross-section with Gaussian intensity shading. The circle is the aperture radius
            <span class="eq" style="display:inline; padding:2px 6px;">r=a w0</span>; the dashed circle indicates <span class="eq" style="display:inline; padding:2px 6px;">w0</span>.
          </figcaption>
        </figure>

        <figure>
          <canvas id="mainPlot" aria-label="Mean photons vs aperture radius"></canvas>
          <figcaption>
            <b>Main plot:</b> Mean photon number <span class="eq" style="display:inline; padding:2px 6px;">N̄(a)</span> versus aperture ratio
            <span class="eq" style="display:inline; padding:2px 6px;">a=r/w0</span>. Marker shows the current slider value.
          </figcaption>
        </figure>

        <figure class="smallCanvas" style="grid-column: 1 / -1;">
          <canvas id="secPlot" aria-label="Poisson distribution of photon counts"></canvas>
          <figcaption>
            <b>Secondary plot:</b> Poisson probability mass function <span class="eq" style="display:inline; padding:2px 6px;">P(N=n)</span> for the current
            mean <span class="eq" style="display:inline; padding:2px 6px;">N̄</span>. As <span class="eq" style="display:inline; padding:2px 6px;">a</span> increases,
            the distribution shifts right and spreads (with width ≈ <span class="eq" style="display:inline; padding:2px 6px;">√N̄</span>).
          </figcaption>
        </figure>
      </div>

      <div class="box" style="margin-top:12px;">
        <h4><span class="tag">Interactive control behavior</span></h4>
        <ul>
          <li>The slider changes <span class="eq" style="display:inline; padding:2px 6px;">a=r/w0</span>.</li>
          <li>All canvases update live: the diagram circle resizes, the mean-count curve marker moves, and the Poisson distribution recomputes.</li>
          <li>The computed KPI values update consistently with the same symbols used in the text.</li>
        </ul>
      </div>
    </article>

  </main>
</div>

<footer class="foot">
  <div>
    Constants used: <span class="eq" style="display:inline; padding:2px 6px;">h = 6.62607015×10^-34 J·s</span>,
    <span class="eq" style="display:inline; padding:2px 6px;">c = 2.99792458×10^8 m/s</span>,
    <span class="eq" style="display:inline; padding:2px 6px;">λ = 633 nm</span>,
    <span class="eq" style="display:inline; padding:2px 6px;">P = 100 pW</span>,
    <span class="eq" style="display:inline; padding:2px 6px;">T = 100 ns</span>.
  </div>
</footer>

<script>
/* =========================
   Smooth scrolling for TOC
========================= */
document.querySelectorAll('[data-scroll]').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    const id = a.getAttribute('href');
    const el = document.querySelector(id);
    if(!el) return;
    el.scrollIntoView({behavior:'smooth', block:'start'});
  });
});

/* =========================
   Copy buttons
========================= */
function copyTextFrom(el){
  const txt = (typeof el === 'string') ? el : (el?.innerText ?? '');
  navigator.clipboard.writeText(txt).then(()=>{
    // tiny affordance: flash button text
  }).catch(()=>{});
}
document.querySelectorAll('button.copy').forEach(btn=>{
  btn.addEventListener('click', ()=>{
    const id = btn.getAttribute('data-copy');
    const el = document.getElementById(id);
    if(el) copyTextFrom(el.innerText);
  });
});

/* =========================
   Physics model
========================= */
const CONST = {
  h: 6.62607015e-34,          // J s
  c: 2.99792458e8,            // m/s
  lambda: 633e-9,             // m
  P: 100e-12,                 // W
  T: 100e-9                   // s
};
function photonEnergy(){
  return CONST.h * CONST.c / CONST.lambda;
}
function fracPower(a){ // a = r/w0
  return 1 - Math.exp(-2*a*a);
}
function meanPhotons(a){
  const f = fracPower(a);
  return (CONST.P * CONST.T * f) / photonEnergy();
}
function poissonPMF(n, mu){
  if(mu<=0) return (n===0)?1:0;
  // compute log to be stable for moderate n
  // log P = -mu + n log mu - log(n!)
  let logFact = 0;
  for(let k=2;k<=n;k++) logFact += Math.log(k);
  const logP = -mu + n*Math.log(mu) - logFact;
  return Math.exp(logP);
}

/* =========================
   Canvas utilities (HiDPI)
========================= */
function setupCanvas(canvas){
  const ctx = canvas.getContext('2d');
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(2, Math.floor(rect.width * dpr));
    canvas.height = Math.max(2, Math.floor(rect.height * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
    return {w: rect.width, h: rect.height, dpr};
  }
  return {canvas, ctx, resize};
}
function drawGrid(ctx, x0,y0,w,h, xTicks, yTicks){
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.10)';
  ctx.lineWidth = 1;
  for(let i=0;i<=xTicks;i++){
    const x = x0 + (w*i/xTicks);
    ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y0+h); ctx.stroke();
  }
  for(let j=0;j<=yTicks;j++){
    const y = y0 + (h*j/yTicks);
    ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x0+w,y); ctx.stroke();
  }
  ctx.restore();
}
function niceNum(x){
  // simple "engineering-ish" formatting for small/large numbers
  if(x===0) return "0";
  const ax = Math.abs(x);
  if(ax < 1e-3 || ax >= 1e4){
    return x.toExponential(2).replace('e','e');
  }
  if(ax < 1) return x.toFixed(4);
  if(ax < 10) return x.toFixed(3);
  if(ax < 100) return x.toFixed(2);
  return x.toFixed(1);
}

/* =========================
   Plots
========================= */
const diag = setupCanvas(document.getElementById('diagCanvas'));
const main = setupCanvas(document.getElementById('mainPlot'));
const sec  = setupCanvas(document.getElementById('secPlot'));

function drawDiagram(a){
  const {ctx} = diag;
  const {w,h} = diag.resize();
  ctx.clearRect(0,0,w,h);

  // margins
  const pad = 18;
  const cx = w*0.5, cy = h*0.52;
  const R = Math.min(w,h)*0.34; // reference scale ~ w0 in pixels

  // title
  ctx.save();
  ctx.fillStyle = 'rgba(234,240,255,0.95)';
  ctx.font = '600 14px ui-sans-serif, system-ui';
  ctx.fillText('Beam waist cross-section (TEM00): I(r) ∝ exp(-2 r² / w0²)', pad, 20);
  ctx.restore();

  // Gaussian shading: draw concentric rings
  const rings = 140;
  for(let i=rings;i>=1;i--){
    const rr = (i/rings)*R*1.5; // show tails beyond w0
    const rNorm = rr / R; // rr = rNorm*w0
    const I = Math.exp(-2*rNorm*rNorm);
    const alpha = 0.45 * I;
    ctx.beginPath();
    ctx.arc(cx, cy, rr, 0, Math.PI*2);
    ctx.fillStyle = `rgba(125,211,252,${alpha})`;
    ctx.fill();
  }

  // dashed circle for w0
  ctx.save();
  ctx.setLineDash([6,6]);
  ctx.strokeStyle = 'rgba(255,255,255,0.65)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(cx, cy, R, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();

  // aperture circle r = a w0
  const Ra = Math.max(0, a) * R;
  ctx.save();
  ctx.strokeStyle = 'rgba(52,211,153,0.95)';
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.arc(cx, cy, Ra, 0, Math.PI*2);
  ctx.stroke();
  ctx.restore();

  // axis arrows & labels
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.60)';
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(cx- R*1.55, cy); ctx.lineTo(cx+ R*1.55, cy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx, cy+ R*1.55); ctx.lineTo(cx, cy- R*1.55); ctx.stroke();
  ctx.fillStyle = 'rgba(255,255,255,0.75)';
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.fillText('x', cx+ R*1.58, cy-6);
  ctx.fillText('y', cx+ 6, cy- R*1.58);
  ctx.restore();

  // annotations
  ctx.save();
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.fillStyle = 'rgba(234,240,255,0.92)';
  ctx.fillText('dashed: r = w0', pad, h-38);
  ctx.fillStyle = 'rgba(193,255,232,0.92)';
  ctx.fillText(`green: aperture r = a·w0 (a=${a.toFixed(2)})`, pad, h-20);
  ctx.restore();
}

function drawMainPlot(a){
  const {ctx} = main;
  const {w,h} = main.resize();
  ctx.clearRect(0,0,w,h);

  const padL = 54, padR = 16, padT = 30, padB = 44;
  const x0 = padL, y0 = padT;
  const pw = w - padL - padR;
  const ph = h - padT - padB;

  // data range
  const aMin = 0, aMax = 2;
  // compute max Nbar at a=2 for y-range
  const yMax = meanPhotons(2) * 1.08 + 0.5;
  const yMin = 0;

  function X(A){ return x0 + (A-aMin)/(aMax-aMin)*pw; }
  function Y(N){ return y0 + (1-(N-yMin)/(yMax-yMin))*ph; }

  // title
  ctx.save();
  ctx.fillStyle = 'rgba(234,240,255,0.95)';
  ctx.font = '600 14px ui-sans-serif, system-ui';
  ctx.fillText('Main plot: mean photon number N̄ vs aperture ratio a = r/w0', x0, 18);
  ctx.restore();

  // grid
  drawGrid(ctx, x0,y0,pw,ph, 10, 8);

  // axes
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.70)';
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x0,y0+ph); ctx.lineTo(x0+pw,y0+ph); ctx.stroke();
  ctx.restore();

  // ticks & labels
  ctx.save();
  ctx.fillStyle = 'rgba(234,240,255,0.82)';
  ctx.font = '12px ui-sans-serif, system-ui';
  // x ticks
  for(let i=0;i<=10;i++){
    const A = aMin + (aMax-aMin)*i/10;
    const x = X(A);
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255,255,255,0.55)';
    ctx.lineWidth = 1.5;
    ctx.moveTo(x, y0+ph); ctx.lineTo(x, y0+ph+6); ctx.stroke();
    ctx.fillText(A.toFixed(1), x-10, y0+ph+22);
  }
  // y ticks
  for(let j=0;j<=8;j++){
    const N = yMin + (yMax-yMin)*j/8;
    const y = Y(N);
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255,255,255,0.55)';
    ctx.lineWidth = 1.5;
    ctx.moveTo(x0-6, y); ctx.lineTo(x0, y); ctx.stroke();
    ctx.fillText(niceNum(N), 6, y+4);
  }
  // axis labels
  ctx.fillStyle = 'rgba(234,240,255,0.88)';
  ctx.fillText('a = r/w0', x0+pw-52, y0+ph+38);
  ctx.save();
  ctx.translate(16, y0+ph*0.5);
  ctx.rotate(-Math.PI/2);
  ctx.fillText('N̄ (photons in T)', 0, 0);
  ctx.restore();
  ctx.restore();

  // curve
  ctx.save();
  ctx.strokeStyle = 'rgba(125,211,252,0.95)';
  ctx.lineWidth = 3;
  ctx.beginPath();
  const Npts = 250;
  for(let i=0;i<=Npts;i++){
    const A = aMin + (aMax-aMin)*i/Npts;
    const N = meanPhotons(A);
    const x = X(A), y = Y(N);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.restore();

  // marker at current a
  const Nc = meanPhotons(a);
  const xm = X(a), ym = Y(Nc);
  ctx.save();
  ctx.fillStyle = 'rgba(52,211,153,0.95)';
  ctx.strokeStyle = 'rgba(0,0,0,0.45)';
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(xm, ym, 6, 0, Math.PI*2); ctx.fill(); ctx.stroke();
  ctx.fillStyle = 'rgba(234,240,255,0.92)';
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.fillText(`a=${a.toFixed(2)}, N̄=${Nc.toFixed(2)}`, Math.min(x0+pw-140, xm+10), Math.max(y0+14, ym-10));
  ctx.restore();

  // legend
  ctx.save();
  const lx = x0+12, ly = y0+10;
  ctx.fillStyle = 'rgba(0,0,0,0.25)';
  ctx.strokeStyle = 'rgba(255,255,255,0.12)';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.roundRect(lx, ly, 210, 40, 10); ctx.fill(); ctx.stroke();
  ctx.strokeStyle = 'rgba(125,211,252,0.95)';
  ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(lx+12, ly+16); ctx.lineTo(lx+46, ly+16); ctx.stroke();
  ctx.fillStyle = 'rgba(234,240,255,0.9)';
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.fillText('N̄(a) = (P T / Eγ) [1-exp(-2a²)]', lx+52, ly+20);
  ctx.fillStyle = 'rgba(193,255,232,0.95)';
  ctx.fillText('marker = current a', lx+52, ly+36);
  ctx.restore();
}

function drawSecondaryPlot(a){
  const {ctx} = sec;
  const {w,h} = sec.resize();
  ctx.clearRect(0,0,w,h);

  const mu = meanPhotons(a);

  const padL = 54, padR = 16, padT = 30, padB = 44;
  const x0 = padL, y0 = padT;
  const pw = w - padL - padR;
  const ph = h - padT - padB;

  // choose n range around mu
  const nMax = Math.max(12, Math.ceil(mu + 5*Math.sqrt(Math.max(mu,1)))); // show enough tail
  const nMin = 0;

  // compute probabilities for scaling
  const probs = [];
  let pMax = 0;
  for(let n=nMin;n<=nMax;n++){
    const p = poissonPMF(n, mu);
    probs.push(p);
    if(p>pMax) pMax = p;
  }
  const yMax = pMax*1.20 + 1e-6;

  function X(n){ return x0 + (n-nMin)/(nMax-nMin)*pw; }
  function Y(p){ return y0 + (1-(p)/(yMax))*ph; }

  // title
  ctx.save();
  ctx.fillStyle = 'rgba(234,240,255,0.95)';
  ctx.font = '600 14px ui-sans-serif, system-ui';
  ctx.fillText(`Secondary plot: Poisson P(N=n) with mean N̄ = ${mu.toFixed(2)}`, x0, 18);
  ctx.restore();

  // grid
  drawGrid(ctx, x0,y0,pw,ph, 12, 8);

  // axes
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.70)';
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x0,y0+ph); ctx.lineTo(x0+pw,y0+ph); ctx.stroke();
  ctx.restore();

  // ticks & labels
  ctx.save();
  ctx.fillStyle = 'rgba(234,240,255,0.82)';
  ctx.font = '12px ui-sans-serif, system-ui';
  // x ticks at integers
  const xt = 12;
  for(let i=0;i<=xt;i++){
    const n = Math.round(nMin + (nMax-nMin)*i/xt);
    const x = X(n);
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255,255,255,0.55)';
    ctx.lineWidth = 1.5;
    ctx.moveTo(x, y0+ph); ctx.lineTo(x, y0+ph+6); ctx.stroke();
    ctx.fillText(String(n), x-6, y0+ph+22);
  }
  // y ticks
  for(let j=0;j<=8;j++){
    const p = yMax*j/8;
    const y = Y(p);
    ctx.beginPath();
    ctx.strokeStyle = 'rgba(255,255,255,0.55)';
    ctx.lineWidth = 1.5;
    ctx.moveTo(x0-6, y); ctx.lineTo(x0, y); ctx.stroke();
    ctx.fillText(p.toExponential(1), 6, y+4);
  }
  ctx.fillStyle = 'rgba(234,240,255,0.88)';
  ctx.fillText('n (photons)', x0+pw-80, y0+ph+38);
  ctx.save();
  ctx.translate(16, y0+ph*0.5);
  ctx.rotate(-Math.PI/2);
  ctx.fillText('P(N=n)', 0, 0);
  ctx.restore();
  ctx.restore();

  // bars
  ctx.save();
  const barW = pw/(nMax-nMin+1) * 0.72;
  for(let n=nMin;n<=nMax;n++){
    const p = probs[n-nMin];
    const x = X(n) - barW/2;
    const y = Y(p);
    const bh = (y0+ph) - y;
    ctx.fillStyle = 'rgba(167,139,250,0.70)';
    ctx.strokeStyle = 'rgba(255,255,255,0.18)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.roundRect(x, y, barW, bh, 4);
    ctx.fill();
    ctx.stroke();
  }
  ctx.restore();

  // annotate mean & sigma
  ctx.save();
  const sigma = Math.sqrt(Math.max(mu,0));
  ctx.fillStyle = 'rgba(234,240,255,0.92)';
  ctx.font = '12px ui-sans-serif, system-ui';
  const line1 = `σ = √N̄ ≈ ${sigma.toFixed(2)}`;
  const line2 = `P0 = e^{-N̄} ≈ ${Math.exp(-mu).toExponential(2)}`;
  ctx.fillText(line1, x0+12, y0+ph-28);
  ctx.fillText(line2, x0+12, y0+ph-10);
  ctx.restore();

  // legend box
  ctx.save();
  const lx = x0+pw-240, ly = y0+10;
  ctx.fillStyle = 'rgba(0,0,0,0.25)';
  ctx.strokeStyle = 'rgba(255,255,255,0.12)';
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.roundRect(lx, ly, 228, 44, 10); ctx.fill(); ctx.stroke();
  ctx.fillStyle = 'rgba(167,139,250,0.70)';
  ctx.strokeStyle = 'rgba(255,255,255,0.18)';
  ctx.beginPath(); ctx.roundRect(lx+12, ly+14, 18, 12, 3); ctx.fill(); ctx.stroke();
  ctx.fillStyle = 'rgba(234,240,255,0.9)';
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.fillText('bars: P(N=n) = e^{-N̄} N̄^n / n!', lx+38, ly+24);
  ctx.fillText('coherent (Poisson) counting statistics', lx+38, ly+40);
  ctx.restore();
}

/* =========================
   KPI updates
========================= */
function updateKPI(a){
  const f = fracPower(a);
  const mu = meanPhotons(a);
  const sigma = Math.sqrt(Math.max(mu,0));
  const p0 = Math.exp(-mu);

  document.getElementById('aReadout').textContent = a.toFixed(2);
  document.getElementById('fVal').textContent = f.toFixed(4);
  document.getElementById('nbarVal').textContent = mu.toFixed(2);
  document.getElementById('sigmaVal').textContent = sigma.toFixed(2);

  // format p0 nicely
  let p0txt = p0.toExponential(2);
  if(p0 > 1e-3 && p0 < 1e3) p0txt = p0.toFixed(4);
  document.getElementById('p0Val').textContent = p0txt;
}

/* =========================
   Main update loop
========================= */
function renderAll(){
  const a = parseFloat(document.getElementById('radiusSlider').value);
  updateKPI(a);
  drawDiagram(a);
  drawMainPlot(a);
  drawSecondaryPlot(a);
}

document.getElementById('radiusSlider').addEventListener('input', renderAll);
window.addEventListener('resize', renderAll);

// initial render at a=1 (the actual problem)
renderAll();
</script>
</body>
</html>
