<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Momentum of a Photon in a Gaussian Beam (Waist W0): Angular Spread, Probability, and p = E/c?</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1730;
      --card:#121c3a;
      --text:#e9eefc;
      --muted:#b8c3ea;
      --faint:#7f8bb8;
      --accent:#7ee7ff;
      --accent2:#b7ff7e;
      --warn:#ffd37e;
      --danger:#ff7ea6;
      --line:rgba(255,255,255,.12);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 20% -10%, rgba(126,231,255,.18), transparent 55%),
                  radial-gradient(1000px 700px at 110% 10%, rgba(183,255,126,.12), transparent 55%),
                  linear-gradient(180deg, #070a14 0%, #0b1020 40%, #070a14 100%);
      color:var(--text);
      line-height:1.55;
    }
    header{
      padding: 34px 18px 18px;
      max-width: 1180px;
      margin: 0 auto;
    }
    header .title{
      display:flex;
      gap:14px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size: clamp(1.55rem, 2.4vw, 2.35rem);
      letter-spacing:.2px;
    }
    .subtitle{
      margin-top:10px;
      color:var(--muted);
      max-width: 82ch;
      font-size: 1.02rem;
    }

    main{
      max-width:1180px;
      margin:0 auto;
      padding: 12px 18px 64px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      align-items:start;
    }

    nav.toc{
      position:sticky;
      top:12px;
      background: linear-gradient(180deg, rgba(18,28,58,.92), rgba(15,23,48,.78));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px 14px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    .toc h2{
      margin:0 0 10px;
      font-size: .95rem;
      letter-spacing:.3px;
      color: var(--muted);
      text-transform: uppercase;
    }
    .toc a{
      display:block;
      padding:9px 10px;
      border-radius: 12px;
      text-decoration:none;
      color: var(--text);
      border:1px solid transparent;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size:.96rem;
    }
    .toc a:hover{
      background: rgba(126,231,255,.08);
      border-color: rgba(126,231,255,.22);
      transform: translateX(2px);
    }
    .toc .small{
      margin-top:10px;
      padding-top:10px;
      border-top:1px solid var(--line);
      color:var(--faint);
      font-size:.92rem;
    }

    article{
      min-width:0;
    }

    section{
      background: linear-gradient(180deg, rgba(18,28,58,.82), rgba(15,23,48,.72));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow);
      margin-bottom: 16px;
      backdrop-filter: blur(10px);
      transform: translateY(0);
      animation: floatIn .45s ease both;
    }
    @keyframes floatIn{
      from{opacity:0; transform: translateY(8px)}
      to{opacity:1; transform: translateY(0)}
    }
    section h2{
      margin: 0 0 10px;
      font-size: 1.2rem;
      letter-spacing:.2px;
    }
    section h3{
      margin: 14px 0 8px;
      font-size: 1.05rem;
      color: var(--muted);
    }
    p{ margin: 8px 0; color: var(--text); }
    ul{ margin: 8px 0 8px 22px; color: var(--text); }
    li{ margin: 6px 0; }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
      nav.toc{ position:relative; top:auto; }
      .grid2,.grid3{ grid-template-columns: 1fr; }
    }

    .callout{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px 10px;
      background: rgba(255,255,255,.03);
      margin: 10px 0;
    }
    .callout .kicker{
      font-weight:700;
      letter-spacing:.25px;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom:6px;
    }
    .badge{
      font-size:.78rem;
      padding: 2px 8px;
      border-radius: 999px;
      border:1px solid var(--line);
      color:var(--muted);
      background: rgba(0,0,0,.14);
    }
    .assump{ border-color: rgba(183,255,126,.25); }
    .assump .kicker{ color: var(--accent2); }
    .keyeq{ border-color: rgba(126,231,255,.28); }
    .keyeq .kicker{ color: var(--accent); }
    .mist{ border-color: rgba(255,211,126,.30); }
    .mist .kicker{ color: var(--warn); }
    .final{ border-color: rgba(255,126,166,.30); }
    .final .kicker{ color: var(--danger); }

    .eqline{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      padding: 10px 10px;
      border-radius: 14px;
      border:1px dashed rgba(126,231,255,.25);
      background: rgba(126,231,255,.06);
      margin: 10px 0;
    }
    .eq{
      font-family: var(--mono);
      font-size: .96rem;
      color: var(--text);
      white-space: pre-wrap;
      word-break: break-word;
    }
    button.copy{
      cursor:pointer;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      font-size:.9rem;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    button.copy:hover{
      transform: translateY(-1px);
      border-color: rgba(126,231,255,.35);
      background: rgba(126,231,255,.10);
    }
    .tiny{
      color: var(--faint);
      font-size: .92rem;
    }

    .vizWrap{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 12px;
      margin-top: 10px;
      align-items:start;
    }
    @media (max-width: 980px){
      .vizWrap{ grid-template-columns: 1fr; }
    }
    .panel{
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
    }
    canvas{
      width:100%;
      height: 320px;
      display:block;
      border-radius: 14px;
      background: radial-gradient(900px 400px at 30% 15%, rgba(126,231,255,.08), transparent 60%),
                  radial-gradient(700px 400px at 110% 10%, rgba(183,255,126,.06), transparent 55%),
                  rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
    }
    .controls{
      display:grid;
      gap:10px;
    }
    .control{
      border:1px solid var(--line);
      border-radius: 14px;
      padding: 10px 10px 8px;
      background: rgba(255,255,255,.03);
    }
    .control label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      color: var(--muted);
      font-size:.95rem;
      margin-bottom:6px;
    }
    .control input[type="range"]{
      width:100%;
    }
    .control .readout{
      font-family: var(--mono);
      color: var(--text);
      font-size:.92rem;
      white-space:nowrap;
    }
    .pill{
      display:inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--text);
      font-size:.86rem;
      font-family: var(--mono);
    }
    footer{
      max-width:1180px;
      margin: 0 auto;
      padding: 0 18px 44px;
      color: var(--faint);
      font-size:.92rem;
    }
    .printHint{
      margin-top:8px;
      color: var(--faint);
      font-size: .9rem;
    }
    @media print{
      body{ background:#fff; color:#000; }
      nav.toc{ display:none; }
      section{ box-shadow:none; backdrop-filter:none; }
      canvas{ border:1px solid #bbb; background:#fff; }
      button.copy{ display:none; }
      .eqline{ border:1px solid #bbb; background:#fff; }
      .callout{ background:#fff; }
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <div>
      <h1>Momentum of a Photon in a Gaussian Beam: “How directional is a photon?”</h1>
      <p class="subtitle">
        We treat a TEM<sub>00</sub> Gaussian beam at its waist as a superposition of plane waves (angular spectrum).
        That superposition gives a <em>distribution</em> of photon momentum directions. We’ll compute the probability
        that the photon momentum lies inside the beam divergence half-angle &theta;<sub>0</sub>, and then discuss whether
        <span class="pill">p = E / c<sub>0</sub></span> still holds.
      </p>
    </div>
    <div class="tiny">
      <div class="pill">Paraxial optics</div>
      <div class="pill" style="margin-left:6px;">Photon momentum spread</div>
    </div>
  </div>
</header>

<main>
  <nav class="toc" aria-label="Table of contents">
    <h2>Table of Contents</h2>
    <a href="#quick">Quick Summary</a>
    <a href="#part0">PART 0 — Concept Primer</a>
    <a href="#part1">PART 1 — Problem Analysis</a>
    <a href="#part2">PART 2 — Strategy & Tips</a>
    <a href="#part3">PART 3 — Full Solution</a>
    <a href="#part4">PART 4 — Deeper Understanding</a>
    <a href="#part5">PART 5 — Visualization Guide</a>
    <div class="small">
      <div><strong>Interactive</strong>: sliders update the diagram and both plots live.</div>
      <div class="printHint">Tip: print for a clean handout.</div>
    </div>
  </nav>

  <article>
    <!-- Quick Summary -->
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li><strong>What this is about:</strong> A Gaussian beam has a finite waist radius <span class="pill">W<sub>0</sub> (m)</span>, so it cannot have a single propagation direction; its photon momentum directions are spread over angles.</li>
        <li><strong>Key physics idea:</strong> At the waist, the field is Gaussian in position → Gaussian in transverse wavevector <span class="pill">k<sub>t</sub> (m<sup>&minus;1</sup>)</span> via Fourier transform (angular spectrum).</li>
        <li><strong>Governing relation:</strong> For a TEM<sub>00</sub> waist profile <span class="pill">E(r) ∝ exp(−r²/W<sub>0</sub>²)</span>, the transverse wavevector intensity is
          <span class="pill">|A(k<sub>t</sub>)|² ∝ exp(−(W<sub>0</sub>²/2) k<sub>t</sub>²)</span>.
        </li>
        <li><strong>Angle mapping:</strong> With total wavenumber <span class="pill">k = 2π/λ</span>, a plane-wave component at angle &theta; has <span class="pill">k<sub>t</sub> = k sin&theta; ≈ k&theta;</span> (paraxial).</li>
        <li><strong>Probability result (part a):</strong>
          <span class="pill">P(θ ≤ Θ) = 1 − exp(−(kW<sub>0</sub>Θ)²/2)</span>.
          Setting <span class="pill">Θ = θ<sub>0</sub> = λ/(πW<sub>0</sub>)</span> gives
          <span class="pill">P(θ ≤ θ<sub>0</sub>) = 1 − e<sup>−2</sup> ≈ 0.865</span> (about 86.5%).
        </li>
        <li><strong>Part (b) takeaway:</strong> A Gaussian beam photon is not in a single momentum eigenstate; each plane-wave component has <span class="pill">|p|=E/c<sub>0</sub></span>, but the <em>beam’s net longitudinal momentum</em> satisfies
          <span class="pill">&lang;p<sub>z</sub>&rang; = (E/c<sub>0</sub>)&lang;cosθ&rang; &lt; E/c<sub>0</sub></span>.
        </li>
      </ul>
    </section>

    <!-- PART 0 -->
    <section id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <h3>Core definitions (symbols, units)</h3>
      <ul>
        <li><span class="pill">W<sub>0</sub> (m)</span>: beam waist radius (for TEM<sub>00</sub>, typically the 1/e field radius; equivalently 1/e<sup>2</sup> intensity radius).</li>
        <li><span class="pill">λ (m)</span>: free-space wavelength; <span class="pill">k = 2π/λ (m<sup>&minus;1</sup>)</span> is the free-space wavenumber.</li>
        <li><span class="pill">θ</span>: angle a plane-wave component makes with the nominal propagation axis (z-axis).</li>
        <li><span class="pill">k<sub>t</sub> (m<sup>&minus;1</sup>)</span>: transverse (radial) component of the wavevector; <span class="pill">k<sub>t</sub> = √(k<sub>x</sub>²+k<sub>y</sub>²)</span>.</li>
        <li><span class="pill">θ<sub>0</sub></span>: Gaussian beam divergence half-angle (for TEM<sub>00</sub> in paraxial optics):
          <span class="pill">θ<sub>0</sub> = λ/(πW<sub>0</sub>)</span>.
        </li>
        <li><span class="pill">E = ħω</span>: photon energy; in free space, a plane-wave photon has momentum magnitude <span class="pill">p = ħk = E/c<sub>0</sub></span>.</li>
      </ul>

      <h3>Physical meaning (what these quantities represent)</h3>
      <p>
        A perfectly collimated plane wave has a single direction: its wavevector (and photon momentum) points exactly along one axis.
        A Gaussian beam, however, has finite transverse size at the waist. Finite size implies (via Fourier uncertainty) a finite spread of
        transverse spatial frequencies, i.e., a spread in transverse wavevector <span class="pill">k<sub>t</sub></span>, which corresponds to a spread of propagation directions (angles).
      </p>

      <div class="callout keyeq">
        <div class="kicker"><span class="badge">Key idea</span> Fourier duality: width in space ↔ width in angle</div>
        <p class="tiny">
          Narrower waist (smaller <span class="pill">W<sub>0</sub></span>) means larger angular spread; wider waist means tighter directionality.
        </p>
      </div>

      <h3>Key laws/principles and validity</h3>
      <ul>
        <li><strong>Angular spectrum representation:</strong> any paraxial beam can be expressed as a superposition of plane waves with varying transverse wavevectors.</li>
        <li><strong>Paraxial (small-angle) approximation:</strong> for well-collimated Gaussian beams, <span class="pill">sinθ ≈ θ</span>, <span class="pill">cosθ ≈ 1 − θ²/2</span>. Valid when typical θ is small (often milliradians).</li>
        <li><strong>Photon momentum in free space:</strong> plane-wave component obeys <span class="pill">|p|=E/c<sub>0</sub></span>. A beam (wavepacket) can have fixed energy but non-sharp momentum direction.</li>
      </ul>

      <h3>Common models/approximations (and why we use them)</h3>
      <ul>
        <li><strong>TEM<sub>00</sub> Gaussian waist field:</strong> <span class="pill">E(r) ∝ exp(−r²/W<sub>0</sub>²)</span>. This is analytically Fourier-transformable.</li>
        <li><strong>Ignore evanescent components:</strong> We restrict to propagating plane waves with total |k| fixed at <span class="pill">2π/λ</span>. For paraxial beams, almost all spectral weight is propagating.</li>
        <li><strong>Interpretation for photons:</strong> Use the classical field’s angular spectrum as the probability amplitude over photon momentum directions (standard in quantum optics for single-mode beams).</li>
      </ul>

      <h3>Mini intuition examples</h3>
      <ul>
        <li><strong>Big laser spot</strong> (large <span class="pill">W<sub>0</sub></span>): photons are very directional; momentum vectors cluster tightly around +z.</li>
        <li><strong>Tight focus</strong> (small <span class="pill">W<sub>0</sub></span>): photons “fan out” more; transverse momentum components become more likely.</li>
      </ul>

      <div class="callout mist">
        <div class="kicker"><span class="badge">What to watch for</span> Typical pitfalls</div>
        <ul>
          <li>Mixing <em>field</em> Gaussian width definitions (1/e field vs 1/e<sup>2</sup> intensity) can shift constants. Here we use the standard TEM<sub>00</sub> form <span class="pill">E ∝ exp(−r²/W<sub>0</sub>²)</span>, which makes <span class="pill">θ<sub>0</sub>=λ/(πW<sub>0</sub>)</span>.</li>
          <li>For probabilities in 2D angle space, remember the <strong>Jacobian</strong> factor: area element is <span class="pill">2πk<sub>t</sub>dk<sub>t</sub></span> (or <span class="pill">2πθ dθ</span> for small angles).</li>
          <li><span class="pill">p = E/c<sub>0</sub></span> applies to plane waves (momentum eigenstates). For beams, be clear whether you mean <em>component-wise</em> momentum magnitude or the <em>net/average</em> momentum vector.</li>
        </ul>
      </div>
    </section>

    <!-- PART 1 -->
    <section id="part1">
      <h2>PART 1 — Problem Analysis (No solving yet)</h2>

      <h3>Rewrite the problem (in plain words)</h3>
      <p>
        A TEM<sub>00</sub> Gaussian beam has waist radius <span class="pill">W<sub>0</sub></span>, so its photons do not all have momentum exactly along the axis.
        (a) Using the standard divergence half-angle <span class="pill">θ<sub>0</sub></span>, find the probability that a photon’s momentum vector lies within that cone:
        <span class="pill">θ ≤ θ<sub>0</sub></span>. (b) Discuss whether <span class="pill">p = E/c<sub>0</sub></span> still holds for such a photon.
      </p>

      <div class="grid2">
        <div class="callout">
          <div class="kicker"><span class="badge">Given</span> Parameters</div>
          <ul>
            <li>Gaussian beam waist radius <span class="pill">W<sub>0</sub></span></li>
            <li>Free-space wavelength <span class="pill">λ</span> (implicitly, since θ<sub>0</sub> is defined using λ)</li>
            <li>Divergence definition (Sec. 3.1): <span class="pill">θ<sub>0</sub> = λ/(πW<sub>0</sub>)</span></li>
          </ul>
        </div>
        <div class="callout">
          <div class="kicker"><span class="badge">Unknowns</span> What to find</div>
          <ul>
            <li>(a) <span class="pill">P(θ ≤ θ<sub>0</sub>)</span></li>
            <li>(b) Whether <span class="pill">p = E/c<sub>0</sub></span> holds, and in what sense (magnitude vs component/average)</li>
          </ul>
        </div>
      </div>

      <h3>Relevant principles (and why they apply)</h3>
      <ul>
        <li><strong>Angular spectrum / Fourier optics:</strong> At the waist, the transverse field profile determines the distribution of transverse wavevectors. That distribution maps directly to momentum-direction probabilities.</li>
        <li><strong>Rotational symmetry:</strong> TEM<sub>00</sub> is circularly symmetric, so momentum directions depend only on the polar angle &theta;, simplifying the probability integral.</li>
        <li><strong>Paraxial mapping:</strong> For typical Gaussian beams, small-angle approximations connect <span class="pill">k<sub>t</sub></span> and &theta; cleanly.</li>
      </ul>

      <div class="callout assump">
        <div class="kicker"><span class="badge">Assumptions</span> Explicit idealizations</div>
        <ul>
          <li>Fundamental Gaussian mode (TEM<sub>00</sub>) at the waist plane.</li>
          <li>Free-space propagation (refractive index n = 1), so <span class="pill">k = 2π/λ</span> and <span class="pill">|p| = ħk</span> for each plane-wave component.</li>
          <li>Paraxial regime for mapping angles (<span class="pill">sinθ ≈ θ</span>) when deriving simple closed forms.</li>
          <li>Single-photon state whose spatial mode matches the classical Gaussian beam mode (standard quantum-optical correspondence).</li>
        </ul>
      </div>

      <h3>Possible approaches (compare)</h3>
      <ul>
        <li><strong>Approach A: Fourier transform of waist field (best here).</strong> Compute the transverse k-space intensity and integrate inside a cone. Pros: analytic, transparent. Cons: must handle 2D Jacobian correctly.</li>
        <li><strong>Approach B: Use known far-field Gaussian intensity pattern.</strong> Far-field intensity vs angle is Gaussian; integrate in angle space. Pros: quick if you trust the far-field formula. Cons: you still need normalization in 2D.</li>
        <li><strong>Approach C: Uncertainty-principle estimate.</strong> Use ΔxΔk ~ 1 to guess scaling. Pros: intuition. Cons: not an exact probability; misses constants.</li>
      </ul>

      <p><strong>Chosen approach:</strong> Approach A (angular spectrum) because it yields the exact probability with correct constants, and it connects directly to photon momentum distribution.</p>
    </section>

    <!-- PART 2 -->
    <section id="part2">
      <h2>PART 2 — Strategy & Tips (Roadmap only)</h2>
      <ol>
        <li>
          <strong>Write the waist-plane field.</strong><br/>
          <span class="tiny">Goal:</span> specify the spatial mode whose Fourier transform sets the momentum spread.<br/>
          <span class="tiny">Tool:</span> <span class="pill">E(r) ∝ exp(−r²/W<sub>0</sub>²)</span>.<br/>
          <span class="tiny">Meaning:</span> finite waist implies finite transverse spatial frequencies.
        </li>
        <li>
          <strong>Compute (or recall) the 2D Fourier transform.</strong><br/>
          <span class="tiny">Tool:</span> Gaussian transforms to Gaussian in k-space.<br/>
          <span class="tiny">Meaning:</span> get <span class="pill">|A(k<sub>t</sub>)|²</span>.
        </li>
        <li>
          <strong>Normalize the transverse k-space probability distribution.</strong><br/>
          <span class="tiny">Tool:</span> <span class="pill">∫|A|² d²k<sub>t</sub> = 1</span> using polar measure <span class="pill">d²k<sub>t</sub>=2πk<sub>t</sub>dk<sub>t</sub></span>.<br/>
          <span class="tiny">Meaning:</span> interpret |A|² as probability density over directions.
        </li>
        <li>
          <strong>Map k-space radius to angle.</strong><br/>
          <span class="tiny">Tool:</span> <span class="pill">k<sub>t</sub>=k sinθ ≈ kθ</span> (paraxial).<br/>
          <span class="tiny">Meaning:</span> the momentum-direction spread is set by <span class="pill">kW<sub>0</sub></span>.
        </li>
        <li>
          <strong>Integrate the probability inside the cone θ ≤ Θ.</strong><br/>
          <span class="tiny">Tool:</span> cumulative distribution of a 2D Gaussian in radial coordinate.<br/>
          <span class="tiny">Meaning:</span> obtain <span class="pill">P(θ ≤ Θ)</span>.
        </li>
        <li>
          <strong>Insert Θ = θ<sub>0</sub> = λ/(πW<sub>0</sub>).</strong><br/>
          <span class="tiny">Meaning:</span> probability inside the standard divergence half-angle.
        </li>
        <li>
          <strong>Discuss p = E/c<sub>0</sub>.</strong><br/>
          <span class="tiny">Tool:</span> momentum is a distribution; compare <span class="pill">|p|</span> per plane-wave component vs <span class="pill">&lang;p<sub>z</sub>&rang;</span> for the beam.
        </li>
      </ol>

      <div class="callout mist">
        <div class="kicker"><span class="badge">Quick tips</span> Common mistakes to avoid</div>
        <ul>
          <li>Don’t integrate probability in θ as <span class="pill">∫f(θ)dθ</span> without the factor <span class="pill">θ</span> (from 2D solid-angle measure for small θ).</li>
          <li>Be explicit about whether θ<sub>0</sub> refers to a 1/e or 1/e<sup>2</sup> definition; here we use the standard Gaussian-beam divergence <span class="pill">θ<sub>0</sub>=λ/(πW<sub>0</sub>)</span>.</li>
          <li>In part (b), clarify “does p=E/c hold” means: for each plane-wave component yes; for the beam’s <em>net longitudinal</em> momentum no.</li>
        </ul>
      </div>
    </section>

    <!-- PART 3 -->
    <section id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Physical intuition before calculating</h3>
      <p>
        A Gaussian beam at its waist is localized in transverse space to radius ~<span class="pill">W<sub>0</sub></span>.
        Localization implies a spread in transverse wavevector of order <span class="pill">Δk<sub>t</sub> ~ 1/W<sub>0</sub></span>.
        Since angle satisfies <span class="pill">θ ~ k<sub>t</sub>/k</span>, we expect typical angles of order
        <span class="pill">Δθ ~ 1/(kW<sub>0</sub>) ~ λ/(2πW<sub>0</sub>)</span>, consistent with the known divergence scaling.
        So a large fraction—but not all—of the momentum vectors should lie within the standard divergence cone.
      </p>

      <h3>Step 1: Waist-plane field (define all symbols)</h3>
      <p>
        Let the (complex) field amplitude at the waist plane z = 0 be circularly symmetric:
      </p>
      <div class="eqline">
        <div class="eq" id="eq1">E(r) = E0 * exp( - r^2 / W0^2 )
where r = sqrt(x^2 + y^2),  W0 = waist radius,  E0 = constant amplitude.</div>
        <button class="copy" data-copy="#eq1">Copy</button>
      </div>
      <p class="tiny">
        Here <span class="pill">W<sub>0</sub></span> is the Gaussian width parameter at the waist. The overall constant E0 is irrelevant for probabilities (it cancels in normalization).
      </p>

      <h3>Step 2: Angular spectrum (2D Fourier transform)</h3>
      <p>
        The angular spectrum amplitude <span class="pill">A(k<sub>x</sub>,k<sub>y</sub>)</span> is (up to convention factors) the 2D Fourier transform of E(x,y).
        For a Gaussian, the transform is also a Gaussian:
      </p>
      <div class="eqline">
        <div class="eq" id="eq2">A(kx, ky) ∝ exp( - (W0^2/4) * (kx^2 + ky^2) )
Let kt = sqrt(kx^2 + ky^2).</div>
        <button class="copy" data-copy="#eq2">Copy</button>
      </div>
      <p>
        Therefore the k-space <em>intensity</em> (proportional to probability density for momentum components in that mode) is
      </p>
      <div class="eqline">
        <div class="eq" id="eq3">|A(kt)|^2 ∝ exp( - (W0^2/2) * kt^2 )
Define β = W0^2/2.</div>
        <button class="copy" data-copy="#eq3">Copy</button>
      </div>

      <h3>Step 3: Normalize the transverse k-space distribution (2D radial Jacobian)</h3>
      <p>
        Because the distribution is rotationally symmetric in the transverse plane, use polar measure:
        <span class="pill">d²k<sub>t</sub> = 2π k<sub>t</sub> dk<sub>t</sub></span>.
        Choose a normalized density
        <span class="pill">P(kx,ky) = C exp(−β k<sub>t</sub>²)</span>
        such that <span class="pill">∫P d²k<sub>t</sub> = 1</span>.
      </p>
      <p>
        Compute the normalization:
      </p>
      <div class="eqline">
        <div class="eq" id="eq4">1 = ∫ P d^2kt
  = ∫_0^∞ [C exp(-β kt^2)] * (2π kt dkt)
  = 2πC ∫_0^∞ kt exp(-β kt^2) dkt
Let u = β kt^2 ⇒ du = 2β kt dkt
∫_0^∞ kt exp(-β kt^2) dkt = 1/(2β)
So 1 = 2πC * (1/(2β)) = (πC)/β
⇒ C = β/π.</div>
        <button class="copy" data-copy="#eq4">Copy</button>
      </div>

      <p>
        The corresponding <em>radial</em> probability density in k<sub>t</sub> is then
      </p>
      <div class="eqline">
        <div class="eq" id="eq5">p(kt) dkt = [2π kt * P] dkt
= 2π kt * (β/π) exp(-β kt^2) dkt
= 2β kt exp(-β kt^2) dkt.</div>
        <button class="copy" data-copy="#eq5">Copy</button>
      </div>

      <h3>Step 4: Cumulative probability inside a transverse-wavevector radius</h3>
      <p>
        The probability that k<sub>t</sub> lies within 0 ≤ k<sub>t</sub> ≤ K is
      </p>
      <div class="eqline">
        <div class="eq" id="eq6">P(kt ≤ K) = ∫_0^K 2β kt exp(-β kt^2) dkt
Let u = β kt^2 ⇒ du = 2β kt dkt
= ∫_0^{βK^2} exp(-u) du
= 1 - exp(-β K^2).</div>
        <button class="copy" data-copy="#eq6">Copy</button>
      </div>

      <h3>Step 5: Map to angular spread (θ) and compute P(θ ≤ Θ)</h3>
      <p>
        Each plane-wave component has total wavenumber magnitude <span class="pill">k = 2π/λ</span>.
        For a component at polar angle θ relative to +z, the transverse wavenumber is
        <span class="pill">k<sub>t</sub> = k sinθ</span>.
        In the paraxial limit, <span class="pill">sinθ ≈ θ</span>, so <span class="pill">k<sub>t</sub> ≈ kθ</span>.
      </p>
      <p>
        Substitute <span class="pill">K = k sinΘ ≈ kΘ</span> into the cumulative probability:
      </p>
      <div class="eqline">
        <div class="eq" id="eq7">P(θ ≤ Θ) = 1 - exp( -β (k sinΘ)^2 )
Paraxial: ≈ 1 - exp( -β k^2 Θ^2 )
with β = W0^2/2
⇒ P(θ ≤ Θ) ≈ 1 - exp( -(k W0 Θ)^2 / 2 ).</div>
        <button class="copy" data-copy="#eq7">Copy</button>
      </div>

      <div class="callout keyeq">
        <div class="kicker"><span class="badge">Key equation</span> Probability within a cone</div>
        <p class="eq" id="eqKey">P(θ ≤ Θ) = 1 − exp( − (k W0 Θ)^2 / 2 ),   where k = 2π/λ.</p>
        <button class="copy" data-copy="#eqKey">Copy</button>
      </div>

      <h3>Step 6: Evaluate at the Gaussian divergence half-angle θ0</h3>
      <p>
        Using the standard TEM<sub>00</sub> divergence half-angle
        <span class="pill">θ<sub>0</sub> = λ/(πW<sub>0</sub>)</span>,
        compute the dimensionless product:
      </p>
      <div class="eqline">
        <div class="eq" id="eq8">k W0 θ0 = (2π/λ) * W0 * (λ/(πW0)) = 2.</div>
        <button class="copy" data-copy="#eq8">Copy</button>
      </div>
      <p>
        Therefore,
      </p>
      <div class="eqline">
        <div class="eq" id="eq9">P(θ ≤ θ0) = 1 − exp( − (2^2)/2 )
= 1 − exp(−2)
≈ 0.8647.</div>
        <button class="copy" data-copy="#eq9">Copy</button>
      </div>

      <div class="callout final">
        <div class="kicker"><span class="badge">Final answer (a)</span> Probability inside the divergence cone</div>
        <p class="eq" id="finalA">P( momentum direction within θ0 ) = 1 − e^(−2) ≈ 0.865.</p>
        <button class="copy" data-copy="#finalA">Copy</button>
        <p class="tiny">
          Interpretation: about 86.5% of the photon momentum vectors lie within the standard Gaussian divergence half-angle.
        </p>
      </div>

      <h3>Part (b): Does p = E/c0 hold? Explain carefully.</h3>
      <p>
        A single plane wave with frequency ω has a definite wavevector magnitude <span class="pill">k = ω/c<sub>0</sub></span>, hence a photon momentum magnitude
        <span class="pill">|p| = ħk = E/c<sub>0</sub></span>.
        A Gaussian beam, however, is a <em>superposition of plane waves pointing in different directions</em>.
        That means a photon in this spatial mode is not (in general) an eigenstate of the full momentum vector.
      </p>

      <div class="callout keyeq">
        <div class="kicker"><span class="badge">Component-wise truth</span> Each propagating component is still “lightlike”</div>
        <p class="eq" id="eq10">For each plane-wave component: |p| = E/c0,   pz = (E/c0) cosθ,   pt = (E/c0) sinθ.</p>
        <button class="copy" data-copy="#eq10">Copy</button>
      </div>

      <p>
        What changes is the <strong>net/average momentum vector</strong>. Because momentum directions are spread,
        the average longitudinal component is reduced:
      </p>
      <div class="eqline">
        <div class="eq" id="eq11">⟨pz⟩ = (E/c0) ⟨cosθ⟩  <  E/c0
since cosθ < 1 for θ > 0 and the distribution has nonzero weight at θ ≠ 0.</div>
        <button class="copy" data-copy="#eq11">Copy</button>
      </div>

      <div class="callout final">
        <div class="kicker"><span class="badge">Final answer (b)</span> What holds and what does not</div>
        <ul>
          <li><strong>Yes</strong>, <span class="pill">p = E/c<sub>0</sub></span> holds for each plane-wave component (and for the magnitude of a momentum eigenstate).</li>
          <li><strong>No</strong>, you generally do <em>not</em> have the beam’s directed momentum equal to <span class="pill">E/c<sub>0</sub></span> along z: instead <span class="pill">⟨p<sub>z</sub>⟩ = (E/c<sub>0</sub>)⟨cosθ⟩ &lt; E/c<sub>0</sub></span>.</li>
          <li>The photon has definite energy (monochromatic beam) but a <strong>distribution</strong> of momentum directions; momentum is not sharp.</li>
        </ul>
        <p class="eq" id="finalB">Conclusion: p = E/c0 is true for the magnitude of each plane-wave component, but the beam’s net longitudinal momentum is smaller: ⟨pz⟩ < E/c0.</p>
        <button class="copy" data-copy="#finalB">Copy</button>
      </div>

      <h3>Sanity checks</h3>
      <ul>
        <li><strong>Units:</strong> The exponent <span class="pill">(kW<sub>0</sub>Θ)²</span> is dimensionless: k (1/m) × W0 (m) × Θ (rad) → dimensionless.</li>
        <li><strong>Limiting case W0 → ∞:</strong> beam becomes plane-wave-like, angular spread → 0. For any fixed Θ &gt; 0, exponent grows → P → 1.</li>
        <li><strong>Limiting case Θ → 0:</strong> P → 0 as expected.</li>
        <li><strong>Reasonableness:</strong> P(θ ≤ θ0) ≈ 0.865 is “most but not all” inside the conventional divergence cone, consistent with θ0 being a characteristic width (not a hard cutoff).</li>
      </ul>

      <p class="tiny">
        Connection to the diagram/plots: the waist size W0 sets the transverse k-space Gaussian width; the plots visualize
        how the cumulative probability grows with acceptance angle Θ and how θ0 shifts with W0 and λ.
      </p>
    </section>

    <!-- Visualizations (embedded within article, as required) -->
    <section aria-label="Interactive visualizations">
      <h2>Interactive Visualizations</h2>
      <p class="tiny">
        Example values are used only for plotting. The symbolic results above remain general.
      </p>

      <div class="vizWrap">
        <div class="panel">
          <canvas id="canvasDiagram" aria-label="Beam geometry diagram"></canvas>
          <div class="tiny" style="margin-top:8px;">
            Diagram: waist radius <span class="pill">W0</span>, divergence half-angle <span class="pill">θ0</span>, and momentum cone.
          </div>
        </div>

        <div class="panel">
          <div class="controls">
            <div class="control">
              <label>
                W0 (waist radius)
                <span class="readout" id="readW0"></span>
              </label>
              <input id="sliderW0" type="range" min="1" max="400" value="50" step="1" />
              <div class="tiny">Units: micrometers (µm). Larger W0 → narrower angular spread.</div>
            </div>

            <div class="control">
              <label>
                λ (wavelength)
                <span class="readout" id="readLam"></span>
              </label>
              <input id="sliderLam" type="range" min="400" max="1600" value="632" step="1" />
              <div class="tiny">Units: nanometers (nm). Larger λ → larger divergence.</div>
            </div>

            <div class="control">
              <label>
                Θ<sub>acc</sub> (acceptance angle for sweep)
                <span class="readout" id="readAcc"></span>
              </label>
              <input id="sliderAcc" type="range" min="0.1" max="30" value="5" step="0.1" />
              <div class="tiny">
                Units: milliradians (mrad). Used in the parameter-sweep plot and as a marker in the main plot.
              </div>
            </div>

            <div class="control">
              <label>
                Use exact sin(Θ) mapping
                <span class="readout" id="readExact"></span>
              </label>
              <input id="toggleExact" type="checkbox" />
              <div class="tiny">
                If checked, uses <span class="pill">k<sub>t</sub>=k sinΘ</span> instead of paraxial <span class="pill">kΘ</span>. For small angles, both match.
              </div>
            </div>

            <div class="callout keyeq" style="margin:0;">
              <div class="kicker"><span class="badge">Live readout</span> Key quantities</div>
              <div class="tiny" id="liveReadout"></div>
            </div>
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div class="panel">
          <canvas id="canvasMain" aria-label="Main plot: cumulative probability vs angle"></canvas>
          <div class="tiny" style="margin-top:8px;">
            Main plot: cumulative probability <span class="pill">P(θ ≤ Θ)</span> vs angle Θ, with markers at Θ = θ0 and Θ = Θacc.
          </div>
        </div>
        <div class="panel">
          <canvas id="canvasSweep" aria-label="Secondary plot: probability vs waist (parameter sweep)"></canvas>
          <div class="tiny" style="margin-top:8px;">
            Secondary plot: parameter sweep of <span class="pill">P(θ ≤ Θacc)</span> vs waist <span class="pill">W0</span> (with λ fixed by the slider).
          </div>
        </div>
      </div>
    </section>

    <!-- PART 4 -->
    <section id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpret the final formula</h3>
      <p>
        The cumulative probability
        <span class="pill">P(θ ≤ Θ) = 1 − exp(−(kW<sub>0</sub>Θ)²/2)</span>
        depends on the single dimensionless combination <span class="pill">kW<sub>0</sub>Θ</span>.
        That’s telling you: what matters is how many “Fourier widths” fit inside your acceptance angle.
      </p>
      <ul>
        <li><strong>k</strong> (or λ): sets the scale converting angle to transverse spatial frequency.</li>
        <li><strong>W<sub>0</sub></strong>: larger waist → narrower k-space distribution → higher probability inside a given Θ.</li>
        <li><strong>Θ</strong>: acceptance cone; increasing Θ quickly saturates probability toward 1.</li>
      </ul>

      <h3>Why P(θ ≤ θ0) becomes a constant (1 − e<sup>−2</sup>)</h3>
      <p>
        Because θ0 itself is defined as <span class="pill">θ<sub>0</sub> = λ/(πW<sub>0</sub>)</span>, it scales exactly like <span class="pill">1/(kW<sub>0</sub>)</span>.
        When you plug θ0 into the exponent, the parameters cancel, leaving a pure number. In other words, θ0 is a “characteristic width” of the angular distribution.
      </p>

      <h3>How changing parameters affects the outcome (connect to plots)</h3>
      <ul>
        <li>Increase <span class="pill">W<sub>0</sub></span>: the curve <span class="pill">P(θ ≤ Θ)</span> rises more sharply with Θ (narrower spread), and θ0 shifts smaller.</li>
        <li>Increase <span class="pill">λ</span>: the distribution broadens (needs larger Θ to reach the same probability), and θ0 shifts larger.</li>
        <li>For a fixed acceptance angle <span class="pill">Θacc</span>, the sweep plot shows <span class="pill">P</span> increasing with <span class="pill">W<sub>0</sub></span> and decreasing with <span class="pill">λ</span>.</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        Instead of Fourier transforming the waist field, you can start from the known far-field intensity of a Gaussian beam:
        it is Gaussian in angle. By normalizing in 2D angle space (with measure <span class="pill">2πθ dθ</span>), you recover the same cumulative probability form.
      </p>

      <h3>Concept check (self-test)</h3>
      <ul>
        <li><strong>Q:</strong> If W0 doubles while λ is fixed, what happens to θ0? <strong>A:</strong> θ0 halves (θ0 ∝ 1/W0).</li>
        <li><strong>Q:</strong> Why is there a factor θ in the angle probability density? <strong>A:</strong> It’s the Jacobian from 2D rotational symmetry (area element in angle space).</li>
        <li><strong>Q:</strong> Does a Gaussian-beam photon have a single momentum vector? <strong>A:</strong> No; it has a distribution of momentum directions (superposition of plane waves).</li>
        <li><strong>Q:</strong> Can ⟨p⟩ have magnitude less than E/c0 even though each component has |p|=E/c0? <strong>A:</strong> Yes—vector averaging over directions reduces the magnitude (like averaging unit vectors pointing different ways).</li>
      </ul>
    </section>

    <!-- PART 5 -->
    <section id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <h3>What each canvas shows</h3>
      <ul>
        <li><strong>Diagram (top-left):</strong> A Gaussian beam at its waist (radius W0) expanding with divergence half-angle θ0. The shaded cone represents the set of momentum directions with θ ≤ θ0.</li>
        <li><strong>Main plot (bottom-left):</strong> Cumulative probability <span class="pill">P(θ ≤ Θ)</span> vs Θ (in mrad). Two vertical markers:
          <ul>
            <li><span class="pill">Θ = θ0</span> (standard divergence) → probability is ~0.865.</li>
            <li><span class="pill">Θ = Θacc</span> (your chosen acceptance) → shows what fraction passes that cone.</li>
          </ul>
        </li>
        <li><strong>Secondary plot (bottom-right):</strong> Parameter sweep of <span class="pill">P(θ ≤ Θacc)</span> as a function of waist <span class="pill">W0</span> (µm), with λ and Θacc set by sliders. The dot highlights the current W0.</li>
      </ul>

      <h3>Interactive controls</h3>
      <ul>
        <li><strong>W0 slider:</strong> changes the beam waist; updates θ0, the diagram cone, the main cumulative curve, and the sweep marker.</li>
        <li><strong>λ slider:</strong> changes wavelength; updates k, θ0, and both plots.</li>
        <li><strong>Θacc slider:</strong> changes the acceptance angle used for the sweep and adds/updates the Θacc marker in the main plot.</li>
        <li><strong>Exact sin mapping toggle:</strong> switches between <span class="pill">k sinΘ</span> and <span class="pill">kΘ</span>. For small Θ they overlap; differences appear at larger angles.</li>
      </ul>

      <div class="callout mist">
        <div class="kicker"><span class="badge">Reading tip</span> What should change and why</div>
        <p class="tiny">
          If you increase W0, you should see θ0 decrease (narrower cone), and for any fixed Θacc the probability rises.
          If you increase λ, θ0 increases (wider cone), and for a fixed Θacc the probability drops because the distribution broadens.
        </p>
      </div>
    </section>
  </article>
</main>

<footer>
  <p>
    Built as a self-contained learning article (no external libraries). Equations are copyable as plain text.
  </p>
</footer>

<script>
/* ---------- Smooth scroll for TOC ---------- */
document.querySelectorAll('nav.toc a').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    const id = a.getAttribute('href');
    const el = document.querySelector(id);
    if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
  });
});

/* ---------- Copy buttons ---------- */
async function copyTextFromSelector(sel){
  const el = document.querySelector(sel);
  if(!el) return;
  const txt = el.textContent.replace(/\u00A0/g,' ').trim();
  try{
    await navigator.clipboard.writeText(txt);
    return true;
  }catch(err){
    // fallback
    const ta = document.createElement('textarea');
    ta.value = txt;
    ta.style.position='fixed';
    ta.style.left='-9999px';
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand('copy'); }catch(e){}
    document.body.removeChild(ta);
    return true;
  }
}
document.querySelectorAll('button.copy').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const sel = btn.getAttribute('data-copy');
    const ok = await copyTextFromSelector(sel);
    const old = btn.textContent;
    btn.textContent = ok ? 'Copied!' : 'Copy failed';
    setTimeout(()=>btn.textContent=old, 900);
  });
});

/* ---------- Math helpers (no MathJax) ---------- */
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function niceTicks(min,max,target=6){
  // returns array of tick values, and step
  const span = max-min;
  if(span<=0) return {ticks:[min], step:1};
  const raw = span/target;
  const pow = Math.pow(10, Math.floor(Math.log10(raw)));
  const steps = [1,2,5,10];
  let step = steps[0]*pow;
  for(const s of steps){
    const candidate = s*pow;
    if(raw <= candidate){ step = candidate; break; }
    step = candidate;
  }
  const t0 = Math.ceil(min/step)*step;
  const ticks=[];
  for(let t=t0; t<=max+1e-12; t+=step) ticks.push(t);
  return {ticks, step};
}
function fmt(x, digits=3){
  if(!isFinite(x)) return '—';
  const ax = Math.abs(x);
  if(ax>=1000) return x.toFixed(0);
  if(ax>=100) return x.toFixed(1);
  if(ax>=10) return x.toFixed(2);
  if(ax>=1) return x.toFixed(digits);
  return x.toPrecision(3);
}

/* ---------- Canvas utilities (HiDPI crisp) ---------- */
function setupCanvas(canvas){
  const ctx = canvas.getContext('2d');
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(2, Math.floor(rect.width * dpr));
  const h = Math.max(2, Math.floor(rect.height * dpr));
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w; canvas.height = h;
  }
  ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  return {ctx, w: rect.width, h: rect.height, dpr};
}
function clear(ctx,w,h){
  ctx.clearRect(0,0,w,h);
}
function drawGrid(ctx, x0,y0, w,h, xTicks, yTicks, xMap, yMap){
  ctx.save();
  ctx.lineWidth = 1;
  ctx.strokeStyle = 'rgba(255,255,255,0.10)';
  // vertical grid
  xTicks.forEach(t=>{
    const x = xMap(t);
    ctx.beginPath();
    ctx.moveTo(x, y0);
    ctx.lineTo(x, y0+h);
    ctx.stroke();
  });
  // horizontal grid
  yTicks.forEach(t=>{
    const y = yMap(t);
    ctx.beginPath();
    ctx.moveTo(x0, y);
    ctx.lineTo(x0+w, y);
    ctx.stroke();
  });
  ctx.restore();
}
function drawAxes(ctx, x0,y0,w,h, xlabel, ylabel){
  ctx.save();
  ctx.strokeStyle = 'rgba(255,255,255,0.35)';
  ctx.lineWidth = 1.2;
  // axes box
  ctx.strokeRect(x0,y0,w,h);

  ctx.fillStyle = 'rgba(233,238,252,0.85)';
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.textAlign = 'center';
  ctx.fillText(xlabel, x0 + w/2, y0 + h + 30);

  ctx.save();
  ctx.translate(x0 - 34, y0 + h/2);
  ctx.rotate(-Math.PI/2);
  ctx.textAlign = 'center';
  ctx.fillText(ylabel, 0, 0);
  ctx.restore();

  ctx.restore();
}
function drawTicks(ctx, xTicks, yTicks, xMap, yMap, x0,y0,w,h){
  ctx.save();
  ctx.fillStyle = 'rgba(233,238,252,0.80)';
  ctx.font = '11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

  // x ticks
  ctx.textAlign='center';
  ctx.textBaseline='top';
  xTicks.forEach(t=>{
    const x=xMap(t);
    ctx.strokeStyle='rgba(255,255,255,0.30)';
    ctx.beginPath();
    ctx.moveTo(x, y0+h);
    ctx.lineTo(x, y0+h+6);
    ctx.stroke();
    ctx.fillText(fmt(t,3), x, y0+h+8);
  });

  // y ticks
  ctx.textAlign='right';
  ctx.textBaseline='middle';
  yTicks.forEach(t=>{
    const y=yMap(t);
    ctx.strokeStyle='rgba(255,255,255,0.30)';
    ctx.beginPath();
    ctx.moveTo(x0-6, y);
    ctx.lineTo(x0, y);
    ctx.stroke();
    ctx.fillText(fmt(t,3), x0-8, y);
  });

  ctx.restore();
}
function drawTitle(ctx, title, x, y){
  ctx.save();
  ctx.fillStyle = 'rgba(233,238,252,0.92)';
  ctx.font = '600 13px ui-sans-serif, system-ui';
  ctx.textAlign='left';
  ctx.textBaseline='top';
  ctx.fillText(title, x, y);
  ctx.restore();
}
function drawLegend(ctx, items, x, y){
  ctx.save();
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.textAlign='left';
  ctx.textBaseline='middle';
  let yy = y;
  items.forEach(it=>{
    ctx.strokeStyle = it.stroke;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x, yy);
    ctx.lineTo(x+18, yy);
    ctx.stroke();
    ctx.fillStyle = 'rgba(233,238,252,0.86)';
    ctx.fillText(it.label, x+24, yy);
    yy += 18;
  });
  ctx.restore();
}

/* ---------- Physics model ---------- */
/*
At waist: |A(kt)|^2 ∝ exp( -β kt^2 ), with β = W0^2/2.
Normalized cumulative: P(kt<=K)=1-exp(-βK^2).
Angle mapping: K = k sinΘ (exact) or kΘ (paraxial).
So P(θ<=Θ) = 1-exp( - (W0^2/2) * (k*sinΘ)^2 )  (exact mapping)
and paraxial version with sinΘ≈Θ.
Divergence: θ0 = λ/(π W0).
*/
function probWithinTheta(W0, lam, Theta, exact){
  const k = 2*Math.PI/lam;
  const beta = (W0*W0)/2;
  const s = exact ? Math.sin(Theta) : Theta;
  const arg = beta * (k*s)*(k*s);
  // Avoid tiny numerical issues
  return 1 - Math.exp(-clamp(arg, 0, 1e6));
}
function theta0(W0, lam){
  return lam/(Math.PI*W0);
}

/* ---------- State + controls ---------- */
const elW0 = document.getElementById('sliderW0');
const elLam = document.getElementById('sliderLam');
const elAcc = document.getElementById('sliderAcc');
const elExact = document.getElementById('toggleExact');

const readW0 = document.getElementById('readW0');
const readLam = document.getElementById('readLam');
const readAcc = document.getElementById('readAcc');
const readExact = document.getElementById('readExact');
const liveReadout = document.getElementById('liveReadout');

const canvDiagram = document.getElementById('canvasDiagram');
const canvMain = document.getElementById('canvasMain');
const canvSweep = document.getElementById('canvasSweep');

function getParams(){
  const W0_um = parseFloat(elW0.value);
  const lam_nm = parseFloat(elLam.value);
  const acc_mrad = parseFloat(elAcc.value);
  const exact = elExact.checked;

  const W0 = W0_um * 1e-6;
  const lam = lam_nm * 1e-9;
  const acc = acc_mrad * 1e-3;

  return {W0_um, lam_nm, acc_mrad, W0, lam, acc, exact};
}

function updateReadouts(p){
  readW0.textContent = `${p.W0_um.toFixed(0)} µm`;
  readLam.textContent = `${p.lam_nm.toFixed(0)} nm`;
  readAcc.textContent = `${p.acc_mrad.toFixed(1)} mrad`;
  readExact.textContent = p.exact ? 'ON' : 'OFF';

  const th0 = theta0(p.W0, p.lam);
  const Pth0 = probWithinTheta(p.W0, p.lam, th0, p.exact);
  const Pacc = probWithinTheta(p.W0, p.lam, p.acc, p.exact);

  // A gentle estimate for <cosθ> using a small-angle approximation:
  // If θ distribution is Rayleigh-like from 2D Gaussian in kt, then <θ^2> = 1/a with a=(kW0)^2/2 (paraxial).
  // Then <cosθ> ≈ 1 - <θ^2>/2.
  const k = 2*Math.PI/p.lam;
  const a = (k*p.W0)*(k*p.W0)/2;
  const theta2_mean = 1/Math.max(a, 1e-12);
  const cos_mean = 1 - theta2_mean/2;
  const pz_over_Ec = clamp(cos_mean, 0, 1);

  liveReadout.innerHTML =
    `k = <span class="pill">${fmt(k,3)} 1/m</span><br/>
     θ0 = <span class="pill">${fmt(th0*1e3,3)} mrad</span><br/>
     P(θ ≤ θ0) = <span class="pill">${fmt(Pth0,4)}</span> (≈ 1 − e<sup>−2</sup>)<br/>
     P(θ ≤ Θacc) = <span class="pill">${fmt(Pacc,4)}</span><br/>
     Small-angle estimate: ⟨pz⟩/(E/c0) ≈ <span class="pill">${fmt(pz_over_Ec,4)}</span>`;
}

/* ---------- Drawing: Diagram ---------- */
function drawDiagram(p){
  const {ctx, w, h} = setupCanvas(canvDiagram);
  clear(ctx,w,h);

  const pad = 14;
  drawTitle(ctx, 'Diagram: Gaussian waist and momentum cone', pad, pad);

  // Coordinate system in diagram
  const x0 = pad;
  const y0 = pad + 22;
  const W = w - 2*pad;
  const H = h - (pad + 22) - pad;

  // Define a simple beam axis and cone
  const cx = x0 + W*0.25;
  const cy = y0 + H*0.55;
  const axisLen = W*0.62;

  const th0 = theta0(p.W0, p.lam);
  const thDraw = clamp(th0, 0, 0.30); // cap for drawing (~17 deg)
  const coneHalfWidth = Math.tan(thDraw) * axisLen;

  // Draw axis
  ctx.save();
  ctx.strokeStyle = 'rgba(233,238,252,0.6)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx+axisLen, cy);
  ctx.stroke();

  // Axis arrow
  ctx.beginPath();
  ctx.moveTo(cx+axisLen, cy);
  ctx.lineTo(cx+axisLen-10, cy-6);
  ctx.lineTo(cx+axisLen-10, cy+6);
  ctx.closePath();
  ctx.fillStyle = 'rgba(233,238,252,0.6)';
  ctx.fill();
  ctx.restore();

  // Draw cone (momentum directions within θ0)
  ctx.save();
  ctx.fillStyle = 'rgba(126,231,255,0.10)';
  ctx.strokeStyle = 'rgba(126,231,255,0.55)';
  ctx.lineWidth = 2;

  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx+axisLen, cy - coneHalfWidth);
  ctx.lineTo(cx+axisLen, cy + coneHalfWidth);
  ctx.closePath();
  ctx.fill();
  ctx.stroke();
  ctx.restore();

  // Draw waist (Gaussian cross-section)
  // Represent W0 as a vertical radius at the start
  const waistPix = clamp((p.W0_um/400)*H*0.30 + 18, 22, H*0.35);
  ctx.save();
  ctx.strokeStyle = 'rgba(183,255,126,0.70)';
  ctx.lineWidth = 2;
  // waist line
  ctx.beginPath();
  ctx.moveTo(cx, cy - waistPix);
  ctx.lineTo(cx, cy + waistPix);
  ctx.stroke();
  // little ticks
  ctx.beginPath();
  ctx.moveTo(cx-8, cy - waistPix);
  ctx.lineTo(cx+8, cy - waistPix);
  ctx.moveTo(cx-8, cy + waistPix);
  ctx.lineTo(cx+8, cy + waistPix);
  ctx.stroke();
  // label
  ctx.fillStyle = 'rgba(233,238,252,0.85)';
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.textAlign = 'left';
  ctx.fillText(`waist radius W0`, cx + 10, cy - waistPix - 6);
  ctx.fillStyle = 'rgba(183,255,126,0.85)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
  ctx.fillText(`${p.W0_um.toFixed(0)} µm`, cx + 10, cy - waistPix + 10);
  ctx.restore();

  // Draw divergence angle label
  ctx.save();
  ctx.strokeStyle = 'rgba(255,211,126,0.8)';
  ctx.lineWidth = 2;
  // small arc
  const arcR = 46;
  ctx.beginPath();
  ctx.arc(cx+34, cy, arcR, -thDraw, thDraw);
  ctx.stroke();

  ctx.fillStyle = 'rgba(255,211,126,0.9)';
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.fillText(`θ0`, cx+34 + arcR + 6, cy - 2);

  ctx.fillStyle = 'rgba(233,238,252,0.85)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
  ctx.fillText(`${fmt(th0*1e3,3)} mrad`, cx+34 + arcR + 6, cy + 16);
  ctx.restore();

  // Note about momentum vectors
  ctx.save();
  ctx.fillStyle = 'rgba(233,238,252,0.80)';
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.textAlign = 'left';
  ctx.fillText('Photon momentum directions populate this cone (not a single vector).', x0+8, y0+H-18);
  ctx.restore();
}

/* ---------- Drawing: Main plot (Cumulative P vs Θ) ---------- */
function drawMainPlot(p){
  const {ctx, w, h} = setupCanvas(canvMain);
  clear(ctx,w,h);

  const pad = 14;
  drawTitle(ctx, 'Main Plot: Cumulative probability  P(θ ≤ Θ)', pad, pad);

  const x0 = pad + 52;
  const y0 = pad + 30;
  const W = w - x0 - pad;
  const H = h - y0 - 54;

  const th0 = theta0(p.W0, p.lam);
  // Choose x-range up to max(6*θ0, Θacc*1.5) but capped
  const xmax = clamp(Math.max(6*th0, 1.5*p.acc), 2e-3, 60e-3); // rad
  const xmin = 0;

  const ymin = 0, ymax = 1;

  const xTicks = niceTicks(xmin*1e3, xmax*1e3, 6).ticks; // mrad
  const yTicks = niceTicks(ymin, ymax, 5).ticks;

  const xMap = (xmrad)=> x0 + (xmrad - xmin*1e3)/(xmax*1e3 - xmin*1e3) * W;
  const yMap = (y)=> y0 + (1 - (y - ymin)/(ymax - ymin)) * H;

  // Grid + axes
  drawGrid(ctx, x0,y0,W,H, xTicks, yTicks, xMap, yMap);
  drawAxes(ctx, x0,y0,W,H, 'Θ (mrad)', 'P(θ ≤ Θ)');
  drawTicks(ctx, xTicks, yTicks, xMap, yMap, x0,y0,W,H);

  // Curve
  ctx.save();
  ctx.strokeStyle = 'rgba(126,231,255,0.95)';
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  const N = 300;
  for(let i=0;i<=N;i++){
    const Theta = xmin + (xmax-xmin)*(i/N);
    const P = probWithinTheta(p.W0, p.lam, Theta, p.exact);
    const x = xMap(Theta*1e3);
    const y = yMap(P);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.restore();

  // Markers at θ0 and Θacc
  function drawVLine(Theta, label, color){
    const xmrad = Theta*1e3;
    const x = xMap(xmrad);
    ctx.save();
    ctx.strokeStyle = color;
    ctx.lineWidth = 2;
    ctx.setLineDash([6,5]);
    ctx.beginPath();
    ctx.moveTo(x, y0);
    ctx.lineTo(x, y0+H);
    ctx.stroke();
    ctx.setLineDash([]);

    const P = probWithinTheta(p.W0, p.lam, Theta, p.exact);
    const y = yMap(P);
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x, y, 4.2, 0, 2*Math.PI);
    ctx.fill();

    ctx.fillStyle = 'rgba(233,238,252,0.88)';
    ctx.font = '12px ui-sans-serif, system-ui';
    ctx.textAlign = 'left';
    ctx.textBaseline = 'bottom';
    ctx.fillText(`${label}: ${fmt(xmrad,3)} mrad, P=${fmt(P,4)}`, x+6, y-6);
    ctx.restore();
  }

  drawVLine(th0, 'θ0', 'rgba(255,211,126,0.95)');
  drawVLine(p.acc, 'Θacc', 'rgba(183,255,126,0.95)');

  // Legend
  drawLegend(ctx, [
    {stroke:'rgba(126,231,255,0.95)', label:'P(θ ≤ Θ)'},
    {stroke:'rgba(255,211,126,0.95)', label:'Θ = θ0'},
    {stroke:'rgba(183,255,126,0.95)', label:'Θ = Θacc'}
  ], x0+10, y0+14);
}

/* ---------- Drawing: Sweep plot P(θ≤Θacc) vs W0 ---------- */
function drawSweepPlot(p){
  const {ctx, w, h} = setupCanvas(canvSweep);
  clear(ctx,w,h);

  const pad = 14;
  drawTitle(ctx, 'Secondary Plot: Sweep  P(θ ≤ Θacc)  vs  W0', pad, pad);

  const x0 = pad + 58;
  const y0 = pad + 30;
  const W = w - x0 - pad;
  const H = h - y0 - 54;

  // Sweep W0 from 1 to 400 µm (matching slider)
  const W0min_um = 1;
  const W0max_um = 400;

  const xmin = W0min_um, xmax = W0max_um;
  const ymin = 0, ymax = 1;

  const xTicks = niceTicks(xmin, xmax, 5).ticks;
  const yTicks = niceTicks(ymin, ymax, 5).ticks;

  const xMap = (x)=> x0 + (x - xmin)/(xmax - xmin) * W;
  const yMap = (y)=> y0 + (1 - (y - ymin)/(ymax - ymin)) * H;

  drawGrid(ctx, x0,y0,W,H, xTicks, yTicks, xMap, yMap);
  drawAxes(ctx, x0,y0,W,H, 'W0 (µm)', 'P(θ ≤ Θacc)');
  drawTicks(ctx, xTicks, yTicks, xMap, yMap, x0,y0,W,H);

  // Curve
  ctx.save();
  ctx.strokeStyle = 'rgba(183,255,126,0.95)';
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  const N = 320;
  for(let i=0;i<=N;i++){
    const W0_um = xmin + (xmax-xmin)*(i/N);
    const W0 = W0_um*1e-6;
    const P = probWithinTheta(W0, p.lam, p.acc, p.exact);
    const x = xMap(W0_um);
    const y = yMap(P);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.restore();

  // Current W0 marker
  const Pcur = probWithinTheta(p.W0, p.lam, p.acc, p.exact);
  const xcur = xMap(p.W0_um);
  const ycur = yMap(Pcur);
  ctx.save();
  ctx.fillStyle = 'rgba(255,211,126,0.95)';
  ctx.beginPath();
  ctx.arc(xcur, ycur, 5.2, 0, 2*Math.PI);
  ctx.fill();

  ctx.fillStyle = 'rgba(233,238,252,0.88)';
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.textAlign = 'left';
  ctx.textBaseline = 'bottom';
  ctx.fillText(`current: W0=${p.W0_um.toFixed(0)} µm → P=${fmt(Pcur,4)}`, xcur+8, ycur-6);
  ctx.restore();

  // Legend
  drawLegend(ctx, [
    {stroke:'rgba(183,255,126,0.95)', label:'Sweep curve'},
    {stroke:'rgba(255,211,126,0.95)', label:'Current W0'}
  ], x0+10, y0+14);
}

/* ---------- Main render loop ---------- */
function render(){
  const p = getParams();
  updateReadouts(p);
  drawDiagram(p);
  drawMainPlot(p);
  drawSweepPlot(p);
}
['input','change'].forEach(evt=>{
  elW0.addEventListener(evt, render);
  elLam.addEventListener(evt, render);
  elAcc.addEventListener(evt, render);
  elExact.addEventListener(evt, render);
});
window.addEventListener('resize', render);

/* ---------- Init ---------- */
render();
</script>
</body>
</html>
