<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gaussian Beam Refraction at a Planar Interface (Normal Incidence)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#121a33;
      --card2:#0f1730;
      --text:#e9eeff;
      --muted:#b9c2e6;
      --accent:#7aa7ff;
      --accent2:#7dffcf;
      --warn:#ffd27a;
      --ok:#9bff7a;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 30% -10%, rgba(122,167,255,.22), transparent 55%),
                  radial-gradient(1000px 650px at 85% 10%, rgba(125,255,207,.16), transparent 60%),
                  linear-gradient(180deg, #070a14 0%, var(--bg) 100%);
      color:var(--text);
      line-height:1.55;
    }
    header{
      padding:28px 18px 10px;
      max-width:1100px;
      margin:0 auto;
    }
    .title{
      display:grid;
      gap:10px;
      align-items:start;
    }
    h1{
      margin:0;
      font-size: clamp(1.5rem, 2.2vw + 1rem, 2.6rem);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      font-size:1.02rem;
      max-width: 78ch;
    }

    main{
      max-width:1100px;
      margin:0 auto;
      padding: 12px 18px 60px;
      display:grid;
      grid-template-columns: 1fr;
      gap:18px;
    }

    .layout{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
    }

    nav.toc{
      position: sticky;
      top: 14px;
      align-self:start;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px 10px;
      backdrop-filter: blur(8px);
    }
    nav.toc h2{
      margin:0 0 10px;
      font-size: .98rem;
      color: var(--text);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    nav.toc .mini{
      font-size:.78rem;
      color: var(--muted);
    }
    nav.toc a{
      display:block;
      padding:8px 10px;
      border-radius: 12px;
      color: var(--muted);
      text-decoration:none;
      font-size:.95rem;
      border: 1px solid transparent;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    nav.toc a:hover{
      background: rgba(122,167,255,.12);
      border-color: rgba(122,167,255,.25);
      color: var(--text);
      transform: translateY(-1px);
    }

    section.card, article.card{
      background: linear-gradient(180deg, rgba(255,255,255,.07), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      overflow:hidden;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid2{grid-template-columns:1fr}
    }

    .callouts{
      display:grid;
      grid-template-columns: repeat(3, 1fr);
      gap:12px;
    }
    @media (max-width: 980px){
      .callouts{grid-template-columns:1fr}
    }
    .callout{
      background: linear-gradient(180deg, rgba(18,26,51,.8), rgba(18,26,51,.45));
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 14px;
      box-shadow: 0 10px 22px rgba(0,0,0,.25);
    }
    .callout h3{
      margin:0 0 6px;
      font-size: .98rem;
    }
    .callout p{margin:0;color:var(--muted);font-size:.94rem}

    h2{
      margin:0 0 10px;
      font-size: 1.3rem;
    }
    h3{
      margin:14px 0 8px;
      font-size: 1.08rem;
      color: var(--text);
    }
    p{margin:10px 0;color: var(--text)}
    ul{margin:10px 0 10px 18px;color: var(--muted)}
    li{margin:6px 0}
    .muted{color:var(--muted)}
    .eqrow{
      display:flex;
      align-items:center;
      gap:10px;
      flex-wrap:wrap;
      padding:10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      margin:10px 0;
    }
    .eq{
      font-family: var(--mono);
      font-size: .98rem;
      color: #f3f6ff;
      white-space: nowrap;
    }
    .copybtn{
      margin-left:auto;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(122,167,255,.10);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:.88rem;
      transition: transform .12s ease, background .12s ease;
    }
    .copybtn:hover{transform: translateY(-1px); background: rgba(122,167,255,.18)}
    .copybtn:active{transform: translateY(0px)}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size:.86rem;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.20);
      color: var(--muted);
    }
    .pill b{color: var(--text)}
    .hr{
      height:1px;
      background: var(--line);
      margin: 12px 0;
    }
    .answerBox{
      border-radius: 18px;
      border:1px solid rgba(125,255,207,.25);
      background: linear-gradient(180deg, rgba(125,255,207,.12), rgba(0,0,0,.18));
      padding: 14px;
      margin-top: 12px;
    }
    .answerBox .big{
      font-size: 1.15rem;
      font-family: var(--mono);
      color: #eafff7;
      margin: 6px 0 0;
      overflow-wrap:anywhere;
    }
    .badge{
      display:inline-block;
      padding: 4px 10px;
      border-radius: 999px;
      font-size:.8rem;
      background: rgba(125,255,207,.16);
      border:1px solid rgba(125,255,207,.28);
      color: #d8fff2;
    }

    figure{
      margin: 0;
    }
    .vizGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .canvasCard{
      background: linear-gradient(180deg, rgba(18,26,51,.75), rgba(18,26,51,.35));
      border:1px solid rgba(255,255,255,.10);
      border-radius: 18px;
      padding: 12px;
      overflow:hidden;
    }
    .canvasHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap:12px;
      margin-bottom: 8px;
    }
    .canvasHeader h3{margin:0;font-size:1.02rem}
    .canvasHeader p{margin:0;color:var(--muted);font-size:.9rem;max-width:70ch}
    canvas{
      width:100%;
      height: 340px;
      display:block;
      border-radius: 14px;
      background: rgba(6,10,22,.55);
      border:1px solid rgba(255,255,255,.08);
    }
    @media (max-width: 680px){
      canvas{height: 300px;}
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin: 10px 0 6px;
    }
    @media (max-width: 980px){
      .controls{grid-template-columns:1fr}
    }
    .control{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 16px;
      padding: 12px;
    }
    .control label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:.92rem;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .control label span.val{
      color: var(--text);
      font-family: var(--mono);
    }
    input[type="range"]{
      width:100%;
    }
    .note{
      color: var(--muted);
      font-size: .92rem;
    }

    footer{
      max-width:1100px;
      margin: 0 auto;
      padding: 20px 18px 40px;
      color: var(--muted);
      font-size: .9rem;
    }

    /* print */
    @media print{
      body{background:#fff;color:#000}
      nav.toc{display:none}
      section.card, article.card{box-shadow:none;border:1px solid #ddd;background:#fff}
      canvas{border:1px solid #ccc;background:#fff}
      .copybtn{display:none}
      .pill{border:1px solid #ccc;background:#fff}
      .answerBox{border:1px solid #0a7;background:#f3fffb}
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <h1>3.2-8 Beam Refraction: Gaussian Beam at a Planar Interface (Normal Incidence)</h1>
    <div class="subtitle">
      A Gaussian beam goes from air (<span class="eq">n<sub>1</sub>=1</span>) into a dielectric (<span class="eq">n<sub>2</sub>=1.5</span>) through a planar boundary.
      The beam axis is normal to the interface and the waist sits exactly at the boundary. We determine how the transmitted beam “looks”
      and compute its angular divergence in the medium.
    </div>
  </div>
</header>

<main>
  <div class="layout">
    <nav class="toc" aria-label="Table of contents">
      <h2>
        <span>On this page</span>
        <span class="mini">sticky TOC</span>
      </h2>
      <a href="#quick" data-scroll>Quick Summary</a>
      <a href="#part1" data-scroll>PART 1 — Problem Analysis</a>
      <a href="#part2" data-scroll>PART 2 — Strategy & Tips</a>
      <a href="#part3" data-scroll>PART 3 — Full Solution</a>
      <a href="#viz" data-scroll>Interactive Visualizations</a>
      <a href="#checks" data-scroll>Sanity Checks</a>
    </nav>

    <div class="content">
      <section class="card" id="quick">
        <h2>Quick Summary</h2>
        <div class="callouts">
          <div class="callout">
            <h3>Key idea</h3>
            <p>The waist at the interface has the same <span class="eq">w<sub>0</sub></span> on both sides (transverse profile matches at <span class="eq">z=0</span>).</p>
          </div>
          <div class="callout">
            <h3>What changes</h3>
            <p>Wavelength inside the medium shrinks: <span class="eq">&lambda;<sub>2</sub>=&lambda;<sub>0</sub>/n<sub>2</sub></span>.</p>
          </div>
          <div class="callout">
            <h3>Result</h3>
            <p>Divergence scales inversely with refractive index:
              <span class="eq">&theta;<sub>2</sub>=&theta;<sub>1</sub>(n<sub>1</sub>/n<sub>2</sub>)</span>.</p>
          </div>
        </div>

        <div class="hr"></div>

        <div class="eqrow">
          <div class="eq" id="eq1">Gaussian beam divergence (small angle):  &theta; = &lambda; / (&pi; w<sub>0</sub>)</div>
          <button class="copybtn" data-copy="Gaussian beam divergence (small angle): theta = lambda/(pi*w0)">Copy</button>
        </div>

        <div class="answerBox">
          <span class="badge">Final numeric answer</span>
          <div class="big" id="finalPlain">Given &theta;₁ = 1 mrad in air and n₂ = 1.5:  &theta;₂ = (1/1.5) mrad ≈ 0.667 mrad.</div>
          <div style="display:flex;gap:10px;flex-wrap:wrap;margin-top:10px;">
            <button class="copybtn" data-copy="theta2 = theta1*(n1/n2) = 1 mrad*(1/1.5) = 0.667 mrad">Copy final answer</button>
            <span class="pill"><b>Sketch:</b> transmitted beam spreads more slowly (smaller divergence), longer Rayleigh range</span>
          </div>
        </div>
      </section>

      <article class="card" id="part1">
        <h2>PART 1 — Problem Analysis (no solving yet)</h2>

        <h3>Restate the problem (in my own words)</h3>
        <p class="muted">
          A Gaussian beam travels along the normal direction and hits a flat interface from air into a material with refractive index
          <span class="eq">n<sub>2</sub>=1.5</span>. The beam waist is located exactly at the interface. We want a qualitative sketch of the transmitted beam and,
          given that the beam’s angular divergence in air is <span class="eq">1 mrad</span>, find the angular divergence in the medium.
        </p>

        <h3>Given quantities</h3>
        <ul>
          <li>Incident medium: air, <span class="eq">n<sub>1</sub>=1</span></li>
          <li>Transmitted medium: <span class="eq">n<sub>2</sub>=1.5</span></li>
          <li>Normal incidence (beam axis perpendicular to interface)</li>
          <li>Beam waist at the boundary (<span class="eq">z=0</span>)</li>
          <li>Angular divergence in air: <span class="eq">&theta;<sub>1</sub>=1 mrad</span> (small-angle)</li>
        </ul>

        <h3>Unknowns</h3>
        <ul>
          <li>Qualitative form (“sketch”) of the transmitted beam</li>
          <li>Angular divergence in the medium: <span class="eq">&theta;<sub>2</sub> = ?</span></li>
        </ul>

        <h3>What must be found/proved</h3>
        <ul>
          <li>How Gaussian-beam divergence transforms across a planar interface at normal incidence</li>
          <li>Compute <span class="eq">&theta;<sub>2</sub></span> numerically for <span class="eq">n<sub>2</sub>=1.5</span></li>
        </ul>

        <h3>Relevant physical principles (and why they apply)</h3>
        <ul>
          <li>
            <b>Gaussian beam propagation</b>: A TEM<sub>00</sub> Gaussian beam has a waist <span class="eq">w<sub>0</sub></span>, Rayleigh range <span class="eq">z<sub>R</sub></span>,
            and far-field divergence <span class="eq">&theta;</span>. This directly describes “angular divergence.”
          </li>
          <li>
            <b>Wavelength in a medium</b>: The frequency stays the same across the boundary, so wavelength changes as
            <span class="eq">&lambda; = &lambda;<sub>0</sub>/n</span>. Divergence depends on wavelength, so refraction changes it.
          </li>
          <li>
            <b>Field continuity at a planar interface (normal incidence)</b>: The transverse profile at <span class="eq">z=0</span> is continuous up to a Fresnel amplitude factor,
            so if the incident field is a waist at the boundary, the transmitted field also has a planar wavefront there (i.e., it is also a waist),
            with the same <span class="eq">w<sub>0</sub></span> in transverse coordinates.
          </li>
        </ul>

        <h3>Possible approaches (2–3) and comparison</h3>
        <ul>
          <li>
            <b>Direct Gaussian-beam formula scaling</b>: Use <span class="eq">&theta;=&lambda;/(&pi w<sub>0</sub>)</span> and the fact that <span class="eq">w<sub>0</sub></span> at the boundary is unchanged while <span class="eq">&lambda;</span> changes with <span class="eq">n</span>.
            <span class="muted">Fast, transparent, ideal for this question.</span>
          </li>
          <li>
            <b>ABCD matrix / complex beam parameter</b>: Propagate the complex parameter <span class="eq">q</span> through an index step and extract the new divergence.
            <span class="muted">More general (handles lenses/curved interfaces), but heavier than needed here.</span>
          </li>
          <li>
            <b>Angular spectrum (Fourier optics)</b>: Interpret divergence as transverse spatial-frequency bandwidth and use how k-space scales with refractive index.
            <span class="muted">Conceptually deep, but overkill for a single numeric ratio.</span>
          </li>
        </ul>

        <p><b>Chosen approach:</b> the <b>direct scaling</b> method is best because the problem is normal incidence with the waist at the interface, so the beam is completely characterized by <span class="eq">w<sub>0</sub></span> and the local wavelength. The divergence ratio then follows immediately.</p>
      </article>

      <article class="card" id="part2">
        <h2>PART 2 — Strategy & Tips (roadmap only)</h2>

        <h3>Plan (5–10 steps, minimal)</h3>
        <ol class="muted" style="margin:10px 0 10px 18px;">
          <li><b>Goal:</b> relate divergence to beam waist and wavelength. <b>Tool:</b> Gaussian-beam relation <span class="eq">&theta;=&lambda;/(&pi w<sub>0</sub>)</span>.</li>
          <li><b>Goal:</b> determine what stays the same at the interface. <b>Tool:</b> continuity of transverse field profile at normal incidence → same <span class="eq">w<sub>0</sub></span> at <span class="eq">z=0</span>.</li>
          <li><b>Goal:</b> express wavelengths in air and in medium. <b>Tool:</b> <span class="eq">&lambda;=&lambda;<sub>0</sub>/n</span>.</li>
          <li><b>Goal:</b> compute divergence ratio. <b>Tool:</b> divide the two divergence expressions to eliminate <span class="eq">w<sub>0</sub></span>.</li>
          <li><b>Goal:</b> insert numbers (<span class="eq">n<sub>1</sub>=1</span>, <span class="eq">n<sub>2</sub>=1.5</span>, <span class="eq">&theta;<sub>1</sub>=1 mrad</span>) to get <span class="eq">&theta;<sub>2</sub></span>.</li>
          <li><b>Goal:</b> sketch/describe transmitted beam. <b>Tool:</b> smaller divergence and larger Rayleigh range in higher index.</li>
          <li><b>Goal:</b> sanity checks. <b>Tool:</b> units and limiting behavior (e.g., <span class="eq">n<sub>2</sub>&rarr;&infin;</span> gives <span class="eq">&theta;<sub>2</sub>&rarr;0</span>).</li>
        </ol>

        <h3>Common mistakes & quick tips</h3>
        <ul>
          <li><b>Mistake:</b> assuming divergence increases because “light slows down.” <b>Tip:</b> divergence depends on wavelength inside the medium, which is <em>smaller</em>, so divergence gets <em>smaller</em> for the same waist size.</li>
          <li><b>Mistake:</b> mixing vacuum wavelength <span class="eq">&lambda;<sub>0</sub></span> with in-medium wavelength <span class="eq">&lambda;</span>. <b>Tip:</b> always specify which one is used in <span class="eq">&theta;=&lambda;/(&pi w<sub>0</sub>)</span>.</li>
          <li><b>Mistake:</b> moving the waist. <b>Tip:</b> the problem explicitly states the waist lies at the boundary; at normal incidence this means the transmitted beam is also a waist there (planar phase front).</li>
        </ul>
      </article>

      <article class="card" id="part3">
        <h2>PART 3 — Full Solution</h2>

        <h3>Physical intuition</h3>
        <p>
          A Gaussian beam’s divergence is fundamentally set by diffraction: a smaller wavelength diffracts less for the same transverse size.
          When the beam enters a higher-index medium at the same frequency, its wavelength shortens by a factor of <span class="eq">1/n</span>.
          Since the beam waist is located at the interface and the transverse profile must match there, the waist radius <span class="eq">w<sub>0</sub></span> is the same immediately after the boundary.
          Therefore, the transmitted beam keeps the same waist size at the interface but spreads more slowly: <b>smaller divergence</b> and <b>longer Rayleigh range</b>.
        </p>

        <h3>Step-by-step derivation</h3>

        <p><b>1) Gaussian-beam divergence (small-angle, far-field):</b></p>
        <div class="eqrow">
          <div class="eq" id="eq2">&theta; = &lambda; / (&pi; w<sub>0</sub>)</div>
          <button class="copybtn" data-copy="theta = lambda/(pi*w0)">Copy</button>
        </div>
        <p class="muted">
          Here <span class="eq">&theta;</span> is the (half-)divergence angle in radians (for paraxial beams),
          <span class="eq">&lambda;</span> is the wavelength in the propagation medium, and <span class="eq">w<sub>0</sub></span> is the waist radius.
        </p>

        <p><b>2) Wavelength change across the interface:</b></p>
        <div class="eqrow">
          <div class="eq" id="eq3">&lambda; = &lambda;<sub>0</sub>/n</div>
          <button class="copybtn" data-copy="lambda = lambda0/n">Copy</button>
        </div>
        <p class="muted">
          Frequency stays the same; phase velocity changes, so wavelength scales as <span class="eq">1/n</span>.
        </p>

        <p><b>3) Waist at the boundary:</b></p>
        <p class="muted">
          The beam waist is at the boundary (<span class="eq">z=0</span>). At normal incidence, the transverse coordinate system is shared across the boundary;
          the transmitted field at <span class="eq">z=0</span> has the same Gaussian radius <span class="eq">w<sub>0</sub></span> (up to a Fresnel amplitude factor that does not change the width).
          Thus we may treat the transmitted beam as having the same waist radius <span class="eq">w<sub>0</sub></span> located at the interface.
        </p>

        <p><b>4) Write divergences in each medium:</b></p>
        <div class="eqrow">
          <div class="eq" id="eq4">
            &theta;<sub>1</sub> = &lambda;<sub>1</sub> / (&pi; w<sub>0</sub>), &nbsp;&nbsp;
            &theta;<sub>2</sub> = &lambda;<sub>2</sub> / (&pi; w<sub>0</sub>)
          </div>
          <button class="copybtn" data-copy="theta1 = lambda1/(pi*w0); theta2 = lambda2/(pi*w0)">Copy</button>
        </div>

        <p><b>5) Take the ratio to eliminate <span class="eq">w<sub>0</sub></span>:</b></p>
        <div class="eqrow">
          <div class="eq" id="eq5">
            &theta;<sub>2</sub> / &theta;<sub>1</sub> = &lambda;<sub>2</sub> / &lambda;<sub>1</sub>
            = ( &lambda;<sub>0</sub>/n<sub>2</sub> ) / ( &lambda;<sub>0</sub>/n<sub>1</sub> )
            = n<sub>1</sub>/n<sub>2</sub>
          </div>
          <button class="copybtn" data-copy="theta2/theta1 = lambda2/lambda1 = (lambda0/n2)/(lambda0/n1) = n1/n2">Copy</button>
        </div>

        <p><b>Therefore:</b></p>
        <div class="eqrow">
          <div class="eq" id="eq6">&theta;<sub>2</sub> = &theta;<sub>1</sub> (n<sub>1</sub>/n<sub>2</sub>)</div>
          <button class="copybtn" data-copy="theta2 = theta1*(n1/n2)">Copy</button>
        </div>

        <p><b>6) Insert the given numbers:</b></p>
        <ul>
          <li><span class="eq">n<sub>1</sub>=1</span> (air)</li>
          <li><span class="eq">n<sub>2</sub>=1.5</span></li>
          <li><span class="eq">&theta;<sub>1</sub>=1 mrad</span></li>
        </ul>

        <div class="answerBox">
          <span class="badge">Boxed result</span>
          <div class="big" id="boxed">
            &theta;<sub>2</sub> = 1 mrad &times; (1/1.5) = 0.666… mrad &approx; 0.667 mrad.
          </div>
        </div>

        <h3>Sketch / description of the transmitted beam</h3>
        <ul>
          <li>The waist remains at the boundary with the same waist radius <span class="eq">w<sub>0</sub></span> (transverse profile continuity).</li>
          <li>Inside the medium the wavelength is shorter, so the beam diffracts less → <b>smaller divergence angle</b>.</li>
          <li>The Rayleigh range increases: <span class="eq">z<sub>R</sub> = &pi; w<sub>0</sub><sup>2</sup> / &lambda;</span>, so with <span class="eq">&lambda;&propto;1/n</span>, we get <span class="eq">z<sub>R,2</sub> = n<sub>2</sub> z<sub>R,1</sub></span>.</li>
        </ul>
      </article>

      <section class="card" id="viz">
        <h2>Interactive Visualizations</h2>
        <p class="note">
          Use the sliders to change <span class="eq">n<sub>2</sub></span> and the incident divergence <span class="eq">&theta;<sub>1</sub></span>.
          All canvases update live. (For plotting, we use an <b>example</b> vacuum wavelength <span class="eq">&lambda;<sub>0</sub>=1.00 &micro;m</span> to convert divergence ↔ waist ↔ Rayleigh range; the final answer for this problem does <em>not</em> depend on choosing <span class="eq">&lambda;<sub>0</sub></span>.)
        </p>

        <div class="controls" aria-label="Interactive controls">
          <div class="control">
            <label for="n2">
              <span>Refractive index <span class="eq">n<sub>2</sub></span></span>
              <span class="val" id="n2Val">1.50</span>
            </label>
            <input id="n2" type="range" min="1.00" max="2.50" step="0.01" value="1.50" />
            <div class="note">Range: 1.00 to 2.50 (air to higher-index dielectric)</div>
          </div>

          <div class="control">
            <label for="theta1">
              <span>Incident divergence <span class="eq">&theta;<sub>1</sub></span> (mrad)</span>
              <span class="val" id="theta1Val">1.00</span>
            </label>
            <input id="theta1" type="range" min="0.20" max="3.00" step="0.01" value="1.00" />
            <div class="note">Range: 0.20 to 3.00 mrad</div>
          </div>

          <div class="control">
            <label>
              <span>Computed transmitted divergence <span class="eq">&theta;<sub>2</sub></span> (mrad)</span>
              <span class="val" id="theta2Val">0.667</span>
            </label>
            <div class="eqrow" style="margin:0;">
              <div class="eq" id="liveEq">&theta;<sub>2</sub> = &theta;<sub>1</sub>(1/n<sub>2</sub>)</div>
              <button class="copybtn" data-copy="theta2 = theta1/n2 (for n1=1)">Copy</button>
            </div>
            <div class="note">Here <span class="eq">n<sub>1</sub>=1</span> (air) is fixed.</div>
          </div>
        </div>

        <div class="vizGrid">
          <figure class="canvasCard">
            <div class="canvasHeader">
              <div>
                <h3>1) Labeled setup diagram (beam at a planar interface)</h3>
                <p>Shows the waist at <span class="eq">z=0</span>, the interface, and how the divergence decreases in the higher-index medium.</p>
              </div>
              <span class="pill"><b>Canvas</b> diagram</span>
            </div>
            <canvas id="cDiagram" aria-label="Beam refraction diagram"></canvas>
          </figure>

          <figure class="canvasCard">
            <div class="canvasHeader">
              <div>
                <h3>2) Main plot: divergence in medium vs refractive index</h3>
                <p>Relationship: <span class="eq">&theta;<sub>2</sub>=&theta;<sub>1</sub>(n<sub>1</sub>/n<sub>2</sub>)</span>. With <span class="eq">n<sub>1</sub>=1</span>, this is simply <span class="eq">&theta;<sub>2</sub>=&theta;<sub>1</sub>/n<sub>2</sub></span>.</p>
              </div>
              <span class="pill"><b>Plot</b> &theta; vs n</span>
            </div>
            <canvas id="cMain" aria-label="Divergence vs refractive index plot"></canvas>
          </figure>

          <figure class="canvasCard">
            <div class="canvasHeader">
              <div>
                <h3>3) Secondary plot: beam radius profile across the interface</h3>
                <p>
                  Using example <span class="eq">&lambda;<sub>0</sub>=1.00 &micro;m</span>, we convert the chosen <span class="eq">&theta;<sub>1</sub></span> to <span class="eq">w<sub>0</sub></span>, then plot
                  <span class="eq">w(z)=w<sub>0</sub>&radic;(1+(z/z<sub>R</sub>)<sup>2</sup>)</span> in air (<span class="eq">z&lt;0</span>) and in the medium (<span class="eq">z&gt;0</span>).
                </p>
              </div>
              <span class="pill"><b>Plot</b> w(z)</span>
            </div>
            <canvas id="cSecondary" aria-label="Beam radius vs z plot"></canvas>
          </figure>
        </div>
      </section>

      <section class="card" id="checks">
        <h2>Sanity Checks</h2>

        <h3>Units check</h3>
        <ul>
          <li><span class="eq">&theta;</span> is dimensionless (radians). In <span class="eq">&theta;=&lambda;/(&pi w<sub>0</sub>)</span>, both <span class="eq">&lambda;</span> and <span class="eq">w<sub>0</sub></span> are lengths → ratio is dimensionless ✓</li>
        </ul>

        <h3>Limiting cases</h3>
        <ul>
          <li>If <span class="eq">n<sub>2</sub>=n<sub>1</sub></span>, then <span class="eq">&theta;<sub>2</sub>=&theta;<sub>1</sub></span> (no change) ✓</li>
          <li>If <span class="eq">n<sub>2</sub></span> increases, <span class="eq">&theta;<sub>2</sub></span> decreases (less diffraction due to shorter wavelength) ✓</li>
          <li>If <span class="eq">n<sub>2</sub>&rarr;&infin;</span>, then <span class="eq">&theta;<sub>2</sub>&rarr;0</span> (extremely short wavelength, minimal spreading) ✓</li>
        </ul>

        <h3>Physical interpretation</h3>
        <p class="muted">
          The transmitted beam is still Gaussian, with a waist at the interface, but it has a smaller diffraction angle and a longer Rayleigh range in the higher-index material.
          So the “sketch” should show a beam that looks tighter (less opening) after the boundary.
        </p>
      </section>
    </div>
  </div>
</main>

<footer>
  <div class="hr"></div>
  <div>
    Built as a self-contained HTML article with vanilla JS + canvas. Copy buttons copy plain text.
    Print view hides UI-only elements.
  </div>
</footer>

<script>
(function(){
  // ---------- helpers ----------
  const $ = (id)=>document.getElementById(id);

  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

  function niceTicks(min, max, n=5){
    // returns {step, start, end, ticks[]} with simple "nice" steps
    const span = max - min;
    if(span <= 0) return {step:1, start:min, end:max, ticks:[min]};
    const raw = span / n;
    const pow = Math.pow(10, Math.floor(Math.log10(raw)));
    const r = raw / pow;
    let nice;
    if(r < 1.5) nice = 1;
    else if(r < 3) nice = 2;
    else if(r < 7) nice = 5;
    else nice = 10;
    const step = nice * pow;
    const start = Math.floor(min/step)*step;
    const end = Math.ceil(max/step)*step;
    const ticks = [];
    for(let v=start; v<=end+1e-12; v+=step) ticks.push(v);
    return {step, start, end, ticks};
  }

  function setupCanvas(canvas){
    const ctx = canvas.getContext('2d');
    function resize(){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(2, Math.floor(rect.width * dpr));
      const h = Math.max(2, Math.floor(rect.height * dpr));
      if(canvas.width !== w || canvas.height !== h){
        canvas.width = w; canvas.height = h;
      }
      ctx.setTransform(1,0,0,1,0,0);
      ctx.scale(dpr, dpr); // draw in CSS pixels
      return {w: rect.width, h: rect.height, dpr};
    }
    return {ctx, resize};
  }

  function drawAxes(ctx, rect, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
    const {x, y, w, h, padL, padR, padT, padB} = rect;
    // background
    ctx.save();
    ctx.clearRect(x, y, w, h);

    // title
    ctx.fillStyle = 'rgba(233,238,255,0.95)';
    ctx.font = '600 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillText(title, x + padL, y + 18);

    // plot area
    const px0 = x + padL;
    const py0 = y + padT;
    const pw = w - padL - padR;
    const ph = h - padT - padB;

    // grid + ticks
    const xt = niceTicks(xMin, xMax, 6);
    const yt = niceTicks(yMin, yMax, 6);

    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.lineWidth = 1;

    // gridlines
    for(const xv of xt.ticks){
      const X = px0 + (xv - xMin) / (xMax - xMin) * pw;
      ctx.beginPath();
      ctx.moveTo(X, py0);
      ctx.lineTo(X, py0 + ph);
      ctx.stroke();
    }
    for(const yv of yt.ticks){
      const Y = py0 + ph - (yv - yMin) / (yMax - yMin) * ph;
      ctx.beginPath();
      ctx.moveTo(px0, Y);
      ctx.lineTo(px0 + pw, Y);
      ctx.stroke();
    }

    // axes
    ctx.strokeStyle = 'rgba(255,255,255,0.25)';
    ctx.lineWidth = 1.25;
    ctx.beginPath();
    ctx.moveTo(px0, py0);
    ctx.lineTo(px0, py0 + ph);
    ctx.lineTo(px0 + pw, py0 + ph);
    ctx.stroke();

    // tick labels
    ctx.fillStyle = 'rgba(185,194,230,0.95)';
    ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';

    // x ticks
    for(const xv of xt.ticks){
      const X = px0 + (xv - xMin) / (xMax - xMin) * pw;
      ctx.beginPath();
      ctx.moveTo(X, py0 + ph);
      ctx.lineTo(X, py0 + ph + 5);
      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.stroke();
      const txt = formatTick(xv);
      const tw = ctx.measureText(txt).width;
      ctx.fillText(txt, X - tw/2, py0 + ph + 18);
    }
    // y ticks
    for(const yv of yt.ticks){
      const Y = py0 + ph - (yv - yMin) / (yMax - yMin) * ph;
      ctx.beginPath();
      ctx.moveTo(px0 - 5, Y);
      ctx.lineTo(px0, Y);
      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.stroke();
      const txt = formatTick(yv);
      const tw = ctx.measureText(txt).width;
      ctx.fillText(txt, px0 - 8 - tw, Y + 4);
    }

    // labels
    ctx.fillStyle = 'rgba(233,238,255,0.92)';
    ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillText(xLabel, px0 + pw - ctx.measureText(xLabel).width, y + h - 10);

    // y label rotated
    ctx.save();
    ctx.translate(x + 14, py0 + ph/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
    ctx.restore();

    ctx.restore();

    function xMap(v){ return px0 + (v - xMin)/(xMax-xMin)*pw; }
    function yMap(v){ return py0 + ph - (v - yMin)/(yMax-yMin)*ph; }
    return {xMap, yMap, px0, py0, pw, ph};
  }

  function formatTick(v){
    const av = Math.abs(v);
    if(av >= 1000) return v.toFixed(0);
    if(av >= 100) return v.toFixed(0);
    if(av >= 10) return v.toFixed(1);
    if(av >= 1) return v.toFixed(2);
    if(av >= 0.1) return v.toFixed(2);
    return v.toFixed(3);
  }

  function drawLine(ctx, pts, stroke='rgba(122,167,255,0.95)', width=2){
    if(pts.length < 2) return;
    ctx.save();
    ctx.strokeStyle = stroke;
    ctx.lineWidth = width;
    ctx.lineJoin = 'round';
    ctx.lineCap = 'round';
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
    ctx.stroke();
    ctx.restore();
  }

  function drawDot(ctx, x, y, r=4, fill='rgba(125,255,207,0.95)'){
    ctx.save();
    ctx.fillStyle = fill;
    ctx.beginPath();
    ctx.arc(x,y,r,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function legendBox(ctx, x, y, items){
    // items: [{label, color}]
    const pad = 10;
    ctx.save();
    ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    let w = 0;
    for(const it of items){
      w = Math.max(w, 18 + 8 + ctx.measureText(it.label).width);
    }
    const h = items.length*18 + pad*2 - 4;
    ctx.fillStyle = 'rgba(0,0,0,0.35)';
    ctx.strokeStyle = 'rgba(255,255,255,0.12)';
    ctx.lineWidth = 1;
    roundRect(ctx, x, y, w + pad*2, h, 12);
    ctx.fill(); ctx.stroke();
    ctx.fillStyle = 'rgba(233,238,255,0.92)';
    for(let i=0;i<items.length;i++){
      const yy = y + pad + i*18 + 2;
      ctx.strokeStyle = items[i].color;
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(x + pad, yy+6);
      ctx.lineTo(x + pad + 16, yy+6);
      ctx.stroke();
      ctx.fillText(items[i].label, x + pad + 22, yy+10);
    }
    ctx.restore();
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  // ---------- physics ----------
  const n1 = 1.0; // air
  const lambda0 = 1e-6; // example vacuum wavelength for the secondary plot (meters)

  function compute(n2, theta1_mrad){
    const theta1 = theta1_mrad * 1e-3; // rad
    const theta2 = theta1 * (n1 / n2);
    // Example conversions for plot 3:
    const w0 = lambda0 / (Math.PI * theta1); // using lambda in air ~ lambda0/n1 = lambda0
    const zR1 = Math.PI * w0*w0 / (lambda0/n1); // air
    const zR2 = Math.PI * w0*w0 / (lambda0/n2); // medium
    return {theta1, theta2, w0, zR1, zR2};
  }

  // ---------- canvases ----------
  const diag = setupCanvas($('cDiagram'));
  const main = setupCanvas($('cMain'));
  const sec  = setupCanvas($('cSecondary'));

  // ---------- state ----------
  const state = {
    n2: 1.50,
    theta1_mrad: 1.00
  };

  function updateUI(){
    $('n2Val').textContent = state.n2.toFixed(2);
    $('theta1Val').textContent = state.theta1_mrad.toFixed(2);
    const {theta2} = compute(state.n2, state.theta1_mrad);
    $('theta2Val').textContent = (theta2*1e3).toFixed(3);
    // update the top final answer line too (problem-specific n2=1.5 might be changed by slider; this is "live")
    $('finalPlain').textContent = `Given θ₁ = ${state.theta1_mrad.toFixed(2)} mrad in air and n₂ = ${state.n2.toFixed(2)}:  θ₂ = θ₁/n₂ ≈ ${(theta2*1e3).toFixed(3)} mrad.`;
  }

  function render(){
    updateUI();
    drawDiagram();
    drawMainPlot();
    drawSecondaryPlot();
  }

  function drawDiagram(){
    const {ctx, resize} = diag;
    const {w, h} = resize();

    const W = w, H = h;
    const pad = 18;

    // backdrop
    ctx.clearRect(0,0,W,H);
    // subtle vignette
    const grad = ctx.createRadialGradient(W*0.35,H*0.25, 10, W*0.5,H*0.55, Math.max(W,H));
    grad.addColorStop(0,'rgba(122,167,255,0.10)');
    grad.addColorStop(1,'rgba(0,0,0,0)');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,W,H);

    // interface at center x
    const xI = W*0.5;
    ctx.strokeStyle = 'rgba(255,255,255,0.28)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(xI, pad);
    ctx.lineTo(xI, H-pad);
    ctx.stroke();

    // label media
    ctx.fillStyle = 'rgba(185,194,230,0.95)';
    ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillText(`air (n₁=1.00)`, pad, pad+14);
    ctx.fillText(`medium (n₂=${state.n2.toFixed(2)})`, xI+10, pad+14);

    // waist at interface, centered vertically
    const y0 = H*0.55;
    const {theta1, theta2} = compute(state.n2, state.theta1_mrad);
    // pick a visual scale for divergence (just for drawing)
    const scale = 240; // pixels per rad-ish (visual)
    const L = Math.min(W,H)*0.42;

    // centerline
    ctx.strokeStyle = 'rgba(255,255,255,0.18)';
    ctx.lineWidth = 1.5;
    ctx.setLineDash([6,6]);
    ctx.beginPath();
    ctx.moveTo(pad, y0);
    ctx.lineTo(W-pad, y0);
    ctx.stroke();
    ctx.setLineDash([]);

    // incident beam envelope lines (left side)
    const a1 = clamp(theta1 * scale, 0.01, 0.45); // in radians scaled to slope
    const xL = xI - L;
    ctx.strokeStyle = 'rgba(122,167,255,0.95)';
    ctx.lineWidth = 2.2;
    ctx.beginPath();
    ctx.moveTo(xI, y0);
    ctx.lineTo(xL, y0 - (xI-xL)*a1);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(xI, y0);
    ctx.lineTo(xL, y0 + (xI-xL)*a1);
    ctx.stroke();

    // transmitted beam envelope lines (right side)
    const a2 = clamp(theta2 * scale, 0.01, 0.45);
    const xR = xI + L;
    ctx.strokeStyle = 'rgba(125,255,207,0.95)';
    ctx.lineWidth = 2.2;
    ctx.beginPath();
    ctx.moveTo(xI, y0);
    ctx.lineTo(xR, y0 - (xR-xI)*a2);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(xI, y0);
    ctx.lineTo(xR, y0 + (xR-xI)*a2);
    ctx.stroke();

    // waist marker
    ctx.strokeStyle = 'rgba(255,255,255,0.5)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(xI-10, y0-18);
    ctx.lineTo(xI-10, y0+18);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(xI+10, y0-18);
    ctx.lineTo(xI+10, y0+18);
    ctx.stroke();

    // labels theta
    ctx.fillStyle = 'rgba(233,238,255,0.95)';
    ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillText(`θ₁ = ${state.theta1_mrad.toFixed(2)} mrad`, xL + 10, y0 - (xI-xL)*a1 - 12);
    ctx.fillText(`θ₂ = ${(theta2*1e3).toFixed(3)} mrad`, xI + 16, y0 - (xR-xI)*a2 - 12);

    // arrow direction
    ctx.fillStyle = 'rgba(233,238,255,0.85)';
    ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillText('propagation →', W*0.62, H-pad-10);

    // small note about waist location
    ctx.fillStyle = 'rgba(185,194,230,0.92)';
    ctx.fillText('waist at interface (z = 0)', xI - 80, y0 + 34);
  }

  function drawMainPlot(){
    const {ctx, resize} = main;
    const {w, h} = resize();

    const rect = {x:0,y:0,w:w,h:h,padL:58,padR:18,padT:34,padB:44};

    const nMin = 1.0, nMax = 2.5;
    const theta1_mrad = state.theta1_mrad;
    const yMin = 0.0;
    const yMax = theta1_mrad * 1.05; // mrad

    const ax = drawAxes(
      ctx, rect,
      nMin, nMax,
      yMin, yMax,
      'Refractive index n₂ (dimensionless)',
      'Divergence θ₂ (mrad)',
      'Divergence in medium vs refractive index'
    );

    // curve theta2(n2) = theta1/n2 (mrad)
    const pts = [];
    for(let i=0;i<=160;i++){
      const n2 = nMin + (nMax-nMin)*i/160;
      const theta2_mrad = theta1_mrad*(n1/n2);
      pts.push({x: ax.xMap(n2), y: ax.yMap(theta2_mrad)});
    }
    drawLine(ctx, pts, 'rgba(122,167,255,0.95)', 2.4);

    // highlight current point
    const curTheta2_mrad = theta1_mrad*(n1/state.n2);
    const X = ax.xMap(state.n2);
    const Y = ax.yMap(curTheta2_mrad);
    drawDot(ctx, X, Y, 4.5, 'rgba(125,255,207,0.95)');

    // a small crosshair
    ctx.save();
    ctx.strokeStyle = 'rgba(125,255,207,0.55)';
    ctx.lineWidth = 1.3;
    ctx.beginPath();
    ctx.moveTo(X, ax.py0);
    ctx.lineTo(X, ax.py0 + ax.ph);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(ax.px0, Y);
    ctx.lineTo(ax.px0 + ax.pw, Y);
    ctx.stroke();
    ctx.restore();

    // legend
    legendBox(ctx, ax.px0 + 10, ax.py0 + 8, [
      {label: 'θ₂(n₂) = θ₁/n₂', color: 'rgba(122,167,255,0.95)'},
      {label: 'current (slider)', color: 'rgba(125,255,207,0.95)'}
    ]);
  }

  function drawSecondaryPlot(){
    const {ctx, resize} = sec;
    const {w, h} = resize();

    const rect = {x:0,y:0,w:w,h:h,padL:62,padR:18,padT:34,padB:44};

    const {w0, zR1, zR2} = compute(state.n2, state.theta1_mrad);

    // Choose z-range around interface: symmetric in air side using zR1, and in medium side using zR2
    // For a clean shared axis, use ±3*zR1 (air-based). This keeps the "same" physical distance;
    // medium will appear to expand less over +z because zR2>zR1.
    const zMin = -3*zR1;
    const zMax =  3*zR1;

    // Convert to mm for y-axis
    function wOf(z, zR){
      return w0 * Math.sqrt(1 + (z/zR)*(z/zR));
    }
    // determine y-limits
    let wMin = w0;
    let wMax = wOf(3*zR1, zR1);
    // medium side at +3 zR1 uses zR2, which yields smaller w than air's at same |z|
    wMax = Math.max(wMax, wOf(-3*zR1, zR1), wOf(3*zR1, zR2));

    const yMin = 0;
    const yMax = (wMax*1e3) * 1.10; // mm

    const ax = drawAxes(
      ctx, rect,
      zMin, zMax,
      yMin, yMax,
      'Axial distance z (m)',
      'Beam radius w(z) (mm)',
      'Beam radius across interface (example λ₀ = 1.00 μm)'
    );

    // Curves: w(z) in air (use zR1 everywhere, but visually mark z<0),
    // and w(z) in medium for z>0 with zR2.
    const ptsAir = [];
    const ptsMed = [];
    for(let i=0;i<=220;i++){
      const z = zMin + (zMax-zMin)*i/220;
      if(z <= 0){
        const ww = wOf(z, zR1)*1e3; // mm
        ptsAir.push({x: ax.xMap(z), y: ax.yMap(ww)});
      }else{
        const ww = wOf(z, zR2)*1e3; // mm
        ptsMed.push({x: ax.xMap(z), y: ax.yMap(ww)});
      }
    }
    drawLine(ctx, ptsAir, 'rgba(122,167,255,0.95)', 2.4);
    drawLine(ctx, ptsMed, 'rgba(125,255,207,0.95)', 2.4);

    // interface marker at z=0
    const x0 = ax.xMap(0);
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    ctx.lineWidth = 1.7;
    ctx.setLineDash([5,5]);
    ctx.beginPath();
    ctx.moveTo(x0, ax.py0);
    ctx.lineTo(x0, ax.py0 + ax.ph);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(233,238,255,0.9)';
    ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillText('interface z=0', x0 + 8, ax.py0 + 16);
    ctx.restore();

    // annotate w0 and zR
    ctx.save();
    ctx.fillStyle = 'rgba(185,194,230,0.95)';
    ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    const w0mm = w0*1e3;
    ctx.fillText(`w₀ ≈ ${w0mm.toFixed(3)} mm (from θ₁)`, ax.px0 + 10, ax.py0 + ax.ph - 10);
    ctx.fillText(`zR,air ≈ ${zR1.toFixed(3)} m`, ax.px0 + 10, ax.py0 + ax.ph - 28);
    ctx.fillText(`zR,medium ≈ ${zR2.toFixed(3)} m`, ax.px0 + 10, ax.py0 + ax.ph - 46);
    ctx.restore();

    legendBox(ctx, ax.px0 + 10, ax.py0 + 8, [
      {label: 'air side (z<0)', color: 'rgba(122,167,255,0.95)'},
      {label: 'medium side (z>0)', color: 'rgba(125,255,207,0.95)'}
    ]);
  }

  // ---------- interactions ----------
  $('n2').addEventListener('input', (e)=>{
    state.n2 = parseFloat(e.target.value);
    render();
  });
  $('theta1').addEventListener('input', (e)=>{
    state.theta1_mrad = parseFloat(e.target.value);
    render();
  });

  // smooth scroll for TOC
  document.querySelectorAll('[data-scroll]').forEach(a=>{
    a.addEventListener('click', (ev)=>{
      ev.preventDefault();
      const href = a.getAttribute('href');
      const el = document.querySelector(href);
      if(!el) return;
      el.scrollIntoView({behavior:'smooth', block:'start'});
      history.replaceState(null, '', href);
    });
  });

  // copy buttons
  async function copyText(t){
    try{
      await navigator.clipboard.writeText(t);
      return true;
    }catch(_){
      // fallback
      const ta = document.createElement('textarea');
      ta.value = t;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      let ok = false;
      try{ ok = document.execCommand('copy'); }catch(e){ ok = false; }
      document.body.removeChild(ta);
      return ok;
    }
  }
  document.querySelectorAll('.copybtn[data-copy]').forEach(btn=>{
    btn.addEventListener('click', async ()=>{
      const t = btn.getAttribute('data-copy') || '';
      const ok = await copyText(t);
      const old = btn.textContent;
      btn.textContent = ok ? 'Copied!' : 'Copy failed';
      setTimeout(()=>btn.textContent = old, 900);
    });
  });

  // responsive redraw
  let raf = null;
  function schedule(){
    if(raf) cancelAnimationFrame(raf);
    raf = requestAnimationFrame(()=>render());
  }
  window.addEventListener('resize', schedule);

  // initial render
  render();
})();
</script>
</body>
</html>
