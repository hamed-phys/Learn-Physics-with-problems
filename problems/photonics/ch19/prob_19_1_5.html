<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Two-Photon Photodetectors — Responsivity Scaling and Derivation</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#111824;
      --panel2:#0f1620;
      --text:#e8eef7;
      --muted:#b7c3d6;
      --faint:#7f93ad;
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#7ee787;
      --warn:#ffd479;
      --bad:#ff7b72;
      --border:rgba(255,255,255,.10);
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(110,231,255,.10), transparent 60%),
        radial-gradient(900px 600px at 85% 15%, rgba(167,139,250,.10), transparent 55%),
        radial-gradient(900px 600px at 45% 90%, rgba(126,231,135,.08), transparent 55%),
        var(--bg);
      line-height:1.55;
    }

    header{
      padding:28px 18px 18px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.05), transparent);
      position:relative;
      overflow:hidden;
    }
    header .wrap{
      max-width:1200px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    h1{
      margin:0;
      font-size: clamp(1.45rem, 2.3vw, 2.25rem);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      max-width: 80ch;
      font-size: 1.02rem;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding:18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      align-items:start;
    }

    nav.toc{
      position: sticky;
      top: 12px;
      align-self:start;
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius:16px;
      box-shadow: var(--shadow);
      padding:14px 14px 10px;
      backdrop-filter: blur(10px);
    }
    nav.toc .toc-title{
      font-weight:700;
      font-size:.95rem;
      letter-spacing:.4px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:10px;
    }
    nav.toc a{
      display:block;
      padding:7px 10px;
      margin:3px 0;
      color:var(--muted);
      text-decoration:none;
      border-radius:10px;
      border:1px solid transparent;
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
      font-size:.93rem;
    }
    nav.toc a:hover{
      background: rgba(110,231,255,.08);
      border-color: rgba(110,231,255,.20);
      transform: translateX(2px);
      color:var(--text);
    }
    .toc small{ color:var(--faint); font-weight:600; }

    article{
      display:flex;
      flex-direction:column;
      gap:16px;
      min-width:0;
    }

    section{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.018));
      border-radius:18px;
      padding:16px 16px 14px;
      box-shadow: var(--shadow);
      min-width:0;
    }
    section h2{
      margin:0 0 10px 0;
      font-size: 1.18rem;
      letter-spacing:.2px;
    }
    section h3{
      margin:14px 0 8px;
      font-size:1.02rem;
      color:var(--text);
    }
    p{ margin: 8px 0; color: var(--text); }
    ul,ol{ margin: 8px 0 8px 1.2rem; color: var(--text); }
    li{ margin: 6px 0; color: var(--text); }
    .muted{ color:var(--muted); }
    .fine{ color:var(--faint); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
      nav.toc{ position:relative; top:auto; }
      .grid2,.grid3{ grid-template-columns: 1fr; }
    }

    .callout{
      border:1px solid var(--border);
      border-left: 4px solid rgba(110,231,255,.6);
      background: rgba(17,24,36,.55);
      border-radius:14px;
      padding:12px 12px 10px;
      margin:10px 0;
    }
    .callout.assumptions{ border-left-color: rgba(255,212,121,.75); }
    .callout.mistakes{ border-left-color: rgba(255,123,114,.75); }
    .callout.final{ border-left-color: rgba(126,231,135,.75); }
    .callout h4{
      margin:0 0 6px;
      font-size:.95rem;
      letter-spacing:.2px;
      color:var(--text);
    }

    .eq{
      display:flex;
      align-items:stretch;
      gap:10px;
      margin:10px 0;
      padding:10px 10px 10px 12px;
      border:1px solid var(--border);
      border-radius:14px;
      background: rgba(15,22,32,.55);
      overflow:auto;
    }
    .eq code{
      font-family:var(--mono);
      font-size:.93rem;
      white-space:pre;
      color: #dbeafe;
    }
    .eq .copyBtn{
      margin-left:auto;
      flex:0 0 auto;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius:12px;
      padding:8px 10px;
      cursor:pointer;
      font-weight:650;
      font-size:.86rem;
      transition: transform .16s ease, background .16s ease, border-color .16s ease;
    }
    .eq .copyBtn:hover{
      background: rgba(110,231,255,.10);
      border-color: rgba(110,231,255,.28);
      transform: translateY(-1px);
    }
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:8px;
    }
    .pill{
      font-family:var(--mono);
      font-size:.82rem;
      color:var(--muted);
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      padding:6px 8px;
      border-radius:999px;
    }

    .vizPanel{
      display:grid;
      grid-template-columns: 1.05fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .vizPanel{ grid-template-columns: 1fr; }
    }
    .canvasCard{
      border:1px solid var(--border);
      border-radius:16px;
      background: rgba(10,14,20,.35);
      overflow:hidden;
      position:relative;
    }
    .canvasHeader{
      padding:10px 12px;
      border-bottom:1px solid rgba(255,255,255,.08);
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
    }
    .canvasHeader .title{
      font-weight:750;
      letter-spacing:.2px;
    }
    .canvasHeader .sub{
      color:var(--faint);
      font-size:.88rem;
      margin-left:auto;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      background: rgba(0,0,0,.12);
    }
    .controls{
      border:1px solid var(--border);
      border-radius:16px;
      background: rgba(10,14,20,.30);
      padding:12px;
    }
    .controls h3{ margin:0 0 10px; }
    .ctrl{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
      margin:10px 0;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.03);
    }
    .ctrl label{
      display:block;
      font-weight:700;
      font-size:.94rem;
      margin-bottom:4px;
    }
    .ctrl .desc{
      color:var(--faint);
      font-size:.86rem;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    .readout{
      font-family:var(--mono);
      font-weight:750;
      font-size:.95rem;
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      min-width: 120px;
      text-align:right;
      white-space:nowrap;
    }
    .miniRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .stat{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.03);
      border-radius:14px;
      padding:10px;
    }
    .stat .k{ color:var(--faint); font-size:.84rem; margin-bottom:2px; }
    .stat .v{ font-family:var(--mono); font-weight:800; }

    footer{
      max-width:1200px;
      margin:0 auto;
      padding:16px 18px 26px;
      color:var(--faint);
      font-size:.92rem;
    }

    /* Print-friendly */
    @media print{
      body{ background:white; color:black; }
      nav.toc{ display:none; }
      section{ box-shadow:none; background:white; border:1px solid #ddd; }
      .eq{ background:#f7f7f7; }
      .canvasCard, .controls{ display:none; }
      header{ background:white; border-bottom:1px solid #ddd; }
    }

    /* Subtle animation */
    @media (prefers-reduced-motion: no-preference){
      section{ animation: pop .35s ease both; }
      @keyframes pop{
        from{ transform: translateY(6px); opacity:0; }
        to{ transform: translateY(0); opacity:1; }
      }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <h1>Two-Photon Photodetectors: Deriving the Responsivity and Understanding the Scalings</h1>
    <div class="subtitle">
      A semiconductor with <span class="muted">hν &lt; E<sub>g</sub> &lt; 2hν</span> cannot absorb a single photon across the bandgap, but can (rarely)
      absorb <em>two photons jointly</em>. Starting from a quadratic photocurrent density model, we derive the responsivity and explain why it scales with wavelength and intensity.
    </div>
  </div>
</header>

<main>
  <nav class="toc" aria-label="Table of contents">
    <div class="toc-title">
      <span>Table of Contents</span>
      <small>sticky</small>
    </div>
    <a href="#quick">Quick Summary</a>
    <a href="#part0">PART 0 — Concept Primer</a>
    <a href="#part1">PART 1 — Problem Analysis</a>
    <a href="#part2">PART 2 — Strategy &amp; Tips</a>
    <a href="#part3">PART 3 — Full Solution</a>
    <a href="#part4">PART 4 — Deeper Understanding</a>
    <a href="#part5">PART 5 — Visualization Guide</a>
  </nav>

  <article>
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>What this is about:</b> a semiconductor detector where <span class="muted">single-photon absorption is forbidden</span> but <span class="muted">two-photon absorption</span> can generate carriers.</li>
        <li><b>Key physics idea:</b> two-photon events scale with the <b>square</b> of photon-flux density: <span class="muted">J<sub>p</sub> = ζ φ²</span>.</li>
        <li><b>Link between optics and flux:</b> optical power is photon energy times photon arrival rate: <span class="muted">P = (hν) (φA)</span>.</li>
        <li><b>Core derivation step:</b> substitute <span class="muted">φ = P/(Ahν)</span> into <span class="muted">J<sub>p</sub> = ζ φ²</span>, then compute total current <span class="muted">I = J<sub>p</sub> A</span>.</li>
        <li><b>Final symbolic result:</b> responsivity <span class="muted">R = I/P</span> becomes
          <span class="muted">R = [ζ/(hc₀)²] λ² (P/A)</span>.
        </li>
        <li><b>Scaling rationale:</b> <span class="muted">R ∝ (P/A)</span> because two-photon absorption is <b>quadratic in intensity</b>; <span class="muted">R ∝ λ²</span> because at fixed power, photon flux increases with λ (lower photon energy).</li>
        <li><b>Visualization:</b> interactive plots show linear dependence on intensity and quadratic dependence on wavelength.</li>
      </ul>

      <div class="eq" role="group" aria-label="Key result">
        <code id="eq_final">R = I/P = [ ζ / (h c0)^2 ] * λ^2 * (P/A)</code>
        <button class="copyBtn" data-copy-target="eq_final">Copy</button>
      </div>

      <div class="pillRow" aria-label="Key symbols">
        <span class="pill">φ: photon-flux density [photons·cm⁻²·s⁻¹]</span>
        <span class="pill">Jp: photocurrent density [A·cm⁻²]</span>
        <span class="pill">ζ: two-photon constant [set by material/device]</span>
        <span class="pill">P/A: intensity (irradiance) [W·cm⁻²]</span>
        <span class="pill">λ: wavelength [m]</span>
      </div>
    </section>

    <section id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <h3>Core definitions (symbols &amp; units)</h3>
      <ul>
        <li><b>Photon energy</b>: <span class="muted">E<sub>ph</sub> = hν = hc₀/λ</span> (J). Here <span class="muted">h</span> is Planck’s constant, <span class="muted">c₀</span> the speed of light.</li>
        <li><b>Photon-flux density</b> <span class="muted">φ</span>: photons arriving per unit area per unit time (photons·cm⁻²·s⁻¹).</li>
        <li><b>Optical power</b> <span class="muted">P</span>: energy per unit time delivered by light (W = J/s).</li>
        <li><b>Irradiance / intensity</b>: <span class="muted">P/A</span> (W·cm⁻²), where <span class="muted">A</span> is illuminated area.</li>
        <li><b>Photocurrent density</b> <span class="muted">J<sub>p</sub></span>: current per unit area from generated carriers (A·cm⁻²).</li>
        <li><b>Responsivity</b> <span class="muted">R</span>: output current per input optical power (A/W), defined as <span class="muted">R = I/P</span>.</li>
      </ul>

      <h3>Physical meaning of the key quantities</h3>
      <ul>
        <li><span class="muted">φ</span> measures how many photons are “available” to trigger absorption events per area and time.</li>
        <li><span class="muted">J<sub>p</sub></span> summarizes the detector’s electrical response locally (per area).</li>
        <li><span class="muted">ζ</span> encodes the probability/efficiency of <b>two-photon</b> carrier generation (material + device physics: band structure, selection rules, field enhancement, carrier collection efficiency, etc.).</li>
      </ul>

      <h3>Key principles and validity conditions</h3>
      <div class="callout assumptions">
        <h4>When does two-photon detection matter?</h4>
        <ul>
          <li>Bandgap window: <span class="muted">hν &lt; E<sub>g</sub> &lt; 2hν</span> (one photon cannot bridge the gap; two photons together can).</li>
          <li>Nonlinear process: the absorption rate depends on <b>two photons arriving “together”</b> in time (within a virtual-state lifetime), so it scales like <span class="muted">φ²</span> (or intensity squared) in the simplest model.</li>
          <li>Steady state and weak depletion: assume the light is not strongly absorbed (rare events) and the detector parameters don’t change with illumination over the range considered.</li>
        </ul>
      </div>

      <h3>Common models/approximations</h3>
      <ul>
        <li><b>Phenomenological quadratic law:</b> <span class="muted">J<sub>p</sub> = ζ φ²</span>. This bypasses microscopic quantum derivations and focuses on measurable scaling.</li>
        <li><b>Uniform illumination:</b> <span class="muted">φ</span> is constant across area <span class="muted">A</span> (so total current is just <span class="muted">I = J<sub>p</sub> A</span>).</li>
        <li><b>No internal gain assumed:</b> current is proportional to generation rate and collection, all wrapped into <span class="muted">ζ</span>.</li>
      </ul>

      <h3>Mini intuition examples (conceptual)</h3>
      <ul>
        <li><b>Intensity doubling:</b> if you double <span class="muted">P/A</span>, then <span class="muted">φ</span> doubles, so <span class="muted">J<sub>p</sub> ∝ φ²</span> increases by a factor of 4. That’s the hallmark of two-photon processes.</li>
        <li><b>Wavelength increase at fixed power:</b> larger <span class="muted">λ</span> means each photon carries less energy, so more photons are needed per second to deliver the same power. Hence <span class="muted">φ</span> increases with <span class="muted">λ</span>.</li>
      </ul>

      <div class="callout mistakes">
        <h4>What to watch for (pitfalls)</h4>
        <ul>
          <li>Mixing <b>power</b> <span class="muted">P</span> with <b>intensity</b> <span class="muted">P/A</span>: two-photon response cares about photon density/flux density, so area matters.</li>
          <li>Forgetting that <span class="muted">ν = c₀/λ</span>, so <span class="muted">1/ν² ∝ λ²</span>.</li>
          <li>Dropping the factor of <span class="muted">A</span> when going from current density <span class="muted">J<sub>p</sub></span> to total current <span class="muted">I</span>.</li>
        </ul>
      </div>
    </section>

    <section id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Problem restatement (in plain words)</h3>
      <p>
        Light of photon energy <span class="muted">hν</span> shines on a semiconductor with bandgap <span class="muted">E<sub>g</sub></span> such that
        <span class="muted">hν &lt; E<sub>g</sub> &lt; 2hν</span>. One photon can’t excite an electron across the gap, but <b>two photons together</b> can.
        You are told that the resulting photocurrent density follows a quadratic law in photon-flux density:
        <span class="muted">J<sub>p</sub> = ζ φ²</span>. Derive the detector responsivity <span class="muted">R</span> (A/W) in terms of <span class="muted">λ</span>, <span class="muted">P</span>, and <span class="muted">A</span>, and explain why it scales with <span class="muted">λ²</span> and <span class="muted">P/A</span>.
      </p>

      <h3>Given quantities</h3>
      <ul>
        <li>Photon energy <span class="muted">hν</span> and flux density <span class="muted">φ</span> (photons·cm⁻²·s⁻¹).</li>
        <li>Bandgap condition <span class="muted">hν &lt; E<sub>g</sub> &lt; 2hν</span>.</li>
        <li>Photocurrent density model: <span class="muted">J<sub>p</sub> = ζ φ²</span>, with constant <span class="muted">ζ</span>.</li>
        <li>Illuminated detector area <span class="muted">A</span> and optical power <span class="muted">P</span>.</li>
      </ul>

      <h3>Unknowns / what must be shown</h3>
      <ul>
        <li>Show responsivity <span class="muted">R = I/P</span> equals:
          <span class="muted">R = [ζ/(h c₀)²] λ² (P/A)</span>.</li>
        <li>Provide physical rationale for the proportionalities <span class="muted">R ∝ λ²</span> and <span class="muted">R ∝ P/A</span>.</li>
      </ul>

      <h3>Relevant principles (and why they apply)</h3>
      <ul>
        <li><b>Energy–photon counting relation:</b> Power equals energy per photon times photons per second. This is the bridge from optical power to photon flux.</li>
        <li><b>Current density to current:</b> <span class="muted">I = J A</span> under uniform illumination/collection.</li>
        <li><b>Nonlinear absorption scaling:</b> two-photon generation rate is quadratic in photon availability (flux density), consistent with <span class="muted">J<sub>p</sub> = ζ φ²</span>.</li>
      </ul>
      <p class="muted">
        We do <em>not</em> need detailed semiconductor transport (mobility, diffusion, recombination) because the problem packages device physics into <span class="muted">ζ</span>.
      </p>

      <div class="callout assumptions">
        <h4>Assumptions stated explicitly</h4>
        <ul>
          <li>Uniform beam over area <span class="muted">A</span> → constant <span class="muted">φ</span> and <span class="muted">J<sub>p</sub></span> across the illuminated region.</li>
          <li>Steady-state response; negligible saturation, heating, and carrier screening.</li>
          <li>All two-photon-generated carriers are collected with fixed efficiency (absorbed into constant <span class="muted">ζ</span>).</li>
          <li>Reflection/transmission losses ignored or absorbed into an effective <span class="muted">P</span> at the active region.</li>
        </ul>
      </div>

      <h3>Possible approaches (compare briefly)</h3>
      <ol>
        <li><b>Direct substitution (best here):</b> Use <span class="muted">P = hν φA</span> to eliminate <span class="muted">φ</span>, then compute <span class="muted">R=I/P</span>. <span class="fine">Fast, minimal assumptions beyond uniformity.</span></li>
        <li><b>Dimensional + scaling argument:</b> Argue <span class="muted">φ ∝ (P/A)/(hν)</span> and thus <span class="muted">J ∝ (P/A)² ν⁻²</span>, then convert to <span class="muted">R</span>. <span class="fine">Good for intuition; still needs one algebraic step.</span></li>
        <li><b>Microscopic two-photon absorption theory:</b> Start from <span class="muted">dI/dz = -β I²</span> and relate β to current. <span class="fine">More detailed, but unnecessary because the problem already gives the quadratic law.</span></li>
      </ol>

      <p><b>Chosen approach:</b> direct substitution. It is the simplest and matches the information given.</p>
    </section>

    <section id="part2">
      <h2>PART 2 — Strategy &amp; Tips (Roadmap Only)</h2>

      <ol>
        <li><b>Goal:</b> connect photon flux density to optical power.<br/>
          <span class="muted">Tool:</span> <span class="muted">P = (energy/photon) × (photons/s)</span> with photons/s = <span class="muted">φA</span>.<br/>
          <span class="fine">Meaning:</span> converts “how much light energy” into “how many photons arrive.”</li>

        <li><b>Goal:</b> solve for <span class="muted">φ</span> in terms of <span class="muted">P, A, ν</span> (or λ).<br/>
          <span class="muted">Tool:</span> algebra + <span class="muted">ν = c₀/λ</span>.<br/>
          <span class="fine">Meaning:</span> expresses photon availability using measurable optical parameters.</li>

        <li><b>Goal:</b> compute photocurrent density using the given model.<br/>
          <span class="muted">Tool:</span> <span class="muted">J<sub>p</sub> = ζ φ²</span>.<br/>
          <span class="fine">Meaning:</span> two-photon nature → quadratic response.</li>

        <li><b>Goal:</b> convert current density to total current.<br/>
          <span class="muted">Tool:</span> <span class="muted">I = J<sub>p</sub> A</span> (uniform illumination).<br/>
          <span class="fine">Meaning:</span> total collected current over the illuminated region.</li>

        <li><b>Goal:</b> compute responsivity and simplify.<br/>
          <span class="muted">Tool:</span> <span class="muted">R = I/P</span> and substitution of <span class="muted">ν</span> by <span class="muted">c₀/λ</span>.<br/>
          <span class="fine">Meaning:</span> isolates how electrical output scales with optical input.</li>

        <li><b>Goal:</b> sanity checks and scaling interpretation.<br/>
          <span class="muted">Tool:</span> dimensional reasoning + limit behavior.<br/>
          <span class="fine">Meaning:</span> ensures the formula is physically consistent.</li>
      </ol>

      <div class="callout mistakes">
        <h4>Common mistakes &amp; quick tips</h4>
        <ul>
          <li><b>Tip:</b> Write <span class="muted">P = hν (φA)</span> first; don’t guess proportionalities.</li>
          <li><b>Tip:</b> Keep <span class="muted">A</span> symbolic until the end; it must not vanish accidentally.</li>
          <li><b>Mistake:</b> using <span class="muted">φ = P/(hν)</span> (missing the area).</li>
          <li><b>Mistake:</b> concluding <span class="muted">R ∝ P</span> but forgetting that for two-photon detectors, <span class="muted">R</span> depends on intensity (<span class="muted">P/A</span>), not just power.</li>
        </ul>
      </div>
    </section>

    <section id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Qualitative expectation (before math)</h3>
      <p>
        Two-photon absorption requires <b>pairs</b> of photons to cooperate. If you increase the photon flux density, the number of possible pairs grows like
        “(number of photons available)²,” so the generated current density should scale like <span class="muted">φ²</span>. Since responsivity is current per power,
        we should expect <span class="muted">R</span> to increase with intensity <span class="muted">P/A</span> (unlike linear photodiodes, where <span class="muted">R</span> is approximately constant).
        Also, at fixed power, longer wavelength means more photons per second, so the two-photon response should increase with <span class="muted">λ</span>.
      </p>

      <h3>Step 1: Relate optical power to photon-flux density</h3>
      <p>
        By definition, optical power is energy delivered per unit time. If each photon carries energy <span class="muted">hν</span>, then the photon arrival rate
        (photons per second) times <span class="muted">hν</span> equals the power.
      </p>

      <div class="eq">
        <code id="eq_power">P = (hν) * (photons per second) = (hν) * (φ A)</code>
        <button class="copyBtn" data-copy-target="eq_power">Copy</button>
      </div>

      <p class="muted">
        Here <span class="muted">φ</span> is photons·cm⁻²·s⁻¹ and <span class="muted">A</span> is cm² (or consistent units), so <span class="muted">φA</span> is photons/s.
      </p>

      <h3>Step 2: Solve for the photon-flux density φ</h3>
      <p>
        Rearranging the power relation:
      </p>
      <div class="eq">
        <code id="eq_phi">φ = P / (A hν)</code>
        <button class="copyBtn" data-copy-target="eq_phi">Copy</button>
      </div>

      <p>
        Since <span class="muted">ν = c₀/λ</span>, we can write <span class="muted">hν = hc₀/λ</span>, giving:
      </p>
      <div class="eq">
        <code id="eq_phi_lambda">φ = P / (A * (h c0 / λ)) = (P λ) / (A h c0)</code>
        <button class="copyBtn" data-copy-target="eq_phi_lambda">Copy</button>
      </div>

      <p class="muted">
        This already shows the key scaling: at fixed <span class="muted">P</span> and <span class="muted">A</span>, photon flux density <span class="muted">φ</span> is proportional to <span class="muted">λ</span>.
      </p>

      <h3>Step 3: Use the given two-photon current-density law</h3>
      <p>
        The problem states that the induced photocurrent density is:
      </p>
      <div class="eq">
        <code id="eq_J">Jp = ζ φ^2</code>
        <button class="copyBtn" data-copy-target="eq_J">Copy</button>
      </div>

      <p>
        Substitute the expression for <span class="muted">φ</span> from Step 2:
      </p>

      <div class="eq">
        <code id="eq_J_sub">Jp = ζ * [ (P λ) / (A h c0) ]^2</code>
        <button class="copyBtn" data-copy-target="eq_J_sub">Copy</button>
      </div>

      <p class="muted">
        Interpretation: two-photon generation scales with the square of photon flux, so it scales like <span class="muted">P²</span>, and also like <span class="muted">λ²</span> because flux increases at longer wavelengths for fixed power.
      </p>

      <h3>Step 4: Convert current density to total current</h3>
      <p>
        For uniform illumination over area <span class="muted">A</span>, the total photocurrent is
        <span class="muted">I = J<sub>p</sub> A</span>.
      </p>

      <div class="eq">
        <code id="eq_I">I = Jp A = ζ A * [ (P λ) / (A h c0) ]^2</code>
        <button class="copyBtn" data-copy-target="eq_I">Copy</button>
      </div>

      <p>
        Simplify carefully: one factor of <span class="muted">A</span> cancels:
      </p>
      <div class="eq">
        <code id="eq_I_simplified">I = ζ * (P^2 λ^2) / (A (h c0)^2)</code>
        <button class="copyBtn" data-copy-target="eq_I_simplified">Copy</button>
      </div>

      <h3>Step 5: Compute responsivity R = I/P</h3>
      <p>
        Divide the current by the optical power:
      </p>

      <div class="eq">
        <code id="eq_R_steps">R = I/P = [ ζ * (P^2 λ^2) / (A (h c0)^2) ] / P = ζ * (P λ^2) / (A (h c0)^2)</code>
        <button class="copyBtn" data-copy-target="eq_R_steps">Copy</button>
      </div>

      <div class="callout final">
        <h4>Final Answer (boxed)</h4>
        <div class="eq" style="margin:8px 0 4px;">
          <code id="eq_R_final">R = I/P = [ ζ / (h c0)^2 ] * λ^2 * (P/A)</code>
          <button class="copyBtn" data-copy-target="eq_R_final">Copy</button>
        </div>
        <p class="muted" style="margin:6px 0 0;">
          This is the requested responsivity in A/W.
        </p>
      </div>

      <h3>Sanity checks</h3>
      <div class="grid2">
        <div class="callout">
          <h4>1) Limiting behavior</h4>
          <ul>
            <li>If <span class="muted">P/A → 0</span> (very weak light), then <span class="muted">R → 0</span>. Two-photon events become vanishingly rare.</li>
            <li>If <span class="muted">λ</span> increases at fixed <span class="muted">P/A</span>, then <span class="muted">R ∝ λ²</span> grows: more photons per second at longer wavelength for the same power.</li>
          </ul>
        </div>
        <div class="callout">
          <h4>2) Units / dimensions (conceptual)</h4>
          <ul>
            <li><span class="muted">R</span> must be A/W. The combination <span class="muted">[ζ/(hc₀)²] λ² (P/A)</span> has that unit when <span class="muted">ζ</span> carries the appropriate device/material dimensions from the empirical law <span class="muted">Jp = ζ φ²</span>.</li>
            <li>Practical note: <span class="muted">ζ</span> is not “universal”; it is defined so that the model is dimensionally consistent in your chosen unit system.</li>
          </ul>
        </div>
      </div>

      <h3>Why the scalings make physical sense</h3>
      <ul>
        <li><b>Why <span class="muted">R ∝ (P/A)</span>:</b> The generated current density is quadratic in flux: <span class="muted">Jp ∝ φ²</span>. But <span class="muted">φ ∝ (P/A)</span> (photon rate per area). Therefore <span class="muted">Jp ∝ (P/A)²</span>. Since <span class="muted">R = I/P ∝ Jp A / P</span>, one power of <span class="muted">P</span> cancels, leaving <span class="muted">R ∝ (P/A)</span>.</li>
        <li><b>Why <span class="muted">R ∝ λ²</span>:</b> At fixed optical power, photon flux is inversely proportional to photon energy:
          <span class="muted">φ ∝ 1/(hν) ∝ 1/ν ∝ λ</span>. Two-photon response is quadratic in <span class="muted">φ</span>, so it brings <span class="muted">λ²</span>.</li>
      </ul>

      <p class="muted">
        Connection to the diagrams/plots below: the main plot shows the <b>linear</b> dependence of <span class="muted">R</span> on intensity <span class="muted">P/A</span> (because of the final cancellation),
        while the secondary plot shows the <b>quadratic</b> rise with <span class="muted">λ</span>.
      </p>
    </section>

    <section id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpreting the final formula term-by-term</h3>
      <ul>
        <li><span class="muted">ζ</span>: “how strong” the two-photon conversion is for the device (quantum probability + collection efficiency + geometry enhancements).</li>
        <li><span class="muted">(hc₀)⁻²</span>: comes purely from converting between photons and watts twice (because the process uses <em>two</em> photons).</li>
        <li><span class="muted">λ²</span>: longer wavelength → lower photon energy → more photons for the same power → more possible pairs.</li>
        <li><span class="muted">(P/A)</span>: two-photon responsivity depends on <b>irradiance</b> (local photon density), not just total power.</li>
      </ul>

      <h3>How parameter changes affect outcomes (connect to interactive plots)</h3>
      <ul>
        <li>Increase <span class="muted">P/A</span> (tight focus or more power): <span class="muted">R</span> increases linearly, but the underlying current <span class="muted">I</span> increases as <span class="muted">P²</span>.</li>
        <li>Increase <span class="muted">λ</span> at fixed irradiance: <span class="muted">R</span> rises like <span class="muted">λ²</span>. (Note: the bandgap condition <span class="muted">hν &lt; E_g &lt; 2hν</span> must still hold.)</li>
        <li>Increase <span class="muted">A</span> at fixed <span class="muted">P</span> (same power spread out more): intensity drops, so <span class="muted">R</span> drops.</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        If you start from the common nonlinear-optics intensity evolution law for two-photon absorption,
        <span class="muted">dI/dz = -β I²</span>, then the carrier generation rate per volume is proportional to <span class="muted">β I² / (2hν)</span>
        (the <span class="muted">2hν</span> accounts for two photons per excitation). Integrating over thickness and multiplying by charge-collection efficiency would again yield a current proportional to <span class="muted">I²</span>,
        consistent with the phenomenological <span class="muted">Jp = ζ φ²</span>.
      </p>

      <h3>Concept checks (with answers)</h3>
      <ul>
        <li><b>Q:</b> Why is responsivity not constant here (unlike a linear photodiode)?<br/>
          <b>A:</b> Two-photon absorption is nonlinear; output current scales as <span class="muted">P²</span>, so <span class="muted">I/P</span> scales as <span class="muted">P</span> (or intensity <span class="muted">P/A</span>).</li>
        <li><b>Q:</b> If you keep <span class="muted">P/A</span> fixed but double <span class="muted">A</span>, what happens to <span class="muted">R</span>?<br/>
          <b>A:</b> Nothing changes, because <span class="muted">R</span> depends only on <span class="muted">P/A</span> and <span class="muted">λ</span>. (But total power <span class="muted">P</span> would have doubled to keep intensity fixed.)</li>
        <li><b>Q:</b> Where does the <span class="muted">λ²</span> come from physically?<br/>
          <b>A:</b> From converting watts to photons twice: photon flux <span class="muted">φ ∝ 1/(hν) ∝ λ</span>, and the process is quadratic in <span class="muted">φ</span>.</li>
        <li><b>Q:</b> What happens if the light is so intense that the material saturates or heats strongly?<br/>
          <b>A:</b> The simple constant-<span class="muted">ζ</span> model can break; real responsivity may deviate from linear-in-intensity behavior.</li>
      </ul>
    </section>

    <section id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <div class="vizPanel">
        <div class="canvasCard">
          <div class="canvasHeader">
            <div class="title">Diagram: Two-Photon Photodetector Setup</div>
            <div class="sub">conceptual (not to scale)</div>
          </div>
          <canvas id="cDiagram" aria-label="Detector diagram canvas"></canvas>
        </div>

        <div class="controls" aria-label="Interactive controls">
          <h3>Interactive Controls (updates all plots)</h3>

          <div class="ctrl">
            <div>
              <label for="slLambda">Wavelength λ (example)</label>
              <div class="desc">Changes photon energy and flux for a fixed optical intensity.</div>
              <input id="slLambda" type="range" min="600" max="2000" step="10" value="1000" />
            </div>
            <div class="readout" id="rdLambda">1000 nm</div>
          </div>

          <div class="ctrl">
            <div>
              <label for="slIrr">Irradiance P/A (example)</label>
              <div class="desc">Two-photon responsivity scales linearly with intensity.</div>
              <input id="slIrr" type="range" min="0" max="5" step="0.05" value="1.00" />
            </div>
            <div class="readout" id="rdIrr">1.00 W/cm²</div>
          </div>

          <div class="ctrl">
            <div>
              <label for="slZeta">Two-photon constant ζ (example)</label>
              <div class="desc">Device/material strength parameter (log slider).</div>
              <input id="slZeta" type="range" min="-46" max="-38" step="0.1" value="-42" />
            </div>
            <div class="readout" id="rdZeta">ζ = 1.0e-42</div>
          </div>

          <div class="miniRow">
            <div class="stat">
              <div class="k">Computed responsivity (at chosen λ and P/A)</div>
              <div class="v" id="statR">R = … A/W</div>
            </div>
            <div class="stat">
              <div class="k">Scaling law used in plots</div>
              <div class="v" style="font-family:var(--mono); font-weight:800;">R ∝ λ² (P/A)</div>
            </div>
          </div>

          <p class="fine" style="margin-top:10px;">
            <b>Note:</b> ζ is unknown in the problem statement, so plots use <b>example values</b> to visualize trends. The final derivation remains symbolic.
          </p>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div class="canvasCard">
          <div class="canvasHeader">
            <div class="title">Main Plot: Responsivity vs Irradiance</div>
            <div class="sub">R(P/A) at chosen λ</div>
          </div>
          <canvas id="cMain" aria-label="Main plot canvas"></canvas>
        </div>

        <div class="canvasCard">
          <div class="canvasHeader">
            <div class="title">Secondary Plot: Responsivity vs Wavelength</div>
            <div class="sub">R(λ) at chosen P/A</div>
          </div>
          <canvas id="cSecondary" aria-label="Secondary plot canvas"></canvas>
        </div>
      </div>

      <h3>What each canvas shows</h3>
      <ul>
        <li><b>Diagram canvas:</b> incoming photons (energy <span class="muted">hν</span>) strike a semiconductor slab. One photon is below bandgap, but two together can excite an electron across <span class="muted">E<sub>g</sub></span>.</li>
        <li><b>Main plot:</b> <span class="muted">R</span> versus <span class="muted">P/A</span> should be a straight line (since <span class="muted">R ∝ P/A</span>).</li>
        <li><b>Secondary plot:</b> <span class="muted">R</span> versus <span class="muted">λ</span> should curve upward like a parabola (since <span class="muted">R ∝ λ²</span>).</li>
      </ul>

      <h3>How the controls affect the plots (and why)</h3>
      <ul>
        <li><b>λ slider:</b> increases photon flux at fixed intensity because <span class="muted">E<sub>ph</sub> = hc₀/λ</span> decreases; since the process is quadratic in flux, <span class="muted">R</span> rises as <span class="muted">λ²</span>. This updates both plots (slope changes in the main plot; curve height changes in the secondary plot).</li>
        <li><b>P/A slider:</b> changes the intensity. Since <span class="muted">R ∝ P/A</span>, it scales the secondary curve and sets the highlighted operating point on the main plot.</li>
        <li><b>ζ slider:</b> multiplies everything uniformly (stronger/weaker two-photon response).</li>
      </ul>
    </section>
  </article>
</main>

<footer>
  Built as a self-contained learning article (vanilla HTML/CSS/JS). The interactive plots illustrate the <b>scaling</b> derived symbolically:
  <span class="muted">R = [ζ/(hc₀)²] λ² (P/A)</span>.
</footer>

<script>
/* =========================
   Utilities
   ========================= */
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }
function fmtSci(x, sig=3){
  if(x===0) return "0";
  const exp = Math.floor(Math.log10(Math.abs(x)));
  const m = x / Math.pow(10, exp);
  const mStr = m.toFixed(sig-1);
  return `${mStr}e${exp>=0?"+":""}${exp}`;
}
function copyText(text){
  if(navigator.clipboard && navigator.clipboard.writeText){
    navigator.clipboard.writeText(text).catch(()=>{ fallbackCopy(text); });
  } else fallbackCopy(text);
}
function fallbackCopy(text){
  const ta = document.createElement("textarea");
  ta.value = text;
  ta.style.position="fixed";
  ta.style.left="-9999px";
  document.body.appendChild(ta);
  ta.select();
  try{ document.execCommand("copy"); }catch(e){}
  document.body.removeChild(ta);
}

/* Copy buttons */
document.querySelectorAll(".copyBtn").forEach(btn=>{
  btn.addEventListener("click", ()=>{
    const id = btn.getAttribute("data-copy-target");
    const el = document.getElementById(id);
    const text = (el && el.textContent) ? el.textContent.trim() : "";
    copyText(text);
    const old = btn.textContent;
    btn.textContent = "Copied!";
    setTimeout(()=>btn.textContent=old, 900);
  });
});

/* =========================
   Physical model (for plots)
   =========================
   Derived: R = [ ζ / (h c0)^2 ] * λ^2 * (P/A)

   We'll compute using SI internally:
   - λ in meters
   - irradiance in W/m^2  (user controls in W/cm^2)
   - h in J*s, c0 in m/s
   ζ is treated as an effective constant consistent with this formula in SI units.
*/
const CONST = {
  h: 6.62607015e-34,
  c0: 2.99792458e8
};

function responsivitySI(lambda_m, irr_Wm2, zeta){
  const hc = CONST.h * CONST.c0;
  return (zeta / (hc*hc)) * (lambda_m*lambda_m) * irr_Wm2; // A/W
}

/* =========================
   High-DPI canvas helpers
   ========================= */
function setupCanvas(canvas, desiredCSSHeight){
  const parent = canvas.parentElement;
  const w = parent.clientWidth;
  const h = desiredCSSHeight;
  canvas.style.height = h + "px";
  canvas.style.width = "100%";
  const dpr = window.devicePixelRatio || 1;
  canvas.width = Math.max(2, Math.floor(w * dpr));
  canvas.height = Math.max(2, Math.floor(h * dpr));
  const ctx = canvas.getContext("2d");
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return {ctx, w, h, dpr};
}

function drawGrid(ctx, x0,y0,w,h, xTicks=6, yTicks=6){
  ctx.save();
  ctx.lineWidth = 1;
  ctx.strokeStyle = "rgba(255,255,255,0.08)";
  for(let i=0;i<=xTicks;i++){
    const x = x0 + (w*i/xTicks);
    ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y0+h); ctx.stroke();
  }
  for(let j=0;j<=yTicks;j++){
    const y = y0 + (h*j/yTicks);
    ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x0+w,y); ctx.stroke();
  }
  ctx.restore();
}

function axes(ctx, box, xLabel, yLabel, title){
  const {x,y,w,h} = box;
  ctx.save();
  ctx.fillStyle = "rgba(255,255,255,0.92)";
  ctx.font = "700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText(title, x, y-10);

  ctx.strokeStyle = "rgba(255,255,255,0.32)";
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.moveTo(x, y);
  ctx.lineTo(x, y+h);
  ctx.lineTo(x+w, y+h);
  ctx.stroke();

  ctx.fillStyle = "rgba(255,255,255,0.82)";
  ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
  ctx.fillText(xLabel, x + w - ctx.measureText(xLabel).width, y + h + 28);

  // y label rotated
  ctx.save();
  ctx.translate(x - 36, y + h/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
  ctx.restore();

  ctx.restore();
}

function ticks(ctx, box, xMin,xMax,yMin,yMax, xTicks=6, yTicks=6, fmtX, fmtY){
  const {x,y,w,h} = box;
  ctx.save();
  ctx.fillStyle = "rgba(255,255,255,0.68)";
  ctx.strokeStyle = "rgba(255,255,255,0.35)";
  ctx.lineWidth = 1;
  ctx.font = "11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";

  for(let i=0;i<=xTicks;i++){
    const t = i/xTicks;
    const xx = x + w*t;
    const val = xMin + (xMax-xMin)*t;
    ctx.beginPath();
    ctx.moveTo(xx, y+h);
    ctx.lineTo(xx, y+h+5);
    ctx.stroke();
    const s = fmtX ? fmtX(val) : (val.toFixed(2));
    const tw = ctx.measureText(s).width;
    ctx.fillText(s, xx - tw/2, y+h+18);
  }

  for(let j=0;j<=yTicks;j++){
    const t = j/yTicks;
    const yy = y + h*(1-t);
    const val = yMin + (yMax-yMin)*t;
    ctx.beginPath();
    ctx.moveTo(x-5, yy);
    ctx.lineTo(x, yy);
    ctx.stroke();
    const s = fmtY ? fmtY(val) : (val.toFixed(2));
    const tw = ctx.measureText(s).width;
    ctx.fillText(s, x - 8 - tw, yy + 4);
  }
  ctx.restore();
}

/* =========================
   Plotting
   ========================= */
function plotLine(ctx, box, xs, ys, xMin,xMax,yMin,yMax, style, label){
  const {x,y,w,h} = box;
  function X(u){ return x + (u-xMin)/(xMax-xMin)*w; }
  function Y(v){ return y + (1-(v-yMin)/(yMax-yMin))*h; }

  ctx.save();
  ctx.strokeStyle = style;
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<xs.length;i++){
    const xx = X(xs[i]);
    const yy = Y(ys[i]);
    if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
  }
  ctx.stroke();
  ctx.restore();

  // small legend line + label
  if(label){
    ctx.save();
    ctx.font = "12px ui-sans-serif, system-ui";
    ctx.fillStyle = "rgba(255,255,255,0.82)";
    const lx = x + 10, ly = y + 10;
    ctx.strokeStyle = style; ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(lx, ly); ctx.lineTo(lx+24, ly); ctx.stroke();
    ctx.fillText(label, lx+32, ly+4);
    ctx.restore();
  }
}

function plotPoint(ctx, box, xVal,yVal, xMin,xMax,yMin,yMax, color, label){
  const {x,y,w,h} = box;
  const xx = x + (xVal-xMin)/(xMax-xMin)*w;
  const yy = y + (1-(yVal-yMin)/(yMax-yMin))*h;
  ctx.save();
  ctx.fillStyle = color;
  ctx.beginPath(); ctx.arc(xx,yy,4.5,0,Math.PI*2); ctx.fill();
  ctx.strokeStyle = "rgba(0,0,0,0.35)";
  ctx.lineWidth = 2; ctx.stroke();

  if(label){
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    ctx.fillStyle = "rgba(255,255,255,0.86)";
    ctx.fillText(label, xx+8, yy-8);
  }
  ctx.restore();
}

/* =========================
   Diagram drawing
   ========================= */
function drawDiagram(){
  const canvas = document.getElementById("cDiagram");
  const {ctx, w, h} = setupCanvas(canvas, 320);
  ctx.clearRect(0,0,w,h);

  // Background
  ctx.fillStyle = "rgba(255,255,255,0.02)";
  ctx.fillRect(0,0,w,h);

  // Draw semiconductor slab
  const slab = {x: w*0.55, y: h*0.22, ww: w*0.32, hh: h*0.56};
  ctx.fillStyle = "rgba(110,231,255,0.10)";
  ctx.strokeStyle = "rgba(110,231,255,0.35)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.roundRect(slab.x, slab.y, slab.ww, slab.hh, 18);
  ctx.fill(); ctx.stroke();

  // P-N / contacts
  ctx.fillStyle = "rgba(255,255,255,0.08)";
  ctx.fillRect(slab.x, slab.y-10, slab.ww, 8);
  ctx.fillRect(slab.x, slab.y+slab.hh+2, slab.ww, 8);

  // Incoming beam arrows
  const bx0 = w*0.12, by = h*0.50;
  ctx.strokeStyle = "rgba(167,139,250,0.75)";
  ctx.lineWidth = 3;
  for(let k=-2;k<=2;k++){
    const yy = by + k*18;
    ctx.beginPath();
    ctx.moveTo(bx0, yy);
    ctx.lineTo(slab.x-12, yy);
    ctx.stroke();
    // arrow head
    ctx.beginPath();
    ctx.moveTo(slab.x-12, yy);
    ctx.lineTo(slab.x-26, yy-7);
    ctx.lineTo(slab.x-26, yy+7);
    ctx.closePath();
    ctx.fillStyle = "rgba(167,139,250,0.75)";
    ctx.fill();
  }

  // Labels
  ctx.fillStyle = "rgba(255,255,255,0.92)";
  ctx.font = "700 14px ui-sans-serif, system-ui";
  ctx.fillText("Incident photon beam", bx0, h*0.20);
  ctx.fillStyle = "rgba(255,255,255,0.78)";
  ctx.font = "12px ui-sans-serif, system-ui";
  ctx.fillText("Photon energy: hν  (with  hν < Eg < 2hν)", bx0, h*0.24);
  ctx.fillText("Photon-flux density: φ  [photons·area⁻¹·time⁻¹]", bx0, h*0.28);

  ctx.fillStyle = "rgba(255,255,255,0.9)";
  ctx.font = "700 13px ui-sans-serif, system-ui";
  ctx.fillText("Semiconductor detector", slab.x + 10, slab.y + 24);

  ctx.fillStyle = "rgba(255,255,255,0.76)";
  ctx.font = "12px ui-sans-serif, system-ui";
  ctx.fillText("Two photons can jointly excite", slab.x + 10, slab.y + 48);
  ctx.fillText("an e⁻ across the bandgap.", slab.x + 10, slab.y + 66);

  // Inside slab: band diagram sketch
  const bandX = slab.x + slab.ww*0.12;
  const bandY = slab.y + slab.hh*0.55;
  const bandW = slab.ww*0.76;
  const bandH = slab.hh*0.35;

  ctx.strokeStyle = "rgba(255,255,255,0.35)";
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(bandX, bandY);
  ctx.lineTo(bandX+bandW, bandY);
  ctx.moveTo(bandX, bandY+bandH);
  ctx.lineTo(bandX+bandW, bandY+bandH);
  ctx.stroke();

  // Eg arrow
  ctx.strokeStyle = "rgba(126,231,135,0.80)";
  ctx.lineWidth = 2.5;
  const ax = bandX + bandW*0.82;
  ctx.beginPath();
  ctx.moveTo(ax, bandY+bandH);
  ctx.lineTo(ax, bandY);
  ctx.stroke();
  ctx.fillStyle = "rgba(126,231,135,0.85)";
  ctx.beginPath();
  ctx.moveTo(ax, bandY);
  ctx.lineTo(ax-6, bandY+10);
  ctx.lineTo(ax+6, bandY+10);
  ctx.closePath(); ctx.fill();
  ctx.beginPath();
  ctx.moveTo(ax, bandY+bandH);
  ctx.lineTo(ax-6, bandY+bandH-10);
  ctx.lineTo(ax+6, bandY+bandH-10);
  ctx.closePath(); ctx.fill();

  ctx.fillStyle = "rgba(255,255,255,0.78)";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  ctx.fillText("CB", bandX, bandY-6);
  ctx.fillText("VB", bandX, bandY+bandH+16);
  ctx.fillText("Eg", ax+10, bandY+bandH*0.55);

  // Two-photon "jump" arrow
  const jx = bandX + bandW*0.35;
  ctx.strokeStyle = "rgba(255,212,121,0.85)";
  ctx.lineWidth = 2.2;
  ctx.beginPath();
  ctx.moveTo(jx, bandY+bandH);
  ctx.lineTo(jx, bandY);
  ctx.stroke();
  ctx.fillStyle = "rgba(255,212,121,0.85)";
  ctx.beginPath();
  ctx.moveTo(jx, bandY);
  ctx.lineTo(jx-6, bandY+10);
  ctx.lineTo(jx+6, bandY+10);
  ctx.closePath(); ctx.fill();
  ctx.fillStyle = "rgba(255,255,255,0.78)";
  ctx.font = "12px ui-sans-serif, system-ui";
  ctx.fillText("2-photon excitation", jx-34, bandY+bandH+40);

  // Output current lead
  ctx.strokeStyle = "rgba(110,231,255,0.55)";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(slab.x+slab.ww, slab.y+slab.hh*0.20);
  ctx.lineTo(w*0.95, slab.y+slab.hh*0.20);
  ctx.stroke();
  ctx.fillStyle = "rgba(255,255,255,0.85)";
  ctx.font = "700 12px ui-sans-serif, system-ui";
  ctx.fillText("Photocurrent I", w*0.78, slab.y+slab.hh*0.20 - 10);
}

/* =========================
   Main plot: R vs irradiance
   Secondary plot: R vs lambda
   ========================= */
function drawMainPlot(params){
  const canvas = document.getElementById("cMain");
  const {ctx, w, h} = setupCanvas(canvas, 320);
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = "rgba(255,255,255,0.02)";
  ctx.fillRect(0,0,w,h);

  const padL=60, padR=18, padT=46, padB=52;
  const box = {x:padL, y:padT, w:w-padL-padR, h:h-padT-padB};

  // Data
  const lam = params.lambda_m;
  const zeta = params.zeta;
  const irrMax_cm2 = 5.0; // W/cm^2
  const irrMax = irrMax_cm2 * 1e4; // W/m^2

  const n=140;
  const xs=[], ys=[];
  let yMax=0;
  for(let i=0;i<n;i++){
    const irr = irrMax*(i/(n-1));
    const R = responsivitySI(lam, irr, zeta);
    xs.push(irr/1e4); // back to W/cm^2 for x-axis
    ys.push(R);
    yMax = Math.max(yMax, R);
  }

  // Include current operating point
  const irrSel_cm2 = params.irr_cm2;
  const irrSel = irrSel_cm2*1e4;
  const Rsel = responsivitySI(lam, irrSel, zeta);
  yMax = Math.max(yMax, Rsel);

  // Expand yMax nicely
  yMax = (yMax===0) ? 1 : yMax*1.12;

  // Draw axes + grid + ticks
  drawGrid(ctx, box.x, box.y, box.w, box.h, 6, 6);
  axes(ctx, box, "Irradiance P/A (W/cm²)", "Responsivity R (A/W)", "Main: R vs Irradiance (linear in P/A)");

  ticks(
    ctx, box,
    0, irrMax_cm2,
    0, yMax,
    6, 6,
    v => v.toFixed(1),
    v => (yMax<0.01 ? v.toExponential(1) : v.toFixed(2))
  );

  // Plot line
  plotLine(ctx, box, xs, ys, 0, irrMax_cm2, 0, yMax, "rgba(110,231,255,0.85)", `λ = ${Math.round(params.lambda_nm)} nm`);

  // Operating point marker
  plotPoint(ctx, box, irrSel_cm2, Rsel, 0, irrMax_cm2, 0, yMax, "rgba(255,212,121,0.95)", "selected");

  // Footer note
  ctx.save();
  ctx.fillStyle="rgba(255,255,255,0.65)";
  ctx.font="12px ui-sans-serif, system-ui";
  ctx.fillText("Trend: straight line because R ∝ (P/A)", box.x, h-16);
  ctx.restore();
}

function drawSecondaryPlot(params){
  const canvas = document.getElementById("cSecondary");
  const {ctx, w, h} = setupCanvas(canvas, 320);
  ctx.clearRect(0,0,w,h);
  ctx.fillStyle = "rgba(255,255,255,0.02)";
  ctx.fillRect(0,0,w,h);

  const padL=66, padR=18, padT=46, padB=52;
  const box = {x:padL, y:padT, w:w-padL-padR, h:h-padT-padB};

  const zeta = params.zeta;
  const irrSel = params.irr_cm2 * 1e4; // W/m^2

  const lamMin_nm = 600, lamMax_nm = 2000;
  const n=170;
  const xs=[], ys=[];
  let yMax=0;
  for(let i=0;i<n;i++){
    const lam_nm = lamMin_nm + (lamMax_nm-lamMin_nm)*(i/(n-1));
    const lam = lam_nm*1e-9;
    const R = responsivitySI(lam, irrSel, zeta);
    xs.push(lam_nm);
    ys.push(R);
    yMax = Math.max(yMax, R);
  }

  const lamSel_nm = params.lambda_nm;
  const Rsel = responsivitySI(params.lambda_m, irrSel, zeta);
  yMax = Math.max(yMax, Rsel);
  yMax = (yMax===0) ? 1 : yMax*1.12;

  drawGrid(ctx, box.x, box.y, box.w, box.h, 7, 6);
  axes(ctx, box, "Wavelength λ (nm)", "Responsivity R (A/W)", "Secondary: R vs Wavelength (quadratic in λ)");

  ticks(
    ctx, box,
    lamMin_nm, lamMax_nm,
    0, yMax,
    7, 6,
    v => Math.round(v).toString(),
    v => (yMax<0.01 ? v.toExponential(1) : v.toFixed(2))
  );

  plotLine(ctx, box, xs, ys, lamMin_nm, lamMax_nm, 0, yMax, "rgba(167,139,250,0.85)", `P/A = ${params.irr_cm2.toFixed(2)} W/cm²`);
  plotPoint(ctx, box, lamSel_nm, Rsel, lamMin_nm, lamMax_nm, 0, yMax, "rgba(255,212,121,0.95)", "selected");

  ctx.save();
  ctx.fillStyle="rgba(255,255,255,0.65)";
  ctx.font="12px ui-sans-serif, system-ui";
  ctx.fillText("Trend: curvature because R ∝ λ²", box.x, h-16);
  ctx.restore();
}

/* =========================
   State + render loop
   ========================= */
const UI = {
  slLambda: document.getElementById("slLambda"),
  slIrr: document.getElementById("slIrr"),
  slZeta: document.getElementById("slZeta"),
  rdLambda: document.getElementById("rdLambda"),
  rdIrr: document.getElementById("rdIrr"),
  rdZeta: document.getElementById("rdZeta"),
  statR: document.getElementById("statR")
};

function getParams(){
  const lambda_nm = parseFloat(UI.slLambda.value);
  const irr_cm2 = parseFloat(UI.slIrr.value);
  const log10z = parseFloat(UI.slZeta.value);
  const zeta = Math.pow(10, log10z);
  const lambda_m = lambda_nm * 1e-9;
  return {lambda_nm, lambda_m, irr_cm2, zeta, log10z};
}

function updateReadouts(params){
  UI.rdLambda.textContent = `${Math.round(params.lambda_nm)} nm`;
  UI.rdIrr.textContent = `${params.irr_cm2.toFixed(2)} W/cm²`;
  UI.rdZeta.textContent = `ζ = ${fmtSci(params.zeta,3)}`;
  const R = responsivitySI(params.lambda_m, params.irr_cm2*1e4, params.zeta);
  UI.statR.textContent = `R = ${R < 0.01 ? R.toExponential(2) : R.toFixed(3)} A/W`;
}

function renderAll(){
  const params = getParams();
  updateReadouts(params);
  drawDiagram();
  drawMainPlot(params);
  drawSecondaryPlot(params);
}

["input","change"].forEach(evt=>{
  UI.slLambda.addEventListener(evt, renderAll);
  UI.slIrr.addEventListener(evt, renderAll);
  UI.slZeta.addEventListener(evt, renderAll);
});

window.addEventListener("resize", ()=>{
  // Re-render on resize for responsive crisp canvases
  renderAll();
});

/* Rounded rectangle support for older canvases */
if(!CanvasRenderingContext2D.prototype.roundRect){
  CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
    r = Math.min(r, w/2, h/2);
    this.beginPath();
    this.moveTo(x+r, y);
    this.arcTo(x+w, y, x+w, y+h, r);
    this.arcTo(x+w, y+h, x, y+h, r);
    this.arcTo(x, y+h, x, y, r);
    this.arcTo(x, y, x+w, y, r);
    this.closePath();
    return this;
  };
}

renderAll();
</script>
</body>
</html>
