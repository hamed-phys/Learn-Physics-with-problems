<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Comparison of Stimulated and Spontaneous Emission in a Cavity (Two-Mode Excitation)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --card:#0f1730;
      --ink:#e9eefc;
      --muted:#b9c4e6;
      --faint:#7f8ab6;
      --accent:#76a7ff;
      --accent2:#7dffcf;
      --warn:#ffcf5a;
      --danger:#ff6b7a;
      --ok:#7dff8a;
      --border:rgba(255,255,255,0.12);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    html,body{height:100%;}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background: radial-gradient(1200px 800px at 20% 10%, rgba(118,167,255,0.18), transparent 60%),
                  radial-gradient(900px 600px at 80% 20%, rgba(125,255,207,0.10), transparent 55%),
                  radial-gradient(700px 500px at 60% 90%, rgba(255,207,90,0.08), transparent 55%),
                  var(--bg);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none;}
    a:hover{text-decoration:underline;}
    header{
      padding: 28px 18px 18px;
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), transparent);
    }
    header .wrap{
      max-width:1200px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.1fr 0.9fr;
      gap:16px;
      align-items:start;
    }
    h1{
      margin:0 0 8px 0;
      font-weight:800;
      letter-spacing:0.2px;
      line-height:1.15;
      font-size: clamp(1.55rem, 2.4vw, 2.2rem);
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: 1rem;
      max-width: 65ch;
    }
    .meta{
      padding:14px 14px;
      background: rgba(17,26,51,0.65);
      border:1px solid var(--border);
      border-radius:16px;
      box-shadow: var(--shadow);
    }
    .meta .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:center;
      justify-content:space-between;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background: rgba(0,0,0,0.18);
      color:var(--muted);
      font-size:0.9rem;
      white-space:nowrap;
    }
    .pill b{color:var(--ink); font-weight:700;}
    main{
      max-width:1200px;
      margin:0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      align-items:start;
    }
    nav{
      position:sticky;
      top:14px;
      align-self:start;
      padding:14px;
      border-radius:16px;
      background: rgba(17,26,51,0.6);
      border:1px solid var(--border);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    nav h2{
      margin:0 0 10px 0;
      font-size:1.0rem;
      letter-spacing:0.2px;
    }
    nav ol{
      margin:0;
      padding-left: 18px;
      color:var(--muted);
    }
    nav li{margin:8px 0;}
    nav .small{color:var(--faint); font-size:0.9rem; margin-top:10px;}
    article{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    section{
      background: rgba(17,26,51,0.45);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 16px 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    section h2{
      margin:0 0 10px 0;
      font-size:1.25rem;
      letter-spacing:0.2px;
    }
    section h3{
      margin: 16px 0 8px 0;
      font-size:1.05rem;
      color: var(--ink);
    }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      header .wrap{grid-template-columns:1fr;}
      main{grid-template-columns:1fr;}
      nav{position:relative; top:auto;}
      .grid2,.grid3{grid-template-columns:1fr;}
    }
    .callout{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 12px;
      background: rgba(0,0,0,0.18);
    }
    .callout.assumptions{border-left: 4px solid var(--warn);}
    .callout.keyeq{border-left: 4px solid var(--accent);}
    .callout.mistakes{border-left: 4px solid var(--danger);}
    .callout.answer{border-left: 4px solid var(--ok);}
    .callout h4{
      margin:0 0 8px 0;
      font-size:0.95rem;
      letter-spacing:0.2px;
      color: var(--muted);
    }
    ul{margin:8px 0 0 18px; color:var(--muted);}
    li{margin:6px 0;}
    .eq{
      font-family: var(--mono);
      font-size: 0.96rem;
      color: #eaf1ff;
      background: rgba(0,0,0,0.22);
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 10px 10px;
      overflow:auto;
      position:relative;
    }
    .eq .copyBtn{
      position:absolute;
      top:8px;
      right:8px;
      border:1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--ink);
      border-radius: 10px;
      padding: 6px 8px;
      font-size: 0.85rem;
      cursor:pointer;
      transition: transform 0.12s ease, background 0.12s ease;
    }
    .eq .copyBtn:hover{background: rgba(255,255,255,0.10); transform: translateY(-1px);}
    .eq .copyBtn:active{transform: translateY(0px) scale(0.98);}
    .eq small{color:var(--faint);}
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .kpi .box{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px;
      background: rgba(0,0,0,0.16);
    }
    .kpi .box .label{color:var(--faint); font-size:0.88rem;}
    .kpi .box .value{font-family:var(--mono); font-size:1.0rem; margin-top:4px;}
    .controls{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .control{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px;
      background: rgba(0,0,0,0.16);
    }
    .control label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:0.92rem;
      margin-bottom:6px;
    }
    .control input[type="range"]{width:100%;}
    .control .hint{color:var(--faint); font-size:0.86rem; margin-top:6px;}
    .viz{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    figure{
      margin:0;
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      background: rgba(0,0,0,0.18);
    }
    figure figcaption{
      margin-top:10px;
      color:var(--muted);
      font-size:0.92rem;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius:14px;
      background: linear-gradient(180deg, rgba(255,255,255,0.04), rgba(255,255,255,0.01));
      border:1px solid rgba(255,255,255,0.10);
    }
    .smallcaps{
      font-variant: small-caps;
      letter-spacing:0.5px;
    }
    .footer{
      max-width:1200px;
      margin: 0 auto;
      padding: 10px 18px 26px;
      color: var(--faint);
      font-size:0.92rem;
    }
    .fadeIn{
      animation: fadeIn 0.5s ease both;
    }
    @keyframes fadeIn{
      from{opacity:0; transform: translateY(6px);}
      to{opacity:1; transform: translateY(0);}
    }
    @media print{
      body{background:#fff; color:#000;}
      header, nav, .controls{display:none !important;}
      section, figure{box-shadow:none; background:#fff; border:1px solid #ccc;}
      .eq{background:#f5f5f5; color:#000;}
      canvas{border:1px solid #999; background:#fff;}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="fadeIn">
      <h1>Stimulated vs. Spontaneous Emission in a Two-Mode Resonator (Lorentzian Line)</h1>
      <p class="subtitle">
        We compare the transition probability per unit time due to <span class="smallcaps">stimulated</span> emission (or absorption)
        against <span class="smallcaps">spontaneous</span> emission for a two-level atom placed in a cavity with two populated modes.
        The key is the Einstein A–B relations plus the spectral overlap of the cavity photons with the atomic Lorentzian lineshape.
      </p>
    </div>
    <div class="meta fadeIn">
      <div class="row">
        <span class="pill"><b>Given</b> λ<sub>0</sub>=0.7&nbsp;µm</span>
        <span class="pill"><b>Given</b> τ<sub>sp</sub>=3&nbsp;ns</span>
        <span class="pill"><b>Given</b> Δν<sub>FWHM</sub>=50&nbsp;GHz</span>
        <span class="pill"><b>Cavity</b> V=100&nbsp;cm³, n=1</span>
        <span class="pill"><b>Photons</b> 1000 in each of two modes</span>
      </div>
    </div>
  </div>
</header>

<main>
  <nav class="fadeIn">
    <h2>Table of Contents</h2>
    <ol>
      <li><a href="#quick">Quick Summary</a></li>
      <li><a href="#part0">PART 0 — Concept Primer</a></li>
      <li><a href="#part1">PART 1 — Problem Analysis</a></li>
      <li><a href="#part2">PART 2 — Strategy &amp; Tips</a></li>
      <li><a href="#part3">PART 3 — Full Solution</a></li>
      <li><a href="#part4">PART 4 — Deeper Understanding</a></li>
      <li><a href="#part5">PART 5 — Visualization Guide</a></li>
    </ol>
    <p class="small">
      Tip: use the sliders to change photon number, linewidth, and detuning and watch both plots update.
    </p>
  </nav>

  <article>
    <section id="quick" class="fadeIn">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>What this is about:</b> comparing <b>stimulated emission/absorption</b> rates to <b>spontaneous emission</b> for a two-level atom in a cavity with two populated modes.</li>
        <li><b>Key physics idea:</b> stimulated rates depend on the <b>spectral energy density</b> of the radiation at the atomic transition frequency, weighted by the <b>atomic lineshape</b>.</li>
        <li><b>Governing law:</b> Einstein relations connect <b>A<sub>21</sub></b> and <b>B<sub>21</sub></b>: A<sub>21</sub> = (8πhν<sub>0</sub><sup>3</sup>/c<sup>3</sup>) B<sub>21</sub>.</li>
        <li><b>Lineshape:</b> Lorentzian (normalized): g(ν)= (1/π) ( (Δν/2) / [(ν−ν<sub>0</sub>)²+(Δν/2)²] ) with units 1/Hz.</li>
        <li><b>Discrete cavity mode:</b> if a mode at ν<sub>m</sub> has N photons, its energy density is u<sub>m</sub>=N hν<sub>m</sub>/V, and it contributes rate W<sub>m</sub>=B<sub>21</sub> u<sub>m</sub> g(ν<sub>m</sub>).</li>
        <li><b>Numeric result (given 1000 photons in each mode):</b> total stimulated emission rate per excited atom ≈ <b>0.298 s⁻¹</b> (tiny compared to spontaneous A<sub>21</sub>≈3.33×10⁸ s⁻¹).</li>
        <li><b>Photon requirement for equality:</b> to make stimulated decay match spontaneous, need about <b>1.12×10¹² photons per mode</b> (if both modes scale together, same detuning/linewidth as given).</li>
      </ul>
    </section>

    <section id="part0" class="fadeIn">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div class="callout keyeq">
          <h4>Core definitions (symbols &amp; units)</h4>
          <ul>
            <li><b>ν<sub>0</sub></b> (Hz): atomic transition frequency; ν<sub>0</sub>=c/λ<sub>0</sub> (for n=1).</li>
            <li><b>A<sub>21</sub></b> (s⁻¹): spontaneous emission rate from level 2 → 1; A<sub>21</sub>=1/τ<sub>sp</sub>.</li>
            <li><b>B<sub>21</sub></b> (SI): Einstein stimulated emission coefficient; multiplies spectral energy density to give a rate.</li>
            <li><b>u(ν)</b> (J·m⁻³·Hz⁻¹): spectral energy density of the radiation field.</li>
            <li><b>g(ν)</b> (Hz⁻¹): normalized atomic lineshape; ∫g(ν)dν=1.</li>
            <li><b>W<sub>stim</sub></b> (s⁻¹): stimulated transition probability per unit time for one atom (per excited atom for emission; per ground-state atom for absorption).</li>
          </ul>
        </div>

        <div class="callout assumptions">
          <h4>Physical meaning (what these represent)</h4>
          <ul>
            <li><b>A<sub>21</sub></b> is the “always-on” radiative decay channel: even in darkness, an excited atom emits.</li>
            <li><b>Stimulated emission</b> is proportional to how much electromagnetic energy is available <b>at the right frequency</b>.</li>
            <li><b>g(ν)</b> describes the probability that the atom responds to light at frequency ν; detuned photons contribute less.</li>
            <li><b>Discrete cavity modes</b> act like sharp spectral “spikes”; their effect is their spike energy times the overlap g(ν).</li>
          </ul>
        </div>
      </div>

      <h3>Key laws/principles &amp; validity conditions</h3>
      <ul>
        <li><b>Einstein A–B relation (vacuum):</b> A<sub>21</sub> = (8πhν<sub>0</sub><sup>3</sup>/c<sup>3</sup>) B<sub>21</sub>. Valid for electric-dipole transitions in an isotropic radiation field (and used as a standard link between spontaneous and stimulated processes).</li>
        <li><b>Stimulated transition rate:</b> W<sub>stim</sub> = ∫ B u(ν) g(ν) dν. Valid in the weak-field, linear-response regime (no saturation).</li>
        <li><b>Lorentzian broadening:</b> typically from finite excited-state lifetime and homogeneous broadening; parameterized here by given FWHM Δν.</li>
      </ul>

      <h3>Common models/approximations (and why)</h3>
      <ul>
        <li><b>Two-level atom:</b> keeps the physics focused on one transition; good when other levels are far detuned.</li>
        <li><b>Normalized Lorentzian g(ν):</b> separates “how much light exists” (u) from “how well the atom couples at that ν” (g).</li>
        <li><b>Mode treated as δ-function in frequency:</b> appropriate when cavity mode linewidth is much narrower than the atomic linewidth, or when we are told only photon number in a mode.</li>
      </ul>

      <h3>Mini intuition examples</h3>
      <ul>
        <li>If all photons are <b>exactly on resonance</b>, stimulated transitions are maximized: g(ν) is largest at ν=ν<sub>0</sub>.</li>
        <li>If photons are <b>detuned by one FWHM</b>, the Lorentzian value drops by a factor of 5 (you’ll see this in the plots).</li>
      </ul>

      <div class="callout mistakes">
        <h4>What to watch for (pitfalls)</h4>
        <ul>
          <li>Mixing up <b>Δν (FWHM)</b> with the half-width γ = Δν/2 inside the Lorentzian.</li>
          <li>Using total energy density u (J/m³) without accounting for the <b>spectral weighting</b> via g(ν).</li>
          <li>For discrete modes: forgetting that the correct operation is effectively an integral with a δ-spike → multiply by g(ν<sub>m</sub>).</li>
          <li>Confusing “rate per atom” with “total photons emitted per second” (which also depends on how many atoms are in level 2).</li>
        </ul>
      </div>
    </section>

    <section id="part1" class="fadeIn">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Problem restatement (in plain language)</h3>
      <p style="color:var(--muted); margin:0;">
        A two-level atom has a transition wavelength λ<sub>0</sub>=0.7&nbsp;µm and a spontaneous lifetime τ<sub>sp</sub>=3&nbsp;ns.
        The atomic transition has a Lorentzian spectral lineshape with FWHM Δν=50&nbsp;GHz.
        The atom sits in a cavity of volume V=100&nbsp;cm³ and refractive index n=1 (vacuum-like).
        Two cavity modes are populated: one at the transition frequency ν<sub>0</sub> and one detuned to ν<sub>0</sub>+Δν.
        Each mode contains 1000 photons.
        We must (i) compute the stimulated emission (or absorption) transition probability per unit time, (ii) write the decay constant for N<sub>2</sub> excited atoms including stimulated+spontaneous emission, and (iii) find how many photons are needed so stimulated decay equals spontaneous decay.
      </p>

      <div class="grid2" style="margin-top:12px;">
        <div class="callout">
          <h4>Given quantities</h4>
          <ul>
            <li>λ<sub>0</sub> = 0.7 µm</li>
            <li>τ<sub>sp</sub> = 3 ns ⇒ A<sub>21</sub> = 1/τ<sub>sp</sub></li>
            <li>Atomic lineshape: Lorentzian with Δν (FWHM) = 50 GHz</li>
            <li>Cavity: V = 100 cm³ = 1.0×10⁻⁴ m³, n = 1</li>
            <li>Mode 1: ν<sub>1</sub>=ν<sub>0</sub>, photons N<sub>ph</sub>=1000</li>
            <li>Mode 2: ν<sub>2</sub>=ν<sub>0</sub>+Δν, photons N<sub>ph</sub>=1000</li>
          </ul>
        </div>
        <div class="callout">
          <h4>Unknowns (what to find)</h4>
          <ul>
            <li>Stimulated transition rate per atom: W<sub>stim</sub> (s⁻¹) from the two modes</li>
            <li>Decay constant for N<sub>2</sub> excited atoms: k = A<sub>21</sub> + W<sub>stim</sub></li>
            <li>Photon number N<sub>ph,eq</sub> such that W<sub>stim</sub> = A<sub>21</sub></li>
          </ul>
        </div>
      </div>

      <h3>Relevant physical principles (and why they apply)</h3>
      <ul>
        <li><b>Einstein coefficients:</b> directly connect spontaneous emission and stimulated emission strengths for a two-level transition.</li>
        <li><b>Spectral overlap via g(ν):</b> needed because one cavity mode is detuned; the Lorentzian dictates reduced coupling.</li>
        <li><b>Energy density of cavity photons:</b> photon number in a mode determines field energy available for stimulation.</li>
      </ul>

      <div class="callout assumptions">
        <h4>Assumptions / idealizations</h4>
        <ul>
          <li>Weak-field, <b>unsaturated</b> two-level response (linear Einstein-rate picture).</li>
          <li>Equal degeneracies so <b>B<sub>12</sub>≈B<sub>21</sub></b> (typical unless stated otherwise); hence absorption and stimulated emission have the same coefficient, differing by population in the initial level.</li>
          <li>Cavity modes treated as <b>spectrally sharp</b> relative to the atomic linewidth (mode = δ at ν<sub>m</sub>).</li>
          <li>n=1 so ν<sub>0</sub>=c/λ<sub>0</sub> (no medium correction needed here).</li>
        </ul>
      </div>

      <h3>Possible approaches (compare &amp; choose)</h3>
      <ul>
        <li><b>Approach A (Einstein + spectral energy density):</b> Compute B from A, then compute W<sub>stim</sub>=∫B u(ν)g(ν)dν with discrete-mode δ-spikes. <b>Best</b> because the problem gives A, Δν, photon numbers, and V.</li>
        <li><b>Approach B (Cross section + photon flux):</b> Convert linewidth to a peak absorption cross section and multiply by photon flux. Works but needs more intermediate relations and careful normalization.</li>
        <li><b>Approach C (Cavity QED / Jaynes–Cummings):</b> Overkill; would require coupling g and mode linewidths not provided.</li>
      </ul>
      <p style="color:var(--muted); margin:0;">
        We choose <b>Approach A</b> because it uses exactly the data provided and matches the wording “probability density for stimulated emission (or absorption)”.
      </p>
    </section>

    <section id="part2" class="fadeIn">
      <h2>PART 2 — Strategy &amp; Tips (Roadmap Only)</h2>
      <ol style="color:var(--muted); margin:0; padding-left:18px;">
        <li><b>Compute transition frequency</b> ν<sub>0</sub>=c/λ<sub>0</sub>. <span style="color:var(--faint);">Goal: set the optical scale.</span></li>
        <li><b>Compute spontaneous rate</b> A<sub>21</sub>=1/τ<sub>sp</sub>. <span style="color:var(--faint);">Goal: baseline decay without light.</span></li>
        <li><b>Use Einstein relation</b> to find B<sub>21</sub> from A<sub>21</sub>. <span style="color:var(--faint);">Goal: link spontaneous to stimulated strength.</span></li>
        <li><b>Write normalized Lorentzian</b> g(ν) with given FWHM Δν. <span style="color:var(--faint);">Goal: handle detuning properly.</span></li>
        <li><b>Compute mode energy densities</b> u<sub>m</sub> = N<sub>ph</sub> hν<sub>m</sub>/V for each mode. <span style="color:var(--faint);">Goal: translate photon numbers into field energy density.</span></li>
        <li><b>Evaluate overlap</b> for each mode: W<sub>m</sub>=B<sub>21</sub> u<sub>m</sub> g(ν<sub>m</sub>). <span style="color:var(--faint);">Goal: get per-atom stimulated rate contributions.</span></li>
        <li><b>Sum contributions</b> W<sub>stim</sub>=W<sub>1</sub>+W<sub>2</sub>. <span style="color:var(--faint);">Goal: total stimulated emission probability per unit time.</span></li>
        <li><b>Write N<sub>2</sub> decay law</b> dN<sub>2</sub>/dt = −(A<sub>21</sub>+W<sub>stim</sub>)N<sub>2</sub>. <span style="color:var(--faint);">Goal: extract the decay constant.</span></li>
        <li><b>Solve equality condition</b> W<sub>stim</sub>=A<sub>21</sub> for required photon number. <span style="color:var(--faint);">Goal: when stimulated matches spontaneous.</span></li>
      </ol>

      <div class="callout mistakes" style="margin-top:12px;">
        <h4>Common mistakes &amp; quick tips</h4>
        <ul>
          <li><b>Tip:</b> For a Lorentzian with FWHM Δν, the half-width is Δν/2. Don’t substitute Δν where Δν/2 belongs.</li>
          <li><b>Tip:</b> g(ν) has units 1/Hz; it is a <i>probability density in frequency</i>. A narrow mode effectively samples g at its own frequency.</li>
          <li><b>Tip:</b> The stimulated rate scales <b>linearly</b> with photon number → equality photon count can be found by simple proportionality once W is computed for 1000 photons.</li>
        </ul>
      </div>
    </section>

    <section id="part3" class="fadeIn">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Physical intuition first (what to expect)</h3>
      <p style="color:var(--muted); margin:0;">
        Optical spontaneous decay for a 3 ns lifetime is extremely fast: A<sub>21</sub>≈3×10<sup>8</sup> s⁻¹.
        In a relatively large cavity volume (100 cm³), even 1000 photons correspond to a very small energy density.
        So we expect <b>stimulated emission to be tiny</b> unless the photon number is astronomically large or the field is strongly confined.
        The detuned mode should contribute less because the Lorentzian overlap decreases away from ν<sub>0</sub>.
      </p>

      <h3>Step 1: Convert wavelength to frequency</h3>
      <div class="eq" data-copy="nu0_eq">
        <button class="copyBtn" data-copy-btn="nu0_eq">Copy</button>
        <span id="nu0_eq">ν0 = c / λ0</span>
        <br/><small>With n=1, use vacuum c.</small>
      </div>
      <p style="color:var(--muted);">
        Given λ<sub>0</sub>=0.7 µm = 0.7×10⁻⁶ m, so:
      </p>
      <div class="eq" data-copy="nu0_num">
        <button class="copyBtn" data-copy-btn="nu0_num">Copy</button>
        <span id="nu0_num">ν0 = (2.99792458×10^8 m/s) / (0.7×10^-6 m) = 4.2827494×10^14 Hz</span>
      </div>

      <h3>Step 2: Spontaneous emission rate</h3>
      <div class="eq" data-copy="A_eq">
        <button class="copyBtn" data-copy-btn="A_eq">Copy</button>
        <span id="A_eq">A21 = 1 / τsp</span>
      </div>
      <p style="color:var(--muted); margin:0;">
        With τ<sub>sp</sub>=3 ns=3×10⁻⁹ s:
      </p>
      <div class="eq" data-copy="A_num">
        <button class="copyBtn" data-copy-btn="A_num">Copy</button>
        <span id="A_num">A21 = 1/(3×10^-9 s) = 3.3333333×10^8 s^-1</span>
      </div>

      <h3>Step 3: Get B<sub>21</sub> from A<sub>21</sub></h3>
      <div class="eq" data-copy="AB_eq">
        <button class="copyBtn" data-copy-btn="AB_eq">Copy</button>
        <span id="AB_eq">A21 = (8π h ν0^3 / c^3) B21  ⇒  B21 = A21 c^3 / (8π h ν0^3)</span>
      </div>
      <p style="color:var(--muted); margin:0;">
        Using h=6.62607015×10⁻³⁴ J·s and c=2.99792458×10⁸ m/s:
      </p>
      <div class="eq" data-copy="B_num">
        <button class="copyBtn" data-copy-btn="B_num">Copy</button>
        <span id="B_num">B21 = 6.8656×10^21 (SI units consistent with u(ν) in J·m^-3·Hz^-1)</span>
        <br/><small>We will use B21 inside W = ∫ B21 u(ν) g(ν) dν.</small>
      </div>
      <p style="color:var(--muted); margin:0;">
        <b>What we did and why:</b> A<sub>21</sub> is given (via lifetime). The Einstein relation lets us compute the
        stimulated coupling strength B<sub>21</sub> without needing dipole moments.
      </p>

      <h3>Step 4: Write the Lorentzian lineshape (normalized)</h3>
      <div class="eq" data-copy="lor_eq">
        <button class="copyBtn" data-copy-btn="lor_eq">Copy</button>
        <span id="lor_eq">g(ν) = (1/π) * ( (Δν/2) / [ (ν−ν0)^2 + (Δν/2)^2 ] ) ,  ∫ g(ν) dν = 1</span>
      </div>
      <p style="color:var(--muted); margin:0;">
        Here Δν is the <b>FWHM</b> (50 GHz). Define the half-width γ = Δν/2 = 25 GHz.
      </p>

      <h3>Step 5: Represent each cavity mode as a δ-spike in frequency</h3>
      <p style="color:var(--muted); margin:0;">
        A single cavity mode at frequency ν<sub>m</sub> containing N photons has total energy
        E<sub>m</sub>=N hν<sub>m</sub>. Distributed over volume V, the (total) energy density is:
      </p>
      <div class="eq" data-copy="u_mode">
        <button class="copyBtn" data-copy-btn="u_mode">Copy</button>
        <span id="u_mode">u_m (total) = (N h νm) / V  (J·m^-3)</span>
      </div>
      <p style="color:var(--muted); margin:0;">
        For the stimulated-rate integral W = ∫ B u(ν) g(ν) dν, a spectrally sharp mode corresponds to
        u(ν) = u<sub>m</sub> δ(ν−ν<sub>m</sub>). Therefore:
      </p>
      <div class="eq" data-copy="delta_rule">
        <button class="copyBtn" data-copy-btn="delta_rule">Copy</button>
        <span id="delta_rule">W_m = ∫ B21 [u_m δ(ν−νm)] g(ν) dν = B21 u_m g(νm)</span>
      </div>

      <h3>Step 6: Compute the two-mode stimulated rate for the given numbers</h3>
      <p style="color:var(--muted); margin:0;">
        Convert volume: V = 100 cm³ = 100×10⁻⁶ m³ = 1.0×10⁻⁴ m³.
        Each mode has N=1000 photons.
      </p>

      <div class="grid2" style="margin-top:12px;">
        <div class="callout keyeq">
          <h4>Evaluate g(ν) at the two mode frequencies</h4>
          <div class="eq" data-copy="g_res">
            <button class="copyBtn" data-copy-btn="g_res">Copy</button>
            <span id="g_res">g(ν0) = (1/π) * (γ / (0^2 + γ^2)) = 1/(πγ) = 2/(πΔν)</span>
          </div>
          <div class="eq" data-copy="g_det">
            <button class="copyBtn" data-copy-btn="g_det">Copy</button>
            <span id="g_det">g(ν0+Δν) = (1/π) * (γ / (Δν^2 + γ^2)) = (2/(5πΔν))</span>
          </div>
          <p style="color:var(--muted); margin:0;">
            So a detuning by one FWHM reduces the Lorentzian value by a factor of 5:
            g(ν0+Δν) = g(ν0)/5.
          </p>
        </div>
        <div class="callout">
          <h4>Compute energy densities per mode</h4>
          <div class="eq" data-copy="u1u2">
            <button class="copyBtn" data-copy-btn="u1u2">Copy</button>
            <span id="u1u2">u1 = (N h ν0)/V,  u2 = (N h (ν0+Δν))/V</span>
          </div>
          <p style="color:var(--muted); margin:0;">
            Numerically (with N=1000, V=1.0×10⁻⁴ m³):
          </p>
          <div class="eq" data-copy="u_num">
            <button class="copyBtn" data-copy-btn="u_num">Copy</button>
            <span id="u_num">u1 ≈ 2.838×10^-12 J·m^-3,  u2 ≈ 2.838×10^-12 J·m^-3</span>
          </div>
        </div>
      </div>

      <p style="color:var(--muted); margin-top:12px;">
        Now compute each mode’s stimulated transition rate contribution:
      </p>
      <div class="eq" data-copy="W_each">
        <button class="copyBtn" data-copy-btn="W_each">Copy</button>
        <span id="W_each">W1 = B21 u1 g(ν0),  W2 = B21 u2 g(ν0+Δν),  Wstim = W1 + W2</span>
      </div>

      <div class="callout answer" style="margin-top:12px;">
        <h4>Stimulated emission (or absorption) probability per unit time — numeric (given case)</h4>
        <div class="kpi">
          <div class="box">
            <div class="label">Mode at ν0 contribution (W1)</div>
            <div class="value" id="outW1">—</div>
          </div>
          <div class="box">
            <div class="label">Detuned mode at ν0+Δν contribution (W2)</div>
            <div class="value" id="outW2">—</div>
          </div>
          <div class="box">
            <div class="label">Total stimulated rate (Wstim)</div>
            <div class="value" id="outWtot">—</div>
          </div>
          <div class="box">
            <div class="label">Spontaneous rate (A21)</div>
            <div class="value" id="outA">—</div>
          </div>
        </div>
        <div class="eq" style="margin-top:10px;" data-copy="stim_answer_text">
          <button class="copyBtn" data-copy-btn="stim_answer_text">Copy</button>
          <span id="stim_answer_text">Given 1000 photons in each mode: W1 ≈ 0.248 s^-1, W2 ≈ 0.0496 s^-1, so Wstim ≈ 0.298 s^-1 per atom (for stimulated emission if in level 2, or absorption if in level 1).</span>
        </div>
      </div>

      <h3>Step 7: Decay constant for N<sub>2</sub> excited atoms</h3>
      <p style="color:var(--muted); margin:0;">
        If N<sub>2</sub> atoms occupy the upper level, each can decay spontaneously at rate A<sub>21</sub> and can also undergo stimulated emission at rate W<sub>stim</sub>.
        The population rate equation is:
      </p>
      <div class="eq" data-copy="N2eq">
        <button class="copyBtn" data-copy-btn="N2eq">Copy</button>
        <span id="N2eq">dN2/dt = −(A21 + Wstim) N2  ⇒  N2(t) = N2(0) exp[−t/τeff]</span>
      </div>
      <div class="eq" data-copy="tau_eff">
        <button class="copyBtn" data-copy-btn="tau_eff">Copy</button>
        <span id="tau_eff">Decay constant: k = A21 + Wstim ; effective lifetime: τeff = 1/k</span>
      </div>

      <div class="callout answer" style="margin-top:12px;">
        <h4>Decay constant (given case)</h4>
        <div class="eq" data-copy="k_num">
          <button class="copyBtn" data-copy-btn="k_num">Copy</button>
          <span id="k_num">k = A21 + Wstim ≈ 3.3333333×10^8 s^-1 + 0.2977 s^-1 ≈ 3.3333333×10^8 s^-1 (to 9 significant digits)</span>
        </div>
        <p style="color:var(--muted); margin:0;">
          <b>Interpretation:</b> the stimulated contribution from 1000 photons in a 100 cm³ cavity is negligible compared to spontaneous decay for a 3 ns lifetime.
        </p>
      </div>

      <h3>Step 8: Photon number needed so stimulated equals spontaneous</h3>
      <p style="color:var(--muted); margin:0;">
        Since W<sub>stim</sub> is linear in photon number N (energy density scales with N), we can scale directly:
      </p>
      <div class="eq" data-copy="scale_eq">
        <button class="copyBtn" data-copy-btn="scale_eq">Copy</button>
        <span id="scale_eq">If Wstim(N0)=W0 at N0 photons per mode, then Wstim(N)=W0*(N/N0). Set Wstim(N)=A21 ⇒ N = N0*(A21/W0).</span>
      </div>

      <div class="callout answer" style="margin-top:12px;">
        <h4>Required photons (given detuning and linewidth)</h4>
        <div class="eq" data-copy="Nreq_text">
          <button class="copyBtn" data-copy-btn="Nreq_text">Copy</button>
          <span id="Nreq_text">With W0 ≈ 0.2977 s^-1 at N0=1000 photons per mode: Nph,eq ≈ 1000*(3.3333×10^8 / 0.2977) ≈ 1.12×10^12 photons per mode.</span>
        </div>
        <p style="color:var(--muted); margin:0;">
          This is the photon number in each mode (assuming both modes scale together as in the original statement).
        </p>
      </div>

      <h3>Sanity checks</h3>
      <ul>
        <li><b>Units:</b> g(ν) has units 1/Hz; u has units J/m³; the integral ∫u(ν)g(ν)dν yields J/m³; multiplying by B gives s⁻¹ as required.</li>
        <li><b>Limiting case:</b> If detuning → 0 for both modes, both contribute with g(ν0) and W increases (you can test by setting detuning to 0 in the slider).</li>
        <li><b>Physical reasonableness:</b> Optical spontaneous rates ~10⁸–10⁹ s⁻¹ are huge; making stimulated comparable in a large volume requires enormous photon density.</li>
      </ul>

      <p style="color:var(--muted); margin:0;">
        Connection to visuals: the Lorentzian plot shows why the detuned mode is weaker; the rate-vs-photon plot shows linear scaling and where it crosses A<sub>21</sub>.
      </p>
    </section>

    <section id="part4" class="fadeIn">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpreting the final formula</h3>
      <div class="eq" data-copy="final_formula">
        <button class="copyBtn" data-copy-btn="final_formula">Copy</button>
        <span id="final_formula">Wstim = B21 * Σ_m [ (N_m h ν_m / V) * g(ν_m) ]</span>
      </div>
      <ul>
        <li><b>B<sub>21</sub></b> sets the intrinsic coupling strength of the transition (linked to its radiative lifetime).</li>
        <li><b>N<sub>m</sub>/V</b> is the photon number density (more photons or smaller volume → larger stimulated rate).</li>
        <li><b>g(ν<sub>m</sub>)</b> is the spectral overlap: detuning suppresses stimulation.</li>
        <li><b>ν<sub>m</sub></b> appears because photon energy is hν (slightly higher energy for slightly higher ν).</li>
      </ul>

      <h3>How changing parameters affects the outcome (connect to plots)</h3>
      <ul>
        <li><b>Photon number:</b> W<sub>stim</sub> grows linearly with N (main plot slope). Doubling photons doubles stimulated rate.</li>
        <li><b>Linewidth (Δν):</b> A broader line lowers the peak g(ν0) ~ 2/(πΔν), reducing the on-resonance contribution (secondary plot flattens).</li>
        <li><b>Detuning:</b> Moving the second mode farther from resonance quickly reduces its contribution due to the Lorentzian tails (secondary plot marker drops).</li>
        <li><b>Volume:</b> Not slider-controlled here, but shrinking V increases u and therefore W<sub>stim</sub> (cavity confinement is powerful).</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p style="color:var(--muted); margin:0;">
        You can derive the same scaling using an <b>absorption cross section</b> σ(ν) for a Lorentzian line and the photon
        flux Φ = (c/n)·(energy density)/(hν), giving W ≈ σ(ν)Φ. When expressed in Einstein-coefficient language, it collapses to
        the same B·u·g weighting (with consistent normalizations).
      </p>

      <h3>Concept check (quick self-test)</h3>
      <ul>
        <li><b>Q:</b> If the linewidth doubles, what happens to the on-resonance stimulated rate (all else fixed)?<br/>
            <b>A:</b> It roughly halves because g(ν0) ∝ 1/Δν.</li>
        <li><b>Q:</b> Why does a detuned mode still contribute at all?<br/>
            <b>A:</b> Because the Lorentzian has nonzero tails: g(ν) &gt; 0 even off resonance.</li>
        <li><b>Q:</b> Does W<sub>stim</sub> depend on how many atoms are present?<br/>
            <b>A:</b> The per-atom rate does not; the <i>total</i> stimulated emission power scales with the number of excited atoms N<sub>2</sub>.</li>
        <li><b>Q:</b> Why are photon numbers for equality so huge here?<br/>
            <b>A:</b> Because A<sub>21</sub> is ~10⁸ s⁻¹, while 1000 photons spread over 10⁻⁴ m³ give a tiny energy density.</li>
      </ul>
    </section>

    <section id="part5" class="fadeIn">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <div class="grid2">
        <div class="controls">
          <div class="control">
            <label for="logN">
              <span>Photon number per mode, log<sub>10</sub>(N)</span>
              <span class="pill"><b id="labN">1000</b> photons</span>
            </label>
            <input id="logN" type="range" min="0" max="12.5" step="0.01" value="3.00"/>
            <div class="hint">Moves the marked point on the rate plot and rescales the mode “spikes” in the Lorentzian plot.</div>
          </div>

          <div class="control">
            <label for="dDet">
              <span>Detuning of Mode 2: δ = ν<sub>2</sub>−ν<sub>0</sub> (GHz)</span>
              <span class="pill"><b id="labDet">50</b> GHz</span>
            </label>
            <input id="dDet" type="range" min="0" max="200" step="0.1" value="50"/>
            <div class="hint">Shifts Mode 2 along the Lorentzian; changes W2 and the total stimulated rate.</div>
          </div>

          <div class="control">
            <label for="dFwhm">
              <span>Atomic linewidth Δν (FWHM) (GHz)</span>
              <span class="pill"><b id="labFwhm">50</b> GHz</span>
            </label>
            <input id="dFwhm" type="range" min="5" max="200" step="0.5" value="50"/>
            <div class="hint">Broader line lowers peak overlap but widens tails; watch both plots update.</div>
          </div>

          <div class="callout answer">
            <h4>Live computed outputs (current slider settings)</h4>
            <div class="kpi">
              <div class="box">
                <div class="label">W1 (s⁻¹)</div>
                <div class="value" id="liveW1">—</div>
              </div>
              <div class="box">
                <div class="label">W2 (s⁻¹)</div>
                <div class="value" id="liveW2">—</div>
              </div>
              <div class="box">
                <div class="label">Wstim = W1+W2 (s⁻¹)</div>
                <div class="value" id="liveW">—</div>
              </div>
              <div class="box">
                <div class="label">N needed for Wstim = A21</div>
                <div class="value" id="liveNeq">—</div>
              </div>
            </div>
          </div>
        </div>

        <div class="viz">
          <figure>
            <canvas id="cnvDiagram" aria-label="Labeled physical setup diagram"></canvas>
            <figcaption><b>Diagram:</b> cavity volume with two populated modes interacting with a two-level atom (levels 1 and 2). Photon numbers and frequencies are labeled.</figcaption>
          </figure>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <figure>
          <canvas id="cnvMain" aria-label="Main plot: stimulated and spontaneous rates vs photon number"></canvas>
          <figcaption><b>Main plot:</b> stimulated rate (depends on N) vs photon number (log scale), with a horizontal line at A<sub>21</sub>. The crossing indicates equal stimulated and spontaneous decay.</figcaption>
        </figure>
        <figure>
          <canvas id="cnvSecondary" aria-label="Secondary plot: Lorentzian overlap and mode contributions"></canvas>
          <figcaption><b>Secondary plot:</b> Lorentzian lineshape g(ν) vs detuning (GHz), with markers at Mode 1 and Mode 2. Marker height indicates each mode’s contribution to W (proportional to u·g).</figcaption>
        </figure>
      </div>

      <div class="callout">
        <h4>How the controls affect the visuals</h4>
        <ul>
          <li><b>Photon number slider:</b> scales u = N hν/V, so both W1 and W2 change linearly → main plot point moves vertically, and secondary markers grow/shrink.</li>
          <li><b>Detuning slider:</b> changes g(ν2) while leaving ν1 on resonance → W2 changes strongly, affecting totals in both plots.</li>
          <li><b>Linewidth slider:</b> changes Lorentzian peak and width → both mode overlaps change (especially on-resonant peak), shifting equality photon count.</li>
        </ul>
      </div>
    </section>
  </article>
</main>

<footer class="footer">
  <div>
    Built with vanilla HTML/CSS/JS. Numbers assume n=1, discrete sharp cavity modes, and a normalized Lorentzian atomic line with given FWHM.
  </div>
</footer>

<script>
(function(){
  // ---------- Constants ----------
  const c = 299792458;                 // m/s
  const h = 6.62607015e-34;            // J*s
  const lambda0 = 0.7e-6;              // m
  const tau_sp = 3e-9;                 // s
  const V = 1e-4;                      // m^3 (100 cm^3)
  const nu0 = c / lambda0;             // Hz
  const A21 = 1 / tau_sp;              // s^-1
  // Einstein relation: A21 = (8π h ν0^3 / c^3) B21
  const B21 = A21 * Math.pow(c,3) / (8*Math.PI*h*Math.pow(nu0,3));

  // Default problem values:
  const N_problem = 1000;
  const det_problem_GHz = 50;
  const fwhm_problem_GHz = 50;

  // ---------- DOM ----------
  const logN = document.getElementById('logN');
  const dDet = document.getElementById('dDet');
  const dFwhm = document.getElementById('dFwhm');

  const labN = document.getElementById('labN');
  const labDet = document.getElementById('labDet');
  const labFwhm = document.getElementById('labFwhm');

  const outW1 = document.getElementById('outW1');
  const outW2 = document.getElementById('outW2');
  const outWtot = document.getElementById('outWtot');
  const outA = document.getElementById('outA');

  const liveW1 = document.getElementById('liveW1');
  const liveW2 = document.getElementById('liveW2');
  const liveW = document.getElementById('liveW');
  const liveNeq = document.getElementById('liveNeq');

  // Canvases
  const cnvDiagram = document.getElementById('cnvDiagram');
  const cnvMain = document.getElementById('cnvMain');
  const cnvSecondary = document.getElementById('cnvSecondary');

  // ---------- Helpers ----------
  function fmt(x, sig=4){
    if (!isFinite(x)) return "—";
    const ax = Math.abs(x);
    if (ax === 0) return "0";
    if (ax >= 1e4 || ax < 1e-3) return x.toExponential(sig);
    return x.toFixed(Math.max(0, sig - Math.floor(Math.log10(ax)) - 1));
  }
  function fmtInt(x){
    if (!isFinite(x)) return "—";
    if (x < 1e6) return Math.round(x).toString();
    return x.toExponential(3);
  }
  function lorentzian(detHz, fwhmHz){
    // g(ν) as function of detuning (ν - ν0): normalized Lorentzian
    // g = (1/π) * (γ / (det^2 + γ^2)), where γ = fwhm/2.
    const gamma = fwhmHz/2;
    return (1/Math.PI) * (gamma / (detHz*detHz + gamma*gamma)); // 1/Hz
  }
  function computeRates(Nphot, det2Hz, fwhmHz){
    const nu1 = nu0;
    const nu2 = nu0 + det2Hz;

    const u1 = (Nphot * h * nu1) / V; // J/m^3
    const u2 = (Nphot * h * nu2) / V; // J/m^3

    const g1 = lorentzian(0, fwhmHz);
    const g2 = lorentzian(det2Hz, fwhmHz);

    const W1 = B21 * u1 * g1; // s^-1
    const W2 = B21 * u2 * g2; // s^-1
    const W = W1 + W2;
    const k = A21 + W;

    // N needed such that W(N) = A21. Since W scales linearly with N:
    const Neq = (W>0) ? (Nphot * (A21/W)) : Infinity;

    return {nu1,nu2,u1,u2,g1,g2,W1,W2,W,k,Neq};
  }

  // ---------- Copy buttons ----------
  function setupCopy(){
    document.querySelectorAll('[data-copy-btn]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-copy-btn');
        const el = document.getElementById(id);
        if(!el) return;
        const text = el.textContent.replace(/\s+/g,' ').trim();
        try{
          await navigator.clipboard.writeText(text);
          const old = btn.textContent;
          btn.textContent = "Copied!";
          setTimeout(()=>btn.textContent=old, 850);
        }catch(e){
          btn.textContent = "Copy failed";
          setTimeout(()=>btn.textContent="Copy", 850);
        }
      });
    });
  }

  // ---------- Canvas rendering (HiDPI) ----------
  function prepCanvas(canvas){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(320, rect.width);
    const h = rect.height || 320;
    canvas.width = Math.round(w * dpr);
    canvas.height = Math.round(h * dpr);
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {ctx, w, h, dpr};
  }

  function drawAxes(ctx, x0, y0, w, h, opts){
    const {
      xLabel="x", yLabel="y", title="",
      xTicks=5, yTicks=5,
      xMin=0,xMax=1,yMin=0,yMax=1,
      grid=true
    } = opts;

    // background
    ctx.clearRect(0,0,ctx.canvas.width,ctx.canvas.height);

    // Title
    ctx.save();
    ctx.fillStyle = "rgba(233,238,252,0.95)";
    ctx.font = "600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(title, x0, y0-10);
    ctx.restore();

    // plot area rect
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,0.14)";
    ctx.lineWidth = 1;
    ctx.strokeRect(x0,y0,w,h);
    ctx.restore();

    // grid + ticks
    function niceTicks(min,max,n){
      const span = max-min;
      if(span<=0) return [min];
      const raw = span/(n-1);
      const pow = Math.pow(10, Math.floor(Math.log10(raw)));
      const candidates = [1,2,5,10].map(k=>k*pow);
      let step = candidates[0];
      for(const c of candidates){
        if(Math.abs(c-raw) < Math.abs(step-raw)) step=c;
      }
      const start = Math.ceil(min/step)*step;
      const ticks=[];
      for(let v=start; v<=max+1e-12; v+=step) ticks.push(v);
      return ticks;
    }

    const xt = niceTicks(xMin,xMax,xTicks);
    const yt = niceTicks(yMin,yMax,yTicks);

    ctx.save();
    ctx.fillStyle = "rgba(185,196,230,0.85)";
    ctx.strokeStyle = "rgba(255,255,255,0.10)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    ctx.lineWidth = 1;

    // x ticks
    xt.forEach(v=>{
      const t = (v-xMin)/(xMax-xMin);
      const x = x0 + t*w;
      if(grid){
        ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y0+h); ctx.stroke();
      }
      ctx.beginPath(); ctx.moveTo(x,y0+h); ctx.lineTo(x,y0+h+6); ctx.stroke();
      ctx.fillText(formatTick(v), x-10, y0+h+18);
    });

    // y ticks
    yt.forEach(v=>{
      const t = (v-yMin)/(yMax-yMin);
      const y = y0 + (1-t)*h;
      if(grid){
        ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x0+w,y); ctx.stroke();
      }
      ctx.beginPath(); ctx.moveTo(x0-6,y); ctx.lineTo(x0,y); ctx.stroke();
      ctx.fillText(formatTick(v), x0-54, y+4);
    });

    // labels
    ctx.save();
    ctx.fillStyle = "rgba(185,196,230,0.9)";
    ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(xLabel, x0 + w - ctx.measureText(xLabel).width, y0+h+36);
    // y label rotated
    ctx.translate(x0-64, y0 + h/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
    ctx.restore();

    ctx.restore();

    function formatTick(v){
      const av = Math.abs(v);
      if(av>=1e4 || av<1e-3) return v.toExponential(1);
      if(av>=100) return v.toFixed(0);
      if(av>=10) return v.toFixed(1);
      return v.toFixed(2);
    }
  }

  function plotLine(ctx, x0,y0,w,h, xs, ys, xMin,xMax,yMin,yMax, style){
    ctx.save();
    ctx.strokeStyle = style || "rgba(118,167,255,0.95)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<xs.length;i++){
      const tx = (xs[i]-xMin)/(xMax-xMin);
      const ty = (ys[i]-yMin)/(yMax-yMin);
      const x = x0 + tx*w;
      const y = y0 + (1-ty)*h;
      if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
    ctx.restore();
  }

  function plotHLine(ctx, x0,y0,w,h, yVal, xMin,xMax,yMin,yMax, style){
    const ty = (yVal-yMin)/(yMax-yMin);
    const y = y0 + (1-ty)*h;
    ctx.save();
    ctx.strokeStyle = style || "rgba(255,207,90,0.95)";
    ctx.lineWidth = 2;
    ctx.setLineDash([6,6]);
    ctx.beginPath();
    ctx.moveTo(x0,y); ctx.lineTo(x0+w,y);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.restore();
  }

  function plotPoint(ctx, x0,y0,w,h, xVal,yVal, xMin,xMax,yMin,yMax, style){
    const tx = (xVal-xMin)/(xMax-xMin);
    const ty = (yVal-yMin)/(yMax-yMin);
    const x = x0 + tx*w;
    const y = y0 + (1-ty)*h;
    ctx.save();
    ctx.fillStyle = style || "rgba(125,255,207,0.95)";
    ctx.strokeStyle = "rgba(0,0,0,0.35)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(x,y,5,0,Math.PI*2);
    ctx.fill();
    ctx.stroke();
    ctx.restore();
  }

  function drawLegend(ctx, items, x, y){
    ctx.save();
    ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillStyle = "rgba(233,238,252,0.9)";
    let yy = y;
    items.forEach(it=>{
      ctx.save();
      ctx.strokeStyle = it.color;
      ctx.lineWidth = 3;
      if(it.dash){ ctx.setLineDash(it.dash); }
      ctx.beginPath();
      ctx.moveTo(x,yy); ctx.lineTo(x+22,yy);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.restore();
      ctx.fillText(it.label, x+30, yy+4);
      yy += 18;
    });
    ctx.restore();
  }

  // ---------- Drawers ----------
  function drawDiagram(state){
    const {ctx,w,h} = prepCanvas(cnvDiagram);
    const pad = 18;

    // background haze
    ctx.save();
    ctx.clearRect(0,0,w,h);
    ctx.fillStyle = "rgba(0,0,0,0.10)";
    ctx.fillRect(0,0,w,h);
    ctx.restore();

    // cavity box
    const bx = pad, by = pad+22, bw = w - 2*pad, bh = h - (2*pad+40);
    ctx.save();
    ctx.strokeStyle = "rgba(255,255,255,0.18)";
    ctx.lineWidth = 2;
    ctx.fillStyle = "rgba(118,167,255,0.06)";
    roundRect(ctx, bx, by, bw, bh, 16);
    ctx.fill(); ctx.stroke();
    ctx.restore();

    // Title
    ctx.save();
    ctx.fillStyle="rgba(233,238,252,0.95)";
    ctx.font="700 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText("Physical setup: atom + two cavity modes in volume V", pad, pad+14);
    ctx.restore();

    // Atom (two-level) in center
    const ax = bx + bw*0.5, ay = by + bh*0.55;
    ctx.save();
    // energy levels
    ctx.strokeStyle="rgba(233,238,252,0.8)";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(ax-42, ay-50); ctx.lineTo(ax+42, ay-50);
    ctx.moveTo(ax-42, ay+30); ctx.lineTo(ax+42, ay+30);
    ctx.stroke();
    // labels
    ctx.fillStyle="rgba(185,196,230,0.9)";
    ctx.font="12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    ctx.fillText("Level 2", ax+52, ay-46);
    ctx.fillText("Level 1", ax+52, ay+34);
    // transition arrow
    ctx.strokeStyle="rgba(125,255,207,0.95)";
    ctx.lineWidth=2;
    ctx.beginPath();
    ctx.moveTo(ax, ay-45); ctx.lineTo(ax, ay+25);
    ctx.stroke();
    // arrow head
    ctx.beginPath();
    ctx.moveTo(ax-6, ay+14); ctx.lineTo(ax, ay+28); ctx.lineTo(ax+6, ay+14);
    ctx.stroke();

    ctx.fillStyle="rgba(125,255,207,0.95)";
    ctx.fillText("ν0", ax+10, ay-6);
    ctx.restore();

    // Mode "waves"
    function drawWave(y, color, label){
      ctx.save();
      ctx.strokeStyle=color;
      ctx.lineWidth=2;
      const left = bx+20, right = bx+bw-20;
      const mid = (left+right)/2;
      ctx.beginPath();
      const A = 10;
      for(let x=left; x<=right; x+=2){
        const t = (x-left)/(right-left) * Math.PI*6;
        const yy = y + A*Math.sin(t);
        if(x===left) ctx.moveTo(x,yy); else ctx.lineTo(x,yy);
      }
      ctx.stroke();
      ctx.fillStyle="rgba(185,196,230,0.9)";
      ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText(label, left, y-14);
      ctx.restore();
    }

    const Ntxt = fmtInt(state.N);
    drawWave(by+bh*0.25, "rgba(118,167,255,0.95)", `Mode 1: ν1 = ν0,  N = ${Ntxt} photons`);
    drawWave(by+bh*0.80, "rgba(255,207,90,0.95)", `Mode 2: ν2 = ν0 + δ,  δ = ${fmt(state.detGHz,3)} GHz,  N = ${Ntxt}`);

    // Volume label
    ctx.save();
    ctx.fillStyle="rgba(185,196,230,0.9)";
    ctx.font="12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    ctx.fillText(`V = 1.0×10^-4 m^3 (100 cm^3), n = 1`, bx+14, by+bh-12);
    ctx.restore();
  }

  function drawMainPlot(state){
    const {ctx,w,h} = prepCanvas(cnvMain);

    const marginL=70, marginR=18, marginT=40, marginB=56;
    const x0=marginL, y0=marginT, pw=w-marginL-marginR, ph=h-marginT-marginB;

    // x axis is log10(N) from 0 to 12.5
    const xMin=0, xMax=12.5;

    // y axis: show both Wstim and A21; A21 is huge ~3e8.
    // We'll show y in log10(rate) to visualize both.
    const yMin= -1;      // 10^-1
    const yMax= 9.2;     // ~1.6e9

    drawAxes(ctx,x0,y0,pw,ph,{
      title:"Rates vs photon number per mode (log scales)",
      xLabel:"log10(N photons per mode)",
      yLabel:"log10(rate) (s^-1)",
      xTicks:6,yTicks:6,
      xMin,xMax,yMin,yMax,
      grid:true
    });

    // Build curve of Wstim(N)
    const xs=[], ysStim=[], ysTot=[];
    for(let x=xMin; x<=xMax+1e-9; x+=0.1){
      const N = Math.pow(10,x);
      const r = computeRates(N, state.detHz, state.fwhmHz);
      const logW = Math.log10(Math.max(r.W, 1e-20));
      xs.push(x);
      ysStim.push(logW);
      ysTot.push(Math.log10(r.k));
    }

    // Plot stimulated
    plotLine(ctx,x0,y0,pw,ph,xs,ysStim,xMin,xMax,yMin,yMax,"rgba(125,255,207,0.95)");
    // Plot total decay constant (A+W)
    plotLine(ctx,x0,y0,pw,ph,xs,ysTot,xMin,xMax,yMin,yMax,"rgba(118,167,255,0.95)");

    // Horizontal A21
    plotHLine(ctx,x0,y0,pw,ph,Math.log10(A21),xMin,xMax,yMin,yMax,"rgba(255,207,90,0.95)");

    // Mark current point
    const xNow = Math.log10(state.N);
    const rNow = computeRates(state.N, state.detHz, state.fwhmHz);
    const yNow = Math.log10(Math.max(rNow.W, 1e-20));
    plotPoint(ctx,x0,y0,pw,ph,xNow,yNow,xMin,xMax,yMin,yMax,"rgba(255,107,122,0.95)");

    // Legend
    drawLegend(ctx,[
      {label:"Wstim (stimulated)", color:"rgba(125,255,207,0.95)"},
      {label:"k = A21+Wstim", color:"rgba(118,167,255,0.95)"},
      {label:"A21 (spontaneous)", color:"rgba(255,207,90,0.95)", dash:[6,6]},
      {label:"Current slider point", color:"rgba(255,107,122,0.95)"}
    ], x0+8, y0+18);

    // annotation for equality
    ctx.save();
    ctx.fillStyle="rgba(185,196,230,0.9)";
    ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText("Crossing where Wstim = A21 → stimulated equals spontaneous", x0+8, y0+ph+48);
    ctx.restore();
  }

  function drawSecondaryPlot(state){
    const {ctx,w,h} = prepCanvas(cnvSecondary);

    const marginL=70, marginR=18, marginT=40, marginB=56;
    const x0=marginL, y0=marginT, pw=w-marginL-marginR, ph=h-marginT-marginB;

    // detuning range in GHz
    const xMin=-120, xMax=220;
    // y is g(ν) in 1/Hz. Values around ~1e-11 for 50 GHz.
    // We'll plot in units of 1/GHz to be more readable: g_GHz = g_Hz * 1e9.
    // So y around 1e-2.
    const fwhmGHz = state.fwhmHz/1e9;
    const gPeak = lorentzian(0, state.fwhmHz) * 1e9; // 1/GHz
    const yMin=0;
    const yMax=Math.max(0.06, gPeak*1.35);

    drawAxes(ctx,x0,y0,pw,ph,{
      title:"Atomic Lorentzian lineshape and mode sampling",
      xLabel:"Detuning (ν − ν0) [GHz]",
      yLabel:"g(ν) [1/GHz]",
      xTicks:6,yTicks:6,
      xMin,xMax,yMin,yMax,
      grid:true
    });

    // Plot Lorentzian curve
    const xs=[], ys=[];
    for(let x=xMin; x<=xMax+1e-9; x+=1){
      const detHz = x*1e9;
      xs.push(x);
      ys.push(lorentzian(detHz, state.fwhmHz)*1e9);
    }
    plotLine(ctx,x0,y0,pw,ph,xs,ys,xMin,xMax,yMin,yMax,"rgba(233,238,252,0.90)");

    // Mode markers: detuning 0 and det2
    const r = computeRates(state.N, state.detHz, state.fwhmHz);
    const g1 = r.g1*1e9;
    const g2 = r.g2*1e9;

    // Draw vertical lines at modes
    function vline(xGHz, color){
      const t = (xGHz-xMin)/(xMax-xMin);
      const x = x0 + t*pw;
      ctx.save();
      ctx.strokeStyle=color;
      ctx.lineWidth=2;
      ctx.setLineDash([5,6]);
      ctx.beginPath();
      ctx.moveTo(x,y0); ctx.lineTo(x,y0+ph);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.restore();
      return x;
    }
    const x1 = vline(0,"rgba(125,255,207,0.85)");
    const x2 = vline(state.detGHz,"rgba(255,207,90,0.85)");

    // Contribution bars: proportional to u*g (since W = B u g). We'll show normalized bars inside plot.
    // Compute normalized heights based on W1 and W2 relative to max(W1,W2) (avoid huge scaling issues).
    const maxW = Math.max(r.W1, r.W2, 1e-30);
    const bar1 = (r.W1/maxW) * (ph*0.35);
    const bar2 = (r.W2/maxW) * (ph*0.35);

    function barAt(xPix, height, color, label){
      ctx.save();
      ctx.fillStyle=color;
      ctx.globalAlpha=0.35;
      ctx.fillRect(xPix-10, y0+ph-height, 20, height);
      ctx.globalAlpha=1.0;
      ctx.strokeStyle=color;
      ctx.lineWidth=2;
      ctx.strokeRect(xPix-10, y0+ph-height, 20, height);

      ctx.fillStyle="rgba(185,196,230,0.9)";
      ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText(label, xPix-36, y0+ph-height-8);
      ctx.restore();
    }

    barAt(x1, bar1, "rgba(125,255,207,0.95)", "W1");
    barAt(x2, bar2, "rgba(255,207,90,0.95)", "W2");

    // Mark points on the Lorentzian curve at the mode positions
    plotPoint(ctx,x0,y0,pw,ph,0,g1,xMin,xMax,yMin,yMax,"rgba(125,255,207,0.95)");
    plotPoint(ctx,x0,y0,pw,ph,state.detGHz,g2,xMin,xMax,yMin,yMax,"rgba(255,207,90,0.95)");

    // Legend
    drawLegend(ctx,[
      {label:`Lorentzian g(ν) (Δν=${fmt(fwhmGHz,3)} GHz)`, color:"rgba(233,238,252,0.90)"},
      {label:"Mode 1 (on resonance)", color:"rgba(125,255,207,0.95)", dash:[5,6]},
      {label:"Mode 2 (detuned)", color:"rgba(255,207,90,0.95)", dash:[5,6]},
      {label:"Bars show relative W1, W2", color:"rgba(185,196,230,0.8)"}
    ], x0+8, y0+18);

    // footnote
    ctx.save();
    ctx.fillStyle="rgba(185,196,230,0.9)";
    ctx.font="12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText("Markers sample g at each mode; contribution ∝ u·g (and u ∝ N/V).", x0+8, y0+ph+48);
    ctx.restore();
  }

  function roundRect(ctx,x,y,w,h,r){
    const rr = Math.min(r, w/2, h/2);
    ctx.beginPath();
    ctx.moveTo(x+rr,y);
    ctx.arcTo(x+w,y,x+w,y+h,rr);
    ctx.arcTo(x+w,y+h,x,y+h,rr);
    ctx.arcTo(x,y+h,x,y,rr);
    ctx.arcTo(x,y,x+w,y,rr);
    ctx.closePath();
  }

  // ---------- Update loop ----------
  function getState(){
    const N = Math.pow(10, parseFloat(logN.value));
    const detGHz = parseFloat(dDet.value);
    const fwhmGHz = parseFloat(dFwhm.value);
    return {
      N,
      detGHz,
      detHz: detGHz*1e9,
      fwhmGHz,
      fwhmHz: fwhmGHz*1e9
    };
  }

  function updateTextAndNumbers(){
    const state = getState();

    labN.textContent = fmtInt(state.N);
    labDet.textContent = fmt(state.detGHz,3);
    labFwhm.textContent = fmt(state.fwhmGHz,3);

    const r = computeRates(state.N, state.detHz, state.fwhmHz);

    liveW1.textContent = `${fmt(r.W1,4)} s^-1`;
    liveW2.textContent = `${fmt(r.W2,4)} s^-1`;
    liveW.textContent  = `${fmt(r.W,4)} s^-1`;
    liveNeq.textContent = isFinite(r.Neq) ? `${fmtInt(r.Neq)} photons/mode` : "—";

    return state;
  }

  function renderAll(){
    const state = updateTextAndNumbers();
    drawDiagram(state);
    drawMainPlot(state);
    drawSecondaryPlot(state);
  }

  // ---------- Fill the fixed (given-case) outputs in PART 3 ----------
  function setGivenCaseOutputs(){
    const r = computeRates(N_problem, det_problem_GHz*1e9, fwhm_problem_GHz*1e9);
    outW1.textContent = `${fmt(r.W1,4)} s^-1`;
    outW2.textContent = `${fmt(r.W2,4)} s^-1`;
    outWtot.textContent = `${fmt(r.W,4)} s^-1`;
    outA.textContent = `${fmt(A21,4)} s^-1`;
  }

  // ---------- Events ----------
  function attach(){
    [logN,dDet,dFwhm].forEach(el=>{
      el.addEventListener('input', renderAll);
    });

    // responsive re-render
    const ro = new ResizeObserver(()=>renderAll());
    ro.observe(cnvDiagram);
    ro.observe(cnvMain);
    ro.observe(cnvSecondary);
    window.addEventListener('resize', renderAll);
  }

  // ---------- Init ----------
  setupCopy();
  setGivenCaseOutputs();
  attach();
  renderAll();
})();
</script>
</body>
</html>
