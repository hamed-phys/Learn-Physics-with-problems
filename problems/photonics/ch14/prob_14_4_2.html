<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Rate Equations for Broadband Radiation in a Leaky Resonator (Two-Level Atoms)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1624;
      --card:#121b2c;
      --text:#e9eefc;
      --muted:#aab6d6;
      --soft:#7f8bb0;
      --line:rgba(255,255,255,.10);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#86efac;
      --warn:#fbbf24;
      --bad:#fb7185;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --r: 16px;
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      background: radial-gradient(1200px 800px at 20% 5%, rgba(125,211,252,.12), transparent 55%),
                  radial-gradient(1000px 800px at 90% 10%, rgba(167,139,250,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.55;
    }
    header{
      padding:28px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }
    .titlebar{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      align-items:end;
    }
    h1{
      margin:0;
      font-size: clamp(1.35rem, 2.2vw, 2.1rem);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      max-width: 75ch;
      font-size: clamp(.95rem, 1.2vw, 1.05rem);
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 14px 18px 60px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
    }

    nav#toc{
      position: sticky;
      top: 14px;
      align-self:start;
      background: linear-gradient(180deg, rgba(18,27,44,.92), rgba(15,22,36,.88));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }
    nav#toc .toc-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    nav#toc .toc-head b{
      font-size:.95rem;
      letter-spacing:.3px;
    }
    nav#toc .toc-head button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 10px;
      padding:6px 9px;
      cursor:pointer;
      font-size:.85rem;
    }
    nav#toc ul{
      list-style:none;
      padding: 10px 10px 14px;
      margin:0;
      display:grid;
      gap:6px;
    }
    nav#toc a{
      display:block;
      padding:8px 10px;
      border-radius: 12px;
      text-decoration:none;
      color: var(--muted);
      border:1px solid transparent;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-size:.93rem;
    }
    nav#toc a:hover{
      background: rgba(125,211,252,.08);
      border-color: rgba(125,211,252,.25);
      color: var(--text);
      transform: translateX(2px);
    }

    section{
      background: linear-gradient(180deg, rgba(18,27,44,.78), rgba(15,22,36,.65));
      border:1px solid var(--line);
      border-radius: var(--r);
      box-shadow: var(--shadow);
      padding:18px;
      backdrop-filter: blur(10px);
      margin-bottom:18px;
    }
    section h2{
      margin:0 0 10px;
      font-size: clamp(1.05rem, 1.55vw, 1.35rem);
    }
    section h3{
      margin:16px 0 8px;
      font-size: 1.05rem;
      color: var(--text);
    }
    p{ margin: 8px 0; color: var(--text); }
    .muted{ color: var(--muted); }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .card{
      background: rgba(255,255,255,.04);
      border:1px solid var(--line);
      border-radius: 14px;
      padding:14px;
    }
    .callout{
      border-left: 4px solid var(--accent);
      background: rgba(125,211,252,.08);
      padding:12px 12px 12px 12px;
      border-radius: 14px;
      border:1px solid rgba(125,211,252,.22);
    }
    .callout.warn{
      border-left-color: var(--warn);
      background: rgba(251,191,36,.08);
      border-color: rgba(251,191,36,.22);
    }
    .callout.good{
      border-left-color: var(--good);
      background: rgba(134,239,172,.08);
      border-color: rgba(134,239,172,.22);
    }
    .callout.bad{
      border-left-color: var(--bad);
      background: rgba(251,113,133,.08);
      border-color: rgba(251,113,133,.22);
    }

    ul{ margin: 8px 0 8px 18px; color: var(--text); }
    li{ margin: 6px 0; }
    .eq{
      position:relative;
      padding:12px 44px 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      font-family: var(--mono);
      font-size: .92rem;
      overflow:auto;
      white-space: pre;
    }
    .copyBtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 10px;
      padding:6px 8px;
      cursor:pointer;
      font-size:.8rem;
    }
    .copyBtn:active{ transform: translateY(1px); }
    .pill{
      display:inline-block;
      font-family: var(--mono);
      font-size: .82rem;
      color: var(--text);
      background: rgba(167,139,250,.12);
      border:1px solid rgba(167,139,250,.25);
      padding:3px 8px;
      border-radius: 999px;
      margin-right:6px;
    }
    .kpi{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    .kpi .mini{
      padding:10px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      min-width: 190px;
    }
    .kpi .mini b{ display:block; font-size:.9rem; }
    .kpi .mini span{ color: var(--muted); font-family: var(--mono); font-size:.9rem; }

    figure{
      margin: 0;
      padding: 10px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
    }
    figcaption{
      margin-top:8px;
      color: var(--muted);
      font-size:.9rem;
    }
    canvas{
      width:100%;
      height:340px;
      display:block;
      border-radius: 12px;
    }
    .row{
      display:flex;
      gap:12px;
      flex-wrap:wrap;
      align-items:flex-end;
      justify-content:space-between;
      margin: 8px 0 0;
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      width: 100%;
    }
    @media (max-width: 980px){
      .controls{ grid-template-columns: 1fr; }
    }
    .control{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
    }
    .control label{
      display:flex;
      justify-content:space-between;
      gap:12px;
      font-size:.92rem;
      color: var(--text);
      margin-bottom: 8px;
    }
    .control label span{
      color: var(--muted);
      font-family: var(--mono);
    }
    input[type="range"], select{
      width:100%;
      accent-color: var(--accent);
    }
    .note{
      color: var(--muted);
      font-size: .92rem;
    }

    .hr{
      height:1px;
      background: var(--line);
      margin: 14px 0;
    }

    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 30px;
      color: var(--muted);
      font-size:.92rem;
    }

    /* subtle entrance */
    section{ animation: rise .35s ease both; transform-origin: 50% 0; }
    @keyframes rise{
      from{ opacity:0; transform: translateY(10px); }
      to{ opacity:1; transform: translateY(0); }
    }

    @media print{
      body{ background:#fff; color:#000; }
      nav#toc{ display:none; }
      section, figure{ box-shadow:none; backdrop-filter:none; }
      section{ break-inside: avoid; border:1px solid #ddd; }
      .copyBtn{ display:none; }
      canvas{ height:260px; }
    }
  </style>
</head>
<body>
<header>
  <div class="titlebar">
    <h1>Rate Equations for Broadband Radiation in a Leaky Resonator (Two-Level Atoms)</h1>
    <div class="subtitle">
      We derive coupled rate equations for the excited-state population <span class="pill">N₂</span> and the mean photon number per cavity mode <span class="pill">n̄</span> when many cavity modes within a bandwidth around the atomic resonance exchange photons with a two-level atomic ensemble and photons leak out with lifetime <span class="pill">τₚ</span>.
    </div>
  </div>
</header>

<main>
  <!-- TOC -->
  <nav id="toc" aria-label="Table of contents">
    <div class="toc-head">
      <b>Table of Contents</b>
      <button id="tocToggle" type="button" title="Collapse/expand">Collapse</button>
    </div>
    <ul id="tocList">
      <li><a href="#quick">Quick Summary</a></li>
      <li><a href="#part0">PART 0 — Concept Primer</a></li>
      <li><a href="#part1">PART 1 — Problem Analysis</a></li>
      <li><a href="#part2">PART 2 — Strategy & Tips</a></li>
      <li><a href="#part3">PART 3 — Full Solution</a></li>
      <li><a href="#part4">PART 4 — Deeper Understanding</a></li>
      <li><a href="#part5">PART 5 — Visualization Guide</a></li>
      <li><a href="#viz">Interactive Visualizations</a></li>
    </ul>
  </nav>

  <div>
    <!-- Quick Summary -->
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>What this is about:</b> two-level atoms in a cavity exchanging photons with a <b>broad band</b> of cavity modes near the atomic resonance frequency <span class="pill">ν₀</span>.</li>
        <li><b>Key idea:</b> treat emission/absorption as <b>rate processes</b> using Einstein <span class="pill">A</span> and <span class="pill">B</span> coefficients; photons leak out with lifetime <span class="pill">τₚ</span>.</li>
        <li><b>Governing physics:</b> population rate equation
          <span class="pill">dN₂/dt</span> includes spontaneous emission, stimulated emission, and absorption.</li>
        <li><b>Broadband modeling:</b> many modes <span class="pill">M</span> in bandwidth <span class="pill">Δν</span>; each mode has mean photon number <span class="pill">n̄</span>.</li>
        <li><b>Photon rate:</b> total photons in the band are <span class="pill">Nph = M n̄</span>, increased by (stimulated + spontaneous) emission and decreased by absorption and leakage.</li>
        <li><b>Final result type:</b> <b>symbolic coupled rate equations</b> for <span class="pill">N₂</span> and <span class="pill">n̄</span> (plus definitions of <span class="pill">M</span> and spectral density).</li>
      </ul>
      <div class="callout good">
        <b>Core takeaway:</b> The only “new” ingredient versus single-mode laser rate equations is the factor
        <span class="pill">M ≈ ρ(ν₀)Δν</span> (number of participating modes), which converts total photon creation/destruction into per-mode change <span class="pill">dn̄/dt</span>.
      </div>
    </section>

    <!-- PART 0 -->
    <section id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div class="card">
          <h3>Core definitions (symbols & units)</h3>
          <ul>
            <li><b>Two-level atoms:</b> lower level 1, upper level 2.</li>
            <li><span class="pill">N₁, N₂</span> = number of atoms in levels 1 and 2 (dimensionless counts) in <b>unit volume</b>.</li>
            <li><span class="pill">ν₀</span> = transition resonance frequency (Hz).</li>
            <li><span class="pill">Δν</span> = linewidth / effective interaction bandwidth (Hz).</li>
            <li><span class="pill">n̄</span> = <b>mean photon number per cavity mode</b> in the interacting band (dimensionless).</li>
            <li><span class="pill">τₚ</span> = photon lifetime in cavity due to losses (s).</li>
            <li><span class="pill">A₂₁</span> = spontaneous emission coefficient (s⁻¹).</li>
            <li><span class="pill">B₁₂, B₂₁</span> = Einstein stimulated absorption/emission coefficients (units depend on choice of energy density; treated consistently below).</li>
            <li><span class="pill">ρ(ν)</span> = electromagnetic mode density per unit volume per Hz (modes·m⁻³·Hz⁻¹).</li>
          </ul>
        </div>

        <div class="card">
          <h3>Physical meaning</h3>
          <ul>
            <li><b>Spontaneous emission</b> (<span class="pill">A₂₁ N₂</span>): excited atoms decay even with zero photons present.</li>
            <li><b>Stimulated processes</b> scale with radiation field strength:
              absorption ∝ <span class="pill">B₁₂ u(ν₀) N₁</span>, stimulated emission ∝ <span class="pill">B₂₁ u(ν₀) N₂</span>.</li>
            <li><b>Broadband cavity field</b>: many modes near <span class="pill">ν₀</span>, each with occupancy <span class="pill">n̄</span>. This is “thermal-like” bookkeeping, even if the distribution is not truly thermal.</li>
            <li><b>Leakage</b>: photons leave the resonator at rate <span class="pill">1/τₚ</span> → a decay term for photon number.</li>
          </ul>
        </div>
      </div>

      <div class="hr"></div>

      <h3>Key laws/principles (and validity)</h3>
      <div class="callout">
        <ul>
          <li><b>Einstein rate model:</b> valid when coherence can be ignored (population dynamics slower than optical period; no need for optical Bloch equations).</li>
          <li><b>Broadband approximation:</b> assume radiation spectral density is approximately constant across the relevant linewidth/band around <span class="pill">ν₀</span>.</li>
          <li><b>Closed radiative system (here):</b> “no nonradiative transitions” means all 2→1 relaxation is radiative and contributes to photons in the band (a standard idealization for rate-equation modeling).</li>
          <li><b>Photon loss as lifetime:</b> treat cavity decay as a simple exponential loss, giving a linear term <span class="pill">-Nph/τₚ</span>.</li>
        </ul>
      </div>

      <h3>Common models/approximations (why we use them)</h3>
      <ul>
        <li><b>Mode counting:</b> number of cavity modes in a band is approximated via free-space density of states:
          <span class="pill">ρ(ν) = 8πν²/c³</span> (includes two polarizations) for a large cavity / continuum of modes.</li>
        <li><b>Uniform occupancy:</b> “a total of <span class="pill">n̄</span> photons in each mode” means we can represent the whole band by one variable <span class="pill">n̄</span>.</li>
        <li><b>Per-mode vs total photons:</b> total photons in the band:
          <span class="pill">Nph = M n̄</span>, where <span class="pill">M ≈ ρ(ν₀)Δν</span>.</li>
      </ul>

      <h3>Mini intuition examples</h3>
      <ul>
        <li><b>Zero field:</b> if <span class="pill">n̄ = 0</span>, stimulated terms vanish, but <span class="pill">N₂</span> still decays via spontaneous emission.</li>
        <li><b>Large field:</b> if <span class="pill">n̄</span> is big, stimulated emission/absorption dominate and can rapidly exchange population between levels.</li>
      </ul>

      <div class="callout warn">
        <b>What to watch for (pitfalls):</b>
        <ul>
          <li>Confusing <span class="pill">n̄</span> (per-mode photon number) with total photons in the cavity band.</li>
          <li>Forgetting the <span class="pill">1/M</span> factor when converting a total photon rate into <span class="pill">dn̄/dt</span>.</li>
          <li>Mixing “energy density” <span class="pill">u(ν)</span> with “photon number” without defining the conversion.</li>
          <li>Assuming single-mode laser equations apply directly—broadband means many modes share the photons.</li>
        </ul>
      </div>
    </section>

    <!-- PART 1 -->
    <section id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Problem restatement (in plain words)</h3>
      <p>
        A unit-volume resonator contains two-level atoms (levels 1 and 2). The atomic transition is centered at frequency
        <span class="pill">ν₀</span> with linewidth <span class="pill">Δν</span>. There are <span class="pill">N₁</span> atoms in level 1 and
        <span class="pill">N₂</span> atoms in level 2. The cavity supports many electromagnetic modes in a broad band around <span class="pill">ν₀</span>,
        and <b>each mode</b> in that band contains a mean of <span class="pill">n̄</span> photons. Photons leak out of the resonator with lifetime
        <span class="pill">τₚ</span>. Assuming no nonradiative transitions, write down the coupled rate equations for
        <span class="pill">N₂</span> and <span class="pill">n̄</span>.
      </p>

      <div class="grid2">
        <div class="card">
          <h3>Given</h3>
          <ul>
            <li><span class="pill">ν₀</span> resonance frequency (Hz)</li>
            <li><span class="pill">Δν</span> linewidth / interaction band (Hz)</li>
            <li><span class="pill">N₁, N₂</span> populations (counts)</li>
            <li><span class="pill">n̄</span> photons per mode in the band (dimensionless)</li>
            <li><span class="pill">τₚ</span> photon lifetime due to leakage (s)</li>
            <li>No nonradiative 2↔1 transitions</li>
          </ul>
        </div>
        <div class="card">
          <h3>Unknowns / what must be found</h3>
          <ul>
            <li>Rate equation for <span class="pill">dN₂/dt</span></li>
            <li>Rate equation for <span class="pill">dn̄/dt</span></li>
            <li>Definitions needed to connect radiation strength to <span class="pill">n̄</span> (mode density, energy density, etc.)</li>
          </ul>
        </div>
      </div>

      <h3>Relevant principles (why they apply)</h3>
      <ul>
        <li><b>Einstein A/B processes:</b> the problem is explicitly about radiative transitions and broadband radiation, so rate equations based on emission/absorption are the natural tool.</li>
        <li><b>Photon leakage model:</b> loss at <span class="pill">1/τₚ</span> is a standard cavity decay term.</li>
        <li><b>Mode counting:</b> because the field is broadband, we need to relate per-mode photon number to total photon number in the band.</li>
      </ul>
      <p class="muted">
        We do <b>not</b> need full Maxwell–Bloch dynamics (coherence, Rabi oscillations) because the problem asks for rate equations and provides no phase/coherence information.
      </p>

      <div class="callout">
        <b>Assumptions (explicit):</b>
        <ul>
          <li>Broadband field around <span class="pill">ν₀</span> has (approximately) uniform occupancy <span class="pill">n̄</span> across the participating modes.</li>
          <li>The cavity is large enough to approximate a quasi-continuum of modes with density <span class="pill">ρ(ν)</span>.</li>
          <li>All 2→1 radiative decays contribute photons into the considered band (idealized, consistent with “no nonradiative transitions”).</li>
          <li>Photon loss is linear: total photons decay as <span class="pill">-Nph/τₚ</span>.</li>
        </ul>
      </div>

      <h3>Possible approaches (compare & choose)</h3>
      <ul>
        <li><b>Approach A: Einstein A/B with spectral energy density</b> <span class="pill">u(ν₀)</span>.
          <br><span class="muted">Pros:</span> clean and standard; matches textbook derivations.
          <span class="muted">Cons:</span> must convert <span class="pill">u</span> ↔ <span class="pill">n̄</span>.</li>
        <li><b>Approach B: Photon-number bookkeeping directly</b> (count photons created/destroyed).
          <br><span class="muted">Pros:</span> very intuitive; naturally incorporates leakage and the <span class="pill">M</span> modes.
          <span class="muted">Cons:</span> still needs a link between stimulated rates and field strength.</li>
        <li><b>Approach C: Optical Bloch equations → rate equations</b> (adiabatic elimination).
          <br><span class="muted">Pros:</span> most general.
          <span class="muted">Cons:</span> overkill; needs parameters not provided.</li>
      </ul>
      <p><b>Best choice:</b> Approach A + photon bookkeeping: write <span class="pill">dN₂/dt</span> with Einstein coefficients, then write a total-photon equation and convert to <span class="pill">dn̄/dt</span> using mode count <span class="pill">M</span>.</p>
    </section>

    <!-- PART 2 -->
    <section id="part2">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

      <ol>
        <li><b>Define the interacting mode band</b>:
          goal = count how many modes participate.
          tool = density of states <span class="pill">ρ(ν)</span>.
          meaning = converts “per mode” to “total”.</li>
        <li><b>Write the population equation for</b> <span class="pill">N₂</span>:
          goal = net gain/loss of excited atoms.
          tool = Einstein processes: spontaneous (<span class="pill">A₂₁</span>), stimulated (<span class="pill">B₂₁ u</span>), absorption (<span class="pill">B₁₂ u</span>).</li>
        <li><b>Relate spectral energy density to</b> <span class="pill">n̄</span>:
          goal = express field strength using photon occupancy.
          tool = energy per mode <span class="pill">hν</span> and mode density <span class="pill">ρ(ν₀)</span>.</li>
        <li><b>Write the total photon-number equation</b> in the band:
          goal = count photons created/destroyed by atomic transitions.
          tool = “one photon per transition” bookkeeping.</li>
        <li><b>Add cavity leakage</b>:
          goal = include photon loss.
          tool = <span class="pill">-Nph/τₚ</span>.</li>
        <li><b>Convert total photon rate to per-mode rate</b>:
          goal = get <span class="pill">dn̄/dt</span>.
          tool = divide by <span class="pill">M</span>.</li>
      </ol>

      <div class="callout warn">
        <b>Common mistakes & quick tips:</b>
        <ul>
          <li><b>Mistake:</b> writing <span class="pill">-n̄/τₚ</span> but forgetting that leakage acts on total photons too.
            <br><b>Tip:</b> start from <span class="pill">Nph = M n̄</span> and apply leakage to <span class="pill">Nph</span>; you’ll recover <span class="pill">-n̄/τₚ</span> automatically because <span class="pill">M</span> is constant.</li>
          <li><b>Mistake:</b> using <span class="pill">u(ν₀) = ρ hν n̄ Δν</span> (extra <span class="pill">Δν</span>).
            <br><b>Tip:</b> <span class="pill">u(ν)</span> is per Hz. The band energy density is <span class="pill">u_band ≈ u(ν₀)Δν</span>.</li>
          <li><b>Mistake:</b> mixing photon number and energy density without defining the conversion.
            <br><b>Tip:</b> write the conversion once and reuse it everywhere.</li>
        </ul>
      </div>
    </section>

    <!-- PART 3 -->
    <section id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Physical intuition first (before equations)</h3>
      <p>
        Excited atoms (level 2) can decay to level 1 in two ways:
        <b>spontaneously</b> (always happening) and <b>stimulated</b> (enhanced when the cavity band has photons).
        Conversely, photons in the band can be <b>absorbed</b> by atoms in level 1, pushing them to level 2.
        Meanwhile, photons leak out through imperfect cavity mirrors with lifetime <span class="pill">τₚ</span>.
        So we expect <span class="pill">N₂</span> and <span class="pill">n̄</span> to be coupled: more photons → faster stimulated transitions; more excited atoms → more emission into the field.
      </p>

      <div class="callout">
        <b>Step 1 — Mode counting in the band</b><br/>
        For a large cavity (continuum of modes), the electromagnetic mode density per unit volume per frequency is
        <span class="pill">ρ(ν) = 8πν²/c³</span> (two polarizations).
        The number of cavity modes within a band of width <span class="pill">Δν</span> around <span class="pill">ν₀</span> in unit volume is
      </div>

      <div class="eq" id="eqM">
        M ≈ ρ(ν₀) Δν = (8π ν₀² / c³) Δν
        <button class="copyBtn" data-copy="#eqM">Copy</button>
      </div>

      <p class="muted">
        This is the key broadband ingredient: the band contains <span class="pill">M</span> modes, and the problem states each has mean occupancy <span class="pill">n̄</span>.
      </p>

      <h3>Step 2 — Write the excited-state population rate equation</h3>
      <p>
        Let <span class="pill">u(ν₀)</span> denote the <b>spectral energy density</b> (energy per unit volume per Hz) near resonance.
        Using Einstein coefficients:
      </p>
      <ul>
        <li><b>Absorption (1→2):</b> rate = <span class="pill">B₁₂ u(ν₀) N₁</span> increases <span class="pill">N₂</span>.</li>
        <li><b>Stimulated emission (2→1):</b> rate = <span class="pill">B₂₁ u(ν₀) N₂</span> decreases <span class="pill">N₂</span>.</li>
        <li><b>Spontaneous emission (2→1):</b> rate = <span class="pill">A₂₁ N₂</span> decreases <span class="pill">N₂</span>.</li>
      </ul>

      <div class="eq" id="eqN2">
dN₂/dt = + B₁₂ u(ν₀) N₁  − B₂₁ u(ν₀) N₂  − A₂₁ N₂
        <button class="copyBtn" data-copy="#eqN2">Copy</button>
      </div>

      <p>
        <b>What we did:</b> we added “gain” terms to <span class="pill">N₂</span> and subtracted “loss” terms, assuming only radiative transitions connect the two levels.
      </p>

      <h3>Step 3 — Relate the field strength u(ν₀) to the per-mode photon number n̄</h3>
      <p>
        In a band where each mode has mean photon number <span class="pill">n̄</span>, the <b>mean energy per mode</b> is approximately <span class="pill">hν₀ n̄</span>.
        The number of modes per unit volume per Hz is <span class="pill">ρ(ν₀)</span>, so the energy per unit volume per Hz (spectral energy density) is
      </p>

      <div class="eq" id="equconv">
u(ν₀) ≈ ρ(ν₀) · hν₀ · n̄
(where ρ(ν₀) = 8πν₀²/c³)
        <button class="copyBtn" data-copy="#equconv">Copy</button>
      </div>

      <p class="muted">
        Notice: no factor of <span class="pill">Δν</span> appears because <span class="pill">u(ν)</span> is defined per Hz; the band energy density would be <span class="pill">u_band ≈ u(ν₀)Δν</span>.
      </p>

      <h3>Step 4 — Write the photon-number rate equation (total photons in the band)</h3>
      <p>
        Let <span class="pill">Nph</span> be the <b>total number of photons</b> in all modes of the band. Since there are <span class="pill">M</span> modes each with mean occupancy <span class="pill">n̄</span>:
      </p>

      <div class="eq" id="eqNph">
Nph = M n̄
        <button class="copyBtn" data-copy="#eqNph">Copy</button>
      </div>

      <p>
        Now count photon creation/destruction by atomic transitions:
      </p>
      <ul>
        <li><b>Each stimulated emission (2→1)</b> adds one photon to the band: <span class="pill">+ B₂₁ u(ν₀) N₂</span>.</li>
        <li><b>Each spontaneous emission (2→1)</b> adds one photon to the band: <span class="pill">+ A₂₁ N₂</span>.</li>
        <li><b>Each absorption (1→2)</b> removes one photon from the band: <span class="pill">− B₁₂ u(ν₀) N₁</span>.</li>
        <li><b>Leakage</b> removes photons at rate <span class="pill">Nph/τₚ</span>.</li>
      </ul>

      <div class="eq" id="eqPhotTot">
dNph/dt = + A₂₁ N₂ + B₂₁ u(ν₀) N₂ − B₁₂ u(ν₀) N₁ − (Nph/τₚ)
        <button class="copyBtn" data-copy="#eqPhotTot">Copy</button>
      </div>

      <p>
        <b>What we did:</b> we wrote a conservation-style balance: sources (emission) minus sinks (absorption + leakage).
      </p>

      <h3>Step 5 — Convert to the desired equation for dn̄/dt</h3>
      <p>
        Since <span class="pill">Nph = M n̄</span> and <span class="pill">M</span> is constant (fixed cavity + fixed <span class="pill">Δν</span>), we have <span class="pill">dNph/dt = M dn̄/dt</span>.
        Divide the total photon equation by <span class="pill">M</span>:
      </p>

      <div class="eq" id="eqnbar">
dn̄/dt = (1/M)[ A₂₁ N₂ + B₂₁ u(ν₀) N₂ − B₁₂ u(ν₀) N₁ ] − n̄/τₚ
        <button class="copyBtn" data-copy="#eqnbar">Copy</button>
      </div>

      <p>
        Finally, if you want everything explicitly in terms of <span class="pill">n̄</span>, substitute
        <span class="pill">u(ν₀) = ρ(ν₀) hν₀ n̄</span> and <span class="pill">M = ρ(ν₀)Δν</span>.
      </p>

      <div class="eq" id="eqFinalPair">
Let ρ₀ = ρ(ν₀) = 8πν₀²/c³ and M = ρ₀ Δν and u(ν₀) = ρ₀ hν₀ n̄.

Rate equations:

(1) dN₂/dt = + B₁₂ u(ν₀) N₁ − B₂₁ u(ν₀) N₂ − A₂₁ N₂

(2) dn̄/dt = (1/M)[ A₂₁ N₂ + B₂₁ u(ν₀) N₂ − B₁₂ u(ν₀) N₁ ] − n̄/τₚ
        <button class="copyBtn" data-copy="#eqFinalPair">Copy</button>
      </div>

      <div class="callout good">
        <b>Final Answer (boxed):</b><br/>
        The coupled rate equations are exactly (1)–(2) above, with the broadband-mode count <span class="pill">M = ρ(ν₀)Δν</span> and the conversion
        <span class="pill">u(ν₀) = ρ(ν₀) hν₀ n̄</span>.
      </div>

      <h3>Sanity checks</h3>
      <div class="grid2">
        <div class="card">
          <h3>Units / dimensions</h3>
          <ul>
            <li><span class="pill">dN₂/dt</span> has units s⁻¹ (since <span class="pill">N₂</span> is a count).</li>
            <li><span class="pill">dn̄/dt</span> has units s⁻¹ (dimensionless per second).</li>
            <li>Leakage term <span class="pill">-n̄/τₚ</span> has units s⁻¹.</li>
            <li>Einstein terms are consistent as long as <span class="pill">B u</span> has units s⁻¹ (which is how the coefficients are defined in this formulation).</li>
          </ul>
        </div>
        <div class="card">
          <h3>Limiting cases</h3>
          <ul>
            <li><b>No photons</b> (<span class="pill">n̄=0</span> ⇒ <span class="pill">u=0</span>): then <span class="pill">dN₂/dt = -A₂₁N₂</span> and
              <span class="pill">dn̄/dt = (A₂₁N₂/M) - n̄/τₚ</span>.</li>
            <li><b>Perfect cavity</b> (<span class="pill">τₚ → ∞</span>): leakage vanishes; photons accumulate from emission until absorption balances.</li>
            <li><b>Huge bandwidth</b> (large <span class="pill">M</span>): per-mode growth from a fixed total emission becomes smaller (because photons are shared among more modes).</li>
          </ul>
        </div>
      </div>

      <p>
        <b>Connection to the diagram/plots:</b> the diagram shows atoms in a cavity exchanging photons with many nearby-frequency modes;
        the plots below illustrate how the coupled ODEs drive <span class="pill">N₂(t)</span> and <span class="pill">n̄(t)</span>, and how changing the cavity lifetime <span class="pill">τₚ</span> changes the dynamics.
      </p>
    </section>

    <!-- PART 4 -->
    <section id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>What each term “controls”</h3>
      <ul>
        <li><span class="pill">A₂₁ N₂</span>:
          spontaneous decay of excited atoms; also a photon <b>source</b> in the photon equation.</li>
        <li><span class="pill">B₂₁ u N₂</span>:
          stimulated emission; scales with both field strength and excited population (positive feedback in lasers).</li>
        <li><span class="pill">B₁₂ u N₁</span>:
          absorption; a photon <b>sink</b> and excited-population <b>source</b>.</li>
        <li><span class="pill">M = ρ₀Δν</span>:
          “photon dilution” among modes—larger bandwidth means slower change in <span class="pill">n̄</span> for the same total emission.</li>
        <li><span class="pill">-n̄/τₚ</span>:
          cavity loss; shorter <span class="pill">τₚ</span> clamps <span class="pill">n̄</span> near zero unless emission is strong.</li>
      </ul>

      <h3>Parameter effects (tie to the interactive plots)</h3>
      <ul>
        <li><b>Increase τₚ (better mirrors):</b> photons remain longer → <span class="pill">n̄(t)</span> decays more slowly and can build up more from emission.</li>
        <li><b>Increase Δν (more modes):</b> <span class="pill">M</span> grows → each emitted photon is spread across more modes → per-mode <span class="pill">n̄</span> grows more slowly.</li>
        <li><b>Increase A₂₁ (faster spontaneous decay):</b> <span class="pill">N₂</span> decays faster; photons are injected faster, but leakage may dominate if <span class="pill">τₚ</span> is short.</li>
      </ul>

      <h3>Alternative derivation idea</h3>
      <p class="muted">
        You can derive similar equations starting from the optical Bloch equations for a two-level ensemble and
        adiabatically eliminating the coherence in the weak-field, broadband limit, which reduces the dynamics to rate equations.
        The Einstein-coefficient route used here is simpler and matches the problem’s intent.
      </p>

      <h3>Concept checks (self-test)</h3>
      <ul>
        <li><b>Q:</b> Why does <span class="pill">dn̄/dt</span> have a <span class="pill">1/M</span> factor in the emission/absorption terms?
          <br><b>A:</b> because those processes change the <b>total</b> photon number in the band; per-mode occupancy changes by total change divided among <span class="pill">M</span> modes.</li>
        <li><b>Q:</b> If <span class="pill">Δν</span> doubles (all else fixed), what happens to the per-mode photon buildup from a fixed excited population?
          <br><b>A:</b> <span class="pill">M</span> doubles, so the same total emission produces roughly half the per-mode growth rate.</li>
        <li><b>Q:</b> In the absence of atoms (<span class="pill">N₁=N₂=0</span>), what is the photon equation?
          <br><b>A:</b> <span class="pill">dn̄/dt = -n̄/τₚ</span> (pure cavity decay).</li>
        <li><b>Q:</b> Why is spontaneous emission included in the photon equation but not multiplied by <span class="pill">u</span>?
          <br><b>A:</b> it occurs even when <span class="pill">u=0</span>; it is field-independent.</li>
      </ul>
    </section>

    <!-- PART 5 -->
    <section id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>
      <p>
        The interactive figures below use <b>example values</b> (clearly shown in the control panel) because the problem statement is symbolic.
        The math and the final rate equations remain fully general.
      </p>

      <ul>
        <li><b>Diagram canvas:</b> shows a leaky cavity containing two-level atoms; photons in many nearby-frequency modes exchange with atoms; leakage sets <span class="pill">τₚ</span>.</li>
        <li><b>Main quantitative plot:</b> time evolution of <span class="pill">N₂(t)</span> and <span class="pill">n̄(t)</span> from the coupled ODEs.</li>
        <li><b>Secondary plot:</b> phase portrait <span class="pill">n̄</span> vs <span class="pill">N₂</span> showing the trajectory (how population decay and photon dynamics co-evolve).</li>
        <li><b>Interactive controls:</b>
          <ul>
            <li><span class="pill">τₚ</span> slider changes photon leakage rate (<span class="pill">1/τₚ</span>) → all plots update.</li>
            <li><span class="pill">Δν</span> slider changes number of modes <span class="pill">M</span> → per-mode photon dynamics changes.</li>
            <li><span class="pill">Initial inversion</span> controls the starting <span class="pill">N₂(0)</span> fraction → changes initial emission strength.</li>
          </ul>
        </li>
      </ul>

      <div class="callout warn">
        <b>Reading tip:</b> If you increase <span class="pill">Δν</span> (more modes), the same total emission is “shared” among more modes, so <span class="pill">n̄(t)</span> tends to be smaller at a given time—even though the total photon number <span class="pill">Nph = M n̄</span> may be similar.
      </div>
    </section>

    <!-- Visualizations -->
    <section id="viz">
      <h2>Interactive Visualizations</h2>

      <div class="controls">
        <div class="control">
          <label for="tauP">
            Photon lifetime τ<sub>p</sub> (s)
            <span id="tauPVal"></span>
          </label>
          <input id="tauP" type="range" min="-9" max="-5" step="0.01" value="-7.0"/>
          <div class="note">Slider is log10(τ<sub>p</sub>). Larger τ<sub>p</sub> = lower loss.</div>
        </div>

        <div class="control">
          <label for="dNu">
            Bandwidth Δν (Hz)
            <span id="dNuVal"></span>
          </label>
          <input id="dNu" type="range" min="7" max="12" step="0.02" value="9.0"/>
          <div class="note">Slider is log10(Δν). Larger Δν → more modes M = ρ(ν₀)Δν.</div>
        </div>

        <div class="control">
          <label for="inv0">
            Initial excited fraction f = N₂(0)/N
            <span id="inv0Val"></span>
          </label>
          <input id="inv0" type="range" min="0" max="1" step="0.01" value="0.7"/>
          <div class="note">Sets N₂(0); N₁(0)=N−N₂(0). No external pumping included.</div>
        </div>

        <div class="control">
          <label for="nbar0">
            Initial photons per mode n̄(0)
            <span id="nbar0Val"></span>
          </label>
          <input id="nbar0" type="range" min="0" max="50" step="0.1" value="2.0"/>
          <div class="note">Controls the initial field strength u(ν₀)=ρ(ν₀)hν₀ n̄.</div>
        </div>
      </div>

      <div class="row">
        <div class="kpi" id="kpi"></div>
      </div>

      <div class="grid2" style="margin-top:14px;">
        <figure>
          <canvas id="cDiagram" aria-label="Physical setup diagram"></canvas>
          <figcaption>
            Labeled setup: leaky cavity (photon lifetime τ<sub>p</sub>) with two-level atoms exchanging photons with many modes within Δν around ν<sub>0</sub>.
          </figcaption>
        </figure>

        <figure>
          <canvas id="cMain" aria-label="Main plot: time evolution"></canvas>
          <figcaption>
            Main plot: numerical integration (example values) of the coupled rate equations for N<sub>2</sub>(t) and n̄(t).
          </figcaption>
        </figure>
      </div>

      <figure style="margin-top:14px;">
        <canvas id="cPhase" aria-label="Secondary plot: phase portrait"></canvas>
        <figcaption>
          Secondary plot: phase portrait trajectory n̄ vs N<sub>2</sub> (how photons and excited population co-evolve).
        </figcaption>
      </figure>

      <div class="callout bad" style="margin-top:14px;">
        <b>Example-values disclaimer:</b> The plots use chosen parameters (A, B, ν₀, N) solely to illustrate behavior. Your final symbolic rate equations do not depend on these numerical choices.
      </div>
    </section>
  </div>
</main>

<footer>
  <div class="hr"></div>
  <p>
    Built for learning: symbolic derivation + interactive intuition. No external libraries used.
  </p>
</footer>

<script>
/* ---------- Utilities ---------- */
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function fmtSci(x, sig=3){
  if (x === 0) return "0";
  const exp = Math.floor(Math.log10(Math.abs(x)));
  const mant = x / Math.pow(10, exp);
  const m = mant.toFixed(sig-1);
  return `${m}e${exp>=0?"+":""}${exp}`;
}
function fmtNum(x){
  if (!isFinite(x)) return "—";
  const ax = Math.abs(x);
  if (ax>=1e4 || (ax>0 && ax<1e-3)) return fmtSci(x,3);
  return (Math.round(x*1000)/1000).toString();
}
async function copyTextFromSelector(sel){
  const el = document.querySelector(sel);
  if(!el) return;
  const txt = el.innerText.replace(/\n\s+\n/g,"\n\n").trim();
  try{
    await navigator.clipboard.writeText(txt);
    flash(el, "Copied ✓");
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    flash(el, "Copied ✓");
  }
}
function flash(el, msg){
  const old = el.style.outline;
  el.style.outline = "2px solid rgba(134,239,172,.6)";
  const badge = document.createElement("div");
  badge.textContent = msg;
  badge.style.position="absolute";
  badge.style.right="12px";
  badge.style.bottom="10px";
  badge.style.padding="4px 8px";
  badge.style.borderRadius="999px";
  badge.style.fontSize=".8rem";
  badge.style.background="rgba(134,239,172,.15)";
  badge.style.border="1px solid rgba(134,239,172,.35)";
  badge.style.color="rgba(233,238,252,.95)";
  badge.style.pointerEvents="none";
  badge.style.fontFamily="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  badge.style.backdropFilter="blur(8px)";
  el.style.position="relative";
  el.appendChild(badge);
  setTimeout(()=>{
    el.style.outline = old;
    badge.remove();
  }, 900);
}

/* ---------- TOC collapse ---------- */
const tocToggle = document.getElementById("tocToggle");
const tocList = document.getElementById("tocList");
let tocCollapsed = false;
tocToggle.addEventListener("click", ()=>{
  tocCollapsed = !tocCollapsed;
  tocList.style.display = tocCollapsed ? "none" : "grid";
  tocToggle.textContent = tocCollapsed ? "Expand" : "Collapse";
});

/* ---------- Copy buttons ---------- */
document.querySelectorAll(".copyBtn").forEach(btn=>{
  btn.addEventListener("click", ()=> copyTextFromSelector(btn.getAttribute("data-copy")));
});

/* ---------- Canvas helpers (HiDPI + axes) ---------- */
function setupCanvas(canvas){
  const ctx = canvas.getContext("2d");
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(2, Math.floor(rect.width * dpr));
    canvas.height = Math.max(2, Math.floor(rect.height * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  }
  resize();
  return {ctx, resize};
}
function clear(ctx, w, h){
  ctx.clearRect(0,0,w,h);
}
function drawPanelBg(ctx, w, h){
  // subtle background grid tint
  ctx.save();
  ctx.fillStyle = "rgba(0,0,0,.18)";
  ctx.fillRect(0,0,w,h);
  ctx.restore();
}
function drawAxes(ctx, rect, xMin,xMax,yMin,yMax, xLabel,yLabel, title, options={}){
  const {xTicks=6, yTicks=5, showLegend=false, legendItems=[]} = options;
  const {x,y,w,h} = rect;
  ctx.save();

  // background
  ctx.fillStyle = "rgba(255,255,255,.02)";
  ctx.fillRect(x,y,w,h);

  // grid + ticks
  ctx.lineWidth = 1;
  for(let i=0;i<=xTicks;i++){
    const t = i/xTicks;
    const X = x + t*w;
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    ctx.beginPath(); ctx.moveTo(X,y); ctx.lineTo(X,y+h); ctx.stroke();

    ctx.fillStyle = "rgba(233,238,252,.85)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    const val = xMin + t*(xMax-xMin);
    const s = fmtNum(val);
    ctx.fillText(s, X-ctx.measureText(s).width/2, y+h+18);
  }
  for(let j=0;j<=yTicks;j++){
    const t = j/yTicks;
    const Y = y + (1-t)*h;
    ctx.strokeStyle = "rgba(255,255,255,.08)";
    ctx.beginPath(); ctx.moveTo(x,Y); ctx.lineTo(x+w,Y); ctx.stroke();

    ctx.fillStyle = "rgba(233,238,252,.85)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    const val = yMin + t*(yMax-yMin);
    const s = fmtNum(val);
    ctx.fillText(s, x-10-ctx.measureText(s).width, Y+4);
  }

  // axis box
  ctx.strokeStyle = "rgba(255,255,255,.18)";
  ctx.strokeRect(x,y,w,h);

  // labels
  ctx.fillStyle = "rgba(233,238,252,.92)";
  ctx.font = "14px "+getComputedStyle(document.body).fontFamily;
  ctx.fillText(xLabel, x + w/2 - ctx.measureText(xLabel).width/2, y+h+42);

  ctx.save();
  ctx.translate(x-46, y+h/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
  ctx.restore();

  // title
  ctx.font = "600 15px "+getComputedStyle(document.body).fontFamily;
  ctx.fillText(title, x+8, y-10);

  // legend
  if(showLegend && legendItems.length){
    const pad=8, itemH=18;
    let maxW=0;
    ctx.font = "13px "+getComputedStyle(document.body).fontFamily;
    legendItems.forEach(it=>{ maxW=Math.max(maxW, ctx.measureText(it.label).width); });
    const boxW = pad*2 + 18 + 8 + maxW;
    const boxH = pad*2 + itemH*legendItems.length;
    const lx = x + w - boxW - 8;
    const ly = y + 8;
    ctx.fillStyle = "rgba(0,0,0,.35)";
    ctx.fillRect(lx,ly,boxW,boxH);
    ctx.strokeStyle = "rgba(255,255,255,.14)";
    ctx.strokeRect(lx,ly,boxW,boxH);
    legendItems.forEach((it,idx)=>{
      const yy = ly+pad + idx*itemH + 13;
      ctx.strokeStyle = it.color;
      ctx.lineWidth=3;
      ctx.beginPath(); ctx.moveTo(lx+pad, yy-6); ctx.lineTo(lx+pad+16, yy-6); ctx.stroke();
      ctx.lineWidth=1;
      ctx.fillStyle = "rgba(233,238,252,.92)";
      ctx.fillText(it.label, lx+pad+24, yy-2);
    });
  }

  ctx.restore();
}
function mapX(xVal, xMin, xMax, rect){ return rect.x + (xVal-xMin)/(xMax-xMin)*rect.w; }
function mapY(yVal, yMin, yMax, rect){ return rect.y + (1-(yVal-yMin)/(yMax-yMin))*rect.h; }
function drawLine(ctx, rect, xs, ys, xMin,xMax,yMin,yMax, color){
  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  for(let i=0;i<xs.length;i++){
    const X = mapX(xs[i], xMin,xMax,rect);
    const Y = mapY(ys[i], yMin,yMax,rect);
    if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  }
  ctx.stroke();
  ctx.restore();
}

/* ---------- Physics model (example values for visualization) ---------- */
const CONST = {
  c: 299792458,
  h: 6.62607015e-34
};

// Choose example parameters for plotting (not part of symbolic answer)
let params = {
  nu0: 3.0e14,    // Hz (near IR)
  A21: 1.0e7,     // 1/s
  // We'll choose B such that stimulated rates are noticeable when nbar ~ O(1..10)
  // Treat B*u as 1/s. We'll use an effective coefficient K = B * rho0 * h*nu0
  // so that stimulated rate = K * nbar.
  K12: 2.5e5,     // 1/s per photon (effective)
  K21: 2.0e5,     // 1/s per photon (effective)
  Ntot: 2.0e18    // atoms in unit volume (example density)
};

// Derived quantities
function rho(nu){
  return 8*Math.PI*nu*nu/(CONST.c**3); // modes per m^3 per Hz
}

/* The visualization uses a simplified substitution:
   u(nu0) = rho0*h*nu0*nbar
   and B12*u = (B12*rho0*h*nu0)*nbar = K12*nbar
   and B21*u = K21*nbar
*/
function simulate(tauP, dNu, f0, nbar0){
  const rho0 = rho(params.nu0);
  const M = rho0 * dNu;              // number of modes in band (unit volume)
  const N2_0 = clamp(f0,0,1) * params.Ntot;
  let N2 = N2_0;
  let N1 = params.Ntot - N2;
  let nbar = Math.max(0, nbar0);

  // ODE system:
  // dN2/dt = +K12*nbar*N1 - K21*nbar*N2 - A21*N2
  // dnbar/dt = (1/M)[ A21*N2 + K21*nbar*N2 - K12*nbar*N1 ] - nbar/tauP
  function deriv(state){
    const N2s = state.N2;
    const N1s = params.Ntot - N2s;
    const nbs = Math.max(0, state.nbar);
    const dN2 = params.K12*nbs*N1s - params.K21*nbs*N2s - params.A21*N2s;
    const dnb = (1/Math.max(M,1e-40))*(params.A21*N2s + params.K21*nbs*N2s - params.K12*nbs*N1s) - nbs/tauP;
    return {dN2, dnb};
  }

  // Integrate with RK4
  const T = 6e-6;      // 6 microseconds window (example)
  const steps = 900;
  const dt = T/steps;
  const ts=[], N2s=[], nbs=[];
  let t=0;

  for(let i=0;i<=steps;i++){
    ts.push(t);
    N2s.push(N2);
    nbs.push(nbar);

    const s1 = {N2, nbar};
    const k1 = deriv(s1);

    const s2 = {N2: N2 + 0.5*dt*k1.dN2, nbar: nbar + 0.5*dt*k1.dnb};
    const k2 = deriv(s2);

    const s3 = {N2: N2 + 0.5*dt*k2.dN2, nbar: nbar + 0.5*dt*k2.dnb};
    const k3 = deriv(s3);

    const s4 = {N2: N2 + dt*k3.dN2, nbar: nbar + dt*k3.dnb};
    const k4 = deriv(s4);

    N2 = N2 + (dt/6)*(k1.dN2 + 2*k2.dN2 + 2*k3.dN2 + k4.dN2);
    nbar = nbar + (dt/6)*(k1.dnb + 2*k2.dnb + 2*k3.dnb + k4.dnb);

    // physical clamps
    N2 = clamp(N2, 0, params.Ntot);
    nbar = Math.max(0, nbar);

    t += dt;
  }

  // compute a few helpful outputs
  const rho0hnu = rho0 * CONST.h * params.nu0;
  const u0 = rho0hnu * nbs[0];
  const Msafe = Math.max(M, 1e-40);
  const Nph0 = Msafe * nbs[0];

  return {ts, N2s, nbs, rho0, M, u0, Nph0};
}

/* ---------- Drawing ---------- */
const diagram = setupCanvas(document.getElementById("cDiagram"));
const mainPlot = setupCanvas(document.getElementById("cMain"));
const phasePlot = setupCanvas(document.getElementById("cPhase"));

function drawDiagram(ctx, W, H, tauP, dNu){
  clear(ctx, W, H);
  drawPanelBg(ctx, W, H);

  const pad = 18;
  const x0 = pad, y0 = pad, w = W-2*pad, h = H-2*pad;

  // cavity box
  ctx.save();
  ctx.strokeStyle = "rgba(233,238,252,.22)";
  ctx.lineWidth = 2;
  ctx.strokeRect(x0+30, y0+30, w-60, h-60);

  // mirrors
  ctx.fillStyle = "rgba(125,211,252,.18)";
  ctx.fillRect(x0+22, y0+30, 10, h-60);
  ctx.fillStyle = "rgba(167,139,250,.16)";
  ctx.fillRect(x0+w-32, y0+30, 10, h-60);

  // atoms (dots)
  const cx = x0 + w/2;
  const cy = y0 + h/2;
  const atomCount = 32;
  for(let i=0;i<atomCount;i++){
    const rx = (Math.random()*0.8+0.1)*(w-140);
    const ry = (Math.random()*0.8+0.1)*(h-140);
    const ax = x0+70 + rx;
    const ay = y0+70 + ry;
    ctx.beginPath();
    ctx.fillStyle = "rgba(233,238,252,.75)";
    ctx.arc(ax, ay, 2.2, 0, Math.PI*2);
    ctx.fill();
    // tiny 2-level sketch on some atoms
    if(i%7===0){
      ctx.strokeStyle = "rgba(233,238,252,.35)";
      ctx.lineWidth=1;
      ctx.beginPath(); ctx.moveTo(ax+6, ay-6); ctx.lineTo(ax+18, ay-6); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(ax+6, ay+6); ctx.lineTo(ax+18, ay+6); ctx.stroke();
      ctx.fillStyle="rgba(233,238,252,.75)";
      ctx.font="11px "+getComputedStyle(document.body).fontFamily;
      ctx.fillText("2", ax+20, ay-2);
      ctx.fillText("1", ax+20, ay+10);
    }
  }

  // photons (wavy lines)
  ctx.strokeStyle = "rgba(125,211,252,.55)";
  ctx.lineWidth = 2;
  for(let k=0;k<4;k++){
    const yy = y0 + 70 + k*(h-140)/3;
    ctx.beginPath();
    for(let x = x0+70; x <= x0+w-70; x+=6){
      const t = (x-(x0+70))/60;
      const y = yy + 6*Math.sin(2*Math.PI*t);
      if(x===x0+70) ctx.moveTo(x,y); else ctx.lineTo(x,y);
    }
    ctx.stroke();
  }

  // leakage arrows
  ctx.strokeStyle = "rgba(251,113,133,.55)";
  ctx.lineWidth = 2.2;
  for(let i=0;i<5;i++){
    const y = y0 + 70 + i*(h-140)/4;
    const x = x0+w-32;
    ctx.beginPath(); ctx.moveTo(x+10, y); ctx.lineTo(x+38, y); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x+38, y); ctx.lineTo(x+30, y-6); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x+38, y); ctx.lineTo(x+30, y+6); ctx.stroke();
  }

  // labels
  ctx.fillStyle = "rgba(233,238,252,.92)";
  ctx.font = "600 15px "+getComputedStyle(document.body).fontFamily;
  ctx.fillText("Resonator (unit volume)", x0+40, y0+22);

  ctx.font = "13px "+getComputedStyle(document.body).fontFamily;
  ctx.fillStyle = "rgba(233,238,252,.82)";
  ctx.fillText("Two-level atoms", x0+44, y0+h-16);

  ctx.fillStyle = "rgba(125,211,252,.85)";
  ctx.fillText("Broadband modes around ν₀ (bandwidth Δν)", x0+60, y0+52);

  ctx.fillStyle = "rgba(251,113,133,.9)";
  ctx.fillText(`Leakage: photons lost at 1/τp  (τp=${fmtSci(tauP,3)} s)`, x0+60, y0+74);

  // show M
  const rho0 = rho(params.nu0);
  const M = rho0*dNu;
  ctx.fillStyle = "rgba(167,139,250,.9)";
  ctx.fillText(`Modes in band: M = ρ(ν₀)Δν ≈ ${fmtSci(M,3)} (example)`, x0+60, y0+96);

  ctx.restore();
}

function drawMain(ctx, W, H, sim){
  clear(ctx, W, H);
  drawPanelBg(ctx, W, H);

  const padL=64, padR=16, padT=34, padB=56;
  const rect = {x:padL, y:padT, w:W-padL-padR, h:H-padT-padB};

  const t = sim.ts;
  const N2 = sim.N2s;
  const nb = sim.nbs;

  const tMin = t[0]*1e6, tMax = t[t.length-1]*1e6; // microseconds for axis
  let yMin = 0, yMax = params.Ntot;
  // We'll scale N2 on left axis in absolute counts; nbar on same axis would be tiny.
  // Instead, plot normalized N2/N and nbar together on a comparable scale (0..1 and 0..nbarMax).
  // We'll plot two curves: f(t)=N2/N, and nbar(t)/nbarScale (scaled) and show legend.
  const f = N2.map(v=> v/params.Ntot);
  const nbMax = Math.max(...nb);
  const nbScale = Math.max(1, nbMax);
  const g = nb.map(v=> v/nbScale);

  const yMinPlot = 0;
  const yMaxPlot = Math.max(1.0, Math.max(...f)*1.05, Math.max(...g)*1.05);

  drawAxes(ctx, rect, tMin, tMax, yMinPlot, yMaxPlot,
           "time t (µs)", "scaled variables (dimensionless)",
           "Coupled dynamics: N₂(t)/N and n̄(t)/n̄max (example)",
           {showLegend:true, legendItems:[
             {label:"f(t)=N₂/N", color:"rgba(125,211,252,.95)"},
             {label:`n̄(t)/n̄max  (n̄max=${fmtNum(nbScale)})`, color:"rgba(167,139,250,.95)"}
           ]});

  const xs = t.map(v=> v*1e6);
  drawLine(ctx, rect, xs, f, tMin,tMax, yMinPlot,yMaxPlot, "rgba(125,211,252,.95)");
  drawLine(ctx, rect, xs, g, tMin,tMax, yMinPlot,yMaxPlot, "rgba(167,139,250,.95)");

  // annotate key derived numbers
  ctx.save();
  ctx.fillStyle = "rgba(233,238,252,.86)";
  ctx.font = "13px "+getComputedStyle(document.body).fontFamily;
  ctx.fillText(`Note: n̄ is scaled by n̄max for visibility.`, rect.x+8, rect.y+rect.h-8);
  ctx.restore();
}

function drawPhase(ctx, W, H, sim){
  clear(ctx, W, H);
  drawPanelBg(ctx, W, H);

  const padL=72, padR=16, padT=34, padB=56;
  const rect = {x:padL, y:padT, w:W-padL-padR, h:H-padT-padB};

  const N2 = sim.N2s;
  const nb = sim.nbs;

  const xMin = 0, xMax = params.Ntot;
  const yMin = 0, yMax = Math.max(1, Math.max(...nb)*1.1);

  drawAxes(ctx, rect, xMin, xMax, yMin, yMax,
           "N₂ (atoms in level 2)", "n̄ (photons per mode)",
           "Phase portrait: n̄ vs N₂ (example)",
           {xTicks:6, yTicks:5, showLegend:true, legendItems:[
             {label:"trajectory (time increases along curve)", color:"rgba(125,211,252,.95)"}
           ]});

  // trajectory
  ctx.save();
  ctx.strokeStyle = "rgba(125,211,252,.95)";
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  for(let i=0;i<N2.length;i++){
    const X = mapX(N2[i], xMin,xMax,rect);
    const Y = mapY(nb[i], yMin,yMax,rect);
    if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
  }
  ctx.stroke();

  // start and end points
  const X0 = mapX(N2[0], xMin,xMax,rect), Y0 = mapY(nb[0], yMin,yMax,rect);
  const Xe = mapX(N2[N2.length-1], xMin,xMax,rect), Ye = mapY(nb[nb.length-1], yMin,yMax,rect);
  ctx.fillStyle = "rgba(167,139,250,.95)";
  ctx.beginPath(); ctx.arc(X0,Y0,4.5,0,Math.PI*2); ctx.fill();
  ctx.fillStyle = "rgba(134,239,172,.95)";
  ctx.beginPath(); ctx.arc(Xe,Ye,4.5,0,Math.PI*2); ctx.fill();

  ctx.fillStyle = "rgba(233,238,252,.86)";
  ctx.font = "13px "+getComputedStyle(document.body).fontFamily;
  ctx.fillText("start", X0+8, Y0-8);
  ctx.fillText("end", Xe+8, Ye-8);

  ctx.restore();
}

/* ---------- Controls + Update loop ---------- */
const elTauP = document.getElementById("tauP");
const elDNu = document.getElementById("dNu");
const elInv0 = document.getElementById("inv0");
const elNbar0 = document.getElementById("nbar0");

const tauPVal = document.getElementById("tauPVal");
const dNuVal = document.getElementById("dNuVal");
const inv0Val = document.getElementById("inv0Val");
const nbar0Val = document.getElementById("nbar0Val");
const kpi = document.getElementById("kpi");

function updateLabels(tauP, dNu, f0, nbar0){
  tauPVal.textContent = fmtSci(tauP,3);
  dNuVal.textContent = fmtSci(dNu,3);
  inv0Val.textContent = fmtNum(f0);
  nbar0Val.textContent = fmtNum(nbar0);
}

function updateKPI(sim, tauP, dNu, f0, nbar0){
  const rho0 = sim.rho0;
  const M = sim.M;
  const N2_0 = f0 * params.Ntot;
  const u0 = rho0 * CONST.h * params.nu0 * nbar0;
  const Nph0 = M * nbar0;

  const items = [
    {k:"Example ν₀ (Hz)", v: fmtSci(params.nu0,3)},
    {k:"ρ(ν₀) (modes·m⁻³·Hz⁻¹)", v: fmtSci(rho0,3)},
    {k:"M=ρΔν (modes)", v: fmtSci(M,3)},
    {k:"N (atoms)", v: fmtSci(params.Ntot,3)},
    {k:"N₂(0) (atoms)", v: fmtSci(N2_0,3)},
    {k:"n̄(0) (photons/mode)", v: fmtNum(nbar0)},
    {k:"u(ν₀)≈ρhν₀n̄ (J·m⁻³·Hz⁻¹)", v: fmtSci(u0,3)},
    {k:"Total photons Nph(0)=Mn̄", v: fmtSci(Nph0,3)},
    {k:"τₚ (s)", v: fmtSci(tauP,3)},
    {k:"Δν (Hz)", v: fmtSci(dNu,3)}
  ];

  kpi.innerHTML = items.map(it=>`
    <div class="mini">
      <b>${it.k}</b>
      <span>${it.v}</span>
    </div>
  `).join("");
}

function computeAndRender(){
  const tauP = Math.pow(10, parseFloat(elTauP.value));
  const dNu = Math.pow(10, parseFloat(elDNu.value));
  const f0 = parseFloat(elInv0.value);
  const nbar0 = parseFloat(elNbar0.value);

  updateLabels(tauP, dNu, f0, nbar0);

  const sim = simulate(tauP, dNu, f0, nbar0);

  // resize canvases (responsive)
  diagram.resize(); mainPlot.resize(); phasePlot.resize();

  // draw
  const cd = document.getElementById("cDiagram");
  drawDiagram(diagram.ctx, cd.clientWidth, cd.clientHeight, tauP, dNu);

  const cm = document.getElementById("cMain");
  drawMain(mainPlot.ctx, cm.clientWidth, cm.clientHeight, sim);

  const cp = document.getElementById("cPhase");
  drawPhase(phasePlot.ctx, cp.clientWidth, cp.clientHeight, sim);

  updateKPI(sim, tauP, dNu, f0, nbar0);
}

[elTauP, elDNu, elInv0, elNbar0].forEach(el=>{
  el.addEventListener("input", computeAndRender);
});

window.addEventListener("resize", computeAndRender);

// Initial render
computeAndRender();
</script>
</body>
</html>
