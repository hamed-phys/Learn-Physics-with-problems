<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Stimulated vs Spontaneous Emission in a Blackbody Cavity (Equality Condition at λ0 = 1 μm)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1624;
      --panel2:#0c1320;
      --text:#e9eefc;
      --muted:#b7c2e0;
      --faint:#8391b7;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.06);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(125,211,252,.16), transparent 60%),
        radial-gradient(900px 600px at 90% 10%, rgba(167,139,250,.14), transparent 55%),
        radial-gradient(900px 700px at 45% 120%, rgba(52,211,153,.10), transparent 55%),
        var(--bg);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding:36px 18px 22px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .wrap{
      max-width:1160px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 290px 1fr;
      gap:18px;
      padding:18px;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns:1fr}
    }
    .hero{
      max-width:1160px;
      margin:0 auto;
      padding:0 18px 14px;
    }
    h1{
      margin:0 0 10px;
      letter-spacing:-0.02em;
      font-size: clamp(26px, 3.2vw, 40px);
      line-height:1.12;
    }
    .sub{
      color:var(--muted);
      max-width: 95ch;
      font-size: 1.02rem;
    }
    .chips{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .chip{
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      padding:6px 10px;
      border-radius:999px;
      font-size:.88rem;
      color:var(--muted);
    }
    .toc{
      position:sticky;
      top:12px;
      align-self:start;
      background:linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.015));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px 14px 12px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .toc h2{
      font-size: .95rem;
      margin:0 0 10px;
      color:var(--text);
      letter-spacing:.02em;
      text-transform:uppercase;
      opacity:.92;
    }
    .toc a{
      display:block;
      padding:8px 8px;
      border-radius:12px;
      color:var(--muted);
      border:1px solid transparent;
      transition: .18s ease;
      font-size:.95rem;
    }
    .toc a:hover{
      background:rgba(125,211,252,.08);
      border-color:rgba(125,211,252,.22);
      color:var(--text);
      text-decoration:none;
    }
    main{
      display:flex;
      flex-direction:column;
      gap:16px;
    }
    section, article{
      background: linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.015));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:16px 16px 14px;
      box-shadow: var(--shadow);
    }
    section h2, article h2{
      margin:0 0 10px;
      font-size:1.25rem;
      letter-spacing:-0.01em;
    }
    h3{
      margin:16px 0 8px;
      font-size:1.06rem;
      color:var(--text);
    }
    p{margin:10px 0}
    ul{margin:10px 0 10px 22px}
    li{margin:6px 0; color:var(--muted)}
    .grid2{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid2{grid-template-columns:1fr}
    }
    .callouts{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      margin-top:8px;
    }
    .box{
      grid-column: span 12;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      border-radius:16px;
      padding:12px 12px 10px;
    }
    .box strong{color:var(--text)}
    .box .title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .tag{
      font-size:.82rem;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.02);
      color:var(--muted);
      user-select:none;
      white-space:nowrap;
    }
    .tag.good{border-color:rgba(52,211,153,.35); background:rgba(52,211,153,.08); color:#c7ffe9}
    .tag.warn{border-color:rgba(251,191,36,.35); background:rgba(251,191,36,.08); color:#fff1c1}
    .tag.bad{border-color:rgba(251,113,133,.38); background:rgba(251,113,133,.08); color:#ffd0d8}
    .eq{
      font-family:var(--mono);
      font-size:.98rem;
      color:#eaf2ff;
      background:rgba(255,255,255,.03);
      border:1px solid var(--line2);
      padding:10px 10px;
      border-radius:14px;
      overflow:auto;
      position:relative;
    }
    .copyRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:8px;
    }
    button.copy{
      appearance:none;
      border:1px solid var(--line);
      background:rgba(255,255,255,.03);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      transition: .18s ease;
      font-size:.92rem;
    }
    button.copy:hover{
      border-color:rgba(125,211,252,.35);
      background:rgba(125,211,252,.08);
      transform: translateY(-1px);
    }
    .note{
      color:var(--faint);
      font-size:.92rem;
    }
    .viz{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .viz{grid-template-columns:1fr}
    }
    figure{
      margin:0;
      padding:12px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      overflow:hidden;
    }
    figcaption{
      margin-top:8px;
      color:var(--muted);
      font-size:.92rem;
    }
    canvas{
      width:100%;
      height:280px;
      display:block;
      border-radius:14px;
      background:rgba(255,255,255,.02);
      border:1px solid var(--line2);
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:12px;
      align-items:center;
      padding:10px 12px;
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(255,255,255,.02);
      margin-top:10px;
    }
    .control{
      display:flex;
      flex-direction:column;
      gap:6px;
      min-width: 240px;
      flex: 1;
    }
    .control label{
      color:var(--muted);
      font-size:.92rem;
      display:flex;
      justify-content:space-between;
      gap:10px;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    .readout{
      font-family:var(--mono);
      font-size:.92rem;
      color:#dbe7ff;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid var(--line2);
      background:rgba(255,255,255,.02);
      min-width: 270px;
    }
    footer{
      max-width:1160px;
      margin: 0 auto 26px;
      padding: 0 18px;
      color: var(--faint);
      font-size:.92rem;
    }
    /* subtle motion */
    @media (prefers-reduced-motion: no-preference){
      section, article, .toc{animation: floatIn .35s ease-out both}
      @keyframes floatIn{
        from{opacity:0; transform: translateY(6px)}
        to{opacity:1; transform: translateY(0)}
      }
    }
    /* print-friendly */
    @media print{
      body{background:#fff; color:#000}
      .toc{display:none}
      section, article{box-shadow:none; border-color:#ddd}
      canvas{border-color:#ddd}
      .eq{border-color:#ddd; background:#f7f7f7; color:#000}
      button.copy{display:none}
      a{color:#000; text-decoration:underline}
    }
  </style>
</head>
<body>
<header>
  <div class="hero">
    <h1>Comparison of Stimulated and Spontaneous Emission in Blackbody Radiation</h1>
    <div class="sub">
      We find the temperature of a thermal-equilibrium blackbody cavity such that, at a chosen wavelength
      <span class="eq" style="display:inline-block;padding:2px 8px;border-radius:10px;vertical-align:baseline;">λ<sub>0</sub> = 1&nbsp;μm</span>,
      the <b>stimulated emission rate</b> from atoms in the cavity walls equals the <b>spontaneous emission rate</b>.
      The key idea is that in equilibrium, the radiation field has a Planck spectrum, and Einstein’s A–B relations connect
      emission rates to the spectral energy density.
    </div>
    <div class="chips">
      <div class="chip">Topic: Einstein coefficients</div>
      <div class="chip">Key concept: photon occupation number</div>
      <div class="chip">Result: closed-form temperature</div>
      <div class="chip">Interactive plots below</div>
    </div>
  </div>
</header>

<div class="wrap">
  <nav class="toc" aria-label="Table of contents">
    <h2>Contents</h2>
    <a href="#quick">Quick Summary</a>
    <a href="#part0">PART 0 — Concept Primer</a>
    <a href="#part1">PART 1 — Problem Analysis</a>
    <a href="#part2">PART 2 — Strategy & Tips</a>
    <a href="#part3">PART 3 — Full Solution</a>
    <a href="#part4">PART 4 — Deeper Understanding</a>
    <a href="#part5">PART 5 — Visualization Guide</a>
  </nav>

  <main>
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li>We compare <b>spontaneous emission</b> (rate coefficient <span class="eq" style="padding:2px 6px;">A<sub>21</sub></span>) and <b>stimulated emission</b> (coefficient <span class="eq" style="padding:2px 6px;">B<sub>21</sub></span>) for atoms in blackbody cavity walls.</li>
        <li>The cavity radiation field in equilibrium has Planck spectral energy density <span class="eq" style="padding:2px 6px;">u(ν,T)</span> (J·m<sup>−3</sup>·Hz<sup>−1</sup>).</li>
        <li>Stimulated and spontaneous emission from level 2→1 satisfy: <span class="eq" style="padding:2px 6px;">R<sub>stim</sub>=B<sub>21</sub>u(ν,T)N<sub>2</sub></span> and <span class="eq" style="padding:2px 6px;">R<sub>sp</sub>=A<sub>21</sub>N<sub>2</sub></span>.</li>
        <li>Equality condition <span class="eq" style="padding:2px 6px;">R<sub>stim</sub>=R<sub>sp</sub></span> implies <span class="eq" style="padding:2px 6px;">u(ν,T)=A<sub>21</sub>/B<sub>21</sub></span>.</li>
        <li>Einstein relation: <span class="eq" style="padding:2px 6px;">A<sub>21</sub> = (8πhν<sup>3</sup>/c<sup>3</sup>)B<sub>21</sub></span>, so <span class="eq" style="padding:2px 6px;">A<sub>21</sub>/B<sub>21</sub>=8πhν<sup>3</sup>/c<sup>3</sup></span>.</li>
        <li>Using Planck’s law gives <span class="eq" style="padding:2px 6px;">e^{hν/kT}=2</span>, hence the <b>closed-form result</b>:
          <span class="eq" style="padding:2px 6px;">T = hν/(k ln 2) = hc/(kλ ln 2)</span> (numeric at 1 μm below).</li>
        <li>At <span class="eq" style="padding:2px 6px;">λ<sub>0</sub>=1&nbsp;μm</span>, the temperature is <b>≈ 2.08×10<sup>4</sup> K</b>.</li>
      </ul>
    </section>

    <article id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div>
          <h3>Core definitions (symbols & units)</h3>
          <ul>
            <li><b>Spectral energy density</b> <span class="eq" style="padding:2px 6px;">u(ν,T)</span>:
              energy per volume per frequency interval (J·m<sup>−3</sup>·Hz<sup>−1</sup>).</li>
            <li><b>Einstein A coefficient</b> <span class="eq" style="padding:2px 6px;">A<sub>21</sub></span>:
              probability per unit time for <i>spontaneous</i> emission 2→1 (s<sup>−1</sup>).</li>
            <li><b>Einstein B coefficient</b> <span class="eq" style="padding:2px 6px;">B<sub>21</sub></span>:
              proportionality for <i>stimulated</i> emission 2→1 in a radiation field (units such that <span class="eq" style="padding:2px 6px;">B u</span> is s<sup>−1</sup>).</li>
            <li><b>Photon energy</b> <span class="eq" style="padding:2px 6px;">E=hν=hc/λ</span> (J).</li>
            <li><b>Mean photon occupation number</b> <span class="eq" style="padding:2px 6px;">\bar n(ν,T)=1/(e^{hν/kT}-1)</span> (dimensionless).</li>
          </ul>

          <h3>Physical meaning</h3>
          <p class="note">
            Spontaneous emission happens even in complete darkness (vacuum fluctuations / quantized field).
            Stimulated emission requires an existing electromagnetic field at the transition frequency: an incoming photon “encourages”
            emission of an identical photon (same ν, direction, polarization, phase).
          </p>
        </div>

        <div>
          <h3>Key laws and validity (assumptions)</h3>
          <ul>
            <li><b>Thermal equilibrium</b>: cavity walls and radiation field share a common temperature <span class="eq" style="padding:2px 6px;">T</span>.</li>
            <li><b>Blackbody radiation</b>: field inside is isotropic and has Planck spectrum.</li>
            <li><b>Einstein rate equations</b> apply for a two-level transition interacting weakly with the radiation field.</li>
            <li><b>Detailed balance</b> in equilibrium links A and B coefficients to Planck’s law.</li>
          </ul>

          <div class="callouts">
            <div class="box">
              <div class="title">
                <strong>Planck spectral energy density</strong>
                <span class="tag">law</span>
              </div>
              <div class="eq" id="eq_planck">u(ν,T) = (8π h ν^3 / c^3) · 1/(exp(hν/(kT)) − 1)</div>
              <div class="copyRow">
                <button class="copy" data-copy="#eq_planck">Copy equation</button>
              </div>
            </div>
          </div>

          <h3>Mini intuition examples</h3>
          <ul>
            <li><b>Low temperature / high frequency</b>: <span class="eq" style="padding:2px 6px;">hν ≫ kT</span> ⇒ almost no photons ⇒ stimulated emission is negligible vs spontaneous.</li>
            <li><b>High temperature / low frequency</b>: many photons ⇒ stimulated emission can dominate.</li>
          </ul>

          <h3>What to watch for (pitfalls)</h3>
          <ul>
            <li>Confusing <span class="eq" style="padding:2px 6px;">u(ν)</span> with intensity or spectral radiance (different units).</li>
            <li>Forgetting that the equality condition cancels the excited-state population <span class="eq" style="padding:2px 6px;">N<sub>2</sub></span>.</li>
            <li>Mixing wavelength-form and frequency-form Planck laws without converting properly.</li>
          </ul>
        </div>
      </div>
    </article>

    <article id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Problem restatement</h3>
      <p>
        A blackbody cavity is in thermal equilibrium at temperature <span class="eq" style="padding:2px 6px;">T</span>.
        Atoms in the cavity walls undergo an optical transition with wavelength <span class="eq" style="padding:2px 6px;">λ<sub>0</sub>=1 μm</span>
        (equivalently frequency <span class="eq" style="padding:2px 6px;">ν=c/λ<sub>0</sub></span>). Find the temperature at which the
        <b>stimulated emission rate</b> equals the <b>spontaneous emission rate</b> at that transition frequency.
      </p>

      <h3>Given</h3>
      <ul>
        <li><span class="eq" style="padding:2px 6px;">λ<sub>0</sub> = 1 μm = 1×10<sup>−6</sup> m</span></li>
        <li>Thermal-equilibrium radiation field in a blackbody cavity</li>
      </ul>

      <h3>Unknowns</h3>
      <ul>
        <li>Temperature <span class="eq" style="padding:2px 6px;">T</span> such that <span class="eq" style="padding:2px 6px;">R<sub>stim</sub>(ν)=R<sub>sp</sub>(ν)</span> at <span class="eq" style="padding:2px 6px;">ν=c/λ<sub>0</sub></span>.</li>
      </ul>

      <h3>Relevant principles (and why they apply)</h3>
      <ul>
        <li><b>Einstein emission rates</b>: They directly compare spontaneous and stimulated emission for the same transition 2→1.</li>
        <li><b>Planck spectrum</b>: The cavity is a blackbody in equilibrium, so <span class="eq" style="padding:2px 6px;">u(ν,T)</span> is known.</li>
        <li><b>Einstein A–B relation</b>: Eliminates unknown atomic constants by relating <span class="eq" style="padding:2px 6px;">A<sub>21</sub></span> and <span class="eq" style="padding:2px 6px;">B<sub>21</sub></span>.</li>
      </ul>

      <div class="callouts">
        <div class="box">
          <div class="title">
            <strong>Assumptions</strong>
            <span class="tag warn">idealizations</span>
          </div>
          <ul>
            <li>Radiation field is isotropic blackbody; wall atoms are in equilibrium with it.</li>
            <li>Two-level transition picture for the emission process at <span class="eq" style="padding:2px 6px;">ν=c/λ<sub>0</sub></span>.</li>
            <li>Steady state / equilibrium so rates can be compared meaningfully.</li>
          </ul>
        </div>
      </div>

      <h3>Possible approaches (compare briefly)</h3>
      <ul>
        <li><b>Approach A (best): Einstein coefficients + Planck law</b> — fastest and most transparent; cancels atomic populations and uses known equilibrium relations.</li>
        <li><b>Approach B: Photon occupation number</b> — use <span class="eq" style="padding:2px 6px;">R<sub>stim</sub>/R<sub>sp</sub> = \bar n</span> from quantum optics; equivalent but assumes the same Einstein relations implicitly.</li>
        <li><b>Approach C: Detailed balance derivation from absorption/emission</b> — more algebra; useful if you want to re-derive Planck’s law or A–B relations.</li>
      </ul>
      <p class="note">
        We will choose Approach A because it is direct, uses only standard equilibrium relations, and yields a clean closed-form temperature.
      </p>
    </article>

    <article id="part2">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>
      <ol style="margin:10px 0 10px 22px; color:var(--muted);">
        <li><b>Write the two emission rates</b> (goal: express equality condition). Tool: Einstein rates. Meaning: how radiation field changes the emission probability.</li>
        <li><b>Set stimulated = spontaneous</b> (goal: solve for required <span class="eq" style="padding:2px 6px;">u(ν,T)</span>). Tool: algebra. Meaning: “one photon in the field triggers as much emission as vacuum does”.</li>
        <li><b>Use A–B relation</b> (goal: eliminate atomic constants). Tool: <span class="eq" style="padding:2px 6px;">A/B = 8πhν^3/c^3</span>. Meaning: equilibrium constraint from detailed balance.</li>
        <li><b>Insert Planck’s law for u(ν,T)</b> (goal: solve for T). Tool: Planck spectral energy density. Meaning: the cavity field amplitude set by temperature.</li>
        <li><b>Solve the resulting exponential equation</b> (goal: find closed-form T). Meaning: identify the temperature where <span class="eq" style="padding:2px 6px;">\bar n = 1</span>.</li>
        <li><b>Convert ν to λ</b> (goal: apply <span class="eq" style="padding:2px 6px;">λ<sub>0</sub>=1 μm</span>). Tool: <span class="eq" style="padding:2px 6px;">ν=c/λ</span>. Meaning: link to the requested wavelength.</li>
        <li><b>Sanity checks</b> (goal: verify units and plausibility). Tool: dimensional analysis + limiting behavior.</li>
      </ol>

      <div class="callouts">
        <div class="box">
          <div class="title">
            <strong>Common mistakes</strong>
            <span class="tag bad">avoid</span>
          </div>
          <ul>
            <li>Using wavelength Planck law <span class="eq" style="padding:2px 6px;">u(λ)</span> but plugging in frequency relations (mismatch).</li>
            <li>Forgetting that the “equality temperature” depends on the chosen <span class="eq" style="padding:2px 6px;">λ</span>; shorter wavelengths require much higher T.</li>
            <li>Dropping the factor <span class="eq" style="padding:2px 6px;">ln 2</span>; the equality is not at <span class="eq" style="padding:2px 6px;">hν=kT</span>, but at <span class="eq" style="padding:2px 6px;">hν=kT ln 2</span>.</li>
          </ul>
        </div>
      </div>
    </article>

    <article id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Physical intuition first</h3>
      <p>
        The ratio of stimulated to spontaneous emission for a given transition is controlled by how many photons
        are already present in the cavity at the transition frequency. In a thermal field, that “photon availability”
        is measured by the mean occupation number <span class="eq" style="padding:2px 6px;">\bar n</span>.
        We expect:
      </p>
      <ul>
        <li>If <span class="eq" style="padding:2px 6px;">T</span> is low, <span class="eq" style="padding:2px 6px;">\bar n</span> is tiny at optical frequencies ⇒ spontaneous dominates.</li>
        <li>As <span class="eq" style="padding:2px 6px;">T</span> rises, photons become abundant ⇒ stimulated grows until it matches spontaneous at some high temperature.</li>
      </ul>

      <h3>Step 1 — Write the emission rates</h3>
      <p>
        Consider a transition from an excited level 2 to a lower level 1 at frequency <span class="eq" style="padding:2px 6px;">ν</span>.
        Let <span class="eq" style="padding:2px 6px;">N<sub>2</sub></span> be the number of atoms in level 2.
      </p>

      <div class="callouts">
        <div class="box">
          <div class="title">
            <strong>Einstein emission rates</strong>
            <span class="tag">rates</span>
          </div>
          <div class="eq" id="eq_rates">
R_sp(ν) = A21 · N2
R_stim(ν) = B21 · u(ν,T) · N2
          </div>
          <div class="copyRow">
            <button class="copy" data-copy="#eq_rates">Copy equations</button>
          </div>
          <p class="note">
            Here <span class="eq" style="padding:2px 6px;">u(ν,T)</span> is the spectral energy density of the radiation field at frequency ν.
          </p>
        </div>
      </div>

      <h3>Step 2 — Set stimulated = spontaneous</h3>
      <p>
        The condition requested is:
        <span class="eq" style="padding:2px 6px;">R<sub>stim</sub>(ν) = R<sub>sp</sub>(ν)</span>.
        Substitute the expressions above:
      </p>
      <div class="eq" id="eq_equal1">
B21 · u(ν,T) · N2 = A21 · N2
      </div>
      <p>
        Since <span class="eq" style="padding:2px 6px;">N<sub>2</sub> &gt; 0</span>, it cancels:
      </p>
      <div class="eq" id="eq_equal2">
u(ν,T) = A21 / B21
      </div>
      <div class="copyRow">
        <button class="copy" data-copy="#eq_equal2">Copy equality condition</button>
      </div>
      <p class="note">
        This is a powerful simplification: the equality temperature depends only on the field’s spectral energy density,
        not on how many atoms are excited.
      </p>

      <h3>Step 3 — Use Einstein’s A–B relation</h3>
      <p>
        In thermal equilibrium, Einstein coefficients satisfy:
      </p>
      <div class="eq" id="eq_AB">
A21 = (8π h ν^3 / c^3) · B21
      </div>
      <p>
        Therefore,
      </p>
      <div class="eq" id="eq_AoverB">
A21 / B21 = 8π h ν^3 / c^3
      </div>
      <div class="copyRow">
        <button class="copy" data-copy="#eq_AB">Copy A–B relation</button>
        <button class="copy" data-copy="#eq_AoverB">Copy A/B result</button>
      </div>

      <h3>Step 4 — Insert Planck’s law for u(ν,T) and solve for T</h3>
      <p>
        The blackbody spectral energy density is:
      </p>
      <div class="eq" id="eq_planck2">
u(ν,T) = (8π h ν^3 / c^3) · 1/(exp(hν/(kT)) − 1)
      </div>
      <p>
        Set this equal to <span class="eq" style="padding:2px 6px;">8π h ν^3 / c^3</span>:
      </p>
      <div class="eq" id="eq_solve1">
(8π h ν^3 / c^3) · 1/(exp(hν/(kT)) − 1) = (8π h ν^3 / c^3)
      </div>
      <p>
        Cancel the common prefactor <span class="eq" style="padding:2px 6px;">8π h ν^3 / c^3</span>:
      </p>
      <div class="eq" id="eq_solve2">
1/(exp(hν/(kT)) − 1) = 1
      </div>
      <p>
        Invert both sides:
      </p>
      <div class="eq" id="eq_solve3">
exp(hν/(kT)) − 1 = 1
      </div>
      <p>
        Hence:
      </p>
      <div class="eq" id="eq_solve4">
exp(hν/(kT)) = 2
      </div>
      <p>
        Take the natural logarithm:
      </p>
      <div class="eq" id="eq_solve5">
hν/(kT) = ln 2
      </div>
      <p>
        Solve for temperature:
      </p>
      <div class="eq" id="eq_Tnu">
T = hν / (k ln 2)
      </div>
      <div class="copyRow">
        <button class="copy" data-copy="#eq_Tnu">Copy T(ν)</button>
      </div>

      <h3>Step 5 — Express in terms of wavelength and evaluate at λ0 = 1 μm</h3>
      <p>
        Using <span class="eq" style="padding:2px 6px;">ν = c/λ</span>:
      </p>
      <div class="eq" id="eq_Tlam">
T = hc / (k λ ln 2)
      </div>
      <div class="copyRow">
        <button class="copy" data-copy="#eq_Tlam">Copy T(λ)</button>
      </div>

      <div class="callouts">
        <div class="box">
          <div class="title">
            <strong>Final Answer (at λ0 = 1 μm)</strong>
            <span class="tag good">result</span>
          </div>
          <div class="eq" id="eq_final">
T* = hc / (k λ0 ln 2)
For λ0 = 1.0×10^-6 m:
T* ≈ 2.08×10^4 K
          </div>
          <div class="copyRow">
            <button class="copy" data-copy="#eq_final">Copy final answer</button>
          </div>
          <p class="note">
            Numerically (using exact SI constants): <span class="eq" style="padding:2px 6px;">T* ≈ 20757 K</span>.
          </p>
        </div>
      </div>

      <h3>Sanity checks</h3>
      <ul>
        <li><b>Units:</b> <span class="eq" style="padding:2px 6px;">hc</span> has J·m, dividing by <span class="eq" style="padding:2px 6px;">kλ</span> (J/K · m) gives K. <span class="eq" style="padding:2px 6px;">ln2</span> is dimensionless ⇒ OK.</li>
        <li><b>Limiting behavior:</b> If <span class="eq" style="padding:2px 6px;">λ</span> decreases (higher frequency), <span class="eq" style="padding:2px 6px;">T*</span> increases — optical/UV requires very hot walls for abundant photons, consistent with intuition.</li>
        <li><b>Physical interpretation:</b> The equality occurs when the thermal field has <b>one photon per mode on average</b> at that frequency:
          <span class="eq" style="padding:2px 6px;">\bar n = 1/(e^{hν/kT}-1) = 1</span>.</li>
      </ul>

      <p class="note">
        Connection to the diagrams/plots below: the plotted quantity <span class="eq" style="padding:2px 6px;">R<sub>stim</sub>/R<sub>sp</sub></span>
        equals <span class="eq" style="padding:2px 6px;">\bar n</span>, which crosses 1 at <span class="eq" style="padding:2px 6px;">T*</span>.
      </p>
    </article>

    <article id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpreting the final formula</h3>
      <p>
        The compact expression
        <span class="eq" style="padding:2px 6px;">T* = hc/(kλ ln2)</span>
        shows that the equality is controlled by a single dimensionless parameter:
        <span class="eq" style="padding:2px 6px;">x = hν/(kT) = hc/(kλT)</span>.
        The condition is simply <span class="eq" style="padding:2px 6px;">x = ln 2</span>.
      </p>
      <ul>
        <li><b>Shorter λ (higher ν)</b> ⇒ larger photon energy ⇒ need higher T to achieve the same thermal occupancy.</li>
        <li><b>Longer λ</b> ⇒ lower photon energy ⇒ even modest temperatures can yield many photons and strong stimulated emission.</li>
      </ul>

      <h3>How changing parameters affects the outcome (tie to interactive plots)</h3>
      <ul>
        <li>Increasing <span class="eq" style="padding:2px 6px;">T</span> increases <span class="eq" style="padding:2px 6px;">\bar n = R<sub>stim</sub>/R<sub>sp</sub></span> monotonically.</li>
        <li>For fixed <span class="eq" style="padding:2px 6px;">T</span>, increasing <span class="eq" style="padding:2px 6px;">λ</span> (lower ν) increases <span class="eq" style="padding:2px 6px;">\bar n</span> and moves you deeper into the stimulated-emission-dominated regime.</li>
        <li>The crossing <span class="eq" style="padding:2px 6px;">\bar n=1</span> always occurs at <span class="eq" style="padding:2px 6px;">T*(λ) ∝ 1/λ</span>, which you can see in the parameter-sweep plot.</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p class="note">
        In quantum optics, for a thermal state the mean photon number at frequency ν is
        <span class="eq" style="padding:2px 6px;">\bar n = 1/(e^{hν/kT}-1)</span>.
        The stimulated emission rate is proportional to <span class="eq" style="padding:2px 6px;">\bar n</span>, while spontaneous emission corresponds to the “+1” vacuum term.
        Thus <span class="eq" style="padding:2px 6px;">R<sub>stim</sub>/R<sub>sp</sub> = \bar n</span>, and the equality condition is simply <span class="eq" style="padding:2px 6px;">\bar n=1</span> ⇒ <span class="eq" style="padding:2px 6px;">e^{hν/kT}=2</span>.
      </p>

      <h3>Concept check (quick self-test)</h3>
      <ul>
        <li><b>Q:</b> If <span class="eq" style="padding:2px 6px;">T</span> doubles, what happens to <span class="eq" style="padding:2px 6px;">R<sub>stim</sub>/R<sub>sp</sub></span> at fixed ν? <b>A:</b> It increases (because <span class="eq" style="padding:2px 6px;">hν/kT</span> decreases), moving toward stimulated dominance.</li>
        <li><b>Q:</b> Does the equality temperature depend on <span class="eq" style="padding:2px 6px;">A<sub>21</sub></span> or <span class="eq" style="padding:2px 6px;">B<sub>21</sub></span>? <b>A:</b> No; equilibrium relations cancel them, leaving only ν (or λ).</li>
        <li><b>Q:</b> At the equality point, what is <span class="eq" style="padding:2px 6px;">\bar n</span>? <b>A:</b> Exactly 1.</li>
        <li><b>Q:</b> Would visible light (<span class="eq" style="padding:2px 6px;">λ≈0.5 μm</span>) require higher or lower temperature than 1 μm? <b>A:</b> Higher (because <span class="eq" style="padding:2px 6px;">T*∝1/λ</span>).</li>
      </ul>
    </article>

    <article id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <div class="controls" aria-label="Interactive controls">
        <div class="control">
          <label for="lamSlider">
            <span>Wavelength <b>λ</b> (μm)</span>
            <span class="note">controls ν = c/λ and the equality temperature</span>
          </label>
          <input id="lamSlider" type="range" min="0.2" max="5.0" step="0.01" value="1.00" />
        </div>
        <div class="readout" id="readout">
          λ = 1.00 μm · ν = 3.00×10^14 Hz · T* = 2.08×10^4 K
        </div>
      </div>

      <div class="viz">
        <figure>
          <canvas id="cDiagram" aria-label="Cavity diagram"></canvas>
          <figcaption>
            Diagram: a blackbody cavity with wall atoms. Emission 2→1 produces photons at the transition wavelength λ.
            The cavity field (Planck spectrum) drives stimulated emission.
          </figcaption>
        </figure>

        <figure>
          <canvas id="cMain" aria-label="Main plot: ratio vs temperature"></canvas>
          <figcaption>
            Main plot: the ratio <span class="eq" style="padding:2px 6px;">R<sub>stim</sub>/R<sub>sp</sub> = \bar n = 1/(e^{hc/(kλT)}-1)</span>
            versus temperature for the selected λ. The crossing at 1 marks <span class="eq" style="padding:2px 6px;">T*</span>.
          </figcaption>
        </figure>

        <figure style="grid-column: 1 / -1;">
          <canvas id="cSweep" aria-label="Secondary plot: equality temperature vs wavelength"></canvas>
          <figcaption>
            Secondary plot (parameter sweep): <span class="eq" style="padding:2px 6px;">T*(λ)=hc/(kλ ln2)</span> across a wavelength range.
            The vertical marker shows your selected λ, and the dot shows the corresponding <span class="eq" style="padding:2px 6px;">T*</span>.
          </figcaption>
        </figure>
      </div>

      <h3>What changes when you move the slider?</h3>
      <ul>
        <li>Changing <span class="eq" style="padding:2px 6px;">λ</span> changes the transition frequency <span class="eq" style="padding:2px 6px;">ν=c/λ</span> and photon energy <span class="eq" style="padding:2px 6px;">hν</span>.</li>
        <li>The main plot updates because the thermal occupation <span class="eq" style="padding:2px 6px;">\bar n(T)</span> depends on <span class="eq" style="padding:2px 6px;">hc/(kλT)</span>.</li>
        <li>The sweep plot updates the marker and readout using the analytic equality temperature <span class="eq" style="padding:2px 6px;">T*(λ)=hc/(kλ ln2)</span>.</li>
      </ul>
    </article>
  </main>
</div>

<footer>
  <p>
    Built for deep study: Einstein coefficients + Planck spectrum → a clean equality condition.
    Tip: use the slider to see how quickly the equality temperature rises as you move toward shorter wavelengths.
  </p>
</footer>

<script>
/* ---------------------------
   Constants (exact SI where defined)
---------------------------- */
const CONST = {
  h: 6.62607015e-34,          // J s
  c: 299792458,               // m/s
  k: 1.380649e-23,            // J/K
  ln2: Math.log(2)
};

function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function fmtPow10(x, sig=3){
  if (x === 0) return "0";
  const sign = x < 0 ? "-" : "";
  x = Math.abs(x);
  const p = Math.floor(Math.log10(x));
  const m = x / Math.pow(10,p);
  const mm = m.toFixed(Math.max(0, sig-1));
  return `${sign}${mm}×10^${p}`;
}
function fmt(x, digits=2){
  return Number(x).toFixed(digits);
}
function niceTicks(min, max, n=6){
  // simple tick generator for linear axes
  const span = max-min;
  if(span<=0) return {step:1, start:min, end:max};
  const raw = span/(n-1);
  const pow = Math.pow(10, Math.floor(Math.log10(raw)));
  const candidates = [1,2,5,10].map(v=>v*pow);
  let step = candidates[0];
  for(const s of candidates){ if(Math.abs(raw-s) < Math.abs(raw-step)) step=s; }
  const start = Math.floor(min/step)*step;
  const end = Math.ceil(max/step)*step;
  return {step, start, end};
}

/* ---------------------------
   Copy buttons (plain text)
---------------------------- */
function attachCopy(){
  document.querySelectorAll("button.copy").forEach(btn=>{
    btn.addEventListener("click", async ()=>{
      const sel = btn.getAttribute("data-copy");
      const node = document.querySelector(sel);
      if(!node) return;
      const text = node.textContent.replace(/\n{3,}/g,"\n\n").trim();
      try{
        await navigator.clipboard.writeText(text);
        const old = btn.textContent;
        btn.textContent = "Copied ✓";
        setTimeout(()=>btn.textContent=old, 900);
      }catch(e){
        const old = btn.textContent;
        btn.textContent = "Copy failed";
        setTimeout(()=>btn.textContent=old, 900);
      }
    });
  });
}

/* ---------------------------
   Canvas utilities (HiDPI + axes)
---------------------------- */
function prepCanvas(canvas){
  const rect = canvas.getBoundingClientRect();
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const w = Math.max(1, Math.floor(rect.width * dpr));
  const h = Math.max(1, Math.floor(rect.height * dpr));
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w; canvas.height = h;
  }
  const ctx = canvas.getContext("2d");
  ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  return {ctx, w: rect.width, h: rect.height, dpr};
}

function drawPanelTitle(ctx, x, y, title){
  ctx.save();
  ctx.font = "600 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillStyle = "rgba(233,238,252,.92)";
  ctx.fillText(title, x, y);
  ctx.restore();
}

function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, opts={}){
  const {x,y,w,h} = box;
  const gridAlpha = opts.gridAlpha ?? 0.10;
  const axisAlpha = opts.axisAlpha ?? 0.35;
  const tickAlpha = opts.tickAlpha ?? 0.40;

  // background
  ctx.save();
  ctx.fillStyle = "rgba(255,255,255,0.02)";
  ctx.fillRect(x, y, w, h);

  // ticks
  const xt = niceTicks(xMin, xMax, 6);
  const yt = niceTicks(yMin, yMax, 6);

  // gridlines
  ctx.strokeStyle = `rgba(255,255,255,${gridAlpha})`;
  ctx.lineWidth = 1;

  ctx.beginPath();
  for(let xv = xt.start; xv <= xt.end + 0.5*xt.step; xv += xt.step){
    const px = x + (xv - xMin) / (xMax - xMin) * w;
    ctx.moveTo(px, y);
    ctx.lineTo(px, y + h);
  }
  for(let yv = yt.start; yv <= yt.end + 0.5*yt.step; yv += yt.step){
    const py = y + h - (yv - yMin) / (yMax - yMin) * h;
    ctx.moveTo(x, py);
    ctx.lineTo(x + w, py);
  }
  ctx.stroke();

  // axes border
  ctx.strokeStyle = `rgba(255,255,255,${axisAlpha})`;
  ctx.strokeRect(x, y, w, h);

  // tick labels
  ctx.fillStyle = `rgba(183,194,224,${tickAlpha})`;
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";

  // x labels
  for(let xv = xt.start; xv <= xt.end + 0.5*xt.step; xv += xt.step){
    const px = x + (xv - xMin) / (xMax - xMin) * w;
    ctx.fillText(formatTick(xv), px - 14, y + h + 16);
  }
  // y labels
  for(let yv = yt.start; yv <= yt.end + 0.5*yt.step; yv += yt.step){
    const py = y + h - (yv - yMin) / (yMax - yMin) * h;
    ctx.fillText(formatTick(yv), x - 48, py + 4);
  }

  // axis labels
  ctx.fillStyle = "rgba(233,238,252,.82)";
  ctx.font = "600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText(xLabel, x + w - ctx.measureText(xLabel).width, y + h + 34);

  ctx.save();
  ctx.translate(x - 56, y + 10);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, 0, 0);
  ctx.restore();

  ctx.restore();

  function formatTick(v){
    // avoid too many decimals
    const av = Math.abs(v);
    if(av >= 10000) return Math.round(v).toString();
    if(av >= 1000) return (Math.round(v/10)*10).toString();
    if(av >= 100) return (Math.round(v)).toString();
    if(av >= 10) return (Math.round(v*10)/10).toString();
    return (Math.round(v*100)/100).toString();
  }

  // mapping functions
  const xToPx = (xx)=> x + (xx - xMin) / (xMax - xMin) * w;
  const yToPx = (yy)=> y + h - (yy - yMin) / (yMax - yMin) * h;

  return {xToPx, yToPx};
}

/* ---------------------------
   Physics functions
---------------------------- */
function nuFromLambda(lam_m){ return CONST.c / lam_m; }
function TstarFromLambda(lam_m){ return (CONST.h * CONST.c) / (CONST.k * lam_m * CONST.ln2); }
function nbar(lam_m, T){
  const x = (CONST.h * CONST.c) / (CONST.k * lam_m * T); // hc/(kλT)
  // handle extremes
  if(x > 80) return 0;
  const ex = Math.exp(x);
  return 1/(ex - 1);
}

/* ---------------------------
   Drawing: Diagram
---------------------------- */
function drawDiagram(canvas, state){
  const {ctx, w, h} = prepCanvas(canvas);
  ctx.clearRect(0,0,w,h);

  drawPanelTitle(ctx, 12, 18, "Diagram — Blackbody cavity and wall atom (2→1) at wavelength λ");

  const pad = 18;
  const box = {x: pad, y: 36, w: w - 2*pad, h: h - 54};
  ctx.save();
  ctx.fillStyle = "rgba(255,255,255,0.015)";
  ctx.fillRect(box.x, box.y, box.w, box.h);

  // cavity outline
  const cx = box.x + 18, cy = box.y + 18, cw = box.w - 36, ch = box.h - 36;
  ctx.strokeStyle = "rgba(255,255,255,0.25)";
  ctx.lineWidth = 2;
  ctx.strokeRect(cx, cy, cw, ch);

  // walls thicker
  ctx.strokeStyle = "rgba(125,211,252,0.20)";
  ctx.lineWidth = 10;
  ctx.strokeRect(cx, cy, cw, ch);

  // atom in wall (left)
  const ax = cx + 18, ay = cy + ch*0.52;
  ctx.fillStyle = "rgba(251,191,36,0.95)";
  ctx.beginPath();
  ctx.arc(ax, ay, 7, 0, Math.PI*2);
  ctx.fill();

  // energy levels next to atom
  ctx.strokeStyle = "rgba(233,238,252,0.7)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(ax + 18, ay - 26);
  ctx.lineTo(ax + 70, ay - 26);
  ctx.moveTo(ax + 18, ay + 12);
  ctx.lineTo(ax + 70, ay + 12);
  ctx.stroke();

  ctx.fillStyle = "rgba(183,194,224,0.9)";
  ctx.font = "12px var(--mono)";
  ctx.fillText("2", ax + 78, ay - 22);
  ctx.fillText("1", ax + 78, ay + 16);

  // downward transition arrow
  ctx.strokeStyle = "rgba(52,211,153,0.85)";
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  ctx.moveTo(ax + 44, ay - 22);
  ctx.lineTo(ax + 44, ay + 8);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(ax + 44, ay + 8);
  ctx.lineTo(ax + 38, ay + 1);
  ctx.lineTo(ax + 50, ay + 1);
  ctx.closePath();
  ctx.fillStyle = "rgba(52,211,153,0.85)";
  ctx.fill();

  // photon wave leaving into cavity
  const startX = ax + 92, startY = ay - 6;
  const endX = cx + cw*0.86, endY = ay - 6;
  ctx.strokeStyle = "rgba(167,139,250,0.85)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  const N = 80;
  for(let i=0;i<=N;i++){
    const t = i/N;
    const xx = startX + (endX-startX)*t;
    const yy = startY + Math.sin(t*10*Math.PI)*7;
    if(i===0) ctx.moveTo(xx, yy); else ctx.lineTo(xx, yy);
  }
  ctx.stroke();

  // arrow head
  ctx.fillStyle = "rgba(167,139,250,0.85)";
  ctx.beginPath();
  ctx.moveTo(endX, startY);
  ctx.lineTo(endX-10, startY-5);
  ctx.lineTo(endX-10, startY+5);
  ctx.closePath();
  ctx.fill();

  // label inside cavity
  ctx.fillStyle = "rgba(233,238,252,0.9)";
  ctx.font = "600 12px ui-sans-serif, system-ui";
  ctx.fillText("Cavity radiation field u(ν,T) (Planck spectrum)", cx + 20, cy + 26);

  // labels
  ctx.fillStyle = "rgba(183,194,224,0.95)";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  ctx.fillText("Wall atom", ax - 4, ay + 26);
  ctx.fillText(`Photon λ = ${fmt(state.lam_um,2)} μm`, cx + cw*0.55, startY - 18);

  // stimulated vs spontaneous tags
  ctx.fillStyle = "rgba(255,255,255,0.04)";
  ctx.strokeStyle = "rgba(255,255,255,0.12)";
  roundRect(ctx, cx + cw*0.52, cy + ch*0.62, cw*0.45, 58, 14);
  ctx.fill();
  ctx.stroke();

  ctx.fillStyle = "rgba(233,238,252,0.92)";
  ctx.font = "600 12px ui-sans-serif, system-ui";
  ctx.fillText("Competing processes (2→1):", cx + cw*0.54, cy + ch*0.66);
  ctx.fillStyle = "rgba(183,194,224,0.95)";
  ctx.font = "12px var(--mono)";
  ctx.fillText("Spontaneous:  A21", cx + cw*0.54, cy + ch*0.72);
  ctx.fillText("Stimulated:   B21·u(ν,T)", cx + cw*0.54, cy + ch*0.78);

  ctx.restore();

  function roundRect(ctx,x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }
}

/* ---------------------------
   Drawing: Main plot
   Ratio = Rstim/Rsp = B u / A = u / (A/B) = 1/(exp(hν/kT)-1) = nbar
---------------------------- */
function drawMain(canvas, state){
  const {ctx, w, h} = prepCanvas(canvas);
  ctx.clearRect(0,0,w,h);
  drawPanelTitle(ctx, 12, 18, "Main Plot — Ratio R_stim/R_sp = n̄ vs Temperature (fixed λ)");

  const padL = 66, padR = 18, padT = 36, padB = 54;
  const plot = {x: padL, y: padT, w: w - padL - padR, h: h - padT - padB};

  // choose ranges
  const Tstar = state.Tstar;
  const Tmax = clamp(Tstar*2.2, 8000, 60000);
  const Tmin = 0;
  // y range: show 0..5, but adapt if huge
  const yAtTmax = nbar(state.lam_m, Tmax);
  const yMax = clamp(Math.max(2.5, yAtTmax*1.15, 1.3), 2.5, 10);
  const yMin = 0;

  const axes = drawAxes(ctx, plot, Tmin, Tmax, yMin, yMax, "T (K)", "R_stim/R_sp (dimensionless)", {gridAlpha:0.10});

  // curve
  ctx.save();
  ctx.strokeStyle = "rgba(125,211,252,0.95)";
  ctx.lineWidth = 2.2;
  ctx.beginPath();
  const N = 300;
  for(let i=0;i<=N;i++){
    const T = Tmin + (Tmax-Tmin)*i/N;
    const y = nbar(state.lam_m, Math.max(1e-6, T));
    const px = axes.xToPx(T);
    const py = axes.yToPx(clamp(y, yMin, yMax));
    if(i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
  }
  ctx.stroke();

  // horizontal line y=1
  ctx.strokeStyle = "rgba(52,211,153,0.8)";
  ctx.setLineDash([6,6]);
  ctx.lineWidth = 1.8;
  ctx.beginPath();
  ctx.moveTo(plot.x, axes.yToPx(1));
  ctx.lineTo(plot.x+plot.w, axes.yToPx(1));
  ctx.stroke();
  ctx.setLineDash([]);

  // marker at T*
  const pxs = axes.xToPx(Tstar);
  const pys = axes.yToPx(1);
  ctx.fillStyle = "rgba(52,211,153,0.95)";
  ctx.beginPath();
  ctx.arc(pxs, pys, 5.5, 0, Math.PI*2);
  ctx.fill();

  // annotation
  ctx.fillStyle = "rgba(233,238,252,0.9)";
  ctx.font = "12px var(--mono)";
  const msg = `T* = ${fmt(Tstar,0)} K (where ratio = 1)`;
  ctx.fillText(msg, clamp(pxs-120, plot.x+6, plot.x+plot.w-240), clamp(pys-10, plot.y+14, plot.y+plot.h-10));

  // legend
  ctx.fillStyle = "rgba(255,255,255,0.04)";
  ctx.strokeStyle = "rgba(255,255,255,0.12)";
  ctx.lineWidth = 1;
  const lx = plot.x + 10, ly = plot.y + 10, lw = 250, lh = 52;
  roundRect(ctx, lx, ly, lw, lh, 12);
  ctx.fill(); ctx.stroke();

  ctx.fillStyle = "rgba(233,238,252,0.92)";
  ctx.font = "600 12px ui-sans-serif, system-ui";
  ctx.fillText(`λ = ${fmt(state.lam_um,2)} μm`, lx+12, ly+20);

  ctx.font = "12px var(--mono)";
  ctx.fillStyle = "rgba(183,194,224,0.95)";
  ctx.fillText("Curve: n̄(T) = 1/(exp(hc/(kλT)) − 1)", lx+12, ly+40);

  ctx.restore();

  function roundRect(ctx,x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }
}

/* ---------------------------
   Drawing: Sweep plot T*(λ)
---------------------------- */
function drawSweep(canvas, state){
  const {ctx, w, h} = prepCanvas(canvas);
  ctx.clearRect(0,0,w,h);
  drawPanelTitle(ctx, 12, 18, "Secondary Plot — Equality Temperature T*(λ) = hc/(kλ ln2)");

  const padL = 66, padR = 18, padT = 36, padB = 54;
  const plot = {x: padL, y: padT, w: w - padL - padR, h: h - padT - padB};

  const lamMin = 0.2e-6, lamMax = 5e-6;
  const TMin = TstarFromLambda(lamMax);
  const TMax = TstarFromLambda(lamMin);

  const axes = drawAxes(ctx, plot, lamMin*1e6, lamMax*1e6, TMin, TMax, "λ (μm)", "T* (K)", {gridAlpha:0.10});

  // curve
  ctx.save();
  ctx.strokeStyle = "rgba(167,139,250,0.95)";
  ctx.lineWidth = 2.2;
  ctx.beginPath();
  const N = 450;
  for(let i=0;i<=N;i++){
    const lam_um = (lamMin*1e6) + (lamMax*1e6 - lamMin*1e6)*i/N;
    const lam_m = lam_um*1e-6;
    const T = TstarFromLambda(lam_m);
    const px = axes.xToPx(lam_um);
    const py = axes.yToPx(T);
    if(i===0) ctx.moveTo(px, py); else ctx.lineTo(px, py);
  }
  ctx.stroke();

  // marker and vertical line at selected λ
  const lam_um_sel = state.lam_um;
  const T_sel = state.Tstar;
  const px = axes.xToPx(lam_um_sel);
  const py = axes.yToPx(T_sel);

  ctx.strokeStyle = "rgba(52,211,153,0.65)";
  ctx.lineWidth = 1.8;
  ctx.setLineDash([6,6]);
  ctx.beginPath();
  ctx.moveTo(px, plot.y);
  ctx.lineTo(px, plot.y+plot.h);
  ctx.stroke();
  ctx.setLineDash([]);

  ctx.fillStyle = "rgba(52,211,153,0.95)";
  ctx.beginPath();
  ctx.arc(px, py, 5.8, 0, Math.PI*2);
  ctx.fill();

  // annotation
  ctx.fillStyle = "rgba(233,238,252,0.9)";
  ctx.font = "12px var(--mono)";
  const label = `(${fmt(lam_um_sel,2)} μm, ${fmt(T_sel,0)} K)`;
  ctx.fillText(label, clamp(px+10, plot.x+6, plot.x+plot.w-220), clamp(py-10, plot.y+14, plot.y+plot.h-10));

  // legend
  ctx.fillStyle = "rgba(255,255,255,0.04)";
  ctx.strokeStyle = "rgba(255,255,255,0.12)";
  ctx.lineWidth = 1;
  roundRect(ctx, plot.x+10, plot.y+10, 280, 52, 12);
  ctx.fill(); ctx.stroke();

  ctx.fillStyle = "rgba(233,238,252,0.92)";
  ctx.font = "600 12px ui-sans-serif, system-ui";
  ctx.fillText("T*(λ) trend: shorter λ → higher T*", plot.x+22, plot.y+30);

  ctx.fillStyle = "rgba(183,194,224,0.95)";
  ctx.font = "12px var(--mono)";
  ctx.fillText("T*(λ) = hc/(kλ ln2)", plot.x+22, plot.y+48);

  ctx.restore();

  function roundRect(ctx,x,y,w,h,r){
    ctx.beginPath();
    ctx.moveTo(x+r,y);
    ctx.arcTo(x+w,y,x+w,y+h,r);
    ctx.arcTo(x+w,y+h,x,y+h,r);
    ctx.arcTo(x,y+h,x,y,r);
    ctx.arcTo(x,y,x+w,y,r);
    ctx.closePath();
  }
}

/* ---------------------------
   State + update loop
---------------------------- */
const state = {
  lam_um: 1.00,
  lam_m: 1.00e-6,
  nu: nuFromLambda(1.00e-6),
  Tstar: TstarFromLambda(1.00e-6)
};

function updateStateFromUI(){
  const lam_um = parseFloat(document.getElementById("lamSlider").value);
  state.lam_um = lam_um;
  state.lam_m = lam_um * 1e-6;
  state.nu = nuFromLambda(state.lam_m);
  state.Tstar = TstarFromLambda(state.lam_m);
}

function updateReadout(){
  const nu = state.nu;
  const T = state.Tstar;
  const txt =
    `λ = ${fmt(state.lam_um,2)} μm · ν = ${fmtPow10(nu,3)} Hz · T* = ${fmtPow10(T,3)} K`;
  document.getElementById("readout").textContent = txt;
}

function redrawAll(){
  drawDiagram(document.getElementById("cDiagram"), state);
  drawMain(document.getElementById("cMain"), state);
  drawSweep(document.getElementById("cSweep"), state);
}

function setup(){
  attachCopy();
  const slider = document.getElementById("lamSlider");
  slider.addEventListener("input", ()=>{
    updateStateFromUI();
    updateReadout();
    redrawAll();
  });

  // initial paint
  updateStateFromUI();
  updateReadout();
  redrawAll();

  // responsive resize (debounced)
  let t=null;
  window.addEventListener("resize", ()=>{
    clearTimeout(t);
    t=setTimeout(()=>redrawAll(), 120);
  });

  // smooth scrolling for TOC
  document.querySelectorAll('.toc a[href^="#"]').forEach(a=>{
    a.addEventListener("click", (e)=>{
      e.preventDefault();
      const id = a.getAttribute("href");
      const el = document.querySelector(id);
      if(el) el.scrollIntoView({behavior:"smooth", block:"start"});
    });
  });
}

setup();
</script>
</body>
</html>
