<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Power Confinement in Hermite–Gaussian Beams (HG00, HG01, HG10, HG11)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101935;
      --card:#0f1730;
      --text:#e8ecff;
      --muted:#b9c2ffcc;
      --line:#2a3566;
      --accent:#7aa2ff;
      --accent2:#7dffcf;
      --warn:#ffd36b;
      --ok:#9bff8a;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Helvetica Neue", "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(122,162,255,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(125,255,207,.12), transparent 60%),
        linear-gradient(180deg, var(--bg), #070a14 70%);
      line-height:1.55;
    }

    header{
      padding:32px 18px 18px;
      max-width:1200px;
      margin:0 auto;
    }
    .hero{
      background: linear-gradient(135deg, rgba(122,162,255,.16), rgba(125,255,207,.10));
      border:1px solid rgba(255,255,255,.10);
      border-radius: calc(var(--radius) + 6px);
      padding:22px 22px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(600px 260px at 30% 30%, rgba(255,255,255,.10), transparent 60%);
      pointer-events:none;
    }
    h1{
      margin:0 0 8px 0;
      font-size: clamp(22px, 2.5vw, 34px);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: clamp(14px, 1.5vw, 16px);
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 14px 18px 80px;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:18px;
    }

    /* Sticky TOC */
    nav#toc{
      position: sticky;
      top: 14px;
      align-self:start;
      background: rgba(16,25,53,.72);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    #toc h2{
      font-size:14px;
      margin:0 0 10px 0;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    #toc a{
      display:block;
      padding:9px 10px;
      margin:6px 0;
      border-radius: 12px;
      color:var(--text);
      text-decoration:none;
      border:1px solid transparent;
      background: rgba(15,23,48,.45);
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
      font-size: 14px;
    }
    #toc a:hover{
      transform: translateY(-1px);
      background: rgba(122,162,255,.12);
      border-color: rgba(122,162,255,.25);
    }

    article{
      background: rgba(16,25,53,.45);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      backdrop-filter: blur(10px);
      overflow:hidden;
    }

    section{
      padding: 6px 0 10px;
      border-top: 1px solid rgba(255,255,255,.10);
      margin-top: 14px;
    }
    section:first-of-type{border-top:none;margin-top:0}
    h2{
      margin: 6px 0 10px;
      font-size: 20px;
    }
    h3{
      margin: 14px 0 8px;
      font-size: 16px;
      color: #dfe6ff;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
      nav#toc{position:relative; top:auto}
      .grid2{grid-template-columns:1fr}
      .grid3{grid-template-columns:1fr}
    }

    .card{
      background: rgba(15,23,48,.55);
      border:1px solid rgba(255,255,255,.10);
      border-radius: var(--radius);
      padding:14px;
    }

    .callout{
      border-left: 4px solid var(--accent);
      background: rgba(122,162,255,.10);
    }
    .callout.warn{border-left-color: var(--warn); background: rgba(255,211,107,.10)}
    .callout.ok{border-left-color: var(--ok); background: rgba(155,255,138,.10)}
    ul{margin:8px 0 0 18px}
    li{margin:4px 0}
    .muted{color:var(--muted)}
    .pill{
      display:inline-block;
      padding:3px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      font-size: 12px;
      color: var(--muted);
      margin-left: 8px;
      vertical-align: middle;
      font-family: var(--mono);
    }

    .eq{
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 12px 12px 10px;
      margin: 10px 0;
      position:relative;
      overflow:auto;
    }
    .eq pre{
      margin:0;
      white-space: pre-wrap;
      font-family: var(--mono);
      font-size: 13px;
      color: #f1f4ff;
    }
    .copyRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top: 8px;
    }
    button.copyBtn, button.uiBtn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(122,162,255,.14);
      color: var(--text);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
      font-size: 13px;
    }
    button.copyBtn:hover, button.uiBtn:hover{
      transform: translateY(-1px);
      background: rgba(122,162,255,.22);
      border-color: rgba(122,162,255,.32);
    }
    .toast{
      display:inline-block;
      padding: 6px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.25);
      color: var(--muted);
      font-size: 12px;
      opacity:0;
      transform: translateY(4px);
      transition: opacity .18s ease, transform .18s ease;
    }
    .toast.show{opacity:1; transform: translateY(0px);}
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      align-items:end;
    }
    .field label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .field input[type="range"]{width:100%}
    .field select, .field input[type="number"]{
      width:100%;
      padding: 9px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      color: var(--text);
      outline:none;
    }
    .field .mini{
      font-size:12px;
      color: var(--muted);
      margin-top: 6px;
    }

    figure{
      margin:0;
    }
    canvas{
      width:100%;
      height: 320px;
      display:block;
      border-radius: 16px;
      background: rgba(0,0,0,.20);
      border:1px solid rgba(255,255,255,.10);
    }
    .smallCanvas{height: 280px;}
    .caption{
      margin-top:8px;
      color: var(--muted);
      font-size: 12px;
    }

    .boxed{
      border:1px solid rgba(125,255,207,.25);
      background: rgba(125,255,207,.10);
      border-radius: var(--radius);
      padding: 14px;
    }
    .final{
      border:1px solid rgba(255,255,255,.16);
      background: linear-gradient(135deg, rgba(122,162,255,.14), rgba(125,255,207,.10));
      border-radius: var(--radius);
      padding: 14px;
    }
    .kpi{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .kpi .item{
      flex: 1 1 170px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding: 10px 12px;
    }
    .kpi .v{font-family:var(--mono); font-size: 13px}
    .kpi .k{color:var(--muted); font-size:12px; margin-bottom:6px}

    footer{
      max-width:1200px;
      margin: 18px auto 0;
      padding: 0 18px 24px;
      color: var(--muted);
      font-size: 12px;
    }

    /* Subtle motion */
    @media (prefers-reduced-motion: no-preference){
      .hero, nav#toc, article { animation: floatIn .45s ease both; }
      @keyframes floatIn{
        from{opacity:0; transform: translateY(10px)}
        to{opacity:1; transform: translateY(0)}
      }
    }

    /* Print-friendly */
    @media print{
      body{background:#fff; color:#000}
      nav#toc{display:none}
      header, main{max-width:900px}
      article{box-shadow:none; backdrop-filter:none; background:#fff; border:1px solid #ccc}
      canvas{display:none}
      .copyRow{display:none}
      .pill{border-color:#999; background:#fff; color:#333}
    }
  </style>
</head>
<body>
  <header>
    <div class="hero">
      <h1>Power Confinement in Hermite–Gaussian Beams</h1>
      <p class="subtitle">
        Fraction of total optical power inside a circular aperture of radius <span class="pill">R = W(z)</span>
        for HG<sub>00</sub>, HG<sub>01</sub>, HG<sub>10</sub>, HG<sub>11</sub>.
      </p>
    </div>
  </header>

  <main>
    <nav id="toc" aria-label="Table of contents">
      <h2>Contents</h2>
      <a href="#quick">Quick Summary</a>
      <a href="#viz">Interactive Visualizations</a>
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a href="#part2">PART 2 — Strategy & Tips</a>
      <a href="#part3">PART 3 — Full Solution</a>
      <a href="#final">Final Results (boxed)</a>
      <a href="#checks">Sanity Checks</a>
    </nav>

    <article>
      <section id="quick">
        <h2>Quick Summary</h2>
        <div class="card callout">
          <ul>
            <li>We want <b>power fraction</b> inside a circle: <span class="pill">η = P(r &lt; R) / P<sub>tot</sub></span>.</li>
            <li>For HG modes, intensity is Gaussian times low-order polynomials; inside a circle, integrals become <b>radial Gaussian moments</b>.</li>
            <li>Let <span class="pill">u = 2R² / w(z)²</span>. Then:
              <span class="pill">η<sub>00</sub>=1-e^{-u}</span>,
              <span class="pill">η<sub>10</sub>=η<sub>01</sub>=1-e^{-u}(1+u)</span>,
              <span class="pill">η<sub>11</sub>=1-e^{-u}(1+u+u²/2)</span>.
            </li>
            <li>For the specific radius <b>R = W(z) = w(z)</b> (the usual 1/e field radius): <span class="pill">u=2</span>.</li>
            <li>Numerically: <span class="pill">η<sub>00</sub>=1-e^{-2}≈0.8647</span>,
              <span class="pill">η<sub>10</sub>=η<sub>01</sub>=1-3e^{-2}≈0.5940</span>,
              <span class="pill">η<sub>11</sub>=1-5e^{-2}≈0.3233</span>.
            </li>
          </ul>
        </div>
      </section>

      <section id="viz">
        <h2>Interactive Visualizations</h2>
        <div class="grid2">
          <div class="card">
            <h3>Controls</h3>
            <div class="controls">
              <div class="field">
                <label for="modeSel">Mode (for the 2D intensity map)</label>
                <select id="modeSel">
                  <option value="00">HG00</option>
                  <option value="10">HG10</option>
                  <option value="01">HG01</option>
                  <option value="11">HG11</option>
                </select>
                <div class="mini">Main plot always shows all modes; this selects the map/diagram mode.</div>
              </div>
              <div class="field">
                <label for="wmm">Example beam radius w(z) (mm)</label>
                <input id="wmm" type="number" min="0.1" step="0.1" value="1.0" />
                <div class="mini">Used only to label the diagram in physical units.</div>
              </div>
              <div class="field" style="grid-column:1 / -1;">
                <label for="rhoSlider">Circular radius R relative to w(z):  ρ = R / w(z)</label>
                <input id="rhoSlider" type="range" min="0" max="2.0" step="0.01" value="1.00" />
                <div class="mini"><span class="pill" id="rhoRead">ρ = 1.00</span> &nbsp;⇒&nbsp; <span class="pill" id="uRead">u = 2.00</span></div>
              </div>
            </div>

            <div class="kpi" aria-live="polite">
              <div class="item">
                <div class="k">η00 at current R</div>
                <div class="v" id="kpi00">—</div>
              </div>
              <div class="item">
                <div class="k">η10 = η01 at current R</div>
                <div class="v" id="kpi10">—</div>
              </div>
              <div class="item">
                <div class="k">η11 at current R</div>
                <div class="v" id="kpi11">—</div>
              </div>
            </div>
          </div>

          <div class="card">
            <h3>Diagram: circle aperture inside the beam cross-section</h3>
            <figure>
              <canvas id="cDiagram" class="smallCanvas" aria-label="Diagram canvas"></canvas>
              <div class="caption">Shows axes, the circular integration region (radius R), and a qualitative mode pattern cue.</div>
            </figure>
          </div>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card">
            <h3>Main plot: enclosed power fraction η versus ρ = R / w(z)</h3>
            <figure>
              <canvas id="cMain" aria-label="Main plot canvas"></canvas>
              <div class="caption">All four curves are computed from the symbolic formulas derived below; the vertical marker is your current ρ.</div>
            </figure>
          </div>
          <div class="card">
            <h3>Secondary plot: 2D intensity map (selected mode) + integration circle</h3>
            <figure>
              <canvas id="cMap" aria-label="Intensity map canvas"></canvas>
              <div class="caption">Intensity is shown in normalized coordinates (x/w, y/w). The circle is r = R.</div>
            </figure>
          </div>
        </div>
      </section>

      <section id="part1">
        <h2>PART 1 — Problem Analysis (no solving yet)</h2>

        <div class="grid2">
          <div class="card">
            <h3>Problem restatement (in plain words)</h3>
            <p>
              For several low-order Hermite–Gaussian (HG) beams (HG<sub>00</sub>, HG<sub>01</sub>, HG<sub>10</sub>, HG<sub>11</sub>),
              compute what fraction of the total optical power lies inside a <b>circular region</b> of radius <b>R = W(z)</b>
              in a transverse plane at propagation distance <b>z</b>.
              Then report the specific numerical ratios for HG<sub>00</sub> and HG<sub>11</sub> when <b>R = W(z)</b>.
            </p>
          </div>

          <div class="card">
            <h3>Given / Unknowns / What to find</h3>
            <ul>
              <li><b>Given:</b> Hermite–Gaussian modes HG<sub>mn</sub>, beam radius <span class="pill">w(z)</span> (often denoted W(z) in some texts), circular region radius <span class="pill">R = W(z)</span>.</li>
              <li><b>Unknowns:</b> power fractions <span class="pill">η<sub>mn</sub>(R) = P(r&lt;R)/P<sub>tot</sub></span> for (m,n) = (0,0), (0,1), (1,0), (1,1).</li>
              <li><b>Must find:</b> symbolic expressions (in terms of <span class="pill">R/w(z)</span>), and the specific values at <span class="pill">R = w(z)</span> for HG<sub>00</sub> and HG<sub>11</sub>.</li>
            </ul>
          </div>
        </div>

        <div class="card callout" style="margin-top:14px;">
          <h3>Relevant physical principles (and why they apply)</h3>
          <ul>
            <li><b>Optical power in a transverse plane</b> is the integral of intensity over area:
              <span class="pill">P = ∬ I(x,y) dA</span>. This is exactly what “contained power” means.
            </li>
            <li><b>Hermite–Gaussian mode intensity</b> is proportional to the squared field magnitude. In the transverse plane,
              low-order HG modes are a Gaussian envelope times low-order polynomials.
            </li>
            <li><b>Symmetry</b>: HG<sub>10</sub> and HG<sub>01</sub> are identical under x↔y, so their power fractions inside a circle must match.
            </li>
          </ul>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Possible approaches (compare briefly)</h3>
          <ol>
            <li><b>Direct 2D Cartesian integration</b> over the disk r&lt;R: hard because the disk boundary couples x and y.</li>
            <li><b>Switch to polar coordinates</b> and rewrite the HG polynomials for low orders: works well here because
              the needed factors become simple angular averages like ⟨cos²θ⟩.</li>
            <li><b>Use known Gaussian-moment / gamma-function identities</b> for integrals like ∫ r<sup>n</sup>e<sup>-ar²</sup>dr:
              fastest and cleanest for low-order modes.</li>
          </ol>
          <p class="muted">
            Best choice: <b>polar coordinates + Gaussian moment integrals</b> (Approaches 2+3). It gives compact closed forms and
            avoids messy error-function boundaries.
          </p>
        </div>
      </section>

      <section id="part2">
        <h2>PART 2 — Strategy & Tips (roadmap only)</h2>

        <div class="card">
          <h3>Step-by-step plan (no algebra yet)</h3>
          <ol>
            <li><b>Write the power fraction</b> as η = (integral of intensity over disk r&lt;R) / (integral over all space).</li>
            <li><b>Use standard HG mode intensity forms</b> (Gaussian envelope times polynomial factors).</li>
            <li><b>For each mode</b>, keep only the shape factor (constants cancel in the ratio).</li>
            <li><b>Convert to polar coordinates</b>: x=r cosθ, y=r sinθ, dA=r dr dθ.</li>
            <li><b>Separate angular and radial parts</b> using averages like ∫cos²θ dθ and ∫cos²θ sin²θ dθ.</li>
            <li><b>Evaluate radial Gaussian-moment integrals</b> of the form ∫ r^(odd) e^{-a r²} dr.</li>
            <li><b>Express results using</b> u = 2R²/w(z)² to simplify.</li>
            <li><b>Plug in R=w(z)</b> (so u=2) for the requested numeric ratios.</li>
          </ol>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card callout warn">
            <h3>Common mistakes</h3>
            <ul>
              <li>Mixing the Gaussian envelope forms: field often has exp(-r²/w²) but <b>intensity</b> has exp(-2r²/w²).</li>
              <li>Forgetting the Jacobian in polar coordinates: <span class="pill">dA = r dr dθ</span>.</li>
              <li>Carrying normalization constants unnecessarily: they cancel in η.</li>
              <li>Confusing the circle radius <span class="pill">R</span> with the beam radius <span class="pill">w(z)</span>.</li>
            </ul>
          </div>
          <div class="card callout ok">
            <h3>Quick tips</h3>
            <ul>
              <li>Introduce <span class="pill">u = 2R²/w²</span> early; it makes every result look like a truncated exponential series.</li>
              <li>Use angular averages: over 0→2π,
                <span class="pill">⟨cos²θ⟩=1/2</span>, <span class="pill">⟨cos²θ sin²θ⟩=1/8</span>.
              </li>
              <li>Check limits: as R→0, η→0; as R→∞, η→1.</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="part3">
        <h2>PART 3 — Full Solution</h2>

        <div class="card">
          <h3>Physical intuition</h3>
          <p>
            HG modes are Gaussian beams “decorated” by polynomial factors that push intensity away from the center
            (creating lobes and nodes). Therefore, for the same circular radius R, higher-order modes typically have
            <b>less</b> power near the center and more in the outskirts. We should expect:
          </p>
          <div class="boxed">
            <b>η<sub>00</sub> &gt; η<sub>10</sub>=η<sub>01</sub> &gt; η<sub>11</sub></b> for a fixed R comparable to w(z).
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Definitions and setup</h3>
          <p>
            Let the beam radius in the transverse plane be <span class="pill">w = w(z)</span>. Define a circular region of radius
            <span class="pill">R</span> (the problem’s radius is <span class="pill">R = W(z)</span>, typically the same as w(z) in HG notation).
            The enclosed-power fraction is
          </p>

          <div class="eq" id="eq1">
            <pre>η_mn(R) = P_mn(r &lt; R) / P_mn(total)
        = ∬_(x^2+y^2&lt;R^2) I_mn(x,y) dA  /  ∬_allspace I_mn(x,y) dA.</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eq1">Copy equation</button>
              <span class="toast" id="toast-eq1">Copied!</span>
            </div>
          </div>

          <p>
            For Hermite–Gaussian modes, the intensity can be written (up to an overall constant that cancels in η) as:
          </p>

          <div class="eq" id="eq2">
            <pre>I_mn(x,y) ∝ [H_m(√2 x/w)]^2 [H_n(√2 y/w)]^2  exp[-2(x^2+y^2)/w^2].</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eq2">Copy equation</button>
              <span class="toast" id="toast-eq2">Copied!</span>
            </div>
          </div>

          <p class="muted">
            Because η is a ratio, we can ignore the global normalization and keep only the polynomial factors and the Gaussian envelope.
          </p>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Switch to polar coordinates</h3>
          <p>
            Use <span class="pill">x = r cosθ</span>, <span class="pill">y = r sinθ</span>, and <span class="pill">dA = r dr dθ</span>.
            Also define the convenient dimensionless parameter:
          </p>

          <div class="eq" id="eqU">
            <pre>u ≡ 2R^2 / w^2   (where w = w(z)).</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eqU">Copy definition</button>
              <span class="toast" id="toast-eqU">Copied!</span>
            </div>
          </div>

          <p>
            The Gaussian factor becomes exp(-2r²/w²) = exp(-a r²) with <span class="pill">a = 2/w²</span>.
            The needed integrals reduce to radial moments of a Gaussian:
          </p>

          <div class="eq" id="eqMom">
            <pre>J_n(R) ≡ ∫_0^R r^n e^{-a r^2} dr,   and compare to J_n(∞).</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eqMom">Copy tool</button>
              <span class="toast" id="toast-eqMom">Copied!</span>
            </div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Mode-by-mode computation</h3>

          <h3>1) HG<sub>00</sub></h3>
          <p>
            For HG<sub>00</sub>, the polynomial factor is 1, so:
            <span class="pill">I00 ∝ exp(-a r²)</span>.
          </p>
          <p>
            The enclosed power is
            <span class="pill">P00(R) ∝ ∫∫_(disk) e^{-a r²} dA = ∫_0^{2π}∫_0^R e^{-a r²} r dr dθ</span>.
          </p>
          <p>
            Angular integration gives a factor 2π. The remaining radial integral is:
            <span class="pill">∫_0^R r e^{-a r²} dr = (1/2a)(1 - e^{-aR²})</span>.
            For total power, replace R→∞, giving (1/2a). Therefore:
          </p>

          <div class="eq" id="eq00">
            <pre>η_00(R) = 1 - e^{-aR^2} = 1 - exp(-2R^2/w^2) = 1 - e^{-u}.</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eq00">Copy result</button>
              <span class="toast" id="toast-eq00">Copied!</span>
            </div>
          </div>

          <h3>2) HG<sub>10</sub> and HG<sub>01</sub></h3>
          <p>
            Use the low-order Hermite polynomial: <span class="pill">H1(ξ)=2ξ</span>.
            Thus for HG<sub>10</sub>:
            <span class="pill">[H1(√2 x/w)]² ∝ x²</span> (constants cancel), so
            <span class="pill">I10 ∝ x² e^{-a r²}</span>.
          </p>
          <p>
            In polar coordinates, x² = r² cos²θ, so
          </p>
          <div class="eq" id="eq10a">
            <pre>P10(R) ∝ ∫_0^{2π}∫_0^R (r^2 cos^2θ) e^{-a r^2} (r dr dθ)
      = (∫_0^{2π} cos^2θ dθ) (∫_0^R r^3 e^{-a r^2} dr).</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eq10a">Copy step</button>
              <span class="toast" id="toast-eq10a">Copied!</span>
            </div>
          </div>
          <p>
            Evaluate the angular integral:
            <span class="pill">∫_0^{2π} cos²θ dθ = π</span>.
            Now compute the radial moment. Let u=r² ⇒ du=2r dr, so r³dr = (u)(du/2):
          </p>
          <div class="eq" id="eq10b">
            <pre>∫_0^R r^3 e^{-a r^2} dr
= (1/2) ∫_0^{R^2} u e^{-a u} du
= (1/2a^2) [ 1 - e^{-aR^2}(1 + aR^2) ].</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eq10b">Copy integral</button>
              <span class="toast" id="toast-eq10b">Copied!</span>
            </div>
          </div>
          <p>
            For total power, take R→∞, giving (1/2a²). Therefore the ratio is
          </p>
          <div class="eq" id="eq10">
            <pre>η_10(R) = 1 - e^{-aR^2}(1 + aR^2)
        = 1 - exp(-2R^2/w^2) (1 + 2R^2/w^2)
        = 1 - e^{-u}(1 + u).</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eq10">Copy result</button>
              <span class="toast" id="toast-eq10">Copied!</span>
            </div>
          </div>
          <p>
            By symmetry (swap x↔y), HG<sub>01</sub> has the same fraction:
            <span class="pill">η<sub>01</sub>(R)=η<sub>10</sub>(R)</span>.
          </p>

          <h3>3) HG<sub>11</sub></h3>
          <p>
            For HG<sub>11</sub>, the polynomial factor contributes x²y² (again, constants cancel), so:
            <span class="pill">I11 ∝ x² y² e^{-a r²}</span>.
          </p>
          <p>
            In polar: x²y² = r⁴ cos²θ sin²θ. Then
          </p>
          <div class="eq" id="eq11a">
            <pre>P11(R) ∝ ∫_0^{2π}∫_0^R (r^4 cos^2θ sin^2θ) e^{-a r^2} (r dr dθ)
      = (∫_0^{2π} cos^2θ sin^2θ dθ) (∫_0^R r^5 e^{-a r^2} dr).</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eq11a">Copy step</button>
              <span class="toast" id="toast-eq11a">Copied!</span>
            </div>
          </div>
          <p>
            The angular integral uses the average ⟨cos²θ sin²θ⟩=1/8 over a full period:
            <span class="pill">∫_0^{2π} cos²θ sin²θ dθ = 2π(1/8)=π/4</span>.
          </p>
          <p>
            For the radial integral, let u=r² again; r⁵dr = r⁴ (r dr) = u² (du/2):
          </p>
          <div class="eq" id="eq11b">
            <pre>∫_0^R r^5 e^{-a r^2} dr
= (1/2) ∫_0^{R^2} u^2 e^{-a u} du
= (1/a^3) [ 1 - e^{-aR^2}(1 + aR^2 + (aR^2)^2/2 ) ].</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eq11b">Copy integral</button>
              <span class="toast" id="toast-eq11b">Copied!</span>
            </div>
          </div>
          <p>
            With R→∞, the total radial moment becomes 1/a³, so the fraction is
          </p>
          <div class="eq" id="eq11">
            <pre>η_11(R) = 1 - e^{-aR^2}(1 + aR^2 + (aR^2)^2/2)
        = 1 - exp(-2R^2/w^2) (1 + 2R^2/w^2 + 2R^4/w^4)
        = 1 - e^{-u} (1 + u + u^2/2).</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eq11">Copy result</button>
              <span class="toast" id="toast-eq11">Copied!</span>
            </div>
          </div>
        </div>
      </section>

      <section id="final">
        <h2>Final Results (boxed)</h2>

        <div class="final">
          <p>
            Define <span class="pill">u = 2R² / w(z)²</span> with integration radius <span class="pill">R</span>.
            Then the power fractions inside a circle of radius R are:
          </p>

          <div class="eq" id="eqFinal">
            <pre>η_00(R) = 1 - e^{-u}

η_10(R) = η_01(R) = 1 - e^{-u}(1 + u)

η_11(R) = 1 - e^{-u}(1 + u + u^2/2)</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eqFinal">Copy final (symbols)</button>
              <span class="toast" id="toast-eqFinal">Copied!</span>
            </div>
          </div>

          <p>
            For the specific problem radius <b>R = W(z)</b>, and in the usual HG convention <b>W(z)=w(z)</b>,
            we have <span class="pill">R=w(z)</span> ⇒ <span class="pill">u=2</span>. Therefore:
          </p>

          <div class="eq" id="eqNums">
            <pre>η_00(R=w) = 1 - e^{-2}  ≈ 0.8646647

η_10(R=w) = η_01(R=w) = 1 - 3e^{-2} ≈ 0.5940000

η_11(R=w) = 1 - 5e^{-2} ≈ 0.3233236</pre>
            <div class="copyRow">
              <button class="copyBtn" data-copy-target="eqNums">Copy final (numbers)</button>
              <span class="toast" id="toast-eqNums">Copied!</span>
            </div>
          </div>

          <div class="boxed" style="margin-top:10px;">
            <b>Answer requested explicitly:</b><br/>
            <span class="pill">HG00: η = 1 - e^{-2} ≈ 0.8647</span><br/>
            <span class="pill">HG11: η = 1 - 5e^{-2} ≈ 0.3233</span>
          </div>
        </div>
      </section>

      <section id="checks">
        <h2>Sanity Checks</h2>

        <div class="grid3">
          <div class="card callout ok">
            <h3>Units</h3>
            <ul>
              <li>η is a ratio of powers ⇒ dimensionless.</li>
              <li>u = 2R²/w² is dimensionless, so exponentials are valid.</li>
            </ul>
          </div>
          <div class="card">
            <h3>Limiting cases</h3>
            <ul>
              <li>R→0 ⇒ u→0 ⇒ η→0 for all modes.</li>
              <li>R→∞ ⇒ u→∞ ⇒ e^{-u}→0 ⇒ η→1 for all modes.</li>
              <li>At fixed R/w, higher-order modes have smaller η (more power in outer lobes).</li>
            </ul>
          </div>
          <div class="card callout warn">
            <h3>Physical interpretation</h3>
            <ul>
              <li>HG00 concentrates power at the center ⇒ large enclosed fraction.</li>
              <li>HG10/HG01 have a nodal line through the center ⇒ less power inside the same circle.</li>
              <li>HG11 has a central node and four lobes ⇒ even less power near r=0.</li>
            </ul>
          </div>
        </div>
      </section>
    </article>
  </main>

  <footer>
    <p>
      Notes: The plotting uses example units (mm) only for diagram labeling; the physics results are symbolic and depend only on the ratio
      ρ = R/w(z). The interactive curves update live from the derived closed-form expressions.
    </p>
  </footer>

  <script>
    // ---------- Utilities ----------
    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
    function fmt(x, n=6){
      if (!isFinite(x)) return "—";
      return x.toFixed(n);
    }
    function exp(x){ return Math.exp(x); }

    // Power fraction formulas with rho = R/w, u = 2 rho^2
    function uFromRho(rho){ return 2*rho*rho; }
    function eta00(rho){ const u=uFromRho(rho); return 1 - exp(-u); }
    function eta10(rho){ const u=uFromRho(rho); return 1 - exp(-u)*(1+u); }
    function eta11(rho){ const u=uFromRho(rho); return 1 - exp(-u)*(1+u+0.5*u*u); }

    // ---------- Copy buttons ----------
    function showToast(id){
      const t = document.getElementById(id);
      if(!t) return;
      t.classList.add("show");
      setTimeout(()=>t.classList.remove("show"), 900);
    }
    function getEqText(eqId){
      const box = document.getElementById(eqId);
      if(!box) return "";
      const pre = box.querySelector("pre");
      return pre ? pre.innerText.trim() : "";
    }
    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        return true;
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        try{ document.execCommand("copy"); }catch(_){}
        document.body.removeChild(ta);
        return true;
      }
    }
    document.querySelectorAll("button.copyBtn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const target = btn.getAttribute("data-copy-target");
        const text = getEqText(target);
        await copyText(text);
        showToast("toast-"+target);
      });
    });

    // ---------- Canvas helpers (HiDPI, axes, plotting) ----------
    function setupCanvas(canvas){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(1, Math.floor(rect.width * dpr));
      const h = Math.max(1, Math.floor(rect.height * dpr));
      if(canvas.width !== w || canvas.height !== h){
        canvas.width = w;
        canvas.height = h;
      }
      const ctx = canvas.getContext("2d");
      ctx.setTransform(1,0,0,1,0,0);
      ctx.clearRect(0,0,w,h);
      return {ctx, w, h, dpr};
    }

    function drawPanelTitle(ctx, w, text){
      ctx.save();
      ctx.fillStyle = "rgba(232,236,255,0.92)";
      ctx.font = "600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(text, 14, 22);
      ctx.restore();
    }

    function drawGridAxes(ctx, plot, opts){
      const {x0,y0,x1,y1} = plot;
      const {
        xLabel="x", yLabel="y",
        xMin=0, xMax=1, yMin=0, yMax=1,
        xTicks=6, yTicks=6,
        unitX="", unitY=""
      } = opts;

      ctx.save();
      // background area
      ctx.fillStyle = "rgba(0,0,0,0.10)";
      ctx.fillRect(x0,y0,x1-x0,y1-y0);

      // grid lines
      ctx.strokeStyle = "rgba(255,255,255,0.08)";
      ctx.lineWidth = 1;
      for(let i=0;i<=xTicks;i++){
        const t = i/xTicks;
        const x = x0 + t*(x1-x0);
        ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y1); ctx.stroke();
      }
      for(let j=0;j<=yTicks;j++){
        const t = j/yTicks;
        const y = y1 - t*(y1-y0);
        ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
      }

      // axes box
      ctx.strokeStyle = "rgba(255,255,255,0.14)";
      ctx.lineWidth = 1.2;
      ctx.strokeRect(x0,y0,x1-x0,y1-y0);

      // ticks + labels
      ctx.fillStyle = "rgba(185,194,255,0.90)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      for(let i=0;i<=xTicks;i++){
        const t = i/xTicks;
        const x = x0 + t*(x1-x0);
        const val = xMin + t*(xMax-xMin);
        ctx.fillText(val.toFixed(2), x, y1+6);
      }
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      for(let j=0;j<=yTicks;j++){
        const t = j/yTicks;
        const y = y1 - t*(y1-y0);
        const val = yMin + t*(yMax-yMin);
        ctx.fillText(val.toFixed(2), x0-6, y);
      }

      // axis labels
      ctx.save();
      ctx.fillStyle = "rgba(232,236,255,0.9)";
      ctx.font = "600 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.fillText(`${xLabel}${unitX?` (${unitX})`:``}`, (x0+x1)/2, y1+42);

      ctx.translate(x0-46, (y0+y1)/2);
      ctx.rotate(-Math.PI/2);
      ctx.textBaseline = "top";
      ctx.fillText(`${yLabel}${unitY?` (${unitY})`:``}`, 0, 0);
      ctx.restore();

      ctx.restore();
    }

    function xMap(plot, x, xMin, xMax){
      return plot.x0 + (x - xMin) * (plot.x1-plot.x0) / (xMax-xMin);
    }
    function yMap(plot, y, yMin, yMax){
      return plot.y1 - (y - yMin) * (plot.y1-plot.y0) / (yMax-yMin);
    }

    function drawLegend(ctx, items, x, y){
      ctx.save();
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";
      const pad=10, lh=18;
      const width = 180;
      const height = pad*2 + lh*items.length;
      ctx.fillStyle = "rgba(0,0,0,0.30)";
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      roundRect(ctx, x, y, width, height, 12);
      ctx.fill();
      ctx.stroke();
      items.forEach((it, i)=>{
        const yy = y + pad + lh*(i+0.5);
        ctx.strokeStyle = it.color;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(x+12, yy);
        ctx.lineTo(x+38, yy);
        ctx.stroke();
        ctx.fillStyle = "rgba(232,236,255,0.92)";
        ctx.fillText(it.label, x+46, yy);
      });
      ctx.restore();
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    // ---------- Main plot: eta vs rho ----------
    function drawMain(canvas, rhoMarker){
      const {ctx,w,h} = setupCanvas(canvas);
      drawPanelTitle(ctx, w, "Enclosed power fraction η(ρ) for HG modes");

      const plot = {x0:60, y0:42, x1:w-18, y1:h-62};
      const xMin=0, xMax=2.0;
      const yMin=0, yMax=1.0;

      drawGridAxes(ctx, plot, {
        xLabel:"ρ = R / w(z)",
        yLabel:"η = P(r<R)/Ptotal",
        xMin,xMax,yMin,yMax,
        xTicks:8, yTicks:5
      });

      // colors (not explicitly named; just RGBA strings)
      const c00 = "rgba(122,162,255,0.95)";
      const c10 = "rgba(125,255,207,0.90)";
      const c11 = "rgba(255,211,107,0.90)";
      const c01 = "rgba(255,140,200,0.85)";

      function plotCurve(fn, color){
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = 2.6;
        ctx.beginPath();
        const N=500;
        for(let i=0;i<=N;i++){
          const x = xMin + (xMax-xMin)*i/N;
          const y = clamp(fn(x), yMin, yMax);
          const X = xMap(plot,x,xMin,xMax);
          const Y = yMap(plot,y,yMin,yMax);
          if(i===0) ctx.moveTo(X,Y);
          else ctx.lineTo(X,Y);
        }
        ctx.stroke();
        ctx.restore();
      }

      plotCurve(eta00, c00);
      plotCurve(eta10, c10);
      plotCurve(eta11, c11);
      // HG01 identical to HG10; draw as a dashed overlay to emphasize equality
      ctx.save();
      ctx.setLineDash([7,6]);
      plotCurve(eta10, c01);
      ctx.restore();

      // Marker line at rhoMarker
      const xm = xMap(plot, rhoMarker, xMin, xMax);
      ctx.save();
      ctx.strokeStyle = "rgba(232,236,255,0.55)";
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(xm, plot.y0);
      ctx.lineTo(xm, plot.y1);
      ctx.stroke();

      // marker dots on each curve
      const y00 = eta00(rhoMarker);
      const y10 = eta10(rhoMarker);
      const y11 = eta11(rhoMarker);

      function dot(x,y,color){
        const X = xMap(plot,x,xMin,xMax);
        const Y = yMap(plot,y,yMin,yMax);
        ctx.fillStyle = color;
        ctx.beginPath(); ctx.arc(X,Y,5,0,Math.PI*2); ctx.fill();
        ctx.strokeStyle = "rgba(0,0,0,0.35)";
        ctx.lineWidth = 1;
        ctx.stroke();
      }
      dot(rhoMarker, y00, c00);
      dot(rhoMarker, y10, c10);
      dot(rhoMarker, y11, c11);

      ctx.restore();

      drawLegend(ctx, [
        {label:"HG00", color:c00},
        {label:"HG10", color:c10},
        {label:"HG01 (same as HG10)", color:c01},
        {label:"HG11", color:c11},
      ], w-210, 56);
    }

    // ---------- Diagram: axes + circle + qualitative lobes ----------
    function drawDiagram(canvas, mode, rho, wmm){
      const {ctx,w,h} = setupCanvas(canvas);
      drawPanelTitle(ctx, w, "Transverse plane: integration circle r = R");

      const pad = 18;
      const cx = w/2, cy = (h/2)+12;
      const Rpix = Math.min(w,h)*0.30;
      const rhoClamped = clamp(rho, 0, 2.0);
      const circle = Rpix * (rhoClamped/1.0); // scaled so rho=1 corresponds to Rpix

      // soft background spot
      const grad = ctx.createRadialGradient(cx, cy, 1, cx, cy, Rpix*1.4);
      grad.addColorStop(0, "rgba(122,162,255,0.14)");
      grad.addColorStop(1, "rgba(0,0,0,0.00)");
      ctx.fillStyle = grad;
      ctx.beginPath(); ctx.arc(cx,cy,Rpix*1.45,0,Math.PI*2); ctx.fill();

      // axes
      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(pad, cy);
      ctx.lineTo(w-pad, cy);
      ctx.moveTo(cx, pad+18);
      ctx.lineTo(cx, h-pad);
      ctx.stroke();

      // arrowheads
      function arrow(x1,y1,x2,y2){
        const ang = Math.atan2(y2-y1, x2-x1);
        const L=10;
        ctx.beginPath();
        ctx.moveTo(x2,y2);
        ctx.lineTo(x2 - L*Math.cos(ang-Math.PI/7), y2 - L*Math.sin(ang-Math.PI/7));
        ctx.lineTo(x2 - L*Math.cos(ang+Math.PI/7), y2 - L*Math.sin(ang+Math.PI/7));
        ctx.closePath();
        ctx.fillStyle = "rgba(255,255,255,0.18)";
        ctx.fill();
      }
      arrow(pad,cy,w-pad,cy);
      arrow(cx,pad+18,cx,h-pad);

      ctx.fillStyle = "rgba(232,236,255,0.85)";
      ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("x", w-pad-10, cy-8);
      ctx.fillText("y", cx+8, pad+28);

      // circle region r=R
      ctx.strokeStyle = "rgba(125,255,207,0.85)";
      ctx.lineWidth = 2.0;
      ctx.beginPath(); ctx.arc(cx,cy,circle,0,Math.PI*2); ctx.stroke();

      // annotate R and w
      ctx.fillStyle = "rgba(185,194,255,0.92)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
      const Rmm = rhoClamped * wmm;
      ctx.fillText(`w(z) = ${wmm.toFixed(2)} mm`, pad, h-pad-10);
      ctx.fillText(`R = ρ w = ${Rmm.toFixed(2)} mm`, pad, h-pad-28);

      // qualitative lobe pattern cue
      ctx.save();
      ctx.globalAlpha = 0.9;
      const s = Rpix*0.65;

      function blob(x,y,rx,ry,alpha, col){
        const g = ctx.createRadialGradient(x,y,1,x,y,Math.max(rx,ry));
        g.addColorStop(0, col.replace("ALPHA", alpha.toFixed(3)));
        g.addColorStop(1, col.replace("ALPHA", "0.000"));
        ctx.fillStyle = g;
        ctx.beginPath();
        ctx.ellipse(x,y,rx,ry,0,0,Math.PI*2);
        ctx.fill();
      }

      const blue = "rgba(122,162,255,ALPHA)";
      if(mode==="00"){
        blob(cx,cy,s*0.9,s*0.9,0.35,blue);
      }else if(mode==="10"){
        blob(cx - s*0.55, cy, s*0.60, s*0.75, 0.35, blue);
        blob(cx + s*0.55, cy, s*0.60, s*0.75, 0.35, blue);
        // node line
        ctx.strokeStyle = "rgba(255,255,255,0.20)";
        ctx.lineWidth = 1.2;
        ctx.beginPath(); ctx.moveTo(cx, cy-s*0.95); ctx.lineTo(cx, cy+s*0.95); ctx.stroke();
      }else if(mode==="01"){
        blob(cx, cy - s*0.55, s*0.75, s*0.60, 0.35, blue);
        blob(cx, cy + s*0.55, s*0.75, s*0.60, 0.35, blue);
        ctx.strokeStyle = "rgba(255,255,255,0.20)";
        ctx.lineWidth = 1.2;
        ctx.beginPath(); ctx.moveTo(cx-s*0.95, cy); ctx.lineTo(cx+s*0.95, cy); ctx.stroke();
      }else{ // 11
        blob(cx - s*0.55, cy - s*0.55, s*0.55, s*0.55, 0.32, blue);
        blob(cx + s*0.55, cy - s*0.55, s*0.55, s*0.55, 0.32, blue);
        blob(cx - s*0.55, cy + s*0.55, s*0.55, s*0.55, 0.32, blue);
        blob(cx + s*0.55, cy + s*0.55, s*0.55, s*0.55, 0.32, blue);
        ctx.strokeStyle = "rgba(255,255,255,0.20)";
        ctx.lineWidth = 1.2;
        ctx.beginPath(); ctx.moveTo(cx, cy-s*0.95); ctx.lineTo(cx, cy+s*0.95); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(cx-s*0.95, cy); ctx.lineTo(cx+s*0.95, cy); ctx.stroke();
      }
      ctx.restore();

      // mode label
      ctx.fillStyle = "rgba(232,236,255,0.92)";
      ctx.font = "600 13px system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(`Selected mode: HG${mode}`, pad, pad+18);

      ctx.restore();
    }

    // ---------- Intensity map (normalized coordinates X=x/w, Y=y/w) ----------
    function intensity(mode, X, Y){
      const r2 = X*X + Y*Y;
      const g = Math.exp(-2*r2);
      if(mode==="00") return g;
      if(mode==="10") return (4*X*X)*g; // (2X)^2 * g
      if(mode==="01") return (4*Y*Y)*g;
      return (16*X*X*Y*Y)*g; // (2X)^2(2Y)^2 * g
    }

    function drawMap(canvas, mode, rho){
      const {ctx,w,h} = setupCanvas(canvas);
      drawPanelTitle(ctx, w, `Normalized intensity map I(x,y) for HG${mode} (with circle r=R)`);

      // plot region
      const plot = {x0:54, y0:42, x1:w-18, y1:h-62};
      const xMin=-2, xMax=2, yMin=-2, yMax=2;

      drawGridAxes(ctx, plot, {
        xLabel:"x / w(z)",
        yLabel:"y / w(z)",
        xMin,xMax,yMin,yMax,
        xTicks:8, yTicks:8,
        unitX:"", unitY:""
      });

      // draw heatmap by sampling grid
      const Nx = 170, Ny = 170;
      // find max for normalization within view
      let maxI = 0;
      for(let j=0;j<Ny;j++){
        const Y = yMin + (yMax-yMin)*(j+0.5)/Ny;
        for(let i=0;i<Nx;i++){
          const X = xMin + (xMax-xMin)*(i+0.5)/Nx;
          const I = intensity(mode, X, Y);
          if(I>maxI) maxI = I;
        }
      }
      maxI = maxI || 1;

      for(let j=0;j<Ny;j++){
        const Yc = yMin + (yMax-yMin)*(j+0.5)/Ny;
        const yPix0 = yMap(plot, Yc + (yMax-yMin)/Ny/2, yMin, yMax);
        const yPix1 = yMap(plot, Yc - (yMax-yMin)/Ny/2, yMin, yMax);
        const dy = Math.abs(yPix1 - yPix0) + 0.5;
        for(let i=0;i<Nx;i++){
          const Xc = xMin + (xMax-xMin)*(i+0.5)/Nx;
          const xPix0 = xMap(plot, Xc - (xMax-xMin)/Nx/2, xMin, xMax);
          const xPix1 = xMap(plot, Xc + (xMax-xMin)/Nx/2, xMin, xMax);
          const dx = Math.abs(xPix1 - xPix0) + 0.5;

          const I = intensity(mode, Xc, Yc)/maxI;
          // map intensity to color via alpha (simple, robust)
          const a = clamp(Math.pow(I, 0.65), 0, 1);
          ctx.fillStyle = `rgba(122,162,255,${(0.04 + 0.86*a).toFixed(4)})`;
          ctx.fillRect(Math.min(xPix0,xPix1), Math.min(yPix0,yPix1), dx, dy);
        }
      }

      // circle r=rho in normalized units (since r = sqrt(X^2+Y^2) and rho=R/w)
      const cx = xMap(plot, 0, xMin, xMax);
      const cy = yMap(plot, 0, yMin, yMax);
      const rx = (plot.x1-plot.x0) * (rho/(xMax-xMin)); // pixels per X times rho
      // same scale for y
      ctx.save();
      ctx.strokeStyle = "rgba(125,255,207,0.90)";
      ctx.lineWidth = 2.2;
      ctx.beginPath(); ctx.arc(cx, cy, rx, 0, Math.PI*2); ctx.stroke();

      // legend marker
      ctx.fillStyle = "rgba(232,236,255,0.90)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
      ctx.fillText(`circle: r = ρ = ${rho.toFixed(2)}`, plot.x0+10, plot.y0+18);
      ctx.restore();
    }

    // ---------- UI wiring ----------
    const modeSel = document.getElementById("modeSel");
    const rhoSlider = document.getElementById("rhoSlider");
    const wmmInput = document.getElementById("wmm");
    const rhoRead = document.getElementById("rhoRead");
    const uRead = document.getElementById("uRead");
    const kpi00 = document.getElementById("kpi00");
    const kpi10 = document.getElementById("kpi10");
    const kpi11 = document.getElementById("kpi11");

    const cMain = document.getElementById("cMain");
    const cMap = document.getElementById("cMap");
    const cDiagram = document.getElementById("cDiagram");

    function updateKPIs(rho){
      const u = uFromRho(rho);
      rhoRead.textContent = `ρ = ${rho.toFixed(2)}`;
      uRead.textContent = `u = ${u.toFixed(2)}`;
      kpi00.textContent = `η00 = ${fmt(eta00(rho), 6)}`;
      kpi10.textContent = `η10 = η01 = ${fmt(eta10(rho), 6)}`;
      kpi11.textContent = `η11 = ${fmt(eta11(rho), 6)}`;
    }

    function renderAll(){
      const mode = modeSel.value;
      const rho = parseFloat(rhoSlider.value);
      const wmm = clamp(parseFloat(wmmInput.value || "1.0"), 0.1, 1000);
      updateKPIs(rho);
      drawMain(cMain, rho);
      drawMap(cMap, mode, rho);
      drawDiagram(cDiagram, mode, rho, wmm);
    }

    // Re-render on interaction
    modeSel.addEventListener("change", renderAll);
    rhoSlider.addEventListener("input", renderAll);
    wmmInput.addEventListener("input", renderAll);

    // Re-render on resize (responsive)
    let resizeTimer=null;
    window.addEventListener("resize", ()=>{
      clearTimeout(resizeTimer);
      resizeTimer=setTimeout(renderAll, 120);
    });

    // Initial render
    renderAll();

    // Smooth scroll for TOC
    document.querySelectorAll('#toc a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        const href = a.getAttribute('href');
        if(!href || !href.startsWith('#')) return;
        const el = document.querySelector(href);
        if(el){
          e.preventDefault();
          el.scrollIntoView({behavior:'smooth', block:'start'});
          history.replaceState(null, "", href);
        }
      });
    });
  </script>
</body>
</html>
