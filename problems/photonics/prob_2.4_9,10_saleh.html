<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Diffraction Grating (Square-Wave Plate) & Reflectance of a Spherical Mirror — Full Worked Solution</title>
  <style>
    :root{
      --bg: #0b0f14;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.08);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.70);
      --faint: rgba(255,255,255,0.55);
      --border: rgba(255,255,255,0.14);
      --accent: #7dd3fc;
      --accent2:#a78bfa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius: 18px;
      --tocW: 290px;
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f7fafc;
        --panel: rgba(0,0,0,0.045);
        --panel2: rgba(0,0,0,0.06);
        --text: rgba(0,0,0,0.88);
        --muted: rgba(0,0,0,0.66);
        --faint: rgba(0,0,0,0.52);
        --border: rgba(0,0,0,0.12);
        --shadow: 0 10px 28px rgba(0,0,0,0.12);
      }
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 12% 5%, rgba(125,211,252,0.16), transparent 55%),
                  radial-gradient(900px 650px at 86% 18%, rgba(167,139,250,0.12), transparent 60%),
                  var(--bg);
      color: var(--text);
      font-family: var(--sans);
      line-height: 1.55;
    }
    a{ color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    header{
      padding: 34px 18px 18px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .hero{
      display:grid;
      grid-template-columns: 1.35fr 0.65fr;
      gap: 16px;
      align-items: stretch;
    }
    @media (max-width: 980px){
      .hero{ grid-template-columns: 1fr; }
    }
    .titleCard{
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      overflow:hidden;
      position:relative;
    }
    .titleCard:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(500px 180px at 15% 20%, rgba(125,211,252,0.16), transparent 60%),
                  radial-gradient(420px 220px at 85% 35%, rgba(167,139,250,0.14), transparent 65%);
      pointer-events:none;
      filter: blur(2px);
      opacity:0.95;
    }
    .titleCard > *{ position:relative; }
    h1{
      margin: 0 0 8px;
      font-weight: 850;
      letter-spacing: -0.02em;
      line-height: 1.12;
      font-size: clamp(1.35rem, 2.2vw, 2.05rem);
    }
    .sub{
      margin: 0 0 10px;
      color: var(--muted);
      font-size: 0.98rem;
    }
    .chips{ display:flex; flex-wrap:wrap; gap:8px; margin-top:10px; }
    .chip{
      font-size: 0.85rem;
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: 999px;
      background: rgba(255,255,255,0.04);
      color: var(--muted);
      backdrop-filter: blur(6px);
    }

    .quick{
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px 12px;
    }
    .quick h2{
      margin: 0 0 8px;
      font-size: 1.02rem;
      letter-spacing: -0.01em;
    }
    .quick ul{
      margin: 0;
      padding-left: 18px;
      color: var(--muted);
    }

    main{
      max-width: 1200px;
      margin: 0 auto 44px;
      padding: 0 18px 20px;
      display:grid;
      grid-template-columns: 1fr var(--tocW);
      gap: 16px;
      align-items:start;
    }
    @media (max-width: 1100px){
      main{ grid-template-columns: 1fr; }
    }

    article{
      background: linear-gradient(180deg, var(--panel2), var(--panel));
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 22px;
      overflow:hidden;
    }

    section{ margin-top: 18px; }
    section:first-of-type{ margin-top: 0; }
    h2{
      margin: 14px 0 10px;
      font-size: 1.22rem;
      letter-spacing: -0.01em;
    }
    h3{
      margin: 14px 0 8px;
      font-size: 1.05rem;
      letter-spacing: -0.01em;
      color: rgba(255,255,255,0.93);
    }
    @media (prefers-color-scheme: light){
      h3{ color: rgba(0,0,0,0.86); }
    }
    p{ margin: 8px 0; color: var(--text); }
    .muted{ color: var(--muted); }
    .small{ font-size: 0.92rem; color: var(--muted); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .callout{
      border: 1px solid var(--border);
      border-radius: 14px;
      padding: 12px 12px 10px;
      background: rgba(255,255,255,0.04);
    }
    .callout strong{ color: var(--text); }
    .ok{ border-left: 4px solid var(--ok); }
    .warn{ border-left: 4px solid var(--warn); }
    .info{ border-left: 4px solid var(--accent); }
    .vio{ border-left: 4px solid var(--accent2); }

    .eqCard{
      margin: 10px 0;
      border: 1px solid var(--border);
      border-radius: 14px;
      background: rgba(255,255,255,0.03);
      overflow:hidden;
    }
    .eqHead{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      padding: 10px 12px;
      border-bottom: 1px solid var(--border);
      background: rgba(255,255,255,0.03);
    }
    .eqTitle{
      font-weight: 700;
      letter-spacing: -0.01em;
      color: var(--muted);
      font-size: 0.93rem;
    }
    .btnRow{ display:flex; gap:8px; flex-wrap:wrap; }
    .btn{
      appearance:none;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.05);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-size: 0.86rem;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      user-select:none;
    }
    .btn:hover{ background: rgba(255,255,255,0.08); border-color: rgba(255,255,255,0.22); }
    .btn:active{ transform: translateY(1px); }
    .btn.primary{ border-color: rgba(125,211,252,0.5); }
    .btn.primary:hover{ background: rgba(125,211,252,0.14); }

    pre.eq{
      margin: 0;
      padding: 12px 12px 12px;
      overflow:auto;
      font-family: var(--mono);
      font-size: 0.92rem;
      line-height: 1.35;
      color: rgba(255,255,255,0.90);
      white-space: pre;
    }
    @media (prefers-color-scheme: light){
      pre.eq{ color: rgba(0,0,0,0.86); }
    }

    .boxFinal{
      border: 1px solid rgba(125,211,252,0.42);
      background: linear-gradient(180deg, rgba(125,211,252,0.12), rgba(255,255,255,0.03));
      border-radius: 16px;
      padding: 12px 12px 10px;
      margin: 12px 0;
      position:relative;
    }
    .boxFinal h3{ margin:0 0 6px; }
    .boxFinal .big{
      font-family: var(--mono);
      font-size: 0.94rem;
      line-height: 1.35;
      margin: 0;
      white-space: pre-wrap;
    }

    figure{
      margin: 12px 0;
      border: 1px solid var(--border);
      border-radius: 16px;
      background: rgba(255,255,255,0.03);
      overflow:hidden;
    }
    figcaption{
      padding: 10px 12px;
      border-top: 1px solid var(--border);
      color: var(--muted);
      font-size: 0.9rem;
    }
    .canvasWrap{
      padding: 12px;
    }
    canvas{
      width: 100%;
      height: 320px;
      display:block;
      border-radius: 12px;
      background: rgba(0,0,0,0.20);
      border: 1px solid rgba(255,255,255,0.10);
    }
    @media (prefers-color-scheme: light){
      canvas{ background: rgba(255,255,255,0.70); }
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin: 12px 0 6px;
    }
    @media (max-width: 860px){
      .controls{ grid-template-columns: 1fr; }
    }
    .control{
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 10px 12px;
      background: rgba(255,255,255,0.03);
    }
    .control label{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      font-size: 0.92rem;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .control .val{
      font-family: var(--mono);
      color: var(--text);
      font-size: 0.9rem;
    }
    input[type="range"]{
      width: 100%;
      accent-color: var(--accent);
    }
    select{
      width: 100%;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      outline:none;
    }

    aside{
      position: sticky;
      top: 14px;
      align-self:start;
      height: fit-content;
      border: 1px solid var(--border);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
      box-shadow: var(--shadow);
      padding: 12px 12px 10px;
    }
    @media (max-width: 1100px){
      aside{ position:relative; top:0; }
    }
    .tocTitle{
      margin: 0 0 10px;
      font-size: 0.98rem;
      color: var(--muted);
      font-weight: 800;
      letter-spacing: 0.02em;
      text-transform: uppercase;
    }
    .toc a{
      display:block;
      padding: 7px 9px;
      border-radius: 12px;
      border: 1px solid transparent;
      color: var(--text);
      font-size: 0.93rem;
    }
    .toc a:hover{
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
      text-decoration:none;
    }
    .toc .subLink{
      margin-left: 10px;
      color: var(--muted);
      font-size: 0.9rem;
    }

    footer{
      max-width: 1200px;
      margin: 0 auto 26px;
      padding: 0 18px;
      color: var(--muted);
      font-size: 0.92rem;
    }

    /* subtle motion */
    @media (prefers-reduced-motion: no-preference){
      article, aside, .titleCard, .quick { animation: fadeUp .45s ease both; }
      @keyframes fadeUp{
        from{ opacity:0; transform: translateY(8px); }
        to{ opacity:1; transform: translateY(0); }
      }
    }

    /* print-friendly */
    @media print{
      body{ background: #fff; color:#000; }
      header, main, footer{ max-width: 100%; }
      aside{ display:none; }
      article{ box-shadow:none; border-color:#bbb; }
      .btn, .controls{ display:none !important; }
      canvas{ border: 1px solid #bbb; }
      pre.eq{ color:#000; }
    }
  </style>
</head>

<body>
<header>
  <div class="hero">
    <div class="titleCard">
      <h1>2.4-9 Diffraction Grating (Square-Wave Plate) &amp; 2.4-10 Reflectance of a Spherical Mirror</h1>
      <p class="sub">
        Thin-element Fourier optics: (i) a <em>binary (square) phase grating</em> and its diffracted plane-wave amplitudes,
        (ii) a <em>spherical mirror</em> behaving like a quadratic-phase element (lens equivalent).
      </p>
      <div class="chips">
        <span class="chip">Fraunhofer / plane-wave decomposition</span>
        <span class="chip">Fourier series coefficients</span>
        <span class="chip">Grating equation</span>
        <span class="chip">Quadratic phase</span>
      </div>
    </div>

    <div class="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li>A periodic transmittance <span style="font-family:var(--mono)">t(x)</span> generates discrete diffracted plane waves at <span style="font-family:var(--mono)">k<sub>x</sub>=k<sub>x,i</sub>+2πm/Λ</span>.</li>
        <li>Hence <span style="font-family:var(--mono)">sin θ<sub>m</sub> = sin θ<sub>i</sub> + m λ/Λ</span>, so for small angles <span style="font-family:var(--mono)">θ ≈ λ/Λ</span> spacing persists for a square grating.</li>
        <li>A 50% duty-cycle binary phase grating has <strong>only odd</strong> diffraction orders; magnitudes fall as <span style="font-family:var(--mono)">1/|m|</span>.</li>
        <li>For normal incidence, order amplitude is the Fourier coefficient <span style="font-family:var(--mono)">T<sub>m</sub></span> of <span style="font-family:var(--mono)">t(x)</span>.</li>
        <li>A spherical mirror with sag <span style="font-family:var(--mono)">z≈(x²+y²)/(2R)</span> produces reflectance <span style="font-family:var(--mono)">r=h₀ exp[-j k₀ (x²+y²)/R]</span>.</li>
        <li>That quadratic phase matches a thin lens with <span style="font-family:var(--mono)">f = −R/2</span> (sign from reflection vs transmission convention).</li>
      </ul>
    </div>
  </div>
</header>

<main>
  <article>
    <!-- ========================= -->
    <!-- PART 1 — Problem Analysis -->
    <!-- ========================= -->
    <section id="part1">
      <h2>PART 1 — Problem Analysis</h2>

      <h3 id="p1-rewrite">Rewrite the problems (in plain words)</h3>
      <div class="grid2">
        <div class="callout info">
          <strong>2.4-9 Diffraction Grating (square thickness):</strong>
          <p class="muted">
            Replace the sinusoidal thickness variation in Exercise 2.4-5 by a <em>square-wave</em> periodic thickness
            <span style="font-family:var(--mono)">d(x)</span> with period <span style="font-family:var(--mono)">Λ ≫ λ</span>.
            Show that the diffracted waves are still separated by an angle about <span style="font-family:var(--mono)">λ/Λ</span>.
            For a plane wave incident <em>normally</em>, find the complex amplitudes of the diffracted plane waves.
          </p>
        </div>
        <div class="callout vio">
          <strong>2.4-10 Spherical mirror reflectance:</strong>
          <p class="muted">
            Show that a thin spherical mirror of radius <span style="font-family:var(--mono)">R</span> has a complex amplitude reflectance
            <span style="font-family:var(--mono)">r(x,y)=h₀ exp[-j k₀ (x²+y²)/R]</span>.
            Compare it to a thin lens transmittance and identify the equivalent focal length.
          </p>
        </div>
      </div>

      <h3 id="p1-given">Given quantities</h3>
      <ul>
        <li><strong>Wavelength:</strong> <span style="font-family:var(--mono)">λ</span>, wavenumber <span style="font-family:var(--mono)">k₀ = 2π/λ</span>.</li>
        <li><strong>Grating period:</strong> <span style="font-family:var(--mono)">Λ</span> with <span style="font-family:var(--mono)">Λ ≫ λ</span>.</li>
        <li><strong>Thin plate index:</strong> <span style="font-family:var(--mono)">n</span> (plate in air).</li>
        <li><strong>Square-wave thickness:</strong> two levels (example: <span style="font-family:var(--mono)">d_L</span> and <span style="font-family:var(--mono)">d_H</span>) repeating every <span style="font-family:var(--mono)">Λ</span>.</li>
        <li><strong>Spherical mirror radius:</strong> <span style="font-family:var(--mono)">R</span>; “thin mirror” → treat as a phase-only surface.</li>
      </ul>

      <h3 id="p1-unknowns">Unknowns</h3>
      <ul>
        <li><strong>2.4-9:</strong> diffraction angles <span style="font-family:var(--mono)">θ_m</span> and complex amplitudes <span style="font-family:var(--mono)">A_m</span> (or <span style="font-family:var(--mono)">T_m</span>) of each diffracted order for normal incidence.</li>
        <li><strong>2.4-10:</strong> show <span style="font-family:var(--mono)">r(x,y)</span> has quadratic phase; find equivalent lens focal length <span style="font-family:var(--mono)">f</span>.</li>
      </ul>

      <h3 id="p1-principles">Relevant principles (and why they apply)</h3>
      <div class="callout info">
        <ul style="margin:6px 0 0; padding-left:18px;">
          <li><strong>Thin element approximation:</strong> a thin plate/mirror multiplies the field by a complex factor
            (<span style="font-family:var(--mono)">t(x)</span> or <span style="font-family:var(--mono)">r(x,y)</span>) without changing transverse coordinates.</li>
          <li><strong>Fourier-series / plane-wave expansion:</strong> if <span style="font-family:var(--mono)">t(x)</span> is periodic, its Fourier series produces discrete transverse spatial frequencies; each corresponds to a plane wave direction.</li>
          <li><strong>Dispersion relation for plane waves:</strong> transverse wavevector component determines propagation angle:
            <span style="font-family:var(--mono)">k_x = k₀ sin θ</span> (for small angles <span style="font-family:var(--mono)">θ≈k_x/k₀</span>).</li>
          <li><strong>Paraxial sag of a spherical surface:</strong> for small radii relative to <span style="font-family:var(--mono)">R</span>,
            <span style="font-family:var(--mono)">z(x,y)≈(x²+y²)/(2R)</span>, giving a quadratic phase factor.</li>
        </ul>
      </div>

      <h3 id="p1-approaches">Possible approaches (compare & pick)</h3>
      <div class="grid2">
        <div class="callout">
          <strong>Approach A (best): Fourier coefficients</strong>
          <p class="muted">
            Write the element as <span style="font-family:var(--mono)">t(x)=∑ T_m e^{j 2π m x/Λ}</span>. Multiply the incident plane wave by
            <span style="font-family:var(--mono)">t(x)</span>. Each term becomes a plane wave with shifted <span style="font-family:var(--mono)">k_x</span>.
            Clean, general, directly yields amplitudes.
          </p>
        </div>
        <div class="callout">
          <strong>Approach B: Huygens/Fraunhofer integral</strong>
          <p class="muted">
            Compute far-field pattern as Fourier transform of aperture function.
            Works, but is more algebra than needed because periodicity guarantees discrete orders.
          </p>
        </div>
      </div>
      <div class="callout ok">
        <strong>Chosen approach:</strong> Fourier-series plane-wave decomposition (Approach A), because the question explicitly asks
        for diffracted plane waves and their amplitudes for a periodic element.
      </div>
    </section>

    <!-- ========================= -->
    <!-- PART 2 — Strategy & Tips  -->
    <!-- ========================= -->
    <section id="part2">
      <h2>PART 2 — Strategy &amp; Tips (roadmap only)</h2>

      <ol>
        <li><strong>Model the thin element:</strong> express the plate as a complex transmittance <span style="font-family:var(--mono)">t(x)</span> depending on thickness.</li>
        <li><strong>Binary (square) profile:</strong> write <span style="font-family:var(--mono)">t(x)</span> as two constants over each half-period (or duty cycle).</li>
        <li><strong>Fourier series:</strong> compute <span style="font-family:var(--mono)">T_m=(1/Λ)∫_0^Λ t(x) e^{-j2πmx/Λ} dx</span>.</li>
        <li><strong>Plane-wave directions:</strong> multiply incident wave by each Fourier harmonic and identify the new transverse wavevector <span style="font-family:var(--mono)">k_x</span>.</li>
        <li><strong>Grating equation:</strong> use <span style="font-family:var(--mono)">k_x = k₀ sin θ</span> to get <span style="font-family:var(--mono)">sin θ_m = sin θ_i + m λ/Λ</span>; for small angles, spacing ≈ <span style="font-family:var(--mono)">λ/Λ</span>.</li>
        <li><strong>Mirror phase:</strong> approximate spherical sag <span style="font-family:var(--mono)">z(x,y)</span> and compute the reflection phase shift <span style="font-family:var(--mono)">Δφ=-2k₀ z</span>.</li>
        <li><strong>Lens comparison:</strong> match the quadratic phase with <span style="font-family:var(--mono)">t_lens=exp[-j k₀ (x²+y²)/(2f)]</span> to identify <span style="font-family:var(--mono)">f</span>.</li>
      </ol>

      <div class="grid2">
        <div class="callout warn">
          <strong>Common mistakes</strong>
          <ul style="margin:6px 0 0; padding-left:18px;">
            <li>Mixing up <span style="font-family:var(--mono)">θ</span> vs <span style="font-family:var(--mono)">sin θ</span> (use small-angle only at the end).</li>
            <li>Forgetting that the <em>amplitudes</em> are Fourier coefficients, not intensities.</li>
            <li>Dropping the duty-cycle phase factor <span style="font-family:var(--mono)">e^{-jπmD}</span> for a rectangular pulse.</li>
            <li>Mirror phase uses a <strong>factor 2</strong> (down-and-back path): <span style="font-family:var(--mono)">Δφ=-2k₀ z</span>.</li>
          </ul>
        </div>
        <div class="callout ok">
          <strong>Quick tips</strong>
          <ul style="margin:6px 0 0; padding-left:18px;">
            <li>Global phase factors (same for all orders) do not affect diffraction efficiencies.</li>
            <li>For a 50% duty binary grating, even orders vanish automatically.</li>
            <li>Check energy trend: larger phase step pushes power out of zero order.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- ========================= -->
    <!-- PART 3 — Full Solution    -->
    <!-- ========================= -->
    <section id="part3">
      <h2>PART 3 — Full Solution</h2>

      <h3 id="intuition">Physical intuition first</h3>
      <p class="muted">
        A periodic plate does not “create arbitrary angles” — it can only add discrete transverse momentum
        in integer multiples of <span style="font-family:var(--mono)">2π/Λ</span>. That is why diffraction orders are discrete.
        A square-wave thickness profile just changes the <em>Fourier spectrum</em> (the order strengths), not the allowed transverse momenta.
      </p>
      <p class="muted">
        A spherical mirror is similarly simple in the paraxial regime: the surface height varies quadratically with radius,
        and reflection converts that height variation into a quadratic phase — the same mathematical object as a thin lens.
      </p>

      <h3 id="sol-249">Solution to 2.4-9 — Square-wave (binary) phase grating</h3>

      <p>
        We model the thin transparent plate by a complex amplitude transmittance <span style="font-family:var(--mono)">t(x)</span>
        that multiplies the incident complex field <span style="font-family:var(--mono)">U_i(x,z)</span>:
      </p>

      <div class="eqCard" id="eq-thin">
        <div class="eqHead">
          <div class="eqTitle">Thin-element model</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-thin pre">Copy</button>
          </div>
        </div>
        <pre class="eq">U_t(x, z=0+) = t(x) · U_i(x, z=0-)</pre>
      </div>

      <p class="muted">
        For a plate of refractive index <span style="font-family:var(--mono)">n</span> in air, the transmitted field gains a phase proportional
        to the optical path difference. Up to an irrelevant global constant phase, the <em>modulation</em> is
        <span style="font-family:var(--mono)">exp[-j k₀ (n−1) d(x)]</span>. So we take:
      </p>

      <div class="eqCard" id="eq-tx">
        <div class="eqHead">
          <div class="eqTitle">Plate transmittance (phase-only, up to a constant)</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-tx pre">Copy</button>
          </div>
        </div>
        <pre class="eq">t(x) = h0 · exp[ -j k0 (n − 1) d(x) ]   ,   k0 = 2π/λ</pre>
      </div>

      <p>
        Now let the thickness be a <strong>square-wave periodic function</strong> of period <span style="font-family:var(--mono)">Λ</span>.
        The cleanest way is to represent one period as two constant thickness levels:
      </p>

      <div class="callout info">
        <p style="margin:0;">
          Over one period <span style="font-family:var(--mono)">x ∈ [0,Λ)</span>:
          <span style="font-family:var(--mono)">d(x)=d_H</span> for <span style="font-family:var(--mono)">0≤x<DΛ</span> and
          <span style="font-family:var(--mono)">d(x)=d_L</span> for <span style="font-family:var(--mono)">DΛ≤x<Λ</span>,
          where <span style="font-family:var(--mono)">D</span> is the duty cycle. (For a symmetric square wave, <span style="font-family:var(--mono)">D=1/2</span>.)
        </p>
      </div>

      <p>
        Then <span style="font-family:var(--mono)">t(x)</span> is also piecewise constant:
      </p>

      <div class="eqCard" id="eq-binary">
        <div class="eqHead">
          <div class="eqTitle">Binary transmittance levels</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-binary pre">Copy</button>
          </div>
        </div>
        <pre class="eq">t(x) = { tH = h0 exp[-j k0 (n−1) dH] , 0 ≤ x < DΛ
       { tL = h0 exp[-j k0 (n−1) dL] , DΛ ≤ x < Λ</pre>
      </div>

      <p>
        Because <span style="font-family:var(--mono)">t(x)</span> is periodic, expand it in a Fourier series:
      </p>

      <div class="eqCard" id="eq-fourier">
        <div class="eqHead">
          <div class="eqTitle">Fourier series of periodic transmittance</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-fourier pre">Copy</button>
          </div>
        </div>
        <pre class="eq">t(x) = Σ_{m = −∞}^{∞} Tm · exp[ j (2π m/Λ) x ]</pre>
      </div>

      <p>
        The coefficients are:
      </p>

      <div class="eqCard" id="eq-Tmdef">
        <div class="eqHead">
          <div class="eqTitle">Fourier coefficient definition</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-Tmdef pre">Copy</button>
          </div>
        </div>
        <pre class="eq">Tm = (1/Λ) ∫_0^Λ t(x) · exp[ −j (2π m/Λ) x ] dx</pre>
      </div>

      <p>
        Plug in the rectangular (binary) function and compute the integral:
      </p>

      <div class="eqCard" id="eq-Tmrect">
        <div class="eqHead">
          <div class="eqTitle">Binary grating Fourier coefficients (general duty cycle D)</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-Tmrect pre">Copy</button>
          </div>
        </div>
        <pre class="eq">For m = 0:
T0 = D tH + (1−D) tL

For m ≠ 0:
Tm = (tH − tL) · exp(−j π m D) · [ sin(π m D) / (π m) ]</pre>
      </div>

      <p class="muted">
        (This is the standard Fourier series of a rectangular pulse: the sinc-like factor
        <span style="font-family:var(--mono)">sin(π m D)/(π m)</span> sets the envelope, and the exponential gives the phase shift due to pulse position.)
      </p>

      <p>
        Now connect Fourier harmonics to diffracted plane waves. Let the incident field be a plane wave:
      </p>

      <div class="eqCard" id="eq-inc">
        <div class="eqHead">
          <div class="eqTitle">Incident plane wave (in x–z plane)</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-inc pre">Copy</button>
          </div>
        </div>
        <pre class="eq">Ui(x,z) = U0 · exp[ j k0 ( x sinθi + z cosθi ) ]</pre>
      </div>

      <p>
        Right after the grating (at <span style="font-family:var(--mono)">z=0+</span>):
      </p>

      <div class="eqCard" id="eq-after">
        <div class="eqHead">
          <div class="eqTitle">Field after grating using Fourier expansion</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-after pre">Copy</button>
          </div>
        </div>
        <pre class="eq">Ut(x,0+) = t(x) Ui(x,0)
        = U0 Σm Tm · exp[ j (k0 sinθi + 2π m/Λ) x ]</pre>
      </div>

      <p>
        Each term is a plane wave with transverse wavevector
        <span style="font-family:var(--mono)">k_{x,m} = k0 sinθi + 2π m/Λ</span>.
        Since a propagating plane wave satisfies <span style="font-family:var(--mono)">k_{x,m} = k0 sinθ_m</span>, we get the <strong>grating equation</strong>:
      </p>

      <div class="eqCard" id="eq-grating">
        <div class="eqHead">
          <div class="eqTitle">Grating equation from transverse momentum matching</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-grating pre">Copy</button>
          </div>
        </div>
        <pre class="eq">k0 sinθm = k0 sinθi + 2π m/Λ
⇒ sinθm = sinθi + m λ/Λ</pre>
      </div>

      <p>
        Therefore the <em>angular separation</em> between adjacent diffracted orders is (for small angles):
      </p>

      <div class="eqCard" id="eq-spacing">
        <div class="eqHead">
          <div class="eqTitle">Small-angle spacing (what the exercise asks to show)</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-spacing pre">Copy</button>
          </div>
        </div>
        <pre class="eq">If |θ|≪1 rad, then sinθ ≈ θ.
So θm ≈ θi + m (λ/Λ)  ⇒  Δθ ≈ λ/Λ</pre>
      </div>

      <p class="muted">
        This conclusion is independent of whether the thickness profile is sinusoidal or square: the allowed
        transverse “kicks” are set only by the period <span style="font-family:var(--mono)">Λ</span>.
      </p>

      <h4 style="margin:14px 0 6px; font-size:1.0rem;">Normal incidence amplitudes (what you must “determine”)</h4>
      <p>
        For normal incidence, <span style="font-family:var(--mono)">θi=0</span>, so the diffracted plane-wave <strong>complex amplitudes</strong> are proportional to <span style="font-family:var(--mono)">T_m</span>:
        <span style="font-family:var(--mono)">A_m = U0 T_m</span>.
      </p>

      <div class="boxFinal" id="final-249">
        <h3>Final result (2.4-9)</h3>
        <p class="big" id="finalText249">Diffraction directions:
  sin θm = m λ/Λ   (normal incidence)

Complex amplitude of order m:
  Am = U0 Tm

For a binary (square) phase grating (duty D), with
  tH = h0 exp[−j k0 (n−1) dH],  tL = h0 exp[−j k0 (n−1) dL]:

  T0 = D tH + (1−D) tL
  Tm (m≠0) = (tH − tL) exp(−j π m D) · sin(π m D)/(π m)

Special case D = 1/2 (symmetric square wave):
  T0 = (tH + tL)/2
  Tm = (tH − tL) · exp(−j π m/2) · sin(π m/2)/(π m)
      ⇒ even m: Tm = 0 ; odd m: |Tm| = |tH − tL|/(π|m|)</p>
        <div class="btnRow" style="margin-top:10px;">
          <button class="btn primary" data-copy="#finalText249">Copy final (plain text)</button>
        </div>
      </div>

      <h4 style="margin:14px 0 6px; font-size:1.0rem;">Sanity checks (2.4-9)</h4>
      <div class="grid2">
        <div class="callout ok">
          <strong>Units</strong>
          <p class="muted" style="margin:6px 0 0;">
            <span style="font-family:var(--mono)">λ/Λ</span> is dimensionless (radians in small-angle approximation), consistent for <span style="font-family:var(--mono)">θ</span>.
            Fourier coefficients <span style="font-family:var(--mono)">T_m</span> are dimensionless complex amplitudes.
          </p>
        </div>
        <div class="callout info">
          <strong>Limiting cases</strong>
          <p class="muted" style="margin:6px 0 0;">
            If <span style="font-family:var(--mono)">dH=dL</span>, then <span style="font-family:var(--mono)">tH=tL</span> and all <span style="font-family:var(--mono)">T_{m≠0}=0</span>:
            no diffraction, only zero order. If the phase step approaches π (strong binary phase grating), power is strongly redistributed into nonzero orders.
          </p>
        </div>
      </div>

      <hr style="border:none; height:1px; background: var(--border); margin: 18px 0;">

      <h3 id="sol-2410">Solution to 2.4-10 — Reflectance of a spherical mirror</h3>

      <p>
        Consider a spherical mirror whose surface departs from a reference plane by a small sag
        <span style="font-family:var(--mono)">z(x,y)</span> (paraxial approximation). For a sphere of radius <span style="font-family:var(--mono)">R</span>,
        near the vertex we use:
      </p>

      <div class="eqCard" id="eq-sag">
        <div class="eqHead">
          <div class="eqTitle">Paraxial sag of a spherical surface</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-sag pre">Copy</button>
          </div>
        </div>
        <pre class="eq">z(x,y) ≈ (x^2 + y^2) / (2R)    (for (x^2+y^2) ≪ R^2)</pre>
      </div>

      <p>
        A normally incident plane wave reflects. If a point on the mirror is displaced by <span style="font-family:var(--mono)">z</span>
        along the optical axis, the round-trip path length changes by approximately <span style="font-family:var(--mono)">2z</span>.
        The corresponding phase change (relative to the reference plane) is:
      </p>

      <div class="eqCard" id="eq-mirrorphase">
        <div class="eqHead">
          <div class="eqTitle">Reflection phase from surface height (factor 2!)</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-mirrorphase pre">Copy</button>
          </div>
        </div>
        <pre class="eq">Δφ(x,y) = −k0 · (2 z(x,y)) = −2 k0 z(x,y)</pre>
      </div>

      <p class="muted">
        (The minus sign is the usual “extra distance increases negative phase” convention for the complex field
        <span style="font-family:var(--mono)">exp(+j k·r)</span> at a fixed reference plane; the exercise’s target form uses the same convention.)
      </p>

      <p>
        Therefore the mirror’s complex amplitude reflectance is a constant magnitude/phase factor <span style="font-family:var(--mono)">h0</span>
        times the spatially varying phase:
      </p>

      <div class="eqCard" id="eq-rxy">
        <div class="eqHead">
          <div class="eqTitle">Spherical mirror reflectance</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-rxy pre">Copy</button>
          </div>
        </div>
        <pre class="eq">r(x,y) = h0 · exp[ j Δφ(x,y) ]
       = h0 · exp[ −2j k0 z(x,y) ]
       = h0 · exp[ −j k0 (x^2 + y^2)/R ]</pre>
      </div>

      <p>
        Now compare this to the thin-lens complex amplitude transmittance (paraxial, phase-only lens):
      </p>

      <div class="eqCard" id="eq-lens">
        <div class="eqHead">
          <div class="eqTitle">Thin lens quadratic phase</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-lens pre">Copy</button>
          </div>
        </div>
        <pre class="eq">t_lens(x,y) = exp[ −j k0 (x^2 + y^2)/(2f) ]</pre>
      </div>

      <p>
        Matching the quadratic phase coefficients:
      </p>

      <div class="eqCard" id="eq-match">
        <div class="eqHead">
          <div class="eqTitle">Coefficient matching ⇒ equivalent focal length</div>
          <div class="btnRow">
            <button class="btn primary" data-copy="#eq-match pre">Copy</button>
          </div>
        </div>
        <pre class="eq">Mirror:  phase coefficient = 1/R
Lens:    phase coefficient = 1/(2f)

So |f| = R/2.

With the exercise’s transmission-form sign convention for an equivalent lens:
  f = −R/2</pre>
      </div>

      <div class="boxFinal" id="final-2410">
        <h3>Final result (2.4-10)</h3>
        <p class="big" id="finalText2410">Spherical mirror reflectance (thin, paraxial):
  r(x,y) = h0 · exp[ −j k0 (x^2 + y^2)/R ].

Compared to a thin lens:
  t_lens(x,y) = exp[ −j k0 (x^2 + y^2)/(2f) ],

the spherical mirror is equivalent (in quadratic phase) to a lens with:
  f = −R/2   (magnitude R/2; sign from reflection vs transmission convention).</p>
        <div class="btnRow" style="margin-top:10px;">
          <button class="btn primary" data-copy="#finalText2410">Copy final (plain text)</button>
        </div>
      </div>

      <h4 style="margin:14px 0 6px; font-size:1.0rem;">Sanity checks (2.4-10)</h4>
      <div class="grid2">
        <div class="callout ok">
          <strong>Units</strong>
          <p class="muted" style="margin:6px 0 0;">
            <span style="font-family:var(--mono)">k0(x^2+y^2)/R</span> is dimensionless because <span style="font-family:var(--mono)">k0</span> is 1/length and
            <span style="font-family:var(--mono)">(x^2+y^2)/R</span> is length.
          </p>
        </div>
        <div class="callout info">
          <strong>Physical interpretation</strong>
          <p class="muted" style="margin:6px 0 0;">
            Quadratic phase means the wavefront becomes curved after reflection: the mirror focuses like a lens.
            The familiar paraxial result is focal length magnitude <span style="font-family:var(--mono)">R/2</span>.
          </p>
        </div>
      </div>
    </section>

    <!-- ========================= -->
    <!-- Visualizations            -->
    <!-- ========================= -->
    <section id="viz">
      <h2>Interactive Visualizations</h2>
      <p class="muted">
        The controls below change the <strong>same parameters used in the derivations</strong> and update all plots live:
        wavelength changes <span style="font-family:var(--mono)">k0</span>, which affects both the grating phase step and the mirror/lens phase.
      </p>

      <div class="controls">
        <div class="control">
          <label>
            <span>Wavelength <span style="font-family:var(--mono)">λ</span> (nm)</span>
            <span class="val" id="valLambdaNm">1550</span>
          </label>
          <input id="sLambda" type="range" min="400" max="2000" value="1550" step="10" />
          <div class="small">Used in: <span style="font-family:var(--mono)">k0=2π/λ</span>, diffraction angles, phase step.</div>
        </div>

        <div class="control">
          <label>
            <span>Thickness step <span style="font-family:var(--mono)">Δd = dH − dL</span> (µm)</span>
            <span class="val" id="valDdUm">0.500</span>
          </label>
          <input id="sDd" type="range" min="0" max="2.0" value="0.5" step="0.01" />
          <div class="small">Used in: <span style="font-family:var(--mono)">Δφ = k0 (n−1) Δd</span> (binary phase grating).</div>
        </div>

        <div class="control">
          <label>
            <span>Grating period <span style="font-family:var(--mono)">Λ</span> (µm)</span>
            <span class="val" id="valPeriodUm">20.0</span>
          </label>
          <input id="sPeriod" type="range" min="2" max="100" value="20" step="0.5" />
          <div class="small">Used in: <span style="font-family:var(--mono)">sin θm = m λ/Λ</span>.</div>
        </div>

        <div class="control">
          <label>
            <span>Mirror radius <span style="font-family:var(--mono)">R</span> (cm)</span>
            <span class="val" id="valRcm">10.0</span>
          </label>
          <input id="sR" type="range" min="2" max="50" value="10" step="0.5" />
          <div class="small">Used in: <span style="font-family:var(--mono)">r(x,y)=h0 exp[−j k0 r^2/R]</span>, equivalent <span style="font-family:var(--mono)">f=−R/2</span>.</div>
        </div>

        <div class="control" style="grid-column: 1 / -1;">
          <label>
            <span>Refractive index <span style="font-family:var(--mono)">n</span> (plate)</span>
            <span class="val" id="valN">1.50</span>
          </label>
          <input id="sN" type="range" min="1.0" max="2.2" value="1.5" step="0.01" />
          <div class="small">Used in: <span style="font-family:var(--mono)">Δφ = k0 (n−1) Δd</span>.</div>
        </div>
      </div>

      <figure>
        <div class="canvasWrap">
          <canvas id="cDiagram" aria-label="Diagram of diffraction grating and spherical mirror"></canvas>
        </div>
        <figcaption>
          Diagram: (left) binary phase grating producing discrete diffraction orders; (right) spherical mirror sag producing quadratic phase.
        </figcaption>
      </figure>

      <figure>
        <div class="canvasWrap">
          <canvas id="cMain" aria-label="Main plot: diffraction order amplitudes"></canvas>
        </div>
        <figcaption>
          Main plot: complex-amplitude magnitudes |T<sub>m</sub>| (and intensities |T<sub>m</sub>|²) versus diffraction order m for a 50% duty binary grating.
        </figcaption>
      </figure>

      <figure>
        <div class="canvasWrap">
          <canvas id="cSecondary" aria-label="Secondary plot: angles and quadratic phases"></canvas>
        </div>
        <figcaption>
          Secondary plot: (A) diffraction angles θ<sub>m</sub> vs m; (B) quadratic phase vs radius for mirror and equivalent lens. Both depend on λ.
        </figcaption>
      </figure>

      <div class="callout info">
        <strong>Example values used in plots:</strong>
        <span class="muted">The sliders define the numeric values (λ, Δd, Λ, R, n). The symbolic results above remain general.</span>
      </div>
    </section>
  </article>

  <aside>
    <div class="tocTitle">Table of Contents</div>
    <nav class="toc" aria-label="Table of contents">
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a class="subLink" href="#p1-rewrite">• Rewrite</a>
      <a class="subLink" href="#p1-given">• Given / Unknowns</a>
      <a class="subLink" href="#p1-principles">• Principles</a>
      <a class="subLink" href="#p1-approaches">• Approaches</a>

      <a href="#part2">PART 2 — Strategy &amp; Tips</a>

      <a href="#part3">PART 3 — Full Solution</a>
      <a class="subLink" href="#sol-249">• 2.4-9 (square grating)</a>
      <a class="subLink" href="#sol-2410">• 2.4-10 (spherical mirror)</a>

      <a href="#viz">Interactive Visualizations</a>
    </nav>
  </aside>
</main>

<footer>
  <p>
    Built as a self-contained HTML article (no external libraries). Equations are rendered as plain text for portability.
  </p>
</footer>

<script>
/* ===========================
   Smooth TOC scrolling
   =========================== */
document.querySelectorAll('aside a[href^="#"]').forEach(a=>{
  a.addEventListener('click', (e)=>{
    const id = a.getAttribute('href');
    const el = document.querySelector(id);
    if(!el) return;
    e.preventDefault();
    el.scrollIntoView({behavior:'smooth', block:'start'});
    history.replaceState(null, "", id);
  });
});

/* ===========================
   Copy buttons
   =========================== */
async function copyFromSelector(sel){
  const el = document.querySelector(sel);
  if(!el) return;
  const txt = el.innerText.trim();
  try{
    await navigator.clipboard.writeText(txt);
    toast("Copied ✓");
  }catch(err){
    // fallback
    const ta = document.createElement('textarea');
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand('copy');
    ta.remove();
    toast("Copied ✓");
  }
}
document.querySelectorAll('[data-copy]').forEach(btn=>{
  btn.addEventListener('click', ()=> copyFromSelector(btn.getAttribute('data-copy')));
});
let toastTimer=null;
function toast(msg){
  let t = document.getElementById('toast');
  if(!t){
    t = document.createElement('div');
    t.id='toast';
    t.style.position='fixed';
    t.style.left='50%';
    t.style.bottom='18px';
    t.style.transform='translateX(-50%)';
    t.style.padding='10px 12px';
    t.style.borderRadius='999px';
    t.style.border='1px solid rgba(255,255,255,0.18)';
    t.style.background='rgba(0,0,0,0.65)';
    t.style.backdropFilter='blur(10px)';
    t.style.color='rgba(255,255,255,0.92)';
    t.style.fontFamily='var(--sans)';
    t.style.fontSize='0.92rem';
    t.style.boxShadow='0 12px 30px rgba(0,0,0,0.35)';
    t.style.zIndex='9999';
    document.body.appendChild(t);
  }
  t.textContent = msg;
  t.style.opacity='1';
  if(toastTimer) clearTimeout(toastTimer);
  toastTimer = setTimeout(()=>{ t.style.opacity='0'; }, 1100);
}

/* ===========================
   Math helpers (complex)
   =========================== */
function c(re, im){ return {re, im}; }
function cAdd(a,b){ return c(a.re+b.re, a.im+b.im); }
function cSub(a,b){ return c(a.re-b.re, a.im-b.im); }
function cMul(a,b){ return c(a.re*b.re - a.im*b.im, a.re*b.im + a.im*b.re); }
function cScale(a,s){ return c(a.re*s, a.im*s); }
function cAbs(a){ return Math.hypot(a.re, a.im); }
function cExpI(phi){ return c(Math.cos(phi), Math.sin(phi)); } // e^{i phi}
function cExpNegI(phi){ return c(Math.cos(phi), -Math.sin(phi)); } // e^{-i phi}

/* ===========================
   Canvas plotting utilities
   =========================== */
function setupCanvas(canvas){
  const ctx = canvas.getContext('2d');
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(2, Math.floor(rect.width * dpr));
    canvas.height = Math.max(2, Math.floor(rect.height * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  }
  resize();
  return {ctx, resize};
}

function drawAxes(ctx, x0,y0,w,h, opts){
  const {title="", xLabel="", yLabel="", xTicks=5, yTicks=5, grid=true} = opts || {};
  ctx.save();
  // panel
  ctx.lineWidth = 1;
  ctx.strokeStyle = getComputedStyle(document.documentElement).getPropertyValue('--border').trim() || 'rgba(255,255,255,0.14)';
  ctx.fillStyle = 'rgba(255,255,255,0.02)';
  ctx.fillRect(x0,y0,w,h);
  ctx.strokeRect(x0,y0,w,h);

  // title
  ctx.fillStyle = getTextColor();
  ctx.font = '700 14px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
  ctx.fillText(title, x0+10, y0+18);

  // axes area
  const padL = 56, padR = 16, padT = 30, padB = 44;
  const ax = {x: x0+padL, y: y0+padT, w: w-padL-padR, h: h-padT-padB};

  // grid + ticks (tick labels set by caller using mapping)
  ctx.strokeStyle = 'rgba(255,255,255,0.10)';
  if(isLight()) ctx.strokeStyle = 'rgba(0,0,0,0.10)';
  ctx.lineWidth = 1;

  if(grid){
    for(let i=0;i<=xTicks;i++){
      const x = ax.x + ax.w*(i/xTicks);
      ctx.beginPath(); ctx.moveTo(x, ax.y); ctx.lineTo(x, ax.y+ax.h); ctx.stroke();
    }
    for(let j=0;j<=yTicks;j++){
      const y = ax.y + ax.h*(j/yTicks);
      ctx.beginPath(); ctx.moveTo(ax.x, y); ctx.lineTo(ax.x+ax.w, y); ctx.stroke();
    }
  }

  // axes lines
  ctx.strokeStyle = getAxisColor();
  ctx.lineWidth = 1.25;
  ctx.beginPath();
  ctx.moveTo(ax.x, ax.y+ax.h);
  ctx.lineTo(ax.x+ax.w, ax.y+ax.h);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(ax.x, ax.y);
  ctx.lineTo(ax.x, ax.y+ax.h);
  ctx.stroke();

  // labels
  ctx.fillStyle = getMutedColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
  ctx.fillText(xLabel, ax.x + ax.w/2 - ctx.measureText(xLabel).width/2, y0 + h - 14);
  // y label rotated
  ctx.save();
  ctx.translate(x0+16, ax.y + ax.h/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
  ctx.restore();

  ctx.restore();
  return ax;
}

function getTextColor(){
  return isLight() ? 'rgba(0,0,0,0.88)' : 'rgba(255,255,255,0.92)';
}
function getMutedColor(){
  return isLight() ? 'rgba(0,0,0,0.60)' : 'rgba(255,255,255,0.70)';
}
function getAxisColor(){
  return isLight() ? 'rgba(0,0,0,0.55)' : 'rgba(255,255,255,0.55)';
}
function isLight(){
  return window.matchMedia && window.matchMedia('(prefers-color-scheme: light)').matches;
}

/* ===========================
   Problem parameters (interactive)
   =========================== */
const S = {
  lambda_nm: 1550,
  dd_um: 0.50,
  period_um: 20.0,
  R_cm: 10.0,
  n: 1.50,
  duty: 0.5,       // keep fixed (square wave)
  mMax: 9
};

const ui = {
  sLambda: document.getElementById('sLambda'),
  sDd: document.getElementById('sDd'),
  sPeriod: document.getElementById('sPeriod'),
  sR: document.getElementById('sR'),
  sN: document.getElementById('sN'),
  valLambdaNm: document.getElementById('valLambdaNm'),
  valDdUm: document.getElementById('valDdUm'),
  valPeriodUm: document.getElementById('valPeriodUm'),
  valRcm: document.getElementById('valRcm'),
  valN: document.getElementById('valN')
};

function syncUI(){
  ui.valLambdaNm.textContent = (+S.lambda_nm).toFixed(0);
  ui.valDdUm.textContent = (+S.dd_um).toFixed(3);
  ui.valPeriodUm.textContent = (+S.period_um).toFixed(1);
  ui.valRcm.textContent = (+S.R_cm).toFixed(1);
  ui.valN.textContent = (+S.n).toFixed(2);
}

['input','change'].forEach(evt=>{
  ui.sLambda.addEventListener(evt, ()=>{ S.lambda_nm = +ui.sLambda.value; syncUI(); renderAll(); });
  ui.sDd.addEventListener(evt, ()=>{ S.dd_um = +ui.sDd.value; syncUI(); renderAll(); });
  ui.sPeriod.addEventListener(evt, ()=>{ S.period_um = +ui.sPeriod.value; syncUI(); renderAll(); });
  ui.sR.addEventListener(evt, ()=>{ S.R_cm = +ui.sR.value; syncUI(); renderAll(); });
  ui.sN.addEventListener(evt, ()=>{ S.n = +ui.sN.value; syncUI(); renderAll(); });
});

/* ===========================
   Physics calculations
   =========================== */
function k0(){
  const lambda_m = S.lambda_nm * 1e-9;
  return 2*Math.PI / lambda_m;
}
function deltaPhi(){
  // Δφ = k0 (n−1) Δd
  const dd_m = S.dd_um * 1e-6;
  return k0() * (S.n - 1) * dd_m;
}
function gratingCoeffsBinary50(){
  // 50% duty, take tH=1, tL=exp(-iΔφ); global factor ignored
  const dphi = deltaPhi();
  const tH = c(1,0);
  const tL = cExpNegI(dphi);

  const coeffs = [];
  for(let m=-S.mMax; m<=S.mMax; m++){
    let T;
    if(m===0){
      T = cScale(cAdd(tH,tL), 0.5);
    }else{
      // Tm = (tH - tL) e^{-j π m/2} sin(π m/2)/(π m)
      const diff = cSub(tH, tL);
      const phase = cExpNegI(Math.PI*m/2);
      const s = Math.sin(Math.PI*m/2);
      const factor = s/(Math.PI*m);
      T = cMul(diff, cScale(phase, factor));
    }
    coeffs.push({m, T, mag: cAbs(T), inten: cAbs(T)*cAbs(T)});
  }
  return coeffs;
}
function theta_m(m){
  // sin θm = m λ/Λ (normal incidence)
  const lam = S.lambda_nm*1e-9;
  const Lam = S.period_um*1e-6;
  const s = m * lam / Lam;
  // clamp to [-1,1] for arcsin; if |s|>1 then evanescent (not propagating)
  if(Math.abs(s) > 1) return null;
  return Math.asin(s); // radians
}
function equivF_m(){
  // f = -R/2
  const Rm = S.R_cm * 1e-2;
  return -Rm/2;
}

/* ===========================
   Renderers
   =========================== */
const diagram = setupCanvas(document.getElementById('cDiagram'));
const mainPlot = setupCanvas(document.getElementById('cMain'));
const secPlot = setupCanvas(document.getElementById('cSecondary'));

function renderDiagram(){
  const canvas = document.getElementById('cDiagram');
  const ctx = diagram.ctx;
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;

  ctx.clearRect(0,0,w,h);

  // background panel + title
  ctx.save();
  ctx.fillStyle = isLight() ? 'rgba(255,255,255,0.75)' : 'rgba(0,0,0,0.18)';
  ctx.fillRect(0,0,w,h);

  ctx.fillStyle = getTextColor();
  ctx.font = '700 14px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
  ctx.fillText('Diagram — Grating diffraction & spherical mirror phase', 12, 20);

  // split line
  ctx.strokeStyle = isLight() ? 'rgba(0,0,0,0.10)' : 'rgba(255,255,255,0.10)';
  ctx.beginPath();
  ctx.moveTo(w*0.5, 34);
  ctx.lineTo(w*0.5, h-14);
  ctx.stroke();

  // Left: grating
  const L = {x: 14, y: 34, w: w*0.5-22, h: h-48};
  ctx.strokeStyle = getAxisColor();
  ctx.strokeRect(L.x, L.y, L.w, L.h);

  // draw grating bars at z=0 (vertical line)
  const gx = L.x + L.w*0.45;
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(gx, L.y+20);
  ctx.lineTo(gx, L.y+L.h-20);
  ctx.stroke();

  // draw alternating "steps" around line
  const bars = 10;
  for(let i=0;i<bars;i++){
    const y0 = L.y+26 + i*(L.h-52)/bars;
    const y1 = L.y+26 + (i+1)*(L.h-52)/bars;
    const wide = (i%2===0) ? 10 : 4;
    ctx.strokeStyle = isLight() ? 'rgba(0,0,0,0.45)' : 'rgba(255,255,255,0.45)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(gx-wide, y0);
    ctx.lineTo(gx-wide, y1);
    ctx.stroke();
  }

  // incident wave arrow (from left)
  ctx.lineWidth = 2;
  ctx.strokeStyle = isLight() ? 'rgba(0,0,0,0.70)' : 'rgba(255,255,255,0.70)';
  const yi = L.y + L.h*0.55;
  arrow(ctx, L.x+20, yi, gx-18, yi);
  label(ctx, 'Incident plane wave', L.x+22, yi-10);

  // diffracted orders on right
  const orders = [-2,-1,0,1,2];
  const lam = S.lambda_nm*1e-9;
  const Lam = S.period_um*1e-6;
  for(const m of orders){
    const th = theta_m(m);
    const x0 = gx+10, y0 = yi;
    let x1, y1;
    if(th===null){
      x1 = gx+90; y1 = yi - m*20;
      ctx.setLineDash([6,4]);
    }else{
      x1 = x0 + 140*Math.cos(th);
      y1 = y0 - 140*Math.sin(th);
      ctx.setLineDash([]);
    }
    ctx.strokeStyle = isLight() ? 'rgba(0,0,0,0.65)' : 'rgba(255,255,255,0.65)';
    arrow(ctx, x0,y0, x1,y1);
    label(ctx, 'm='+m, x1+6, y1+4);
  }
  ctx.setLineDash([]);

  // annotate Λ and λ/Λ
  ctx.fillStyle = getMutedColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
  ctx.fillText('Period Λ sets Δkx = 2π/Λ', L.x+18, L.y+18);
  ctx.fillText('Angle spacing (small): Δθ ≈ λ/Λ', L.x+18, L.y+L.h-10);

  // Right: spherical mirror
  const R = {x: w*0.5+10, y: 34, w: w*0.5-24, h: h-48};
  ctx.strokeStyle = getAxisColor();
  ctx.strokeRect(R.x, R.y, R.w, R.h);

  // draw mirror arc
  const cx = R.x + R.w*0.62;
  const cy = R.y + R.h*0.52;
  const rad = Math.min(R.w,R.h)*0.58;
  ctx.lineWidth = 2;
  ctx.strokeStyle = isLight() ? 'rgba(0,0,0,0.70)' : 'rgba(255,255,255,0.70)';
  ctx.beginPath();
  ctx.arc(cx, cy, rad, Math.PI*0.62, Math.PI*1.38, false);
  ctx.stroke();

  // axis line
  ctx.strokeStyle = isLight() ? 'rgba(0,0,0,0.35)' : 'rgba(255,255,255,0.35)';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(R.x+20, cy);
  ctx.lineTo(R.x+R.w-20, cy);
  ctx.stroke();

  // incident and reflected rays
  arrow(ctx, R.x+30, cy+40, cx-rad+6, cy+40);
  label(ctx, 'Incident', R.x+34, cy+30);
  arrow(ctx, cx-rad+6, cy-40, R.x+30, cy-70);
  label(ctx, 'Reflected', R.x+34, cy-84);

  // sag / quadratic phase label
  ctx.fillStyle = getMutedColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
  ctx.fillText('Sag: z≈(x²+y²)/(2R)', R.x+18, R.y+18);
  ctx.fillText('r(x,y)=h0 exp[−j k0 (x²+y²)/R]', R.x+18, R.y+R.h-10);

  ctx.restore();
}

function renderMainPlot(){
  const canvas = document.getElementById('cMain');
  const ctx = mainPlot.ctx;
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);

  const coeffs = gratingCoeffsBinary50();
  const mags = coeffs.map(o=>o.mag);
  const intens = coeffs.map(o=>o.inten);
  const mVals = coeffs.map(o=>o.m);

  // Determine scaling
  const maxMag = Math.max(...mags, 1e-12);
  const maxInt = Math.max(...intens, 1e-12);

  // axes for magnitudes (left)
  const ax = drawAxes(ctx, 10, 10, w-20, h-20, {
    title: 'Main plot — Binary grating order strengths (D=0.5)',
    xLabel: 'Diffraction order m (dimensionless)',
    yLabel: '|T_m| and |T_m|² (dimensionless)',
    xTicks: 6,
    yTicks: 5,
    grid: true
  });

  // mapping
  const xMin = -S.mMax - 0.5;
  const xMax = S.mMax + 0.5;

  function xMap(x){
    return ax.x + ax.w * ((x - xMin)/(xMax - xMin));
  }
  function yMap(y){
    // plot up to 1.05*maxMag (for mag curve), but we also show intensity as dashed scaled to same axis
    const yMax = 1.05*Math.max(maxMag, Math.sqrt(maxInt));
    return ax.y + ax.h * (1 - y / yMax);
  }

  // ticks labels
  ctx.save();
  ctx.fillStyle = getMutedColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');

  for(let i=0;i<=6;i++){
    const xv = xMin + (xMax-xMin)*i/6;
    const x = xMap(xv);
    ctx.fillText(Math.round(xv).toString(), x-6, ax.y+ax.h+18);
  }
  const yMax = 1.05*Math.max(maxMag, Math.sqrt(maxInt));
  for(let j=0;j<=5;j++){
    const yv = yMax * j/5;
    const y = yMap(yv);
    ctx.fillText(yv.toFixed(2), ax.x-44, y+4);
  }
  ctx.restore();

  // bars for |T_m|
  ctx.save();
  const barW = ax.w / (mVals.length) * 0.72;
  ctx.fillStyle = isLight() ? 'rgba(0,0,0,0.60)' : 'rgba(255,255,255,0.65)';
  for(let i=0;i<mVals.length;i++){
    const m = mVals[i];
    const mag = mags[i];
    const x = xMap(m) - barW/2;
    const y = yMap(mag);
    const y0 = yMap(0);
    ctx.fillRect(x, y, barW, y0 - y);
  }

  // overlay intensity curve scaled by sqrt to share axis (visual comparison)
  ctx.strokeStyle = isLight() ? 'rgba(125,211,252,0.95)' : 'rgba(125,211,252,0.95)';
  ctx.lineWidth = 2;
  ctx.setLineDash([6,4]);
  ctx.beginPath();
  for(let i=0;i<mVals.length;i++){
    const m = mVals[i];
    const yv = Math.sqrt(intens[i]); // scale to amplitude-like
    const x = xMap(m);
    const y = yMap(yv);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.setLineDash([]);

  // legend
  const lx = ax.x + ax.w - 220;
  const ly = ax.y + 10;
  ctx.fillStyle = isLight() ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.22)';
  ctx.strokeStyle = isLight() ? 'rgba(0,0,0,0.12)' : 'rgba(255,255,255,0.12)';
  roundRect(ctx, lx, ly, 210, 54, 12, true, true);

  ctx.fillStyle = getTextColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
  ctx.fillText('Bars: |T_m|', lx+12, ly+18);
  ctx.fillText('Dashed: √(|T_m|²) = |T_m|', lx+12, ly+38);

  // annotation with phase step
  const dphi = deltaPhi();
  ctx.fillStyle = getMutedColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--mono');
  const note = `Δφ = k0(n−1)Δd = ${dphi.toFixed(3)} rad`;
  ctx.fillText(note, ax.x+10, ax.y+ax.h-10);

  ctx.restore();
}

function renderSecondaryPlot(){
  const canvas = document.getElementById('cSecondary');
  const ctx = secPlot.ctx;
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  ctx.clearRect(0,0,w,h);

  // Split into two panels: left angles, right quadratic phase
  const pad = 10;
  const gap = 10;
  const W1 = (w - 2*pad - gap)/2;
  const H1 = h - 2*pad;

  // Panel A: angles vs m
  const axA = drawAxes(ctx, pad, pad, W1, H1, {
    title: 'Secondary A — Diffraction angles θm (normal incidence)',
    xLabel: 'Order m',
    yLabel: 'θm (degrees)',
    xTicks: 6,
    yTicks: 5,
    grid: true
  });

  const mVals = [];
  const thDeg = [];
  for(let m=-S.mMax; m<=S.mMax; m++){
    const th = theta_m(m);
    if(th===null) continue; // evanescent
    mVals.push(m);
    thDeg.push(th*180/Math.PI);
  }
  const xMin = -S.mMax;
  const xMax = S.mMax;
  const yMin = Math.min(...thDeg, -1);
  const yMax = Math.max(...thDeg, 1);

  function xMapA(x){ return axA.x + axA.w * ((x - xMin)/(xMax - xMin)); }
  function yMapA(y){ return axA.y + axA.h * (1 - (y - yMin)/(yMax - yMin || 1)); }

  // ticks labels
  ctx.save();
  ctx.fillStyle = getMutedColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
  for(let i=0;i<=6;i++){
    const xv = xMin + (xMax-xMin)*i/6;
    ctx.fillText(Math.round(xv).toString(), xMapA(xv)-6, axA.y+axA.h+18);
  }
  for(let j=0;j<=5;j++){
    const yv = yMin + (yMax-yMin)*j/5;
    ctx.fillText(yv.toFixed(2), axA.x-50, yMapA(yv)+4);
  }
  ctx.restore();

  // plot line
  ctx.save();
  ctx.strokeStyle = isLight() ? 'rgba(0,0,0,0.70)' : 'rgba(255,255,255,0.70)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<mVals.length;i++){
    const x = xMapA(mVals[i]);
    const y = yMapA(thDeg[i]);
    if(i===0) ctx.moveTo(x,y);
    else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // points
  ctx.fillStyle = isLight() ? 'rgba(125,211,252,0.95)' : 'rgba(125,211,252,0.95)';
  for(let i=0;i<mVals.length;i++){
    const x = xMapA(mVals[i]);
    const y = yMapA(thDeg[i]);
    ctx.beginPath(); ctx.arc(x,y,3.2,0,Math.PI*2); ctx.fill();
  }

  // annotation
  ctx.fillStyle = getMutedColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--mono');
  const lam = S.lambda_nm*1e-9, Lam = S.period_um*1e-6;
  ctx.fillText(`λ/Λ = ${(lam/Lam).toExponential(2)} (radians approx)`, axA.x+10, axA.y+axA.h-10);
  ctx.restore();

  // Panel B: quadratic phase vs radius
  const axB = drawAxes(ctx, pad + W1 + gap, pad, W1, H1, {
    title: 'Secondary B — Quadratic phase vs radius (mirror vs lens)',
    xLabel: 'Radius ρ (mm)',
    yLabel: 'Phase φ(ρ) (radians, wrapped)',
    xTicks: 5,
    yTicks: 5,
    grid: true
  });

  const Rm = S.R_cm*1e-2;
  const f = equivF_m();
  const k = k0();

  // sample radius up to 4 mm
  const rhoMax = 4e-3;
  const N = 240;
  const rho = [];
  const phiMirror = [];
  const phiLens = [];
  for(let i=0;i<=N;i++){
    const r = rhoMax * i/N;
    // mirror phase: -k0 * r^2 / R
    const pm = -k * (r*r) / Rm;
    // lens phase: -k0 * r^2 / (2f)
    const pl = -k * (r*r) / (2*f);
    // wrap to [-π,π] for readability
    rho.push(r);
    phiMirror.push(wrapPi(pm));
    phiLens.push(wrapPi(pl));
  }

  const xMinB = 0;
  const xMaxB = rhoMax*1e3; // mm
  const yMinB = -Math.PI;
  const yMaxB = Math.PI;

  function xMapB(xmm){ return axB.x + axB.w * ((xmm - xMinB)/(xMaxB - xMinB || 1)); }
  function yMapB(y){ return axB.y + axB.h * (1 - (y - yMinB)/(yMaxB - yMinB || 1)); }

  // ticks labels
  ctx.save();
  ctx.fillStyle = getMutedColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
  for(let i=0;i<=5;i++){
    const xv = xMinB + (xMaxB-xMinB)*i/5;
    ctx.fillText(xv.toFixed(1), xMapB(xv)-8, axB.y+axB.h+18);
  }
  for(let j=0;j<=5;j++){
    const yv = yMinB + (yMaxB-yMinB)*j/5;
    ctx.fillText(yv.toFixed(2), axB.x-50, yMapB(yv)+4);
  }
  ctx.restore();

  // mirror curve
  ctx.save();
  ctx.strokeStyle = isLight() ? 'rgba(0,0,0,0.70)' : 'rgba(255,255,255,0.70)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<rho.length;i++){
    const x = xMapB(rho[i]*1e3);
    const y = yMapB(phiMirror[i]);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // lens curve
  ctx.strokeStyle = isLight() ? 'rgba(167,139,250,0.95)' : 'rgba(167,139,250,0.95)';
  ctx.lineWidth = 2;
  ctx.setLineDash([6,4]);
  ctx.beginPath();
  for(let i=0;i<rho.length;i++){
    const x = xMapB(rho[i]*1e3);
    const y = yMapB(phiLens[i]);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();
  ctx.setLineDash([]);

  // legend
  const lx = axB.x + axB.w - 185;
  const ly = axB.y + 10;
  ctx.fillStyle = isLight() ? 'rgba(255,255,255,0.85)' : 'rgba(0,0,0,0.22)';
  ctx.strokeStyle = isLight() ? 'rgba(0,0,0,0.12)' : 'rgba(255,255,255,0.12)';
  roundRect(ctx, lx, ly, 175, 56, 12, true, true);

  ctx.fillStyle = getTextColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
  ctx.fillText('Solid: mirror φ=−k0ρ²/R', lx+10, ly+18);
  ctx.fillText('Dashed: lens φ=−k0ρ²/(2f)', lx+10, ly+38);

  // annotate f
  ctx.fillStyle = getMutedColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--mono');
  ctx.fillText(`R=${(Rm*100).toFixed(1)} cm,  f=−R/2=${(f*100).toFixed(2)} cm`, axB.x+10, axB.y+axB.h-10);
  ctx.restore();
}

function wrapPi(x){
  // wrap to [-pi, pi)
  const tw = 2*Math.PI;
  let y = ((x + Math.PI) % tw + tw) % tw - Math.PI;
  return y;
}

function arrow(ctx, x0,y0,x1,y1){
  const dx = x1-x0, dy = y1-y0;
  const L = Math.hypot(dx,dy) || 1;
  const ux = dx/L, uy = dy/L;
  const head = 10;
  ctx.beginPath();
  ctx.moveTo(x0,y0);
  ctx.lineTo(x1,y1);
  ctx.stroke();
  // head
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x1 - head*ux + 0.45*head*(-uy), y1 - head*uy + 0.45*head*(ux));
  ctx.lineTo(x1 - head*ux - 0.45*head*(-uy), y1 - head*uy - 0.45*head*(ux));
  ctx.closePath();
  ctx.fillStyle = ctx.strokeStyle;
  ctx.fill();
}

function label(ctx, text, x, y){
  ctx.save();
  ctx.fillStyle = getMutedColor();
  ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
  ctx.fillText(text, x, y);
  ctx.restore();
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

/* ===========================
   Global render / resize
   =========================== */
function renderAll(){
  renderDiagram();
  renderMainPlot();
  renderSecondaryPlot();
}

function handleResize(){
  diagram.resize();
  mainPlot.resize();
  secPlot.resize();
  renderAll();
}
window.addEventListener('resize', handleResize);

// initial
syncUI();
renderAll();
</script>
</body>
</html>
