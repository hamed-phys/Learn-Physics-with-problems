<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Partially Coherent Gaussian (Gaussian–Schell) Beam in the Fraunhofer Region</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111827;
      --panel2:#0f172a;
      --text:#e5e7eb;
      --muted:#a3a3a3;
      --line:rgba(255,255,255,.12);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 25px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    html{ scroll-behavior:smooth; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% -10%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(1000px 600px at 90% 10%, rgba(167,139,250,.14), transparent 55%),
        radial-gradient(900px 600px at 50% 110%, rgba(52,211,153,.10), transparent 55%),
        var(--bg);
      line-height:1.55;
    }

    header{
      position:relative;
      padding: 48px 18px 22px;
      border-bottom:1px solid var(--line);
      overflow:hidden;
    }
    header .wrap{
      max-width:1200px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:18px;
      align-items:start;
    }
    h1{
      margin:0 0 10px;
      font-size: clamp(1.6rem, 2.6vw, 2.35rem);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: clamp(1rem, 1.35vw, 1.08rem);
    }
    .pillrow{
      margin-top:14px;
      display:flex;
      flex-wrap:wrap;
      gap:10px;
    }
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:7px 10px;
      border-radius:999px;
      font-size:.9rem;
      color: #d1d5db;
      backdrop-filter: blur(8px);
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 18px 18px 70px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      align-items:start;
    }

    /* Sticky mini TOC */
    nav#toc{
      position:sticky;
      top:14px;
      align-self:start;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    #toc .tochead{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    #toc .tochead strong{
      font-size: .95rem;
      letter-spacing:.2px;
      color:#f3f4f6;
    }
    #toc .tochead button{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--text);
      border-radius: 12px;
      padding: 6px 9px;
      cursor:pointer;
      font-size:.85rem;
    }
    #toc .tocbody{
      padding:10px 10px 12px;
    }
    #toc a{
      display:block;
      padding:8px 10px;
      border-radius: 12px;
      color:#dbeafe;
      text-decoration:none;
      font-size:.92rem;
      border:1px solid transparent;
    }
    #toc a:hover{
      background: rgba(125,211,252,.09);
      border-color: rgba(125,211,252,.25);
    }

    article{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    section{
      padding: 18px 18px;
      border-bottom: 1px solid var(--line);
    }
    section:last-child{ border-bottom:none; }
    h2{
      margin: 0 0 10px;
      font-size: clamp(1.18rem, 1.8vw, 1.45rem);
    }
    h3{
      margin: 14px 0 8px;
      font-size: 1.05rem;
      color:#f3f4f6;
    }
    p{ margin: 8px 0; color:#e5e7eb; }
    ul{ margin: 8px 0 0 20px; color:#e5e7eb; }
    li{ margin: 6px 0; }
    .muted{ color: var(--muted); }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
      nav#toc{ position:relative; top:auto; }
      header .wrap{ grid-template-columns: 1fr; }
      .grid2{ grid-template-columns: 1fr; }
    }

    .card{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(15,23,42,.55);
      box-shadow: 0 10px 22px rgba(0,0,0,.20);
    }
    .callout{
      border-left: 4px solid rgba(125,211,252,.8);
      background: rgba(125,211,252,.08);
    }
    .callout.warn{
      border-left-color: rgba(251,191,36,.9);
      background: rgba(251,191,36,.08);
    }
    .callout.good{
      border-left-color: rgba(52,211,153,.9);
      background: rgba(52,211,153,.08);
    }
    .callout.bad{
      border-left-color: rgba(251,113,133,.95);
      background: rgba(251,113,133,.08);
    }
    .eqblock{
      position:relative;
      margin-top:10px;
      padding: 12px 12px 12px;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      font-family: var(--mono);
      color: #eaf2ff;
      overflow:auto;
      white-space: pre;
    }
    .copybtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 6px 9px;
      cursor:pointer;
      font-size:.85rem;
    }
    .copybtn:hover{ background: rgba(255,255,255,.10); }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(255,255,255,.03);
      padding: 10px 10px;
    }
    .kpi .label{
      color: var(--muted);
      font-size:.85rem;
      margin-bottom:4px;
    }
    .kpi .value{
      font-family: var(--mono);
      font-size: .98rem;
    }

    figure{
      margin:0;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(15,23,42,.45);
      overflow:hidden;
    }
    figcaption{
      padding: 10px 12px;
      border-top:1px solid var(--line);
      color: var(--muted);
      font-size: .92rem;
    }
    canvas{
      width:100%;
      height: 330px;
      display:block;
      background: radial-gradient(900px 400px at 50% 10%, rgba(125,211,252,.08), transparent 55%);
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 12px;
    }
    .ctrl{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px 10px;
      background: rgba(255,255,255,.03);
    }
    .ctrl label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:#e5e7eb;
      font-size:.92rem;
      margin-bottom: 6px;
    }
    .ctrl input[type="range"]{ width:100%; }
    .ctrl .small{
      color: var(--muted);
      font-size:.85rem;
      margin-top:4px;
    }

    .fadeIn{
      animation: fadeIn .55s ease both;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }

    footer{
      max-width:1200px;
      margin: 0 auto;
      padding: 18px;
      color: var(--muted);
      font-size: .92rem;
    }

    /* Print-friendly */
    @media print{
      body{ background:#fff; color:#000; }
      header, nav#toc, .controls, .copybtn{ display:none !important; }
      article, section, figure, .card{ box-shadow:none; background:#fff; border-color:#ddd; }
      .eqblock{ background:#f6f6f6; color:#000; }
      canvas{ border:1px solid #ddd; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div>
        <h1>Partially Coherent Gaussian Beam (Gaussian–Schell Model) in the Fraunhofer Region</h1>
        <p class="subtitle">
          How a Gaussian intensity profile and a Gaussian spatial coherence function propagate to the far field —
          and why reduced spatial coherence increases beam divergence.
        </p>
        <div class="pillrow">
          <span class="pill">Optics • Statistical Optics</span>
          <span class="pill">Fraunhofer Diffraction</span>
          <span class="pill">Mutual Intensity / Cross-spectral Density</span>
          <span class="pill">Gaussian–Schell Model</span>
        </div>
      </div>
      <div class="card callout good fadeIn">
        <strong>What you’ll get</strong>
        <p class="muted" style="margin-top:6px">
          A clean derivation showing the far-field intensity stays Gaussian and an explicit
          formula for the propagated 1/e<sup>2</sup> radius <span style="font-family:var(--mono)">W(z)</span>.
        </p>
        <div class="kpi" style="margin-top:10px">
          <div class="box">
            <div class="label">Key result shape</div>
            <div class="value">I<sub>z</sub>(x) ∝ exp[-2x²/W²(z)]</div>
          </div>
          <div class="box">
            <div class="label">Divergence (half-angle)</div>
            <div class="value">θ = W(z)/z</div>
          </div>
        </div>
      </div>
    </div>
  </header>

  <main>
    <nav id="toc" aria-label="Table of contents">
      <div class="tochead">
        <strong>Mini Table of Contents</strong>
        <button id="tocToggle" type="button" aria-label="Toggle TOC">Collapse</button>
      </div>
      <div class="tocbody" id="tocBody">
        <a href="#quick">Quick Summary</a>
        <a href="#part0">PART 0 — Concept Primer</a>
        <a href="#part1">PART 1 — Problem Analysis</a>
        <a href="#part2">PART 2 — Strategy & Tips</a>
        <a href="#part3">PART 3 — Full Solution</a>
        <a href="#part4">PART 4 — Deeper Understanding</a>
        <a href="#part5">PART 5 — Visualization Guide</a>
      </div>
    </nav>

    <article>
      <section id="quick">
        <h2>Quick Summary</h2>
        <ul>
          <li><strong>Problem:</strong> A quasi-monochromatic beam has Gaussian intensity at <span style="font-family:var(--mono)">z=0</span> and Gaussian spatial coherence. Find the far-field intensity and beam width.</li>
          <li><strong>Key physics idea:</strong> In statistical optics, propagation acts on the <em>mutual intensity</em> (cross-spectral density), not directly on intensity.</li>
          <li><strong>Model:</strong> Gaussian–Schell model (GSM): Gaussian intensity × Gaussian degree of coherence.</li>
          <li><strong>Governing propagation (Fraunhofer):</strong> far-field spectral density is a double integral of the source mutual intensity with a Fourier kernel in the separation coordinate.</li>
          <li><strong>Result:</strong> Far-field intensity remains Gaussian:
            <span style="font-family:var(--mono)">I_z(x) ∝ exp[-2x^2 / W^2(z)]</span>.</li>
          <li><strong>Beam width:</strong>
            <span style="font-family:var(--mono)">W(z) = (λ z/π) √( 1/W0^2 + 2/ρc^2 )</span> (1D, Fraunhofer).</li>
          <li><strong>Coherence effect:</strong> Smaller coherence length <span style="font-family:var(--mono)">ρc</span> increases divergence; in the incoherent limit, divergence scales ~ <span style="font-family:var(--mono)">1/ρc</span>.</li>
        </ul>

        <div class="eqblock" id="eqFinalBlock" role="group" aria-label="Final answer equation block">
          <button class="copybtn" data-copy-target="eqFinalText">Copy</button>
          <div id="eqFinalText">Final (Fraunhofer, 1D Gaussian–Schell):
I_z(x) ∝ exp[-2 x^2 / W^2(z)]
W(z) = (λ z/π) * sqrt( 1/W0^2 + 2/ρc^2 )
Divergence half-angle: θ = W(z)/z = (λ/π) * sqrt( 1/W0^2 + 2/ρc^2 )</div>
        </div>
      </section>

      <section id="part0">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <div class="grid2">
          <div class="card fadeIn">
            <h3>Core definitions (symbols & units)</h3>
            <ul>
              <li><strong>Wavelength</strong> <span style="font-family:var(--mono)">λ</span> (m), wavenumber <span style="font-family:var(--mono)">k = 2π/λ</span> (rad/m).</li>
              <li><strong>Transverse coordinate</strong> <span style="font-family:var(--mono)">x</span> (m), propagation distance <span style="font-family:var(--mono)">z</span> (m).</li>
              <li><strong>Intensity</strong> <span style="font-family:var(--mono)">I(x)</span> (W/m²) or arbitrary units here.</li>
              <li><strong>Mutual intensity</strong> (cross-spectral density at one frequency)
                <span style="font-family:var(--mono)">W(x1,x2)</span> (intensity units).</li>
              <li><strong>Complex degree of coherence</strong>
                <span style="font-family:var(--mono)">g(x1,x2) = W(x1,x2)/sqrt[I(x1)I(x2)]</span> (dimensionless).</li>
              <li><strong>Beam radius</strong> <span style="font-family:var(--mono)">W0</span> at <span style="font-family:var(--mono)">z=0</span> defined by
                <span style="font-family:var(--mono)">I(x)=I0 exp(-2x^2/W0^2)</span> (1/e² intensity radius).</li>
              <li><strong>Coherence length</strong> <span style="font-family:var(--mono)">ρc</span> (m) via
                <span style="font-family:var(--mono)">g(x1,x2)=exp[-(x1-x2)^2/ρc^2]</span>.</li>
            </ul>
          </div>

          <div class="card fadeIn">
            <h3>Physical meaning</h3>
            <ul>
              <li><span style="font-family:var(--mono)">W(x1,x2)</span> measures how strongly the field at <span style="font-family:var(--mono)">x1</span> correlates with the field at <span style="font-family:var(--mono)">x2</span> (for a narrowband wave).</li>
              <li><span style="font-family:var(--mono)">ρc</span> sets a transverse separation scale: points farther apart than ~<span style="font-family:var(--mono)">ρc</span> “do not interfere much.”</li>
              <li>Fraunhofer (far-field) patterns are essentially Fourier transforms: small structure in the source (including coherence structure) produces wide angular spread.</li>
            </ul>
            <div class="card callout warn" style="margin-top:10px">
              <strong>Key idea:</strong> For partially coherent light, the far-field intensity is not just
              <em>the square of a Fourier transform of an amplitude</em>. You must propagate the <em>mutual intensity</em>.
            </div>
          </div>
        </div>

        <h3>Key laws/principles & validity</h3>
        <div class="card callout">
          <p style="margin:0"><strong>Fraunhofer propagation of mutual intensity (1D, quasi-monochromatic):</strong></p>
          <div class="eqblock" id="eqPropBlock">
            <button class="copybtn" data-copy-target="eqPropText">Copy</button>
            <div id="eqPropText">Let k = 2π/λ. In the Fraunhofer region,
S_z(x) ∝ ∬ W_0(x1,x2) exp[-i (k x / z) (x1 - x2)] dx1 dx2
where S_z(x) is the spectral density (proportional to intensity) in the plane z.</div>
          </div>
          <p class="muted" style="margin:8px 0 0">
            This uses paraxial approximation and assumes z is large enough that quadratic phase factors reduce to a Fourier kernel in the separation coordinate (x1−x2).
          </p>
        </div>

        <h3>Common models/approximations (and why)</h3>
        <ul>
          <li><strong>Paraxial approximation:</strong> angles are small, so propagation is governed by Fresnel/Fraunhofer diffraction.</li>
          <li><strong>Fraunhofer approximation:</strong> far field where transverse coordinates map to spatial frequencies
            <span style="font-family:var(--mono)">q = kx/z</span>.</li>
          <li><strong>Gaussian–Schell model:</strong> Gaussian intensity envelope + Gaussian coherence function. This is powerful because Gaussians stay Gaussians under Fourier transforms, so the propagated field statistics remain analytically tractable.</li>
        </ul>

        <h3>Mini intuition examples</h3>
        <ul>
          <li><strong>Perfectly coherent limit:</strong> <span style="font-family:var(--mono)">ρc → ∞</span> ⇒ the beam behaves like a coherent Gaussian; far-field divergence is set by the source size <span style="font-family:var(--mono)">W0</span>.</li>
          <li><strong>Very low coherence:</strong> small <span style="font-family:var(--mono)">ρc</span> ⇒ the beam breaks into many small “coherence patches.” Small patches diffract strongly ⇒ larger far-field spread.</li>
        </ul>

        <div class="card callout warn">
          <h3 style="margin-top:0">What to watch for (pitfalls)</h3>
          <ul>
            <li>Confusing the intensity radius <span style="font-family:var(--mono)">W0</span> with a field-amplitude radius. Here <span style="font-family:var(--mono)">I ∝ exp(-2x^2/W0^2)</span>.</li>
            <li>Propagating intensity directly instead of the mutual intensity.</li>
            <li>Dropping factors of 2 in Gaussian exponents (a very common error).</li>
            <li>Forgetting the far-field coordinate mapping: <span style="font-family:var(--mono)">q = kx/z</span>.</li>
          </ul>
        </div>
      </section>

      <section id="part1">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <h3>Restate the problem (in plain words)</h3>
        <p>
          A quasi-monochromatic beam propagates along <span style="font-family:var(--mono)">z</span>.
          In the plane <span style="font-family:var(--mono)">z=0</span> its intensity across <span style="font-family:var(--mono)">x</span> is Gaussian:
          <span style="font-family:var(--mono)">I(x)=I0 exp(-2x^2/W0^2)</span>.
          The (normalized) mutual intensity is also Gaussian:
          <span style="font-family:var(--mono)">g(x1,x2)=exp[-(x1-x2)^2/ρc^2]</span>.
          Show that in the Fraunhofer region the intensity at distance <span style="font-family:var(--mono)">z</span>
          is still Gaussian, and derive the propagated beam width <span style="font-family:var(--mono)">W(z)</span>
          in terms of <span style="font-family:var(--mono)">W0, ρc, λ, z</span>. Then interpret how spatial coherence affects divergence.
        </p>

        <div class="grid2">
          <div class="card">
            <h3>Given</h3>
            <ul>
              <li><span style="font-family:var(--mono)">λ</span>: wavelength (free space)</li>
              <li><span style="font-family:var(--mono)">I(x)=I0 exp(-2x^2/W0^2)</span></li>
              <li><span style="font-family:var(--mono)">g(x1,x2)=exp[-(x1-x2)^2/ρc^2]</span></li>
              <li>Propagation along <span style="font-family:var(--mono)">z</span>, Fraunhofer conditions apply</li>
            </ul>
          </div>
          <div class="card">
            <h3>Unknowns / must show</h3>
            <ul>
              <li>Form of far-field intensity: <span style="font-family:var(--mono)">I_z(x) ∝ exp(-2x^2/W^2(z))</span></li>
              <li>Expression for <span style="font-family:var(--mono)">W(z)</span></li>
              <li>Interpretation: how <span style="font-family:var(--mono)">ρc</span> changes divergence</li>
            </ul>
          </div>
        </div>

        <h3>Relevant physics principles (and why they apply)</h3>
        <ul>
          <li><strong>Statistical optics propagation:</strong> For partially coherent light, second-order statistics (<span style="font-family:var(--mono)">W(x1,x2)</span>) propagate linearly through free space. This directly yields intensity after propagation.</li>
          <li><strong>Fraunhofer diffraction:</strong> In the far field, the propagation kernel becomes a Fourier kernel in the separation coordinate <span style="font-family:var(--mono)">(x1-x2)</span>, making Gaussian integrals tractable.</li>
          <li><strong>Gaussian–Schell model closure:</strong> A GSM beam remains GSM under paraxial propagation; in particular, far-field intensity stays Gaussian.</li>
        </ul>

        <div class="card callout warn">
          <strong>Assumptions (explicit)</strong>
          <ul>
            <li>Quasi-monochromatic (narrowband), stationary statistics.</li>
            <li>Scalar, 1D transverse coordinate <span style="font-family:var(--mono)">x</span> (extensions to 2D are similar).</li>
            <li>Paraxial propagation; Fraunhofer region at the observation plane.</li>
            <li>Free-space propagation; no apertures other than the beam itself.</li>
          </ul>
        </div>

        <h3>Possible approaches (compare)</h3>
        <ol>
          <li><strong>Direct mutual-intensity Fraunhofer integral (best here):</strong> Plug the GSM form into the double integral; Gaussians separate nicely. <span class="muted">Pros: shortest, fully analytic. Cons: requires comfort with change of variables.</span></li>
          <li><strong>Wigner distribution / phase-space method:</strong> Compute the Wigner function at <span style="font-family:var(--mono)">z=0</span> and use free-space shearing; then integrate to get intensity. <span class="muted">Pros: strong intuition. Cons: extra formalism.</span></li>
          <li><strong>Coherent-mode decomposition:</strong> Decompose the GSM beam into coherent Hermite–Gaussian modes, propagate each, then sum intensities. <span class="muted">Pros: connects to modal optics. Cons: heavier machinery.</span></li>
        </ol>
        <p><strong>Chosen approach:</strong> the direct Fraunhofer mutual-intensity integral, because it’s the most transparent and uses only Gaussian integrals.</p>
      </section>

      <section id="part2">
        <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>
        <ol>
          <li>
            <strong>Build the mutual intensity at z=0.</strong>
            <div class="muted">Tool: <span style="font-family:var(--mono)">W0(x1,x2)=√I(x1)√I(x2) g(x1,x2)</span>. Meaning: encodes both envelope and coherence.</div>
          </li>
          <li>
            <strong>Write the Fraunhofer propagation formula for intensity.</strong>
            <div class="muted">Tool: <span style="font-family:var(--mono)">S_z(x) ∝ ∬ W0 exp[-i(kx/z)(x1-x2)] dx1 dx2</span>. Meaning: far-field is a Fourier transform in separation.</div>
          </li>
          <li>
            <strong>Change variables to average and difference coordinates.</strong>
            <div class="muted">Tool: <span style="font-family:var(--mono)">u=(x1+x2)/2, v=x1-x2</span>. Meaning: often separates envelope (u) from coherence (v).</div>
          </li>
          <li>
            <strong>Show the integrand factorizes into a product of two Gaussians.</strong>
            <div class="muted">Meaning: then the double integral becomes two independent 1D Gaussian integrals.</div>
          </li>
          <li>
            <strong>Evaluate the Gaussian integrals.</strong>
            <div class="muted">Tool: <span style="font-family:var(--mono)">∫ exp(-a t^2 - i b t) dt = √(π/a) exp(-b^2/(4a))</span>.</div>
          </li>
          <li>
            <strong>Read off the far-field Gaussian width and express W(z).</strong>
            <div class="muted">Meaning: match the exponent to <span style="font-family:var(--mono)">exp(-2x^2/W^2(z))</span>.</div>
          </li>
          <li>
            <strong>Sanity-check limiting cases and units.</strong>
            <div class="muted">Meaning: verify coherent limit and incoherent limit behave sensibly.</div>
          </li>
          <li>
            <strong>Interpret divergence vs coherence.</strong>
            <div class="muted">Meaning: smaller <span style="font-family:var(--mono)">ρc</span> → larger angular spread.</div>
          </li>
        </ol>

        <div class="card callout warn">
          <strong>Common mistakes & quick tips</strong>
          <ul>
            <li><strong>Tip:</strong> Convert intensity Gaussian to amplitude Gaussian by square root: if <span style="font-family:var(--mono)">I ∝ exp(-2x^2/W0^2)</span> then <span style="font-family:var(--mono)">√I ∝ exp(-x^2/W0^2)</span>.</li>
            <li><strong>Mistake:</strong> Missing a factor of 2 when forming <span style="font-family:var(--mono)">W0(x1,x2)</span>.</li>
            <li><strong>Tip:</strong> In (u,v) variables, the <span style="font-family:var(--mono)">u</span>-dependence often becomes purely the source envelope, while <span style="font-family:var(--mono)">v</span>-dependence controls angular spread.</li>
          </ul>
        </div>
      </section>

      <section id="part3">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Qualitative expectation (before math)</h3>
        <p>
          A narrower transverse feature in the source produces a broader far-field pattern (Fourier duality).
          Partial coherence introduces an additional “narrow feature” in the separation coordinate (through <span style="font-family:var(--mono)">g</span>),
          so we expect <em>more</em> far-field broadening when the coherence length <span style="font-family:var(--mono)">ρc</span> is small.
          Because the source statistics are Gaussian, the far field should remain Gaussian.
        </p>

        <h3>Step 1: Construct the mutual intensity at z=0</h3>
        <p>
          The normalized mutual intensity (degree of coherence) is given, and the intensity is given.
          For quasi-monochromatic light we can write the cross-spectral density (mutual intensity) as:
        </p>

        <div class="eqblock" id="eqW0Block">
          <button class="copybtn" data-copy-target="eqW0Text">Copy</button>
          <div id="eqW0Text">Given I(x)=I0 exp(-2x^2/W0^2).
Then √I(x)=√I0 exp(-x^2/W0^2).

Given g(x1,x2)=exp[-(x1-x2)^2/ρc^2].

So the mutual intensity at z=0 is:
W0(x1,x2) = √I(x1) √I(x2) g(x1,x2)
          = I0 exp[-(x1^2+x2^2)/W0^2] * exp[-(x1-x2)^2/ρc^2].</div>
        </div>

        <p class="muted">
          Interpretation: the first exponential sets the overall beam envelope; the second sets how quickly correlations decay with separation.
        </p>

        <h3>Step 2: Fraunhofer propagation for the spectral density (intensity)</h3>
        <p>
          In the Fraunhofer region, the propagated spectral density (proportional to intensity) at transverse position <span style="font-family:var(--mono)">x</span>
          in the plane <span style="font-family:var(--mono)">z</span> can be written (up to an overall constant scale factor) as:
        </p>

        <div class="eqblock" id="eqFraunBlock">
          <button class="copybtn" data-copy-target="eqFraunText">Copy</button>
          <div id="eqFraunText">Let k = 2π/λ.
Fraunhofer (far-field) propagation of mutual intensity gives:
I_z(x) ∝ S_z(x) ∝ ∬ W0(x1,x2) exp[-i (k x / z) (x1 - x2)] dx1 dx2.</div>
        </div>

        <p class="muted">
          The kernel depends only on the separation <span style="font-family:var(--mono)">(x1-x2)</span>, so a change to average/difference coordinates is ideal.
        </p>

        <h3>Step 3: Change variables to average and difference coordinates</h3>
        <p>
          Define:
          <span style="font-family:var(--mono)">u = (x1+x2)/2</span> (average position) and
          <span style="font-family:var(--mono)">v = x1-x2</span> (separation).
          Then
          <span style="font-family:var(--mono)">x1 = u + v/2</span>, <span style="font-family:var(--mono)">x2 = u - v/2</span>,
          and the Jacobian is <span style="font-family:var(--mono)">dx1 dx2 = du dv</span>.
        </p>

        <p>Compute the quadratic forms that appear in <span style="font-family:var(--mono)">W0</span>:</p>
        <ul>
          <li>
            <span style="font-family:var(--mono)">x1^2 + x2^2 = (u+v/2)^2 + (u-v/2)^2 = 2u^2 + v^2/2</span>
          </li>
          <li>
            <span style="font-family:var(--mono)">(x1-x2)^2 = v^2</span>
          </li>
        </ul>

        <p>So the mutual intensity becomes:</p>
        <div class="eqblock" id="eqUvBlock">
          <button class="copybtn" data-copy-target="eqUvText">Copy</button>
          <div id="eqUvText">W0(u,v) = I0 exp[-(2u^2 + v^2/2)/W0^2] * exp[-v^2/ρc^2]
       = I0 exp[-2u^2/W0^2] * exp[-v^2( 1/(2W0^2) + 1/ρc^2 )].</div>
        </div>

        <p class="muted">
          This is the crucial simplification: the statistics factor into an envelope-only Gaussian in <span style="font-family:var(--mono)">u</span>
          and a coherence-controlled Gaussian in <span style="font-family:var(--mono)">v</span>.
        </p>

        <h3>Step 4: Write the propagated intensity and separate the integrals</h3>
        <p>
          The Fraunhofer kernel becomes <span style="font-family:var(--mono)">exp[-i (k x / z) v]</span>.
          Therefore:
        </p>

        <div class="eqblock" id="eqSepBlock">
          <button class="copybtn" data-copy-target="eqSepText">Copy</button>
          <div id="eqSepText">I_z(x) ∝ ∬ I0 exp[-2u^2/W0^2] exp[-a v^2] exp[-i b v] du dv

where
a = (1/(2W0^2) + 1/ρc^2)   and   b = (k x / z).</div>
        </div>

        <p>
          The integral is a product of two independent Gaussian integrals:
          <span style="font-family:var(--mono)">∫ exp(-2u^2/W0^2) du</span> and
          <span style="font-family:var(--mono)">∫ exp(-a v^2 - i b v) dv</span>.
          Only the <span style="font-family:var(--mono)">v</span>-integral contains <span style="font-family:var(--mono)">x</span>,
          so it determines the functional dependence (shape) of <span style="font-family:var(--mono)">I_z(x)</span>.
        </p>

        <h3>Step 5: Evaluate the Gaussian integrals</h3>
        <p>
          Use the standard result (valid for <span style="font-family:var(--mono)">Re(a)&gt;0</span>):
        </p>

        <div class="eqblock" id="eqGaussianIntBlock">
          <button class="copybtn" data-copy-target="eqGaussianIntText">Copy</button>
          <div id="eqGaussianIntText">∫_{-∞}^{∞} exp(-a v^2 - i b v) dv = sqrt(π/a) * exp( - b^2/(4a) ).</div>
        </div>

        <p>
          Thus, up to multiplicative constants (independent of <span style="font-family:var(--mono)">x</span>),
          the propagated intensity has the form
          <span style="font-family:var(--mono)">I_z(x) ∝ exp( - b^2/(4a) )</span>.
          Substituting <span style="font-family:var(--mono)">b = kx/z</span> gives:
        </p>

        <div class="eqblock" id="eqShapeBlock">
          <button class="copybtn" data-copy-target="eqShapeText">Copy</button>
          <div id="eqShapeText">I_z(x) ∝ exp[ -(k^2 x^2 / z^2) / (4a) ]
with a = (1/(2W0^2) + 1/ρc^2).</div>
        </div>

        <p>
          This is a Gaussian in <span style="font-family:var(--mono)">x</span>, as required.
          Now match it to the requested form:
          <span style="font-family:var(--mono)">I_z(x) ∝ exp[-2x^2/W^2(z)]</span>.
        </p>

        <h3>Step 6: Read off the far-field width W(z)</h3>
        <p>
          Match exponents:
          <span style="font-family:var(--mono)">2/W^2(z) = (k^2/z^2)/(4a)</span>.
          Solve for <span style="font-family:var(--mono)">W^2(z)</span>:
        </p>

        <div class="eqblock" id="eqWzDeriveBlock">
          <button class="copybtn" data-copy-target="eqWzDeriveText">Copy</button>
          <div id="eqWzDeriveText">2/W^2(z) = k^2 / (4 a z^2)
=> W^2(z) = (8 a z^2)/k^2.

With a = (1/(2W0^2) + 1/ρc^2) and k=2π/λ:

W^2(z) = (8 z^2 / (4π^2/λ^2)) * (1/(2W0^2) + 1/ρc^2)
       = (2 λ^2 z^2 / π^2) * (1/(2W0^2) + 1/ρc^2)
       = (λ^2 z^2 / π^2) * (1/W0^2 + 2/ρc^2).

Therefore:
W(z) = (λ z / π) * sqrt( 1/W0^2 + 2/ρc^2 ).</div>
        </div>

        <div class="card callout good">
          <h3 style="margin-top:0">Final Answer (boxed)</h3>
          <p style="margin:6px 0 0">
            In the Fraunhofer region the intensity remains Gaussian:
            <span style="font-family:var(--mono)">I_z(x) ∝ exp[-2x^2/W^2(z)]</span>,
            with
            <span style="font-family:var(--mono)">W(z) = (λ z/π) √(1/W0^2 + 2/ρc^2)</span>.
          </p>
        </div>

        <h3>Sanity checks</h3>
        <div class="grid2">
          <div class="card">
            <h3 style="margin-top:0">1) Units/dimensions</h3>
            <p class="muted">
              Inside the square root: <span style="font-family:var(--mono)">1/W0^2</span> and <span style="font-family:var(--mono)">2/ρc^2</span> are both 1/m².
              Multiply by <span style="font-family:var(--mono)">(λ z/π)</span> (m·m) gives meters. ✔
            </p>
          </div>
          <div class="card">
            <h3 style="margin-top:0">2) Limiting cases</h3>
            <ul>
              <li><strong>Fully coherent:</strong> <span style="font-family:var(--mono)">ρc→∞</span> ⇒
                <span style="font-family:var(--mono)">W(z) = (λ z/π)(1/W0)</span> (standard Gaussian far-field scaling). ✔</li>
              <li><strong>Low coherence:</strong> <span style="font-family:var(--mono)">ρc≪W0</span> ⇒
                <span style="font-family:var(--mono)">W(z) ≈ (λ z/π) √2 / ρc</span> (divergence dominated by coherence patches). ✔</li>
            </ul>
          </div>
        </div>

        <h3>Physical interpretation (coherence and divergence)</h3>
        <p>
          Define the far-field (half) divergence angle using the 1/e<sup>2</sup> radius:
          <span style="font-family:var(--mono)">θ = W(z)/z</span>.
          From the result,
          <span style="font-family:var(--mono)">θ = (λ/π) √(1/W0^2 + 2/ρc^2)</span>.
          This shows divergence arises from <em>two independent “width scales”</em>:
          the finite beam size <span style="font-family:var(--mono)">W0</span> and the finite coherence length <span style="font-family:var(--mono)">ρc</span>.
          Smaller <span style="font-family:var(--mono)">ρc</span> increases the second term and therefore increases divergence.
        </p>

        <p class="muted">
          Connection to the diagram/plots below: as you decrease <span style="font-family:var(--mono)">ρc</span>, the coherence “patches” shrink,
          so their diffraction spreads the far-field Gaussian more strongly; you’ll see <span style="font-family:var(--mono)">W(z)</span> rise and the intensity profile broaden.
        </p>
      </section>

      <section id="part4">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpreting the formula</h3>
        <p>
          The beam width in the Fraunhofer region is linear in <span style="font-family:var(--mono)">z</span> and <span style="font-family:var(--mono)">λ</span>,
          and depends on an <em>effective inverse-squared width</em>:
        </p>
        <div class="eqblock" id="eqInterpretBlock">
          <button class="copybtn" data-copy-target="eqInterpretText">Copy</button>
          <div id="eqInterpretText">Define an effective “far-field-setting” scale:
A_eff = (1/W0^2 + 2/ρc^2).

Then W(z) = (λ z/π) * sqrt(A_eff).

• 1/W0^2 term: diffraction from finite beam envelope (coherent Gaussian result).
• 2/ρc^2 term: extra broadening from finite spatial coherence.</div>
        </div>

        <h3>How parameter changes affect the outcome</h3>
        <ul>
          <li><strong>Increase W0:</strong> decreases <span style="font-family:var(--mono)">1/W0^2</span> ⇒ smaller divergence (tighter far-field).</li>
          <li><strong>Increase ρc:</strong> decreases <span style="font-family:var(--mono)">2/ρc^2</span> ⇒ approach coherent divergence limit.</li>
          <li><strong>Increase λ:</strong> increases diffraction linearly ⇒ larger divergence.</li>
          <li><strong>Increase z:</strong> far-field spot grows linearly with distance, but the angular width <span style="font-family:var(--mono)">θ</span> stays constant.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p class="muted">
          Using the <strong>Wigner distribution</strong> of a GSM beam, free-space propagation corresponds to a shear in phase space.
          The far-field intensity is then the marginal over spatial frequency; the Gaussian form is preserved and yields the same width.
          This approach is especially insightful if you want a “ray + diffraction” intuition for partial coherence.
        </p>

        <h3>Concept checks (self-test)</h3>
        <ul>
          <li><strong>Q:</strong> If the beam is perfectly coherent, does <span style="font-family:var(--mono)">ρc</span> matter? <strong>A:</strong> No; as <span style="font-family:var(--mono)">ρc→∞</span> the coherence term vanishes and you recover the coherent Gaussian divergence.</li>
          <li><strong>Q:</strong> Why does smaller <span style="font-family:var(--mono)">ρc</span> increase divergence? <strong>A:</strong> The field becomes correlated only over smaller patches, and smaller transverse features diffract more strongly (Fourier duality).</li>
          <li><strong>Q:</strong> Why is the far-field still Gaussian? <strong>A:</strong> Because the integrals are Gaussian; GSM beams are closed under paraxial propagation.</li>
          <li><strong>Q:</strong> Does <span style="font-family:var(--mono)">W(z)</span> depend on <span style="font-family:var(--mono)">I0</span>? <strong>A:</strong> No; <span style="font-family:var(--mono)">I0</span> scales amplitude, not width.</li>
        </ul>
      </section>

      <section id="part5">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <div class="grid2">
          <figure class="fadeIn">
            <canvas id="cDiagram" aria-label="Diagram canvas"></canvas>
            <figcaption>
              <strong>Diagram:</strong> Gaussian intensity at <span style="font-family:var(--mono)">z=0</span> with coherence length <span style="font-family:var(--mono)">ρc</span>,
              propagating to a far-field observation plane at distance <span style="font-family:var(--mono)">z</span> where the intensity is Gaussian with radius <span style="font-family:var(--mono)">W(z)</span>.
            </figcaption>
          </figure>

          <figure class="fadeIn">
            <canvas id="cMain" aria-label="Main plot canvas"></canvas>
            <figcaption>
              <strong>Main plot:</strong> Far-field beam radius <span style="font-family:var(--mono)">W(z)</span> versus propagation distance <span style="font-family:var(--mono)">z</span>.
              Two curves are shown: your chosen <span style="font-family:var(--mono)">ρc</span> and the coherent reference (<span style="font-family:var(--mono)">ρc→∞</span>).
            </figcaption>
          </figure>
        </div>

        <figure class="fadeIn" style="margin-top:14px">
          <canvas id="cSecondary" aria-label="Secondary plot canvas"></canvas>
          <figcaption>
            <strong>Secondary plot:</strong> Normalized far-field intensity profile <span style="font-family:var(--mono)">I_z(x)/I_z(0)</span> at a selected distance <span style="font-family:var(--mono)">z</span>.
            You’ll see the Gaussian broaden as <span style="font-family:var(--mono)">ρc</span> decreases.
          </figcaption>
        </figure>

        <div class="controls card" style="margin-top:14px">
          <div>
            <h3 style="margin:0 0 6px">Interactive controls (live)</h3>
            <p class="muted" style="margin:0">
              Change coherence length, source size, wavelength, and the profile plane distance. All canvases update together.
              <br><span style="font-family:var(--mono)">Example values</span> are used for visualization only; the derivation above is fully symbolic.
            </p>
          </div>

          <div class="controls">
            <div class="ctrl">
              <label>
                <span>Coherence length ρc (mm)</span>
                <span class="muted" id="vRho">1.00</span>
              </label>
              <input id="sRho" type="range" min="0.05" max="5" step="0.01" value="1.00"/>
              <div class="small">Smaller ρc → larger divergence (broader far-field).</div>
            </div>

            <div class="ctrl">
              <label>
                <span>Source radius W0 (mm)</span>
                <span class="muted" id="vW0">0.50</span>
              </label>
              <input id="sW0" type="range" min="0.10" max="2.00" step="0.01" value="0.50"/>
              <div class="small">Larger W0 → smaller coherent diffraction term.</div>
            </div>

            <div class="ctrl">
              <label>
                <span>Wavelength λ (nm)</span>
                <span class="muted" id="vLam">633</span>
              </label>
              <input id="sLam" type="range" min="400" max="1600" step="1" value="633"/>
              <div class="small">Longer λ increases diffraction linearly.</div>
            </div>

            <div class="ctrl">
              <label>
                <span>Profile distance z (m)</span>
                <span class="muted" id="vZpick">2.00</span>
              </label>
              <input id="sZpick" type="range" min="0.5" max="10" step="0.05" value="2.00"/>
              <div class="small">Sets which plane is used for the intensity profile plot.</div>
            </div>
          </div>

          <div class="card callout" style="grid-column:1 / -1; margin-top:12px">
            <strong>How to interpret changes</strong>
            <ul>
              <li>When you drag <span style="font-family:var(--mono)">ρc</span> down, the <span style="font-family:var(--mono)">W(z)</span> curve rises above the coherent reference and the intensity profile becomes wider.</li>
              <li>When you drag <span style="font-family:var(--mono)">W0</span> up, the coherent reference narrows (less diffraction from a larger source).</li>
              <li>Changing <span style="font-family:var(--mono)">λ</span> scales all widths proportionally.</li>
            </ul>
          </div>

          <div class="kpi" style="grid-column:1 / -1; margin-top:12px">
            <div class="box">
              <div class="label">Computed divergence θ (mrad)</div>
              <div class="value" id="kTheta">—</div>
            </div>
            <div class="box">
              <div class="label">Computed W(zpick) (mm)</div>
              <div class="value" id="kWz">—</div>
            </div>
          </div>
        </div>

        <div class="eqblock" id="eqPlotBlock">
          <button class="copybtn" data-copy-target="eqPlotText">Copy</button>
          <div id="eqPlotText">Equations used in plots (example parameters):
k = 2π/λ
W(z) = (λ z/π) * sqrt( 1/W0^2 + 2/ρc^2 )
I_z(x)/I_z(0) = exp[ -2 x^2 / W^2(z) ]</div>
        </div>
      </section>
    </article>
  </main>

  <footer>
    <div class="card">
      <strong>Note:</strong> The derivation assumes the Fraunhofer (far-field) regime under paraxial propagation.
      The plotted numbers use example values (visible in the sliders) to illustrate trends; the symbolic result is general.
    </div>
  </footer>

  <script>
    // ---------- Utilities ----------
    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
    function fmt(x, digits=3){
      if(!isFinite(x)) return "—";
      const ax = Math.abs(x);
      if(ax !== 0 && (ax < 1e-3 || ax >= 1e4)) return x.toExponential(2);
      return x.toFixed(digits);
    }

    // Copy buttons
    (function setupCopy(){
      document.querySelectorAll('.copybtn').forEach(btn=>{
        btn.addEventListener('click', async ()=>{
          const id = btn.getAttribute('data-copy-target');
          const el = document.getElementById(id);
          const text = el ? el.textContent : '';
          try{
            await navigator.clipboard.writeText(text.trim());
            const old = btn.textContent;
            btn.textContent = "Copied!";
            setTimeout(()=>btn.textContent = old, 900);
          }catch(e){
            const old = btn.textContent;
            btn.textContent = "Copy failed";
            setTimeout(()=>btn.textContent = old, 900);
          }
        });
      });
    })();

    // TOC collapse
    (function setupTOC(){
      const btn = document.getElementById('tocToggle');
      const body = document.getElementById('tocBody');
      let open = true;
      btn.addEventListener('click', ()=>{
        open = !open;
        body.style.display = open ? 'block' : 'none';
        btn.textContent = open ? 'Collapse' : 'Expand';
      });
    })();

    // ---------- Model ----------
    function W_of_z(z, lambda, W0, rhoc){
      // W(z) = (λ z/π) sqrt( 1/W0^2 + 2/rhoc^2 )
      const A = (1/(W0*W0)) + (2/(rhoc*rhoc));
      return (lambda * z / Math.PI) * Math.sqrt(A);
    }
    function W_coherent(z, lambda, W0){
      // rhoc -> infinity => A = 1/W0^2
      return (lambda * z / Math.PI) * (1/W0);
    }

    // ---------- Canvas helpers ----------
    function setupCanvas(canvas){
      const ctx = canvas.getContext('2d');
      function resize(){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.max(2, Math.floor(rect.width * dpr));
        canvas.height = Math.max(2, Math.floor(rect.height * dpr));
        ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
      }
      resize();
      return {ctx, resize};
    }

    function clear(ctx, w, h){
      ctx.clearRect(0,0,w,h);
    }

    function drawPanelTitle(ctx, title, x, y){
      ctx.save();
      ctx.font = "600 14px " + getComputedStyle(document.body).fontFamily;
      ctx.fillStyle = "rgba(229,231,235,.95)";
      ctx.fillText(title, x, y);
      ctx.restore();
    }

    function plotAxes(ctx, x0, y0, w, h, xLabel, yLabel, xMin, xMax, yMin, yMax){
      // background grid
      ctx.save();
      ctx.lineWidth = 1;

      // grid
      const gridN = 8;
      ctx.strokeStyle = "rgba(255,255,255,.08)";
      for(let i=0;i<=gridN;i++){
        const gx = x0 + (w*i/gridN);
        const gy = y0 + (h*i/gridN);
        ctx.beginPath(); ctx.moveTo(gx, y0); ctx.lineTo(gx, y0+h); ctx.stroke();
        ctx.beginPath(); ctx.moveTo(x0, gy); ctx.lineTo(x0+w, gy); ctx.stroke();
      }

      // axes
      ctx.strokeStyle = "rgba(255,255,255,.35)";
      ctx.beginPath(); ctx.moveTo(x0, y0+h); ctx.lineTo(x0+w, y0+h); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x0, y0); ctx.lineTo(x0, y0+h); ctx.stroke();

      // ticks and labels
      ctx.fillStyle = "rgba(229,231,235,.88)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;

      function niceTick(v){ return Math.abs(v) >= 1e3 || Math.abs(v) < 1e-2 ? v.toExponential(1) : (Math.round(v*1000)/1000).toString(); }

      const tN = 5;
      for(let i=0;i<=tN;i++){
        // x ticks
        const tx = x0 + (w*i/tN);
        const xv = xMin + (xMax-xMin)*i/tN;
        ctx.strokeStyle = "rgba(255,255,255,.25)";
        ctx.beginPath(); ctx.moveTo(tx, y0+h); ctx.lineTo(tx, y0+h+4); ctx.stroke();
        ctx.fillText(niceTick(xv), tx-10, y0+h+18);

        // y ticks
        const ty = y0 + h - (h*i/tN);
        const yv = yMin + (yMax-yMin)*i/tN;
        ctx.beginPath(); ctx.moveTo(x0-4, ty); ctx.lineTo(x0, ty); ctx.stroke();
        ctx.fillText(niceTick(yv), x0-46, ty+4);
      }

      // axis labels
      ctx.font = "600 12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText(xLabel, x0 + w - 10 - ctx.measureText(xLabel).width, y0 + h + 36);

      // rotated y label
      ctx.save();
      ctx.translate(x0 - 54, y0 + 8);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();

      ctx.restore();

      // mapping functions
      function X(x){ return x0 + (x-xMin)/(xMax-xMin)*w; }
      function Y(y){ return y0 + h - (y-yMin)/(yMax-yMin)*h; }
      return {X, Y};
    }

    function drawLine(ctx, pts, strokeStyle="rgba(125,211,252,.95)", lineWidth=2){
      ctx.save();
      ctx.strokeStyle = strokeStyle;
      ctx.lineWidth = lineWidth;
      ctx.beginPath();
      for(let i=0;i<pts.length;i++){
        const p=pts[i];
        if(i===0) ctx.moveTo(p.x, p.y);
        else ctx.lineTo(p.x, p.y);
      }
      ctx.stroke();
      ctx.restore();
    }

    function drawLegend(ctx, items, x, y){
      ctx.save();
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillStyle = "rgba(229,231,235,.9)";
      ctx.strokeStyle = "rgba(255,255,255,.18)";
      const pad = 10;
      const lineH = 18;
      let maxW = 0;
      items.forEach(it=>{
        maxW = Math.max(maxW, ctx.measureText(it.label).width);
      });
      const boxW = pad*2 + 16 + 8 + maxW;
      const boxH = pad*2 + items.length*lineH;
      ctx.fillStyle = "rgba(0,0,0,.30)";
      ctx.fillRect(x, y, boxW, boxH);
      ctx.strokeRect(x, y, boxW, boxH);

      for(let i=0;i<items.length;i++){
        const yy = y + pad + i*lineH + 6;
        ctx.strokeStyle = items[i].color;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(x+pad, yy);
        ctx.lineTo(x+pad+14, yy);
        ctx.stroke();
        ctx.fillStyle = "rgba(229,231,235,.92)";
        ctx.fillText(items[i].label, x+pad+22, yy+4);
      }
      ctx.restore();
    }

    // ---------- Draw: Diagram ----------
    function drawDiagram(canvasState, params){
      const {ctx} = canvasState;
      const W = canvasState.canvasWidthCSS;
      const H = canvasState.canvasHeightCSS;
      clear(ctx, W, H);

      // Layout
      const pad = 16;
      drawPanelTitle(ctx, "Physical setup (1D transverse x, propagation along z)", pad, 20);

      // coordinate frame
      const midY = H*0.56;
      const leftX = pad + 16;
      const rightX = W - pad - 16;

      // z axis line
      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,.25)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(leftX, midY);
      ctx.lineTo(rightX, midY);
      ctx.stroke();

      // Arrow head
      ctx.beginPath();
      ctx.moveTo(rightX, midY);
      ctx.lineTo(rightX-10, midY-6);
      ctx.lineTo(rightX-10, midY+6);
      ctx.closePath();
      ctx.fillStyle = "rgba(255,255,255,.25)";
      ctx.fill();

      // label z
      ctx.fillStyle = "rgba(229,231,235,.9)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText("z", rightX-4, midY-10);

      // Source plane and observation plane
      const srcX = leftX + 28;
      const obsX = rightX - 110;

      ctx.strokeStyle = "rgba(125,211,252,.65)";
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(srcX, pad+40); ctx.lineTo(srcX, H-pad-20); ctx.stroke();
      ctx.fillStyle="rgba(125,211,252,.9)";
      ctx.fillText("z = 0", srcX-14, pad+28);

      ctx.strokeStyle = "rgba(167,139,250,.65)";
      ctx.beginPath(); ctx.moveTo(obsX, pad+40); ctx.lineTo(obsX, H-pad-20); ctx.stroke();
      ctx.fillStyle="rgba(167,139,250,.9)";
      ctx.fillText("z = " + fmt(params.zPick,2) + " m", obsX-30, pad+28);

      // Gaussian profile at source (intensity vs x drawn sideways)
      function drawGaussianAt(xCenter, color, widthPix, labelTop, labelBottom){
        const n=120;
        const amp = 70;
        const sigma = widthPix/2.2;
        ctx.strokeStyle = color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        for(let i=0;i<n;i++){
          const t = (i/(n-1))*2 - 1; // -1..1
          const y = midY + t*amp;
          const g = Math.exp(- (t*amp)*(t*amp)/(2*sigma*sigma));
          const x = xCenter + g*48;
          if(i===0) ctx.moveTo(x, y);
          else ctx.lineTo(x, y);
        }
        ctx.stroke();

        // center line
        ctx.strokeStyle = "rgba(255,255,255,.12)";
        ctx.lineWidth = 1;
        ctx.beginPath(); ctx.moveTo(xCenter, midY-amp); ctx.lineTo(xCenter, midY+amp); ctx.stroke();

        // labels
        ctx.fillStyle = "rgba(229,231,235,.9)";
        ctx.fillText(labelTop, xCenter-12, midY-amp-16);
        ctx.fillStyle = "rgba(229,231,235,.75)";
        ctx.fillText(labelBottom, xCenter-20, midY+amp+18);
      }

      // Convert W0 and W(z) into relative pixel widths for visualization
      const W0mm = params.W0*1e3;
      const Wzmm = params.Wz*1e3;
      const w0Pix = 60 + 50*clamp(W0mm/2.0, 0.05, 2.0);
      const wzPix = 60 + 50*clamp(Wzmm/50.0, 0.05, 2.0);

      drawGaussianAt(srcX, "rgba(125,211,252,.95)", w0Pix, "I(x) at z=0", "Width: W0");
      drawGaussianAt(obsX, "rgba(167,139,250,.95)", wzPix, "I_z(x) in far field", "Width: W(z)");

      // coherence length annotation near source: bracket showing rho_c
      const rhoPix = 20 + 90*clamp((params.rhoC*1e3)/2.5, 0.02, 2.0);
      const yA = midY - rhoPix/2;
      const yB = midY + rhoPix/2;
      ctx.strokeStyle = "rgba(52,211,153,.85)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(srcX-38, yA);
      ctx.lineTo(srcX-38, yB);
      ctx.stroke();
      // small ticks
      ctx.beginPath();
      ctx.moveTo(srcX-44, yA); ctx.lineTo(srcX-32, yA);
      ctx.moveTo(srcX-44, yB); ctx.lineTo(srcX-32, yB);
      ctx.stroke();
      ctx.fillStyle = "rgba(52,211,153,.95)";
      ctx.fillText("ρc", srcX-58, yA-8);
      ctx.fillStyle = "rgba(229,231,235,.78)";
      ctx.fillText("coherence length", srcX-102, yB+18);

      // Fraunhofer note
      ctx.fillStyle = "rgba(229,231,235,.8)";
      ctx.fillText("Fraunhofer region: far-field Fourier mapping q = kx/z", leftX+18, H-pad-6);

      ctx.restore();
    }

    // ---------- Draw: Main Plot W(z) ----------
    function drawMainPlot(canvasState, params){
      const {ctx} = canvasState;
      const W = canvasState.canvasWidthCSS;
      const H = canvasState.canvasHeightCSS;
      clear(ctx, W, H);

      const padL = 62, padR = 16, padT = 26, padB = 52;
      drawPanelTitle(ctx, "Main plot: Far-field radius W(z) vs distance z", 16, 20);

      // Domain
      const zMin = 0.5, zMax = 10.0;
      // Determine y range from curves
      let yMax = 0;
      for(let i=0;i<=200;i++){
        const z = zMin + (zMax-zMin)*i/200;
        const Wz = W_of_z(z, params.lambda, params.W0, params.rhoC);
        const Wc = W_coherent(z, params.lambda, params.W0);
        yMax = Math.max(yMax, Wz, Wc);
      }
      // show in mm for axes
      const yMin = 0;
      const yMaxMM = (yMax*1e3)*1.15;

      const axes = plotAxes(ctx, padL, padT, W-padL-padR, H-padT-padB,
        "z (m)", "W(z) (mm)", zMin, zMax, yMin, yMaxMM);

      // Build points
      const ptsPartial = [];
      const ptsCoherent = [];
      for(let i=0;i<=260;i++){
        const z = zMin + (zMax-zMin)*i/260;
        const wp = W_of_z(z, params.lambda, params.W0, params.rhoC)*1e3;
        const wc = W_coherent(z, params.lambda, params.W0)*1e3;
        ptsPartial.push({x: axes.X(z), y: axes.Y(wp)});
        ptsCoherent.push({x: axes.X(z), y: axes.Y(wc)});
      }

      drawLine(ctx, ptsCoherent, "rgba(229,231,235,.55)", 2);
      drawLine(ctx, ptsPartial, "rgba(125,211,252,.95)", 2.5);

      // vertical marker for selected zPick
      const zx = axes.X(params.zPick);
      ctx.save();
      ctx.strokeStyle = "rgba(251,191,36,.65)";
      ctx.setLineDash([6,6]);
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(zx, padT);
      ctx.lineTo(zx, H-padB);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = "rgba(251,191,36,.95)";
      ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
      ctx.fillText("z = " + fmt(params.zPick,2) + " m", zx+6, padT+14);
      ctx.restore();

      // Legend
      drawLegend(ctx, [
        {label:"coherent (ρc → ∞)", color:"rgba(229,231,235,.55)"},
        {label:"partial coherence (ρc = " + fmt(params.rhoC*1e3,2) + " mm)", color:"rgba(125,211,252,.95)"}
      ], W-260, padT+8);
    }

    // ---------- Draw: Secondary Plot intensity profile ----------
    function drawSecondaryPlot(canvasState, params){
      const {ctx} = canvasState;
      const W = canvasState.canvasWidthCSS;
      const H = canvasState.canvasHeightCSS;
      clear(ctx, W, H);

      const padL = 62, padR = 16, padT = 26, padB = 52;
      drawPanelTitle(ctx, "Secondary plot: Normalized far-field intensity profile at z = " + fmt(params.zPick,2) + " m", 16, 20);

      // Use x axis in mm on screen
      const Wz = params.Wz; // meters
      const Wc = W_coherent(params.zPick, params.lambda, params.W0);

      // choose x-range to show ~±2.8 widths of larger one
      const Wmax = Math.max(Wz, Wc);
      const xMax = 2.8 * Wmax; // meters
      const xMin = -xMax;

      const axes = plotAxes(ctx, padL, padT, W-padL-padR, H-padT-padB,
        "x (mm)", "I_z(x)/I_z(0)", xMin*1e3, xMax*1e3, 0, 1.05);

      // compute profiles
      const ptsPartial = [];
      const ptsCoherent = [];
      for(let i=0;i<=400;i++){
        const x = xMin + (xMax-xMin)*i/400; // meters
        const Ip = Math.exp(-2*x*x/(Wz*Wz));
        const Ic = Math.exp(-2*x*x/(Wc*Wc));
        ptsPartial.push({x: axes.X(x*1e3), y: axes.Y(Ip)});
        ptsCoherent.push({x: axes.X(x*1e3), y: axes.Y(Ic)});
      }

      // Plot coherent reference (gray) and partial (cyan)
      drawLine(ctx, ptsCoherent, "rgba(229,231,235,.55)", 2);
      drawLine(ctx, ptsPartial, "rgba(167,139,250,.95)", 2.5);

      // Legend
      drawLegend(ctx, [
        {label:"coherent reference", color:"rgba(229,231,235,.55)"},
        {label:"partial coherence", color:"rgba(167,139,250,.95)"}
      ], W-210, padT+8);

      // annotate widths at 1/e^2 points (x = ±W)
      function markWidth(Wm, color, label){
        const xw = Wm*1e3;
        ctx.save();
        ctx.strokeStyle = color;
        ctx.setLineDash([5,5]);
        ctx.lineWidth = 1.8;
        ctx.beginPath();
        ctx.moveTo(axes.X(-xw), padT);
        ctx.lineTo(axes.X(-xw), H-padB);
        ctx.moveTo(axes.X(xw), padT);
        ctx.lineTo(axes.X(xw), H-padB);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = color;
        ctx.font = "12px " + getComputedStyle(document.body).fontFamily;
        ctx.fillText(label + " ±W", axes.X(xw)+6, H-padB-8);
        ctx.restore();
      }
      markWidth(Wc, "rgba(229,231,235,.55)", "coh");
      markWidth(Wz, "rgba(167,139,250,.85)", "part");
    }

    // ---------- Responsive + draw orchestration ----------
    const cDiagram = document.getElementById('cDiagram');
    const cMain = document.getElementById('cMain');
    const cSecondary = document.getElementById('cSecondary');

    const stDiagram = setupCanvas(cDiagram);
    const stMain = setupCanvas(cMain);
    const stSecondary = setupCanvas(cSecondary);

    // store CSS sizes (for clearRect in CSS pixels)
    function refreshCanvasCSSSizes(){
      [stDiagram, stMain, stSecondary].forEach(st=>{
        const rect = st.ctx.canvas.getBoundingClientRect();
        st.canvasWidthCSS = rect.width;
        st.canvasHeightCSS = rect.height;
      });
    }

    // Controls
    const sRho = document.getElementById('sRho');
    const sW0  = document.getElementById('sW0');
    const sLam = document.getElementById('sLam');
    const sZpick = document.getElementById('sZpick');

    const vRho = document.getElementById('vRho');
    const vW0  = document.getElementById('vW0');
    const vLam = document.getElementById('vLam');
    const vZpick = document.getElementById('vZpick');

    const kTheta = document.getElementById('kTheta');
    const kWz = document.getElementById('kWz');

    function getParams(){
      const rhoC_mm = parseFloat(sRho.value);
      const W0_mm = parseFloat(sW0.value);
      const lam_nm = parseFloat(sLam.value);
      const zPick_m = parseFloat(sZpick.value);

      const rhoC = rhoC_mm * 1e-3;  // m
      const W0 = W0_mm * 1e-3;      // m
      const lambda = lam_nm * 1e-9; // m

      const Wz = W_of_z(zPick_m, lambda, W0, rhoC);

      return {rhoC, W0, lambda, zPick: zPick_m, Wz};
    }

    function updateReadouts(params){
      vRho.textContent = fmt(params.rhoC*1e3, 2);
      vW0.textContent  = fmt(params.W0*1e3, 2);
      vLam.textContent = Math.round(params.lambda*1e9).toString();
      vZpick.textContent = fmt(params.zPick, 2);

      const theta = (params.Wz/params.zPick); // radians (1/e^2 half-angle)
      kTheta.textContent = fmt(theta*1e3, 3) + " mrad";
      kWz.textContent = fmt(params.Wz*1e3, 3) + " mm";
    }

    function redraw(){
      const p = getParams();
      updateReadouts(p);

      // Attach lambda, etc. with names used by drawing functions
      const params = {
        rhoC: p.rhoC,
        W0: p.W0,
        lambda: p.lambda,
        zPick: p.zPick,
        Wz: p.Wz
      };

      refreshCanvasCSSSizes();

      drawDiagram({ctx: stDiagram.ctx, canvasWidthCSS: stDiagram.canvasWidthCSS, canvasHeightCSS: stDiagram.canvasHeightCSS}, params);
      drawMainPlot({ctx: stMain.ctx, canvasWidthCSS: stMain.canvasWidthCSS, canvasHeightCSS: stMain.canvasHeightCSS}, params);
      drawSecondaryPlot({ctx: stSecondary.ctx, canvasWidthCSS: stSecondary.canvasWidthCSS, canvasHeightCSS: stSecondary.canvasHeightCSS}, params);
    }

    // Hook events
    [sRho, sW0, sLam, sZpick].forEach(el=>{
      el.addEventListener('input', redraw);
    });

    // Resize handling (crisp DPI)
    function onResize(){
      stDiagram.resize();
      stMain.resize();
      stSecondary.resize();
      redraw();
    }
    window.addEventListener('resize', onResize);

    // Initial draw
    onResize();
  </script>
</body>
</html>
