<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Condition for Raman–Nath Diffraction: Maximum Acoustic Beam Width</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#e9eefc;
      --muted:#b8c3e6;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(167,139,250,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(125,211,252,.14), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(52,211,153,.10), transparent 55%),
        var(--bg);
      line-height:1.55;
    }

    header{
      padding: clamp(18px, 3vw, 34px);
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(17,26,51,.85), rgba(17,26,51,.35));
      backdrop-filter: blur(10px);
      position:sticky;
      top:0;
      z-index:10;
    }
    header .wrap{
      max-width:1200px;
      margin:0 auto;
      display:flex;
      gap:18px;
      align-items:flex-start;
      justify-content:space-between;
    }
    h1{
      margin:0;
      font-size: clamp(20px, 2.4vw, 34px);
      letter-spacing:.2px;
    }
    .subtitle{
      margin-top:6px;
      color:var(--muted);
      max-width:70ch;
      font-size: clamp(13px, 1.2vw, 15px);
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: clamp(16px, 2.6vw, 28px);
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 18px;
      align-items:start;
    }

    nav#toc{
      position:sticky;
      top:92px;
      align-self:start;
      background: rgba(17,26,51,.55);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px 10px;
      backdrop-filter: blur(10px);
    }
    nav#toc h2{
      margin:0 0 10px 0;
      font-size:14px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:var(--muted);
    }
    nav#toc a{
      display:block;
      padding:8px 10px;
      margin:4px 0;
      border-radius:12px;
      color:var(--text);
      text-decoration:none;
      border:1px solid transparent;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-size:14px;
    }
    nav#toc a:hover{
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.25);
      transform: translateY(-1px);
    }

    article{
      background: rgba(17,26,51,.45);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
      backdrop-filter: blur(10px);
    }

    section{
      padding: clamp(16px, 2.2vw, 26px);
      border-top:1px solid var(--line);
    }
    section:first-child{border-top:none}

    h2{
      margin:0 0 10px 0;
      font-size: clamp(18px, 1.8vw, 24px);
    }
    h3{
      margin:18px 0 8px 0;
      font-size: clamp(16px, 1.5vw, 20px);
      color: #f1f5ff;
    }
    p{margin:10px 0; color: var(--text)}
    .muted{color:var(--muted)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
      nav#toc{position:relative; top:auto}
      .grid2,.grid3{grid-template-columns:1fr}
    }

    .card{
      background: rgba(15,23,48,.65);
      border:1px solid var(--line);
      border-radius: 14px;
      padding:14px;
    }
    .callout{
      border-left: 4px solid var(--accent);
      background: rgba(125,211,252,.08);
    }
    .callout.warn{
      border-left-color: var(--warn);
      background: rgba(251,191,36,.08);
    }
    .callout.good{
      border-left-color: var(--good);
      background: rgba(52,211,153,.08);
    }
    .callout.bad{
      border-left-color: var(--bad);
      background: rgba(251,113,133,.08);
    }

    ul{margin:10px 0 0 18px}
    li{margin:6px 0; color:var(--text)}
    .label{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:12px;
      border:1px solid var(--line);
      color:var(--muted);
      margin-left:8px;
      vertical-align:middle;
    }

    .eqbox{
      display:flex;
      gap:10px;
      align-items:stretch;
      justify-content:space-between;
      padding:12px;
      border-radius:14px;
      border:1px solid rgba(167,139,250,.25);
      background: rgba(167,139,250,.08);
      overflow:auto;
    }
    .eq{
      font-family: var(--mono);
      font-size: 14px;
      white-space: pre-wrap;
      line-height:1.45;
      color:#f6f3ff;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-size: 13px;
      white-space:nowrap;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.10);
      border-color: rgba(125,211,252,.25);
    }
    .btn:active{transform: translateY(0px)}
    .btn.small{padding:6px 8px; font-size:12px}

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 720px){
      .controls{grid-template-columns:1fr}
    }
    .control{
      padding:12px;
      border-radius:14px;
      border:1px solid var(--line);
      background: rgba(15,23,48,.55);
    }
    .control label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      color:var(--muted);
      margin-bottom:8px;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    .readout{
      font-family: var(--mono);
      color: var(--text);
      font-size: 13px;
    }

    figure{
      margin:0;
      padding:0;
    }
    .canvasWrap{
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(10,16,34,.55);
      overflow:hidden;
      box-shadow: inset 0 0 0 1px rgba(255,255,255,.03);
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
    }
    .canvasTitle{
      padding:10px 12px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      background: rgba(17,26,51,.55);
    }
    .canvasTitle strong{font-size:13px; color:var(--muted); letter-spacing:.3px; text-transform:uppercase}
    .pill{
      font-family: var(--mono);
      font-size:12px;
      padding:4px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background: rgba(255,255,255,.05);
      white-space:nowrap;
    }

    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 18px 28px 30px;
      color: var(--muted);
      font-size: 13px;
    }

    @media print{
      header, nav#toc, .btn, .controls {display:none !important}
      body{background:#fff; color:#000}
      article, section, .card, .canvasWrap{box-shadow:none !important; background:#fff !important; border-color:#ddd !important}
      .eqbox{background:#f6f6ff !important; border-color:#ddd !important}
      .muted{color:#333}
      canvas{height:260px}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div>
        <h1>Condition for Raman–Nath Diffraction: Maximum Acoustic Beam Width</h1>
        <div class="subtitle">
          We derive the <em>thin-grating</em> (Raman–Nath) condition for acousto‑optic diffraction and obtain an expression for the maximum acoustic beam width <span class="eq">D<sub>s</sub></span> that still permits Raman–Nath diffraction for light of wavelength <span class="eq">&lambda;</span> interacting with an acoustic wave of wavelength <span class="eq">&Lambda;</span>.
        </div>
      </div>
      <button class="btn" id="copyFinalTop" title="Copy final result (plain text)">Copy final result</button>
    </div>
  </header>

  <main>
    <nav id="toc" aria-label="Table of contents">
      <h2>Table of contents</h2>
      <a href="#quick-summary">Quick Summary</a>
      <a href="#part0">PART 0 — Concept Primer</a>
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a href="#part2">PART 2 — Strategy &amp; Tips</a>
      <a href="#part3">PART 3 — Full Solution</a>
      <a href="#part4">PART 4 — Deeper Understanding</a>
      <a href="#part5">PART 5 — Visualization Guide</a>
    </nav>

    <article>
      <section id="quick-summary">
        <h2>Quick Summary</h2>
        <ul>
          <li><strong>What this is about:</strong> Light diffracting from a sound wave (acousto‑optic grating) in the <em>Raman–Nath</em> (thin grating) regime.</li>
          <li><strong>Key physics idea:</strong> If the interaction region is thin enough, the grating does not enforce strict Bragg selectivity—multiple diffraction orders can appear.</li>
          <li><strong>Core parameter:</strong> The Klein–Cook (or “thickness”) parameter <span class="eq">Q</span> measures whether the grating is thin or thick.</li>
          <li><strong>Governing relationship:</strong> <span class="eq">Q = (2&pi; &lambda; D<sub>s</sub>)/&Lambda;<sup>2</sup></span> (using the optical wavelength in the medium).</li>
          <li><strong>Raman–Nath condition:</strong> <span class="eq">Q &ll; 1</span> (often “<span class="eq">Q &lt; 1</span>” as a practical boundary).</li>
          <li><strong>Final result type:</strong> Symbolic expression for the maximum acoustic beam width <span class="eq">D<sub>s,max</sub></span>.</li>
          <li><strong>Final result:</strong> <span class="eq">D<sub>s,max</sub> &approx; &Lambda;<sup>2</sup>/(2&pi;&lambda;)</span> (or <span class="eq">D<sub>s,max</sub> &sim; &Lambda;<sup>2</sup>/&lambda;</span> as an order‑of‑magnitude rule).</li>
        </ul>

        <div class="card callout good" style="margin-top:14px;">
          <p style="margin:0;"><strong>Big picture:</strong> Raman–Nath diffraction is “thin grating” diffraction. The acoustic beam must be thin enough that the light doesn’t have room to build up Bragg‑matched energy transfer into only one order.</p>
        </div>
      </section>

      <section id="part0">
        <h2>PART 0 — Concept Primer (theory before solving)</h2>

        <div class="grid2">
          <div class="card">
            <h3>Core definitions</h3>
            <ul>
              <li><strong>Optical wavelength:</strong> <span class="eq">&lambda;</span> (units: m). In acousto‑optics, the relevant wavelength is typically the wavelength <em>inside the medium</em>.</li>
              <li><strong>Acoustic wavelength:</strong> <span class="eq">&Lambda;</span> (units: m). This sets the grating period of the refractive‑index modulation.</li>
              <li><strong>Acoustic beam width:</strong> <span class="eq">D<sub>s</sub></span> (units: m). This is the thickness/interaction length along the optical propagation direction through the sound field.</li>
              <li><strong>Diffraction angle:</strong> <span class="eq">&theta;</span> (radians). For small angles, first orders satisfy roughly <span class="eq">&theta; &approx; &lambda;/&Lambda;</span>.</li>
            </ul>
          </div>

          <div class="card">
            <h3>Physical meaning</h3>
            <p>
              The sound wave creates a moving (or standing) periodic index pattern—an optical phase grating.
              If the grating is <em>thin</em>, the light picks up a phase modulation and then diffracts into many orders (Raman–Nath).
              If the grating is <em>thick</em>, only the Bragg‑matched order efficiently grows (Bragg regime).
            </p>
            <p class="muted">
              Think “thin grating” = like a surface grating; “thick grating” = like a volume hologram with strong angular selectivity.
            </p>
          </div>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card callout">
            <h3>Key law/principle and validity</h3>
            <p>
              The regime is controlled by the <strong>Klein–Cook parameter</strong> <span class="eq">Q</span>, which compares the interaction length to the “Talbot-like” diffraction length set by the grating period:
            </p>
            <div class="eqbox" role="group" aria-label="Key equation: Klein–Cook parameter">
              <div class="eq" id="eqQ">Q = (2π · λ · D_s) / Λ^2</div>
              <button class="btn small" data-copy="#eqQ">Copy</button>
            </div>
            <p class="muted" style="margin-top:10px;">
              <strong>Raman–Nath:</strong> <span class="eq">Q ≪ 1</span> (thin grating). <strong>Bragg:</strong> <span class="eq">Q ≫ 1</span> (thick grating).
            </p>
          </div>

          <div class="card">
            <h3>Common models/approximations</h3>
            <ul>
              <li><strong>Small-angle diffraction:</strong> when <span class="eq">&lambda; ≪ &Lambda;</span>, the diffracted angles are small and <span class="eq">sin(&theta;/2) ≈ &theta;/2</span>.</li>
              <li><strong>Thin phase grating model:</strong> the sound field mainly imprints a phase modulation; diffraction happens after the interaction region.</li>
              <li><strong>Neglect of strong coupling details:</strong> the Raman–Nath/Bragg boundary is largely geometric (thickness/selectivity), not requiring the acoustic amplitude.</li>
            </ul>
          </div>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card">
            <h3>Mini intuition examples</h3>
            <ul>
              <li><strong>If you double the acoustic period:</strong> <span class="eq">&Lambda;</span> increases, the grating is “coarser,” and it becomes easier to stay in Raman–Nath because <span class="eq">Q ∝ 1/&Lambda;<sup>2</sup></span>.</li>
              <li><strong>If you use shorter-wavelength light:</strong> smaller <span class="eq">&lambda;</span> reduces <span class="eq">Q</span>, again favoring Raman–Nath for the same <span class="eq">D<sub>s</sub></span>.</li>
            </ul>
          </div>

          <div class="card callout warn">
            <h3>What to watch for (pitfalls)</h3>
            <ul>
              <li><strong>Which wavelength?</strong> Using vacuum <span class="eq">&lambda;<sub>0</sub></span> vs in‑medium <span class="eq">&lambda; = &lambda;<sub>0</sub>/n</span> changes the numeric value of <span class="eq">D<sub>s,max</sub></span> by a factor <span class="eq">n</span>.</li>
              <li><strong>Thickness meaning:</strong> <span class="eq">D<sub>s</sub></span> is the interaction length along the optical path through the acoustic beam, not the lateral beam diameter.</li>
              <li><strong>Boundary is not razor-sharp:</strong> “<span class="eq">Q &lt; 1</span>” is a practical criterion; “<span class="eq">Q ≪ 1</span>” is the clean theoretical limit.</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="part1">
        <h2>PART 1 — Problem Analysis (no solving yet)</h2>

        <div class="card">
          <h3>Restating the problem</h3>
          <p>
            We have an acoustic beam (a sound wave) of wavelength <span class="eq">&Lambda;</span> forming a periodic refractive‑index grating.
            Light of wavelength <span class="eq">&lambda;</span> passes through an acoustic region of width <span class="eq">D<sub>s</sub></span>.
            We must derive an expression for the <strong>maximum</strong> <span class="eq">D<sub>s</sub></span> such that the diffraction remains in the <strong>Raman–Nath</strong> (thin grating) regime.
          </p>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card">
            <h3>Given quantities</h3>
            <ul>
              <li><strong>Acoustic wavelength:</strong> <span class="eq">&Lambda;</span></li>
              <li><strong>Optical wavelength:</strong> <span class="eq">&lambda;</span></li>
            </ul>
            <h3>Unknown</h3>
            <ul>
              <li><strong>Maximum acoustic beam width:</strong> <span class="eq">D<sub>s,max</sub></span></li>
            </ul>
          </div>

          <div class="card">
            <h3>Relevant principles and why</h3>
            <ul>
              <li><strong>Thin vs thick grating criterion:</strong> Raman–Nath requires the grating to be thin enough that Bragg selectivity does not dominate—captured by <span class="eq">Q</span>.</li>
              <li><strong>Why not full coupled-wave Bragg theory?</strong> The question asks for a <em>geometric/kinematic</em> condition on width, not diffraction efficiency vs acoustic power.</li>
              <li><strong>Why not just use the diffraction angle?</strong> The angle tells where orders go, but the regime boundary depends on whether the interaction length is long enough to enforce phase matching (selectivity), which is a thickness effect.</li>
            </ul>
          </div>
        </div>

        <div class="card callout" style="margin-top:14px;">
          <h3>Assumptions (explicit)</h3>
          <ul>
            <li><strong>Weak-to-moderate index modulation:</strong> regime classification by thickness is meaningful (not dominated by extreme nonlinear coupling).</li>
            <li><strong>Paraxial/small angles:</strong> typical acousto‑optic case <span class="eq">&lambda; ≪ &Lambda;</span>, so diffracted angles are small.</li>
            <li><strong>Uniform interaction length:</strong> treat the acoustic beam as a slab of thickness <span class="eq">D<sub>s</sub></span> along the optical path.</li>
            <li><strong>Use in-medium optical wavelength:</strong> <span class="eq">&lambda;</span> is taken as the wavelength in the interaction medium (if not, replace <span class="eq">&lambda;</span> by <span class="eq">&lambda;<sub>0</sub>/n</span>).</li>
          </ul>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Possible approaches (compare)</h3>
          <ul>
            <li><strong>Klein–Cook parameter approach:</strong> Use <span class="eq">Q</span> and set <span class="eq">Q &lt; 1</span> for Raman–Nath. <span class="label">Best for this question</span></li>
            <li><strong>Phase-mismatch accumulation approach:</strong> Estimate how much longitudinal phase mismatch builds over <span class="eq">D<sub>s</sub></span>; require it to be small so Bragg selectivity doesn’t develop.</li>
            <li><strong>Diffraction-length (Fresnel) argument:</strong> Compare <span class="eq">D<sub>s</sub></span> to the characteristic diffraction length associated with grating period <span class="eq">&Lambda;</span>.</li>
          </ul>
          <p class="muted">
            We’ll choose the Klein–Cook parameter route because it is compact, standard, and directly yields <span class="eq">D<sub>s,max</sub></span> in terms of <span class="eq">&lambda;</span> and <span class="eq">&Lambda;</span>.
          </p>
        </div>
      </section>

      <section id="part2">
        <h2>PART 2 — Strategy &amp; Tips (roadmap only)</h2>

        <div class="card">
          <ol style="margin:10px 0 0 18px;">
            <li><strong>Define geometry:</strong> Identify <span class="eq">D<sub>s</sub></span> as the interaction length along optical propagation.</li>
            <li><strong>Recall diffraction angle scale:</strong> Use small-angle grating relation to connect to the physical picture (orders at <span class="eq">&theta; ~ &lambda;/&Lambda;</span>).</li>
            <li><strong>Introduce thickness parameter:</strong> Write the Klein–Cook parameter <span class="eq">Q</span> that compares thickness to the grating’s characteristic diffraction length.</li>
            <li><strong>State regime criterion:</strong> Raman–Nath requires <span class="eq">Q ≪ 1</span> (or practically <span class="eq">Q &lt; 1</span>).</li>
            <li><strong>Solve for maximum thickness:</strong> Set <span class="eq">Q = 1</span> as the boundary and isolate <span class="eq">D<sub>s,max</sub></span>.</li>
            <li><strong>Sanity checks:</strong> Verify units, and test limits (larger <span class="eq">&Lambda;</span> allows larger <span class="eq">D<sub>s</sub></span>, etc.).</li>
          </ol>
        </div>

        <div class="card callout warn" style="margin-top:14px;">
          <h3>Common mistakes and quick tips</h3>
          <ul>
            <li><strong>Mixing wavelengths:</strong> If you only know vacuum wavelength <span class="eq">&lambda;<sub>0</sub></span>, convert via <span class="eq">&lambda; = &lambda;<sub>0</sub>/n</span>.</li>
            <li><strong>Forgetting the “thin” meaning:</strong> Raman–Nath is about <em>interaction length</em>, not about acoustic power.</li>
            <li><strong>Dropping the 2&pi;:</strong> The clean boundary from <span class="eq">Q</span> includes <span class="eq">2&pi;</span>; if you want an order-of-magnitude rule, you can state <span class="eq">D<sub>s</sub> &ll; &Lambda;<sup>2</sup>/&lambda;</span>.</li>
          </ul>
        </div>
      </section>

      <section id="part3">
        <h2>PART 3 — Full Solution (detailed + teaching)</h2>

        <div class="card">
          <h3>Qualitative expectation (before math)</h3>
          <p>
            If the acoustic beam is very thin, the light experiences a brief periodic phase modulation and then diffracts into multiple orders—classic Raman–Nath behavior.
            As the beam gets thicker, the interaction becomes “volume-like”: only the order that satisfies Bragg phase matching efficiently builds up, and the system transitions toward Bragg diffraction.
            So we expect a maximum thickness scaling like <span class="eq">D<sub>s,max</sub> ∝ &Lambda;<sup>2</sup>/&lambda;</span>: larger acoustic period makes it easier to remain thin; shorter optical wavelength also helps.
          </p>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card">
            <h3>Step 1: Define symbols clearly</h3>
            <ul>
              <li><strong><span class="eq">&lambda;</span>:</strong> optical wavelength in the interaction medium (m).</li>
              <li><strong><span class="eq">&Lambda;</span>:</strong> acoustic wavelength (grating period) (m).</li>
              <li><strong><span class="eq">D<sub>s</sub></span>:</strong> acoustic beam width along the optical propagation direction (interaction length) (m).</li>
              <li><strong><span class="eq">Q</span>:</strong> Klein–Cook thickness parameter (dimensionless).</li>
            </ul>
          </div>

          <div class="card">
            <h3>Step 2: Connect to the diffraction picture</h3>
            <p>
              A periodic grating of period <span class="eq">&Lambda;</span> produces diffracted orders at angles set by the grating equation.
              For small angles (typical in acousto‑optics), the first-order deflection scale is
              <span class="eq">&theta; &sim; &lambda;/&Lambda;</span>.
              This tells us the orders separate in angle, but the <em>regime</em> depends on whether the interaction length is long enough to enforce phase matching.
            </p>
          </div>
        </div>

        <div class="card callout" style="margin-top:14px;">
          <h3>Step 3: Introduce the governing regime parameter</h3>
          <p>
            The standard way to distinguish Raman–Nath (thin) from Bragg (thick) acousto‑optic diffraction is the <strong>Klein–Cook parameter</strong>:
          </p>
          <div class="eqbox" role="group" aria-label="Klein–Cook parameter equation">
            <div class="eq" id="eqQ2">Q = (2π · λ · D_s) / Λ^2</div>
            <button class="btn small" data-copy="#eqQ2">Copy</button>
          </div>
          <p class="muted" style="margin-top:10px;">
            Physically, <span class="eq">Q</span> compares the interaction length <span class="eq">D<sub>s</sub></span> to a characteristic “diffraction/phase-matching” length set by <span class="eq">&Lambda;<sup>2</sup>/&lambda;</span>.
          </p>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card">
            <h3>Step 4: State the Raman–Nath condition</h3>
            <p>
              Raman–Nath diffraction requires the grating to be thin enough that Bragg selectivity does not develop.
              In terms of <span class="eq">Q</span>:
            </p>
            <div class="eqbox" role="group" aria-label="Raman–Nath condition">
              <div class="eq" id="eqRN">Raman–Nath regime: Q ≪ 1  (practically, Q &lt; 1)</div>
              <button class="btn small" data-copy="#eqRN">Copy</button>
            </div>
            <p class="muted" style="margin-top:10px;">
              The boundary <span class="eq">Q = 1</span> is commonly used to estimate the maximum thickness that still behaves “thin.”
            </p>
          </div>

          <div class="card">
            <h3>Step 5: Solve for the maximum width</h3>
            <p>
              Set the boundary condition <span class="eq">Q = 1</span> and solve for <span class="eq">D<sub>s</sub></span>:
            </p>
            <div class="eqbox" role="group" aria-label="Derivation for Ds max">
              <div class="eq" id="eqDerive">
1 = (2π · λ · D_s,max) / Λ^2
⇒ D_s,max = Λ^2 / (2π · λ)
              </div>
              <button class="btn small" data-copy="#eqDerive">Copy</button>
            </div>
          </div>
        </div>

        <div class="card callout good" style="margin-top:14px;">
          <h3>Final result (boxed)</h3>
          <div class="eqbox" role="group" aria-label="Final answer">
            <div class="eq" id="eqFinal">D_s,max ≈ Λ^2 / (2π · λ)   (Raman–Nath boundary Q = 1)</div>
            <button class="btn small" data-copy="#eqFinal">Copy</button>
          </div>
          <p class="muted" style="margin-top:10px;">
            If you want the strict “thin” requirement, state it as <span class="eq">D<sub>s</sub> ≪ &Lambda;<sup>2</sup>/(2&pi;&lambda;)</span> (or order-of-magnitude <span class="eq">D<sub>s</sub> ≪ &Lambda;<sup>2</sup>/&lambda;</span>).
          </p>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card">
            <h3>Sanity checks</h3>
            <ul>
              <li><strong>Units:</strong> <span class="eq">&Lambda;<sup>2</sup>/&lambda;</span> has units of m, so <span class="eq">D<sub>s,max</sub></span> is a length—correct.</li>
              <li><strong>Limiting behavior:</strong> Larger <span class="eq">&Lambda;</span> increases <span class="eq">D<sub>s,max</sub></span> quadratically—coarser grating stays “thin” more easily.</li>
              <li><strong>Shorter light wavelength:</strong> Smaller <span class="eq">&lambda;</span> increases <span class="eq">D<sub>s,max</sub></span>—shorter wavelength tolerates thicker interaction before becoming Bragg-like.</li>
            </ul>
          </div>

          <div class="card">
            <h3>Physical interpretation in plain language</h3>
            <p>
              The acoustic beam must be thin compared with a characteristic length scale <span class="eq">&Lambda;<sup>2</sup>/&lambda;</span>.
              If the beam is thicker than that, the light has enough distance to “feel” the volume nature of the grating, and Bragg phase matching starts to dominate—suppressing multiple orders.
            </p>
            <p class="muted">
              The diagram and plots below show how increasing <span class="eq">D<sub>s</sub></span> increases <span class="eq">Q</span> and pushes the system from Raman–Nath toward Bragg.
            </p>
          </div>
        </div>
      </section>

      <section id="part4">
        <h2>PART 4 — Deeper Understanding (theory around the result)</h2>

        <div class="grid2">
          <div class="card">
            <h3>Re-interpreting the formula</h3>
            <p>
              The result
              <span class="eq">D<sub>s,max</sub> ≈ &Lambda;<sup>2</sup>/(2&pi;&lambda;)</span>
              says the “thinness” threshold is set by the ratio of a <em>grating scale squared</em> to the optical wavelength.
            </p>
            <ul>
              <li><strong><span class="eq">&Lambda;</span> term:</strong> doubling <span class="eq">&Lambda;</span> makes <span class="eq">D<sub>s,max</sub></span> four times larger.</li>
              <li><strong><span class="eq">&lambda;</span> term:</strong> using shorter-wavelength light increases the allowable thickness linearly.</li>
              <li><strong><span class="eq">2&pi;</span> factor:</strong> reflects that the boundary is about accumulating order‑unity phase over the interaction length.</li>
            </ul>
          </div>

          <div class="card">
            <h3>How parameters affect the outcome (connect to plots)</h3>
            <p>
              In the interactive plots, you’ll see:
            </p>
            <ul>
              <li><strong>Increasing <span class="eq">D<sub>s</sub></span>:</strong> increases <span class="eq">Q</span> linearly, pushing toward Bragg.</li>
              <li><strong>Increasing <span class="eq">&Lambda;</span>:</strong> decreases <span class="eq">Q</span> as <span class="eq">1/&Lambda;<sup>2</sup></span>, strongly favoring Raman–Nath.</li>
              <li><strong>Changing <span class="eq">&lambda;</span>:</strong> changes both <span class="eq">Q</span> and the diffraction angles <span class="eq">&theta;<sub>m</sub> ≈ m&lambda;/&Lambda;</span>.</li>
            </ul>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Alternative derivation idea (brief)</h3>
          <p>
            You can also derive the same scaling by estimating the longitudinal phase mismatch between incident and diffracted waves and requiring that the mismatch does not accumulate significantly over <span class="eq">D<sub>s</sub></span>.
            That “small accumulated mismatch” criterion leads to the same thickness scale <span class="eq">D<sub>s</sub> ∼ &Lambda;<sup>2</sup>/&lambda;</span>, with the more precise boundary captured by the <span class="eq">2&pi;</span> in <span class="eq">Q</span>.
          </p>
        </div>

        <div class="card callout" style="margin-top:14px;">
          <h3>Concept check (quick self-test)</h3>
          <ul>
            <li><strong>Q:</strong> If <span class="eq">&Lambda;</span> doubles, what happens to <span class="eq">Q</span> (for fixed <span class="eq">D<sub>s</sub>, &lambda;</span>)? <br><span class="muted"><strong>A:</strong> It drops by a factor of 4 because <span class="eq">Q ∝ 1/&Lambda;<sup>2</sup></span>.</span></li>
            <li><strong>Q:</strong> Why can Raman–Nath show multiple diffraction orders? <br><span class="muted"><strong>A:</strong> The interaction is too short to enforce Bragg selectivity, so the phase grating produces a multi-order spectrum.</span></li>
            <li><strong>Q:</strong> What does <span class="eq">Q ≫ 1</span> imply? <br><span class="muted"><strong>A:</strong> Thick grating (Bragg regime): strong angular selectivity and typically one dominant diffracted order.</span></li>
            <li><strong>Q:</strong> If you only know vacuum wavelength <span class="eq">&lambda;<sub>0</sub></span>, how do you adapt the formula? <br><span class="muted"><strong>A:</strong> Use <span class="eq">&lambda; = &lambda;<sub>0</sub>/n</span> in <span class="eq">D<sub>s,max</sub> = &Lambda;<sup>2</sup>/(2&pi;&lambda;)</span>, giving <span class="eq">D<sub>s,max</sub> = n&Lambda;<sup>2</sup>/(2&pi;&lambda;<sub>0</sub>)</span>.</span></li>
          </ul>
        </div>
      </section>

      <section id="part5">
        <h2>PART 5 — Visualization Guide (how to read the plots)</h2>

        <div class="card">
          <h3>Interactive controls</h3>
          <p>
            Use the sliders to change the parameters:
            <span class="eq">D<sub>s</sub></span> (acoustic beam width), <span class="eq">&Lambda;</span> (acoustic wavelength), and <span class="eq">&lambda;</span> (optical wavelength in the medium).
            All canvases update live:
            the setup diagram, the <span class="eq">Q</span> plot, and the diffraction-angle plot.
          </p>
        </div>

        <div class="controls" aria-label="Interactive controls">
          <div class="control">
            <label for="Ds">
              <span>Acoustic beam width <span class="eq">D<sub>s</sub></span> (mm)</span>
              <span class="readout" id="DsReadout">2.00</span>
            </label>
            <input id="Ds" type="range" min="0.1" max="20" step="0.1" value="2.0" />
            <div class="muted" style="font-size:12px; margin-top:6px;">This is the interaction length along the optical path.</div>
          </div>

          <div class="control">
            <label for="Lambda">
              <span>Acoustic wavelength <span class="eq">&Lambda;</span> (&micro;m)</span>
              <span class="readout" id="LambdaReadout">50.0</span>
            </label>
            <input id="Lambda" type="range" min="5" max="200" step="1" value="50" />
            <div class="muted" style="font-size:12px; margin-top:6px;">Grating period set by the sound wave.</div>
          </div>

          <div class="control">
            <label for="lambda">
              <span>Optical wavelength <span class="eq">&lambda;</span> (nm)</span>
              <span class="readout" id="lambdaReadout">532</span>
            </label>
            <input id="lambda" type="range" min="400" max="1550" step="1" value="532" />
            <div class="muted" style="font-size:12px; margin-top:6px;">Example values for plotting; the final result remains symbolic.</div>
          </div>

          <div class="control">
            <label>
              <span>Regime indicator</span>
              <span class="readout" id="regimeReadout">—</span>
            </label>
            <button class="btn" id="resetBtn" type="button">Reset to example values</button>
            <div class="muted" style="font-size:12px; margin-top:8px;">
              Boundary uses <span class="eq">Q = 1</span>. Raman–Nath is best when <span class="eq">Q ≪ 1</span>.
            </div>
          </div>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <figure class="canvasWrap">
            <div class="canvasTitle">
              <strong>Diagram: light through acoustic grating</strong>
              <span class="pill" id="pillDiagram">updates with D<sub>s</sub>, &Lambda;, &lambda;</span>
            </div>
            <canvas id="diagramCanvas" aria-label="Setup diagram canvas"></canvas>
          </figure>

          <figure class="canvasWrap">
            <div class="canvasTitle">
              <strong>Main plot: Klein–Cook parameter Q vs D<sub>s</sub></strong>
              <span class="pill" id="pillQ">Q = —</span>
            </div>
            <canvas id="qCanvas" aria-label="Q plot canvas"></canvas>
          </figure>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <figure class="canvasWrap">
            <div class="canvasTitle">
              <strong>Secondary plot: diffraction angles &theta;<sub>m</sub> vs order m</strong>
              <span class="pill" id="pillTheta">small-angle: &theta;<sub>m</sub> ≈ m&lambda;/&Lambda;</span>
            </div>
            <canvas id="thetaCanvas" aria-label="Diffraction angle plot canvas"></canvas>
          </figure>

          <div class="card">
            <h3>What each canvas shows</h3>
            <ul>
              <li><strong>Diagram:</strong> A slab of thickness <span class="eq">D<sub>s</sub></span> containing a periodic index pattern of period <span class="eq">&Lambda;</span>, with diffracted orders leaving at angles <span class="eq">&theta;<sub>m</sub></span>.</li>
              <li><strong>Main plot:</strong> <span class="eq">Q(D<sub>s</sub>)</span> with a horizontal line at <span class="eq">Q = 1</span> marking the thin/thick boundary.</li>
              <li><strong>Secondary plot:</strong> The small-angle prediction <span class="eq">&theta;<sub>m</sub> ≈ m&lambda;/&Lambda;</span> (in radians) for several diffraction orders.</li>
            </ul>
            <div class="card callout warn" style="margin-top:12px;">
              <p style="margin:0;">
                <strong>Reading tip:</strong> You can have small diffraction angles and still be in the Bragg regime if <span class="eq">D<sub>s</sub></span> is large enough—angle and regime are related but not the same thing.
              </p>
            </div>
          </div>
        </div>
      </section>
    </article>
  </main>

  <footer>
    <div>
      <strong>Final result (plain text):</strong>
      <span class="eq" id="finalPlain">D_s,max ≈ Λ^2 / (2π · λ)  (Raman–Nath boundary Q = 1; use λ in the medium)</span>
    </div>
    <div style="margin-top:8px;">
      Built as a self-contained learning article with interactive canvases (no external libraries).
    </div>
  </footer>

  <script>
    // ---------- Clipboard helpers ----------
    function copyText(text){
      if (navigator.clipboard && navigator.clipboard.writeText){
        return navigator.clipboard.writeText(text);
      }
      // Fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      ta.style.position = 'fixed';
      ta.style.left = '-9999px';
      document.body.appendChild(ta);
      ta.select();
      try { document.execCommand('copy'); } catch(e){}
      document.body.removeChild(ta);
      return Promise.resolve();
    }

    document.querySelectorAll('[data-copy]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const sel = btn.getAttribute('data-copy');
        const el = document.querySelector(sel);
        if(!el) return;
        await copyText(el.textContent.trim());
        const old = btn.textContent;
        btn.textContent = 'Copied';
        setTimeout(()=>btn.textContent = old, 900);
      });
    });

    document.getElementById('copyFinalTop').addEventListener('click', async ()=>{
      const t = document.getElementById('finalPlain').textContent.trim();
      await copyText(t);
      const b = document.getElementById('copyFinalTop');
      const old = b.textContent;
      b.textContent = 'Copied';
      setTimeout(()=>b.textContent = old, 900);
    });

    // ---------- State ----------
    const state = {
      Ds_mm: 2.0,      // mm
      Lambda_um: 50.0, // µm
      lambda_nm: 532,  // nm
      // derived in SI
      get Ds(){ return this.Ds_mm * 1e-3; },
      get Lambda(){ return this.Lambda_um * 1e-6; },
      get lambda(){ return this.lambda_nm * 1e-9; },
      get Q(){ return (2*Math.PI * this.lambda * this.Ds) / (this.Lambda*this.Lambda); },
      get DsMax(){ return (this.Lambda*this.Lambda) / (2*Math.PI*this.lambda); } // meters
    };

    // ---------- Controls ----------
    const DsEl = document.getElementById('Ds');
    const LambdaEl = document.getElementById('Lambda');
    const lambdaEl = document.getElementById('lambda');

    const DsReadout = document.getElementById('DsReadout');
    const LambdaReadout = document.getElementById('LambdaReadout');
    const lambdaReadout = document.getElementById('lambdaReadout');
    const regimeReadout = document.getElementById('regimeReadout');
    const pillQ = document.getElementById('pillQ');

    function updateReadouts(){
      DsReadout.textContent = (+state.Ds_mm).toFixed(2);
      LambdaReadout.textContent = (+state.Lambda_um).toFixed(1);
      lambdaReadout.textContent = String(state.lambda_nm);

      const Q = state.Q;
      pillQ.textContent = `Q = ${Q.toFixed(3)}`;

      let regime = '';
      let color = '';
      if (Q < 0.3){ regime = 'Raman–Nath (comfortably thin)'; color = 'var(--good)'; }
      else if (Q < 1.0){ regime = 'Raman–Nath (near boundary)'; color = 'var(--warn)'; }
      else { regime = 'Bragg-like (thick grating)'; color = 'var(--bad)'; }
      regimeReadout.textContent = regime;
      regimeReadout.style.color = color;
    }

    function bindControls(){
      DsEl.addEventListener('input', ()=>{
        state.Ds_mm = parseFloat(DsEl.value);
        updateAll();
      });
      LambdaEl.addEventListener('input', ()=>{
        state.Lambda_um = parseFloat(LambdaEl.value);
        updateAll();
      });
      lambdaEl.addEventListener('input', ()=>{
        state.lambda_nm = parseInt(lambdaEl.value, 10);
        updateAll();
      });

      document.getElementById('resetBtn').addEventListener('click', ()=>{
        state.Ds_mm = 2.0;
        state.Lambda_um = 50.0;
        state.lambda_nm = 532;
        DsEl.value = state.Ds_mm;
        LambdaEl.value = state.Lambda_um;
        lambdaEl.value = state.lambda_nm;
        updateAll();
      });
    }

    // ---------- Canvas utilities ----------
    function setupCanvas(canvas){
      const ctx = canvas.getContext('2d');
      function resize(){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        const w = Math.max(320, rect.width);
        const h = rect.height || 320;
        canvas.width = Math.floor(w * dpr);
        canvas.height = Math.floor(h * dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0);
        return {w, h, dpr};
      }
      return {ctx, resize};
    }

    function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
      const {x, y, w, h, padL, padR, padT, padB} = box;
      const plotX = x + padL, plotY = y + padT;
      const plotW = w - padL - padR, plotH = h - padT - padB;

      // background
      ctx.save();
      ctx.fillStyle = 'rgba(255,255,255,0.02)';
      ctx.fillRect(x, y, w, h);

      // title
      ctx.fillStyle = 'rgba(233,238,252,0.92)';
      ctx.font = '600 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(title, x + 10, y + 18);

      // grid
      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.lineWidth = 1;

      const nGrid = 6;
      for(let i=0;i<=nGrid;i++){
        const gx = plotX + (i/nGrid)*plotW;
        ctx.beginPath(); ctx.moveTo(gx, plotY); ctx.lineTo(gx, plotY+plotH); ctx.stroke();
        const gy = plotY + (i/nGrid)*plotH;
        ctx.beginPath(); ctx.moveTo(plotX, gy); ctx.lineTo(plotX+plotW, gy); ctx.stroke();
      }

      // axes
      ctx.strokeStyle = 'rgba(255,255,255,0.35)';
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(plotX, plotY+plotH);
      ctx.lineTo(plotX+plotW, plotY+plotH);
      ctx.moveTo(plotX, plotY);
      ctx.lineTo(plotX, plotY+plotH);
      ctx.stroke();

      // ticks + labels
      ctx.fillStyle = 'rgba(184,195,230,0.95)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

      function fmt(v){
        const av = Math.abs(v);
        if (av >= 1000) return v.toFixed(0);
        if (av >= 10) return v.toFixed(1);
        if (av >= 1) return v.toFixed(2);
        return v.toFixed(3);
      }

      for(let i=0;i<=nGrid;i++){
        const t = i/nGrid;
        const xv = xMin + t*(xMax-xMin);
        const gx = plotX + t*plotW;
        ctx.strokeStyle = 'rgba(255,255,255,0.25)';
        ctx.beginPath(); ctx.moveTo(gx, plotY+plotH); ctx.lineTo(gx, plotY+plotH+6); ctx.stroke();
        ctx.fillText(fmt(xv), gx-12, plotY+plotH+18);

        const yv = yMax - t*(yMax-yMin);
        const gy = plotY + t*plotH;
        ctx.beginPath(); ctx.moveTo(plotX-6, gy); ctx.lineTo(plotX, gy); ctx.stroke();
        ctx.fillText(fmt(yv), plotX-52, gy+4);
      }

      // axis labels
      ctx.fillStyle = 'rgba(233,238,252,0.9)';
      ctx.font = '600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(xLabel, plotX + plotW - ctx.measureText(xLabel).width, y + h - 8);

      ctx.save();
      ctx.translate(x + 12, plotY + 10);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();

      ctx.restore();

      return {
        plotX, plotY, plotW, plotH,
        xToPx: (xv)=> plotX + (xv-xMin)/(xMax-xMin)*plotW,
        yToPx: (yv)=> plotY + (yMax-yv)/(yMax-yMin)*plotH
      };
    }

    // ---------- Diagram canvas ----------
    const diagram = setupCanvas(document.getElementById('diagramCanvas'));
    function drawDiagram(){
      const {ctx, resize} = diagram;
      const {w, h} = resize();
      ctx.clearRect(0,0,w,h);

      // Layout
      const margin = 18;
      const slabX = w*0.42;
      const slabW = w*0.18;
      const slabY = h*0.18;
      const slabH = h*0.64;

      // Background subtle
      ctx.fillStyle = 'rgba(255,255,255,0.02)';
      ctx.fillRect(0,0,w,h);

      // Incident beam arrow
      ctx.strokeStyle = 'rgba(125,211,252,0.9)';
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(margin, h/2);
      ctx.lineTo(slabX-10, h/2);
      ctx.stroke();
      drawArrowHead(ctx, slabX-10, h/2, 0, 'rgba(125,211,252,0.9)');

      // Slab (acoustic region)
      ctx.fillStyle = 'rgba(167,139,250,0.10)';
      ctx.strokeStyle = 'rgba(167,139,250,0.55)';
      ctx.lineWidth = 2;
      roundRect(ctx, slabX, slabY, slabW, slabH, 14);
      ctx.fill();
      ctx.stroke();

      // Acoustic grating lines inside slab (period Λ)
      const Lambda = state.Lambda; // m
      const Ds = state.Ds; // m
      // Map Λ to a visual spacing: choose scale so that 10–20 periods visible at typical values
      const periodsTarget = 10;
      const spacing = Math.max(6, Math.min(22, slabH / periodsTarget));
      ctx.strokeStyle = 'rgba(233,238,252,0.18)';
      ctx.lineWidth = 1;
      for(let y=slabY+10; y<slabY+slabH-10; y+=spacing){
        ctx.beginPath();
        ctx.moveTo(slabX+10, y);
        ctx.lineTo(slabX+slabW-10, y);
        ctx.stroke();
      }

      // Diffracted orders (m = -2..2)
      const theta1 = state.lambda / state.Lambda; // rad small-angle
      const orders = [-2,-1,0,1,2];
      const originX = slabX + slabW + 10;
      const originY = h/2;

      orders.forEach(m=>{
        const th = m*theta1;
        const len = w*0.35;
        const x2 = originX + len*Math.cos(th);
        const y2 = originY + len*Math.sin(th);
        const alpha = (m===0) ? 0.85 : 0.55;
        ctx.strokeStyle = `rgba(125,211,252,${alpha})`;
        ctx.lineWidth = (m===0) ? 2.8 : 2.0;
        ctx.beginPath();
        ctx.moveTo(originX, originY);
        ctx.lineTo(x2, y2);
        ctx.stroke();
        drawArrowHead(ctx, x2, y2, th, `rgba(125,211,252,${alpha})`);

        // label
        ctx.fillStyle = 'rgba(233,238,252,0.9)';
        ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
        const label = `m=${m}`;
        ctx.fillText(label, x2 - 18, y2 + (m>=0 ? -6 : 14));
      });

      // Thickness label Ds
      ctx.strokeStyle = 'rgba(52,211,153,0.85)';
      ctx.lineWidth = 2;
      const xDim = slabX + slabW + 22;
      ctx.beginPath();
      ctx.moveTo(xDim, slabY);
      ctx.lineTo(xDim, slabY+slabH);
      ctx.stroke();
      drawTick(ctx, xDim, slabY, -8, 0, 'rgba(52,211,153,0.85)');
      drawTick(ctx, xDim, slabY+slabH, -8, 0, 'rgba(52,211,153,0.85)');

      ctx.fillStyle = 'rgba(52,211,153,0.95)';
      ctx.font = '600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(`D_s = ${state.Ds_mm.toFixed(2)} mm`, xDim + 8, slabY + slabH/2);

      // Λ label (visual)
      ctx.fillStyle = 'rgba(184,195,230,0.95)';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(`Λ = ${state.Lambda_um.toFixed(1)} µm`, slabX + 10, slabY - 10);
      ctx.fillText(`λ = ${state.lambda_nm} nm`, margin, h/2 - 14);

      // Regime badge
      const Q = state.Q;
      let badge = '', col = '';
      if (Q < 0.3){ badge='Raman–Nath'; col='rgba(52,211,153,0.95)'; }
      else if (Q < 1.0){ badge='Near boundary'; col='rgba(251,191,36,0.95)'; }
      else { badge='Bragg-like'; col='rgba(251,113,133,0.95)'; }

      ctx.fillStyle = 'rgba(17,26,51,0.75)';
      roundRect(ctx, w-170, 14, 156, 44, 12);
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.12)';
      ctx.stroke();

      ctx.fillStyle = col;
      ctx.font = '700 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(badge, w-160, 34);
      ctx.fillStyle = 'rgba(233,238,252,0.9)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(`Q=${Q.toFixed(3)}`, w-160, 52);
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }
    function drawArrowHead(ctx, x, y, angle, color){
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(angle);
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.lineTo(-10, -5);
      ctx.lineTo(-10, 5);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }
    function drawTick(ctx, x, y, dx, dy, color){
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x+dx, y+dy);
      ctx.stroke();
    }

    // ---------- Q plot canvas ----------
    const qPlot = setupCanvas(document.getElementById('qCanvas'));
    function drawQPlot(){
      const {ctx, resize} = qPlot;
      const {w, h} = resize();
      ctx.clearRect(0,0,w,h);

      // Choose x-range in mm around slider range
      const xMin = 0;
      const xMax = 20; // mm
      // y-range: show up to maybe 3
      const yMin = 0;
      const yMax = 3;

      const box = {x:0,y:0,w,h,padL:64,padR:18,padT:34,padB:44};
      const ax = drawAxes(ctx, box, xMin, xMax, yMin, yMax, 'D_s (mm)', 'Q (dimensionless)', 'Klein–Cook parameter');

      // Plot Q(Ds) line: Q = a * Ds, with Ds in meters
      const a = (2*Math.PI * state.lambda) / (state.Lambda*state.Lambda); // per meter
      ctx.strokeStyle = 'rgba(125,211,252,0.95)';
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      for(let i=0;i<=200;i++){
        const Ds_mm = xMin + (i/200)*(xMax-xMin);
        const Ds_m = Ds_mm*1e-3;
        const Q = a*Ds_m;
        const px = ax.xToPx(Ds_mm);
        const py = ax.yToPx(Math.min(Q, yMax));
        if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      }
      ctx.stroke();

      // Boundary line Q=1
      ctx.strokeStyle = 'rgba(251,191,36,0.85)';
      ctx.setLineDash([6,6]);
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(ax.plotX, ax.yToPx(1));
      ctx.lineTo(ax.plotX+ax.plotW, ax.yToPx(1));
      ctx.stroke();
      ctx.setLineDash([]);

      // Marker at current Ds
      const Qcur = state.Q;
      const px = ax.xToPx(state.Ds_mm);
      const py = ax.yToPx(Math.min(Qcur, yMax));
      ctx.fillStyle = (Qcur<1) ? 'rgba(52,211,153,0.95)' : 'rgba(251,113,133,0.95)';
      ctx.beginPath();
      ctx.arc(px, py, 5.5, 0, Math.PI*2);
      ctx.fill();

      // Legend
      ctx.fillStyle = 'rgba(233,238,252,0.9)';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText('Q(D_s)', ax.plotX+10, ax.plotY+18);
      ctx.fillStyle = 'rgba(251,191,36,0.9)';
      ctx.fillText('Q = 1 boundary', ax.plotX+10, ax.plotY+36);

      // Ds_max annotation
      const DsMax_mm = state.DsMax * 1e3;
      const xAnn = Math.min(Math.max(DsMax_mm, xMin), xMax);
      const pxAnn = ax.xToPx(xAnn);
      ctx.strokeStyle = 'rgba(167,139,250,0.85)';
      ctx.setLineDash([4,6]);
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(pxAnn, ax.plotY);
      ctx.lineTo(pxAnn, ax.plotY+ax.plotH);
      ctx.stroke();
      ctx.setLineDash([]);

      ctx.fillStyle = 'rgba(167,139,250,0.95)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(`D_s,max ≈ ${DsMax_mm.toFixed(2)} mm`, Math.min(pxAnn+8, ax.plotX+ax.plotW-160), ax.plotY+ax.plotH-10);
    }

    // ---------- Theta plot canvas ----------
    const thetaPlot = setupCanvas(document.getElementById('thetaCanvas'));
    function drawThetaPlot(){
      const {ctx, resize} = thetaPlot;
      const {w, h} = resize();
      ctx.clearRect(0,0,w,h);

      // Orders
      const mMin = -5, mMax = 5;
      const theta1 = state.lambda / state.Lambda; // rad
      const thetaMax = Math.max(0.02, Math.min(0.35, Math.abs(mMax*theta1)*1.2)); // rad

      const box = {x:0,y:0,w,h,padL:64,padR:18,padT:34,padB:44};
      const ax = drawAxes(ctx, box, mMin, mMax, -thetaMax, thetaMax, 'order m (dimensionless)', 'θ_m (rad)', 'Small-angle diffraction angles');

      // Plot points θ_m = m θ1
      ctx.strokeStyle = 'rgba(125,211,252,0.35)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(ax.xToPx(mMin), ax.yToPx(mMin*theta1));
      ctx.lineTo(ax.xToPx(mMax), ax.yToPx(mMax*theta1));
      ctx.stroke();

      // Points
      for(let m=mMin; m<=mMax; m++){
        const th = m*theta1;
        const px = ax.xToPx(m);
        const py = ax.yToPx(th);
        const isZero = (m===0);
        ctx.fillStyle = isZero ? 'rgba(167,139,250,0.95)' : 'rgba(125,211,252,0.95)';
        ctx.beginPath();
        ctx.arc(px, py, isZero ? 5.5 : 4.5, 0, Math.PI*2);
        ctx.fill();
      }

      // Legend + annotation
      ctx.fillStyle = 'rgba(233,238,252,0.9)';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText('θ_m ≈ m·λ/Λ', ax.plotX+10, ax.plotY+18);

      ctx.fillStyle = 'rgba(184,195,230,0.95)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
      ctx.fillText(`θ_1 ≈ ${(theta1).toExponential(2)} rad`, ax.plotX+10, ax.plotY+36);
      ctx.fillText(`≈ ${(theta1*180/Math.PI).toFixed(3)}°`, ax.plotX+10, ax.plotY+52);
    }

    // ---------- Update all ----------
    function updateAll(){
      updateReadouts();
      drawDiagram();
      drawQPlot();
      drawThetaPlot();
    }

    // ---------- Resize handling ----------
    let resizeTimer = null;
    window.addEventListener('resize', ()=>{
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(updateAll, 80);
    });

    // ---------- Init ----------
    bindControls();
    updateAll();
  </script>
</body>
</html>
