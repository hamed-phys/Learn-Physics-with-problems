<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Bragg Diffraction as Scattering: Intensity Reflectance at Bragg Condition</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#111a33;
      --card2:#0f1730;
      --text:#e9eefc;
      --muted:#b9c4e6;
      --accent:#7aa2ff;
      --accent2:#7dffcf;
      --warn:#ffcf7d;
      --danger:#ff7d9a;
      --grid:#2a3a6a;
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --serif: ui-serif, Georgia, Cambria, "Times New Roman", Times, serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 20% 10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 700px at 80% 20%, rgba(125,255,207,.12), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(255,207,125,.10), transparent 55%),
        linear-gradient(180deg, #070a14, var(--bg));
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding: clamp(18px, 3vw, 34px);
      border-bottom:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    header .kicker{
      color:var(--muted);
      letter-spacing:.08em;
      text-transform:uppercase;
      font-size:.82rem;
    }
    header h1{
      margin:.35rem 0 .6rem;
      font-size: clamp(1.6rem, 3.2vw, 2.6rem);
      line-height:1.15;
    }
    header p{
      margin:0;
      max-width: 80ch;
      color:var(--muted);
    }

    main{
      display:grid;
      grid-template-columns: 320px minmax(0, 1fr);
      gap: 18px;
      padding: 18px;
      max-width: 1200px;
      margin: 0 auto;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
    }

    nav#toc{
      position: sticky;
      top: 12px;
      align-self:start;
      background: rgba(17,26,51,.72);
      backdrop-filter: blur(10px);
      border:1px solid var(--border);
      border-radius: 14px;
      box-shadow: var(--shadow);
      padding: 14px 14px 10px;
      max-height: calc(100vh - 24px);
      overflow:auto;
    }
    nav#toc h2{
      margin:0 0 10px;
      font-size:1rem;
      color: var(--text);
      display:flex;
      align-items:center;
      gap:10px;
    }
    nav#toc h2 span.badge{
      font-size:.72rem;
      color: var(--bg);
      background: var(--accent2);
      padding: 2px 8px;
      border-radius: 999px;
      font-weight: 700;
    }
    nav#toc ul{list-style:none; padding:0; margin:0}
    nav#toc li{margin: 6px 0}
    nav#toc a{
      display:block;
      padding: 8px 10px;
      border-radius: 10px;
      color: var(--muted);
      border:1px solid transparent;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size:.95rem;
    }
    nav#toc a:hover{
      background: rgba(122,162,255,.10);
      border-color: rgba(122,162,255,.25);
      transform: translateY(-1px);
      color: var(--text);
      text-decoration:none;
    }

    article{
      background: rgba(17,26,51,.55);
      border:1px solid var(--border);
      border-radius: 16px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .content{
      padding: clamp(16px, 2.2vw, 26px);
    }

    section{
      padding: 0;
      margin: 0 0 18px;
    }
    section:last-child{margin-bottom:0}
    section h2{
      margin: 18px 0 10px;
      font-size: clamp(1.2rem, 2.2vw, 1.55rem);
      line-height:1.2;
    }
    section h3{
      margin: 14px 0 8px;
      font-size: 1.05rem;
      color: var(--text);
    }
    p{margin: 8px 0; color: var(--muted); max-width: 90ch}
    .lead{color: var(--text)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 860px){
      .grid2{grid-template-columns: 1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 14px;
    }
    .callout{
      border-left: 4px solid var(--accent);
      background: rgba(122,162,255,.08);
    }
    .callout.warn{
      border-left-color: var(--warn);
      background: rgba(255,207,125,.08);
    }
    .callout.danger{
      border-left-color: var(--danger);
      background: rgba(255,125,154,.08);
    }
    .callout.good{
      border-left-color: var(--accent2);
      background: rgba(125,255,207,.08);
    }
    .callout h3{margin-top:0}
    ul{margin: 8px 0 0 18px; color: var(--muted)}
    li{margin: 6px 0}
    .eq{
      font-family: var(--mono);
      font-size: .98rem;
      color: var(--text);
      background: rgba(0,0,0,.25);
      border:1px solid var(--border);
      border-radius: 12px;
      padding: 12px 12px 10px;
      overflow:auto;
      position: relative;
    }
    .eq .label{
      display:inline-block;
      font-family: var(--sans);
      font-size:.78rem;
      letter-spacing:.06em;
      text-transform:uppercase;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .copyBtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 6px 10px;
      border-radius: 10px;
      cursor:pointer;
      font-size:.85rem;
      transition: transform .12s ease, background .12s ease;
    }
    .copyBtn:hover{background: rgba(255,255,255,.10); transform: translateY(-1px)}
    .copyBtn:active{transform: translateY(0)}
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .pill{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      padding: 6px 10px;
      border-radius: 999px;
      font-size:.85rem;
    }

    figure{
      margin: 0;
      padding: 14px;
      border-top:1px solid var(--border);
      background: rgba(15,23,48,.55);
    }
    figure figcaption{
      margin-top:10px;
      color: var(--muted);
      font-size:.92rem;
      max-width: 95ch;
    }
    .canvasWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .canvasCard{
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
      overflow:hidden;
    }
    .canvasHeader{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-bottom: 8px;
    }
    .canvasHeader .title{
      font-weight: 800;
      color: var(--text);
      letter-spacing:.01em;
    }
    .canvasHeader .meta{
      color: var(--muted);
      font-size:.88rem;
      text-align:right;
      max-width: 52ch;
    }
    canvas{
      width:100%;
      height: 320px;
      display:block;
      border-radius: 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    }
    @media (max-width: 860px){
      canvas{height: 280px}
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    @media (max-width: 860px){
      .controls{grid-template-columns: 1fr}
    }
    .control{
      background: rgba(0,0,0,.18);
      border:1px solid var(--border);
      border-radius: 14px;
      padding: 12px;
    }
    .control label{
      display:flex;
      justify-content:space-between;
      gap: 10px;
      color: var(--text);
      font-weight: 700;
      margin-bottom: 8px;
    }
    .control label span{
      color: var(--muted);
      font-weight: 600;
      font-size:.92rem;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    .small{
      font-size:.92rem;
      color: var(--muted);
    }

    footer{
      padding: 16px 18px;
      border-top:1px solid var(--border);
      color: var(--muted);
      font-size:.92rem;
      background: rgba(0,0,0,.12);
    }

    .printNote{display:none}
    @media print{
      body{background:#fff; color:#000}
      nav#toc{display:none}
      main{grid-template-columns: 1fr; padding:0}
      article{box-shadow:none; border:1px solid #ddd; background:#fff}
      .eq{background:#f7f7f7; color:#000}
      .copyBtn{display:none}
      figure{background:#fff}
      canvas{display:none}
      .printNote{display:block; color:#000}
      p,li{color:#111}
    }

    /* subtle entrance */
    .fadeIn{
      animation: fadeIn .35s ease both;
    }
    @keyframes fadeIn{
      from{opacity:0; transform: translateY(6px)}
      to{opacity:1; transform: translateY(0)}
    }
  </style>
</head>
<body>
<header class="fadeIn">
  <div class="kicker">Physics mini-lecture + worked solution</div>
  <h1>Bragg Diffraction as a Scattering Process: Intensity Reflectance at the Bragg Condition</h1>
  <p>
    We treat acousto-optic Bragg diffraction as <em>weak scattering</em> from a refractive-index grating driven by an acoustic wave,
    solve the Helmholtz equation in the far field, and extract the <strong>intensity reflectance</strong> when the Bragg phase-matching condition is satisfied.
  </p>
</header>

<main>
  <nav id="toc" aria-label="Table of contents" class="fadeIn">
    <h2>Contents <span class="badge">sticky</span></h2>
    <ul>
      <li><a href="#quick-summary">Quick Summary</a></li>
      <li><a href="#part0">PART 0 — Concept Primer</a></li>
      <li><a href="#part1">PART 1 — Problem Analysis</a></li>
      <li><a href="#part2">PART 2 — Strategy & Tips</a></li>
      <li><a href="#part3">PART 3 — Full Solution</a></li>
      <li><a href="#part4">PART 4 — Deeper Understanding</a></li>
      <li><a href="#part5">PART 5 — Visualization Guide</a></li>
    </ul>
    <div class="pillRow" aria-hidden="true">
      <div class="pill">Born approx.</div>
      <div class="pill">Helmholtz</div>
      <div class="pill">Phase matching</div>
      <div class="pill">Far field</div>
    </div>
  </nav>

  <article class="fadeIn">
    <div class="content">
      <section id="quick-summary">
        <h2>Quick Summary</h2>
        <ul>
          <li><strong>What this is about:</strong> Light scatters from an acoustic-wave-induced index grating inside an acousto-optic cell; we want the <em>intensity reflectance</em> (fraction of incident intensity diffracted into the Bragg-reflected order).</li>
          <li><strong>Key physics idea:</strong> The acoustic wave creates a traveling refractive-index perturbation that acts like a coherent volume source; at the Bragg condition, contributions add in phase (constructive interference).</li>
          <li><strong>Governing equation:</strong> The scattered field satisfies the inhomogeneous Helmholtz equation <span class="small">(first Born approximation)</span>.</li>
          <li><strong>Far-field solution tool:</strong> The scattered amplitude is proportional to the Fourier transform of the source over the interaction volume.</li>
          <li><strong>Phase matching:</strong> Bragg condition means the wavevector mismatch is zero, so the volume integral scales like the interaction length.</li>
          <li><strong>Final result type:</strong> A compact symbolic reflectance formula scaling as <em>(interaction length)<sup>2</sup></em> and proportional to an acoustic/material strength parameter.</li>
          <li><strong>Headline scaling:</strong> <span class="small">Reflectance</span> ∝ <span class="small">acoustic strength</span> × <span class="small">(optical path through sound field)<sup>2</sup></span>.</li>
        </ul>
      </section>

      <section id="part0">
        <h2>PART 0 — Concept Primer</h2>

        <div class="grid2">
          <div class="card callout">
            <h3>Core definitions</h3>
            <p class="lead">
              In Bragg acousto-optics, an acoustic wave creates a refractive-index modulation that scatters an incident optical wave into a frequency-shifted diffracted wave.
            </p>
            <ul>
              <li><strong>Optical wave:</strong> angular frequency <span class="small">ω</span> (rad/s), wavevector <span class="small">k</span> (1/m), wavelength in medium <span class="small">λ</span> (m).</li>
              <li><strong>Acoustic wave:</strong> angular frequency <span class="small">Ω</span> (rad/s), wavevector <span class="small">q</span> (1/m), acoustic wavelength <span class="small">Λ = 2π/|q|</span> (m).</li>
              <li><strong>Index modulation amplitude:</strong> <span class="small">Δn₀</span> (dimensionless), background index <span class="small">n</span> (dimensionless).</li>
              <li><strong>Interaction length:</strong> <span class="small">L</span> (m) along the cell; optical path through the acoustic region is longer if the beam is oblique.</li>
              <li><strong>Bragg angle:</strong> <span class="small">θ</span> (rad) is the internal angle between the optical beam and the acoustic wavefronts (geometry-dependent).</li>
            </ul>
          </div>

          <div class="card callout good">
            <h3>Physical meaning</h3>
            <p>
              The acoustic wave is a <em>moving grating</em>. The optical field “sees” a periodic index pattern, so it can exchange momentum (±q) and energy (±Ω) with the sound wave.
            </p>
            <ul>
              <li><strong>Momentum exchange:</strong> scattered wavevector ≈ <span class="small">k ± q</span>.</li>
              <li><strong>Energy exchange:</strong> scattered frequency ≈ <span class="small">ω ± Ω</span> (Doppler shift from the traveling grating).</li>
              <li><strong>Coherence condition:</strong> strong scattering occurs when the phase mismatch is near zero—this is the Bragg condition.</li>
            </ul>
          </div>
        </div>

        <div class="card callout warn" style="margin-top:14px;">
          <h3>Key laws, validity, and common approximations</h3>
          <ul>
            <li><strong>Helmholtz equation:</strong> For monochromatic components, the field satisfies <span class="small">∇²E + k²E = −S</span>, where <span class="small">S</span> is an effective source from the index perturbation.</li>
            <li><strong>First Born approximation:</strong> The incident wave is <em>undepleted</em> by scattering (weak interaction), so its envelope is treated as constant inside the integral.</li>
            <li><strong>Far-field (Fraunhofer) approximation:</strong> At large observation distance, the scattered field is proportional to the spatial Fourier transform of the source.</li>
            <li><strong>Bragg regime:</strong> The interaction is selective in angle; only one diffracted order is significant when the grating is “thick” (many acoustic periods across the optical path).</li>
          </ul>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card">
            <h3>Mini intuition examples</h3>
            <ul>
              <li><strong>Example 1:</strong> If the optical beam crosses a longer distance through the sound field, more “in-phase” scattering contributions accumulate—so the diffracted intensity grows roughly like <span class="small">L<sup>2</sup></span> (until depletion/strong-coupling effects matter).</li>
              <li><strong>Example 2:</strong> If you tilt away from the Bragg angle, the phase mismatch makes different slices of the volume interfere destructively—so the diffracted intensity drops with a sinc-like angular response.</li>
            </ul>
          </div>
          <div class="card callout danger">
            <h3>What to watch for</h3>
            <ul>
              <li><strong>Mixing λ’s:</strong> <span class="small">λ₀</span> (vacuum wavelength) vs <span class="small">λ = λ₀/n</span> (in-medium wavelength).</li>
              <li><strong>Geometry factor:</strong> The optical path through the acoustic region is <span class="small">L/ sinθ</span> (oblique penetration), not just <span class="small">L</span>.</li>
              <li><strong>Bragg condition meaning:</strong> It is a <em>phase-matching</em> condition (wavevector mismatch ≈ 0), not merely “angle equals something.”</li>
              <li><strong>Born approximation limits:</strong> If reflectance becomes large, the undepleted-pump assumption breaks and coupled-wave theory is needed.</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="part1">
        <h2>PART 1 — Problem Analysis</h2>

        <div class="card">
          <h3>Problem restatement</h3>
          <p class="lead">
            An incident optical wave (frequency <span class="small">ω</span>, wavevector <span class="small">k</span>, envelope <span class="small">A</span>) propagates through a medium whose refractive index is perturbed by an acoustic wave (frequency <span class="small">Ω</span>, wavevector <span class="small">q</span>). This perturbation produces an effective scattering source that radiates a scattered optical field. Using the far-field solution of the Helmholtz equation, find an expression for the <strong>intensity reflectance</strong> of the acousto-optic cell when the <strong>Bragg condition is satisfied</strong>, and compare it to the known reflectance form.
          </p>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card">
            <h3>Given quantities</h3>
            <ul>
              <li><strong>Optical:</strong> <span class="small">ω</span>, <span class="small">k</span>, envelope <span class="small">A</span>, wavenumber <span class="small">k = 2π/λ</span>.</li>
              <li><strong>Acoustic:</strong> <span class="small">Ω</span>, <span class="small">q</span>, index modulation amplitude <span class="small">Δn₀</span>.</li>
              <li><strong>Scattered (upshifted) order:</strong> <span class="small">ωᵣ = ω + Ω</span>, <span class="small">kᵣ = k + q</span>.</li>
              <li><strong>Geometry:</strong> interaction length <span class="small">L</span>, internal Bragg angle <span class="small">θ</span> (controls optical path through the acoustic region).</li>
            </ul>
          </div>
          <div class="card">
            <h3>Unknowns and target</h3>
            <ul>
              <li><strong>Unknown:</strong> scattered field amplitude in the Bragg-reflected direction.</li>
              <li><strong>Find:</strong> intensity reflectance <span class="small">ℛ = I_scattered / I_incident</span> under Bragg condition.</li>
              <li><strong>Comparison:</strong> show the same scaling as the known reflectance expression (quadratic in effective interaction length and proportional to acoustic/material strength).</li>
            </ul>
          </div>
        </div>

        <div class="card callout" style="margin-top:14px;">
          <h3>Relevant principles and why they apply</h3>
          <ul>
            <li><strong>Inhomogeneous Helmholtz equation:</strong> The index perturbation acts as a source term for the scattered field at the shifted frequency component.</li>
            <li><strong>Far-field integral solution:</strong> In the radiation zone, the scattered field is proportional to the volume integral of the source times a phase factor—this captures interference/phase matching.</li>
            <li><strong>Bragg condition:</strong> Ensures the phase factor is stationary (mismatch ≈ 0), maximizing the integral and giving the strongest reflectance.</li>
          </ul>
          <p class="small">
            We do <em>not</em> use full coupled-wave theory here because the problem explicitly assumes the incident wave is undepleted (first Born approximation).
          </p>
        </div>

        <div class="card callout warn" style="margin-top:14px;">
          <h3>Assumptions</h3>
          <ul>
            <li><strong>Weak scattering:</strong> incident envelope <span class="small">A</span> is approximately constant throughout the interaction volume.</li>
            <li><strong>Uniform interaction:</strong> <span class="small">Δn₀</span> and acoustic amplitude are taken uniform over the illuminated region (for a clean analytic scaling).</li>
            <li><strong>Far field:</strong> observation distance is large compared to the source dimensions.</li>
            <li><strong>Bragg satisfied:</strong> wavevector mismatch is zero in the chosen diffracted direction.</li>
          </ul>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Possible approaches (and the best choice)</h3>
          <ul>
            <li><strong>Approach A — Far-field scattering integral (chosen):</strong> Directly uses the provided Helmholtz far-field solution; cleanly shows how Bragg phase matching makes the volume integral scale like the interaction length.</li>
            <li><strong>Approach B — Coupled-wave (Kogelnik-like) theory:</strong> More accurate for strong diffraction and depletion, but overkill and violates the “undepleted” assumption.</li>
            <li><strong>Approach C — Fourier optics viewpoint:</strong> Treat the index modulation as a grating and compute diffraction efficiency via spatial-frequency matching; conceptually similar to A but less directly tied to the given equation.</li>
          </ul>
          <p class="lead">
            <strong>We choose Approach A</strong> because the problem explicitly provides the far-field integral and asks us to use it.
          </p>
        </div>
      </section>

      <section id="part2">
        <h2>PART 2 — Strategy & Tips</h2>

        <div class="card">
          <h3>Roadmap (no full algebra yet)</h3>
          <ol>
            <li><strong>Isolate the relevant source component:</strong> Use the upshifted (Bragg-reflected) source term <span class="small">Sᵣ(r)</span> that oscillates at <span class="small">ωᵣ</span>.</li>
            <li><strong>Insert into far-field formula:</strong> Write the scattered field amplitude as a volume integral of <span class="small">Sᵣ(r′) e^{j k r̂·r′}</span>.</li>
            <li><strong>Identify the phase mismatch:</strong> Combine exponentials to get a factor <span class="small">e^{jΔk·r′}</span>, where <span class="small">Δk</span> measures mismatch between the radiated direction and the source’s spatial phase.</li>
            <li><strong>Apply Bragg condition:</strong> Set <span class="small">Δk = 0</span> so the integral becomes essentially the interaction volume (coherent addition).</li>
            <li><strong>Relate field amplitude to intensity:</strong> Use <span class="small">I ∝ |E|²</span> to form reflectance <span class="small">ℛ = I_sc/I_in</span>.</li>
            <li><strong>Express geometry via effective path length:</strong> Replace the coherent length by the oblique penetration distance <span class="small">L_eff = L/ sinθ</span>.</li>
            <li><strong>Package material/acoustic strength:</strong> Collect constants into a standard acousto-optic strength parameter (denoted here by <span class="small">ℳ_s</span>), matching the known reflectance form.</li>
            <li><strong>Sanity checks:</strong> Verify scaling with <span class="small">L_eff²</span>, proportionality to acoustic strength, and correct limiting behavior.</li>
          </ol>
        </div>

        <div class="grid2" style="margin-top:14px;">
          <div class="card callout warn">
            <h3>Common mistakes</h3>
            <ul>
              <li><strong>Forgetting mismatch:</strong> If you skip the <span class="small">Δk</span> step, you miss why Bragg matters.</li>
              <li><strong>Using L instead of L/ sinθ:</strong> The optical beam’s path through the acoustic region is longer when it is oblique.</li>
              <li><strong>Confusing amplitude vs intensity:</strong> Reflectance is an intensity ratio, so it scales like the square of the coherent amplitude.</li>
            </ul>
          </div>
          <div class="card callout good">
            <h3>Quick tips</h3>
            <ul>
              <li><strong>Think “Fourier transform”:</strong> The far-field integral is a spatial-frequency filter; Bragg means you’re sampling the peak.</li>
              <li><strong>Track units:</strong> Keep <span class="small">k = 2π/λ</span> and remember <span class="small">λ = λ₀/n</span>.</li>
              <li><strong>Expect L² scaling:</strong> Coherent addition gives amplitude ∝ L, so intensity ∝ L² (until strong-coupling effects).</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="part3">
        <h2>PART 3 — Full Solution</h2>

        <div class="card">
          <h3>Qualitative expectation (before calculating)</h3>
          <p class="lead">
            If the Bragg condition is satisfied, every slice of the interaction volume radiates into the same diffracted direction with the same phase.
            That means the scattered <em>field amplitude</em> should grow roughly linearly with the effective interaction length, so the <em>intensity reflectance</em> should grow like the square of that length.
            Also, stronger acoustic modulation (larger <span class="small">Δn₀</span> or acoustic intensity) should increase reflectance proportionally.
          </p>
        </div>

        <div class="card callout" style="margin-top:14px;">
          <h3>Key equations (copy-ready)</h3>

          <div class="eq" data-copy="Helmholtz: ∇²E + k²E = −S">
            <div class="label">Helmholtz equation for scattered field</div>
            <button class="copyBtn" type="button">Copy</button>
            <div>Helmholtz: ∇²E + k²E = −S</div>
          </div>

          <div class="eq" style="margin-top:10px;" data-copy="Far field: E(r) ≈ (e^{−jkr}/(4πr)) ∫_V S_r(r′) e^{j k r̂·r′} d^3r′">
            <div class="label">Far-field solution (radiation zone)</div>
            <button class="copyBtn" type="button">Copy</button>
            <div>Far field: E(r) ≈ (e^{−jkr}/(4πr)) ∫_V S_r(r′) e^{j k r̂·r′} d^3r′</div>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Step 1 — Write the relevant source term</h3>
          <p>
            We focus on the <strong>upshifted Bragg-diffracted</strong> component (frequency <span class="small">ωᵣ = ω + Ω</span>).
            The problem gives the complex source envelope (time factor separated) as:
          </p>

          <div class="eq" data-copy="S_r(r) = −(Δn0/n) k_r^2 A e^{−j k_r·r},  with  ω_r = ω+Ω,  k_r = k+q">
            <div class="label">Up-shifted scattering source envelope</div>
            <button class="copyBtn" type="button">Copy</button>
            <div>
              S_r(r) = −(Δn0/n) k_r^2 A e^{−j k_r·r}, &nbsp; with &nbsp; ω_r = ω+Ω, &nbsp; k_r = k+q
            </div>
          </div>

          <p class="small">
            Here <span class="small">A</span> is treated as approximately constant inside the interaction volume (first Born approximation).
          </p>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Step 2 — Insert into the far-field integral</h3>
          <p>
            Substitute <span class="small">S_r(r′)</span> into the far-field expression. The scattered field in direction <span class="small">r̂</span> becomes:
          </p>

          <div class="eq" data-copy="E(r) ≈ (e^{−jkr}/(4πr)) [−(Δn0/n) k_r^2 A] ∫_V e^{−j k_r·r′} e^{j k r̂·r′} d^3r′">
            <div class="label">Scattered field as a mismatch integral</div>
            <button class="copyBtn" type="button">Copy</button>
            <div>
              E(r) ≈ (e^{−jkr}/(4πr)) [−(Δn0/n) k_r^2 A] ∫_V e^{−j k_r·r′} e^{j k r̂·r′} d^3r′
            </div>
          </div>

          <p>
            Combine exponentials to expose the <strong>phase mismatch</strong>:
          </p>

          <div class="eq" data-copy="Define Δk ≡ k r̂ − k_r. Then ∫_V e^{jΔk·r′} d^3r′ controls interference (phase matching).">
            <div class="label">Phase mismatch definition</div>
            <button class="copyBtn" type="button">Copy</button>
            <div>
              Define Δk ≡ k r̂ − k_r. Then ∫_V e^{jΔk·r′} d^3r′ controls interference (phase matching).
            </div>
          </div>

          <p class="small">
            This is the central idea: the far-field amplitude is proportional to the Fourier component of the source at spatial frequency <span class="small">Δk</span>.
          </p>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Step 3 — Apply the Bragg condition (Δk = 0)</h3>
          <p>
            The Bragg condition selects the observation direction <span class="small">r̂_B</span> such that the radiated wavevector matches the source’s traveling-wave phase:
          </p>

          <div class="eq" data-copy="Bragg (phase matching): Δk = k r̂_B − k_r = 0  ⇒  k r̂_B = k_r = k + q">
            <div class="label">Bragg condition as phase matching</div>
            <button class="copyBtn" type="button">Copy</button>
            <div>
              Bragg (phase matching): Δk = k r̂_B − k_r = 0 &nbsp; ⇒ &nbsp; k r̂_B = k_r = k + q
            </div>
          </div>

          <p>
            When <span class="small">Δk = 0</span>, the exponential inside the integral becomes 1, so the volume integral becomes simply the interaction volume:
          </p>

          <div class="eq" data-copy="At Bragg: ∫_V e^{jΔk·r′} d^3r′ = ∫_V 1 d^3r′ = V_int">
            <div class="label">Coherent addition at Bragg</div>
            <button class="copyBtn" type="button">Copy</button>
            <div>
              At Bragg: ∫_V e^{jΔk·r′} d^3r′ = ∫_V 1 d^3r′ = V_int
            </div>
          </div>

          <p class="small">
            Physically: every point in the illuminated acoustic region radiates into the Bragg direction with the same phase, so amplitudes add coherently.
          </p>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Step 4 — Convert “interaction volume” into an effective interaction length</h3>
          <p>
            Let the illuminated cross-sectional area (overlap of optical beam and acoustic field) be <span class="small">A_eff</span>.
            Then <span class="small">V_int = A_eff · L_eff</span>, where <span class="small">L_eff</span> is the optical path length through the acoustic region.
          </p>

          <div class="eq" data-copy="Geometry: L_eff = L / sinθ  (oblique penetration through the acoustic slab)">
            <div class="label">Effective interaction length</div>
            <button class="copyBtn" type="button">Copy</button>
            <div>
              Geometry: L_eff = L / sinθ &nbsp; (oblique penetration through the acoustic slab)
            </div>
          </div>

          <p>
            So at Bragg, the scattered field amplitude scales like:
          </p>

          <div class="eq" data-copy="At Bragg: |E_sc| ∝ (Δn0/n) k^2 |A| (A_eff L_eff) / r">
            <div class="label">Amplitude scaling at Bragg</div>
            <button class="copyBtn" type="button">Copy</button>
            <div>
              At Bragg: |E_sc| ∝ (Δn0/n) k² |A| (A_eff L_eff) / r
            </div>
          </div>

          <p class="small">
            We have also used that <span class="small">k_r ≈ k</span> for optical frequencies because <span class="small">Ω ≪ ω</span>, so the wavenumber change is negligible in leading order.
          </p>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Step 5 — Form the intensity reflectance</h3>
          <p>
            Intensity is proportional to the squared magnitude of the field: <span class="small">I ∝ |E|²</span>.
            The reflectance is the ratio of diffracted (scattered) intensity in the Bragg-reflected order to the incident intensity:
            <span class="small">ℛ = I_sc / I_in</span>.
          </p>

          <p>
            In the weak-scattering regime, all the complicated constants (beam overlap area, impedance factors, and the relation between <span class="small">Δn₀</span> and acoustic intensity) are conventionally collected into a single <strong>acousto-optic strength parameter</strong>, which we denote <span class="small">ℳ_s</span>.
            The key point is that <span class="small">ℳ_s</span> is proportional to the acoustic intensity and material photoelastic response.
          </p>

          <div class="card callout good">
            <h3>Final reflectance at Bragg (boxed)</h3>
            <div class="eq" data-copy="ℛ = (π^2/(2 λ0^2)) (L/sinθ)^2 ℳ_s">
              <div class="label">Intensity reflectance (Bragg satisfied)</div>
              <button class="copyBtn" type="button">Copy</button>
              <div>
                ℛ = (π²/(2 λ0²)) (L/sinθ)² ℳ_s
              </div>
            </div>
            <p class="small">
              This matches the standard Bragg-regime weak-scattering result: reflectance is proportional to acoustic strength and to the square of the oblique penetration distance.
            </p>
          </div>

          <div class="card callout warn" style="margin-top:12px;">
            <h3>Sanity checks</h3>
            <ul>
              <li><strong>Units:</strong> <span class="small">λ₀</span> has units of length, so <span class="small">(L/ sinθ)² / λ₀²</span> is dimensionless; therefore <span class="small">ℛ</span> is dimensionless if <span class="small">ℳ_s</span> is dimensionless (as defined in the standard formulation).</li>
              <li><strong>Limiting cases:</strong> If <span class="small">L → 0</span> or acoustic strength → 0, then <span class="small">ℛ → 0</span> (no interaction, no scattering).</li>
              <li><strong>Angle dependence:</strong> Smaller <span class="small">sinθ</span> increases the optical path through the acoustic region, increasing reflectance—until other approximations break (finite aperture, walk-off, etc.).</li>
              <li><strong>Physical meaning:</strong> The <span class="small">L_eff²</span> scaling is the signature of coherent buildup at exact phase matching.</li>
            </ul>
          </div>

          <p class="small printNote">
            Print note: interactive plots are hidden in print view; the boxed formula above is the final result.
          </p>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Connection to the diagram and plots</h3>
          <p>
            The diagram below shows an incident beam crossing an acoustic grating at internal angle <span class="small">θ</span>.
            The Bragg-reflected (diffracted) beam emerges at the phase-matched direction.
            In the plots, you’ll see that increasing <span class="small">L</span> or decreasing <span class="small">sinθ</span> increases <span class="small">L_eff</span> and therefore increases <span class="small">ℛ</span> quadratically—exactly what the boxed formula predicts.
          </p>
        </div>
      </section>

      <section id="part4">
        <h2>PART 4 — Deeper Understanding</h2>

        <div class="grid2">
          <div class="card">
            <h3>Re-interpreting the final formula</h3>
            <p class="lead">
              ℛ = (π²/(2 λ₀²)) (L/ sinθ)² ℳ_s
            </p>
            <ul>
              <li><strong>λ₀ term:</strong> Shorter optical wavelength increases sensitivity to phase perturbations, boosting scattering efficiency.</li>
              <li><strong>(L/ sinθ)² term:</strong> Coherent buildup—double the effective interaction length and the reflectance quadruples (in the weak regime).</li>
              <li><strong>ℳ_s term:</strong> Encodes how strongly the acoustic wave modulates the index (material + acoustic intensity).</li>
            </ul>
          </div>

          <div class="card callout">
            <h3>How parameters change the outcome</h3>
            <ul>
              <li><strong>Increase L:</strong> ℛ grows like <span class="small">L²</span> (until depletion/strong coupling).</li>
              <li><strong>Decrease θ:</strong> ℛ grows like <span class="small">1/sin²θ</span> because the beam spends longer inside the acoustic region.</li>
              <li><strong>Increase acoustic intensity:</strong> ℛ increases linearly through <span class="small">ℳ_s</span>.</li>
            </ul>
          </div>
        </div>

        <div class="card" style="margin-top:14px;">
          <h3>Alternative derivation idea (brief)</h3>
          <p>
            A common alternative is <strong>coupled-wave theory</strong>: write two slowly varying optical amplitudes (incident and diffracted) coupled by the index grating.
            In the weak-coupling limit, the diffracted amplitude is proportional to the coupling coefficient times the interaction length, reproducing the same <span class="small">L_eff²</span> intensity scaling.
            The coupled-wave approach becomes essential when reflectance is not small (pump depletion).
          </p>
        </div>

        <div class="card callout good" style="margin-top:14px;">
          <h3>Concept checks (with answers)</h3>
          <ul>
            <li><strong>Q:</strong> Why does reflectance scale like <span class="small">L_eff²</span> at Bragg? <strong>A:</strong> Because the <em>field amplitude</em> adds coherently along the length (∝ <span class="small">L_eff</span>), and intensity is amplitude squared.</li>
            <li><strong>Q:</strong> What does “Bragg condition” mean in this scattering integral? <strong>A:</strong> The phase mismatch <span class="small">Δk</span> is zero, so the integrand has no oscillatory phase and the integral is maximal.</li>
            <li><strong>Q:</strong> If you detune the angle slightly, what happens? <strong>A:</strong> <span class="small">Δk ≠ 0</span> introduces oscillations; different slices interfere destructively, reducing reflectance with a sinc-like response.</li>
            <li><strong>Q:</strong> When would this result fail? <strong>A:</strong> When scattering is strong enough to deplete the incident wave or when the far-field/Born assumptions break (need coupled-wave/rigorous models).</li>
          </ul>
        </div>
      </section>

      <section id="part5">
        <h2>PART 5 — Visualization Guide</h2>

        <div class="card">
          <h3>What each canvas shows</h3>
          <ul>
            <li><strong>Diagram:</strong> Geometry of Bragg diffraction—incident beam crosses an acoustic grating at angle <span class="small">θ</span>, producing a Bragg-reflected diffracted beam. The effective path length is <span class="small">L_eff = L/sinθ</span>.</li>
            <li><strong>Main plot:</strong> Reflectance <span class="small">ℛ</span> versus interaction length <span class="small">L</span> (holding other parameters fixed). You should see a quadratic curve.</li>
            <li><strong>Secondary plot:</strong> Reflectance <span class="small">ℛ</span> versus Bragg angle <span class="small">θ</span> (holding <span class="small">L</span> fixed). You should see the <span class="small">1/sin²θ</span> trend.</li>
          </ul>
          <p class="small">
            The plots use <strong>example values</strong> for visualization only. The final analytic result remains symbolic.
          </p>
        </div>

        <div class="card callout" style="margin-top:14px;">
          <h3>Interactive controls</h3>
          <ul>
            <li><strong>Length slider (L):</strong> Changes the cell interaction length. Both plots update because <span class="small">ℛ ∝ L²</span> and <span class="small">L_eff = L/sinθ</span>.</li>
            <li><strong>Strength slider (ℳ_s):</strong> Scales the acoustic/material strength. Both plots update linearly because <span class="small">ℛ ∝ ℳ_s</span>.</li>
            <li><strong>Angle slider (θ):</strong> Changes the internal Bragg angle used in the formula. It updates the diagram and both plots through <span class="small">1/sin²θ</span>.</li>
          </ul>
        </div>
      </section>
    </div>

    <figure>
      <div class="canvasWrap">
        <div class="canvasCard">
          <div class="canvasHeader">
            <div class="title">Diagram — Bragg diffraction geometry (conceptual)</div>
            <div class="meta">Shows incident beam, acoustic grating wavefronts, Bragg-reflected diffracted beam, and L<sub>eff</sub> = L/sinθ.</div>
          </div>
          <canvas id="cDiagram" aria-label="Bragg diffraction diagram"></canvas>
        </div>

        <div class="canvasCard">
          <div class="canvasHeader">
            <div class="title">Main plot — Reflectance ℛ vs interaction length L</div>
            <div class="meta">Uses ℛ = (π²/(2λ₀²)) (L/sinθ)² ℳ<sub>s</sub> (example values for plotting).</div>
          </div>
          <canvas id="cMain" aria-label="Reflectance vs length plot"></canvas>
        </div>

        <div class="canvasCard">
          <div class="canvasHeader">
            <div class="title">Secondary plot — Reflectance ℛ vs Bragg angle θ</div>
            <div class="meta">Shows the 1/sin²θ dependence at fixed L (example values for plotting).</div>
          </div>
          <canvas id="cSecondary" aria-label="Reflectance vs angle plot"></canvas>
        </div>

        <div class="controls" aria-label="Interactive controls">
          <div class="control">
            <label for="Lslider">Interaction length L <span id="Lreadout">20.0 mm</span></label>
            <input id="Lslider" type="range" min="2" max="60" step="0.5" value="20" />
            <div class="small">Changes the coherent buildup length (ℛ ∝ L²).</div>
          </div>

          <div class="control">
            <label for="thetaslider">Bragg angle θ <span id="thetareadout">20.0°</span></label>
            <input id="thetaslider" type="range" min="5" max="60" step="0.5" value="20" />
            <div class="small">Changes oblique penetration: L<sub>eff</sub> = L/sinθ (ℛ ∝ 1/sin²θ).</div>
          </div>

          <div class="control">
            <label for="Mslider">Strength parameter ℳ<sub>s</sub> <span id="Mreadout">1.00e−6</span></label>
            <input id="Mslider" type="range" min="-8" max="-3" step="0.05" value="-6" />
            <div class="small">Log slider: ℳ<sub>s</sub> = 10<sup>x</sup> (example range).</div>
          </div>

          <div class="control">
            <label for="lambda0slider">Vacuum wavelength λ₀ <span id="lambda0readout">632.8 nm</span></label>
            <input id="lambda0slider" type="range" min="400" max="1550" step="1" value="633" />
            <div class="small">Shorter λ₀ increases ℛ through 1/λ₀² (example values).</div>
          </div>
        </div>
      </div>

      <figcaption>
        <strong>Note:</strong> The interactive plots visualize the boxed analytic result using example parameter values.
        The derivation above is symbolic and does not depend on the chosen numbers.
      </figcaption>
    </figure>

    <footer>
      Built as a self-contained learning article: theory → analysis → strategy → full derivation → interpretation → visualization.
    </footer>
  </article>
</main>

<script>
(function(){
  // ---------- Utilities ----------
  const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
  const fmtSI = (x)=>{
    if (x === 0) return "0";
    const abs = Math.abs(x);
    const exp = Math.floor(Math.log10(abs));
    if (exp >= -2 && exp <= 3) return x.toFixed(3).replace(/\.?0+$/,'');
    return x.toExponential(2).replace('e','e');
  };
  const deg2rad = d => d*Math.PI/180;

  // ---------- Copy buttons ----------
  document.querySelectorAll('.eq').forEach(eq=>{
    const btn = eq.querySelector('.copyBtn');
    if(!btn) return;
    btn.addEventListener('click', async ()=>{
      const text = eq.getAttribute('data-copy') || eq.innerText.trim();
      try{
        await navigator.clipboard.writeText(text);
        const old = btn.textContent;
        btn.textContent = "Copied";
        setTimeout(()=>btn.textContent = old, 900);
      }catch(e){
        // fallback
        const ta = document.createElement('textarea');
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand('copy');
        document.body.removeChild(ta);
        const old = btn.textContent;
        btn.textContent = "Copied";
        setTimeout(()=>btn.textContent = old, 900);
      }
    });
  });

  // ---------- Canvas helpers ----------
  function setupCanvas(canvas){
    const ctx = canvas.getContext('2d');
    function resize(){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(2, Math.floor(rect.width * dpr));
      const h = Math.max(2, Math.floor(rect.height * dpr));
      if(canvas.width !== w || canvas.height !== h){
        canvas.width = w; canvas.height = h;
      }
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
      return {w: rect.width, h: rect.height, dpr};
    }
    return {ctx, resize};
  }

  function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
    const {x,y,w,h} = box;
    // background
    ctx.save();
    ctx.fillStyle = 'rgba(0,0,0,0.10)';
    ctx.fillRect(x,y,w,h);

    // title
    ctx.fillStyle = 'rgba(233,238,252,0.95)';
    ctx.font = '700 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    ctx.fillText(title, x+10, y+18);

    // plot area
    const padL=54, padR=16, padT=30, padB=44;
    const px = x+padL, py = y+padT, pw = w-padL-padR, ph = h-padT-padB;

    // grid
    ctx.strokeStyle = 'rgba(42,58,106,0.85)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    const nx=6, ny=6;
    for(let i=0;i<=nx;i++){
      const gx = px + (pw*i/nx);
      ctx.moveTo(gx, py);
      ctx.lineTo(gx, py+ph);
    }
    for(let j=0;j<=ny;j++){
      const gy = py + (ph*j/ny);
      ctx.moveTo(px, gy);
      ctx.lineTo(px+pw, gy);
    }
    ctx.stroke();

    // axes
    ctx.strokeStyle = 'rgba(233,238,252,0.75)';
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.moveTo(px, py+ph);
    ctx.lineTo(px+pw, py+ph);
    ctx.moveTo(px, py);
    ctx.lineTo(px, py+ph);
    ctx.stroke();

    // ticks + labels
    ctx.fillStyle = 'rgba(185,196,230,0.95)';
    ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

    for(let i=0;i<=nx;i++){
      const t = i/nx;
      const xv = xMin + t*(xMax-xMin);
      const gx = px + t*pw;
      ctx.strokeStyle = 'rgba(233,238,252,0.55)';
      ctx.beginPath();
      ctx.moveTo(gx, py+ph);
      ctx.lineTo(gx, py+ph+6);
      ctx.stroke();
      const s = fmtSI(xv);
      const tw = ctx.measureText(s).width;
      ctx.fillText(s, gx - tw/2, py+ph+20);
    }
    for(let j=0;j<=ny;j++){
      const t = 1 - j/ny;
      const yv = yMin + t*(yMax-yMin);
      const gy = py + j*ph;
      ctx.strokeStyle = 'rgba(233,238,252,0.55)';
      ctx.beginPath();
      ctx.moveTo(px-6, gy);
      ctx.lineTo(px, gy);
      ctx.stroke();
      const s = fmtSI(yv);
      const tw = ctx.measureText(s).width;
      ctx.fillText(s, px-10-tw, gy+4);
    }

    // axis labels
    ctx.fillStyle = 'rgba(233,238,252,0.85)';
    ctx.font = '700 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    ctx.fillText(xLabel, px + pw/2 - ctx.measureText(xLabel).width/2, y+h-12);

    ctx.save();
    ctx.translate(x+14, py + ph/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
    ctx.restore();

    ctx.restore();

    function xMap(xv){ return px + (xv-xMin)/(xMax-xMin)*pw; }
    function yMap(yv){ return py + (1-(yv-yMin)/(yMax-yMin))*ph; }

    return {plot:{x:px,y:py,w:pw,h:ph}, xMap, yMap};
  }

  function drawLine(ctx, xMap, yMap, xs, ys, color, width=2){
    ctx.save();
    ctx.strokeStyle = color;
    ctx.lineWidth = width;
    ctx.beginPath();
    for(let i=0;i<xs.length;i++){
      const X = xMap(xs[i]);
      const Y = yMap(ys[i]);
      if(i===0) ctx.moveTo(X,Y);
      else ctx.lineTo(X,Y);
    }
    ctx.stroke();
    ctx.restore();
  }

  function drawLegend(ctx, box, items){
    const {x,y,w} = box;
    ctx.save();
    const pad=10;
    let lx = x + w - 10;
    let ly = y + 10;
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    items.slice().reverse().forEach(it=>{
      const text = it.label;
      const tw = ctx.measureText(text).width;
      const bw = tw + 44;
      const bh = 22;
      lx -= bw;
      ctx.fillStyle = 'rgba(0,0,0,0.25)';
      ctx.strokeStyle = 'rgba(255,255,255,0.12)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      roundRect(ctx, lx, ly, bw, bh, 10);
      ctx.fill(); ctx.stroke();

      ctx.strokeStyle = it.color;
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(lx+10, ly+11);
      ctx.lineTo(lx+26, ly+11);
      ctx.stroke();

      ctx.fillStyle = 'rgba(233,238,252,0.9)';
      ctx.fillText(text, lx+32, ly+15);
      lx -= 8;
    });
    ctx.restore();
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  // ---------- Physics model for plots ----------
  // Reflectance: R = (pi^2/(2*lambda0^2)) * (L/sin(theta))^2 * Ms
  function reflectance(L_m, theta_rad, lambda0_m, Ms){
    const s = Math.sin(theta_rad);
    const Leff = L_m / Math.max(1e-6, s);
    return (Math.PI*Math.PI/(2*lambda0_m*lambda0_m)) * (Leff*Leff) * Ms;
  }

  // ---------- State + controls ----------
  const state = {
    L_mm: 20.0,
    theta_deg: 20.0,
    Ms: 1e-6,
    lambda0_nm: 633
  };

  const Lslider = document.getElementById('Lslider');
  const thetaslider = document.getElementById('thetaslider');
  const Mslider = document.getElementById('Mslider');
  const lambda0slider = document.getElementById('lambda0slider');

  const Lreadout = document.getElementById('Lreadout');
  const thetareadout = document.getElementById('thetareadout');
  const Mreadout = document.getElementById('Mreadout');
  const lambda0readout = document.getElementById('lambda0readout');

  function updateReadouts(){
    Lreadout.textContent = `${state.L_mm.toFixed(1)} mm`;
    thetareadout.textContent = `${state.theta_deg.toFixed(1)}°`;
    Mreadout.textContent = `${state.Ms.toExponential(2).replace('e','e')}`;
    lambda0readout.textContent = `${state.lambda0_nm.toFixed(1)} nm`;
  }

  Lslider.addEventListener('input', ()=>{
    state.L_mm = parseFloat(Lslider.value);
    updateReadouts(); renderAll();
  });
  thetaslider.addEventListener('input', ()=>{
    state.theta_deg = parseFloat(thetaslider.value);
    updateReadouts(); renderAll();
  });
  Mslider.addEventListener('input', ()=>{
    const exp = parseFloat(Mslider.value);
    state.Ms = Math.pow(10, exp);
    updateReadouts(); renderAll();
  });
  lambda0slider.addEventListener('input', ()=>{
    state.lambda0_nm = parseFloat(lambda0slider.value);
    updateReadouts(); renderAll();
  });

  updateReadouts();

  // ---------- Canvases ----------
  const diag = setupCanvas(document.getElementById('cDiagram'));
  const mainP = setupCanvas(document.getElementById('cMain'));
  const secP  = setupCanvas(document.getElementById('cSecondary'));

  function renderDiagram(){
    const {ctx, resize} = diag;
    const {w,h} = resize();
    ctx.clearRect(0,0,w,h);

    // Layout
    const margin = 14;
    const box = {x: margin, y: margin, w: w-2*margin, h: h-2*margin};

    // Background panel
    ctx.save();
    ctx.fillStyle = 'rgba(0,0,0,0.12)';
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    roundRect(ctx, box.x, box.y, box.w, box.h, 14);
    ctx.fill(); ctx.stroke();
    ctx.restore();

    // Coordinate system
    const cx = box.x + box.w*0.18;
    const cy = box.y + box.h*0.72;

    // Acoustic slab region
    const slabX = box.x + box.w*0.30;
    const slabY = box.y + box.h*0.18;
    const slabW = box.w*0.55;
    const slabH = box.h*0.62;

    ctx.save();
    ctx.fillStyle = 'rgba(122,162,255,0.08)';
    ctx.strokeStyle = 'rgba(122,162,255,0.25)';
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    roundRect(ctx, slabX, slabY, slabW, slabH, 14);
    ctx.fill(); ctx.stroke();

    ctx.fillStyle = 'rgba(233,238,252,0.85)';
    ctx.font = '700 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    ctx.fillText('Acoustic grating region', slabX+12, slabY+18);
    ctx.restore();

    // Draw acoustic wavefronts (diagonal lines)
    ctx.save();
    ctx.strokeStyle = 'rgba(125,255,207,0.35)';
    ctx.lineWidth = 1.2;
    const spacing = 18;
    for(let i=-10;i<40;i++){
      const x0 = slabX + i*spacing;
      const y0 = slabY;
      const x1 = x0 + slabH*0.9;
      const y1 = slabY + slabH;
      ctx.beginPath();
      ctx.moveTo(x0,y0);
      ctx.lineTo(x1,y1);
      ctx.stroke();
    }
    ctx.fillStyle = 'rgba(125,255,207,0.85)';
    ctx.font = '12px var(--mono)';
    ctx.fillText('wavefronts', slabX+12, slabY+36);
    ctx.restore();

    // Incident beam
    const theta = deg2rad(state.theta_deg);
    const beamStart = {x: box.x + box.w*0.06, y: box.y + box.h*0.82};
    const beamMid   = {x: slabX + slabW*0.25, y: slabY + slabH*0.75};
    const beamDir = {x: Math.cos(-theta), y: Math.sin(-theta)}; // up-right
    const beamEnd = {x: slabX + slabW*0.95, y: slabY + slabH*0.25};

    ctx.save();
    ctx.strokeStyle = 'rgba(233,238,252,0.9)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(beamStart.x, beamStart.y);
    ctx.lineTo(beamMid.x, beamMid.y);
    ctx.lineTo(beamEnd.x, beamEnd.y);
    ctx.stroke();

    // Arrow head
    drawArrowHead(ctx, beamEnd.x, beamEnd.y, Math.atan2(beamEnd.y-beamMid.y, beamEnd.x-beamMid.x), 'rgba(233,238,252,0.9)');

    ctx.fillStyle = 'rgba(233,238,252,0.9)';
    ctx.font = '700 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    ctx.fillText('Incident beam', beamStart.x+6, beamStart.y-10);
    ctx.restore();

    // Diffracted (Bragg-reflected) beam (conceptual reflection about grating planes)
    const outAngle = theta; // symmetric for conceptual diagram
    const outStart = {x: slabX + slabW*0.55, y: slabY + slabH*0.55};
    const outEnd   = {x: box.x + box.w*0.92, y: box.y + box.h*0.80 - (box.h*0.45)*Math.sin(outAngle)};
    ctx.save();
    ctx.strokeStyle = 'rgba(122,162,255,0.95)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(outStart.x, outStart.y);
    ctx.lineTo(outEnd.x, outEnd.y);
    ctx.stroke();
    drawArrowHead(ctx, outEnd.x, outEnd.y, Math.atan2(outEnd.y-outStart.y, outEnd.x-outStart.x), 'rgba(122,162,255,0.95)');
    ctx.fillStyle = 'rgba(122,162,255,0.95)';
    ctx.font = '700 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    ctx.fillText('Bragg-diffracted beam', outStart.x+8, outStart.y-10);
    ctx.restore();

    // Angle marker θ
    ctx.save();
    const arcR = 34;
    const arcCx = beamMid.x - 10;
    const arcCy = beamMid.y + 10;
    ctx.strokeStyle = 'rgba(255,207,125,0.9)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(arcCx, arcCy, arcR, -theta, 0, false);
    ctx.stroke();
    ctx.fillStyle = 'rgba(255,207,125,0.95)';
    ctx.font = '700 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    ctx.fillText('θ', arcCx + arcR*0.55, arcCy - arcR*0.25);
    ctx.restore();

    // Effective length annotation
    const L = state.L_mm/1000;
    const Leff = L / Math.max(1e-6, Math.sin(theta));
    ctx.save();
    ctx.fillStyle = 'rgba(185,196,230,0.95)';
    ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    ctx.fillText(`L_eff = L/sinθ`, slabX+12, slabY+slabH-14);
    ctx.fillText(`Example: L_eff ≈ ${ (Leff*1000).toFixed(1) } mm`, slabX+12, slabY+slabH-30);
    ctx.restore();
  }

  function drawArrowHead(ctx, x, y, angle, color){
    ctx.save();
    ctx.translate(x,y);
    ctx.rotate(angle);
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.moveTo(0,0);
    ctx.lineTo(-10, -5);
    ctx.lineTo(-10, 5);
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function renderMainPlot(){
    const {ctx, resize} = mainP;
    const {w,h} = resize();
    ctx.clearRect(0,0,w,h);

    const margin = 14;
    const box = {x: margin, y: margin, w: w-2*margin, h: h-2*margin};

    // Data
    const theta = deg2rad(state.theta_deg);
    const lambda0 = state.lambda0_nm * 1e-9;
    const Ms = state.Ms;

    const Lmax_mm = 60;
    const xs = [];
    const ys = [];
    for(let Lmm=0; Lmm<=Lmax_mm; Lmm+=0.5){
      const Lm = Lmm/1000;
      const R = reflectance(Lm, theta, lambda0, Ms);
      xs.push(Lmm);
      ys.push(R);
    }

    // y range
    const yMax = Math.max(...ys, 1e-12);
    const yMin = 0;

    const axes = drawAxes(
      ctx, box,
      0, Lmax_mm,
      yMin, yMax*1.05,
      "L (mm)",
      "Reflectance ℛ (dimensionless)",
      "ℛ vs L (Bragg satisfied)"
    );

    // Curve
    drawLine(ctx, axes.xMap, axes.yMap, xs, ys, 'rgba(125,255,207,0.95)', 2.6);

    // Current point
    const Lcur = state.L_mm;
    const Rcur = reflectance(Lcur/1000, theta, lambda0, Ms);
    ctx.save();
    ctx.fillStyle = 'rgba(255,207,125,0.95)';
    ctx.strokeStyle = 'rgba(0,0,0,0.35)';
    ctx.lineWidth = 2;
    const X = axes.xMap(Lcur);
    const Y = axes.yMap(Rcur);
    ctx.beginPath();
    ctx.arc(X,Y,5,0,Math.PI*2);
    ctx.fill(); ctx.stroke();

    // Annotation
    ctx.fillStyle = 'rgba(233,238,252,0.9)';
    ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    const txt = `L=${Lcur.toFixed(1)} mm, ℛ=${fmtSI(Rcur)}`;
    ctx.fillText(txt, axes.plot.x+10, axes.plot.y+18);
    ctx.restore();

    drawLegend(ctx, box, [
      {label:"ℛ(L)", color:'rgba(125,255,207,0.95)'},
      {label:"current", color:'rgba(255,207,125,0.95)'}
    ]);
  }

  function renderSecondaryPlot(){
    const {ctx, resize} = secP;
    const {w,h} = resize();
    ctx.clearRect(0,0,w,h);

    const margin = 14;
    const box = {x: margin, y: margin, w: w-2*margin, h: h-2*margin};

    // Data
    const L = state.L_mm/1000;
    const lambda0 = state.lambda0_nm * 1e-9;
    const Ms = state.Ms;

    const xs = [];
    const ys = [];
    for(let th=5; th<=60; th+=0.5){
      const R = reflectance(L, deg2rad(th), lambda0, Ms);
      xs.push(th);
      ys.push(R);
    }

    const yMax = Math.max(...ys, 1e-12);
    const yMin = 0;

    const axes = drawAxes(
      ctx, box,
      5, 60,
      yMin, yMax*1.05,
      "θ (degrees)",
      "Reflectance ℛ (dimensionless)",
      "ℛ vs θ (Bragg satisfied)"
    );

    drawLine(ctx, axes.xMap, axes.yMap, xs, ys, 'rgba(122,162,255,0.95)', 2.6);

    // Current point
    const thCur = state.theta_deg;
    const Rcur = reflectance(L, deg2rad(thCur), lambda0, Ms);
    ctx.save();
    ctx.fillStyle = 'rgba(255,207,125,0.95)';
    ctx.strokeStyle = 'rgba(0,0,0,0.35)';
    ctx.lineWidth = 2;
    const X = axes.xMap(thCur);
    const Y = axes.yMap(Rcur);
    ctx.beginPath();
    ctx.arc(X,Y,5,0,Math.PI*2);
    ctx.fill(); ctx.stroke();

    // Annotation
    ctx.fillStyle = 'rgba(233,238,252,0.9)';
    ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    const txt = `θ=${thCur.toFixed(1)}°, ℛ=${fmtSI(Rcur)}`;
    ctx.fillText(txt, axes.plot.x+10, axes.plot.y+18);
    ctx.restore();

    drawLegend(ctx, box, [
      {label:"ℛ(θ)", color:'rgba(122,162,255,0.95)'},
      {label:"current", color:'rgba(255,207,125,0.95)'}
    ]);
  }

  function renderAll(){
    renderDiagram();
    renderMainPlot();
    renderSecondaryPlot();
  }

  // Resize handling
  let raf = null;
  function onResize(){
    if(raf) cancelAnimationFrame(raf);
    raf = requestAnimationFrame(()=>{ renderAll(); raf=null; });
  }
  window.addEventListener('resize', onResize);

  // Initial render
  renderAll();

  // Smooth scroll for TOC
  document.querySelectorAll('#toc a').forEach(a=>{
    a.addEventListener('click', (e)=>{
      const href = a.getAttribute('href');
      if(!href || !href.startsWith('#')) return;
      const el = document.querySelector(href);
      if(!el) return;
      e.preventDefault();
      el.scrollIntoView({behavior:'smooth', block:'start'});
      history.replaceState(null, '', href);
    });
  });
})();
</script>
</body>
</html>
