<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Diffraction from Periodic Structures: Geometry and Frequency Shifts</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#e9eefc;
      --muted:#b9c3e6;
      --accent:#7aa2ff;
      --accent2:#7dffcf;
      --warn:#ffcc66;
      --danger:#ff6b8a;
      --ok:#7dffcf;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(122,162,255,.18), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(125,255,207,.12), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(255,204,102,.10), transparent 60%),
        linear-gradient(180deg, #070a14, var(--bg));
      line-height:1.55;
    }

    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}

    header{
      padding:28px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }
    .hero{
      background: linear-gradient(135deg, rgba(122,162,255,.18), rgba(125,255,207,.10));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px 22px 18px;
      overflow:hidden;
      position:relative;
    }
    .hero:before{
      content:"";
      position:absolute;
      inset:-2px;
      background:
        radial-gradient(500px 200px at 20% 0%, rgba(255,255,255,.10), transparent 60%),
        radial-gradient(400px 220px at 80% 20%, rgba(255,255,255,.08), transparent 60%);
      pointer-events:none;
      filter: blur(0.2px);
    }
    .hero h1{
      margin:0 0 8px;
      font-size: clamp(1.35rem, 2.2vw, 2.0rem);
      letter-spacing:.2px;
      position:relative;
    }
    .hero p{
      margin:0;
      color:var(--muted);
      max-width: 75ch;
      position:relative;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding:14px 18px 60px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      align-items:start;
    }

    nav.toc{
      position:sticky;
      top:14px;
      align-self:start;
      background: rgba(17,26,51,.72);
      backdrop-filter: blur(10px);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 14px 10px;
      max-height: calc(100vh - 28px);
      overflow:auto;
    }
    nav.toc h2{
      font-size: .95rem;
      margin:0 0 10px;
      color: var(--text);
      letter-spacing:.2px;
    }
    nav.toc ul{
      list-style:none;
      padding:0;
      margin:0;
      display:grid;
      gap:6px;
    }
    nav.toc a{
      display:block;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid transparent;
      color:var(--muted);
      font-size:.92rem;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    nav.toc a:hover{
      background: rgba(122,162,255,.10);
      border-color: rgba(122,162,255,.22);
      transform: translateY(-1px);
      color: var(--text);
      text-decoration:none;
    }

    article{
      background: rgba(17,26,51,.55);
      backdrop-filter: blur(10px);
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px 22px;
      overflow:hidden;
    }

    section{scroll-margin-top: 18px;}
    h2{
      margin: 18px 0 10px;
      font-size: 1.15rem;
      letter-spacing:.2px;
    }
    h3{
      margin: 14px 0 8px;
      font-size: 1.02rem;
      color: var(--text);
    }
    p{margin: 8px 0; color: var(--text);}
    .muted{color:var(--muted)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr;}
      nav.toc{position:relative; top:auto; max-height:none;}
      .grid2{grid-template-columns:1fr;}
    }

    .card{
      background: rgba(15,23,48,.75);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px 12px 10px;
    }
    .callouts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin: 10px 0 6px;
    }
    @media (max-width: 980px){
      .callouts{grid-template-columns:1fr;}
    }
    .callout{
      border-radius:14px;
      padding:12px 12px 10px;
      border:1px solid var(--line);
      background: rgba(15,23,48,.78);
      position:relative;
      overflow:hidden;
    }
    .callout:before{
      content:"";
      position:absolute;
      inset:0;
      background: radial-gradient(500px 200px at 20% 0%, rgba(255,255,255,.06), transparent 60%);
      pointer-events:none;
    }
    .callout h4{
      margin:0 0 6px;
      font-size:.95rem;
      letter-spacing:.2px;
      position:relative;
    }
    .callout ul{margin:8px 0 0; padding-left:18px; color:var(--muted); position:relative;}
    .callout p{color:var(--muted); position:relative;}
    .assumptions h4{color: var(--accent2);}
    .keyeq h4{color: var(--accent);}
    .mistakes h4{color: var(--warn);}
    .final h4{color: var(--ok);}

    .eq{
      font-family: var(--mono);
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      border-radius:12px;
      padding:10px 10px;
      overflow:auto;
      position:relative;
    }
    .eq .copyBtn{
      position:absolute;
      top:8px;
      right:8px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(122,162,255,.12);
      color: var(--text);
      border-radius:10px;
      padding:6px 8px;
      font-size:.82rem;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
    }
    .eq .copyBtn:hover{transform: translateY(-1px); background: rgba(122,162,255,.18);}
    .eq code{white-space:pre; color: #eaf0ff;}

    .controls{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap:10px;
      margin: 10px 0 6px;
    }
    @media (max-width: 980px){
      .controls{grid-template-columns:1fr;}
    }
    label{
      display:block;
      font-size:.86rem;
      color: var(--muted);
      margin-bottom:6px;
    }
    select, input[type="range"], input[type="number"]{
      width:100%;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      padding:10px 10px;
      outline:none;
    }
    input[type="range"]{padding:10px 0;}
    .small{
      font-size:.86rem;
      color: var(--muted);
      margin-top:6px;
    }

    figure{
      margin: 10px 0 0;
      padding: 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(15,23,48,.70);
    }
    figure figcaption{
      margin-top:10px;
      color: var(--muted);
      font-size:.9rem;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .canvasRow{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    @media (min-width: 980px){
      .canvasRow{grid-template-columns: 1fr 1fr;}
      .canvasRow canvas{height:300px;}
    }

    .hr{
      height:1px;
      background: var(--line);
      margin: 14px 0;
    }

    .bullets{
      margin: 8px 0 0;
      padding-left: 18px;
      color: var(--muted);
    }

    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(122,162,255,.10);
      color: var(--text);
      font-size:.82rem;
      margin-right:6px;
    }

    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 30px;
      color: var(--muted);
      font-size:.9rem;
    }

    @media print{
      body{background:#fff; color:#000;}
      header, main, article, nav.toc, figure, .callout, .card{box-shadow:none; backdrop-filter:none;}
      nav.toc{display:none;}
      article{border:1px solid #ddd; background:#fff;}
      .eq{background:#f7f7f7; border:1px solid #ddd;}
      .eq .copyBtn{display:none;}
      canvas{display:none;}
      figure figcaption:after{content:" (Canvas hidden in print)"; color:#666;}
    }
  </style>
</head>
<body>
  <header>
    <div class="hero">
      <h1>Diffraction of Light from Periodic Structures (20.1-1): Geometry + Frequency Shifts</h1>
      <p>
        We’ll treat each periodic structure as a <span class="pill">grating in space</span> and ask two questions:
        <span class="pill">Where do diffracted beams go?</span> and <span class="pill">Do they change frequency?</span>
      </p>
    </div>
  </header>

  <main>
    <nav class="toc" aria-label="Table of contents">
      <h2>Table of contents</h2>
      <ul>
        <li><a href="#quick-summary">Quick Summary</a></li>
        <li><a href="#part0">PART 0 — Concept Primer</a></li>
        <li><a href="#part1">PART 1 — Problem Analysis</a></li>
        <li><a href="#part2">PART 2 — Strategy & Tips</a></li>
        <li><a href="#part3">PART 3 — Full Solution</a></li>
        <li><a href="#part4">PART 4 — Deeper Understanding</a></li>
        <li><a href="#part5">PART 5 — Visualization Guide</a></li>
      </ul>
      <div class="hr"></div>
      <div class="card">
        <div class="muted" style="font-size:.9rem; margin-bottom:8px;">Interactive controls</div>
        <div class="controls" style="grid-template-columns:1fr;">
          <div>
            <label for="structure">Periodic structure</label>
            <select id="structure">
              <option value="travel">a) Acoustic traveling wave (Λ)</option>
              <option value="stand">b) Acoustic standing wave (Λ)</option>
              <option value="sinus">c) Sinusoidal graded-index medium (Λ)</option>
              <option value="layers">d) Stratified alternating layers (Λ)</option>
            </select>
            <div class="small" id="structureNote"></div>
          </div>

          <div>
            <label for="lambdaNm">Optical wavelength λ (nm)</label>
            <input id="lambdaNm" type="number" min="200" max="2000" step="1" value="633"/>
            <div class="small">Example value for plotting; solution stays symbolic.</div>
          </div>

          <div>
            <label for="nMedium">Refractive index n (dimensionless)</label>
            <input id="nMedium" type="number" min="1" max="3" step="0.01" value="1.00"/>
            <div class="small">Use n&gt;1 for diffraction inside a medium.</div>
          </div>

          <div>
            <label for="LambdaUm">Period Λ (µm)</label>
            <input id="LambdaUm" type="range" min="0.5" max="50" step="0.1" value="10"/>
            <div class="small"><span id="LambdaReadout"></span></div>
          </div>

          <div>
            <label for="thetaDeg">Incidence angle θᵢ (deg)</label>
            <input id="thetaDeg" type="range" min="-60" max="60" step="0.5" value="0"/>
            <div class="small"><span id="thetaReadout"></span></div>
          </div>

          <div>
            <label for="faMHz">Acoustic frequency fₐ (MHz) (only for acoustic cases)</label>
            <input id="faMHz" type="range" min="1" max="500" step="1" value="100"/>
            <div class="small"><span id="faReadout"></span></div>
          </div>
        </div>
      </div>
    </nav>

    <article>
      <section id="quick-summary">
        <h2>Quick Summary</h2>
        <ul class="bullets">
          <li><strong>What this is about:</strong> Diffraction of a plane optical wave (wavelength λ) by periodic structures of spatial period Λ.</li>
          <li><strong>Key physics idea:</strong> A periodic structure supplies (or removes) discrete momentum quanta \(m\mathbf{K}\) where \(K = 2\pi/\Lambda\).</li>
          <li><strong>Governing relation (vector form):</strong> \(\mathbf{k}_d = \mathbf{k}_i + m\mathbf{K}\) (phase-matching / grating equation).</li>
          <li><strong>Angle condition (1D grating, same medium):</strong> \(\sin\theta_m = \sin\theta_i + m\,\lambda/(\Lambda n)\).</li>
          <li><strong>Frequency shift rule:</strong> If the grating travels with angular frequency Ω, then \(\omega_d = \omega_i + m\Omega\).</li>
          <li><strong>Traveling acoustic wave:</strong> moving grating ⇒ diffracted orders are Doppler-shifted by ±Ω (first order) or \(m\Omega\) (mth order).</li>
          <li><strong>Standing acoustic wave / static index gratings / static layers:</strong> stationary grating ⇒ no frequency shift (Ω = 0).</li>
          <li><strong>Final result type:</strong> symbolic diffraction-angle and frequency-shift formulas + qualitative discussion per case.</li>
        </ul>
      </section>

      <div class="hr"></div>

      <section id="part0">
        <h2>PART 0 — Concept Primer (theory before solving)</h2>

        <h3>Core definitions (symbols + units)</h3>
        <div class="grid2">
          <div class="card">
            <p><strong>Optical wave:</strong> plane wave with angular frequency ω (rad/s), wavelength λ (m), and wavevector magnitude</p>
            <div class="eq" data-copy="k = 2πn/λ">
              <button class="copyBtn" type="button">Copy</button>
              <code>k = 2π n / λ</code>
            </div>
            <p class="muted">Here n is the refractive index of the medium where diffraction occurs.</p>
          </div>
          <div class="card">
            <p><strong>Periodic structure (grating):</strong> spatial period Λ (m) ⇒ grating wavevector magnitude</p>
            <div class="eq" data-copy="K = 2π/Λ">
              <button class="copyBtn" type="button">Copy</button>
              <code>K = 2π / Λ</code>
            </div>
            <p class="muted">For a 1D grating, \(\mathbf{K}\) points normal to the grating planes (direction of periodicity).</p>
          </div>
        </div>

        <h3>Physical meaning of key quantities</h3>
        <p>
          Think of \(\mathbf{k}\) as the “direction + spatial oscillation rate” of the wave’s phase.
          A periodic structure can add or subtract discrete chunks of spatial phase variation—those are the integer multiples \(m\mathbf{K}\).
          If the structure itself moves in time (like a traveling acoustic wave), it can also exchange energy, shifting the optical frequency by integer multiples of the acoustic frequency.
        </p>

        <h3>Key laws/principles and validity</h3>
        <div class="callouts">
          <div class="callout keyeq">
            <h4>Key phase-matching law (diffraction condition)</h4>
            <p class="muted">
              For a 1D periodic structure, diffracted orders satisfy conservation of the tangential component of wavevector up to integer multiples of \(\mathbf{K}\):
            </p>
            <div class="eq" data-copy="k_d = k_i + mK (vector form: k⃗_d = k⃗_i + mK⃗)">
              <button class="copyBtn" type="button">Copy</button>
              <code>k⃗_d = k⃗_i + m K⃗</code>
            </div>
            <p class="muted">
              This is the same idea as the grating equation, written in wavevector language.
            </p>
          </div>
          <div class="callout assumptions">
            <h4>When this model is valid</h4>
            <ul>
              <li><strong>Linear optics:</strong> medium response is linear; no nonlinear frequency mixing beyond the moving-grating Doppler effect.</li>
              <li><strong>Weak/moderate scattering:</strong> we identify discrete diffracted orders (plane-wave components).</li>
              <li><strong>Single spatial period:</strong> structure is periodic with period Λ (or effectively so over the interaction region).</li>
              <li><strong>Same medium for angles:</strong> the simple \(\sin\theta\) form assumes incident and diffracted waves propagate in the same refractive index n.</li>
            </ul>
          </div>
        </div>

        <h3>Common models/approximations (and why we use them)</h3>
        <p>
          We treat each structure as an effective grating:
          <strong>acoustic waves</strong> create a refractive-index modulation via the photoelastic effect;
          <strong>graded-index sinusoid</strong> is literally an index grating;
          <strong>alternating layers</strong> form a periodic index profile (a “volume grating” / Bragg reflector).
          The wavevector picture is powerful because it immediately gives both <em>angles</em> (momentum matching) and <em>frequency shifts</em> (energy exchange with a moving pattern).
        </p>

        <h3>Mini intuition examples</h3>
        <ul class="bullets">
          <li><strong>Static grating:</strong> It can redirect light (change direction) but cannot change photon energy ⇒ no frequency shift.</li>
          <li><strong>Traveling grating:</strong> Like a moving mirror pattern—scattering from it produces a Doppler-like shift equal to the pattern’s temporal frequency.</li>
        </ul>

        <div class="callout mistakes">
          <h4>What to watch for (typical pitfalls)</h4>
          <ul>
            <li><strong>Mixing λ in vacuum vs in medium:</strong> inside index n, use \(\lambda/n\) as the wavelength in the grating equation.</li>
            <li><strong>Forgetting order sign:</strong> \(m\) can be positive or negative; angles and frequency shifts follow that sign.</li>
            <li><strong>Assuming “any m exists”:</strong> only orders with \(|\sin\theta_m|\le 1\) propagate; others are evanescent.</li>
            <li><strong>Standing wave ≠ traveling wave:</strong> standing wave is stationary in time ⇒ no net frequency shift.</li>
          </ul>
        </div>
      </section>

      <div class="hr"></div>

      <section id="part1">
        <h2>PART 1 — Problem Analysis (no solving yet)</h2>

        <h3>Problem restatement (in plain words)</h3>
        <p>
          An optical plane wave of wavelength λ illuminates several different periodic structures, each with spatial period Λ.
          For each structure, we must describe the diffraction geometry (where the diffracted beams go) and state whether the diffracted light experiences a frequency shift—and what that shift is.
        </p>

        <h3>Given quantities</h3>
        <ul class="bullets">
          <li><strong>Optical wavelength:</strong> λ (given symbolically).</li>
          <li><strong>Structure period:</strong> Λ (given symbolically).</li>
          <li><strong>Structure types:</strong> (a) traveling acoustic wave, (b) standing acoustic wave, (c) sinusoidal index grating, (d) alternating layers (periodic stratified medium).</li>
        </ul>

        <h3>Unknowns / what must be found</h3>
        <ul class="bullets">
          <li><strong>Diffraction directions:</strong> angles \(\theta_m\) (or equivalent wavevector geometry) for diffracted orders m.</li>
          <li><strong>Frequency shifts:</strong> \(\Delta \omega_m\) (or \(\Delta f_m\)) for each case.</li>
        </ul>

        <h3>Relevant principles (and why they apply)</h3>
        <p>
          The structures are periodic, so they impose a discrete spatial Fourier spectrum at wavevector \(K=2\pi/\Lambda\).
          Diffraction is therefore governed by <strong>phase matching</strong> (momentum conservation up to integer multiples of \(K\)).
          Frequency shifts occur only if the structure is <strong>time-dependent</strong> (a traveling acoustic wave), allowing energy exchange.
        </p>
        <p class="muted">
          We do <em>not</em> need full Maxwell boundary-value solutions here; the question asks for geometry and frequency shifts, which the wavevector/Bragg picture captures cleanly.
        </p>

        <div class="callout assumptions">
          <h4>Assumptions we will use</h4>
          <ul>
            <li><strong>Plane-wave optics:</strong> incident field is a plane wave; diffracted fields are plane-wave orders.</li>
            <li><strong>1D periodicity:</strong> the structure varies sinusoidally or periodically along one axis with period Λ.</li>
            <li><strong>Same propagation medium:</strong> incident and diffracted waves propagate in refractive index n (we keep n symbolic).</li>
            <li><strong>Small modulation (conceptual):</strong> enough to produce diffraction, but not so strong that we must solve coupled-wave amplitudes to answer geometry.</li>
          </ul>
        </div>

        <h3>Possible approaches (compare briefly)</h3>
        <ul class="bullets">
          <li><strong>Wavevector (k-space) phase matching:</strong> Fast, geometric, directly gives angles and frequency shifts; best for this question.</li>
          <li><strong>Real-space grating equation:</strong> Equivalent for angles; less direct for moving gratings and frequency shifts.</li>
          <li><strong>Coupled-wave / matrix optics:</strong> Needed for reflectivity/efficiency vs thickness; overkill for “geometry + frequency shift”.</li>
        </ul>

        <p><strong>Chosen approach:</strong> wavevector phase matching + moving-grating energy exchange, because it answers exactly what’s asked with minimal machinery.</p>
      </section>

      <div class="hr"></div>

      <section id="part2">
        <h2>PART 2 — Strategy & Tips (roadmap only)</h2>

        <ol class="bullets">
          <li><strong>Model each structure as a grating:</strong> identify whether it is static or traveling; set \(K=2\pi/\Lambda\) and (if traveling) \(\Omega\).</li>
          <li><strong>Write the phase-matching condition:</strong> use \(\mathbf{k}_d=\mathbf{k}_i+m\mathbf{K}\) to relate diffracted and incident wavevectors.</li>
          <li><strong>Convert to angles:</strong> for 1D geometry, extract \(\sin\theta_m\) from the transverse component; include refractive index n.</li>
          <li><strong>Check which orders propagate:</strong> enforce \(|\sin\theta_m|\le 1\).</li>
          <li><strong>Determine frequency shift:</strong> if the grating travels, apply \(\omega_d=\omega_i+m\Omega\); if static, \(\omega_d=\omega_i\).</li>
          <li><strong>Interpret physically:</strong> explain why traveling patterns shift frequency (Doppler-like) and why static patterns do not.</li>
          <li><strong>Summarize per case:</strong> give geometry statement + frequency shift statement for (a)–(d).</li>
        </ol>

        <div class="callout mistakes">
          <h4>Quick tips + common mistakes</h4>
          <ul>
            <li><strong>Tip:</strong> Treat “standing wave” as two counter-propagating traveling waves—net pattern is stationary, so no net shift in the scattered light frequency.</li>
            <li><strong>Mistake:</strong> Using \(\lambda\) in vacuum when diffraction happens inside a medium; use \(\lambda/n\) in the angle formula.</li>
            <li><strong>Tip:</strong> Keep the sign of m consistent: it controls both the diffracted direction and the sign of the frequency shift for traveling gratings.</li>
          </ul>
        </div>
      </section>

      <div class="hr"></div>

      <section id="part3">
        <h2>PART 3 — Full Solution (detailed + teaching)</h2>

        <h3>Qualitative intuition first</h3>
        <p>
          Any periodic structure acts like a “momentum ladder”: it can redirect light into discrete angles (orders).
          But only a structure that <em>changes in time</em> can exchange energy with the light and shift its frequency.
          So we expect: <strong>traveling acoustic wave → frequency shift</strong>; <strong>standing acoustic wave and static index/layer gratings → no shift</strong>.
        </p>

        <h3>Step 1: Define the geometry and symbols</h3>
        <p>
          Let the periodicity be along the x-direction, so the grating wavevector is
          \(\mathbf{K}=K\,\hat{\mathbf{x}}\) with \(K=2\pi/\Lambda\).
          The incident optical wavevector \(\mathbf{k}_i\) has magnitude \(k=2\pi n/\lambda\) and makes an angle \(\theta_i\) with the grating normal (x-axis) in the x–z plane.
          A diffracted order m has wavevector \(\mathbf{k}_m\) (also magnitude ≈ k if frequency is unchanged; slightly different if shifted).
        </p>

        <div class="callout keyeq">
          <h4>Master diffraction condition (1D periodicity)</h4>
          <div class="eq" data-copy="k⃗_m = k⃗_i + m K⃗,  with  K = 2π/Λ">
            <button class="copyBtn" type="button">Copy</button>
            <code>k⃗_m = k⃗_i + m K⃗,  with  K = 2π/Λ</code>
          </div>
          <p class="muted">
            Meaning: the grating supplies discrete transverse momentum \(mK\).
          </p>
        </div>

        <h3>Step 2: Convert phase matching into an angle formula</h3>
        <p>
          In the x–z plane, the x-component of the optical wavevector is \(k\sin\theta\) (taking \(\theta\) measured from the z-axis toward +x, or equivalently using a consistent convention).
          The grating adds \(mK\) in x, so:
        </p>

        <div class="eq" data-copy="k sin(θ_m) = k sin(θ_i) + mK">
          <button class="copyBtn" type="button">Copy</button>
          <code>k sin(θ_m) = k sin(θ_i) + mK</code>
        </div>

        <p>
          Divide by \(k=2\pi n/\lambda\) and substitute \(K=2\pi/\Lambda\):
        </p>

        <div class="eq" data-copy="sin(θ_m) = sin(θ_i) + m (λ/(nΛ))">
          <button class="copyBtn" type="button">Copy</button>
          <code>sin(θ_m) = sin(θ_i) + m (λ/(nΛ))</code>
        </div>

        <p class="muted">
          What we did: we translated the vector condition into a scalar condition on the transverse component.
          Why: diffraction angles are determined by transverse phase matching.
        </p>

        <h3>Step 3: Frequency shift rule for moving gratings</h3>
        <p>
          If the periodic structure is a traveling wave, its refractive-index modulation is time-dependent, typically of the form
          \(\Delta n \propto \cos(Kx - \Omega t)\).
          Scattering from this moving pattern can exchange energy \(\hbar\Omega\) per grating quantum, giving:
        </p>

        <div class="eq" data-copy="ω_m = ω_i + mΩ  (equivalently: Δf_m = m f_a)">
          <button class="copyBtn" type="button">Copy</button>
          <code>ω_m = ω_i + mΩ  (equivalently: Δf_m = m f_a)</code>
        </div>

        <p class="muted">
          Physical meaning: the traveling grating is like a “phonon” field; absorbing/emitting m phonons shifts the optical frequency by \(m\Omega\).
        </p>

        <div class="callout assumptions">
          <h4>Important note about magnitudes</h4>
          <p class="muted">
            For typical acousto-optic devices, \(\Omega \ll \omega_i\), so the change in optical wavelength is tiny.
            Geometry is still well captured by the grating equation using the original k, while the frequency shift is accurately \(m\Omega\).
          </p>
        </div>

        <h3>Now apply to each structure (a)–(d)</h3>

        <h3>(a) Acoustic traveling wave of wavelength Λ</h3>
        <p>
          A traveling acoustic wave produces a traveling refractive-index grating:
          \(\Delta n(x,t)\propto \cos(Kx-\Omega t)\).
          Therefore:
        </p>
        <ul class="bullets">
          <li><strong>Geometry (diffracted angles):</strong> orders m satisfy
            <span class="muted">\( \sin\theta_m = \sin\theta_i + m\,\lambda/(n\Lambda)\).</span>
          </li>
          <li><strong>Frequency shift(s):</strong> each order is shifted by
            <span class="muted">\( \Delta\omega_m = m\Omega\) (or \(\Delta f_m = m f_a\)).</span>
          </li>
        </ul>
        <p class="muted">
          Sign: \(m&gt;0\) corresponds to adding +mK momentum and +mΩ energy (one consistent convention); \(m&lt;0\) gives the opposite shift.
        </p>

        <h3>(b) Acoustic standing wave of wavelength Λ</h3>
        <p>
          A standing wave can be written as the sum of two counter-propagating traveling waves:
          \(\cos(Kx)\cos(\Omega t)\).
          The spatial pattern \(\cos(Kx)\) is stationary (nodes fixed in space), so the grating does not translate.
          In the usual diffraction picture, the dominant effect is a <strong>static index grating</strong> at period Λ.
        </p>
        <ul class="bullets">
          <li><strong>Geometry:</strong> same grating equation
            <span class="muted">\( \sin\theta_m = \sin\theta_i + m\,\lambda/(n\Lambda)\).</span>
          </li>
          <li><strong>Frequency shift(s):</strong> <strong>no net frequency shift</strong> for the diffracted light:
            <span class="muted">\( \Delta\omega_m = 0\).</span>
          </li>
        </ul>
        <p class="muted">
          Intuition: the pattern is not “moving past” the light, so there is no Doppler-like energy exchange.
        </p>

        <h3>(c) Sinusoidal graded-index transparent medium (period Λ)</h3>
        <p>
          Here the refractive index varies as \(n(x)=n_0+\Delta n\cos(Kx)\) with no time dependence.
          This is a classic <strong>static volume phase grating</strong>.
        </p>
        <ul class="bullets">
          <li><strong>Geometry:</strong> diffracted orders satisfy
            <span class="muted">\( \sin\theta_m = \sin\theta_i + m\,\lambda/(n\Lambda)\).</span>
          </li>
          <li><strong>Frequency shift(s):</strong> none:
            <span class="muted">\( \Delta\omega_m = 0\).</span>
          </li>
        </ul>

        <h3>(d) Stratified medium: alternating layers of two indices (period Λ)</h3>
        <p>
          Alternating layers form a periodic index profile along the layer normal—again a <strong>static</strong> periodic structure.
          This is the basis of distributed Bragg reflectors (DBRs) and Bragg gratings: strong reflection occurs near the Bragg condition.
        </p>
        <ul class="bullets">
          <li><strong>Geometry:</strong> the same momentum-matching idea applies. In particular, strong coupling often occurs in the <strong>Bragg regime</strong>, where a specific order (often back-reflection) is phase matched. A common special case is near-normal incidence, where the Bragg condition for strong reflection is approximately
            <span class="muted">\(2 n_{\text{eff}} \Lambda \approx m\lambda\)</span>
            (for appropriate definition of \(\Lambda\) relative to layer spacing and the relevant Fourier component).
          </li>
          <li><strong>Frequency shift(s):</strong> none:
            <span class="muted">\( \Delta\omega_m = 0\).</span>
          </li>
        </ul>
        <p class="muted">
          Why “Bragg” matters here: layered media are typically thick (many periods), so only certain orders satisfy phase matching strongly—often producing narrowband reflection rather than many transmitted orders.
        </p>

        <div class="callout final">
          <h4>Final answer (boxed summary)</h4>
          <div class="eq" data-copy="Angles:  sin(θ_m) = sin(θ_i) + m (λ/(nΛ))  (propagating if |sin(θ_m)| ≤ 1)
Frequency: traveling acoustic wave → Δf_m = m f_a (Δω_m = mΩ); standing acoustic wave / static index grating / static layers → Δf_m = 0">
            <button class="copyBtn" type="button">Copy</button>
            <code>Angles:  sin(θ_m) = sin(θ_i) + m (λ/(nΛ))  (propagating if |sin(θ_m)| ≤ 1)
Frequency: traveling acoustic wave → Δf_m = m f_a (Δω_m = mΩ); standing acoustic wave / static index grating / static layers → Δf_m = 0</code>
          </div>
          <p class="muted">
            Geometry is set by spatial periodicity (Λ). Frequency shifts require temporal periodicity (traveling wave).
          </p>
        </div>

        <h3>Sanity checks</h3>
        <ul class="bullets">
          <li><strong>Units:</strong> \(\lambda/(n\Lambda)\) is dimensionless, so it can add to \(\sin\theta\). \(\Delta f_m = m f_a\) has units of Hz.</li>
          <li><strong>Limiting case Λ → ∞:</strong> \(K\to 0\) ⇒ no diffraction; only m=0 survives.</li>
          <li><strong>Small λ/Λ:</strong> diffraction angles are small and only a few orders propagate—consistent with intuition.</li>
          <li><strong>Static structures:</strong> no time dependence ⇒ no energy exchange ⇒ no frequency shift.</li>
        </ul>

        <p>
          Connection to the diagram and plots below: the diagram shows the incident beam and the allowed diffracted orders.
          The main plot shows \(\theta_m\) versus order m for your chosen λ, Λ, n, and \(\theta_i\).
          The secondary plot shows \(\Delta f_m\) versus m—nonzero only for the traveling acoustic case.
        </p>
      </section>

      <div class="hr"></div>

      <section id="part4">
        <h2>PART 4 — Deeper Understanding (theory around the result)</h2>

        <h3>Re-interpreting the final formulas</h3>
        <p>
          The angle formula
          \(\sin\theta_m = \sin\theta_i + m\,\lambda/(n\Lambda)\)
          says each order is separated in \(\sin\theta\) by a fixed step \(\Delta(\sin\theta)=\lambda/(n\Lambda)\).
          So:
          smaller Λ (tighter period) ⇒ larger angular spread; larger n ⇒ smaller spread (because the wavelength in the medium is shorter).
        </p>
        <p>
          The frequency rule \(\Delta f_m = m f_a\) is a clean signature of a traveling grating:
          the optical field is “beating” with a moving index pattern, so it picks up the pattern’s temporal frequency.
        </p>

        <h3>Parameter effects (connect to the interactive plots)</h3>
        <ul class="bullets">
          <li><strong>Decrease Λ:</strong> orders move farther apart in angle; fewer orders remain propagating because \(|\sin\theta_m|\le 1\).</li>
          <li><strong>Increase |θᵢ|:</strong> the whole set of orders shifts; some orders can disappear (become evanescent) on one side.</li>
          <li><strong>Increase n:</strong> angular spacing shrinks (since \(\lambda/n\) is smaller).</li>
          <li><strong>Change fₐ (traveling acoustic only):</strong> frequency shifts scale linearly with m and with fₐ; angles do not depend on fₐ (they depend on Λ).</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p class="muted">
          You can derive the same results by expanding the periodic structure as a Fourier series and using the fact that multiplying the field by a periodic phase/amplitude modulation creates sidebands in spatial frequency (and, for traveling waves, in temporal frequency). The discrete sidebands correspond exactly to the integer orders m.
        </p>

        <h3>Concept checks (quick self-test)</h3>
        <ul class="bullets">
          <li><strong>Q:</strong> Why can a static grating change direction but not frequency? <strong>A:</strong> It can exchange momentum (spatial periodicity) but not energy (no time dependence).</li>
          <li><strong>Q:</strong> What determines whether order m propagates? <strong>A:</strong> Whether \(|\sin\theta_m|\le 1\); otherwise it is evanescent.</li>
          <li><strong>Q:</strong> If Λ is halved, what happens to angular spacing? <strong>A:</strong> It doubles in \(\sin\theta\) spacing: \(\Delta(\sin\theta)=\lambda/(n\Lambda)\).</li>
          <li><strong>Q:</strong> For a traveling acoustic wave, what is the shift of the +1 order? <strong>A:</strong> \(\Delta f_{+1}=+f_a\) (sign depends on the chosen m convention).</li>
        </ul>
      </section>

      <div class="hr"></div>

      <section id="part5">
        <h2>PART 5 — Visualization Guide (how to read the plots)</h2>

        <div class="card">
          <p class="muted" style="margin:0 0 8px;">
            The canvases below update live when you change Λ, θᵢ, λ, n, and the structure type.
            (λ and n are “example values” for plotting; the symbolic solution above is general.)
          </p>
        </div>

        <figure>
          <div class="canvasRow">
            <canvas id="diagram" aria-label="Diffraction geometry diagram"></canvas>
            <canvas id="plotAngles" aria-label="Plot of diffraction angle versus order"></canvas>
          </div>
          <canvas id="plotFreq" aria-label="Plot of frequency shift versus order" style="margin-top:12px; height:300px;"></canvas>
          <figcaption>
            <strong>Left:</strong> geometry diagram (incident beam and diffracted orders). <strong>Right:</strong> diffraction angles θₘ vs order m.
            <strong>Bottom:</strong> frequency shift Δfₘ vs m (nonzero only for traveling acoustic wave).
          </figcaption>
        </figure>

        <h3>What each canvas shows</h3>
        <ul class="bullets">
          <li><strong>Diagram:</strong> A 1D grating with period Λ; incident ray at θᵢ; diffracted rays for orders m that propagate.</li>
          <li><strong>Main plot (θₘ vs m):</strong> Points for each integer order m in a chosen range; only propagating orders are highlighted.</li>
          <li><strong>Secondary plot (Δfₘ vs m):</strong> A line/points showing Δfₘ = m fₐ for traveling acoustic; otherwise Δfₘ = 0.</li>
        </ul>

        <h3>Interactive controls</h3>
        <ul class="bullets">
          <li><strong>Structure selector:</strong> toggles whether frequency shifts are present (traveling acoustic) or absent (others).</li>
          <li><strong>Λ slider:</strong> changes angular spacing of orders in the main plot and the ray fan in the diagram.</li>
          <li><strong>θᵢ slider:</strong> shifts the entire set of diffracted angles left/right.</li>
          <li><strong>fₐ slider:</strong> changes the slope of Δfₘ vs m only for the traveling acoustic case.</li>
        </ul>
      </section>
    </article>
  </main>

  <footer>
    <p>
      Built as a learning-first mini-lecture: wavevector phase matching gives diffraction geometry; time dependence gives frequency shifts.
    </p>
  </footer>

  <script>
    // ---------- Copy buttons ----------
    (function(){
      function copyText(text){
        if(navigator.clipboard && navigator.clipboard.writeText){
          navigator.clipboard.writeText(text);
        }else{
          const ta=document.createElement('textarea');
          ta.value=text;
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
        }
      }
      document.querySelectorAll('.eq').forEach(eq=>{
        const btn = eq.querySelector('.copyBtn');
        if(!btn) return;
        btn.addEventListener('click', ()=>{
          const text = eq.getAttribute('data-copy') || eq.innerText.trim();
          copyText(text);
          const old = btn.textContent;
          btn.textContent = "Copied";
          setTimeout(()=>btn.textContent=old, 900);
        });
      });
    })();

    // ---------- Canvas utilities ----------
    function setupCanvas(canvas){
      const ctx = canvas.getContext('2d');
      function resize(){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        canvas.width = Math.max(2, Math.floor(rect.width * dpr));
        canvas.height = Math.max(2, Math.floor(rect.height * dpr));
        ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
      }
      resize();
      return {ctx, resize};
    }

    function clear(ctx, w, h){
      ctx.clearRect(0,0,w,h);
    }

    function roundNice(x){
      const pow = Math.pow(10, Math.floor(Math.log10(Math.abs(x)||1)));
      const n = x / pow;
      let step;
      if(n < 1.5) step = 1;
      else if(n < 3.5) step = 2;
      else if(n < 7.5) step = 5;
      else step = 10;
      return step * pow;
    }

    function drawAxes(ctx, rect, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
      const {x,y,w,h} = rect;
      // panel
      ctx.save();
      ctx.fillStyle = 'rgba(0,0,0,0.18)';
      ctx.strokeStyle = 'rgba(255,255,255,0.10)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(x,y,w,h,12);
      ctx.fill();
      ctx.stroke();

      // title
      ctx.fillStyle = 'rgba(233,238,252,0.95)';
      ctx.font = '600 13px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText(title, x+12, y+18);

      // plot area
      const padL=52, padR=16, padT=30, padB=42;
      const px = x+padL, py = y+padT, pw = w-padL-padR, ph = h-padT-padB;

      // grid + ticks
      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.lineWidth = 1;

      const xRange = xMax-xMin;
      const yRange = yMax-yMin;

      const xStep = roundNice(xRange/6);
      const yStep = roundNice(yRange/6);

      // x ticks
      ctx.fillStyle = 'rgba(185,195,230,0.95)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';

      for(let xv = Math.ceil(xMin/xStep)*xStep; xv <= xMax+1e-12; xv += xStep){
        const t = (xv-xMin)/xRange;
        const X = px + t*pw;
        // gridline
        ctx.beginPath();
        ctx.moveTo(X, py);
        ctx.lineTo(X, py+ph);
        ctx.stroke();
        // tick
        ctx.strokeStyle = 'rgba(255,255,255,0.14)';
        ctx.beginPath();
        ctx.moveTo(X, py+ph);
        ctx.lineTo(X, py+ph+6);
        ctx.stroke();
        ctx.strokeStyle = 'rgba(255,255,255,0.08)';
        // label
        const s = (Math.abs(xv) < 1e-9) ? "0" : (Math.round(xv*1000)/1000).toString();
        ctx.fillText(s, X-10, py+ph+20);
      }

      // y ticks
      for(let yv = Math.ceil(yMin/yStep)*yStep; yv <= yMax+1e-12; yv += yStep){
        const t = 1 - (yv-yMin)/yRange;
        const Y = py + t*ph;
        // gridline
        ctx.beginPath();
        ctx.moveTo(px, Y);
        ctx.lineTo(px+pw, Y);
        ctx.stroke();
        // tick
        ctx.strokeStyle = 'rgba(255,255,255,0.14)';
        ctx.beginPath();
        ctx.moveTo(px-6, Y);
        ctx.lineTo(px, Y);
        ctx.stroke();
        ctx.strokeStyle = 'rgba(255,255,255,0.08)';
        // label
        const s = (Math.abs(yv) < 1e-9) ? "0" : (Math.round(yv*1000)/1000).toString();
        ctx.fillText(s, px-44, Y+4);
      }

      // axes lines
      ctx.strokeStyle = 'rgba(255,255,255,0.22)';
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(px, py+ph);
      ctx.lineTo(px+pw, py+ph);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(px, py);
      ctx.lineTo(px, py+ph);
      ctx.stroke();

      // labels
      ctx.fillStyle = 'rgba(233,238,252,0.92)';
      ctx.font = '600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText(xLabel, px+pw/2-30, py+ph+36);

      ctx.save();
      ctx.translate(px-44, py+ph/2+30);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();

      ctx.restore();

      return {px, py, pw, ph, xMin, xMax, yMin, yMax};
    }

    function mapX(frame, x){
      return frame.px + (x-frame.xMin)/(frame.xMax-frame.xMin)*frame.pw;
    }
    function mapY(frame, y){
      return frame.py + (1-(y-frame.yMin)/(frame.yMax-frame.yMin))*frame.ph;
    }

    // ---------- Physics helpers ----------
    function deg2rad(d){ return d*Math.PI/180; }
    function rad2deg(r){ return r*180/Math.PI; }

    function computeOrders(params){
      const {lambda, n, Lambda, thetaIdeg} = params;
      const thetaI = deg2rad(thetaIdeg);
      const step = lambda/(n*Lambda); // dimensionless
      // choose a reasonable order range for plotting
      const mMax = 10;
      const orders = [];
      for(let m=-mMax; m<=mMax; m++){
        const s = Math.sin(thetaI) + m*step;
        const propagating = Math.abs(s) <= 1;
        const thetaM = propagating ? Math.asin(s) : NaN;
        orders.push({m, s, thetaM, propagating});
      }
      return orders;
    }

    function freqShiftHz(structure, m, faHz){
      if(structure === 'travel') return m*faHz;
      return 0;
    }

    // ---------- Drawing: diagram ----------
    function drawDiagram(ctx, canvas, params, orders, structure){
      const w = canvas.getBoundingClientRect().width;
      const h = canvas.getBoundingClientRect().height;

      clear(ctx, w, h);

      // background panel
      ctx.save();
      ctx.fillStyle = 'rgba(0,0,0,0.18)';
      ctx.strokeStyle = 'rgba(255,255,255,0.10)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(0,0,w,h,12);
      ctx.fill();
      ctx.stroke();

      // title
      ctx.fillStyle = 'rgba(233,238,252,0.95)';
      ctx.font = '600 13px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Diagram: incident beam + diffracted orders', 12, 18);

      // coordinate system
      const cx = w*0.52, cy = h*0.62;
      const scale = Math.min(w,h)*0.34;

      // grating planes (vertical lines) representing periodicity along x
      const planeX = w*0.28;
      ctx.strokeStyle = 'rgba(122,162,255,0.35)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(planeX, 40);
      ctx.lineTo(planeX, h-20);
      ctx.stroke();

      // small ticks to suggest period
      ctx.strokeStyle = 'rgba(122,162,255,0.22)';
      ctx.lineWidth = 1;
      for(let i=0;i<10;i++){
        const yy = 55 + i*(h-90)/9;
        ctx.beginPath();
        ctx.moveTo(planeX-10, yy);
        ctx.lineTo(planeX+10, yy);
        ctx.stroke();
      }

      // label Λ
      ctx.fillStyle = 'rgba(185,195,230,0.95)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
      ctx.fillText('period Λ', planeX-22, 36);

      // incident ray
      const thetaI = deg2rad(params.thetaIdeg);
      const incLen = scale*1.05;
      const incStart = {x: planeX- incLen*Math.cos(thetaI), y: cy - incLen*Math.sin(thetaI)};
      const incEnd = {x: planeX, y: cy};

      function arrow(from, to, color, width){
        ctx.strokeStyle = color;
        ctx.lineWidth = width;
        ctx.beginPath();
        ctx.moveTo(from.x, from.y);
        ctx.lineTo(to.x, to.y);
        ctx.stroke();
        // arrowhead
        const ang = Math.atan2(to.y-from.y, to.x-from.x);
        const ah = 10;
        ctx.fillStyle = color;
        ctx.beginPath();
        ctx.moveTo(to.x, to.y);
        ctx.lineTo(to.x - ah*Math.cos(ang-0.35), to.y - ah*Math.sin(ang-0.35));
        ctx.lineTo(to.x - ah*Math.cos(ang+0.35), to.y - ah*Math.sin(ang+0.35));
        ctx.closePath();
        ctx.fill();
      }

      arrow(incStart, incEnd, 'rgba(125,255,207,0.85)', 2.6);
      ctx.fillStyle = 'rgba(125,255,207,0.95)';
      ctx.fillText('incident (θᵢ)', incStart.x+6, incStart.y-6);

      // diffracted rays (show propagating orders, emphasize m=0, ±1)
      const outLen = scale*1.05;
      const origin = {x: planeX, y: cy};

      const show = orders.filter(o=>o.propagating);
      // sort by |m| so central orders drawn last (on top)
      show.sort((a,b)=>Math.abs(b.m)-Math.abs(a.m));

      for(const o of show){
        const th = o.thetaM;
        const to = {x: origin.x + outLen*Math.cos(th), y: origin.y + outLen*Math.sin(th)};
        const isMain = (o.m===0);
        const isFirst = (Math.abs(o.m)===1);
        const col = isMain ? 'rgba(255,204,102,0.90)' : (isFirst ? 'rgba(122,162,255,0.85)' : 'rgba(233,238,252,0.35)');
        const lw = isMain ? 3.0 : (isFirst ? 2.4 : 1.4);
        arrow(origin, to, col, lw);

        if(isMain || isFirst){
          ctx.fillStyle = col;
          const label = `m=${o.m}`;
          ctx.fillText(label, to.x + (o.m>=0?6:-34), to.y + (o.m>=0?-6:14));
        }
      }

      // frequency shift note
      ctx.fillStyle = 'rgba(185,195,230,0.95)';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      const shiftText = (structure==='travel')
        ? 'Traveling grating: diffracted orders shift by Δf = m fₐ'
        : 'Static grating: Δf = 0 for all orders';
      ctx.fillText(shiftText, 12, h-14);

      ctx.restore();
    }

    // ---------- Drawing: plot angles ----------
    function drawPlotAngles(ctx, canvas, params, orders){
      const w = canvas.getBoundingClientRect().width;
      const h = canvas.getBoundingClientRect().height;
      clear(ctx, w, h);

      // Determine y-range from possible angles
      const yMin = -90, yMax = 90;
      const xMin = -10, xMax = 10;

      const frame = drawAxes(
        ctx,
        {x:0,y:0,w:w,h:h},
        xMin, xMax, yMin, yMax,
        'order m (integer)',
        'θₘ (deg)',
        'Main plot: diffraction angle vs order'
      );

      // legend
      ctx.save();
      ctx.fillStyle = 'rgba(233,238,252,0.92)';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Legend:', frame.px+frame.pw-120, frame.py+14);
      function legDot(x,y,color,text){
        ctx.fillStyle=color;
        ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
        ctx.fillStyle='rgba(185,195,230,0.95)';
        ctx.fillText(text, x+10, y+4);
      }
      legDot(frame.px+frame.pw-110, frame.py+30, 'rgba(125,255,207,0.9)', 'propagating');
      legDot(frame.px+frame.pw-110, frame.py+48, 'rgba(255,107,138,0.9)', 'evanescent');
      ctx.restore();

      // plot points
      for(const o of orders){
        const x = o.m;
        const y = o.propagating ? rad2deg(o.thetaM) : (o.s>1 ? 90 : -90);
        const X = mapX(frame, x);
        const Y = mapY(frame, y);

        ctx.save();
        ctx.fillStyle = o.propagating ? 'rgba(125,255,207,0.9)' : 'rgba(255,107,138,0.9)';
        ctx.strokeStyle = 'rgba(0,0,0,0.35)';
        ctx.lineWidth = 1;
        ctx.beginPath();
        ctx.arc(X, Y, o.propagating ? 4.5 : 3.8, 0, Math.PI*2);
        ctx.fill();
        ctx.stroke();
        ctx.restore();
      }

      // highlight incidence angle line for m=0
      const m0 = orders.find(o=>o.m===0);
      if(m0 && m0.propagating){
        const X = mapX(frame, 0);
        const Y = mapY(frame, rad2deg(m0.thetaM));
        ctx.save();
        ctx.strokeStyle = 'rgba(255,204,102,0.75)';
        ctx.lineWidth = 2;
        ctx.setLineDash([6,5]);
        ctx.beginPath();
        ctx.moveTo(frame.px, Y);
        ctx.lineTo(frame.px+frame.pw, Y);
        ctx.stroke();
        ctx.setLineDash([]);
        ctx.fillStyle = 'rgba(255,204,102,0.95)';
        ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
        ctx.fillText('m=0', X+8, Y-8);
        ctx.restore();
      }
    }

    // ---------- Drawing: plot frequency shifts ----------
    function drawPlotFreq(ctx, canvas, params, structure){
      const w = canvas.getBoundingClientRect().width;
      const h = canvas.getBoundingClientRect().height;
      clear(ctx, w, h);

      const mMax = 10;
      const faHz = params.faMHz * 1e6;

      // y-range
      let yMin, yMax;
      if(structure === 'travel'){
        yMin = -mMax*params.faMHz;
        yMax =  mMax*params.faMHz;
        // pad
        yMin *= 1.1; yMax *= 1.1;
      }else{
        yMin = -1; yMax = 1;
      }

      const frame = drawAxes(
        ctx,
        {x:0,y:0,w:w,h:h},
        -mMax, mMax, yMin, yMax,
        'order m (integer)',
        'Δfₘ (MHz)',
        'Secondary plot: frequency shift vs order'
      );

      // plot line and points
      ctx.save();
      ctx.strokeStyle = (structure==='travel') ? 'rgba(122,162,255,0.85)' : 'rgba(185,195,230,0.35)';
      ctx.lineWidth = 2;

      ctx.beginPath();
      for(let m=-mMax; m<=mMax; m++){
        const dfMHz = freqShiftHz(structure, m, faHz)/1e6;
        const X = mapX(frame, m);
        const Y = mapY(frame, dfMHz);
        if(m===-mMax) ctx.moveTo(X,Y);
        else ctx.lineTo(X,Y);
      }
      ctx.stroke();

      for(let m=-mMax; m<=mMax; m++){
        const dfMHz = freqShiftHz(structure, m, faHz)/1e6;
        const X = mapX(frame, m);
        const Y = mapY(frame, dfMHz);
        ctx.fillStyle = (structure==='travel') ? 'rgba(122,162,255,0.9)' : 'rgba(185,195,230,0.55)';
        ctx.beginPath();
        ctx.arc(X,Y,4,0,Math.PI*2);
        ctx.fill();
      }

      // annotation
      ctx.fillStyle = 'rgba(233,238,252,0.92)';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      const note = (structure==='travel')
        ? 'Traveling acoustic wave: Δfₘ = m fₐ'
        : 'Static/standing structures: Δfₘ = 0';
      ctx.fillText(note, frame.px+10, frame.py+18);

      ctx.restore();
    }

    // ---------- UI + render loop ----------
    const el = {
      structure: document.getElementById('structure'),
      lambdaNm: document.getElementById('lambdaNm'),
      nMedium: document.getElementById('nMedium'),
      LambdaUm: document.getElementById('LambdaUm'),
      thetaDeg: document.getElementById('thetaDeg'),
      faMHz: document.getElementById('faMHz'),
      LambdaReadout: document.getElementById('LambdaReadout'),
      thetaReadout: document.getElementById('thetaReadout'),
      faReadout: document.getElementById('faReadout'),
      structureNote: document.getElementById('structureNote'),
      diagram: document.getElementById('diagram'),
      plotAngles: document.getElementById('plotAngles'),
      plotFreq: document.getElementById('plotFreq')
    };

    const canv = {
      diagram: setupCanvas(el.diagram),
      plotAngles: setupCanvas(el.plotAngles),
      plotFreq: setupCanvas(el.plotFreq)
    };

    function getParams(){
      const lambda = parseFloat(el.lambdaNm.value) * 1e-9; // m
      const n = parseFloat(el.nMedium.value);
      const Lambda = parseFloat(el.LambdaUm.value) * 1e-6; // m
      const thetaIdeg = parseFloat(el.thetaDeg.value);
      const faMHz = parseFloat(el.faMHz.value);
      return {lambda, n, Lambda, thetaIdeg, faMHz};
    }

    function updateReadouts(params){
      el.LambdaReadout.textContent = `Λ = ${parseFloat(el.LambdaUm.value).toFixed(1)} µm`;
      el.thetaReadout.textContent = `θᵢ = ${params.thetaIdeg.toFixed(1)}°`;
      el.faReadout.textContent = `fₐ = ${params.faMHz.toFixed(0)} MHz`;

      const s = el.structure.value;
      const note = {
        travel: 'Moving index grating → angles + Doppler-like frequency shifts.',
        stand: 'Stationary pattern → angles only; no net frequency shift.',
        sinus: 'Static sinusoidal index → classic phase grating; no frequency shift.',
        layers: 'Static layered periodic medium → Bragg/volume grating behavior; no frequency shift.'
      }[s];
      el.structureNote.textContent = note;
    }

    function render(){
      const params = getParams();
      const structure = el.structure.value;

      updateReadouts(params);

      const orders = computeOrders(params);

      // resize canvases (responsive)
      canv.diagram.resize();
      canv.plotAngles.resize();
      canv.plotFreq.resize();

      drawDiagram(canv.diagram.ctx, el.diagram, params, orders, structure);
      drawPlotAngles(canv.plotAngles.ctx, el.plotAngles, params, orders);
      drawPlotFreq(canv.plotFreq.ctx, el.plotFreq, params, structure);
    }

    // events
    ['change','input'].forEach(evt=>{
      el.structure.addEventListener(evt, render);
      el.lambdaNm.addEventListener(evt, render);
      el.nMedium.addEventListener(evt, render);
      el.LambdaUm.addEventListener(evt, render);
      el.thetaDeg.addEventListener(evt, render);
      el.faMHz.addEventListener(evt, render);
    });

    // smooth scroll for TOC
    document.querySelectorAll('nav.toc a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        const id = a.getAttribute('href');
        if(id && id.startsWith('#')){
          e.preventDefault();
          const target = document.querySelector(id);
          if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
        }
      });
    });

    // initial render + resize
    window.addEventListener('resize', ()=>render());
    render();
  </script>
</body>
</html>
