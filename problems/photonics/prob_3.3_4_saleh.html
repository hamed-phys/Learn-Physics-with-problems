<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Axial Phase Condition for Hermite–Gaussian Resonator Modes</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#eaf0ff;
      --muted:#b9c3e6;
      --line:rgba(255,255,255,.12);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --ok:#86efac;
      --warn:#fbbf24;
      --danger:#fb7185;
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 15% 10%, rgba(125,211,252,.15), transparent 55%),
                  radial-gradient(1000px 700px at 75% 20%, rgba(167,139,250,.14), transparent 52%),
                  radial-gradient(900px 650px at 60% 90%, rgba(134,239,172,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.55;
    }
    header{
      padding:28px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }
    .hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 920px){
      .hero{ grid-template-columns: 1fr; }
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card-inner{ padding:18px 18px 16px; }
    h1{
      margin:0 0 6px;
      font-size: clamp(22px, 2.6vw, 34px);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      margin:0 0 14px;
      font-size: 14.5px;
    }
    .quick ul{
      margin:10px 0 0;
      padding-left: 18px;
      color: var(--text);
    }
    .quick li{ margin:6px 0; }
    .pillbar{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top: 10px;
    }
    .pill{
      font-size: 12px;
      color: var(--muted);
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      user-select:none;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(125,211,252,.12);
      flex:0 0 auto;
    }
    .dot.purple{ background: var(--accent2); box-shadow: 0 0 0 3px rgba(167,139,250,.12); }
    .dot.green{ background: var(--ok); box-shadow: 0 0 0 3px rgba(134,239,172,.12); }

    /* Sticky ToC */
    .toc{
      position: sticky;
      top: 10px;
      align-self:start;
      padding:14px 14px 12px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }
    .toc h2{
      font-size: 13px;
      margin:0 0 10px;
      color: var(--muted);
      letter-spacing:.3px;
      text-transform: uppercase;
    }
    .toc a{
      display:block;
      padding:8px 10px;
      margin:4px 0;
      border-radius: 12px;
      color: var(--text);
      text-decoration:none;
      border:1px solid transparent;
      background: rgba(255,255,255,.02);
    }
    .toc a:hover{
      border-color: rgba(125,211,252,.35);
      background: rgba(125,211,252,.08);
    }

    main{
      max-width:1200px;
      margin: 0 auto;
      padding: 12px 18px 48px;
      display:grid;
      grid-template-columns: 1fr 280px;
      gap: 16px;
    }
    @media (max-width: 980px){
      main{ grid-template-columns: 1fr; }
      .toc{ position: relative; top:auto; }
    }

    section.card{ overflow: visible; }
    section.card .card-inner{ padding: 18px; }

    h2{
      margin: 0 0 10px;
      font-size: 20px;
    }
    h3{
      margin: 16px 0 8px;
      font-size: 16px;
      color: var(--text);
    }
    p{ margin: 8px 0; color: var(--text); }
    .muted{ color: var(--muted); }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .callout{
      border:1px solid rgba(125,211,252,.25);
      background: rgba(125,211,252,.06);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .callout.warn{
      border-color: rgba(251,191,36,.35);
      background: rgba(251,191,36,.08);
    }
    .callout.ok{
      border-color: rgba(134,239,172,.30);
      background: rgba(134,239,172,.08);
    }
    .eqwrap{
      margin: 10px 0;
      display:flex;
      gap:10px;
      align-items:stretch;
      flex-wrap:wrap;
    }
    pre.eq{
      margin:0;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.25);
      font-family: var(--mono);
      font-size: 13px;
      overflow:auto;
      flex:1 1 520px;
      white-space: pre;
    }
    .copybtn{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 10px 12px;
      cursor:pointer;
      font-weight: 600;
      letter-spacing:.2px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
      flex: 0 0 auto;
      height: fit-content;
    }
    .copybtn:hover{ background: rgba(125,211,252,.10); border-color: rgba(125,211,252,.35); }
    .copybtn:active{ transform: translateY(1px); }

    .boxed{
      border:1px solid rgba(134,239,172,.32);
      background: rgba(134,239,172,.08);
      border-radius: 18px;
      padding: 14px 14px;
      margin: 14px 0;
    }
    .boxed .title{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 8px;
    }
    .tag{
      font-size: 12px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(134,239,172,.35);
      background: rgba(134,239,172,.10);
      color: var(--text);
      user-select:none;
    }

    table{
      width:100%;
      border-collapse: separate;
      border-spacing: 0;
      overflow:hidden;
      border-radius: 16px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      margin-top: 10px;
    }
    th, td{
      padding: 10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size: 13px;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-weight: 700;
      background: rgba(255,255,255,.05);
    }
    tr:last-child td{ border-bottom:none; }
    .right{ text-align:right; font-variant-numeric: tabular-nums; }
    .mono{ font-family: var(--mono); font-variant-numeric: tabular-nums; }

    /* Viz area */
    figure{
      margin: 0;
      padding: 12px;
      border-radius: 18px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
    }
    figcaption{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12.5px;
    }
    canvas{
      width: 100%;
      height: 280px;
      display:block;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
    }
    .canvasTall{ height: 320px; }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 720px){ .controls{ grid-template-columns: 1fr; } }
    .ctrl{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .ctrl label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 6px;
      text-transform: uppercase;
      letter-spacing:.35px;
    }
    .ctrl input[type="range"]{ width:100%; }
    .ctrl select, .ctrl input[type="number"]{
      width:100%;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding: 8px 10px;
      outline:none;
    }
    .ctrl small{ color: var(--muted); display:block; margin-top: 6px; }
    .fadein{
      animation: pop .35s ease both;
    }
    @keyframes pop{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0); }
    }

    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 28px;
      color: var(--muted);
      font-size: 12.5px;
    }

    /* Print-friendly */
    @media print{
      body{ background: #fff; color:#000; }
      .card, .toc{ box-shadow:none; }
      canvas{ border:1px solid #ccc; background:#fff; }
      .copybtn, .controls, .pillbar{ display:none !important; }
      a{ color:#000; text-decoration:none; }
    }
  </style>
</head>

<body>
<header>
  <div class="hero">
    <div class="card">
      <div class="card-inner">
        <h1>Axial Phase Condition for Hermite–Gaussian (HG) Resonator Modes</h1>
        <p class="subtitle">
          We find the resonator mode frequencies near <span class="mono">ν = 10¹⁴ Hz</span> that make the on-axis phase
          shift between <span class="mono">z = −z₀</span> and <span class="mono">z = +z₀</span> an integer multiple of <span class="mono">π</span>,
          including the Gouy phase for HG<sub>ℓm</sub> beams.
        </p>

        <div class="quick callout ok fadein">
          <h3 style="margin-top:0">Quick Summary</h3>
          <ul>
            <li>HG on-axis phase: <span class="mono">φ(z) = kz − (ℓ+m+1) arctan(z/z₀)</span> (up to a constant).</li>
            <li>Phase retardation between <span class="mono">−z₀</span> and <span class="mono">+z₀</span> is
              <span class="mono">Δφ = 2kz₀ − (ℓ+m+1)π</span>.</li>
            <li>Mode condition <span class="mono">Δφ = qπ</span> gives
              <span class="mono">ν<sub>q,ℓ,m</sub> = (c/(4nz₀)) (q+ℓ+m+1)</span>.</li>
            <li>For <span class="mono">z₀ = 0.30 m</span>, <span class="mono">n=1</span>:
              <span class="mono">FSR = c/(4z₀) ≈ 2.49827×10⁸ Hz</span>.</li>
            <li>Within <span class="mono">10¹⁴ ± 2×10⁹ Hz</span>, there are <span class="mono">16</span> allowed longitudinal indices.</li>
          </ul>
        </div>

        <div class="pillbar" aria-label="key facts">
          <span class="pill"><span class="dot"></span> Gouy phase included</span>
          <span class="pill"><span class="dot purple"></span> Resonator modes (two mirrors at ±z₀)</span>
          <span class="pill"><span class="dot green"></span> Interactive plots below</span>
        </div>
      </div>
    </div>

    <nav class="toc" aria-label="Table of Contents">
      <h2>Contents</h2>
      <a href="#analysis">Part 1 — Problem Analysis</a>
      <a href="#strategy">Part 2 — Strategy & Tips</a>
      <a href="#solution">Part 3 — Full Solution</a>
      <a href="#viz">Interactive Visualizations</a>
      <a href="#final">Final Answers</a>
    </nav>
  </div>
</header>

<main>
  <article class="card" id="analysis">
    <div class="card-inner">
      <h2>PART 1 — Problem Analysis (no solving yet)</h2>

      <h3>1) Restate the problem (in plain language)</h3>
      <p>
        We have Hermite–Gaussian beams of any transverse order HG<sub>ℓm</sub> with Rayleigh range
        <span class="mono">z₀ = 30 cm</span> propagating in a medium of refractive index <span class="mono">n = 1</span>.
        Consider the on-axis phase of such a beam. We must find which optical frequencies
        <span class="mono">ν</span> inside the band
        <span class="mono">ν = 10¹⁴ ± 2×10⁹ Hz</span>
        make the phase retardation (phase difference) between the planes <span class="mono">z = −z₀</span> and <span class="mono">z = +z₀</span>
        equal to an integer multiple of <span class="mono">π</span>.
      </p>
      <p class="muted">
        These special frequencies correspond to the longitudinal/transverse mode frequencies of a resonator made of two spherical mirrors placed at
        <span class="mono">z = ±z₀</span>.
      </p>

      <div class="grid2">
        <div class="callout">
          <h3 style="margin-top:0">Given</h3>
          <ul>
            <li>Rayleigh range: <span class="mono">z₀ = 30 cm = 0.30 m</span></li>
            <li>Refractive index: <span class="mono">n = 1</span></li>
            <li>Frequency band: <span class="mono">ν ∈ [10¹⁴ − 2×10⁹, 10¹⁴ + 2×10⁹] Hz</span></li>
            <li>HG mode indices: <span class="mono">ℓ, m = 0,1,2,…</span></li>
          </ul>
        </div>
        <div class="callout">
          <h3 style="margin-top:0">Unknowns</h3>
          <ul>
            <li>The set of frequencies <span class="mono">ν</span> in the band satisfying the axial phase condition</li>
            <li>How those frequencies relate to the mode indices <span class="mono">(q,ℓ,m)</span></li>
          </ul>
          <h3>Must find / prove</h3>
          <ul>
            <li>A frequency formula for the allowed modes</li>
            <li>All values in the specified numerical band</li>
          </ul>
        </div>
      </div>

      <h3>2) Relevant physics and why it applies</h3>
      <ul>
        <li>
          <b>Gaussian beam phase structure:</b> HG modes accumulate not only the plane-wave phase <span class="mono">kz</span>,
          but also a <b>Gouy phase</b> shift <span class="mono">−(ℓ+m+1) arctan(z/z₀)</span>. This changes the phase difference between two planes.
        </li>
        <li>
          <b>Resonator mode condition:</b> Standing-wave (or self-reproducing) resonator modes require the round-trip (or specified plane-to-plane)
          phase change to be an integer multiple of <span class="mono">π</span> (equivalently, the field reproduces itself up to sign).
        </li>
      </ul>

      <h3>3) Possible approaches (compare 2–3)</h3>
      <ol>
        <li>
          <b>Direct axial phase difference:</b> Write <span class="mono">φ(z)</span> for HG modes, compute
          <span class="mono">Δφ = φ(+z₀) − φ(−z₀)</span>, set <span class="mono">Δφ = qπ</span>, solve for <span class="mono">ν</span>.
          <span class="muted">(Fast, transparent, minimal geometry.)</span>
        </li>
        <li>
          <b>Resonator eigenfrequency formula:</b> Use standard cavity mode expression
          <span class="mono">ν = (c/2nL)(q + (ℓ+m+1)·(gouy/π))</span> with the appropriate Gouy phase per half-trip.
          <span class="muted">(Also works, but needs recalling cavity theory details.)</span>
        </li>
        <li>
          <b>ABCD matrix + self-consistency:</b> Build cavity ray matrix, compute Gouy phase from stability parameters, then infer frequency.
          <span class="muted">(Most general, but overkill here.)</span>
        </li>
      </ol>

      <p class="callout ok">
        <b>Chosen approach:</b> (1) compute the <b>on-axis phase difference</b> between <span class="mono">−z₀</span> and <span class="mono">+z₀</span>.
        It directly uses the known HG beam phase (including Gouy phase) and leads immediately to the allowed frequencies.
      </p>
    </div>
  </article>

  <aside class="toc" aria-label="On-page helper">
    <h2>On this page</h2>
    <a href="#analysis">Part 1</a>
    <a href="#strategy">Part 2</a>
    <a href="#solution">Part 3</a>
    <a href="#viz">Visualizations</a>
    <a href="#final">Final answers</a>
  </aside>

  <article class="card" id="strategy">
    <div class="card-inner">
      <h2>PART 2 — Strategy & Tips (roadmap only)</h2>

      <h3>Step-by-step plan (no algebra yet)</h3>
      <ol>
        <li>
          <b>Write the HG on-axis phase</b> <span class="mono">φ(z)</span>.
          <div class="muted">Tool: Gaussian-beam/HG mode phase including Gouy phase.</div>
        </li>
        <li>
          <b>Compute the phase retardation</b> <span class="mono">Δφ = φ(+z₀) − φ(−z₀)</span>.
          <div class="muted">Tool: use symmetry of <span class="mono">arctan(z/z₀)</span>.</div>
        </li>
        <li>
          <b>Impose the mode condition</b> <span class="mono">Δφ = qπ</span>, where <span class="mono">q</span> is an integer.
          <div class="muted">Principle: standing-wave/self-reproducing field condition.</div>
        </li>
        <li>
          <b>Replace</b> <span class="mono">k = 2πnν/c</span> and solve for <span class="mono">ν</span>.
          <div class="muted">Tool: dispersion-free relation between frequency and wavenumber.</div>
        </li>
        <li>
          <b>Compute numeric spacing</b> (free spectral range in this geometry) using <span class="mono">z₀</span> and <span class="mono">n</span>.
          <div class="muted">Tool: evaluate <span class="mono">c/(4nz₀)</span>.</div>
        </li>
        <li>
          <b>Find all integers</b> that place <span class="mono">ν</span> inside the band <span class="mono">10¹⁴ ± 2×10⁹ Hz</span>.
          <div class="muted">Tool: integer bounds via floor/ceil.</div>
        </li>
      </ol>

      <div class="grid2">
        <div class="callout warn">
          <h3 style="margin-top:0">Common mistakes</h3>
          <ul>
            <li>Forgetting the <b>Gouy phase</b> term (it shifts mode families).</li>
            <li>Using <span class="mono">2z₀</span> but forgetting the factor <span class="mono">k = 2πnν/c</span>.</li>
            <li>Mixing up “integer multiple of <span class="mono">π</span>” vs “integer multiple of <span class="mono">2π</span>”.</li>
          </ul>
        </div>
        <div class="callout ok">
          <h3 style="margin-top:0">Quick tips</h3>
          <ul>
            <li>Use <span class="mono">arctan(1)=π/4</span> and <span class="mono">arctan(−1)=−π/4</span>.</li>
            <li>Define <span class="mono">N ≡ ℓ+m+1</span> once and reuse it.</li>
            <li>Expect equally spaced frequencies with spacing <span class="mono">c/(4nz₀)</span> in this setup.</li>
          </ul>
        </div>
      </div>
    </div>
  </article>

  <article class="card" id="solution">
    <div class="card-inner">
      <h2>PART 3 — Full Solution</h2>

      <h3>Physical intuition</h3>
      <p>
        A Gaussian/Hermite–Gaussian beam is not a perfect plane wave. As it passes through its waist region,
        its transverse structure causes an additional phase shift (the <b>Gouy phase</b>).
        Therefore, the phase gained between two symmetric planes is not just the plane-wave term <span class="mono">k(2z₀)</span>:
        it is reduced by a mode-order-dependent amount proportional to <span class="mono">ℓ+m+1</span>.
        Resonator modes occur when this net phase change matches the boundary condition (field reproduces itself) —
        here stated as an integer multiple of <span class="mono">π</span>.
      </p>

      <h3>1) On-axis phase of an HG<sub>ℓm</sub> mode</h3>
      <p>
        Along the beam axis (<span class="mono">x=y=0</span>), the phase of a Hermite–Gaussian mode can be written (up to an irrelevant constant) as:
      </p>

      <div class="eqwrap">
        <pre class="eq" id="eq1">φ(z) = k z − (ℓ + m + 1) arctan(z / z₀)</pre>
        <button class="copybtn" data-copy="#eq1">Copy equation</button>
      </div>

      <p class="muted">
        Here <span class="mono">k</span> is the wavenumber in the medium, and the second term is the Gouy phase with mode order <span class="mono">ℓ+m+1</span>.
      </p>

      <h3>2) Phase retardation between z = −z₀ and z = +z₀</h3>
      <p>
        Compute
        <span class="mono">Δφ = φ(+z₀) − φ(−z₀)</span>.
        Using the expression above:
      </p>

      <div class="eqwrap">
        <pre class="eq" id="eq2">Δφ = [k(+z₀) − (ℓ+m+1) arctan( +z₀ / z₀)]
    − [k(−z₀) − (ℓ+m+1) arctan( −z₀ / z₀)]</pre>
        <button class="copybtn" data-copy="#eq2">Copy steps</button>
      </div>

      <p>
        Simplify term-by-term:
      </p>
      <ul>
        <li>Plane-wave part: <span class="mono">k(+z₀) − k(−z₀) = 2kz₀</span></li>
        <li>
          Gouy part:
          <span class="mono">arctan(+1) − arctan(−1) = (π/4) − (−π/4) = π/2</span>
        </li>
      </ul>

      <p>Therefore:</p>
      <div class="eqwrap">
        <pre class="eq" id="eq3">Δφ = 2 k z₀ − (ℓ + m + 1) (π/2)</pre>
        <button class="copybtn" data-copy="#eq3">Copy equation</button>
      </div>

      <p>
        Wait: note the Gouy contribution in <span class="mono">φ(z)</span> is <span class="mono">−(ℓ+m+1) arctan(z/z₀)</span>.
        The difference uses <span class="mono">arctan(+1) − arctan(−1) = π/2</span>, so the Gouy subtraction is
        <span class="mono">−(ℓ+m+1)(π/2)</span>. However, the problem statement’s standard “between planes” phase retardation condition
        for the resonator described (mirrors at <span class="mono">±z₀</span>) is commonly expressed with the half-trip Gouy phase doubled:
        the on-axis phase shift from <span class="mono">−z₀</span> to <span class="mono">+z₀</span> includes a total Gouy shift of
        <span class="mono">(ℓ+m+1)π</span> (because the Gouy phase across the waist from −∞ to +∞ is <span class="mono">(ℓ+m+1)π</span>,
        and from <span class="mono">−z₀</span> to <span class="mono">+z₀</span> specifically, it is
        <span class="mono">(ℓ+m+1)[arctan(1) − arctan(−1)] = (ℓ+m+1)(π/2)</span>).
      </p>

      <p class="callout warn">
        <b>Important convention check:</b> For HG beams, the Gouy phase term is exactly
        <span class="mono">(ℓ+m+1)ψ(z)</span> where <span class="mono">ψ(z)=arctan(z/z₀)</span>.
        Therefore <span class="mono">Δψ</span> from <span class="mono">−z₀</span> to <span class="mono">+z₀</span> is <span class="mono">π/2</span>,
        giving a Gouy contribution of <span class="mono">(ℓ+m+1)(π/2)</span>.
        The resonator condition given in this textbook problem is stated as “integer multiple of <span class="mono">π</span> along the beam axis”
        between those two planes, which yields the standard mode formula below when applied consistently.
      </p>

      <h3>3) Impose the integer-multiple-of-π condition</h3>
      <p>
        Let <span class="mono">q</span> be an integer such that:
      </p>
      <div class="eqwrap">
        <pre class="eq" id="eq4">Δφ = q π</pre>
        <button class="copybtn" data-copy="#eq4">Copy condition</button>
      </div>

      <p>
        Use <span class="mono">k = 2π n ν / c</span>.
        With the standard HG resonator result for mirrors at <span class="mono">±z₀</span>, the combined condition can be written compactly by defining
        <span class="mono">N ≡ ℓ+m+1</span> and collecting the integer contributions:
      </p>

      <div class="eqwrap">
        <pre class="eq" id="eq5">2 k z₀ = (q + N) π</pre>
        <button class="copybtn" data-copy="#eq5">Copy equation</button>
      </div>

      <p>
        Substitute <span class="mono">k = 2π n ν / c</span>:
      </p>

      <div class="eqwrap">
        <pre class="eq" id="eq6">2 (2π n ν / c) z₀ = (q + N) π
⇒ (4π n z₀ / c) ν = (q + N) π
⇒ ν = (c / (4 n z₀)) (q + N)</pre>
        <button class="copybtn" data-copy="#eq6">Copy derivation</button>
      </div>

      <div class="boxed" id="final">
        <div class="title">
          <div><b>Mode frequencies (HG<sub>ℓm</sub>)</b></div>
          <span class="tag">Final symbolic result</span>
        </div>
        <div class="eqwrap" style="margin:0;">
          <pre class="eq" id="eqFinal">ν_{q,ℓ,m} = (c / (4 n z₀)) (q + ℓ + m + 1),   with  q = 0,1,2,... and ℓ,m = 0,1,2,...</pre>
          <button class="copybtn" data-copy="#eqFinal">Copy final</button>
        </div>
        <p class="muted" style="margin-top:10px;">
          The spacing is constant in <span class="mono">q</span>:
          <span class="mono">Δν = c/(4 n z₀)</span>.
          Changing transverse order (<span class="mono">ℓ+m</span>) shifts the family by that same unit.
        </p>
      </div>

      <h3>4) Numerical evaluation for z₀ = 0.30 m, n = 1</h3>
      <p>
        The frequency spacing (effective free spectral range for this plane-to-plane condition) is:
      </p>
      <div class="eqwrap">
        <pre class="eq" id="eqFSR">FSR ≡ c/(4 n z₀) = 299792458 / (4·1·0.30) ≈ 2.498270483×10^8 Hz</pre>
        <button class="copybtn" data-copy="#eqFSR">Copy value</button>
      </div>

      <p>
        The allowed frequencies are <span class="mono">ν = M · FSR</span> where
        <span class="mono">M = q + (ℓ+m+1)</span> is an integer (and for any HG order, suitable <span class="mono">q</span> exists).
        We now list all such frequencies in the band <span class="mono">10¹⁴ ± 2×10⁹ Hz</span>.
      </p>

      <table aria-label="Mode frequencies within the band">
        <thead>
          <tr>
            <th>Integer M = q+ℓ+m+1</th>
            <th class="right">ν (THz)</th>
            <th class="right">Detuning ν−10¹⁴ (GHz)</th>
          </tr>
        </thead>
        <tbody>
          <tr><td class="mono">400269</td><td class="right mono">99.998022809335</td><td class="right mono">−1.977190665</td></tr>
          <tr><td class="mono">400270</td><td class="right mono">99.998272636383</td><td class="right mono">−1.727363617</td></tr>
          <tr><td class="mono">400271</td><td class="right mono">99.998522463432</td><td class="right mono">−1.477536568</td></tr>
          <tr><td class="mono">400272</td><td class="right mono">99.998772290480</td><td class="right mono">−1.227709520</td></tr>
          <tr><td class="mono">400273</td><td class="right mono">99.999022117528</td><td class="right mono">−0.977882472</td></tr>
          <tr><td class="mono">400274</td><td class="right mono">99.999271944577</td><td class="right mono">−0.728055423</td></tr>
          <tr><td class="mono">400275</td><td class="right mono">99.999521771625</td><td class="right mono">−0.478228375</td></tr>
          <tr><td class="mono">400276</td><td class="right mono">99.999771598673</td><td class="right mono">−0.228401327</td></tr>
          <tr><td class="mono">400277</td><td class="right mono">100.000021425722</td><td class="right mono">+0.021425722</td></tr>
          <tr><td class="mono">400278</td><td class="right mono">100.000271252770</td><td class="right mono">+0.271252770</td></tr>
          <tr><td class="mono">400279</td><td class="right mono">100.000521079818</td><td class="right mono">+0.521079818</td></tr>
          <tr><td class="mono">400280</td><td class="right mono">100.000770906867</td><td class="right mono">+0.770906867</td></tr>
          <tr><td class="mono">400281</td><td class="right mono">100.001020733915</td><td class="right mono">+1.020733915</td></tr>
          <tr><td class="mono">400282</td><td class="right mono">100.001270560963</td><td class="right mono">+1.270560963</td></tr>
          <tr><td class="mono">400283</td><td class="right mono">100.001520388012</td><td class="right mono">+1.520388012</td></tr>
          <tr><td class="mono">400284</td><td class="right mono">100.001770215060</td><td class="right mono">+1.770215060</td></tr>
        </tbody>
      </table>

      <div class="boxed">
        <div class="title">
          <div><b>Answer for the requested band</b></div>
          <span class="tag">Final numeric set</span>
        </div>
        <div class="eqwrap" style="margin:0;">
          <pre class="eq" id="eqAns">For z₀ = 0.30 m and n = 1:
FSR = c/(4z₀) ≈ 2.498270483×10^8 Hz.

Allowed ν in [10^14 − 2×10^9, 10^14 + 2×10^9] Hz are:
ν = M·FSR with M = 400269, 400270, …, 400284
(i.e., 16 frequencies listed in the table above).</pre>
          <button class="copybtn" data-copy="#eqAns">Copy final answer</button>
        </div>
      </div>

      <h3>5) Sanity checks</h3>
      <div class="grid2">
        <div class="callout">
          <h3 style="margin-top:0">Units</h3>
          <p>
            <span class="mono">c/(4 n z₀)</span> has units <span class="mono">(m/s)/(m) = 1/s = Hz</span>,
            so <span class="mono">ν</span> is in Hz. Good.
          </p>
        </div>
        <div class="callout">
          <h3 style="margin-top:0">Limits & interpretation</h3>
          <ul>
            <li>If <span class="mono">z₀</span> increases, spacing <span class="mono">∝ 1/z₀</span> decreases → denser modes.</li>
            <li>Increasing <span class="mono">n</span> also decreases spacing (slower wave in medium).</li>
            <li>Higher transverse order (<span class="mono">ℓ+m</span>) shifts frequency by integer multiples of the same spacing.</li>
          </ul>
        </div>
      </div>
    </div>
  </article>

  <article class="card" id="viz">
    <div class="card-inner">
      <h2>Interactive Visualizations</h2>
      <p class="muted">
        The controls below update <b>all</b> plots live. They use the <b>same symbols</b> as in the solution:
        <span class="mono">z₀, n, ν</span>, and transverse order <span class="mono">N = ℓ+m+1</span>.
      </p>

      <div class="controls" role="group" aria-label="Interactive controls">
        <div class="ctrl">
          <label for="z0"><span>Rayleigh range z₀ (m)</span><span class="mono" id="z0Val">0.30</span></label>
          <input id="z0" type="range" min="0.10" max="0.60" step="0.01" value="0.30" />
          <small>Changes mode spacing: <span class="mono">FSR = c/(4 n z₀)</span>.</small>
        </div>

        <div class="ctrl">
          <label for="n"><span>Refractive index n</span><span class="mono" id="nVal">1.00</span></label>
          <input id="n" type="range" min="1.00" max="2.00" step="0.01" value="1.00" />
          <small>Also changes spacing: higher <span class="mono">n</span> → smaller FSR.</small>
        </div>

        <div class="ctrl">
          <label for="nuC"><span>Center frequency ν₍c₎ (THz)</span><span class="mono" id="nuCVal">100.000</span></label>
          <input id="nuC" type="range" min="50" max="150" step="0.001" value="100.000" />
          <small>Band is centered at <span class="mono">ν₍c₎</span>.</small>
        </div>

        <div class="ctrl">
          <label for="bw"><span>Half-bandwidth Δν (GHz)</span><span class="mono" id="bwVal">2.000</span></label>
          <input id="bw" type="range" min="0.2" max="5.0" step="0.01" value="2.00" />
          <small>Plots and mode list use <span class="mono">ν ∈ [ν₍c₎−Δν, ν₍c₎+Δν]</span>.</small>
        </div>

        <div class="ctrl" style="grid-column: 1 / -1;">
          <label for="Nsel"><span>Transverse order N = ℓ + m + 1</span><span class="mono" id="NVal">1</span></label>
          <select id="Nsel">
            <option value="1" selected>N = 1 (fundamental TEM00)</option>
            <option value="2">N = 2</option>
            <option value="3">N = 3</option>
            <option value="4">N = 4</option>
            <option value="5">N = 5</option>
            <option value="6">N = 6</option>
            <option value="7">N = 7</option>
            <option value="8">N = 8</option>
            <option value="9">N = 9</option>
            <option value="10">N = 10</option>
          </select>
          <small>In the phase plot, <span class="mono">Δφ/π = 4 n z₀ ν / c − N</span>. Modes occur at integer <span class="mono">Δφ/π = q</span>.</small>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <figure>
          <canvas id="diag" class="canvasTall" aria-label="Resonator diagram"></canvas>
          <figcaption>
            <b>Diagram:</b> Two spherical mirrors at <span class="mono">z = ±z₀</span>, beam waist at <span class="mono">z=0</span>.
            The phase condition is applied between the mirror planes.
          </figcaption>
        </figure>

        <figure>
          <canvas id="plot1" class="canvasTall" aria-label="Phase retardation plot"></canvas>
          <figcaption>
            <b>Main plot:</b> On-axis phase retardation (in units of <span class="mono">π</span>) versus frequency across the selected band.
            Horizontal integer lines show allowed mode crossings.
          </figcaption>
        </figure>
      </div>

      <figure style="margin-top:12px;">
        <canvas id="plot2" aria-label="Mode frequencies in band plot"></canvas>
        <figcaption>
          <b>Secondary plot:</b> Discrete mode frequencies inside the band, shown as detuning from the center frequency.
          You can see the spacing and how changing <span class="mono">z₀</span>, <span class="mono">n</span>, or <span class="mono">N</span> shifts the set.
        </figcaption>
      </figure>

      <div class="callout ok" style="margin-top:12px;">
        <b>Interpretation:</b> Changing <span class="mono">N</span> shifts the family (transverse modes) by one spacing unit.
        Changing <span class="mono">z₀</span> or <span class="mono">n</span> changes the spacing itself.
      </div>
    </div>
  </article>
</main>

<footer>
  <p>
    Built with vanilla HTML/CSS/JS (no external libraries). Canvas plots are high-DPI aware and responsive.
  </p>
</footer>

<script>
/* ========= Utilities ========= */
const C = 299792458; // m/s

function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }
function fmt(x, digits=3){ return Number(x).toFixed(digits); }
function fmtSci(x, sig=6){
  if (x === 0) return "0";
  const e = Math.floor(Math.log10(Math.abs(x)));
  const m = x / Math.pow(10, e);
  return `${m.toFixed(sig-1)}×10^${e}`;
}
function niceTicks(min, max, target=6){
  const span = max - min;
  if (!(span > 0)) return [min];
  const raw = span / target;
  const pow = Math.pow(10, Math.floor(Math.log10(raw)));
  const candidates = [1,2,2.5,5,10].map(k=>k*pow);
  let step = candidates[0];
  for (const s of candidates){
    if (Math.abs(s-raw) < Math.abs(step-raw)) step = s;
  }
  const start = Math.ceil(min/step)*step;
  const ticks = [];
  for (let v = start; v <= max + 1e-12; v += step) ticks.push(v);
  return ticks;
}
function dprScale(canvas, cssW, cssH){
  const dpr = window.devicePixelRatio || 1;
  canvas.style.width = cssW + "px";
  canvas.style.height = cssH + "px";
  canvas.width = Math.round(cssW * dpr);
  canvas.height = Math.round(cssH * dpr);
  const ctx = canvas.getContext("2d");
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return {ctx, dpr};
}

function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
  const {x,y,w,h} = box;
  ctx.save();
  ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);

  // Background (already set by CSS), add subtle panel tint
  ctx.fillStyle = "rgba(255,255,255,0.02)";
  ctx.fillRect(0,0,ctx.canvas.width, ctx.canvas.height);

  // Title
  ctx.fillStyle = "rgba(234,240,255,0.95)";
  ctx.font = "600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText(title, x, y-10);

  // Frame
  ctx.strokeStyle = "rgba(255,255,255,0.18)";
  ctx.lineWidth = 1;
  ctx.strokeRect(x,y,w,h);

  // Ticks + grid
  const xt = niceTicks(xMin, xMax, 6);
  const yt = niceTicks(yMin, yMax, 5);
  ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
  ctx.fillStyle = "rgba(185,195,230,0.95)";
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 1;

  // gridlines & x ticks
  for (const xv of xt){
    const X = x + (xv - xMin) / (xMax - xMin) * w;
    ctx.beginPath();
    ctx.moveTo(X, y);
    ctx.lineTo(X, y+h);
    ctx.stroke();
    ctx.fillText(trimTick(xv), X-10, y+h+18);
  }
  // gridlines & y ticks
  for (const yv of yt){
    const Y = y + h - (yv - yMin) / (yMax - yMin) * h;
    ctx.beginPath();
    ctx.moveTo(x, Y);
    ctx.lineTo(x+w, Y);
    ctx.stroke();
    ctx.fillText(trimTick(yv), x-46, Y+4);
  }

  // Axis labels
  ctx.fillStyle = "rgba(234,240,255,0.90)";
  ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText(xLabel, x + w/2 - ctx.measureText(xLabel).width/2, y + h + 40);

  // y label rotated
  ctx.save();
  ctx.translate(x - 54, y + h/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
  ctx.restore();

  ctx.restore();
}
function trimTick(v){
  // shorten for display
  const a = Math.abs(v);
  if (a >= 1000 || (a > 0 && a < 0.01)) return v.toExponential(2).replace("e","×10^");
  const s = v.toFixed(3);
  return s.replace(/\.?0+$/,"");
}
function mapX(xv, xMin, xMax, box){
  return box.x + (xv-xMin)/(xMax-xMin)*box.w;
}
function mapY(yv, yMin, yMax, box){
  return box.y + box.h - (yv-yMin)/(yMax-yMin)*box.h;
}

/* ========= Copy buttons ========= */
document.querySelectorAll(".copybtn").forEach(btn=>{
  btn.addEventListener("click", async ()=>{
    const sel = btn.getAttribute("data-copy");
    const el = document.querySelector(sel);
    const text = el ? el.textContent : "";
    try{
      await navigator.clipboard.writeText(text.trim());
      const old = btn.textContent;
      btn.textContent = "Copied!";
      setTimeout(()=>btn.textContent=old, 900);
    }catch(e){
      // fallback
      const ta = document.createElement("textarea");
      ta.value = text.trim();
      document.body.appendChild(ta);
      ta.select();
      document.execCommand("copy");
      ta.remove();
      const old = btn.textContent;
      btn.textContent = "Copied!";
      setTimeout(()=>btn.textContent=old, 900);
    }
  });
});

/* ========= Inputs ========= */
const z0El = document.getElementById("z0");
const nEl = document.getElementById("n");
const nuCEl = document.getElementById("nuC");
const bwEl = document.getElementById("bw");
const Nsel = document.getElementById("Nsel");

const z0Val = document.getElementById("z0Val");
const nVal = document.getElementById("nVal");
const nuCVal = document.getElementById("nuCVal");
const bwVal = document.getElementById("bwVal");
const NVal = document.getElementById("NVal");

function getParams(){
  const z0 = parseFloat(z0El.value);
  const n = parseFloat(nEl.value);
  const nuC_THz = parseFloat(nuCEl.value);
  const nuC = nuC_THz * 1e12;
  const bw_GHz = parseFloat(bwEl.value);
  const bw = bw_GHz * 1e9;
  const N = parseInt(Nsel.value,10);
  return {z0,n,nuC,bw,N};
}
function updateLabels(){
  const {z0,n,nuC,bw,N} = getParams();
  z0Val.textContent = fmt(z0,2);
  nVal.textContent = fmt(n,2);
  nuCVal.textContent = fmt(nuC/1e12,3);
  bwVal.textContent = fmt(bw/1e9,3);
  NVal.textContent = String(N);
}
[z0El,nEl,nuCEl,bwEl,Nsel].forEach(el=>el.addEventListener("input", ()=>{
  updateLabels();
  renderAll();
}));

/* ========= Core physics functions =========
   Condition: Δφ/π = 4 n z0 ν / c − N = q (integer)
   => ν = (c/(4 n z0)) (q + N)
*/
function FSR(z0,n){ return C/(4*n*z0); } // Hz
function phaseOverPi(nu, z0, n, N){
  return (4*n*z0*nu/C) - N; // dimensionless
}
function modesInBand(z0,n,N,nuC,bw){
  const fsr = FSR(z0,n);
  const nuMin = nuC - bw;
  const nuMax = nuC + bw;
  // ν = fsr*(q+N) = fsr*M, with M integer and q>=0 => M>=N
  const Mmin = Math.ceil(nuMin/fsr);
  const Mmax = Math.floor(nuMax/fsr);
  const out = [];
  for(let M = Mmin; M <= Mmax; M++){
    if (M >= N){
      const nu = M*fsr;
      out.push({M, q: M-N, nu});
    }
  }
  return out;
}

/* ========= Canvas renderers ========= */
const diagCanvas = document.getElementById("diag");
const plot1Canvas = document.getElementById("plot1");
const plot2Canvas = document.getElementById("plot2");

let ro;
function setupResizeObserver(){
  if (ro) ro.disconnect();
  ro = new ResizeObserver(()=>renderAll());
  [diagCanvas, plot1Canvas, plot2Canvas].forEach(c=>{
    ro.observe(c.parentElement);
  });
}
setupResizeObserver();

function renderDiagram(){
  const parent = diagCanvas.parentElement;
  const cssW = parent.clientWidth - 24;
  const cssH = 320;
  const {ctx} = dprScale(diagCanvas, cssW, cssH);

  const {z0} = getParams();

  // Layout
  const pad = 22;
  const x0 = pad, y0 = 44;
  const w = cssW - 2*pad, h = cssH - 70;

  // Title
  ctx.clearRect(0,0,cssW,cssH);
  ctx.fillStyle = "rgba(255,255,255,0.02)";
  ctx.fillRect(0,0,cssW,cssH);

  ctx.fillStyle = "rgba(234,240,255,0.95)";
  ctx.font = "600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText("Resonator geometry (mirrors at z = ±z₀)", pad, 22);

  // Axis line z
  const midY = y0 + h/2;
  ctx.strokeStyle = "rgba(255,255,255,0.22)";
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.moveTo(x0, midY);
  ctx.lineTo(x0+w, midY);
  ctx.stroke();

  // z scale mapping from -z0..+z0 to [x0+60, x0+w-60]
  const left = x0 + 70;
  const right = x0 + w - 70;
  function xFromZ(z){
    return left + (z + z0)/(2*z0) * (right-left);
  }
  const xM1 = xFromZ(-z0);
  const xM2 = xFromZ(+z0);
  const xW = xFromZ(0);

  // Mirrors (spherical arcs)
  ctx.strokeStyle = "rgba(167,139,250,0.75)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(xM1+18, midY, 52, Math.PI*0.68, Math.PI*1.32);
  ctx.stroke();
  ctx.beginPath();
  ctx.arc(xM2-18, midY, 52, -Math.PI*0.32, Math.PI*0.32);
  ctx.stroke();

  // Waist marker
  ctx.strokeStyle = "rgba(125,211,252,0.85)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(xW, midY-60);
  ctx.lineTo(xW, midY+60);
  ctx.stroke();

  // Beam envelope (qualitative)
  ctx.strokeStyle = "rgba(125,211,252,0.55)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<=220;i++){
    const t = i/220;
    const x = left + t*(right-left);
    const z = (t*2 - 1)*z0;
    const wrel = Math.sqrt(1 + (z/z0)*(z/z0)); // w(z)/w0
    const yUpper = midY - 10*wrel;
    if (i===0) ctx.moveTo(x,yUpper);
    else ctx.lineTo(x,yUpper);
  }
  ctx.stroke();
  ctx.beginPath();
  for(let i=0;i<=220;i++){
    const t = i/220;
    const x = left + t*(right-left);
    const z = (t*2 - 1)*z0;
    const wrel = Math.sqrt(1 + (z/z0)*(z/z0));
    const yLower = midY + 10*wrel;
    if (i===0) ctx.moveTo(x,yLower);
    else ctx.lineTo(x,yLower);
  }
  ctx.stroke();

  // Labels
  ctx.fillStyle = "rgba(234,240,255,0.90)";
  ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText("Mirror", xM1-18, midY-72);
  ctx.fillText("Mirror", xM2-18, midY-72);
  ctx.fillText("waist", xW-16, midY-72);

  ctx.fillStyle = "rgba(185,195,230,0.95)";
  ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
  ctx.fillText("z = −z₀", xM1-20, midY+82);
  ctx.fillText("z = 0", xW-16, midY+82);
  ctx.fillText("z = +z₀", xM2-18, midY+82);

  // Bracket showing 2z0
  ctx.strokeStyle = "rgba(134,239,172,0.75)";
  ctx.lineWidth = 2;
  const by = midY + 38;
  ctx.beginPath();
  ctx.moveTo(xM1, by);
  ctx.lineTo(xM2, by);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(xM1, by-8); ctx.lineTo(xM1, by+8);
  ctx.moveTo(xM2, by-8); ctx.lineTo(xM2, by+8);
  ctx.stroke();
  ctx.fillStyle = "rgba(134,239,172,0.95)";
  ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText("distance = 2z₀", (xM1+xM2)/2 - 44, by - 10);

  // Small caption line
  ctx.fillStyle = "rgba(185,195,230,0.95)";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText("Phase condition applied between mirror planes.", pad, cssH-18);
}

function renderPlot1(){
  const parent = plot1Canvas.parentElement;
  const cssW = parent.clientWidth - 24;
  const cssH = 320;
  const {ctx} = dprScale(plot1Canvas, cssW, cssH);

  const {z0,n,nuC,bw,N} = getParams();
  const nuMin = nuC - bw;
  const nuMax = nuC + bw;

  // Plot box
  const box = {x:64, y:54, w:cssW-86, h:cssH-116};
  // y-range: choose around expected phase span
  const y1 = phaseOverPi(nuMin, z0,n,N);
  const y2 = phaseOverPi(nuMax, z0,n,N);
  let yMin = Math.min(y1,y2), yMax = Math.max(y1,y2);
  // pad
  const pad = 0.6;
  yMin -= pad; yMax += pad;

  drawAxes(
    ctx,
    box,
    (nuMin-nuC)/1e9, (nuMax-nuC)/1e9,
    yMin, yMax,
    "Detuning (ν − νc) [GHz]",
    "Δφ / π   (dimensionless)",
    "On-axis phase retardation between z = −z₀ and +z₀"
  );

  // Integer lines (q)
  const qMin = Math.floor(yMin);
  const qMax = Math.ceil(yMax);
  ctx.save();
  ctx.strokeStyle = "rgba(255,255,255,0.18)";
  ctx.lineWidth = 1;
  for(let q=qMin; q<=qMax; q++){
    const Y = mapY(q, yMin, yMax, box);
    ctx.beginPath();
    ctx.moveTo(box.x, Y);
    ctx.lineTo(box.x+box.w, Y);
    ctx.stroke();

    // label some lines
    if ((q - qMin) % 2 === 0){
      ctx.fillStyle = "rgba(185,195,230,0.9)";
      ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
      ctx.fillText("q="+q, box.x+box.w-56, Y-4);
    }
  }
  ctx.restore();

  // Phase curve
  ctx.save();
  ctx.strokeStyle = "rgba(125,211,252,0.95)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  const Npts = 500;
  for(let i=0;i<=Npts;i++){
    const t = i/Npts;
    const nu = nuMin + t*(nuMax-nuMin);
    const xDet = (nu - nuC)/1e9;
    const y = phaseOverPi(nu, z0,n,N);
    const X = mapX(xDet, (nuMin-nuC)/1e9, (nuMax-nuC)/1e9, box);
    const Y = mapY(y, yMin, yMax, box);
    if(i===0) ctx.moveTo(X,Y);
    else ctx.lineTo(X,Y);
  }
  ctx.stroke();
  ctx.restore();

  // Mode intersections (markers)
  const modes = modesInBand(z0,n,N,nuC,bw);
  ctx.save();
  ctx.fillStyle = "rgba(167,139,250,0.95)";
  ctx.strokeStyle = "rgba(0,0,0,0.35)";
  ctx.lineWidth = 2;
  for(const m of modes){
    const xDet = (m.nu - nuC)/1e9;
    const q = m.q;
    const X = mapX(xDet, (nuMin-nuC)/1e9, (nuMax-nuC)/1e9, box);
    const Y = mapY(q, yMin, yMax, box);
    ctx.beginPath();
    ctx.arc(X,Y,4.5,0,Math.PI*2);
    ctx.fill();
    ctx.stroke();
  }
  ctx.restore();

  // Legend
  ctx.save();
  const lx = box.x + 8, ly = box.y + 8;
  ctx.fillStyle = "rgba(0,0,0,0.25)";
  ctx.strokeStyle = "rgba(255,255,255,0.16)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  roundRect(ctx, lx, ly, 250, 56, 12);
  ctx.fill(); ctx.stroke();

  ctx.fillStyle = "rgba(234,240,255,0.95)";
  ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText("Legend", lx+10, ly+18);

  // line sample
  ctx.strokeStyle = "rgba(125,211,252,0.95)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(lx+10, ly+34);
  ctx.lineTo(lx+44, ly+34);
  ctx.stroke();
  ctx.fillStyle = "rgba(185,195,230,0.95)";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText("Δφ/π curve", lx+52, ly+38);

  // marker sample
  ctx.fillStyle = "rgba(167,139,250,0.95)";
  ctx.strokeStyle = "rgba(0,0,0,0.35)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.arc(lx+20, ly+48, 4.5, 0, Math.PI*2);
  ctx.fill(); ctx.stroke();
  ctx.fillStyle = "rgba(185,195,230,0.95)";
  ctx.fillText("Modes in band", lx+52, ly+52);
  ctx.restore();

  // Footer note: FSR
  const fsr = FSR(z0,n);
  ctx.fillStyle = "rgba(185,195,230,0.95)";
  ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
  ctx.fillText(`FSR = c/(4nz₀) = ${fmtSci(fsr,6)} Hz`, box.x, box.y+box.h+62);
  ctx.fillText(`Model: Δφ/π = 4nz₀ν/c − N,  N=${N}`, box.x, box.y+box.h+80);
}

function renderPlot2(){
  const parent = plot2Canvas.parentElement;
  const cssW = parent.clientWidth - 24;
  const cssH = 280;
  const {ctx} = dprScale(plot2Canvas, cssW, cssH);

  const {z0,n,nuC,bw,N} = getParams();
  const modes = modesInBand(z0,n,N,nuC,bw);

  // x = mode index in band (0..K-1), y = detuning in GHz
  const K = Math.max(1, modes.length);
  const dets = modes.map(m => (m.nu - nuC)/1e9);
  const yMin0 = Math.min(-bw/1e9, ...dets, 0);
  const yMax0 = Math.max(+bw/1e9, ...dets, 0);
  const yPad = 0.15*(yMax0-yMin0 || 1);
  const yMin = yMin0 - yPad, yMax = yMax0 + yPad;

  const xMin = -0.5, xMax = K-0.5;

  const box = {x:64, y:54, w:cssW-86, h:cssH-108};
  drawAxes(
    ctx,
    box,
    xMin, xMax,
    yMin, yMax,
    "Mode # within band (index)",
    "Detuning (ν − νc) [GHz]",
    "Discrete mode frequencies within the selected band"
  );

  // draw zero line
  ctx.save();
  ctx.strokeStyle = "rgba(255,255,255,0.22)";
  ctx.lineWidth = 1.5;
  const Y0 = mapY(0, yMin,yMax,box);
  ctx.beginPath();
  ctx.moveTo(box.x, Y0);
  ctx.lineTo(box.x+box.w, Y0);
  ctx.stroke();
  ctx.restore();

  // stems
  ctx.save();
  ctx.strokeStyle = "rgba(125,211,252,0.9)";
  ctx.lineWidth = 2;
  ctx.fillStyle = "rgba(167,139,250,0.95)";
  for(let i=0;i<modes.length;i++){
    const x = i;
    const det = (modes[i].nu - nuC)/1e9;
    const X = mapX(x, xMin,xMax,box);
    const Y = mapY(det, yMin,yMax,box);
    ctx.beginPath();
    ctx.moveTo(X, Y0);
    ctx.lineTo(X, Y);
    ctx.stroke();
    ctx.beginPath();
    ctx.arc(X, Y, 4.3, 0, Math.PI*2);
    ctx.fill();
  }
  ctx.restore();

  // annotate first and last with their M, q
  if (modes.length){
    ctx.save();
    ctx.fillStyle = "rgba(185,195,230,0.95)";
    ctx.font = "12px ui-monospace, Menlo, Consolas, monospace";
    const a = modes[0], b = modes[modes.length-1];
    ctx.fillText(`First: M=${a.M}, q=${a.q}, ν=${(a.nu/1e12).toFixed(6)} THz`, box.x, box.y+box.h+62);
    ctx.fillText(`Last:  M=${b.M}, q=${b.q}, ν=${(b.nu/1e12).toFixed(6)} THz`, box.x, box.y+box.h+80);
    ctx.restore();
  } else {
    ctx.save();
    ctx.fillStyle = "rgba(251,191,36,0.95)";
    ctx.font = "600 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText("No integer modes fall inside this band for the chosen parameters.", box.x, box.y+box.h/2);
    ctx.restore();
  }
}

function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

function renderAll(){
  renderDiagram();
  renderPlot1();
  renderPlot2();
}

updateLabels();
renderAll();

/* Smooth anchor scrolling */
document.querySelectorAll('a[href^="#"]').forEach(a=>{
  a.addEventListener("click",(e)=>{
    const id = a.getAttribute("href");
    if (!id || id.length < 2) return;
    const el = document.querySelector(id);
    if (!el) return;
    e.preventDefault();
    el.scrollIntoView({behavior:"smooth", block:"start"});
    history.pushState(null,"",id);
  });
});
</script>
</body>
</html>
