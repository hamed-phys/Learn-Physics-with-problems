<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Maximum Length of an Attenuation-Limited Optical Fiber Link (10 Mb/s, 870 nm)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#101827;
      --card:#0f1a2b;
      --text:#e8eefc;
      --muted:#b7c3dd;
      --faint:#7f8fb3;
      --accent:#7dd3fc;
      --accent2:#a7f3d0;
      --warn:#fbbf24;
      --danger:#fb7185;
      --ok:#86efac;
      --line:rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 15% 10%, rgba(125,211,252,.12), transparent 60%),
        radial-gradient(900px 500px at 85% 25%, rgba(167,243,208,.10), transparent 55%),
        radial-gradient(900px 500px at 55% 95%, rgba(251,191,36,.08), transparent 55%),
        var(--bg);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      position:relative;
      padding:34px 18px 22px;
      border-bottom:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.04), transparent);
    }
    .wrap{
      max-width:1120px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.1fr .55fr;
      gap:18px;
      align-items:start;
    }
    .hero{
      padding:18px 18px 16px;
      background:linear-gradient(180deg, rgba(125,211,252,.10), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    .kicker{
      color:var(--muted);
      font-size:14px;
      letter-spacing:.2px;
    }
    h1{
      margin:.25rem 0 .4rem;
      font-size:clamp(22px, 2.2vw + 14px, 36px);
      line-height:1.12;
    }
    .sub{
      margin:0;
      color:var(--muted);
      font-size:15px;
      max-width:72ch;
    }

    /* Sticky TOC */
    .toc{
      position:sticky;
      top:14px;
      align-self:start;
      padding:14px 14px 10px;
      border:1px solid var(--line);
      border-radius:var(--radius);
      background:rgba(16,24,39,.72);
      box-shadow:0 10px 24px rgba(0,0,0,.22);
      backdrop-filter: blur(10px);
    }
    .toc h2{
      margin:0 0 8px;
      font-size:13px;
      color:var(--muted);
      letter-spacing:.3px;
      text-transform:uppercase;
    }
    .toc ul{margin:0; padding-left:16px}
    .toc li{margin:6px 0; font-size:14px}
    .toc a{color:var(--text)}
    .toc a:hover{color:var(--accent); text-decoration:none}

    main{
      padding:18px;
    }
    .content{
      max-width:1120px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.1fr .55fr;
      gap:18px;
      align-items:start;
    }

    section{
      background:rgba(16,24,39,.58);
      border:1px solid var(--line);
      border-radius:var(--radius2);
      padding:18px;
      box-shadow:0 10px 26px rgba(0,0,0,.20);
      backdrop-filter: blur(10px);
      overflow:hidden;
      animation:pop .45s ease both;
    }
    @keyframes pop{
      from{transform:translateY(6px); opacity:.0}
      to{transform:translateY(0); opacity:1}
    }
    section h2{
      margin:0 0 10px;
      font-size:20px;
      letter-spacing:.2px;
    }
    section h3{
      margin:16px 0 8px;
      font-size:16px;
      color:var(--accent2);
      letter-spacing:.2px;
    }
    p{margin:8px 0}
    .muted{color:var(--muted)}
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:12px 12px 10px;
    }
    .callout{
      border-left:4px solid var(--accent);
      background:linear-gradient(90deg, rgba(125,211,252,.12), rgba(255,255,255,.02));
      padding:12px 12px 10px;
      border-radius:14px;
      border:1px solid rgba(125,211,252,.18);
    }
    .callout.warn{border-left-color:var(--warn); border-color:rgba(251,191,36,.22); background:linear-gradient(90deg, rgba(251,191,36,.12), rgba(255,255,255,.02));}
    .callout.danger{border-left-color:var(--danger); border-color:rgba(251,113,133,.22); background:linear-gradient(90deg, rgba(251,113,133,.12), rgba(255,255,255,.02));}
    .callout.ok{border-left-color:var(--ok); border-color:rgba(134,239,172,.22); background:linear-gradient(90deg, rgba(134,239,172,.12), rgba(255,255,255,.02));}
    ul{margin:8px 0 8px 18px}
    li{margin:6px 0}
    .eqbox{
      margin:10px 0;
      border:1px solid var(--line);
      border-radius:16px;
      overflow:hidden;
      background:rgba(0,0,0,.20);
    }
    .eqtop{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:center;
      padding:10px 10px 8px;
      border-bottom:1px solid var(--line);
      background:rgba(255,255,255,.03);
    }
    .eqtop .label{
      font-size:13px;
      color:var(--muted);
      letter-spacing:.2px;
      text-transform:uppercase;
    }
    pre.eq{
      margin:0;
      padding:10px 12px 12px;
      font-family:var(--mono);
      font-size:13px;
      line-height:1.45;
      color:#eaf2ff;
      overflow:auto;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{background:rgba(255,255,255,.10); border-color:rgba(255,255,255,.26)}
    .btn:active{transform:translateY(1px)}
    .tiny{
      font-size:12.5px;
      color:var(--muted);
    }
    .pillrow{
      display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 0;
    }
    .pill{
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background:rgba(255,255,255,.03);
    }
    details{
      border:1px dashed rgba(255,255,255,.18);
      border-radius:16px;
      padding:10px 12px;
      background:rgba(255,255,255,.02);
      margin:10px 0;
    }
    summary{
      cursor:pointer;
      color:var(--accent2);
      font-weight:600;
      outline:none;
    }
    summary::-webkit-details-marker{display:none}
    summary:before{
      content:"▸";
      display:inline-block;
      margin-right:8px;
      transform:translateY(-1px);
      transition:transform .15s ease;
      color:var(--accent2);
    }
    details[open] summary:before{transform:rotate(90deg) translateX(1px)}
    figure{
      margin:12px 0 0;
      padding:12px;
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(0,0,0,.18);
    }
    figcaption{
      margin-top:8px;
      font-size:12.5px;
      color:var(--muted);
    }
    canvas{width:100%; height:320px; display:block; border-radius:14px; background:rgba(8,12,20,.55); border:1px solid rgba(255,255,255,.10)}
    .rightcol section{position:sticky; top:14px}
    .mini{
      display:grid;
      grid-template-columns:1fr;
      gap:10px;
    }
    .table{
      width:100%;
      border-collapse:separate;
      border-spacing:0;
      overflow:hidden;
      border-radius:14px;
      border:1px solid var(--line);
      background:rgba(0,0,0,.15);
    }
    .table th,.table td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      font-size:13.5px;
      vertical-align:top;
    }
    .table th{
      text-align:left;
      color:var(--muted);
      background:rgba(255,255,255,.03);
      font-weight:650;
    }
    .table tr:last-child td{border-bottom:none}
    .kpi{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 10px 8px;
      background:rgba(255,255,255,.03);
    }
    .kpi .big{
      font-family:var(--mono);
      font-size:16px;
      margin:4px 0 0;
    }
    .backtop{
      display:inline-flex;
      align-items:center;
      gap:8px;
      margin-top:12px;
      padding:9px 12px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.05);
      color:var(--text);
    }
    .backtop:hover{background:rgba(255,255,255,.09); text-decoration:none}
    footer{
      padding:18px;
      color:var(--muted);
      font-size:13px;
      border-top:1px solid var(--line);
      background:linear-gradient(180deg, transparent, rgba(255,255,255,.03));
    }
    @media (max-width: 980px){
      .wrap,.content{grid-template-columns:1fr}
      .rightcol section{position:relative; top:auto}
      .toc{position:relative; top:auto}
      canvas{height:300px}
    }
    @media print{
      :root{ --bg:#ffffff; --panel:#ffffff; --card:#ffffff; --text:#000000; --muted:#222; --faint:#444; --line:#ddd; }
      body{background:#fff}
      header, footer{border-color:#ddd}
      .toc{display:none}
      section, .hero{box-shadow:none; backdrop-filter:none}
      .btn{display:none}
      a{color:#000; text-decoration:underline}
      section{break-inside:avoid; page-break-inside:avoid}
      .pagebreak{break-before:page; page-break-before:always}
    }
  </style>
</head>

<body>
<header id="top">
  <div class="wrap">
    <div class="hero">
      <div class="kicker">Photonics link budgeting • Attenuation-limited system • 10 Mb/s at 870 nm</div>
      <h1>Maximum Length of an Attenuation-Limited Optical Fiber Link</h1>
      <p class="sub">
        We convert receiver sensitivity given in <em>photons per bit</em> into <em>received power</em> (dBm), then use a
        practical engineering link budget (fiber loss + connectors + couplers + safety margin) to find the maximum
        link length for a PIN receiver and an APD receiver.
      </p>
      <div class="pillrow">
        <span class="pill">Industrial relevance: power margin & reliability</span>
        <span class="pill">Key idea: photons/bit ⇄ watts</span>
        <span class="pill">Answer: numeric (dBm, km)</span>
      </div>
    </div>

    <nav class="toc" aria-label="Table of contents">
      <h2>On this page</h2>
      <ul>
        <li><a href="#quick">Quick Summary</a></li>
        <li><a href="#p0">PART 0 — Concept Primer</a></li>
        <li><a href="#p0b">PART 0B — Industry & Applied Physics</a></li>
        <li><a href="#p1">PART 1 — Problem Analysis</a></li>
        <li><a href="#p2">PART 2 — Strategy & Tips</a></li>
        <li><a href="#p3">PART 3 — Full Solution</a></li>
        <li><a href="#p4">PART 4 — Deeper Understanding</a></li>
        <li><a href="#p5">PART 5 — Optional Plot Guide</a></li>
      </ul>
    </nav>
  </div>
</header>

<main>
  <div class="content">
    <article>
      <section id="quick">
        <h2>Quick Summary</h2>
        <ul>
          <li><strong>What this is about:</strong> maximum fiber-link length when <em>attenuation and insertion losses</em> dominate.</li>
          <li><strong>Key physics idea:</strong> receiver sensitivity stated as <em>photons/bit</em> is converted to <em>minimum average received power</em>.</li>
          <li><strong>Photon energy:</strong> E<sub>ph</sub> = h·c/λ (J per photon).</li>
          <li><strong>Power from photons/bit:</strong> P<sub>r,sens</sub> = (N<sub>ph/bit</sub> · E<sub>ph</sub>) · R<sub>b</sub>.</li>
          <li><strong>Engineering link budget:</strong> P<sub>r</sub>(dBm) = P<sub>tx</sub>(dBm) − [fiber loss + connector loss + coupler loss + safety margin].</li>
          <li><strong>Here:</strong> fiber attenuation = 3.5 dB/km, connectors between 1-km segments = 1 dB each, input+output couplers = 2 dB each, safety margin = 6 dB.</li>
          <li><strong>Results (numeric):</strong> PIN sensitivity ≈ −49.4 dBm ⇒ max length ≈ <strong>6 km</strong>; APD sensitivity ≈ −65.45 dBm ⇒ max length ≈ <strong>10 km</strong>.</li>
          <li><strong>Physical meaning:</strong> APD needs far fewer photons/bit, so it tolerates much larger total path loss and thus longer distance.</li>
        </ul>
      </section>

      <section id="p0">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <h3>Core definitions (symbols + SI units)</h3>
        <div class="grid2">
          <div class="card">
            <ul>
              <li><strong>Bit rate</strong> R<sub>b</sub> (s<sup>−1</sup>) — bits per second (here 10 Mb/s).</li>
              <li><strong>Wavelength</strong> λ (m) — sets photon energy (here 870 nm).</li>
              <li><strong>Photon energy</strong> E<sub>ph</sub> (J) — energy carried by one photon.</li>
              <li><strong>Photons per bit</strong> N<sub>ph/bit</sub> (dimensionless) — sensitivity metric.</li>
              <li><strong>Average optical power</strong> P (W) — time-averaged received power.</li>
            </ul>
          </div>
          <div class="card">
            <ul>
              <li><strong>Attenuation</strong> α (dB/km) — distributed loss per kilometer.</li>
              <li><strong>Insertion loss</strong> L (dB) — discrete losses (connectors, couplers).</li>
              <li><strong>Power in dBm</strong> — 10·log<sub>10</sub>(P/1 mW).</li>
              <li><strong>Safety margin</strong> M (dB) — reserve for aging, dirt, temp drift.</li>
            </ul>
          </div>
        </div>

        <h3>Physical meaning (intuition)</h3>
        <p class="muted">
          “Photons per bit” is an energy-per-information requirement: if a receiver needs N photons to reliably decide one bit,
          then it needs at least N·E<sub>ph</sub> joules of optical energy arriving during that bit period. Multiply by bit rate to
          convert to average power. In the field, engineers then subtract all the losses (distributed + discrete) and demand a
          safety cushion to ensure the link works in real conditions, not just in the lab.
        </p>

        <div class="callout">
          <strong>Key connection:</strong> Sensitivity in photons/bit ↔ minimum received average power.
          <div class="eqbox" role="group" aria-label="Key equation">
            <div class="eqtop">
              <div class="label">Key equations (copyable)</div>
              <button class="btn" type="button" data-copy="eq-key">Copy</button>
            </div>
            <pre id="eq-key" class="eq">Photon energy:      E_ph = (h c)/λ           [J]
Energy per bit:     E_bit = N_ph/bit · E_ph  [J/bit]
Min received power: P_r,sens = E_bit · R_b   [W]
dBm conversion:     P(dBm) = 10 log10(P/1mW) [dBm]</pre>
          </div>
        </div>

        <h3>Validity conditions & assumptions (when this model is appropriate)</h3>
        <ul>
          <li><strong>Attenuation-limited link:</strong> dispersion and bandwidth penalties are neglected (reasonable here because the problem explicitly targets attenuation limit at 10 Mb/s).</li>
          <li><strong>Given photon sensitivities already “include” receiver realities:</strong> quantum efficiency, noise, decision statistics are rolled into the stated photons/bit numbers (we treat them as required photons arriving at the detector).</li>
          <li><strong>Losses in dB add linearly:</strong> distributed and discrete losses are summed in dB for power budgeting.</li>
          <li><strong>Average power model:</strong> we use average optical power consistent with typical receiver sensitivity definitions at a stated bit rate.</li>
        </ul>

        <h3>Common models/approximations and why engineers use them</h3>
        <ul>
          <li><strong>Decibel link budget:</strong> turns multiplicative transmission factors into additive bookkeeping — ideal for quick design checks.</li>
          <li><strong>“Worst-case” margining:</strong> includes safety margin to account for connector contamination, bending, aging, temperature drift, and manufacturing tolerances.</li>
          <li><strong>Segmented connector counting:</strong> when fiber is installed in fixed spools/sections, connector losses can dominate long-term reliability and service costs.</li>
        </ul>

        <h3>Mini intuition examples (minimal algebra)</h3>
        <ul>
          <li><strong>Shorter wavelength → higher photon energy:</strong> for the same photons/bit, shorter λ means higher required power (because each photon costs more energy).</li>
          <li><strong>Higher bit rate → higher required power:</strong> if you need the same photons per bit but send bits faster, you need proportionally more watts.</li>
          <li><strong>More connectors → shorter range:</strong> a few dB of insertion loss can equal kilometers of fiber loss.</li>
        </ul>

        <div class="callout warn">
          <strong>What to watch for (pitfalls)</strong>
          <ul>
            <li>Mixing up <strong>photons/bit</strong> with photons/second (you must multiply by bit rate).</li>
            <li>Forgetting <strong>coupler losses</strong> and <strong>safety margin</strong> in the link budget.</li>
            <li>Connector counting: for N one-kilometer segments, connectors between them are <strong>(N − 1)</strong>, not N.</li>
            <li>Confusing dBm (absolute) with dB (relative).</li>
          </ul>
        </div>

        <details>
          <summary>Deeper note: why APDs “buy” distance</summary>
          <p class="muted">
            An avalanche photodiode (APD) provides internal gain through impact ionization, effectively amplifying the
            photocurrent before the preamplifier noise dominates. The trade-off is excess noise from the multiplication
            process and higher bias/control complexity. In link budgets, APDs often translate into several–tens of dB
            improved sensitivity (here: photons/bit improve by a factor of 5000/125 = 40, which is 10·log10(40) ≈ 16 dB).
          </p>
        </details>

        <a class="backtop" href="#top" aria-label="Back to top">↑ Back to top</a>
      </section>

      <section id="p0b">
        <h2>PART 0B — Industry & Applied Physics Perspective</h2>

        <h3>Where this appears in industry (concrete application areas)</h3>
        <ul>
          <li><strong>Industrial automation networks:</strong> factory fieldbuses and fiber sensor backbones where rugged connectors and maintenance intervals matter.</li>
          <li><strong>Campus / building fiber links:</strong> short-to-medium distance links with many patch panels (connector-heavy).</li>
          <li><strong>Harsh-environment sensing:</strong> distributed sensors in rail, energy, and aerospace where safety margin is mandatory for reliability.</li>
        </ul>

        <h3>Why engineers care</h3>
        <div class="grid2">
          <div class="callout">
            <strong>Performance & reliability</strong>
            <ul>
              <li>Meeting BER targets depends on receiving enough optical energy per bit.</li>
              <li>Margins protect against real-world degradation (dust, bend loss, aging).</li>
            </ul>
          </div>
          <div class="callout">
            <strong>Cost & maintainability</strong>
            <ul>
              <li>More segments/connectors increase install flexibility but add loss and failure points.</li>
              <li>Choosing APD vs PIN affects BOM cost, bias circuits, and thermal management.</li>
            </ul>
          </div>
        </div>

        <h3>Typical measurement/validation methods</h3>
        <ul>
          <li><strong>Optical power meter + calibrated source:</strong> verifies insertion losses and end-to-end received power.</li>
          <li><strong>OTDR (optical time-domain reflectometry):</strong> localizes connector/splice losses and fiber attenuation by distance.</li>
          <li><strong>BER testing:</strong> validates that the photon/bit (or power) margin is sufficient under operational conditions.</li>
        </ul>

        <h3>Design trade-offs & constraints</h3>
        <ul>
          <li><strong>Connector quality vs serviceability:</strong> high-quality connectors reduce loss but cost more; more connectors ease maintenance but shrink the power budget.</li>
          <li><strong>Safety margin selection:</strong> larger margins increase reliability but reduce maximum reach (or require a stronger source / better receiver).</li>
          <li><strong>Receiver choice (PIN vs APD):</strong> APD extends reach but adds bias complexity, temperature dependence, and potential reliability considerations.</li>
        </ul>

        <details>
          <summary>From lab to product: adapting the idealized model</summary>
          <p class="muted">
            In production, engineers often replace “single number” losses with distributions: connector loss variance,
            aging curves, and temperature ranges. The safety margin is then set using statistical yield targets
            (e.g., 99.9% links meet BER), not just a fixed dB guess. Still, the same backbone equations remain the
            first-pass design tool and the basis for requirements documents and acceptance testing.
          </p>
        </details>

        <a class="backtop" href="#top">↑ Back to top</a>
      </section>

      <section id="p1">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <h3>Restate the problem (clear wording)</h3>
        <p>
          An optical fiber link operates at <strong>10 Mb/s</strong>. The transmitter is a <strong>100 μW LED at 870 nm</strong>.
          The fiber has attenuation <strong>3.5 dB/km</strong>. The cable is installed in <strong>1-km segments</strong> with a
          <strong>1 dB connector loss</strong> at each connector between segments. The <strong>input and output couplers</strong>
          each add <strong>2 dB</strong> loss, and a <strong>6 dB safety margin</strong> is required.
          Two receiver options are available, specified by sensitivity in photons/bit:
          <strong>PIN:</strong> 5000 photons/bit, <strong>APD:</strong> 125 photons/bit.
          We must find (1) each receiver’s sensitivity in <strong>dBm</strong> and (2) the <strong>maximum link length</strong>
          (in km) allowed by the power budget.
        </p>

        <h3>Given quantities</h3>
        <table class="table" aria-label="Given quantities">
          <tr><th>Quantity</th><th>Symbol</th><th>Value</th></tr>
          <tr><td>Bit rate</td><td>R<sub>b</sub></td><td>10 Mb/s = 10×10<sup>6</sup> s<sup>−1</sup></td></tr>
          <tr><td>Wavelength</td><td>λ</td><td>870 nm = 870×10<sup>−9</sup> m</td></tr>
          <tr><td>Transmitter power</td><td>P<sub>tx</sub></td><td>100 μW = 1.0×10<sup>−4</sup> W</td></tr>
          <tr><td>Fiber attenuation</td><td>α</td><td>3.5 dB/km</td></tr>
          <tr><td>Segment length</td><td>ℓ</td><td>1 km (fixed)</td></tr>
          <tr><td>Connector loss between segments</td><td>L<sub>c</sub></td><td>1 dB each</td></tr>
          <tr><td>Input coupler loss</td><td>L<sub>in</sub></td><td>2 dB</td></tr>
          <tr><td>Output coupler loss</td><td>L<sub>out</sub></td><td>2 dB</td></tr>
          <tr><td>Safety margin</td><td>M</td><td>6 dB</td></tr>
          <tr><td>PIN sensitivity</td><td>N<sub>ph/bit</sub></td><td>5000 photons/bit</td></tr>
          <tr><td>APD sensitivity</td><td>N<sub>ph/bit</sub></td><td>125 photons/bit</td></tr>
        </table>

        <h3>Unknowns (what we must find)</h3>
        <ul>
          <li>Receiver sensitivity power <strong>P<sub>r,sens</sub></strong> in <strong>dBm</strong> for PIN and APD.</li>
          <li>Maximum number of 1-km segments <strong>N</strong> (thus maximum length <strong>L = N km</strong>) for each receiver.</li>
        </ul>

        <h3>Relevant principles and why they apply</h3>
        <ul>
          <li><strong>Photon energy relation</strong> E<sub>ph</sub> = h·c/λ applies because sensitivity is given in photons/bit.</li>
          <li><strong>Power = energy/time</strong> converts energy/bit to watts using the bit rate R<sub>b</sub>.</li>
          <li><strong>Decibel addition</strong> applies because multiple losses in series multiply in linear power units but add in dB.</li>
        </ul>

        <h3>Explicit assumptions</h3>
        <div class="callout warn">
          <strong>Assumptions used in this solution</strong>
          <ul>
            <li>Photon sensitivities (photons/bit) refer to photons arriving at the receiver input (after all losses).</li>
            <li>Transmitter power is the launched optical power before coupler losses.</li>
            <li>Dispersion and bandwidth penalties are ignored (attenuation-limited by statement of problem).</li>
            <li>Loss values are fixed and independent of length (except fiber attenuation and number of connectors).</li>
            <li>Length must be an integer number of 1-km segments.</li>
          </ul>
        </div>

        <h3>Possible approaches (compare 2–3)</h3>
        <div class="grid2">
          <div class="card">
            <strong>Approach A — Full dB link budget (recommended)</strong>
            <ul class="muted">
              <li>Convert receiver sensitivity to dBm.</li>
              <li>Compute total allowable loss: P<sub>tx</sub> − P<sub>r,sens</sub>.</li>
              <li>Subtract fixed losses and solve for length.</li>
            </ul>
            <div class="tiny"><strong>Pros:</strong> fast, industry standard. <strong>Cons:</strong> hides linear-unit intuition unless explained.</div>
          </div>
          <div class="card">
            <strong>Approach B — Linear power ratios</strong>
            <ul class="muted">
              <li>Convert every dB loss to multiplicative factors.</li>
              <li>Multiply factors and solve for L via exponentials.</li>
            </ul>
            <div class="tiny"><strong>Pros:</strong> direct physics of power flow. <strong>Cons:</strong> messy; dB is cleaner for many components.</div>
          </div>
        </div>
        <div class="card">
          <strong>Approach C — “Loss per km + overhead” heuristic</strong>
          <p class="muted" style="margin:6px 0 0">
            Combine distributed loss (dB/km) with average connector loss per km to get an effective slope, then solve.
            Works well when segment length is fixed (here: 1 km).
          </p>
          <div class="tiny"><strong>Pros:</strong> quick mental math. <strong>Cons:</strong> must be careful with connector counting (N−1).</div>
        </div>

        <p><strong>Chosen approach:</strong> Approach A (dB link budget), because it matches how optical links are specified, installed, and validated in industry, and it cleanly incorporates discrete losses and safety margin.</p>

        <a class="backtop" href="#top">↑ Back to top</a>
      </section>

      <section id="p2">
        <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

        <ol>
          <li><strong>Compute photon energy</strong> using E<sub>ph</sub>=h·c/λ (sets joules/photon).</li>
          <li><strong>Convert photons/bit to energy/bit</strong>: E<sub>bit</sub>=N<sub>ph/bit</sub>·E<sub>ph</sub> (physical meaning: energy that must reach the detector per decision).</li>
          <li><strong>Convert to received power</strong>: P<sub>r,sens</sub>=E<sub>bit</sub>·R<sub>b</sub> (watts).</li>
          <li><strong>Convert watts to dBm</strong> for receiver sensitivity (absolute power reference).</li>
          <li><strong>Convert transmitter power to dBm</strong> to use a consistent dB arithmetic system.</li>
          <li><strong>Write total loss model</strong> for N one-kilometer segments:
            fiber loss + connector loss + couplers + margin.</li>
          <li><strong>Impose the budget inequality</strong>: P<sub>rx</sub>(dBm) ≥ P<sub>r,sens</sub>(dBm).</li>
          <li><strong>Solve for N</strong>, then choose the largest integer N allowed (because segments are 1 km each).</li>
          <li><strong>Report results</strong> for both receivers; compare and interpret physically.</li>
        </ol>

        <div class="callout danger">
          <strong>Common mistakes (quick fixes)</strong>
          <ul>
            <li><strong>Forgetting R<sub>b</sub>:</strong> photons/bit → power requires multiplying by bit rate.</li>
            <li><strong>Connector count error:</strong> N segments have (N−1) connectors between them.</li>
            <li><strong>dBm vs dB:</strong> dBm is absolute power; dB is relative loss/gain.</li>
            <li><strong>Neglecting margin:</strong> margin is not optional in industrial links.</li>
          </ul>
        </div>

        <a class="backtop" href="#top">↑ Back to top</a>
      </section>

      <section id="p3">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Qualitative expectation (before calculating)</h3>
        <p class="muted">
          The APD requires far fewer photons per bit than the PIN receiver, so it should tolerate more total attenuation.
          Therefore, we expect a significantly longer maximum distance for the APD. Also, because the link has connectors every
          kilometer, discrete 1 dB losses will noticeably reduce reach compared to fiber attenuation alone.
        </p>

        <h3>Step 1: Convert receiver sensitivity (photons/bit) → received power (W)</h3>
        <p>
          First compute photon energy at wavelength λ:
        </p>

        <div class="eqbox" role="group" aria-label="Photon energy equation">
          <div class="eqtop">
            <div class="label">Photon energy</div>
            <button class="btn" type="button" data-copy="eq-eph">Copy</button>
          </div>
          <pre id="eq-eph" class="eq">E_ph = (h c)/λ

h = 6.62607015×10^-34 J·s
c = 2.99792458×10^8 m/s
λ = 870×10^-9 m</pre>
        </div>

        <p>
          Numerically:
          <span class="muted">
            E<sub>ph</sub> = (6.62607015×10<sup>−34</sup>)(2.99792458×10<sup>8</sup>)/(870×10<sup>−9</sup>)
            ≈ 2.283×10<sup>−19</sup> J per photon.
          </span>
        </p>

        <p>
          Energy required per bit is then:
          E<sub>bit</sub> = N<sub>ph/bit</sub> · E<sub>ph</sub>.
          Convert to average received power using bit rate R<sub>b</sub>:
          P<sub>r,sens</sub> = E<sub>bit</sub> · R<sub>b</sub>.
        </p>

        <div class="eqbox" role="group" aria-label="Sensitivity power equation">
          <div class="eqtop">
            <div class="label">Photons/bit → watts</div>
            <button class="btn" type="button" data-copy="eq-pr">Copy</button>
          </div>
          <pre id="eq-pr" class="eq">E_bit = N_ph/bit · E_ph
P_r,sens = E_bit · R_b = N_ph/bit · E_ph · R_b</pre>
        </div>

        <p>Now compute for each receiver (R<sub>b</sub> = 10×10<sup>6</sup> s<sup>−1</sup>):</p>

        <div class="grid2">
          <div class="card">
            <strong>PIN receiver (5000 photons/bit)</strong>
            <pre class="eq" style="margin-top:8px">P_r,sens = 5000 · (2.283×10^-19) · (1.0×10^7)
        ≈ 1.1416×10^-8 W</pre>
            <div class="tiny muted">This is about 11.4 nW average power.</div>
          </div>
          <div class="card">
            <strong>APD receiver (125 photons/bit)</strong>
            <pre class="eq" style="margin-top:8px">P_r,sens = 125 · (2.283×10^-19) · (1.0×10^7)
        ≈ 2.8541×10^-10 W</pre>
            <div class="tiny muted">This is about 0.285 nW average power.</div>
          </div>
        </div>

        <h3>Step 2: Convert sensitivity to dBm</h3>
        <p>
          dBm is defined by:
          P(dBm) = 10 log<sub>10</sub>(P / 1 mW) = 10 log<sub>10</sub>(P / 10<sup>−3</sup> W).
        </p>

        <div class="eqbox" role="group" aria-label="dBm conversion equation">
          <div class="eqtop">
            <div class="label">Watts → dBm</div>
            <button class="btn" type="button" data-copy="eq-dbm">Copy</button>
          </div>
          <pre id="eq-dbm" class="eq">P(dBm) = 10 log10(P / 1 mW) = 10 log10(P / 10^-3 W)</pre>
        </div>

        <p>Apply to each sensitivity power:</p>

        <div class="kpi">
          <div class="box">
            <div class="tiny">PIN sensitivity P<sub>r,sens</sub></div>
            <div class="big">≈ −49.42 dBm</div>
            <div class="tiny muted">(from 1.1416×10<sup>−8</sup> W)</div>
          </div>
          <div class="box">
            <div class="tiny">APD sensitivity P<sub>r,sens</sub></div>
            <div class="big">≈ −65.45 dBm</div>
            <div class="tiny muted">(from 2.8541×10<sup>−10</sup> W)</div>
          </div>
        </div>

        <h3>Step 3: Transmitter power in dBm</h3>
        <p>
          The source power is 100 μW = 1.0×10<sup>−4</sup> W = 0.1 mW, so:
        </p>
        <pre class="eq">P_tx(dBm) = 10 log10(0.1 mW / 1 mW) = 10 log10(0.1) = −10 dBm</pre>

        <h3>Step 4: Build the practical loss model (N segments of 1 km)</h3>
        <p>
          Let N be the number of 1-km fiber segments. Then the total length is L = N km.
        </p>
        <ul>
          <li><strong>Fiber loss:</strong> α·L = (3.5 dB/km)·N.</li>
          <li><strong>Connectors between segments:</strong> there is one connector between adjacent segments, so there are (N − 1) connectors, each 1 dB → (N − 1) dB.</li>
          <li><strong>Couplers:</strong> input + output = 2 dB + 2 dB = 4 dB.</li>
          <li><strong>Safety margin:</strong> 6 dB.</li>
        </ul>

        <div class="callout">
          <strong>Total link loss (dB)</strong>
          <div class="eqbox" role="group" aria-label="Total loss equation">
            <div class="eqtop">
              <div class="label">Loss model (copyable)</div>
              <button class="btn" type="button" data-copy="eq-loss">Copy</button>
            </div>
            <pre id="eq-loss" class="eq">Let N = number of 1-km segments (so L = N km).

Total loss = fiber + connectors + couplers + margin
           = (3.5 N) + [1·(N−1)] + 4 + 6
           = 4.5 N + 9   dB</pre>
          </div>
        </div>

        <h3>Step 5: Apply the power budget inequality and solve for N</h3>
        <p>
          Received power in dBm is:
        </p>
        <pre class="eq">P_rx(dBm) = P_tx(dBm) − (Total loss in dB) = −10 − (4.5 N + 9)</pre>

        <p>
          The link must satisfy P<sub>rx</sub>(dBm) ≥ P<sub>r,sens</sub>(dBm).
          Therefore:
        </p>

        <div class="eqbox" role="group" aria-label="Budget inequality">
          <div class="eqtop">
            <div class="label">Solve for maximum N</div>
            <button class="btn" type="button" data-copy="eq-N">Copy</button>
          </div>
          <pre id="eq-N" class="eq">Require:  P_tx(dBm) − (4.5 N + 9)  ≥  P_r,sens(dBm)

So:        4.5 N + 9  ≤  P_tx(dBm) − P_r,sens(dBm)

Thus:      N  ≤  [ P_tx(dBm) − P_r,sens(dBm) − 9 ] / 4.5</pre>
        </div>

        <p>Now plug in numbers for each receiver.</p>

        <div class="grid2">
          <div class="card">
            <strong>PIN receiver</strong>
            <pre class="eq" style="margin-top:8px">P_r,sens ≈ −49.42 dBm
N ≤ [ (−10) − (−49.42) − 9 ] / 4.5
  ≤ (39.42 − 9) / 4.5
  ≤ 30.42 / 4.5
  ≤ 6.76</pre>
            <p class="muted" style="margin-top:6px">
              Because the fiber is made of 1-km segments, N must be an integer. So the maximum is:
              <strong>N_max = 6</strong> ⇒ <strong>L_max = 6 km</strong>.
            </p>
            <details>
              <summary>Check the next integer (why not 7 km?)</summary>
              <pre class="eq">For N = 7:
Total loss = 4.5(7)+9 = 40.5 dB
P_rx = −10 − 40.5 = −50.5 dBm  (below −49.42 dBm) → fails</pre>
            </details>
          </div>

          <div class="card">
            <strong>APD receiver</strong>
            <pre class="eq" style="margin-top:8px">P_r,sens ≈ −65.45 dBm
N ≤ [ (−10) − (−65.45) − 9 ] / 4.5
  ≤ (55.45 − 9) / 4.5
  ≤ 46.45 / 4.5
  ≤ 10.32</pre>
            <p class="muted" style="margin-top:6px">
              Integer constraint gives:
              <strong>N_max = 10</strong> ⇒ <strong>L_max = 10 km</strong>.
            </p>
            <details>
              <summary>Check the next integer (why not 11 km?)</summary>
              <pre class="eq">For N = 11:
Total loss = 4.5(11)+9 = 58.5 dB
P_rx = −10 − 58.5 = −68.5 dBm  (below −65.45 dBm) → fails</pre>
            </details>
          </div>
        </div>

        <h3>Sanity checks</h3>
        <div class="grid2">
          <div class="callout ok">
            <strong>Units/dimensions</strong>
            <ul>
              <li>E<sub>ph</sub> has units J (because h·c/λ → (J·s)(m/s)/m = J).</li>
              <li>P<sub>r,sens</sub> = (J/bit)(bit/s) = J/s = W.</li>
              <li>Loss accounting is in dB; received power in dBm is consistent.</li>
            </ul>
          </div>
          <div class="callout ok">
            <strong>Limiting/consistency checks</strong>
            <ul>
              <li>If margin increases, the allowed N decreases linearly (makes sense).</li>
              <li>If connector loss were zero, slope would drop from 4.5 to 3.5 dB/km, extending range (intuitive).</li>
              <li>APD vs PIN sensitivity difference:
                10·log<sub>10</sub>(5000/125)=10·log<sub>10</sub>(40)≈16 dB → explains ~3–4 km extra reach with ~4.5 dB/km effective loss.</li>
            </ul>
          </div>
        </div>

        <h3>Final results (boxed)</h3>
        <div class="callout ok">
          <strong>Final Answer</strong>
          <div class="eqbox" role="group" aria-label="Final answer (copyable)">
            <div class="eqtop">
              <div class="label">Final answer (copy plain text)</div>
              <button class="btn" type="button" data-copy="final">Copy</button>
            </div>
            <pre id="final" class="eq">Given: Rb = 10 Mb/s, λ = 870 nm, Ptx = 100 μW = −10 dBm
Loss model for N (1-km) segments: Total loss = 4.5 N + 9  dB

Photon energy: Eph = hc/λ ≈ 2.283×10^-19 J

Receiver sensitivities:
• PIN (5000 photons/bit):
  Pr,sens = 5000·Eph·Rb ≈ 1.1416×10^-8 W  →  Pr,sens ≈ −49.42 dBm
  Nmax = floor([−10 − (−49.42) − 9]/4.5) = floor(6.76) = 6
  Lmax = 6 km

• APD (125 photons/bit):
  Pr,sens = 125·Eph·Rb ≈ 2.8541×10^-10 W →  Pr,sens ≈ −65.45 dBm
  Nmax = floor([−10 − (−65.45) − 9]/4.5) = floor(10.32) = 10
  Lmax = 10 km</pre>
          </div>
        </div>

        <figure aria-label="Static plot: received power vs distance">
          <canvas id="plot" width="900" height="520"></canvas>
          <figcaption>
            Static plot (not interactive): received power versus distance using the given loss model, with horizontal lines
            marking the two receiver sensitivity thresholds (PIN and APD). The maximum usable length occurs where the received
            power curve falls to the sensitivity line (with integer-km constraint).
          </figcaption>
        </figure>

        <a class="backtop" href="#top">↑ Back to top</a>
      </section>

      <section id="p4" class="pagebreak">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpreting the final formula</h3>
        <p>
          The core constraint is:
        </p>
        <pre class="eq">P_tx(dBm) − [4.5 N + 9]  ≥  P_r,sens(dBm)</pre>
        <p class="muted">
          Each term has a clear engineering meaning:
        </p>
        <ul>
          <li><strong>P<sub>tx</sub>:</strong> “how much optical budget you start with.”</li>
          <li><strong>4.5 N:</strong> “how fast the budget is consumed per km” (3.5 dB/km fiber + ~1 dB/km connectors in this installation style).</li>
          <li><strong>+9 dB overhead:</strong> fixed penalties: connectors offset (−1 dB), plus couplers (4 dB) and margin (6 dB) → net +9 dB.</li>
          <li><strong>P<sub>r,sens</sub>:</strong> “how low the receiver can go” before BER becomes unacceptable.</li>
        </ul>

        <h3>Parameter dependence (what changes what?)</h3>
        <div class="grid2">
          <div class="card">
            <strong>Bit rate R<sub>b</sub></strong>
            <p class="muted">
              P<sub>r,sens</sub> ∝ R<sub>b</sub>. Doubling bit rate requires ~3 dB more received power (because 10·log10(2) ≈ 3 dB),
              reducing maximum length by roughly 3/4.5 ≈ 0.67 km in this system.
            </p>
          </div>
          <div class="card">
            <strong>Wavelength λ</strong>
            <p class="muted">
              E<sub>ph</sub> ∝ 1/λ. Longer wavelength lowers photon energy, improving sensitivity in watts for a fixed photons/bit requirement.
              (Real systems also have wavelength-dependent fiber attenuation and detector responsivity.)
            </p>
          </div>
          <div class="card">
            <strong>Connector/coupler losses</strong>
            <p class="muted">
              Each extra 1 dB discrete loss is equivalent to about 1/4.5 ≈ 0.22 km of reach here.
              In connector-dense installations, cleaning and connector selection can matter as much as kilometers of fiber.
            </p>
          </div>
          <div class="card">
            <strong>Safety margin M</strong>
            <p class="muted">
              Margin directly subtracts from available loss budget. Increasing margin from 6 dB to 9 dB would reduce N by 3/4.5 ≈ 0.67 km.
              Industrial practice often prefers slightly shorter reach with robust margin for lower downtime risk.
            </p>
          </div>
        </div>

        <h3>Alternative derivation idea (brief but meaningful)</h3>
        <p class="muted">
          You can compute the allowable total transmission factor in linear units:
          T = P<sub>r,sens</sub>/P<sub>tx</sub>, then write each loss as a multiplicative factor
          (10<sup>−loss(dB)/10</sup>) and solve for N. This yields the same result but with more algebra; the dB method is
          simply the logarithm of that multiplicative approach.
        </p>

        <h3>Concept check (self-test Q&A)</h3>
        <ul>
          <li><strong>Q:</strong> If the photons/bit requirement decreases by a factor of 10, how does sensitivity in dBm change?
              <br><strong>A:</strong> It improves by 10 dB (because 10·log10(1/10) = −10 dB).</li>
          <li><strong>Q:</strong> Why do losses add in dB?
              <br><strong>A:</strong> Because dB is logarithmic; multiplying power ratios becomes addition of their logarithms.</li>
          <li><strong>Q:</strong> Why is there (N−1) connectors, not N?
              <br><strong>A:</strong> Connectors are between segments; N segments create N−1 interfaces between them.</li>
          <li><strong>Q:</strong> What practical issues does a 6 dB margin cover?
              <br><strong>A:</strong> Aging, temperature drift, bending, connector contamination, component tolerances, maintenance variability.</li>
        </ul>

        <a class="backtop" href="#top">↑ Back to top</a>
      </section>

      <section id="p5">
        <h2>PART 5 — Optional Plot Guide</h2>
        <p>
          A plot is useful here because the link budget is essentially a <strong>straight line in dB</strong>:
          received power decreases linearly with distance when loss per km is constant and connectors scale with segment count.
          The intersections with sensitivity thresholds directly show maximum reach.
        </p>

        <h3>What the plot shows</h3>
        <ul>
          <li><strong>x-axis:</strong> link length L (km), using integer km segments.</li>
          <li><strong>y-axis:</strong> received power P<sub>rx</sub> (dBm).</li>
          <li><strong>Main curve:</strong> P<sub>rx</sub>(dBm) = −10 − (4.5L + 9), evaluated at L in km (here L is treated continuously for the line, but segment constraint is enforced in the final answer).</li>
          <li><strong>Horizontal lines:</strong> receiver sensitivity levels: PIN ≈ −49.42 dBm, APD ≈ −65.45 dBm.</li>
          <li><strong>Feature to notice:</strong> the slope is −4.5 dB per km, meaning each km “costs” 4.5 dB of budget.</li>
        </ul>

        <a class="backtop" href="#top">↑ Back to top</a>
      </section>
    </article>

    <aside class="rightcol" aria-label="Side summary panel">
      <section>
        <h2>At-a-glance results</h2>
        <div class="mini">
          <div class="callout">
            <strong>Transmitter</strong>
            <div class="tiny muted">100 μW → <span style="font-family:var(--mono); color:var(--text)">−10 dBm</span></div>
          </div>

          <div class="card">
            <strong>Loss model (N km)</strong>
            <div class="tiny muted" style="margin-top:6px">Total loss = (3.5N) + (N−1) + 4 + 6 = <span style="font-family:var(--mono); color:var(--text)">4.5N + 9 dB</span></div>
          </div>

          <div class="card">
            <strong>Sensitivities</strong>
            <table class="table" aria-label="Sensitivities summary">
              <tr><th>Receiver</th><th>P<sub>r,sens</sub> (dBm)</th></tr>
              <tr><td>Si PIN</td><td style="font-family:var(--mono)">−49.42</td></tr>
              <tr><td>Si APD</td><td style="font-family:var(--mono)">−65.45</td></tr>
            </table>
          </div>

          <div class="card">
            <strong>Max lengths</strong>
            <table class="table" aria-label="Maximum length summary">
              <tr><th>Receiver</th><th>N<sub>max</sub> (km)</th></tr>
              <tr><td>Si PIN</td><td style="font-family:var(--mono)">6</td></tr>
              <tr><td>Si APD</td><td style="font-family:var(--mono)">10</td></tr>
            </table>
            <div class="tiny muted" style="margin-top:8px">
              Integer constraint applied (1-km segments).
            </div>
          </div>

          <details>
            <summary>Industrial note: why margins are “real money”</summary>
            <p class="muted">
              A few dB of margin can prevent truck rolls, downtime, and intermittent faults.
              In industrial environments, connector contamination and bend losses are common, so the margin is often a business decision:
              reduce warranty risk vs maximize reach.
            </p>
          </details>

          <a class="backtop" href="#top">↑ Back to top</a>
        </div>
      </section>
    </aside>
  </div>
</main>

<footer>
  <div class="wrap" style="grid-template-columns:1fr; gap:10px">
    <div>
      <strong>Note:</strong> This solution uses the problem’s stated “photons/bit” sensitivities as effective required photons at the receiver input.
      In detailed receiver design, these values would be derived from quantum efficiency, noise statistics, bandwidth, and required BER, but the
      link-budget method remains the standard first-order engineering tool.
    </div>
    <div class="tiny muted">© Self-contained educational article. No external libraries used.</div>
  </div>
</footer>

<script>
  // Copy buttons (plain text copy)
  (function(){
    function copyTextFromElementId(id){
      const el = document.getElementById(id);
      if(!el) return;
      const txt = el.textContent.replace(/\u00a0/g,' ');
      navigator.clipboard.writeText(txt).then(()=> {
        flash(el);
      }).catch(()=> {
        // Fallback: selection
        try{
          const range = document.createRange();
          range.selectNodeContents(el);
          const sel = window.getSelection();
          sel.removeAllRanges();
          sel.addRange(range);
          document.execCommand('copy');
          sel.removeAllRanges();
          flash(el);
        }catch(e){}
      });
    }
    function flash(el){
      const old = el.style.outline;
      el.style.outline = "2px solid rgba(167,243,208,.65)";
      el.style.outlineOffset = "3px";
      setTimeout(()=>{ el.style.outline = old; el.style.outlineOffset=""; }, 450);
    }
    document.addEventListener('click', (ev)=>{
      const btn = ev.target.closest('button[data-copy]');
      if(!btn) return;
      const id = btn.getAttribute('data-copy');
      copyTextFromElementId(id);
      btn.textContent = "Copied!";
      setTimeout(()=>btn.textContent="Copy", 900);
    });
  })();

  // Static plot (one canvas): received power vs length with sensitivity lines
  (function(){
    const canvas = document.getElementById('plot');
    if(!canvas) return;
    const ctx = canvas.getContext('2d');

    // Given values (from the problem)
    const Ptx = -10;               // dBm
    const pinSens = -49.4247251592;
    const apdSens = -65.4453250725;

    // Loss model: Prx = Ptx - (4.5 L + 9), L in km (continuous line for visualization)
    function prx(Lkm){ return Ptx - (4.5*Lkm + 9); }

    // Plot range
    const xMin = 0, xMax = 12;     // km
    const yMax = -10;              // dBm
    const yMin = -75;              // dBm

    function resize(){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(320, Math.floor(rect.width));
      const h = Math.max(260, Math.floor(rect.height));
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      draw(w,h);
    }

    function draw(w,h){
      ctx.clearRect(0,0,w,h);

      // Layout
      const padL = 62, padR = 16, padT = 36, padB = 48;
      const plotW = w - padL - padR;
      const plotH = h - padT - padB;

      // Helpers
      const xToPx = (x)=> padL + (x - xMin) * plotW / (xMax - xMin);
      const yToPx = (y)=> padT + (yMax - y) * plotH / (yMax - yMin);

      // Background
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.03)";
      ctx.fillRect(padL, padT, plotW, plotH);
      ctx.restore();

      // Grid + ticks
      ctx.save();
      ctx.lineWidth = 1;

      // X ticks every 1 km
      for(let x=0; x<=12; x+=1){
        const X = xToPx(x);
        ctx.strokeStyle = (x%2===0) ? "rgba(255,255,255,0.10)" : "rgba(255,255,255,0.06)";
        ctx.beginPath();
        ctx.moveTo(X, padT);
        ctx.lineTo(X, padT+plotH);
        ctx.stroke();
      }

      // Y ticks every 5 dB
      for(let y=-75; y<=-10; y+=5){
        const Y = yToPx(y);
        ctx.strokeStyle = (y%10===0) ? "rgba(255,255,255,0.10)" : "rgba(255,255,255,0.06)";
        ctx.beginPath();
        ctx.moveTo(padL, Y);
        ctx.lineTo(padL+plotW, Y);
        ctx.stroke();
      }
      ctx.restore();

      // Axes
      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,0.25)";
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(padL, padT);
      ctx.lineTo(padL, padT+plotH);
      ctx.lineTo(padL+plotW, padT+plotH);
      ctx.stroke();
      ctx.restore();

      // Title
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.92)";
      ctx.font = "700 14px " + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = "left";
      ctx.textBaseline = "top";
      ctx.fillText("Received Power vs Link Length (Given Loss Model)", padL, 10);
      ctx.restore();

      // Axis labels
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.78)";
      ctx.font = "600 12px " + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = "center";
      ctx.textBaseline = "bottom";
      ctx.fillText("Link length L (km)", padL + plotW/2, h - 10);

      ctx.translate(16, padT + plotH/2);
      ctx.rotate(-Math.PI/2);
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      ctx.fillText("Received power P_rx (dBm)", 0, 0);
      ctx.restore();

      // Tick labels
      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,0.75)";
      ctx.font = "12px " + getComputedStyle(document.documentElement).getPropertyValue('--mono');

      // X labels
      ctx.textAlign = "center";
      ctx.textBaseline = "top";
      for(let x=0; x<=12; x+=2){
        ctx.fillText(String(x), xToPx(x), padT+plotH+8);
      }

      // Y labels
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      for(let y=-75; y<=-10; y+=10){
        ctx.fillText(String(y), padL-8, yToPx(y));
      }
      ctx.restore();

      // Main curve
      ctx.save();
      ctx.strokeStyle = "rgba(125,211,252,0.95)";
      ctx.lineWidth = 2.2;
      ctx.beginPath();
      for(let i=0;i<=240;i++){
        const x = xMin + (xMax-xMin)*i/240;
        const y = prx(x);
        const X = xToPx(x), Y = yToPx(y);
        if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
      }
      ctx.stroke();
      ctx.restore();

      // Sensitivity lines
      function drawHline(y, color, label){
        const Y = yToPx(y);
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = 1.8;
        ctx.setLineDash([6,6]);
        ctx.beginPath();
        ctx.moveTo(padL, Y);
        ctx.lineTo(padL+plotW, Y);
        ctx.stroke();
        ctx.setLineDash([]);

        // Label
        ctx.fillStyle = color;
        ctx.font = "600 12px " + getComputedStyle(document.documentElement).getPropertyValue('--sans');
        ctx.textAlign = "left";
        ctx.textBaseline = "bottom";
        ctx.fillText(label, padL+8, Y-6);
        ctx.restore();
      }
      drawHline(pinSens, "rgba(167,243,208,0.92)", "PIN sensitivity ≈ −49.42 dBm");
      drawHline(apdSens, "rgba(251,191,36,0.92)", "APD sensitivity ≈ −65.45 dBm");

      // Mark integer-km maxima (6 km and 10 km)
      function markPoint(Lkm, color, text){
        const X = xToPx(Lkm);
        const Y = yToPx(prx(Lkm));
        ctx.save();
        ctx.fillStyle = "rgba(255,255,255,0.90)";
        ctx.beginPath();
        ctx.arc(X,Y,4.8,0,Math.PI*2);
        ctx.fill();

        ctx.strokeStyle = color;
        ctx.lineWidth = 2.2;
        ctx.beginPath();
        ctx.arc(X,Y,6.6,0,Math.PI*2);
        ctx.stroke();

        ctx.fillStyle = "rgba(255,255,255,0.82)";
        ctx.font = "600 12px " + getComputedStyle(document.documentElement).getPropertyValue('--sans');
        ctx.textAlign = "left";
        ctx.textBaseline = "top";
        ctx.fillText(text, X+10, Y+8);
        ctx.restore();
      }
      markPoint(6, "rgba(167,243,208,0.95)", "Max PIN length: 6 km");
      markPoint(10, "rgba(251,191,36,0.95)", "Max APD length: 10 km");

      // Legend
      const lx = padL + 10, ly = padT + 10;
      const lw = 270, lh = 74;
      ctx.save();
      ctx.fillStyle = "rgba(0,0,0,0.30)";
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.lineWidth = 1;
      roundRect(ctx, lx, ly, lw, lh, 12);
      ctx.fill();
      ctx.stroke();

      ctx.font = "600 12px " + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.fillStyle = "rgba(255,255,255,0.85)";
      ctx.textAlign = "left";
      ctx.textBaseline = "middle";

      // Curve sample
      ctx.strokeStyle = "rgba(125,211,252,0.95)";
      ctx.lineWidth = 2.2;
      ctx.beginPath(); ctx.moveTo(lx+12, ly+20); ctx.lineTo(lx+44, ly+20); ctx.stroke();
      ctx.fillText("P_rx(L) = −10 − (4.5L + 9)", lx+54, ly+20);

      // PIN line sample
      ctx.strokeStyle = "rgba(167,243,208,0.92)";
      ctx.setLineDash([6,6]);
      ctx.beginPath(); ctx.moveTo(lx+12, ly+42); ctx.lineTo(lx+44, ly+42); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillText("PIN threshold", lx+54, ly+42);

      // APD line sample
      ctx.strokeStyle = "rgba(251,191,36,0.92)";
      ctx.setLineDash([6,6]);
      ctx.beginPath(); ctx.moveTo(lx+12, ly+62); ctx.lineTo(lx+44, ly+62); ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillText("APD threshold", lx+54, ly+62);

      ctx.restore();
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    const ro = new ResizeObserver(()=>resize());
    ro.observe(canvas);
    window.addEventListener('resize', resize, {passive:true});
    resize();
  })();
</script>
</body>
</html>
