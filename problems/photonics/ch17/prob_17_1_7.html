<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fermi Level of an Intrinsic and Doped Semiconductor (Bandgap, Effective Mass, and Doping Dependence)</title>
  <style>
    :root{
      --bg:#0b0f19;
      --panel:#0f1626;
      --panel2:#101b33;
      --text:#e8eefc;
      --muted:#a9b7d6;
      --line:rgba(255,255,255,.12);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 700px at 70% -10%, rgba(125,211,252,.18), transparent 60%),
                  radial-gradient(900px 600px at 10% 10%, rgba(167,139,250,.16), transparent 55%),
                  linear-gradient(180deg, #070a12, #0b0f19 35%, #090c14);
      line-height:1.55;
    }
    header{
      padding: 44px 18px 18px;
      max-width: 1180px;
      margin: 0 auto;
    }
    .title{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 18px;
      align-items:start;
    }
    h1{
      margin:0 0 10px 0;
      font-size: clamp(1.45rem, 2.6vw, 2.2rem);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      font-size:1.02rem;
      margin:0;
      max-width: 70ch;
    }
    .badgeRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      justify-content:flex-end;
      margin-top:8px;
    }
    .badge{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius: 999px;
      font-size:.86rem;
      color: var(--muted);
      backdrop-filter: blur(6px);
      box-shadow: 0 6px 18px rgba(0,0,0,.18);
      white-space:nowrap;
    }
    main{
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 18px 52px;
      display:grid;
      grid-template-columns: 310px 1fr;
      gap: 18px;
      align-items:start;
    }
    nav{
      position: sticky;
      top: 14px;
      align-self:start;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px 14px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    nav h2{
      font-size: 0.98rem;
      margin: 0 0 8px 0;
      color: var(--text);
      letter-spacing: .3px;
    }
    .toc a{
      display:block;
      padding: 8px 10px;
      border-radius: 12px;
      text-decoration:none;
      color: var(--muted);
      border: 1px solid transparent;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size: .94rem;
    }
    .toc a:hover{
      background: rgba(125,211,252,.08);
      border-color: rgba(125,211,252,.25);
      color: var(--text);
      transform: translateY(-1px);
    }
    .content{
      display:flex;
      flex-direction:column;
      gap: 16px;
      min-width:0;
    }
    section, article{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px 18px 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    section h2, article h2{
      margin: 0 0 10px 0;
      font-size: 1.25rem;
      letter-spacing:.2px;
    }
    section h3, article h3{
      margin: 14px 0 8px 0;
      font-size: 1.07rem;
      color: var(--text);
    }
    p{margin: 8px 0}
    ul{margin: 8px 0 8px 20px}
    li{margin: 6px 0}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1.15fr .85fr .85fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
      nav{position:relative; top:auto}
      .title{grid-template-columns:1fr}
      .badgeRow{justify-content:flex-start}
      .grid2,.grid3{grid-template-columns:1fr}
    }
    .callout{
      border:1px solid var(--line);
      background: rgba(16,27,51,.55);
      border-radius: 16px;
      padding: 12px 12px 10px;
      margin: 10px 0;
    }
    .callout strong{
      display:inline-block;
      margin-bottom:6px;
      letter-spacing:.2px;
    }
    .callout.assump{border-color: rgba(251,191,36,.28)}
    .callout.keyeq{border-color: rgba(125,211,252,.28)}
    .callout.mist{border-color: rgba(251,113,133,.28)}
    .callout.final{border-color: rgba(52,211,153,.28)}
    .eq{
      font-family: var(--mono);
      font-size: .95rem;
      color: #dbeafe;
      background: rgba(0,0,0,.25);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px 10px 10px;
      overflow:auto;
      position:relative;
      margin: 10px 0;
    }
    .eq .copyBtn{
      position:absolute;
      top:8px;
      right:8px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 6px 8px;
      cursor:pointer;
      font-size:.82rem;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .eq .copyBtn:hover{
      transform: translateY(-1px);
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.28);
    }
    .mini{
      color: var(--muted);
      font-size: .92rem;
    }
    .vizWrap{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap: 12px;
      align-items: stretch;
      margin-top: 8px;
    }
    @media (max-width: 980px){
      .vizWrap{grid-template-columns: 1fr}
    }
    figure{
      margin:0;
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 10px;
      background: rgba(0,0,0,.20);
      overflow:hidden;
    }
    figcaption{
      margin-top: 8px;
      color: var(--muted);
      font-size: .92rem;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius: 12px;
      background: rgba(10,14,25,.55);
      border:1px solid rgba(255,255,255,.10);
    }
    .controls{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: rgba(0,0,0,.18);
    }
    .controls h3{margin:0 0 6px 0}
    .ctrlRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 520px){
      .ctrlRow{grid-template-columns: 1fr}
    }
    label{
      display:block;
      font-size:.92rem;
      color: var(--muted);
      margin-bottom:6px;
    }
    input[type="range"]{width:100%}
    select, input[type="number"]{
      width:100%;
      padding: 9px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
    }
    .readout{
      font-family: var(--mono);
      background: rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 12px;
      padding: 9px 10px;
      color:#e2e8f0;
      font-size:.92rem;
    }
    footer{
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 18px 36px;
      color: var(--muted);
      font-size: .92rem;
    }
    .hr{
      height:1px;
      background: var(--line);
      margin: 12px 0;
    }
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 980px){
      .kpi{grid-template-columns:1fr}
    }
    .kpi .box{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding: 10px 12px;
    }
    .kpi .box .name{color:var(--muted); font-size:.88rem}
    .kpi .box .val{font-family:var(--mono); font-size:1rem; margin-top:4px}
    .printHint{display:none}
    @media print{
      body{background:#fff; color:#000}
      nav{display:none}
      section, article, figure{box-shadow:none; background:#fff}
      canvas{border:1px solid #aaa}
      .eq{background:#f6f6f6; color:#000}
      .eq .copyBtn{display:none}
      .printHint{display:block; color:#444}
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <div>
      <h1>Fermi Level of an Intrinsic Semiconductor (and How Doping Shifts It)</h1>
      <p class="subtitle">
        Using the nondegenerate (exponential) approximation for carrier densities, we derive the intrinsic Fermi level
        and then generalize to a doped semiconductor via charge neutrality and the mass-action law.
      </p>
      <p class="mini printHint">Print note: copy buttons and sticky navigation are hidden in print mode.</p>
    </div>
    <div class="badgeRow">
      <div class="badge">Regime: nondegenerate (Boltzmann) carriers</div>
      <div class="badge">Key tools: Nc, Nv, mass-action, charge neutrality</div>
      <div class="badge">Outputs: Ei (intrinsic), Ef(Nd,Na)</div>
    </div>
  </div>
</header>

<main>
  <nav aria-label="Table of contents">
    <h2>Table of Contents</h2>
    <div class="toc">
      <a href="#quick">Quick Summary</a>
      <a href="#part0">PART 0 — Concept Primer</a>
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a href="#part2">PART 2 — Strategy & Tips</a>
      <a href="#part3">PART 3 — Full Solution</a>
      <a href="#part4">PART 4 — Deeper Understanding</a>
      <a href="#part5">PART 5 — Visualization Guide</a>
      <a href="#viz">Interactive Visualizations</a>
    </div>
    <div class="hr"></div>
    <div class="mini">
      Tip: use the controls to see how <span style="color:var(--accent)">temperature</span>,
      <span style="color:var(--accent2)">effective-mass ratio</span>, and <span style="color:var(--good)">doping</span>
      move the Fermi level and carrier densities.
    </div>
  </nav>

  <div class="content">
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>What this is about:</b> locating the Fermi level <span class="mini">(chemical potential)</span> in an intrinsic semiconductor, then how it shifts with doping.</li>
        <li><b>Key physics idea:</b> in thermal equilibrium, carrier concentrations depend exponentially on energy separations from <b>Ef</b> (Boltzmann approximation).</li>
        <li><b>Governing equations:</b> <span style="font-family:var(--mono)">n = Nc exp(-(Ec−Ef)/kT)</span>, <span style="font-family:var(--mono)">p = Nv exp(-(Ef−Ev)/kT)</span>, and <span style="font-family:var(--mono)">np = Nc Nv exp(−Eg/kT) = ni²</span>.</li>
        <li><b>Intrinsic result (symbolic):</b> <span style="font-family:var(--mono)">Ei = (Ec+Ev)/2 + (kT/2) ln(Nv/Nc)</span> (midgap only if <span style="font-family:var(--mono)">Nc=Nv</span>).</li>
        <li><b>Mass dependence:</b> since <span style="font-family:var(--mono)">Nc ∝ (m*e)^(3/2)</span> and <span style="font-family:var(--mono)">Nv ∝ (m*h)^(3/2)</span>, the intrinsic level shifts by <span style="font-family:var(--mono)">(3/4)kT ln(m*h/m*e)</span>.</li>
        <li><b>Doped result (symbolic):</b> with complete ionization, charge neutrality gives <span style="font-family:var(--mono)">n − p = ND − NA</span> plus <span style="font-family:var(--mono)">np=ni²</span> → a quadratic for <span style="font-family:var(--mono)">n</span> and then <span style="font-family:var(--mono)">Ef = Ec − kT ln(Nc/n)</span>.</li>
        <li><b>Final answer type:</b> fully symbolic formulas; plots use <b>example</b> constants (Si-like) for visualization.</li>
      </ul>
    </section>

    <article id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <h3>Core definitions (symbols + units)</h3>
      <ul>
        <li><b>Ef</b> — Fermi level (equilibrium chemical potential), energy in <b>eV</b> or <b>J</b>.</li>
        <li><b>Ec, Ev</b> — conduction- and valence-band edges, energy in <b>eV</b>.</li>
        <li><b>Eg = Ec − Ev</b> — bandgap energy (eV).</li>
        <li><b>n, p</b> — electron and hole concentrations, typically <b>cm⁻³</b>.</li>
        <li><b>Nc, Nv</b> — effective density of states (conduction/valence), <b>cm⁻³</b>.</li>
        <li><b>k</b> — Boltzmann constant; in semiconductor energy units: <span style="font-family:var(--mono)">k = 8.617×10⁻⁵ eV/K</span>.</li>
        <li><b>T</b> — absolute temperature (K).</li>
        <li><b>m*e, m*h</b> — effective masses for electrons/holes (relative to free-electron mass if desired).</li>
      </ul>

      <h3>Physical meaning (what these represent)</h3>
      <p>
        In equilibrium, <b>Ef</b> sets the relative probability that states are occupied. If <b>Ef</b> lies closer to
        <b>Ec</b>, it is “easier” (thermally) to populate conduction-band states → <b>n</b> increases. If <b>Ef</b> is closer to
        <b>Ev</b>, holes become more numerous → <b>p</b> increases.
      </p>

      <div class="callout keyeq">
        <strong>Key approximation (nondegenerate / Boltzmann regime)</strong>
        <p class="mini">
          When the Fermi level is inside the bandgap and at least a few <span style="font-family:var(--mono)">kT</span> away from a band edge,
          the Fermi–Dirac function simplifies so carrier densities become exponential in energy separation.
        </p>
      </div>

      <h3>Key laws/principles + validity</h3>
      <ul>
        <li><b>Carrier densities in equilibrium (Boltzmann forms):</b> valid when carriers are <b>nondegenerate</b> (not too heavily doped, not too low T).</li>
        <li><b>Mass-action law:</b> <span style="font-family:var(--mono)">np = ni²</span> holds in equilibrium under the same assumptions, regardless of doping (as long as nondegenerate).</li>
        <li><b>Charge neutrality:</b> total positive charge ≈ total negative charge; connects doping to <span style="font-family:var(--mono)">n</span> and <span style="font-family:var(--mono)">p</span>.</li>
      </ul>

      <h3>Common models/approximations (and why we use them)</h3>
      <ul>
        <li><b>Parabolic bands + effective mass:</b> lets us express <span style="font-family:var(--mono)">Nc, Nv</span> compactly.</li>
        <li><b>Complete ionization:</b> at moderate T, donors/acceptors are assumed fully ionized so <span style="font-family:var(--mono)">ND⁺≈ND</span>, <span style="font-family:var(--mono)">NA⁻≈NA</span>.</li>
        <li><b>Neglect bandgap narrowing and degeneracy:</b> good for teaching and for moderate doping; breaks down for very high doping.</li>
      </ul>

      <h3>Mini intuition examples</h3>
      <ul>
        <li>If <b>Ef</b> moves up by <span style="font-family:var(--mono)">+kT ln 10</span> (≈ 0.059 eV at 300 K), then <span style="font-family:var(--mono)">n</span> increases by a factor of 10 (since it’s exponential).</li>
        <li>If hole effective mass is larger so <span style="font-family:var(--mono)">Nv</span> is larger, the intrinsic level shifts slightly toward the conduction band to keep <span style="font-family:var(--mono)">n=p</span>.</li>
      </ul>

      <div class="callout mist">
        <strong>What to watch for (pitfalls)</strong>
        <ul class="mini">
          <li>Mixing energy units: use eV consistently with <span style="font-family:var(--mono)">k=8.617×10⁻⁵ eV/K</span>.</li>
          <li>For intrinsic material, <span style="font-family:var(--mono)">Ef</span> is not always exactly midgap—only if <span style="font-family:var(--mono)">Nc=Nv</span> (often not true).</li>
          <li>For doped cases, remember: you need <b>both</b> charge neutrality and mass-action to solve for <span style="font-family:var(--mono)">n,p</span>.</li>
          <li>Very heavy doping can violate the nondegenerate approximation (Ef can enter a band).</li>
        </ul>
      </div>
    </article>

    <article id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Problem restatement (in plain words)</h3>
      <p>
        You are given the equilibrium carrier-density formulas (Boltzmann approximation):
      </p>
      <div class="eq" data-copy="n = Nc * exp(-(Ec - Ef)/(kT))
p = Nv * exp(-(Ef - Ev)/(kT))">
        <button class="copyBtn" type="button">Copy</button>
        n = Nc · exp( −(Ec − Ef)/(kT) )<br/>
        p = Nv · exp( −(Ef − Ev)/(kT) )
      </div>
      <p>
        (a) Find an expression for the intrinsic Fermi level <b>Ei</b> and show it is exactly midgap only when the electron and hole effective masses are equal.
        (b) For a doped semiconductor, express the Fermi level as a function of doping and the intrinsic level from (a).
      </p>

      <h3>Given quantities</h3>
      <ul>
        <li>Carrier density formulas: <span style="font-family:var(--mono)">n(Nc,Ec,Ef,T)</span> and <span style="font-family:var(--mono)">p(Nv,Ev,Ef,T)</span>.</li>
        <li>Density-of-states parameters: <span style="font-family:var(--mono)">Nc</span>, <span style="font-family:var(--mono)">Nv</span> (and their mass dependence).</li>
        <li>Bandgap relation: <span style="font-family:var(--mono)">Eg = Ec − Ev</span>.</li>
      </ul>

      <h3>Unknowns</h3>
      <ul>
        <li>Intrinsic Fermi level <span style="font-family:var(--mono)">Ei</span> (or <span style="font-family:var(--mono)">Ef</span> for intrinsic).</li>
        <li>Doped Fermi level <span style="font-family:var(--mono)">Ef(ND,NA)</span> (or equivalently relative shift from <span style="font-family:var(--mono)">Ei</span>).</li>
      </ul>

      <h3>What must be found / proved</h3>
      <ul>
        <li>Expression for <span style="font-family:var(--mono)">Ei</span> and show “midgap” condition when <span style="font-family:var(--mono)">m*e = m*h</span> (so <span style="font-family:var(--mono)">Nc=Nv</span>).</li>
        <li>Expression for doped <span style="font-family:var(--mono)">Ef</span> as function of doping and <span style="font-family:var(--mono)">Ei</span>.</li>
      </ul>

      <h3>Relevant physical principles (and why they apply)</h3>
      <ul>
        <li><b>Thermal equilibrium:</b> allows use of equilibrium distributions and defines a single Fermi level <span style="font-family:var(--mono)">Ef</span>.</li>
        <li><b>Nondegenerate carrier statistics:</b> justifies exponential forms for <span style="font-family:var(--mono)">n</span> and <span style="font-family:var(--mono)">p</span>.</li>
        <li><b>Charge neutrality in doped material:</b> links <span style="font-family:var(--mono)">n,p</span> to dopant densities <span style="font-family:var(--mono)">ND,NA</span>.</li>
      </ul>

      <div class="callout assump">
        <strong>Assumptions used in this standard derivation</strong>
        <ul class="mini">
          <li>Thermal equilibrium (single <span style="font-family:var(--mono)">Ef</span>).</li>
          <li>Nondegenerate (Boltzmann) statistics: <span style="font-family:var(--mono)">Ef</span> lies in the gap and not too close to band edges.</li>
          <li>Parabolic bands with effective masses, so <span style="font-family:var(--mono)">Nc ∝ (m*e T)^(3/2)</span> and <span style="font-family:var(--mono)">Nv ∝ (m*h T)^(3/2)</span>.</li>
          <li>For doped case (part b): complete ionization so <span style="font-family:var(--mono)">ND⁺≈ND</span>, <span style="font-family:var(--mono)">NA⁻≈NA</span>.</li>
        </ul>
      </div>

      <h3>Possible approaches (and which we choose)</h3>
      <ul>
        <li><b>Approach 1 (direct algebra):</b> set <span style="font-family:var(--mono)">n=p</span> for intrinsic, solve for <span style="font-family:var(--mono)">Ef</span>. For doped, combine charge neutrality with <span style="font-family:var(--mono)">np=ni²</span>.</li>
        <li><b>Approach 2 (use intrinsic level Ei as reference):</b> first derive <span style="font-family:var(--mono)">Ei</span>, then express <span style="font-family:var(--mono)">Ef−Ei = kT ln(n/ni)</span>. This makes doping shifts clean.</li>
        <li><b>Approach 3 (graphical/energy diagram):</b> interpret shifts via band diagram; good for intuition but still needs equations.</li>
      </ul>
      <p><b>Best choice:</b> Approach 2, because it yields a compact “shift from intrinsic” formula and connects naturally to plots.</p>
    </article>

    <article id="part2">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

      <ol>
        <li>
          <b>Goal:</b> derive intrinsic level.
          <br><span class="mini"><b>Tool:</b> set <span style="font-family:var(--mono)">n=p</span> using Boltzmann forms.</span>
          <br><span class="mini"><b>Meaning:</b> intrinsic has equal electrons and holes.</span>
        </li>
        <li>
          <b>Goal:</b> isolate <span style="font-family:var(--mono)">Ei</span>.
          <br><span class="mini"><b>Tool:</b> take logs and solve linear equation in <span style="font-family:var(--mono)">Ei</span>.</span>
          <br><span class="mini"><b>Meaning:</b> position in gap balances densities of states.</span>
        </li>
        <li>
          <b>Goal:</b> show midgap condition.
          <br><span class="mini"><b>Tool:</b> use <span style="font-family:var(--mono)">Ei = (Ec+Ev)/2 + (kT/2)ln(Nv/Nc)</span>.</span>
          <br><span class="mini"><b>Meaning:</b> equal DOS → no shift from midgap.</span>
        </li>
        <li>
          <b>Goal:</b> connect DOS to effective masses.
          <br><span class="mini"><b>Tool:</b> <span style="font-family:var(--mono)">Nc ∝ (m*e)^(3/2)</span>, <span style="font-family:var(--mono)">Nv ∝ (m*h)^(3/2)</span>.</span>
          <br><span class="mini"><b>Meaning:</b> heavier mass → more available states.</span>
        </li>
        <li>
          <b>Goal:</b> solve doped case for <span style="font-family:var(--mono)">n,p</span>.
          <br><span class="mini"><b>Tool:</b> charge neutrality <span style="font-family:var(--mono)">n − p = ND − NA</span> plus mass-action <span style="font-family:var(--mono)">np=ni²</span>.</span>
          <br><span class="mini"><b>Meaning:</b> doping fixes net charge; equilibrium still enforces pairing via <span style="font-family:var(--mono)">ni</span>.</span>
        </li>
        <li>
          <b>Goal:</b> express <span style="font-family:var(--mono)">Ef</span> (or <span style="font-family:var(--mono)">Ef−Ei</span>).
          <br><span class="mini"><b>Tool:</b> <span style="font-family:var(--mono)">Ef = Ec − kT ln(Nc/n)</span> or <span style="font-family:var(--mono)">Ef−Ei = kT ln(n/ni)</span>.</span>
          <br><span class="mini"><b>Meaning:</b> Fermi level moves logarithmically with carrier concentration.</span>
        </li>
      </ol>

      <div class="callout mist">
        <strong>Common mistakes + quick tips</strong>
        <ul class="mini">
          <li>Don’t forget the <span style="font-family:var(--mono)">ln(Nv/Nc)</span> term: it is the whole reason <span style="font-family:var(--mono)">Ei</span> can deviate from midgap.</li>
          <li>When solving doped case: write it as a quadratic; don’t assume <span style="font-family:var(--mono)">n≈ND</span> unless you explicitly take the “strongly n-type” limit.</li>
          <li>Check limiting cases: as <span style="font-family:var(--mono)">ND−NA → 0</span>, you must recover <span style="font-family:var(--mono)">n=p=ni</span> and <span style="font-family:var(--mono)">Ef=Ei</span>.</li>
        </ul>
      </div>
    </article>

    <article id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Qualitative expectation (before math)</h3>
      <p>
        In an <b>intrinsic</b> semiconductor, thermal excitation creates electrons and holes in pairs, so we expect
        <span style="font-family:var(--mono)">n=p</span>. The Fermi level should lie somewhere in the gap, near midgap.
        However, if the conduction and valence bands have different “capacity” (different densities of states),
        <span style="font-family:var(--mono)">Ef</span> shifts to equalize <span style="font-family:var(--mono)">n</span> and <span style="font-family:var(--mono)">p</span>.
      </p>
      <p>
        In a <b>doped</b> semiconductor, extra donors (n-type) push <span style="font-family:var(--mono)">Ef</span> upward (toward <span style="font-family:var(--mono)">Ec</span>) to increase <span style="font-family:var(--mono)">n</span>;
        acceptors (p-type) push it downward (toward <span style="font-family:var(--mono)">Ev</span>) to increase <span style="font-family:var(--mono)">p</span>.
      </p>

      <div class="hr"></div>

      <h3>(a) Intrinsic Fermi level Ei</h3>
      <p><b>Step 1 — Write the given Boltzmann expressions</b> (define symbols):</p>
      <ul class="mini">
        <li><span style="font-family:var(--mono)">Ec</span>: conduction band edge; <span style="font-family:var(--mono)">Ev</span>: valence band edge.</li>
        <li><span style="font-family:var(--mono)">Nc, Nv</span>: effective density of states in the conduction/valence bands.</li>
        <li><span style="font-family:var(--mono)">kT</span>: thermal energy (in eV if using eV).</li>
      </ul>

      <div class="eq" data-copy="n = Nc * exp(-(Ec - Ef)/(kT))
p = Nv * exp(-(Ef - Ev)/(kT))">
        <button class="copyBtn" type="button">Copy</button>
        n = Nc · exp( −(Ec − Ef)/(kT) )<br/>
        p = Nv · exp( −(Ef − Ev)/(kT) )
      </div>

      <p><b>Step 2 — Intrinsic condition:</b> for an intrinsic semiconductor at equilibrium, electrons and holes are generated in pairs, so</p>
      <div class="eq" data-copy="Intrinsic: n = p = ni">
        <button class="copyBtn" type="button">Copy</button>
        Intrinsic: n = p = ni
      </div>

      <p><b>Step 3 — Set n = p and solve for Ef (call it Ei)</b></p>
      <p class="mini">Set the two exponentials equal and take logs carefully:</p>

      <div class="eq" data-copy="Nc * exp(-(Ec - Ei)/(kT)) = Nv * exp(-(Ei - Ev)/(kT))">
        <button class="copyBtn" type="button">Copy</button>
        Nc · exp( −(Ec − Ei)/(kT) ) = Nv · exp( −(Ei − Ev)/(kT) )
      </div>

      <p>Divide both sides by <span style="font-family:var(--mono)">Nc</span> and take the natural log:</p>
      <div class="eq" data-copy="ln(Nv/Nc) = - (Ec - Ei)/(kT) + (Ei - Ev)/(kT)">
        <button class="copyBtn" type="button">Copy</button>
        ln(Nv/Nc) = −(Ec − Ei)/(kT) + (Ei − Ev)/(kT)
      </div>

      <p>Combine terms in <span style="font-family:var(--mono)">Ei</span>:</p>
      <div class="eq" data-copy="ln(Nv/Nc) = (2Ei - Ec - Ev)/(kT)">
        <button class="copyBtn" type="button">Copy</button>
        ln(Nv/Nc) = (2Ei − Ec − Ev)/(kT)
      </div>

      <p>Solve for <span style="font-family:var(--mono)">Ei</span>:</p>
      <div class="eq" data-copy="Ei = (Ec + Ev)/2 + (kT/2) * ln(Nv/Nc)">
        <button class="copyBtn" type="button">Copy</button>
        Ei = (Ec + Ev)/2 + (kT/2) · ln(Nv/Nc)
      </div>

      <p class="mini">
        <b>What we did and why:</b> We enforced the intrinsic condition <span style="font-family:var(--mono)">n=p</span>.
        Any asymmetry between the conduction and valence densities of states (<span style="font-family:var(--mono)">Nc</span> vs <span style="font-family:var(--mono)">Nv</span>)
        forces a small shift of <span style="font-family:var(--mono)">Ei</span> away from the exact midgap energy.
      </p>

      <div class="callout final">
        <strong>Intrinsic Fermi level (general)</strong>
        <div class="eq" data-copy="Ei = (Ec + Ev)/2 + (kT/2) ln(Nv/Nc)">
          <button class="copyBtn" type="button">Copy</button>
          Ei = (Ec + Ev)/2 + (kT/2) ln(Nv/Nc)
        </div>
      </div>

      <p><b>Step 4 — Show when Ei is exactly midgap</b></p>
      <p>
        Midgap means <span style="font-family:var(--mono)">Ei = (Ec+Ev)/2</span>. From the formula above, that occurs iff
        <span style="font-family:var(--mono)">ln(Nv/Nc)=0</span>, i.e. iff <span style="font-family:var(--mono)">Nv = Nc</span>.
      </p>

      <p><b>Step 5 — Connect Nc and Nv to effective masses</b></p>
      <p class="mini">
        For parabolic bands, the effective density of states scales as
        <span style="font-family:var(--mono)">Nc ∝ (m*e T)^(3/2)</span> and <span style="font-family:var(--mono)">Nv ∝ (m*h T)^(3/2)</span>
        (the proportionality constant includes Planck’s constant and degeneracy factors).
      </p>

      <div class="eq" data-copy="Nc ∝ (m*e)^(3/2) T^(3/2)
Nv ∝ (m*h)^(3/2) T^(3/2)">
        <button class="copyBtn" type="button">Copy</button>
        Nc ∝ (m*e)^(3/2) · T^(3/2)<br/>
        Nv ∝ (m*h)^(3/2) · T^(3/2)
      </div>

      <p>Therefore,</p>
      <div class="eq" data-copy="ln(Nv/Nc) = (3/2) ln(m*h/m*e)">
        <button class="copyBtn" type="button">Copy</button>
        ln(Nv/Nc) = (3/2) ln(m*h / m*e)
      </div>

      <p>Insert into <span style="font-family:var(--mono)">Ei</span>:</p>
      <div class="eq" data-copy="Ei = (Ec + Ev)/2 + (3/4) kT ln(m*h/m*e)">
        <button class="copyBtn" type="button">Copy</button>
        Ei = (Ec + Ev)/2 + (3/4) kT · ln(m*h / m*e)
      </div>

      <p>
        So <span style="font-family:var(--mono)">Ei</span> is exactly midgap when <span style="font-family:var(--mono)">m*h = m*e</span>,
        because then <span style="font-family:var(--mono)">Nv = Nc</span>.
      </p>

      <div class="hr"></div>

      <h3>(b) Fermi level in a doped semiconductor as a function of doping</h3>

      <p><b>Step 1 — Use mass-action law to define ni</b></p>
      <p class="mini">
        Multiply the given expressions for <span style="font-family:var(--mono)">n</span> and <span style="font-family:var(--mono)">p</span>:
      </p>
      <div class="eq" data-copy="np = Nc Nv exp(-(Ec - Ev)/(kT)) = Nc Nv exp(-Eg/(kT))">
        <button class="copyBtn" type="button">Copy</button>
        np = Nc Nv · exp( −(Ec − Ev)/(kT) ) = Nc Nv · exp( −Eg/(kT) )
      </div>

      <p class="mini">Define the intrinsic concentration:</p>
      <div class="eq" data-copy="ni^2 = Nc Nv exp(-Eg/(kT))">
        <button class="copyBtn" type="button">Copy</button>
        ni² = Nc Nv · exp( −Eg/(kT) )
      </div>

      <p><b>Step 2 — Charge neutrality (complete ionization)</b></p>
      <p class="mini">
        Let <span style="font-family:var(--mono)">ND</span> be donor concentration and <span style="font-family:var(--mono)">NA</span> acceptor concentration (cm⁻³).
        Under complete ionization, the net ionized dopant charge is approximately <span style="font-family:var(--mono)">ND − NA</span>.
        Charge neutrality gives:
      </p>
      <div class="eq" data-copy="n - p = ND - NA (complete ionization)">
        <button class="copyBtn" type="button">Copy</button>
        n − p = ND − NA  (complete ionization)
      </div>

      <p><b>Step 3 — Solve for n and p using two equations</b></p>
      <p class="mini">
        Combine <span style="font-family:var(--mono)">p = ni² / n</span> with <span style="font-family:var(--mono)">n − p = ND − NA</span>:
      </p>
      <div class="eq" data-copy="n - (ni^2/n) = ND - NA  ⇒  n^2 - (ND-NA) n - ni^2 = 0">
        <button class="copyBtn" type="button">Copy</button>
        n − (ni²/n) = ND − NA  ⇒  n² − (ND−NA) n − ni² = 0
      </div>

      <p>Quadratic formula gives the physically meaningful (positive) solution:</p>
      <div class="eq" data-copy="n = ( (ND-NA)/2 ) + sqrt( ((ND-NA)/2)^2 + ni^2 )
p = ni^2 / n">
        <button class="copyBtn" type="button">Copy</button>
        n = (ND−NA)/2 + sqrt( ((ND−NA)/2)² + ni² )<br/>
        p = ni² / n
      </div>

      <p class="mini">
        <b>What we did and why:</b> charge neutrality sets the <i>difference</i> <span style="font-family:var(--mono)">n−p</span>,
        while equilibrium statistics sets the <i>product</i> <span style="font-family:var(--mono)">np</span>. Difference + product uniquely determines both.
      </p>

      <p><b>Step 4 — Convert carrier concentration to Fermi level</b></p>
      <p class="mini">
        From the given electron relation:
      </p>
      <div class="eq" data-copy="n = Nc exp(-(Ec - Ef)/(kT))  ⇒  Ef = Ec - kT ln(Nc/n)">
        <button class="copyBtn" type="button">Copy</button>
        n = Nc · exp( −(Ec − Ef)/(kT) )  ⇒  Ef = Ec − kT ln(Nc/n)
      </div>

      <p><b>Step 5 — Express Ef relative to the intrinsic level Ei (cleanest “doping shift” form)</b></p>
      <p class="mini">
        Use the intrinsic identity <span style="font-family:var(--mono)">ni = Nc exp(−(Ec−Ei)/kT)</span> (same formula with <span style="font-family:var(--mono)">Ef=Ei</span> and <span style="font-family:var(--mono)">n=ni</span>).
        Then:
      </p>
      <div class="eq" data-copy="Ef - Ei = kT ln(n/ni) = -kT ln(p/ni)">
        <button class="copyBtn" type="button">Copy</button>
        Ef − Ei = kT ln(n/ni) = −kT ln(p/ni)
      </div>

      <div class="callout final">
        <strong>Final boxed results (intrinsic + doped)</strong>

        <div class="eq" data-copy="(a) Ei = (Ec + Ev)/2 + (kT/2) ln(Nv/Nc) = (Ec + Ev)/2 + (3/4)kT ln(m*h/m*e)

(b) With complete ionization:
n = (ND−NA)/2 + sqrt(((ND−NA)/2)^2 + ni^2)
p = ni^2/n
Ef = Ei + kT ln(n/ni)  (equivalently Ef = Ec − kT ln(Nc/n))">
          <button class="copyBtn" type="button">Copy</button>
          (a) Ei = (Ec + Ev)/2 + (kT/2) ln(Nv/Nc) = (Ec + Ev)/2 + (3/4)kT ln(m*h/m*e)<br/><br/>
          (b) With complete ionization:<br/>
          n = (ND−NA)/2 + sqrt(((ND−NA)/2)^2 + ni^2)<br/>
          p = ni^2/n<br/>
          Ef = Ei + kT ln(n/ni)  (equivalently Ef = Ec − kT ln(Nc/n))
        </div>
      </div>

      <h3>Sanity checks</h3>
      <ul>
        <li><b>Units:</b> arguments of exponentials and logarithms are dimensionless: energies divided by <span style="font-family:var(--mono)">kT</span> and ratios like <span style="font-family:var(--mono)">Nv/Nc</span>.</li>
        <li><b>Intrinsic limit:</b> if <span style="font-family:var(--mono)">ND=NA</span>, then <span style="font-family:var(--mono)">n=ni</span>, <span style="font-family:var(--mono)">p=ni</span>, and <span style="font-family:var(--mono)">Ef=Ei</span>.</li>
        <li><b>Strong n-type limit:</b> if <span style="font-family:var(--mono)">ND−NA ≫ ni</span>, then
          <span style="font-family:var(--mono)">n ≈ ND−NA</span> and <span style="font-family:var(--mono)">p ≈ ni²/(ND−NA)</span>.</li>
        <li><b>Midgap condition:</b> <span style="font-family:var(--mono)">m*h=m*e</span> ⇒ <span style="font-family:var(--mono)">Nv=Nc</span> ⇒ intrinsic level is exactly at <span style="font-family:var(--mono)">(Ec+Ev)/2</span>.</li>
      </ul>

      <p class="mini">
        Connection to the diagram/plots: the band diagram canvas shows <span style="font-family:var(--mono)">Ev</span>, <span style="font-family:var(--mono)">Ec</span>, <span style="font-family:var(--mono)">Ei</span>, and the doped <span style="font-family:var(--mono)">Ef</span>.
        The plots show how <span style="font-family:var(--mono)">Ef</span> shifts with net doping and how <span style="font-family:var(--mono)">n,p</span> respond.
      </p>
    </article>

    <article id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Reinterpreting the intrinsic formula</h3>
      <p>
        The intrinsic level
        <span style="font-family:var(--mono)">Ei = midgap + (kT/2) ln(Nv/Nc)</span>
        has two parts:
      </p>
      <ul>
        <li><b>Midgap baseline:</b> <span style="font-family:var(--mono)">(Ec+Ev)/2</span> depends only on the band edges.</li>
        <li><b>Entropy / state-count correction:</b> <span style="font-family:var(--mono)">(kT/2) ln(Nv/Nc)</span> accounts for unequal numbers of available states near each band edge.</li>
      </ul>
      <p class="mini">
        If <span style="font-family:var(--mono)">Nv &lt; Nc</span>, there are “more” conduction-band states, so to keep <span style="font-family:var(--mono)">n=p</span> the Fermi level must move <i>down</i> (making electrons slightly harder to excite).
        If <span style="font-family:var(--mono)">Nv &gt; Nc</span>, it shifts upward.
      </p>

      <h3>How parameters change the outcome (connect to the controls)</h3>
      <ul>
        <li><b>Temperature T:</b> increases <span style="font-family:var(--mono)">kT</span> and typically increases <span style="font-family:var(--mono)">ni</span> dramatically, so for the same doping the Fermi level shift from <span style="font-family:var(--mono)">Ei</span> is reduced.</li>
        <li><b>Mass ratio m*h/m*e:</b> changes <span style="font-family:var(--mono)">Nv/Nc</span>, shifting <span style="font-family:var(--mono)">Ei</span> away from midgap by <span style="font-family:var(--mono)">(3/4)kT ln(m*h/m*e)</span>.</li>
        <li><b>Doping (ND−NA):</b> changes the net charge. In the nondegenerate regime, <span style="font-family:var(--mono)">Ef−Ei = kT ln(n/ni)</span>, i.e. logarithmic in <span style="font-family:var(--mono)">n</span>.</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p class="mini">
        Instead of starting with <span style="font-family:var(--mono)">n</span> and <span style="font-family:var(--mono)">p</span>, you can derive <span style="font-family:var(--mono)">Ei</span>
        by equating electron and hole chemical potentials and using the effective densities of states from integrating the density of states times the Boltzmann factor.
        That route makes the statistical-mechanics origin of <span style="font-family:var(--mono)">Nc,Nv</span> explicit.
      </p>

      <h3>Concept check (self-test)</h3>
      <ul>
        <li><b>Q:</b> If <span style="font-family:var(--mono)">Nv &gt; Nc</span>, does <span style="font-family:var(--mono)">Ei</span> move up or down? <br><b>A:</b> Up (toward <span style="font-family:var(--mono)">Ec</span>), because <span style="font-family:var(--mono)">ln(Nv/Nc)&gt;0</span>.</li>
        <li><b>Q:</b> In strong n-type doping, what happens to <span style="font-family:var(--mono)">p</span>? <br><b>A:</b> <span style="font-family:var(--mono)">p ≈ ni²/n</span> becomes very small (minority carriers suppressed).</li>
        <li><b>Q:</b> Why does <span style="font-family:var(--mono)">Ef</span> depend logarithmically on <span style="font-family:var(--mono)">n</span>? <br><b>A:</b> Because <span style="font-family:var(--mono)">n</span> is exponential in <span style="font-family:var(--mono)">Ef</span> under Boltzmann statistics.</li>
      </ul>
    </article>

    <article id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>
      <ul>
        <li><b>Diagram canvas:</b> a band diagram with <span style="font-family:var(--mono)">Ev</span>, <span style="font-family:var(--mono)">Ec</span>, intrinsic level <span style="font-family:var(--mono)">Ei</span>, and doped <span style="font-family:var(--mono)">Ef</span>. Energies are in <b>eV</b>.</li>
        <li><b>Main plot:</b> <span style="font-family:var(--mono)">Ef</span> (and <span style="font-family:var(--mono)">Ei</span>) versus net doping <span style="font-family:var(--mono)">ND−NA</span> (cm⁻³). This shows how the chemical potential moves with doping.</li>
        <li><b>Secondary plot:</b> carrier concentrations <span style="font-family:var(--mono)">n</span> and <span style="font-family:var(--mono)">p</span> versus net doping, on a log scale, highlighting majority/minority behavior.</li>
        <li><b>Interactive controls:</b>
          <ul>
            <li><b>Temperature</b> changes <span style="font-family:var(--mono)">kT</span> and <span style="font-family:var(--mono)">ni</span> → shifts curves.</li>
            <li><b>Mass ratio</b> changes <span style="font-family:var(--mono)">Nv/Nc</span> → moves <span style="font-family:var(--mono)">Ei</span> away from midgap.</li>
            <li><b>Doping type/level</b> sets <span style="font-family:var(--mono)">ND−NA</span> → moves <span style="font-family:var(--mono)">Ef</span> up/down and changes <span style="font-family:var(--mono)">n,p</span>.</li>
          </ul>
        </li>
      </ul>
      <p class="mini">
        All plotted values use <b>example constants</b> (Si-like <span style="font-family:var(--mono)">Eg≈1.12 eV</span>, and typical <span style="font-family:var(--mono)">Nc,Nv</span> at 300 K) to make the relationships visible.
        The symbolic derivations above are general.
      </p>
    </article>

    <section id="viz">
      <h2>Interactive Visualizations</h2>

      <div class="vizWrap">
        <figure>
          <canvas id="bandCanvas" aria-label="Band diagram"></canvas>
          <figcaption>
            Band diagram (example values): shows <span style="font-family:var(--mono)">Ev</span>, <span style="font-family:var(--mono)">Ec</span>,
            intrinsic <span style="font-family:var(--mono)">Ei</span>, and doped <span style="font-family:var(--mono)">Ef</span>.
          </figcaption>
        </figure>

        <div class="controls">
          <h3>Controls</h3>
          <div class="ctrlRow">
            <div>
              <label for="temp">Temperature T (K)</label>
              <input id="temp" type="range" min="200" max="600" value="300" step="1"/>
              <div class="readout" id="tempOut">T = 300 K</div>
            </div>
            <div>
              <label for="massRatio">Mass ratio m*h/m*e</label>
              <input id="massRatio" type="range" min="0.2" max="5.0" value="1.0" step="0.01"/>
              <div class="readout" id="massOut">m*h/m*e = 1.00</div>
            </div>
          </div>

          <div class="ctrlRow">
            <div>
              <label for="dopType">Doping type</label>
              <select id="dopType">
                <option value="n">n-type (donors): ND - NA &gt; 0</option>
                <option value="p">p-type (acceptors): ND - NA &lt; 0</option>
              </select>
            </div>
            <div>
              <label for="dopLevel">Doping level (cm⁻³, log10)</label>
              <input id="dopLevel" type="range" min="13" max="19" value="16" step="0.01"/>
              <div class="readout" id="dopOut">|ND−NA| = 1.00e16 cm⁻³</div>
            </div>
          </div>

          <div class="kpi" aria-label="Computed values readout">
            <div class="box">
              <div class="name">Intrinsic concentration</div>
              <div class="val" id="niOut">ni = … cm⁻³</div>
            </div>
            <div class="box">
              <div class="name">Carrier densities</div>
              <div class="val" id="npOut">n = …, p = …</div>
            </div>
            <div class="box">
              <div class="name">Fermi levels</div>
              <div class="val" id="efOut">Ei = … eV, Ef = … eV</div>
            </div>
          </div>

          <p class="mini" style="margin-top:10px">
            Note: If the computed <span style="font-family:var(--mono)">Ef</span> approaches or enters a band at very high doping,
            the nondegenerate approximation may no longer be accurate (plots still update to show the trend).
          </p>
        </div>
      </div>

      <div class="vizWrap" style="margin-top:12px">
        <figure>
          <canvas id="efCanvas" aria-label="Fermi level vs doping plot"></canvas>
          <figcaption>
            Main plot: <span style="font-family:var(--mono)">Ei</span> and <span style="font-family:var(--mono)">Ef</span> vs net doping <span style="font-family:var(--mono)">ND−NA</span>.
          </figcaption>
        </figure>
        <figure>
          <canvas id="npCanvas" aria-label="Carrier concentrations vs doping plot"></canvas>
          <figcaption>
            Secondary plot: <span style="font-family:var(--mono)">n</span> and <span style="font-family:var(--mono)">p</span> vs net doping (log scale).
          </figcaption>
        </figure>
      </div>
    </section>
  </div>
</main>

<footer>
  <div class="hr"></div>
  <p>
    Built as a self-contained teaching article: no external libraries, no MathJax. All equations are plain text and copyable.
    Visualizations use example constants to illustrate the derived symbolic relationships.
  </p>
</footer>

<script>
/* =========================
   Copy buttons for equations
   ========================= */
(function(){
  function copyText(text){
    navigator.clipboard.writeText(text).catch(()=>{});
  }
  document.querySelectorAll('.eq').forEach(eq=>{
    const btn = eq.querySelector('.copyBtn');
    if(!btn) return;
    btn.addEventListener('click', ()=>{
      const payload = eq.getAttribute('data-copy') || eq.innerText;
      copyText(payload.trim());
      const old = btn.textContent;
      btn.textContent = 'Copied';
      setTimeout(()=>btn.textContent = old, 700);
    });
  });
})();

/* =========================
   Semiconductor model (nondegenerate)
   Energies in eV, concentrations in cm^-3
   Example constants for plotting: Si-like at 300K
   ========================= */
const k_eV = 8.617333262e-5; // eV/K
const Eg_default = 1.12; // eV (example, Si at ~300K)

const Nc300 = 2.8e19;  // cm^-3 (example for Si)
const Nv300 = 1.04e19; // cm^-3 (example for Si)
const T0 = 300;

function Nc_of_T(T, massRatio /* mh/me affects Nv/Nc; keep Nc anchored to example */){
  // Scale with T^(3/2), keep Nc baseline Nc300.
  return Nc300 * Math.pow(T/T0, 1.5);
}
function Nv_of_T(T, massRatio){
  // Start from Nv300 scaling with T^(3/2), then adjust by mass ratio factor:
  // Nv/Nc ∝ (mh/me)^(3/2). We implement that by multiplying Nv by (massRatio)^(3/2)
  // but keep Nc unchanged; this lets Ei shift as theory predicts.
  const base = Nv300 * Math.pow(T/T0, 1.5);
  return base * Math.pow(massRatio, 1.5);
}
function ni_of(T, Eg, Nc, Nv){
  // ni^2 = Nc Nv exp(-Eg/(kT))
  const kT = k_eV * T;
  const ni2 = Nc * Nv * Math.exp(-Eg / kT);
  return Math.sqrt(Math.max(ni2, 0));
}
function intrinsic_Ei(Ev, Ec, T, Nc, Nv){
  // Ei = (Ec+Ev)/2 + (kT/2) ln(Nv/Nc)
  const kT = k_eV * T;
  return 0.5*(Ec+Ev) + 0.5*kT*Math.log(Nv/Nc);
}
function carriers_from_doping(T, Eg, Nc, Nv, NDminusNA){
  // Solve n - p = D and np = ni^2 => n^2 - D n - ni^2 = 0
  const ni = ni_of(T, Eg, Nc, Nv);
  const D = NDminusNA;
  const halfD = 0.5*D;
  const n = halfD + Math.sqrt(halfD*halfD + ni*ni);
  const p = (ni*ni) / Math.max(n, 1e-300);
  return {n, p, ni};
}
function Ef_from_n(Ec, T, Nc, n){
  // n = Nc exp(-(Ec - Ef)/kT) => Ef = Ec - kT ln(Nc/n)
  const kT = k_eV * T;
  return Ec - kT*Math.log(Nc/Math.max(n, 1e-300));
}
function Ef_shift_from_Ei(T, n, ni){
  // Ef - Ei = kT ln(n/ni)
  const kT = k_eV * T;
  return kT*Math.log(Math.max(n,1e-300)/Math.max(ni,1e-300));
}

/* =========================
   Canvas helpers
   ========================= */
function setupCanvas(canvas){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(200, Math.floor(rect.width));
  const h = Math.max(180, Math.floor(rect.height));
  canvas.width = Math.floor(w * dpr);
  canvas.height = Math.floor(h * dpr);
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0);
  return {ctx, w, h, dpr};
}

function clear(ctx, w, h){
  ctx.clearRect(0,0,w,h);
  // subtle background
  const g = ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0, "rgba(255,255,255,0.05)");
  g.addColorStop(1, "rgba(255,255,255,0.02)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);
}

function drawText(ctx, x, y, text, color="rgba(232,238,252,0.92)", size=12, align="left"){
  ctx.fillStyle = color;
  ctx.font = `${size}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial`;
  ctx.textAlign = align;
  ctx.textBaseline = "alphabetic";
  ctx.fillText(text, x, y);
}

function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title, opts={}){
  const {x=0,y=0,w=300,h=200} = box;
  const padL = opts.padL ?? 52;
  const padR = opts.padR ?? 16;
  const padT = opts.padT ?? 28;
  const padB = opts.padB ?? 44;

  const gx0 = x + padL, gx1 = x + w - padR;
  const gy0 = y + padT, gy1 = y + h - padB;

  // Title
  drawText(ctx, x + 10, y + 20, title, "rgba(232,238,252,0.95)", 13, "left");

  // Plot area
  ctx.strokeStyle = "rgba(255,255,255,0.14)";
  ctx.lineWidth = 1;
  ctx.strokeRect(gx0, gy0, gx1-gx0, gy1-gy0);

  // Grid + ticks
  const nx = opts.nx ?? 6;
  const ny = opts.ny ?? 6;

  ctx.strokeStyle = "rgba(255,255,255,0.08)";
  ctx.lineWidth = 1;

  for(let i=0;i<=nx;i++){
    const t = i/nx;
    const X = gx0 + t*(gx1-gx0);
    ctx.beginPath();
    ctx.moveTo(X, gy0);
    ctx.lineTo(X, gy1);
    ctx.stroke();
  }
  for(let j=0;j<=ny;j++){
    const t = j/ny;
    const Y = gy1 - t*(gy1-gy0);
    ctx.beginPath();
    ctx.moveTo(gx0, Y);
    ctx.lineTo(gx1, Y);
    ctx.stroke();
  }

  // Axis labels
  drawText(ctx, (gx0+gx1)/2, y + h - 14, xLabel, "rgba(169,183,214,0.95)", 12, "center");
  ctx.save();
  ctx.translate(x + 16, (gy0+gy1)/2);
  ctx.rotate(-Math.PI/2);
  drawText(ctx, 0, 0, yLabel, "rgba(169,183,214,0.95)", 12, "center");
  ctx.restore();

  // Mapping functions
  const xToPx = (X)=> gx0 + (X - xMin)/(xMax - xMin) * (gx1 - gx0);
  const yToPx = (Y)=> gy1 - (Y - yMin)/(yMax - yMin) * (gy1 - gy0);

  // Tick labels (lightweight)
  ctx.fillStyle = "rgba(169,183,214,0.90)";
  ctx.font = `11px ${getComputedStyle(document.body).fontFamily}`;

  if(opts.xTicks){
    opts.xTicks.forEach(tick=>{
      const X = xToPx(tick.value);
      drawText(ctx, X, gy1 + 16, tick.label, "rgba(169,183,214,0.9)", 11, "center");
    });
  }else{
    for(let i=0;i<=nx;i++){
      const t = i/nx;
      const val = xMin + t*(xMax-xMin);
      const X = xToPx(val);
      const label = opts.xFmt ? opts.xFmt(val) : (Math.abs(val) >= 1000 ? val.toExponential(1) : val.toFixed(2));
      drawText(ctx, X, gy1 + 16, label, "rgba(169,183,214,0.85)", 11, "center");
    }
  }

  if(opts.yTicks){
    opts.yTicks.forEach(tick=>{
      const Y = yToPx(tick.value);
      drawText(ctx, gx0 - 8, Y + 4, tick.label, "rgba(169,183,214,0.9)", 11, "right");
    });
  }else{
    for(let j=0;j<=ny;j++){
      const t = j/ny;
      const val = yMin + t*(yMax-yMin);
      const Y = yToPx(val);
      const label = opts.yFmt ? opts.yFmt(val) : val.toFixed(2);
      drawText(ctx, gx0 - 8, Y + 4, label, "rgba(169,183,214,0.85)", 11, "right");
    }
  }

  return {gx0,gx1,gy0,gy1,xToPx,yToPx};
}

function drawLegend(ctx, x, y, items){
  // items: [{label, strokeStyle, lineWidth}]
  const pad = 8;
  const lineH = 16;
  const w = 8 + 18 + Math.max(...items.map(it=>it.label.length))*6.2;
  const h = pad*2 + items.length*lineH;
  ctx.fillStyle = "rgba(0,0,0,0.30)";
  ctx.strokeStyle = "rgba(255,255,255,0.14)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  roundRect(ctx, x, y, w, h, 10);
  ctx.fill();
  ctx.stroke();

  items.forEach((it, i)=>{
    const yy = y + pad + (i+0.6)*lineH;
    ctx.strokeStyle = it.strokeStyle;
    ctx.lineWidth = it.lineWidth ?? 2;
    ctx.beginPath();
    ctx.moveTo(x+10, yy);
    ctx.lineTo(x+26, yy);
    ctx.stroke();
    drawText(ctx, x+32, yy+4, it.label, "rgba(232,238,252,0.90)", 12, "left");
  });
}

function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

/* =========================
   Draw: band diagram
   ========================= */
function drawBandDiagram(canvas, state){
  const {ctx, w, h} = setupCanvas(canvas);
  clear(ctx,w,h);

  const margin = 18;
  const left = margin, right = w - margin, top = 30, bottom = h - 22;

  // Energy reference: Ev=0, Ec=Eg
  const Ev = 0;
  const Ec = state.Eg;

  // Extend view a bit beyond bands
  const yMin = Ev - 0.22;
  const yMax = Ec + 0.22;

  const yToPx = (E)=> bottom - (E - yMin)/(yMax - yMin)*(bottom - top);

  // Title
  drawText(ctx, left, 22, "Band Diagram (energies in eV)", "rgba(232,238,252,0.95)", 13, "left");

  // Draw bands
  ctx.strokeStyle = "rgba(125,211,252,0.9)";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(left+30, yToPx(Ec));
  ctx.lineTo(right-30, yToPx(Ec));
  ctx.stroke();
  drawText(ctx, left+30, yToPx(Ec)-8, "Ec", "rgba(125,211,252,0.95)", 12, "left");

  ctx.strokeStyle = "rgba(167,139,250,0.9)";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(left+30, yToPx(Ev));
  ctx.lineTo(right-30, yToPx(Ev));
  ctx.stroke();
  drawText(ctx, left+30, yToPx(Ev)-8, "Ev", "rgba(167,139,250,0.95)", 12, "left");

  // Shade bandgap
  ctx.fillStyle = "rgba(255,255,255,0.04)";
  ctx.fillRect(left+30, yToPx(Ec), (right-left)-60, yToPx(Ev) - yToPx(Ec));

  // Draw Ei and Ef
  const Ei = state.Ei;
  const Ef = state.Ef;

  // Ei
  ctx.strokeStyle = "rgba(52,211,153,0.95)";
  ctx.lineWidth = 2;
  ctx.setLineDash([6,4]);
  ctx.beginPath();
  ctx.moveTo(left+40, yToPx(Ei));
  ctx.lineTo(right-40, yToPx(Ei));
  ctx.stroke();
  ctx.setLineDash([]);
  drawText(ctx, right-40, yToPx(Ei)-8, "Ei (intrinsic)", "rgba(52,211,153,0.95)", 12, "right");

  // Ef (doped)
  ctx.strokeStyle = "rgba(251,191,36,0.95)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(left+40, yToPx(Ef));
  ctx.lineTo(right-40, yToPx(Ef));
  ctx.stroke();
  drawText(ctx, right-40, yToPx(Ef)-8, "Ef (doped)", "rgba(251,191,36,0.95)", 12, "right");

  // Eg bracket
  ctx.strokeStyle = "rgba(255,255,255,0.22)";
  ctx.lineWidth = 1.5;
  const xB = left + 18;
  ctx.beginPath();
  ctx.moveTo(xB, yToPx(Ec));
  ctx.lineTo(xB, yToPx(Ev));
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(xB-6, yToPx(Ec));
  ctx.lineTo(xB+6, yToPx(Ec));
  ctx.moveTo(xB-6, yToPx(Ev));
  ctx.lineTo(xB+6, yToPx(Ev));
  ctx.stroke();
  drawText(ctx, xB+10, (yToPx(Ec)+yToPx(Ev))/2 + 4, `Eg = ${state.Eg.toFixed(2)} eV`, "rgba(169,183,214,0.95)", 12, "left");

  // Axis ticks
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 1;
  const nTicks = 6;
  for(let i=0;i<=nTicks;i++){
    const t = i/nTicks;
    const E = yMin + t*(yMax-yMin);
    const Y = yToPx(E);
    ctx.beginPath();
    ctx.moveTo(left+30, Y);
    ctx.lineTo(left+34, Y);
    ctx.stroke();
    drawText(ctx, left+26, Y+4, E.toFixed(2), "rgba(169,183,214,0.85)", 11, "right");
  }
  drawText(ctx, left+8, top+12, "E (eV)", "rgba(169,183,214,0.95)", 12, "left");
}

/* =========================
   Draw: Ef vs doping (main plot)
   ========================= */
function drawEfVsDoping(canvas, state){
  const {ctx, w, h} = setupCanvas(canvas);
  clear(ctx,w,h);

  // Prepare sweep across doping magnitude and sign
  // Use log10 |D| from 13 to 19; show both n-type and p-type on x-axis as signed log scale
  const xMin = -19, xMax = 19; // signed log10(|D|), with sign
  const Ev = 0, Ec = state.Eg;

  // Y range slightly beyond bands
  const yMin = Ev - 0.15;
  const yMax = Ec + 0.15;

  // Custom ticks
  const xTicks = [];
  [-18,-16,-14,-12,12,14,16,18].forEach(v=>{
    const s = v<0 ? "p" : "n";
    xTicks.push({value:v, label:`${s}:1e${Math.abs(v)}`});
  });

  const map = drawAxes(ctx, {x:0,y:0,w,h}, xMin, xMax, yMin, yMax,
    "Net doping ND−NA (signed log10 cm⁻³)", "Energy (eV)",
    "Main Plot — Fermi Level vs Doping (example constants)",
    {
      nx: 8, ny: 6,
      xTicks,
      yFmt: (v)=>v.toFixed(2)
    }
  );

  // Compute curves for a set of x values
  function D_from_signedLog(x){
    if(Math.abs(x) < 1e-9) return 0;
    const sign = x>=0 ? 1 : -1;
    const mag = Math.pow(10, Math.abs(x));
    return sign * mag;
  }

  const N = 220;
  const pointsEf = [];
  const pointsEi = [];
  for(let i=0;i<N;i++){
    const sx = xMin + (i/(N-1))*(xMax-xMin);
    if(Math.abs(sx) < 12) continue; // skip tiny doping region between 1e12; not shown
    const D = D_from_signedLog(sx);
    const {n,p,ni} = carriers_from_doping(state.T, state.Eg, state.Nc, state.Nv, D);
    const Ei = state.Ei; // independent of D for fixed T and masses
    const Ef = Ei + Ef_shift_from_Ei(state.T, n, ni);
    pointsEf.push({sx, Ef});
    pointsEi.push({sx, Ei});
  }

  // Draw Ei (horizontal, dashed)
  ctx.strokeStyle = "rgba(52,211,153,0.95)";
  ctx.lineWidth = 2;
  ctx.setLineDash([6,4]);
  ctx.beginPath();
  let first = true;
  pointsEi.forEach(pt=>{
    const X = map.xToPx(pt.sx);
    const Y = map.yToPx(pt.Ei);
    if(first){ ctx.moveTo(X,Y); first=false; } else ctx.lineTo(X,Y);
  });
  ctx.stroke();
  ctx.setLineDash([]);

  // Draw Ef curve
  ctx.strokeStyle = "rgba(251,191,36,0.95)";
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  first = true;
  pointsEf.forEach(pt=>{
    const X = map.xToPx(pt.sx);
    const Y = map.yToPx(pt.Ef);
    if(first){ ctx.moveTo(X,Y); first=false; } else ctx.lineTo(X,Y);
  });
  ctx.stroke();

  // Band edges markers
  ctx.strokeStyle = "rgba(125,211,252,0.5)";
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(map.gx0, map.yToPx(Ec));
  ctx.lineTo(map.gx1, map.yToPx(Ec));
  ctx.stroke();
  drawText(ctx, map.gx1-6, map.yToPx(Ec)-6, "Ec", "rgba(125,211,252,0.8)", 11, "right");

  ctx.strokeStyle = "rgba(167,139,250,0.5)";
  ctx.beginPath();
  ctx.moveTo(map.gx0, map.yToPx(Ev));
  ctx.lineTo(map.gx1, map.yToPx(Ev));
  ctx.stroke();
  drawText(ctx, map.gx1-6, map.yToPx(Ev)-6, "Ev", "rgba(167,139,250,0.8)", 11, "right");

  // Current operating point marker
  const sx0 = state.signedLogD;
  const X0 = map.xToPx(sx0);
  const Y0 = map.yToPx(state.Ef);
  ctx.fillStyle = "rgba(251,191,36,0.95)";
  ctx.beginPath();
  ctx.arc(X0, Y0, 4.5, 0, Math.PI*2);
  ctx.fill();
  drawText(ctx, X0+8, Y0-8, "current", "rgba(232,238,252,0.85)", 11, "left");

  drawLegend(ctx, map.gx0+10, map.gy0+10, [
    {label:"Ef (doped)", strokeStyle:"rgba(251,191,36,0.95)", lineWidth:2.5},
    {label:"Ei (intrinsic)", strokeStyle:"rgba(52,211,153,0.95)", lineWidth:2}
  ]);
}

/* =========================
   Draw: n and p vs doping (secondary plot)
   ========================= */
function drawNpVsDoping(canvas, state){
  const {ctx, w, h} = setupCanvas(canvas);
  clear(ctx,w,h);

  const xMin = -19, xMax = 19; // signed log10(|D|)
  // y-axis: log10 concentration
  const yMin = 6, yMax = 20;

  const xTicks = [];
  [-18,-16,-14,-12,12,14,16,18].forEach(v=>{
    const s = v<0 ? "p" : "n";
    xTicks.push({value:v, label:`${s}:1e${Math.abs(v)}`});
  });

  const yTicks = [];
  [6,8,10,12,14,16,18,20].forEach(v=>{
    yTicks.push({value:v, label:`1e${v}`});
  });

  const map = drawAxes(ctx, {x:0,y:0,w,h}, xMin, xMax, yMin, yMax,
    "Net doping ND−NA (signed log10 cm⁻³)", "Carrier concentration (cm⁻³, log10)",
    "Secondary Plot — n and p vs Doping (nondegenerate model)",
    {nx: 8, ny: 7, xTicks, yTicks}
  );

  function D_from_signedLog(x){
    if(Math.abs(x) < 1e-9) return 0;
    const sign = x>=0 ? 1 : -1;
    const mag = Math.pow(10, Math.abs(x));
    return sign * mag;
  }
  function safeLog10(v){
    return Math.log10(Math.max(v, 1e-300));
  }

  const N = 240;
  const ptsN = [];
  const ptsP = [];
  for(let i=0;i<N;i++){
    const sx = xMin + (i/(N-1))*(xMax-xMin);
    if(Math.abs(sx) < 12) continue;
    const D = D_from_signedLog(sx);
    const {n,p} = carriers_from_doping(state.T, state.Eg, state.Nc, state.Nv, D);
    ptsN.push({sx, y: safeLog10(n)});
    ptsP.push({sx, y: safeLog10(p)});
  }

  // n curve
  ctx.strokeStyle = "rgba(125,211,252,0.95)";
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  let first=true;
  ptsN.forEach(pt=>{
    const X = map.xToPx(pt.sx);
    const Y = map.yToPx(pt.y);
    if(first){ctx.moveTo(X,Y); first=false;} else ctx.lineTo(X,Y);
  });
  ctx.stroke();

  // p curve
  ctx.strokeStyle = "rgba(167,139,250,0.95)";
  ctx.lineWidth = 2.5;
  ctx.beginPath();
  first=true;
  ptsP.forEach(pt=>{
    const X = map.xToPx(pt.sx);
    const Y = map.yToPx(pt.y);
    if(first){ctx.moveTo(X,Y); first=false;} else ctx.lineTo(X,Y);
  });
  ctx.stroke();

  // current point markers
  const X0 = map.xToPx(state.signedLogD);
  const yN0 = map.yToPx(Math.log10(state.n));
  const yP0 = map.yToPx(Math.log10(state.p));

  ctx.fillStyle = "rgba(125,211,252,0.95)";
  ctx.beginPath(); ctx.arc(X0, yN0, 4.5, 0, Math.PI*2); ctx.fill();

  ctx.fillStyle = "rgba(167,139,250,0.95)";
  ctx.beginPath(); ctx.arc(X0, yP0, 4.5, 0, Math.PI*2); ctx.fill();

  drawLegend(ctx, map.gx0+10, map.gy0+10, [
    {label:"n (electrons)", strokeStyle:"rgba(125,211,252,0.95)", lineWidth:2.5},
    {label:"p (holes)", strokeStyle:"rgba(167,139,250,0.95)", lineWidth:2.5}
  ]);
}

/* =========================
   State + UI
   ========================= */
const bandCanvas = document.getElementById('bandCanvas');
const efCanvas   = document.getElementById('efCanvas');
const npCanvas   = document.getElementById('npCanvas');

const tempEl = document.getElementById('temp');
const massEl = document.getElementById('massRatio');
const dopTypeEl = document.getElementById('dopType');
const dopLevelEl = document.getElementById('dopLevel');

const tempOut = document.getElementById('tempOut');
const massOut = document.getElementById('massOut');
const dopOut  = document.getElementById('dopOut');

const niOut = document.getElementById('niOut');
const npOut = document.getElementById('npOut');
const efOut = document.getElementById('efOut');

function fmtSci(x){
  if(!isFinite(x) || x<=0) return "0";
  const e = Math.floor(Math.log10(x));
  const m = x / Math.pow(10,e);
  return `${m.toFixed(2)}e${e}`;
}

function computeState(){
  const T = parseFloat(tempEl.value);
  const massRatio = parseFloat(massEl.value);
  const dopType = dopTypeEl.value;
  const logD = parseFloat(dopLevelEl.value); // log10 magnitude

  const Dmag = Math.pow(10, logD);
  const D = (dopType === "n" ? +Dmag : -Dmag);

  const Ev = 0;
  const Ec = Eg_default;

  const Nc = Nc_of_T(T, massRatio);
  const Nv = Nv_of_T(T, massRatio);

  const {n,p,ni} = carriers_from_doping(T, Eg_default, Nc, Nv, D);
  const Ei = intrinsic_Ei(Ev, Ec, T, Nc, Nv);
  const Ef = Ei + Ef_shift_from_Ei(T, n, ni);

  // signed log for x-axis in plots
  const signedLogD = (D>=0 ? +logD : -logD);

  return {T, massRatio, dopType, logD, D, signedLogD, Eg:Eg_default, Ev, Ec, Nc, Nv, ni, n, p, Ei, Ef};
}

function updateReadouts(state){
  tempOut.textContent = `T = ${state.T.toFixed(0)} K`;
  massOut.textContent = `m*h/m*e = ${state.massRatio.toFixed(2)}`;
  dopOut.textContent  = `|ND−NA| = ${fmtSci(Math.abs(state.D))} cm⁻³`;

  niOut.textContent = `ni = ${fmtSci(state.ni)} cm⁻³`;
  npOut.textContent = `n = ${fmtSci(state.n)} ,  p = ${fmtSci(state.p)}`;
  efOut.textContent = `Ei = ${state.Ei.toFixed(3)} eV,  Ef = ${state.Ef.toFixed(3)} eV`;
}

function renderAll(){
  const state = computeState();
  updateReadouts(state);
  drawBandDiagram(bandCanvas, state);
  drawEfVsDoping(efCanvas, state);
  drawNpVsDoping(npCanvas, state);
}

[tempEl, massEl, dopTypeEl, dopLevelEl].forEach(el=>{
  el.addEventListener('input', renderAll);
  el.addEventListener('change', renderAll);
});

// Responsive redraw
let resizeTimer = null;
window.addEventListener('resize', ()=>{
  clearTimeout(resizeTimer);
  resizeTimer = setTimeout(renderAll, 100);
});

renderAll();
</script>
</body>
</html>
