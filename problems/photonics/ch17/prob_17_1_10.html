<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Energy Levels in a GaAs/AlGaAs Quantum Well (GaAs/Al0.3Ga0.7As)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1733;
      --card:#111c3f;
      --ink:#eaf0ff;
      --muted:#b9c4e6;
      --soft:#7f8bb3;
      --accent:#7cf0c8;
      --accent2:#8ab4ff;
      --warn:#ffcc66;
      --danger:#ff6b7a;
      --border:rgba(255,255,255,.12);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }

    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      background: radial-gradient(1200px 900px at 15% 10%, rgba(124,240,200,.16), transparent 55%),
                  radial-gradient(900px 700px at 85% 20%, rgba(138,180,255,.16), transparent 60%),
                  linear-gradient(180deg, #070a14, var(--bg));
      color: var(--ink);
      line-height:1.55;
    }

    header{
      padding: 28px 18px 18px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), transparent);
      position: relative;
      overflow:hidden;
    }
    header .wrap{
      max-width: 1100px;
      margin: 0 auto;
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap: 18px;
      align-items: start;
    }
    h1{
      margin:0;
      font-size: clamp(1.45rem, 2.2vw, 2.15rem);
      letter-spacing:.2px;
    }
    .subtitle{
      margin-top:10px;
      color: var(--muted);
      font-size: 1.02rem;
    }
    .badgeRow{
      display:flex; gap:10px; flex-wrap:wrap;
      justify-content:flex-end;
      padding-top:4px;
    }
    .badge{
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      padding: 7px 10px;
      border-radius:999px;
      font-size:.85rem;
      color: var(--muted);
      backdrop-filter: blur(6px);
      box-shadow: 0 8px 18px rgba(0,0,0,.18);
    }
    .badge b{ color: var(--ink); font-weight:700; }

    main{
      max-width: 1100px;
      margin: 0 auto;
      padding: 18px;
      display:grid;
      grid-template-columns: 290px 1fr;
      gap: 18px;
      align-items:start;
    }

    nav#toc{
      position: sticky;
      top: 12px;
      align-self:start;
      border: 1px solid var(--border);
      background: rgba(17,28,63,.62);
      border-radius: 16px;
      padding: 14px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      max-height: calc(100vh - 24px);
      overflow:auto;
    }
    nav#toc .tocTitle{
      font-weight:800;
      letter-spacing:.3px;
      margin: 0 0 10px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    nav#toc a{
      display:block;
      padding: 7px 8px;
      margin: 3px 0;
      border-radius: 10px;
      color: var(--muted);
      text-decoration:none;
      border:1px solid transparent;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size: .93rem;
    }
    nav#toc a:hover{
      background: rgba(124,240,200,.10);
      border-color: rgba(124,240,200,.24);
      transform: translateX(2px);
      color: var(--ink);
    }

    .content{
      display:flex;
      flex-direction:column;
      gap: 16px;
      min-width: 0;
    }

    section, article{
      border:1px solid var(--border);
      background: rgba(15,23,51,.55);
      border-radius: 18px;
      box-shadow: var(--shadow);
      padding: 16px 16px 14px;
      backdrop-filter: blur(10px);
      min-width:0;
    }

    h2{
      margin: 0 0 10px;
      font-size: 1.25rem;
      letter-spacing:.2px;
    }
    h3{
      margin: 14px 0 8px;
      font-size: 1.07rem;
      color: var(--ink);
    }
    p{ margin: 8px 0; color: var(--muted); }
    ul{ margin: 8px 0 8px 18px; color: var(--muted); }
    li{ margin: 6px 0; }
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    .card{
      border:1px solid var(--border);
      background: rgba(17,28,63,.55);
      border-radius: 14px;
      padding: 12px 12px 10px;
      min-width:0;
    }
    .callout{
      border-left: 4px solid var(--accent);
      background: rgba(124,240,200,.08);
      border-radius: 12px;
      padding: 12px;
      margin: 10px 0;
      border-top: 1px solid rgba(124,240,200,.18);
      border-right: 1px solid rgba(124,240,200,.18);
      border-bottom: 1px solid rgba(124,240,200,.18);
    }
    .callout.warn{ border-left-color: var(--warn); background: rgba(255,204,102,.08); border-color: rgba(255,204,102,.20); }
    .callout.danger{ border-left-color: var(--danger); background: rgba(255,107,122,.08); border-color: rgba(255,107,122,.20); }
    .callout b{ color: var(--ink); }
    .equationBox{
      border:1px dashed rgba(138,180,255,.35);
      background: rgba(138,180,255,.08);
      border-radius: 14px;
      padding: 12px;
      margin: 10px 0;
      position: relative;
      overflow:hidden;
    }
    .eq{
      font-family: var(--mono);
      font-size: .95rem;
      white-space: pre-wrap;
      color: var(--ink);
      margin:0;
    }
    .copyRow{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      margin-top: 10px;
    }
    button.copyBtn{
      cursor:pointer;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 12px;
      font-weight: 650;
      font-size: .9rem;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    button.copyBtn:hover{
      transform: translateY(-1px);
      background: rgba(124,240,200,.10);
      border-color: rgba(124,240,200,.25);
    }
    .tiny{
      font-size: .88rem;
      color: var(--soft);
    }
    .kpi{
      display:flex;
      flex-direction:column;
      gap:6px;
    }
    .kpi .label{
      font-size:.86rem;
      color: var(--soft);
    }
    .kpi .value{
      font-family: var(--mono);
      font-size: 1.02rem;
      color: var(--ink);
    }
    .kpi .value b{ color: var(--accent); }
    .hr{
      height:1px; background: var(--border); margin: 12px 0;
    }

    figure{
      margin: 0;
    }
    .canvasWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    canvas{
      width: 100%;
      height: 360px;
      border-radius: 16px;
      border: 1px solid var(--border);
      background: rgba(7,10,20,.55);
      box-shadow: 0 10px 26px rgba(0,0,0,.28);
    }
    .controls{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap: 12px;
      align-items:end;
    }
    .control{
      border:1px solid var(--border);
      background: rgba(17,28,63,.45);
      border-radius: 14px;
      padding: 12px;
    }
    .control label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      font-weight:700;
      color: var(--ink);
    }
    .control .readout{
      font-family: var(--mono);
      color: var(--accent);
      font-weight:800;
      font-size:.95rem;
    }
    input[type="range"]{
      width:100%;
      margin-top:10px;
      accent-color: var(--accent);
    }
    select{
      width:100%;
      margin-top:10px;
      padding: 9px 10px;
      border-radius: 12px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      outline: none;
    }

    footer{
      max-width: 1100px;
      margin: 0 auto 24px;
      padding: 0 18px;
      color: var(--soft);
      font-size: .9rem;
    }

    @media (max-width: 980px){
      header .wrap{ grid-template-columns: 1fr; }
      .badgeRow{ justify-content:flex-start; }
      main{ grid-template-columns: 1fr; }
      nav#toc{ position: relative; top: 0; max-height: none; }
      .controls{ grid-template-columns: 1fr; }
      canvas{ height: 320px; }
      .grid2, .grid3{ grid-template-columns: 1fr; }
    }

    @media print{
      body{ background:white; color:black; }
      header, nav#toc, .controls, .copyRow{ display:none !important; }
      section, article{ box-shadow:none; background:white; border:1px solid #ddd; }
      canvas{ border:1px solid #bbb; box-shadow:none; }
      p,li{ color:#111; }
      .eq{ color:#000; }
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div>
      <h1>Energy Levels in a GaAs/AlGaAs Quantum Well (GaAs/Al<sub>x</sub>Ga<sub>1−x</sub>As)</h1>
      <div class="subtitle">
        We build the band-edge diagram (GaAs well, AlGaAs barriers), compute the <b>conduction-band well depth</b>,
        and then infer the <b>well width</b> that reproduces a given finite-well spectrum.
      </div>
    </div>
    <div class="badgeRow">
      <div class="badge"><b>Topic</b>: quantum wells</div>
      <div class="badge"><b>Model</b>: 1D finite square well</div>
      <div class="badge"><b>Output</b>: diagram + numeric d</div>
    </div>
  </div>
</header>

<main>
  <nav id="toc" aria-label="Table of contents">
    <div class="tocTitle">
      <span>Table of Contents</span>
      <span class="tiny">sticky</span>
    </div>
    <a href="#quick">Quick Summary</a>
    <a href="#primer">PART 0 — Concept Primer</a>
    <a href="#analysis">PART 1 — Problem Analysis</a>
    <a href="#strategy">PART 2 — Strategy & Tips</a>
    <a href="#solution">PART 3 — Full Solution</a>
    <a href="#deeper">PART 4 — Deeper Understanding</a>
    <a href="#vizguide">PART 5 — Visualization Guide</a>
  </nav>

  <div class="content">
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li>We analyze a <b>GaAs/AlGaAs multi-quantum-well</b>: GaAs is the well, Al<sub>x</sub>Ga<sub>1−x</sub>As is the barrier.</li>
        <li>The barrier bandgap increases with Al fraction: <span class="eq">E<sub>g</sub>(Al<sub>x</sub>GaAs) ≈ E<sub>g</sub>(GaAs) + (1.247 eV)·x</span>.</li>
        <li>The <b>bandgap discontinuity</b> <span class="eq">ΔE<sub>g</sub></span> splits into conduction/valence offsets; here <b>60%</b> goes to the conduction band: <span class="eq">V<sub>0c</sub> = ΔE<sub>c</sub> ≈ 0.60·ΔE<sub>g</sub></span>.</li>
        <li>We use a <b>1D finite square well</b> as the electron confinement model (effective mass approximation).</li>
        <li>Given a reference spectrum for which <span class="eq">V<sub>0</sub> = 32ħ²/(m d²)</span> (equivalently the dimensionless depth parameter equals 4), we solve for the width: <span class="eq">d = √(32ħ²/(m V<sub>0</sub>))</span>.</li>
        <li><b>For x = 0.3</b>: ΔE<sub>g</sub> ≈ 0.374 eV, so <b>V<sub>0c</sub> ≈ 0.224 eV</b>, and with m* = 0.07m<sub>0</sub> we get <b>d ≈ 12.4 nm</b>.</li>
        <li>The bound-state energies then scale with V<sub>0</sub>: <span class="eq">E<sub>1</sub>≈0.10V<sub>0</sub>, E<sub>2</sub>≈0.37V<sub>0</sub>, E<sub>3</sub>≈0.81V<sub>0</sub></span> (fractions from the provided finite-well figure).</li>
      </ul>
    </section>

    <article id="primer">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div class="card">
          <h3>Core definitions (symbols & units)</h3>
          <ul>
            <li><b>Bandgap</b> E<sub>g</sub> (eV): energy difference between conduction-band minimum and valence-band maximum.</li>
            <li><b>Band offsets</b> ΔE<sub>c</sub>, ΔE<sub>v</sub> (eV): discontinuities at a heterojunction in conduction and valence bands.</li>
            <li><b>Well depth</b> V<sub>0</sub> (J or eV): barrier height of the finite square well for electrons (here V<sub>0</sub> = ΔE<sub>c</sub>).</li>
            <li><b>Well width</b> d (m): thickness of the GaAs layer where the electron is confined.</li>
            <li><b>Effective mass</b> m* (kg): electron inertial parameter in a band; used in Schrödinger equation in semiconductors.</li>
            <li><b>Reduced Planck constant</b> ħ (J·s): ħ = h/(2π).</li>
          </ul>
        </div>

        <div class="card">
          <h3>Physical meaning</h3>
          <ul>
            <li>In a heterostructure, <b>different bandgaps</b> create <b>potential steps</b> for carriers.</li>
            <li>For an electron in the conduction band, the GaAs region is a <b>lower potential energy</b> (the well) and AlGaAs is a <b>higher potential</b> (the barrier).</li>
            <li>Quantum confinement quantizes motion along the growth direction (z), producing discrete <b>subband energies</b> E<sub>n</sub> below the barrier top.</li>
          </ul>
        </div>
      </div>

      <h3>Key laws/principles (validity & assumptions)</h3>
      <div class="callout">
        <b>Effective-mass Schrödinger model (1D confinement):</b><br/>
        For a conduction-band electron confined along z:
        <div class="equationBox">
          <pre class="eq" id="eq_sch">-(ħ²/2m*) d²ψ/dz² + V(z)ψ = Eψ</pre>
          <div class="copyRow">
            <button class="copyBtn" data-copy-target="eq_sch">Copy equation</button>
          </div>
        </div>
        <span class="tiny">Valid when the envelope-function approximation holds: slowly varying envelope compared to the lattice scale; abrupt interfaces modeled as step potentials; single-band conduction description.</span>
      </div>

      <h3>Common models/approximations (why we use them)</h3>
      <ul>
        <li><b>Finite square well</b>: treats the conduction-band profile as piecewise constant (0 inside GaAs, V<sub>0</sub> in AlGaAs). Great for quick estimates and intuition.</li>
        <li><b>Band-offset rule</b>: the bandgap difference ΔE<sub>g</sub> splits into ΔE<sub>c</sub> and ΔE<sub>v</sub>. In many AlGaAs/GaAs contexts, a common estimate is ~60/40 (conduction/valence) for the discontinuity share.</li>
        <li><b>Neglect of strain and nonparabolicity</b>: for small/moderate Al content and introductory estimates, we often ignore strain and energy-dependent mass.</li>
      </ul>

      <h3>Mini intuition examples</h3>
      <ul>
        <li>If the well is <b>narrower</b>, kinetic energy increases (uncertainty principle), so the bound levels move <b>up</b>.</li>
        <li>If the barrier is <b>higher</b> (larger V<sub>0</sub>), the wavefunction leaks less and bound states become <b>more like</b> an infinite well.</li>
      </ul>

      <div class="callout warn">
        <b>What to watch for (pitfalls):</b>
        <ul>
          <li>Mixing <b>eV</b> and <b>J</b> in formulas with ħ (use J in SI, or convert consistently).</li>
          <li>Confusing the <b>bandgap increase</b> with the <b>conduction-band offset</b>. Only a fraction of ΔE<sub>g</sub> becomes the electron barrier height.</li>
          <li>Using the free-electron mass instead of the <b>effective mass m*</b>.</li>
        </ul>
      </div>
    </article>

    <article id="analysis">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Restated problem (in plain words)</h3>
      <p>
        We have a GaAs/AlGaAs quantum-well structure where the barrier alloy is Al<sub>0.3</sub>Ga<sub>0.7</sub>As.
        (a) Draw the energy-band diagram and determine the bandgap difference and the <b>conduction-band well depth</b>.
        (b) Treat the GaAs conduction-band well as a <b>finite 1D square well</b> whose energy levels match a reference case
        where the well depth satisfies <span class="eq">V<sub>0</sub> = 32ħ²/(m d²)</span>. Find the well width d.
      </p>

      <div class="grid2">
        <div class="card">
          <h3>Given</h3>
          <ul>
            <li>E<sub>g</sub>(GaAs) = 1.42 eV</li>
            <li>E<sub>g</sub>(AlGaAs) increases by 12.47 meV per 1% Al → by 1.247 eV per x = 1</li>
            <li>Al fraction x = 0.3</li>
            <li>Conduction-band well depth is ~60% of total band discontinuity: ΔE<sub>c</sub> ≈ 0.60 ΔE<sub>g</sub></li>
            <li>Finite-well reference: V<sub>0</sub> = 32ħ²/(m d²) and level fractions (from figure): E<sub>1</sub>≈0.10V<sub>0</sub>, E<sub>2</sub>≈0.37V<sub>0</sub>, E<sub>3</sub>≈0.81V<sub>0</sub></li>
            <li>Electron effective mass in GaAs: m* ≈ 0.07m<sub>0</sub> = 0.64×10<sup>−31</sup> kg</li>
          </ul>
        </div>
        <div class="card">
          <h3>Unknowns / must find</h3>
          <ul>
            <li>ΔE<sub>g</sub> and the band diagram offsets</li>
            <li>Conduction-band barrier height V<sub>0c</sub> (electron well depth)</li>
            <li>Well width d satisfying V<sub>0c</sub> = 32ħ²/(m* d²)</li>
            <li>(Optional interpretation) numerical energies E<sub>1</sub>, E<sub>2</sub>, E<sub>3</sub></li>
          </ul>
        </div>
      </div>

      <h3>Which physics applies (and why)</h3>
      <ul>
        <li><b>Heterojunction band offsets</b>: different bandgaps mean different conduction/valence edges → step-like potentials.</li>
        <li><b>1D confinement Schrödinger equation</b>: motion is quantized along growth direction in a thin layer.</li>
        <li><b>Effective mass approximation</b>: conduction-band electrons in GaAs behave like particles with mass m* in the envelope equation.</li>
      </ul>
      <p class="tiny">We do not need full k·p bandstructure or many-body effects because the task is a band-offset + finite-well estimate.</p>

      <div class="callout">
        <b>Assumptions (explicit):</b>
        <ul>
          <li>Band edges form abrupt steps; GaAs well potential is 0 and AlGaAs barrier is V<sub>0c</sub>.</li>
          <li>Conduction-band offset fraction is 60% of ΔE<sub>g</sub> (given rule-of-thumb).</li>
          <li>Electron effective mass is constant in the well (GaAs value used).</li>
          <li>We use the provided finite-well reference spectrum (dimensionless depth parameter fixed) to infer d.</li>
        </ul>
      </div>

      <h3>Possible approaches (choose one)</h3>
      <ul>
        <li><b>Approach A (used here):</b> compute ΔE<sub>g</sub> → V<sub>0c</sub>, then use V<sub>0</sub>=32ħ²/(m d²) to solve d directly. <b>Fast</b>, uses given reference spectrum.</li>
        <li><b>Approach B:</b> solve transcendental finite-well equations (even/odd) for the actual energies; then fit d. <b>More general</b> but unnecessary because the problem supplies the needed dimensionless relation.</li>
        <li><b>Approach C:</b> approximate with infinite well energies E<sub>n</sub>≈(ħ²π²n²)/(2m d²) and apply a correction for finite depth. <b>Good intuition</b> but less precise than the provided reference.</li>
      </ul>
      <p><b>Best choice:</b> Approach A, because the problem explicitly ties the spectrum to the reference finite-well case.</p>
    </article>

    <article id="strategy">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

      <ol style="margin:8px 0 8px 18px; color: var(--muted);">
        <li>
          <b>Compute barrier bandgap</b> for Al<sub>0.3</sub>GaAs using the linear increment rule.
          <div class="tiny">Tool: ΔE<sub>g</sub> = (1.247 eV)·x.</div>
        </li>
        <li>
          <b>Get bandgap discontinuity</b> ΔE<sub>g</sub> = E<sub>g</sub>(barrier) − E<sub>g</sub>(well).
          <div class="tiny">Meaning: total energy “step” available across conduction + valence.</div>
        </li>
        <li>
          <b>Split ΔE<sub>g</sub> into offsets</b> using the 60/40 rule: ΔE<sub>c</sub>=0.60ΔE<sub>g</sub>, ΔE<sub>v</sub>=0.40ΔE<sub>g</sub>.
          <div class="tiny">Meaning: electron confinement uses ΔE<sub>c</sub>.</div>
        </li>
        <li>
          <b>Set finite-well depth</b> V<sub>0</sub> = ΔE<sub>c</sub> and convert to SI (J).
          <div class="tiny">Tip: 1 eV = 1.602×10<sup>−19</sup> J.</div>
        </li>
        <li>
          <b>Solve for width</b> using the given reference relation V<sub>0</sub> = 32ħ²/(m* d²).
          <div class="tiny">Meaning: d is chosen so the dimensionless depth parameter matches the reference spectrum.</div>
        </li>
        <li>
          <b>(Optional) Compute bound energies</b> from the figure fractions: E<sub>n</sub> = f<sub>n</sub>V<sub>0</sub>.
          <div class="tiny">Tip: energies scale linearly with V<sub>0</sub> when those fractions are fixed.</div>
        </li>
      </ol>

      <div class="callout warn">
        <b>Common mistakes & quick tips</b>
        <ul>
          <li><b>Don’t</b> use ΔE<sub>g</sub> as the electron barrier; use <b>ΔE<sub>c</sub> = 0.60ΔE<sub>g</sub></b>.</li>
          <li>When using ħ in SI, <b>convert V<sub>0</sub> to joules</b>.</li>
          <li>Keep d in meters until the end, then convert to nm (1 nm = 10<sup>−9</sup> m).</li>
        </ul>
      </div>
    </article>

    <article id="solution">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Qualitative expectation (before calculating)</h3>
      <p>
        Adding Al to GaAs increases the barrier bandgap, raising the barrier band edges relative to GaAs. That should produce
        a finite electron well of depth ΔE<sub>c</sub>. If ΔE<sub>c</sub> is a few tenths of an eV (typical),
        then a well width on the order of <b>several to ~10 nm</b> often supports a handful of bound electron states—consistent
        with the reference spectrum showing three bound levels.
      </p>

      <div class="hr"></div>

      <h3>(a) Bandgap and band offsets for Al<sub>0.3</sub>Ga<sub>0.7</sub>As</h3>

      <p><b>Step 1: Compute E<sub>g</sub> of the barrier.</b> The problem states:</p>
      <div class="equationBox">
        <pre class="eq" id="eq_eg">E_g(Al_xGaAs) ≈ E_g(GaAs) + (12.47 meV per 1%)·(100x)
             = E_g(GaAs) + (1.247 eV)·x</pre>
        <div class="copyRow">
          <button class="copyBtn" data-copy-target="eq_eg">Copy equation</button>
        </div>
      </div>

      <p>For x = 0.30:</p>
      <div class="equationBox">
        <pre class="eq" id="eq_eg_num">E_g(barrier) = 1.42 eV + (1.247 eV)(0.30)
              = 1.42 eV + 0.3741 eV
              = 1.7941 eV</pre>
        <div class="copyRow">
          <button class="copyBtn" data-copy-target="eq_eg_num">Copy steps</button>
        </div>
      </div>

      <p><b>Step 2: Bandgap discontinuity.</b></p>
      <div class="equationBox">
        <pre class="eq" id="eq_dEg">ΔE_g = E_g(barrier) − E_g(well)
     = 1.7941 eV − 1.42 eV
     = 0.3741 eV</pre>
        <div class="copyRow">
          <button class="copyBtn" data-copy-target="eq_dEg">Copy ΔEg</button>
        </div>
      </div>

      <p><b>Step 3: Split into conduction and valence offsets (given 60% rule).</b></p>
      <div class="equationBox">
        <pre class="eq" id="eq_offsets">ΔE_c ≈ 0.60·ΔE_g
ΔE_v ≈ 0.40·ΔE_g</pre>
        <div class="copyRow">
          <button class="copyBtn" data-copy-target="eq_offsets">Copy offsets</button>
        </div>
      </div>

      <p>Numerically:</p>
      <div class="equationBox">
        <pre class="eq" id="eq_offsets_num">ΔE_c ≈ 0.60(0.3741 eV) = 0.22446 eV
ΔE_v ≈ 0.40(0.3741 eV) = 0.14964 eV</pre>
        <div class="copyRow">
          <button class="copyBtn" data-copy-target="eq_offsets_num">Copy numeric offsets</button>
        </div>
      </div>

      <div class="callout">
        <b>Result (a):</b> The GaAs conduction-band well depth (electron barrier height) is
        <b>V<sub>0c</sub> = ΔE<sub>c</sub> ≈ 0.224 eV</b>. The valence-band offset is ≈ 0.150 eV.
      </div>

      <div class="hr"></div>

      <h3>(b) Well width d from the reference finite-square-well spectrum</h3>

      <p>
        We are told the GaAs conduction well has the <b>same energy level pattern</b> as the shown finite square well, for which
        the well depth satisfies:
      </p>

      <div class="equationBox">
        <pre class="eq" id="eq_V0">V_0 = 32·ħ²/(m*·d²)</pre>
        <div class="copyRow">
          <button class="copyBtn" data-copy-target="eq_V0">Copy key relation</button>
        </div>
      </div>

      <p>
        Here, we identify <b>V<sub>0</sub> = V<sub>0c</sub> = ΔE<sub>c</sub></b> (the conduction-band barrier height),
        and m* is the GaAs conduction-band effective mass.
      </p>

      <p><b>Step 1: Convert V<sub>0</sub> to joules (SI).</b></p>
      <div class="equationBox">
        <pre class="eq" id="eq_convert">V_0 = 0.22446 eV × (1.602176634×10⁻¹⁹ J/eV)
    = 3.596×10⁻²⁰ J  (rounded)</pre>
        <div class="copyRow">
          <button class="copyBtn" data-copy-target="eq_convert">Copy conversion</button>
        </div>
      </div>

      <p><b>Step 2: Solve for d.</b> Rearranging V<sub>0</sub> = 32ħ²/(m*d²):</p>
      <div class="equationBox">
        <pre class="eq" id="eq_dsolve">d = √( 32·ħ² / (m*·V_0) )</pre>
        <div class="copyRow">
          <button class="copyBtn" data-copy-target="eq_dsolve">Copy d formula</button>
        </div>
      </div>

      <p><b>Step 3: Substitute numbers.</b> Use ħ = 1.054571817×10<sup>−34</sup> J·s and m* = 0.64×10<sup>−31</sup> kg:</p>
      <div class="equationBox">
        <pre class="eq" id="eq_dnum">d = √( 32(1.054571817×10⁻³⁴)² / ( (0.64×10⁻³¹)(3.596×10⁻²⁰) ) )
  ≈ 1.243×10⁻⁸ m
  = 12.43 nm</pre>
        <div class="copyRow">
          <button class="copyBtn" data-copy-target="eq_dnum">Copy numeric d</button>
        </div>
      </div>

      <div class="callout" style="border-left-color: var(--accent2); background: rgba(138,180,255,.08); border-color: rgba(138,180,255,.20);">
        <b>Final Answer (b):</b><br/>
        <span class="eq" id="final_answer">For Al0.3Ga0.7As barriers: V0c ≈ 0.224 eV, and the GaAs conduction-band well width is d ≈ 12.4 nm (using V0 = 32ħ²/(m*d²) with m* = 0.07m0).</span>
        <div class="copyRow">
          <button class="copyBtn" data-copy-target="final_answer">Copy final answer</button>
        </div>
      </div>

      <h3>Sanity checks</h3>
      <div class="grid3">
        <div class="card">
          <h3 style="margin-top:0;">Units</h3>
          <p class="tiny">
            In <span class="eq">d = √(32ħ²/(mV))</span>,
            ħ² has units J²·s². Divide by m·V → (kg)(J) gives (J·s²/kg) = (kg·m²/s² · s² / kg) = m². Square root → m. ✅
          </p>
        </div>
        <div class="card">
          <h3 style="margin-top:0;">Limiting behavior</h3>
          <p class="tiny">
            If V<sub>0</sub> increases, the required d for the same dimensionless depth parameter decreases as d ∝ 1/√V<sub>0</sub>. ✅
          </p>
        </div>
        <div class="card">
          <h3 style="margin-top:0;">Physical sense</h3>
          <p class="tiny">
            A ~0.22 eV barrier and ~12 nm width is a classic scale for GaAs/AlGaAs wells supporting a few electron subbands. ✅
          </p>
        </div>
      </div>

      <p>
        <b>Connection to the diagram & plots:</b> The band diagram shows ΔE<sub>c</sub> and ΔE<sub>v</sub> steps.
        The plots show how increasing Al fraction increases ΔE<sub>c</sub> and therefore changes the width d needed to keep the
        same reference finite-well “shape parameter”.
      </p>
    </article>

    <article id="deeper">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpreting the formulas</h3>
      <ul>
        <li><b>ΔE<sub>g</sub></b> is controlled by alloy composition x: higher x → larger barrier bandgap.</li>
        <li><b>ΔE<sub>c</sub> = 0.60ΔE<sub>g</sub></b> controls electron confinement (well depth V<sub>0</sub>).</li>
        <li><b>d = √(32ħ²/(m*V<sub>0</sub>))</b> shows the interplay of quantum mechanics and material parameters:
          heavier mass or higher barrier allows the same spectrum with a narrower well.</li>
      </ul>

      <div class="callout">
        <b>Parameter sensitivity (connect to interactive plots):</b>
        <ul>
          <li>As x increases, V<sub>0</sub> increases roughly linearly, so <b>d decreases like 1/√x</b> (for this reference condition).</li>
          <li>The bound energies in the provided reference spectrum are fixed fractions of V<sub>0</sub>, so they <b>increase linearly</b> with x.</li>
        </ul>
      </div>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        Instead of using the supplied relation V<sub>0</sub> = 32ħ²/(m d²), one could solve the finite square well exactly.
        For even states: <span class="eq">k tan(kd/2) = κ</span>, and for odd states: <span class="eq">−k cot(kd/2)=κ</span>,
        where <span class="eq">k=√(2mE)/ħ</span>, <span class="eq">κ=√(2m(V0−E))/ħ</span>. You would then adjust d until the computed E<sub>n</sub> match the figure.
        The given relation skips that work by encoding the dimensionless depth parameter directly.
      </p>

      <h3>Concept check (self-test)</h3>
      <ul>
        <li><b>Q:</b> Why isn’t the electron barrier equal to ΔE<sub>g</sub>? <b>A:</b> Because ΔE<sub>g</sub> splits between conduction and valence offsets; only ΔE<sub>c</sub> applies to electrons.</li>
        <li><b>Q:</b> If m* were larger, would the same well depth require a larger or smaller d (for fixed spectrum parameter)? <b>A:</b> Smaller; d ∝ 1/√m*.</li>
        <li><b>Q:</b> Why do bound energies scale with V<sub>0</sub> in the reference figure? <b>A:</b> The displayed energies are given as fractions of V<sub>0</sub>; if the shape parameter is held fixed, the spectrum rescales with V<sub>0</sub>.</li>
      </ul>
    </article>

    <article id="vizguide">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <div class="controls" aria-label="Interactive controls">
        <div class="control">
          <label>
            Al fraction <span class="tiny">(barrier composition)</span>
            <span class="readout" id="xReadout">x = 0.30</span>
          </label>
          <input id="xSlider" type="range" min="0" max="0.45" step="0.01" value="0.30" />
          <div class="tiny" style="margin-top:8px;">
            Changes barrier bandgap → changes ΔE<sub>c</sub> → updates diagram + both plots.
          </div>
        </div>
        <div class="control">
          <label>
            Conduction offset share
            <span class="readout" id="shareReadout">60%</span>
          </label>
          <input id="shareSlider" type="range" min="0.4" max="0.75" step="0.01" value="0.60" />
          <div class="tiny" style="margin-top:8px;">
            Adjusts how ΔE<sub>g</sub> splits into ΔE<sub>c</sub> and ΔE<sub>v</sub>.
          </div>
        </div>
        <div class="control">
          <label>
            Energy-level pattern
            <span class="readout" id="patternReadout">Fig fractions</span>
          </label>
          <select id="patternSelect">
            <option value="fig" selected>Use provided finite-well fractions (0.10, 0.37, 0.81)</option>
            <option value="inf">Compare to infinite-well ratios (n² scaling, normalized)</option>
          </select>
          <div class="tiny" style="margin-top:8px;">
            Secondary visualization: compare the reference finite-well levels to an infinite-well-like pattern.
          </div>
        </div>
      </div>

      <div class="grid2" style="margin-top:12px;">
        <div class="card kpi">
          <div class="label">Barrier bandgap E<sub>g</sub>(Al<sub>x</sub>GaAs) (eV)</div>
          <div class="value" id="kpiEgB">1.7941</div>
          <div class="label">Bandgap discontinuity ΔE<sub>g</sub> (eV)</div>
          <div class="value" id="kpiDEg">0.3741</div>
        </div>
        <div class="card kpi">
          <div class="label">Conduction well depth V<sub>0</sub>=ΔE<sub>c</sub> (eV)</div>
          <div class="value" id="kpiV0">0.2245</div>
          <div class="label">Well width d from V<sub>0</sub>=32ħ²/(m*d²) (nm)</div>
          <div class="value" id="kpiD"><b>12.43</b></div>
        </div>
      </div>

      <figure class="canvasWrap" style="margin-top:12px;">
        <canvas id="cDiagram" aria-label="Band diagram canvas"></canvas>
        <canvas id="cMain" aria-label="Main plot canvas"></canvas>
        <canvas id="cSecondary" aria-label="Secondary plot canvas"></canvas>
        <figcaption class="tiny">
          Diagram: band edges and offsets. Main plot: d versus Al fraction x (for the chosen offset share and fixed reference spectrum parameter).
          Secondary plot: bound levels versus x (or comparison pattern) updated live.
        </figcaption>
      </figure>

      <div class="callout">
        <b>What each canvas shows</b>
        <ul>
          <li><b>Band diagram:</b> Conduction and valence band edges across barrier–well–barrier, with ΔE<sub>c</sub> and ΔE<sub>v</sub> labeled.</li>
          <li><b>Main plot:</b> Required well width <b>d(x)</b> to satisfy <span class="eq">V<sub>0</sub>=32ħ²/(m*d²)</span> when V<sub>0</sub>=ΔE<sub>c</sub>(x).</li>
          <li><b>Secondary plot:</b> Energy levels E<sub>1</sub>, E<sub>2</sub>, E<sub>3</sub> vs x using either the provided finite-well fractions or an infinite-well-like normalized pattern for comparison.</li>
        </ul>
      </div>
    </article>
  </div>
</main>

<footer>
  <div class="hr"></div>
  Built as a self-contained learning article: vanillla HTML/CSS/JS, interactive canvases, and copyable equations.
</footer>

<script>
(function(){
  // ---------- Constants ----------
  const EgGaAs = 1.42;          // eV
  const slope = 1.247;          // eV per x (since 12.47 meV per 1% => 1.247 eV per 100%)
  const hbar = 1.054571817e-34; // J*s
  const eVtoJ = 1.602176634e-19;
  const mEff = 0.64e-31;        // kg (given)

  // Reference level fractions from the provided finite well figure (for the case shown).
  const figFractions = [0.10, 0.37, 0.81];

  // ---------- DOM ----------
  const xSlider = document.getElementById('xSlider');
  const shareSlider = document.getElementById('shareSlider');
  const patternSelect = document.getElementById('patternSelect');

  const xReadout = document.getElementById('xReadout');
  const shareReadout = document.getElementById('shareReadout');
  const patternReadout = document.getElementById('patternReadout');

  const kpiEgB = document.getElementById('kpiEgB');
  const kpiDEg = document.getElementById('kpiDEg');
  const kpiV0 = document.getElementById('kpiV0');
  const kpiD = document.getElementById('kpiD');

  const cDiagram = document.getElementById('cDiagram');
  const cMain = document.getElementById('cMain');
  const cSecondary = document.getElementById('cSecondary');

  // ---------- Utilities ----------
  function clamp(v,a,b){ return Math.max(a, Math.min(b,v)); }
  function fmt(v, n=4){ return (+v).toFixed(n); }
  function fmt2(v){ return (+v).toFixed(2); }
  function fmt3(v){ return (+v).toFixed(3); }

  function copyTextFromElementId(id){
    const el = document.getElementById(id);
    if(!el) return;
    const text = el.textContent.replace(/\u00a0/g,' ');
    navigator.clipboard.writeText(text).then(()=>{
      flashToast("Copied ✓");
    }).catch(()=>{
      flashToast("Copy failed");
    });
  }

  // Simple toast
  let toastTimer = null;
  function flashToast(msg){
    let t = document.getElementById('toast');
    if(!t){
      t = document.createElement('div');
      t.id = 'toast';
      t.style.position='fixed';
      t.style.left='50%';
      t.style.bottom='18px';
      t.style.transform='translateX(-50%)';
      t.style.padding='10px 12px';
      t.style.border='1px solid rgba(255,255,255,.16)';
      t.style.background='rgba(15,23,51,.88)';
      t.style.color='white';
      t.style.borderRadius='14px';
      t.style.boxShadow='0 14px 36px rgba(0,0,0,.35)';
      t.style.fontWeight='700';
      t.style.zIndex='9999';
      t.style.backdropFilter='blur(10px)';
      document.body.appendChild(t);
    }
    t.textContent = msg;
    t.style.opacity='1';
    if(toastTimer) clearTimeout(toastTimer);
    toastTimer = setTimeout(()=>{ t.style.opacity='0'; }, 1100);
  }

  // Attach copy buttons
  document.querySelectorAll('button.copyBtn').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const target = btn.getAttribute('data-copy-target');
      if(target) copyTextFromElementId(target);
    });
  });

  // ---------- HiDPI Canvas Setup ----------
  function setupCanvas(canvas){
    const rect = canvas.getBoundingClientRect();
    const dpr = window.devicePixelRatio || 1;
    const w = Math.max(2, Math.floor(rect.width * dpr));
    const h = Math.max(2, Math.floor(rect.height * dpr));
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w; canvas.height = h;
    }
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
    return {ctx, wCSS: rect.width, hCSS: rect.height, dpr};
  }

  function drawGridAxes(ctx, box, xMin,xMax,yMin,yMax, xLabel,yLabel, title){
    const {x,y,w,h} = box;

    // Background
    ctx.save();
    ctx.fillStyle = 'rgba(7,10,20,0.35)';
    ctx.fillRect(x,y,w,h);
    ctx.restore();

    // Grid & axes
    const padL=56, padR=16, padT=34, padB=48;
    const plot = {x:x+padL, y:y+padT, w:w-padL-padR, h:h-padT-padB};

    // Title
    ctx.save();
    ctx.fillStyle = 'rgba(234,240,255,0.95)';
    ctx.font = '700 14px ui-sans-serif, system-ui';
    ctx.fillText(title, x+12, y+20);
    ctx.restore();

    // Gridlines
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.lineWidth = 1;
    const nGrid = 6;
    for(let i=0;i<=nGrid;i++){
      const gx = plot.x + (plot.w*i/nGrid);
      const gy = plot.y + (plot.h*i/nGrid);
      ctx.beginPath(); ctx.moveTo(gx, plot.y); ctx.lineTo(gx, plot.y+plot.h); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(plot.x, gy); ctx.lineTo(plot.x+plot.w, gy); ctx.stroke();
    }
    ctx.restore();

    // Axes lines
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.moveTo(plot.x, plot.y+plot.h);
    ctx.lineTo(plot.x+plot.w, plot.y+plot.h);
    ctx.moveTo(plot.x, plot.y);
    ctx.lineTo(plot.x, plot.y+plot.h);
    ctx.stroke();
    ctx.restore();

    // Ticks & labels
    ctx.save();
    ctx.fillStyle = 'rgba(185,196,230,0.95)';
    ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New"';
    const nTicks = 6;
    for(let i=0;i<=nTicks;i++){
      const tx = plot.x + (plot.w*i/nTicks);
      const val = xMin + (xMax-xMin)*i/nTicks;
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(255,255,255,0.35)';
      ctx.moveTo(tx, plot.y+plot.h);
      ctx.lineTo(tx, plot.y+plot.h+6);
      ctx.stroke();
      const s = (Math.round(val*1000)/1000).toString();
      ctx.fillText(s, tx-10, plot.y+plot.h+22);
    }
    for(let i=0;i<=nTicks;i++){
      const ty = plot.y + plot.h - (plot.h*i/nTicks);
      const val = yMin + (yMax-yMin)*i/nTicks;
      ctx.beginPath();
      ctx.strokeStyle = 'rgba(255,255,255,0.35)';
      ctx.moveTo(plot.x-6, ty);
      ctx.lineTo(plot.x, ty);
      ctx.stroke();
      const s = (Math.round(val*1000)/1000).toString();
      ctx.fillText(s, plot.x-46, ty+4);
    }
    // Axis labels
    ctx.fillStyle = 'rgba(185,196,230,0.95)';
    ctx.font = '700 12px ui-sans-serif, system-ui';
    ctx.fillText(xLabel, plot.x + plot.w/2 - ctx.measureText(xLabel).width/2, y+h-14);
    ctx.save();
    ctx.translate(x+14, plot.y + plot.h/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
    ctx.restore();
    ctx.restore();

    // Mapping
    function xMap(v){ return plot.x + (v-xMin)/(xMax-xMin)*plot.w; }
    function yMap(v){ return plot.y + plot.h - (v-yMin)/(yMax-yMin)*plot.h; }

    return {plot, xMap, yMap};
  }

  function linePlot(ctx, map, xs, ys, strokeStyle){
    ctx.save();
    ctx.strokeStyle = strokeStyle;
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<xs.length;i++){
      const px = map.xMap(xs[i]);
      const py = map.yMap(ys[i]);
      if(i===0) ctx.moveTo(px,py);
      else ctx.lineTo(px,py);
    }
    ctx.stroke();
    ctx.restore();
  }

  function pointsPlot(ctx, map, xs, ys, fillStyle){
    ctx.save();
    ctx.fillStyle = fillStyle;
    for(let i=0;i<xs.length;i++){
      const px = map.xMap(xs[i]);
      const py = map.yMap(ys[i]);
      ctx.beginPath();
      ctx.arc(px, py, 4, 0, Math.PI*2);
      ctx.fill();
    }
    ctx.restore();
  }

  function legend(ctx, x, y, items){
    ctx.save();
    ctx.font = '12px ui-sans-serif, system-ui';
    let yy = y;
    items.forEach(it=>{
      ctx.fillStyle = it.color;
      ctx.fillRect(x, yy-9, 14, 8);
      ctx.fillStyle = 'rgba(234,240,255,0.92)';
      ctx.fillText(it.label, x+20, yy);
      yy += 16;
    });
    ctx.restore();
  }

  // ---------- Physics model ----------
  function computeFromX(x, share){
    const EgB = EgGaAs + slope*x;
    const dEg = EgB - EgGaAs;
    const dEc = share * dEg;      // eV
    const dEv = (1-share) * dEg;  // eV
    const V0eV = dEc;
    const V0J = V0eV * eVtoJ;

    // Avoid division by zero near x=0 (no barrier => no well).
    let d_m = Infinity;
    if(V0J > 0){
      d_m = Math.sqrt(32*hbar*hbar/(mEff*V0J));
    }
    const d_nm = d_m * 1e9;

    // Energies using reference figure fractions
    const Efig = figFractions.map(f => f*V0eV);

    // Infinite well pattern (normalized to match E3 = 0.81 V0 for visual comparison)
    // Infinite well energies scale as n^2; choose scale so E3(inf) equals 0.81 V0.
    const n = [1,2,3];
    const scale = 0.81/(9); // because 3^2=9
    const EinfFrac = n.map(k => scale*k*k); // fractions of V0
    const Einf = EinfFrac.map(fr => fr*V0eV);

    return {x, share, EgB, dEg, dEc, dEv, V0eV, d_nm, Efig, Einf, EinfFrac};
  }

  // ---------- Diagram canvas ----------
  function drawBandDiagram(state){
    const {ctx, wCSS, hCSS} = setupCanvas(cDiagram);
    ctx.clearRect(0,0,wCSS,hCSS);

    // Layout
    const pad = 14;
    const box = {x: pad, y: pad, w: wCSS-2*pad, h: hCSS-2*pad};

    // Header
    ctx.save();
    ctx.fillStyle = 'rgba(234,240,255,0.95)';
    ctx.font = '700 14px ui-sans-serif, system-ui';
    ctx.fillText('Band-Edge Diagram (GaAs well, AlGaAs barrier)', box.x+10, box.y+18);
    ctx.restore();

    // Coordinate for energy axis (relative)
    const left = box.x + 34;
    const top = box.y + 38;
    const right = box.x + box.w - 14;
    const bottom = box.y + box.h - 16;

    // Choose energy scale from 0 to EgB + margin
    const Emax = Math.max(2.2, state.EgB + 0.35); // eV
    const Emin = -0.15;

    function yE(E){ return bottom - (E - Emin)/(Emax - Emin)*(bottom-top); }

    // Regions along x: barrier | well | barrier
    const x0 = left + 60;
    const x1 = left + (right-left)*0.34;
    const x2 = left + (right-left)*0.66;
    const x3 = right - 10;

    // Draw region labels
    ctx.save();
    ctx.fillStyle = 'rgba(185,196,230,0.90)';
    ctx.font = '700 12px ui-sans-serif, system-ui';
    ctx.fillText('AlGaAs (barrier)', x0, top-10);
    ctx.fillText('GaAs (well)', (x1+x2)/2-38, top-10);
    ctx.fillText('AlGaAs (barrier)', x2+20, top-10);
    ctx.restore();

    // Energy axis
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.moveTo(left, top);
    ctx.lineTo(left, bottom);
    ctx.stroke();
    ctx.fillStyle = 'rgba(185,196,230,0.9)';
    ctx.font = '12px ui-monospace, SFMono-Regular';
    ctx.fillText('Energy (eV)', left-28, top-14);
    // ticks
    const nTicks = 7;
    for(let i=0;i<=nTicks;i++){
      const E = Emin + (Emax-Emin)*i/nTicks;
      const yy = yE(E);
      ctx.beginPath();
      ctx.moveTo(left-6, yy);
      ctx.lineTo(left, yy);
      ctx.stroke();
      ctx.fillText((Math.round(E*100)/100).toFixed(2), left-54, yy+4);
      // faint grid
      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.beginPath();
      ctx.moveTo(left, yy);
      ctx.lineTo(right, yy);
      ctx.stroke();
      ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    }
    ctx.restore();

    // Define band edges (choose GaAs VB top as 0 reference; then CB edge at Eg)
    const Ev_w = 0.0;
    const Ec_w = EgGaAs;

    const Ev_b = Ev_w - state.dEv;      // valence band in barrier lower (more negative) by ΔEv
    const Ec_b = Ec_w + state.dEc;      // conduction band in barrier higher by ΔEc

    // Draw bands
    function drawStep(yWell, yBarrier, color){
      ctx.save();
      ctx.strokeStyle = color;
      ctx.lineWidth = 3;
      // left barrier
      ctx.beginPath();
      ctx.moveTo(x0, yE(yBarrier));
      ctx.lineTo(x1, yE(yBarrier));
      // step into well
      ctx.lineTo(x1, yE(yWell));
      ctx.lineTo(x2, yE(yWell));
      // step out
      ctx.lineTo(x2, yE(yBarrier));
      ctx.lineTo(x3, yE(yBarrier));
      ctx.stroke();
      ctx.restore();
    }

    drawStep(Ec_w, Ec_b, 'rgba(124,240,200,0.95)'); // conduction
    drawStep(Ev_w, Ev_b, 'rgba(138,180,255,0.95)'); // valence

    // Fill barrier areas lightly
    ctx.save();
    ctx.fillStyle = 'rgba(255,255,255,0.035)';
    ctx.fillRect(x0, top, x1-x0, bottom-top);
    ctx.fillRect(x2, top, x3-x2, bottom-top);
    ctx.restore();

    // Labels: ΔEc and ΔEv
    function drawDelta(x, E1, E2, label, color){
      const y1 = yE(E1), y2 = yE(E2);
      const yTop = Math.min(y1,y2), yBot = Math.max(y1,y2);
      ctx.save();
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x, yTop);
      ctx.lineTo(x, yBot);
      ctx.stroke();
      // arrow heads
      ctx.fillStyle = color;
      ctx.beginPath(); ctx.moveTo(x, yTop); ctx.lineTo(x-5, yTop+8); ctx.lineTo(x+5, yTop+8); ctx.closePath(); ctx.fill();
      ctx.beginPath(); ctx.moveTo(x, yBot); ctx.lineTo(x-5, yBot-8); ctx.lineTo(x+5, yBot-8); ctx.closePath(); ctx.fill();

      ctx.fillStyle = 'rgba(234,240,255,0.95)';
      ctx.font = '700 12px ui-sans-serif, system-ui';
      ctx.fillText(label, x+10, (yTop+yBot)/2 + 4);
      ctx.restore();
    }

    drawDelta(x1+12, Ec_w, Ec_b, `ΔEc = ${fmt3(state.dEc)} eV`, 'rgba(124,240,200,0.95)');
    drawDelta(x1+12, Ev_b, Ev_w, `ΔEv = ${fmt3(state.dEv)} eV`, 'rgba(138,180,255,0.95)');

    // Annotate V0 and d (conceptually)
    ctx.save();
    ctx.fillStyle = 'rgba(185,196,230,0.92)';
    ctx.font = '12px ui-monospace, SFMono-Regular';
    ctx.fillText(`Barrier Eg ≈ ${fmt3(state.EgB)} eV`, x2+18, top+8);
    ctx.fillText(`V0 (electron) = ΔEc ≈ ${fmt3(state.V0eV)} eV`, x2+18, top+26);

    // width label across well
    const yW = bottom-16;
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    ctx.lineWidth = 1.4;
    ctx.beginPath();
    ctx.moveTo(x1, yW);
    ctx.lineTo(x2, yW);
    ctx.stroke();
    // ticks
    ctx.beginPath(); ctx.moveTo(x1, yW-6); ctx.lineTo(x1, yW+6); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(x2, yW-6); ctx.lineTo(x2, yW+6); ctx.stroke();
    ctx.fillStyle = 'rgba(234,240,255,0.92)';
    ctx.font = '700 12px ui-sans-serif, system-ui';
    const dText = (isFinite(state.d_nm) ? `d ≈ ${fmt2(state.d_nm)} nm` : `d undefined (V0=0)`);
    ctx.fillText(dText, (x1+x2)/2 - ctx.measureText(dText).width/2, yW-10);
    ctx.restore();

    // Footer note
    ctx.save();
    ctx.fillStyle = 'rgba(185,196,230,0.78)';
    ctx.font = '12px ui-sans-serif, system-ui';
    ctx.fillText('Reference: GaAs VB top set to 0 eV (diagram is relative, not absolute to vacuum).', box.x+10, box.y+box.h-8);
    ctx.restore();
  }

  // ---------- Main plot: d vs x ----------
  function drawMainPlot(state){
    const {ctx, wCSS, hCSS} = setupCanvas(cMain);
    ctx.clearRect(0,0,wCSS,hCSS);

    // Sweep x for plot
    const xMaxPlot = 0.45;
    const xs = [];
    const ds = [];
    for(let x=0; x<=xMaxPlot+1e-9; x+=0.01){
      const st = computeFromX(+x.toFixed(2), state.share);
      xs.push(st.x);
      ds.push(isFinite(st.d_nm) ? st.d_nm : NaN);
    }
    // y range ignoring NaN
    const dsFinite = ds.filter(v=>Number.isFinite(v));
    const yMin = Math.max(0, Math.min(...dsFinite)*0.85);
    const yMax = Math.max(...dsFinite)*1.12;

    const map = drawGridAxes(
      ctx,
      {x:12,y:12,w:wCSS-24,h:hCSS-24},
      0, xMaxPlot, yMin, yMax,
      'Al fraction x (unitless)',
      'Well width d (nm)',
      'Main Plot: Width d required for the reference finite-well condition'
    );

    // line
    linePlot(ctx, map, xs, ds, 'rgba(124,240,200,0.95)');
    pointsPlot(ctx, map, xs.filter((_,i)=>i%5===0), ds.filter((_,i)=>i%5===0), 'rgba(124,240,200,0.95)');

    // current point
    if(isFinite(state.d_nm)){
      ctx.save();
      ctx.fillStyle = 'rgba(255,204,102,0.95)';
      ctx.strokeStyle = 'rgba(255,204,102,0.95)';
      const px = map.xMap(state.x);
      const py = map.yMap(state.d_nm);
      ctx.beginPath();
      ctx.arc(px, py, 6, 0, Math.PI*2);
      ctx.fill();

      ctx.font = '700 12px ui-sans-serif, system-ui';
      const tag = `x=${fmt2(state.x)}, d=${fmt2(state.d_nm)} nm`;
      const tw = ctx.measureText(tag).width;
      const bx = clamp(px+10, map.plot.x, map.plot.x+map.plot.w - (tw+16));
      const by = clamp(py-26, map.plot.y+6, map.plot.y+map.plot.h-30);
      ctx.fillStyle = 'rgba(15,23,51,0.85)';
      ctx.strokeStyle = 'rgba(255,204,102,0.45)';
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(bx, by, tw+16, 22, 10);
      ctx.fill();
      ctx.stroke();
      ctx.fillStyle = 'rgba(234,240,255,0.95)';
      ctx.fillText(tag, bx+8, by+15);
      ctx.restore();
    }

    legend(ctx, map.plot.x + map.plot.w - 170, map.plot.y + 18, [
      {label:'d(x) for fixed reference spectrum', color:'rgba(124,240,200,0.95)'},
      {label:'current selection', color:'rgba(255,204,102,0.95)'}
    ]);
  }

  // ---------- Secondary plot: energy levels vs x ----------
  function drawSecondaryPlot(state){
    const {ctx, wCSS, hCSS} = setupCanvas(cSecondary);
    ctx.clearRect(0,0,wCSS,hCSS);

    const xMaxPlot = 0.45;
    const xs = [];
    const E1 = [], E2 = [], E3 = [], V0 = [];
    const A1 = [], A2 = [], A3 = []; // alternative pattern
    for(let x=0; x<=xMaxPlot+1e-9; x+=0.01){
      const st = computeFromX(+x.toFixed(2), state.share);
      xs.push(st.x);
      V0.push(st.V0eV);

      if(state.pattern === 'fig'){
        E1.push(st.Efig[0]); E2.push(st.Efig[1]); E3.push(st.Efig[2]);
      }else{
        E1.push(st.Einf[0]); E2.push(st.Einf[1]); E3.push(st.Einf[2]);
      }

      // Always plot the other pattern faintly for comparison
      A1.push(state.pattern === 'fig' ? st.Einf[0] : st.Efig[0]);
      A2.push(state.pattern === 'fig' ? st.Einf[1] : st.Efig[1]);
      A3.push(state.pattern === 'fig' ? st.Einf[2] : st.Efig[2]);
    }

    const yMax = Math.max(...V0)*1.15 + 0.02;
    const map = drawGridAxes(
      ctx,
      {x:12,y:12,w:wCSS-24,h:hCSS-24},
      0, xMaxPlot, 0, yMax,
      'Al fraction x (unitless)',
      'Energy (eV)',
      'Secondary Plot: Bound levels (below barrier) vs composition'
    );

    // Barrier top V0
    linePlot(ctx, map, xs, V0, 'rgba(255,255,255,0.55)');

    // Main pattern levels
    linePlot(ctx, map, xs, E1, 'rgba(138,180,255,0.95)');
    linePlot(ctx, map, xs, E2, 'rgba(138,180,255,0.75)');
    linePlot(ctx, map, xs, E3, 'rgba(138,180,255,0.55)');

    // Alternative (faint dashed)
    ctx.save();
    ctx.setLineDash([6,4]);
    linePlot(ctx, map, xs, A1, 'rgba(124,240,200,0.65)');
    linePlot(ctx, map, xs, A2, 'rgba(124,240,200,0.50)');
    linePlot(ctx, map, xs, A3, 'rgba(124,240,200,0.40)');
    ctx.restore();

    // Current vertical marker
    ctx.save();
    const px = map.xMap(state.x);
    ctx.strokeStyle = 'rgba(255,204,102,0.65)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(px, map.plot.y);
    ctx.lineTo(px, map.plot.y+map.plot.h);
    ctx.stroke();

    // Current points
    function dot(y, color){
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(px, map.yMap(y), 5, 0, Math.PI*2);
      ctx.fill();
    }
    dot(state.V0eV, 'rgba(255,255,255,0.85)');
    const curLevels = (state.pattern === 'fig') ? state.Efig : state.Einf;
    dot(curLevels[0], 'rgba(138,180,255,0.95)');
    dot(curLevels[1], 'rgba(138,180,255,0.75)');
    dot(curLevels[2], 'rgba(138,180,255,0.55)');

    // Small annotation
    ctx.fillStyle = 'rgba(234,240,255,0.95)';
    ctx.font = '700 12px ui-sans-serif, system-ui';
    const label = `V0=${fmt3(state.V0eV)} eV`;
    ctx.fillText(label, clamp(px+8, map.plot.x, map.plot.x+map.plot.w-110), map.plot.y+16);
    ctx.restore();

    // Legend
    const mainLabel = (state.pattern === 'fig') ? 'Selected: Fig fractions' : 'Selected: Infinite-well-like';
    const altLabel  = (state.pattern === 'fig') ? 'Comparison: Infinite-well-like' : 'Comparison: Fig fractions';
    legend(ctx, map.plot.x + map.plot.w - 220, map.plot.y + 18, [
      {label:'Barrier top V0', color:'rgba(255,255,255,0.55)'},
      {label: mainLabel + ' (E1,E2,E3)', color:'rgba(138,180,255,0.95)'},
      {label: altLabel + ' (dashed)', color:'rgba(124,240,200,0.65)'},
      {label:'current x marker', color:'rgba(255,204,102,0.65)'}
    ]);
  }

  // ---------- State / update ----------
  function update(){
    const x = parseFloat(xSlider.value);
    const share = parseFloat(shareSlider.value);
    const pattern = patternSelect.value;

    xReadout.textContent = `x = ${fmt2(x)}`;
    shareReadout.textContent = `${Math.round(share*100)}%`;
    patternReadout.textContent = (pattern === 'fig') ? 'Fig fractions' : 'Infinite-like';

    const st = computeFromX(x, share);
    st.pattern = pattern;

    // Update KPIs
    kpiEgB.textContent = fmt4(st.EgB);
    kpiDEg.textContent = fmt4(st.dEg);
    kpiV0.textContent = fmt4(st.V0eV);
    kpiD.innerHTML = isFinite(st.d_nm) ? `<b>${fmt2(st.d_nm)}</b>` : `<b>—</b>`;

    // Draw canvases
    drawBandDiagram(st);
    drawMainPlot(st);
    drawSecondaryPlot(st);
  }

  // Resize observer (responsive redraw)
  let resizeTimer = null;
  function requestUpdate(){
    if(resizeTimer) cancelAnimationFrame(resizeTimer);
    resizeTimer = requestAnimationFrame(update);
  }

  window.addEventListener('resize', requestUpdate);
  xSlider.addEventListener('input', update);
  shareSlider.addEventListener('input', update);
  patternSelect.addEventListener('change', update);

  // Smooth scroll for TOC
  document.querySelectorAll('#toc a').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const id = a.getAttribute('href');
      const el = document.querySelector(id);
      if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
    });
  });

  // Initial draw
  update();
})();
</script>
</body>
</html>
