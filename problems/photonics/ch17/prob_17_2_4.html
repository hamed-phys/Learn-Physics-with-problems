<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Peak Spontaneous Emission Rate in Thermal Equilibrium (Direct-Gap Semiconductor)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#11182a;
      --panel2:#0f1524;
      --text:#e9eefc;
      --muted:#b9c4e2;
      --faint:#7f8bb1;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#86efac;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.10);
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 600px at 20% 0%, rgba(125,211,252,.16), transparent 60%),
                  radial-gradient(900px 500px at 80% 20%, rgba(167,139,250,.14), transparent 55%),
                  linear-gradient(180deg, var(--bg), #070a11);
      color:var(--text);
      line-height:1.55;
    }
    header{
      padding: 38px 18px 16px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .kicker{
      display:inline-flex;
      gap:10px;
      align-items:center;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:13px;
      letter-spacing:.2px;
    }
    .dot{width:10px;height:10px;border-radius:50%;background:linear-gradient(135deg,var(--accent),var(--accent2))}
    h1{
      margin:14px 0 8px;
      font-size: clamp(26px, 4vw, 40px);
      line-height:1.15;
      letter-spacing:-.6px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      max-width: 80ch;
      font-size: 16px;
    }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 10px 18px 70px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
    }

    nav.toc{
      position: sticky;
      top: 12px;
      align-self:start;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border-radius: var(--radius);
      padding: 14px 14px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    nav.toc h2{
      margin: 6px 0 10px;
      font-size: 14px;
      color: var(--muted);
      letter-spacing:.35px;
      text-transform: uppercase;
    }
    nav.toc a{
      display:block;
      padding: 9px 10px;
      margin: 6px 0;
      text-decoration:none;
      color: var(--text);
      border-radius: 12px;
      border:1px solid transparent;
      background: rgba(255,255,255,.02);
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-size: 14px;
    }
    nav.toc a:hover{
      transform: translateY(-1px);
      background: rgba(125,211,252,.08);
      border-color: rgba(125,211,252,.22);
    }
    .content{
      display:flex;
      flex-direction:column;
      gap: 16px;
      min-width: 0;
    }

    section{
      border: 1px solid var(--line);
      border-radius: var(--radius);
      background: linear-gradient(180deg, rgba(255,255,255,.045), rgba(255,255,255,.022));
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    section > .sec-head{
      padding: 14px 16px;
      border-bottom: 1px solid var(--line);
      background: rgba(255,255,255,.03);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
    }
    section h2{
      margin:0;
      font-size: 18px;
      letter-spacing:-.2px;
    }
    section .sec-body{
      padding: 16px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 860px){
      .grid2{grid-template-columns:1fr}
    }

    .callout{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px 12px;
      background: rgba(255,255,255,.03);
    }
    .callout h3{
      margin:0 0 6px;
      font-size: 14px;
      color: var(--muted);
      text-transform: uppercase;
      letter-spacing:.28px;
    }
    .callout p, .callout ul{margin: 8px 0}
    ul{padding-left: 18px}
    li{margin: 6px 0}
    .muted{color:var(--muted)}
    .faint{color:var(--faint)}
    .mono{font-family:var(--mono)}
    .eq{
      font-family:var(--mono);
      font-size: 13.5px;
      white-space: pre-wrap;
      border-radius: 14px;
      padding: 12px 12px;
      background: rgba(0,0,0,.24);
      border:1px solid rgba(255,255,255,.09);
      overflow:auto;
      position:relative;
    }
    .eq b{color:var(--accent)}
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      font-size: 13px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .btn:hover{transform: translateY(-1px); background: rgba(125,211,252,.09); border-color: rgba(125,211,252,.25)}
    .btn:active{transform: translateY(0px)}
    .btn.small{padding:6px 9px; font-size:12px; border-radius: 10px}
    .copyrow{
      display:flex; gap:8px; align-items:center; flex-wrap:wrap;
    }
    .pill{
      display:inline-flex; align-items:center; gap:8px;
      padding: 7px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.13);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      font-size: 13px;
    }
    .pill .tag{color:var(--text)}
    .hr{height:1px;background:var(--line);margin:10px 0}
    .note{
      display:flex; gap:10px; align-items:flex-start;
      padding: 10px 12px;
      border-radius: 14px;
      border:1px dashed rgba(255,255,255,.18);
      background: rgba(167,139,250,.06);
      color: var(--muted);
      margin-top: 10px;
    }
    .note .icon{
      width: 18px;height:18px;border-radius: 6px;
      background: rgba(167,139,250,.18);
      display:grid;place-items:center;color: var(--text);
      font-weight:700;font-size: 12px; flex:0 0 auto;
    }

    /* Visualization block */
    .vizwrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
    }
    .controls{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap: 12px;
      align-items:end;
    }
    @media (max-width: 900px){
      .controls{grid-template-columns: 1fr}
    }
    .control{
      border:1px solid var(--line);
      border-radius: 16px;
      padding: 12px;
      background: rgba(255,255,255,.03);
    }
    .control label{
      display:block;
      font-size: 13px;
      color: var(--muted);
      margin-bottom: 8px;
    }
    .control .row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    input[type="range"]{width:100%}
    input[type="number"], select{
      width: 100%;
      padding: 9px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      font-size: 13px;
      outline:none;
    }
    .readout{
      font-family: var(--mono);
      font-size: 12.8px;
      color: var(--text);
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding: 8px 10px;
      min-width: 140px;
      text-align:center;
    }
    .canvasCard{
      border:1px solid var(--line);
      background: rgba(255,255,255,.02);
      border-radius: 18px;
      padding: 10px;
      overflow:hidden;
    }
    canvas{display:block; width:100%; height: 320px;}
    .canvasTitle{
      display:flex;justify-content:space-between;align-items:center;
      gap:10px;margin: 2px 2px 10px;
      color: var(--muted); font-size: 13px;
    }
    .legendHint{color:var(--faint); font-size:12px}
    footer{
      max-width: 1200px;
      margin: 0 auto;
      padding: 18px 18px 38px;
      color: var(--faint);
      font-size: 13px;
    }

    /* Print-friendly */
    @media print{
      body{background:#fff;color:#000}
      nav.toc{display:none}
      section{box-shadow:none; background:#fff; border-color:#ddd}
      .eq{background:#f6f6f6; border-color:#ddd}
      .btn{display:none}
      canvas{height:240px}
    }

    /* Subtle motion */
    @media (prefers-reduced-motion: no-preference){
      section{animation: pop .35s ease both}
      @keyframes pop{from{transform:translateY(6px);opacity:.0}to{transform:translateY(0);opacity:1}}
    }
  </style>
</head>
<body>
  <header>
    <div class="kicker"><span class="dot"></span><span>Photonics / Semiconductor Optics</span><span class="faint">•</span><span class="muted">Thermal equilibrium emission</span></div>
    <h1>Peak Direct Interband Spontaneous Emission Rate in Thermal Equilibrium</h1>
    <p class="subtitle">
      We derive where the equilibrium spontaneous emission spectrum peaks, prove the closed-form peak value,
      discuss doping, and compute a GaAs number at 300 K — with interactive plots you can explore.
    </p>
  </header>

  <main>
    <nav class="toc" aria-label="Table of Contents">
      <h2>Table of Contents</h2>
      <a href="#qs">Quick Summary</a>
      <a href="#p0">PART 0 — Concept Primer</a>
      <a href="#p1">PART 1 — Problem Analysis</a>
      <a href="#p2">PART 2 — Strategy & Tips</a>
      <a href="#p3">PART 3 — Full Solution</a>
      <a href="#p4">PART 4 — Deeper Understanding</a>
      <a href="#p5">PART 5 — Visualization Guide</a>
      <div class="hr"></div>
      <div class="pill"><span class="tag">Interactive</span><span class="faint">change T, Eg, τr, doping shift</span></div>
    </nav>

    <div class="content">
      <!-- Quick Summary -->
      <section id="qs">
        <div class="sec-head">
          <h2>Quick Summary</h2>
          <div class="copyrow">
            <button class="btn small" data-copy-target="finalAnswerText">Copy final answers</button>
          </div>
        </div>
        <div class="sec-body">
          <ul>
            <li><b>What this is about:</b> the <span class="mono">spectral spontaneous emission rate</span> from a <b>direct-gap</b> semiconductor in <b>thermal equilibrium</b>.</li>
            <li><b>Key physics idea:</b> the spectrum is shaped by the <b>joint density of states</b> (∝ √(hν−Eg)) and <b>Boltzmann occupation</b> (∝ exp[−(hν−Eg)/kT]) when the Fermi level sits well inside the gap.</li>
            <li><b>Governing spectral form (nondegenerate):</b> <span class="mono">r_sp(ν) ∝ √(hν−Eg) · exp[−(hν−Eg)/kT]</span> with an overall factor <span class="mono">exp(−Eg/kT)</span>.</li>
            <li><b>Peak photon energy:</b> the spectrum maximizes at <b>hν<sub>p</sub> = Eg + (1/2)kT</b> (energy measured in joules; divide by q for eV).</li>
            <li><b>Peak value (photons/s/Hz/cm³):</b> <span class="mono">r_sp(ν_p) = (D0 / √(2e)) · √(kT)/τ_r</span>, with <span class="mono">D0 = (2mr/ħ²)^(3/2) · exp(−Eg/kT) / π²</span>.</li>
            <li><b>Doping effect:</b> if it does <b>not</b> make carriers degenerate (Fermi level still in gap, several kT from band edges), the result is essentially unchanged; <b>heavy doping</b> can shift/broaden the spectrum (Burstein–Moss, bandgap narrowing, degenerate statistics).</li>
            <li><b>GaAs at 300 K (given values):</b> <b>hν<sub>p</sub> ≈ 1.433 eV</b> and <b>r_sp(ν_p) ≈ 3.1×10²³ photons·s⁻¹·Hz⁻¹·cm⁻³</b>.</li>
          </ul>

          <div class="callout">
            <h3>Final answers (plain text)</h3>
            <pre class="eq" id="finalAnswerText">a) Peak photon energy:  hν_p = E_g + (1/2) kT.

b) Peak spectral spontaneous emission rate:
   r_sp(ν_p) = (D0 / √(2e)) (√(kT) / τ_r),
   where D0 = [(2 m_r / ħ^2)^(3/2) / π^2] exp(−E_g / kT).
   Equivalent: r_sp(ν_p) = [2 (m_r)^(3/2) / (√e π^2 ħ^3)] (√(kT) / τ_r) exp(−E_g / kT).

c) Doping: negligible change as long as carriers remain nondegenerate (E_F within the gap and ≥ several kT from band edges).
   Heavy doping → degenerate statistics + band filling (Burstein–Moss) + bandgap narrowing → peak shifts/broadens and magnitude changes.

d) GaAs, T = 300 K, τ_r = 0.4 ns, m_c = 0.07 m0, m_v = 0.50 m0, E_g = 1.42 eV:
   m_r = m_c m_v / (m_c + m_v) ≈ 0.0614 m0,
   hν_p ≈ 1.4329 eV,
   r_sp(ν_p) ≈ 3.1×10^23 photons s^−1 Hz^−1 cm^−3.</pre>
          </div>
        </div>
      </section>

      <!-- PART 0 -->
      <section id="p0">
        <div class="sec-head">
          <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>
          <div class="copyrow">
            <button class="btn small" data-copy-target="eqKey1">Copy key spectral form</button>
            <button class="btn small" data-copy-target="eqKey2">Copy peak condition</button>
          </div>
        </div>
        <div class="sec-body">
          <div class="grid2">
            <div class="callout">
              <h3>Core definitions (symbols & units)</h3>
              <ul>
                <li><b>Photon energy</b>: <span class="mono">E = hν</span> (J) or (eV); <span class="mono">h</span> is Planck’s constant, <span class="mono">ν</span> frequency (Hz).</li>
                <li><b>Bandgap</b>: <span class="mono">E_g</span> (J or eV), energy between conduction-band minimum and valence-band maximum.</li>
                <li><b>Thermal energy</b>: <span class="mono">kT</span> (J), with <span class="mono">k</span> Boltzmann constant and temperature <span class="mono">T</span> (K).</li>
                <li><b>Reduced effective mass</b> (direct transition at same <span class="mono">k</span>): <span class="mono">m_r</span> (kg), defined by
                  <span class="mono">1/m_r = 1/m_c + 1/m_v</span>,
                  so <span class="mono">m_r = (m_c m_v)/(m_c+m_v)</span>.
                </li>
                <li><b>Radiative lifetime parameter</b>: <span class="mono">τ_r</span> (s), representing the characteristic spontaneous radiative recombination time (in the simplified model used here).</li>
                <li><b>Spectral spontaneous emission rate</b>: <span class="mono">r_sp(ν)</span> (photons·s⁻¹·Hz⁻¹·cm⁻³). This is “per time, per frequency, per volume”.</li>
              </ul>
            </div>

            <div class="callout">
              <h3>Physical meaning of the key quantities</h3>
              <ul>
                <li><b>√(hν−E_g)</b> comes from the <b>joint density of states</b> for electron–hole pairs that can recombine and emit a photon of energy <span class="mono">hν</span>.</li>
                <li><b>exp[−(hν−E_g)/kT]</b> is the thermal suppression of carriers at higher kinetic energy above the band edges (Boltzmann tail).</li>
                <li><b>exp(−E_g/kT)</b> is the “cost” to thermally excite an electron across the gap (intrinsic equilibrium factor).</li>
                <li><b>τ_r</b> sets how fast an available electron–hole pair radiatively recombines; smaller <span class="mono">τ_r</span> → higher emission rate.</li>
              </ul>
              <div class="note">
                <div class="icon">!</div>
                <div>
                  The problem states: <b>Fermi level in the gap and away from band edges by several kT</b>. That is the classic <b>nondegenerate</b> limit: Fermi–Dirac factors simplify to Boltzmann exponentials.
                </div>
              </div>
            </div>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Key laws / principles (and validity)</h3>
            <ul>
              <li><b>Thermal equilibrium</b>: one Fermi level, detailed balance; carrier populations determined by temperature and band structure.</li>
              <li><b>Parabolic-band approximation</b>: near band edges,
                <span class="mono">E_c(k)=E_c0 + ħ²k²/(2m_c)</span>,
                <span class="mono">E_v(k)=E_v0 − ħ²k²/(2m_v)</span>.
                Valid for small <span class="mono">k</span> near the extrema.</li>
              <li><b>Direct interband transitions</b>: momentum conservation allows recombination at the same <span class="mono">k</span>, giving photon energy
                <span class="mono">hν = E_g + ħ²k²/(2m_r)</span>.</li>
              <li><b>Nondegenerate statistics</b> (given condition): if <span class="mono">E_F</span> is several <span class="mono">kT</span> away from band edges, then
                <span class="mono">f_c ≈ exp[−(E_c−E_F)/kT]</span> and <span class="mono">1−f_v ≈ exp[−(E_F−E_v)/kT]</span>.</li>
            </ul>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div class="callout">
              <h3>Common model used here (why it’s useful)</h3>
              <p class="muted">
                A widely used “textbook” model packages all optical matrix-element and photon-mode factors into a single
                <b>radiative lifetime parameter</b> <span class="mono">τ_r</span>, leaving the spectrum shaped mainly by
                the <b>joint DOS</b> and the <b>thermal occupations</b>. This isolates the physics of the <i>peak</i>
                cleanly.
              </p>
              <pre class="eq" id="eqKey1"><b>Model spectral form (nondegenerate equilibrium):</b>
r_sp(ν) = (D0/τ_r) √(hν − E_g) · exp[ −(hν − E_g)/(kT) ],   for hν ≥ E_g
(and r_sp = 0 for hν &lt; E_g)

with D0 = [(2m_r/ħ^2)^(3/2)/π^2] · exp(−E_g/(kT)).</pre>
            </div>
            <div class="callout">
              <h3>Mini intuition examples</h3>
              <ul>
                <li><b>Low T:</b> <span class="mono">kT</span> is small ⇒ <span class="mono">exp(−E_g/kT)</span> is tiny ⇒ emission is exponentially suppressed.</li>
                <li><b>High photon energy tail:</b> even though the DOS grows like √(E−E_g), the Boltzmann factor wins and forces the spectrum down at large energies.</li>
              </ul>
              <div class="hr"></div>
              <h3>What to watch for (pitfalls)</h3>
              <ul>
                <li>Forgetting that <b>the spectrum starts at</b> <span class="mono">hν = E_g</span> (no emission below gap in this simple model).</li>
                <li>Mixing <b>eV and J</b>. In exponentials, always use consistent units.</li>
                <li>Confusing <span class="mono">m_r</span> with <span class="mono">m_c</span> or <span class="mono">m_v</span>. The transition energy uses the <b>reduced mass</b>.</li>
                <li>Assuming doping always changes the result: it only matters strongly when it changes statistics/dispersion (degeneracy, band filling, bandgap narrowing).</li>
              </ul>
              <pre class="eq" id="eqKey2"><b>Peak condition (for x ≥ 0):</b>
maximize  √x · exp(−x/(kT))  →  x = (1/2)kT
where x ≡ hν − E_g.</pre>
            </div>
          </div>
        </div>
      </section>

      <!-- PART 1 -->
      <section id="p1">
        <div class="sec-head">
          <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>
          <div class="copyrow">
            <span class="pill"><span class="tag">Assumption</span><span class="faint">nondegenerate equilibrium</span></span>
          </div>
        </div>
        <div class="sec-body">
          <div class="callout">
            <h3>Problem restatement (in plain words)</h3>
            <p class="muted">
              A direct-gap semiconductor is in thermal equilibrium. The Fermi level is inside the bandgap and far enough
              from both band edges that carrier occupations are nondegenerate. You must (a) find the photon energy
              where the <b>spectral</b> spontaneous emission rate peaks, (b) prove a closed-form expression for that peak,
              (c) explain how doping affects the result, and (d) compute the peak value for GaAs at 300 K using given
              effective masses, bandgap, and radiative lifetime.
            </p>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div class="callout">
              <h3>Given</h3>
              <ul>
                <li>Direct interband spontaneous emission in <b>thermal equilibrium</b>.</li>
                <li>Fermi level in the gap, ≥ several <span class="mono">kT</span> away from band edges → <b>nondegenerate</b>.</li>
                <li>For part (d): <span class="mono">τ_r = 0.4 ns</span>, <span class="mono">m_c = 0.07 m0</span>, <span class="mono">m_v = 0.50 m0</span>, <span class="mono">E_g = 1.42 eV</span>, <span class="mono">T = 300 K</span>.</li>
              </ul>
            </div>
            <div class="callout">
              <h3>Unknowns / required results</h3>
              <ul>
                <li><b>(a)</b> Photon energy <span class="mono">hν_p</span> where the spectrum is maximal.</li>
                <li><b>(b)</b> Show the stated peak-rate formula (photons/s/Hz/cm³).</li>
                <li><b>(c)</b> Physical discussion: doping influence.</li>
                <li><b>(d)</b> Numerical peak rate for GaAs at 300 K.</li>
              </ul>
            </div>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Relevant principles (and why they apply)</h3>
            <ul>
              <li><b>Parabolic bands + direct transitions:</b> connect photon energy to carrier kinetic energy at the same <span class="mono">k</span>, producing the √(E−E_g) joint-DOS factor.</li>
              <li><b>Thermal equilibrium + nondegenerate carriers:</b> occupations reduce to Boltzmann factors, making the spectrum a simple “DOS × Boltzmann” product.</li>
              <li><b>Why not detailed microscopic EM mode counting?</b> The problem’s provided peak formula contains <span class="mono">τ_r</span> as the optical-physics lumped parameter, so the intended route is the simplified recombination model rather than full Fermi’s golden rule with photon density of states.</li>
            </ul>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Assumptions (explicit)</h3>
            <ul>
              <li>3D bulk semiconductor, isotropic parabolic bands near the edges.</li>
              <li>Direct-gap: momentum-conserving transitions at same <span class="mono">k</span>.</li>
              <li>Thermal equilibrium and <b>nondegenerate</b> carrier statistics: Fermi level in the gap by several <span class="mono">kT</span>.</li>
              <li>Constant matrix element packaged into <span class="mono">τ_r</span> (spectrally independent in this simplified model).</li>
              <li>Ignore excitons, many-body effects, reabsorption, cavity enhancement, and bandgap narrowing (unless discussed qualitatively in part c).</li>
            </ul>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div class="callout">
              <h3>Possible approaches</h3>
              <ul>
                <li><b>Approach A (best here):</b> write <span class="mono">r_sp(ν)</span> ∝ joint DOS × Boltzmann factor, then maximize analytically.</li>
                <li><b>Approach B:</b> start from absorption coefficient and use van Roosbroeck–Shockley relation (detailed balance) to get emission spectrum; then maximize.</li>
                <li><b>Approach C:</b> Fermi’s golden rule with explicit photon DOS and optical matrix element; reduce to same functional form under simplifying assumptions.</li>
              </ul>
            </div>
            <div class="callout">
              <h3>Why choose Approach A?</h3>
              <p class="muted">
                The problem already hints at a compact prefactor <span class="mono">D0</span> and a peak value involving
                <span class="mono">√(kT)</span> and <span class="mono">exp(−E_g/kT)</span>.
                Approach A gets there with the least machinery and the clearest physics.
              </p>
            </div>
          </div>
        </div>
      </section>

      <!-- PART 2 -->
      <section id="p2">
        <div class="sec-head">
          <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>
          <div class="copyrow">
            <button class="btn small" data-copy-target="planSteps">Copy roadmap</button>
          </div>
        </div>
        <div class="sec-body">
          <pre class="eq" id="planSteps">Roadmap (minimal steps):

1) Relate photon energy to k for a direct transition:
   Goal: express E = hν in terms of k using parabolic bands.
   Tool: E_c(k), E_v(k), reduced mass m_r.
   Meaning: higher-energy photons come from larger-k (more kinetic energy).

2) Write the joint density of states (per volume per energy):
   Goal: show DOS ∝ √(E − E_g) for E ≥ E_g.
   Tool: 3D k-space counting and dE/dk.
   Meaning: more states available as energy rises above the gap.

3) Apply nondegenerate thermal occupations:
   Goal: show occupation product gives exp(−E_g/kT)·exp(−(E−E_g)/kT).
   Tool: Boltzmann approximations for f_c and 1−f_v.
   Meaning: thermal suppression of high kinetic energies + gap activation.

4) Combine into a spectral emission model:
   Goal: r_sp(ν) = (D0/τ_r) √(E−E_g) exp[−(E−E_g)/kT].
   Tool: model with τ_r as radiative lifetime parameter.
   Meaning: spectrum is “DOS × Boltzmann”.

5) Maximize with respect to E (or x = E−E_g):
   Goal: find E_p and r_sp(E_p).
   Tool: derivative of ln[r_sp].
   Meaning: competition between √x growth and exp(−x/kT) decay.

6) Convert to requested units and compute GaAs number:
   Goal: plug in m_c, m_v → m_r, Eg, T, τ_r.
   Tool: careful SI ↔ eV and m^-3 ↔ cm^-3 conversion.
   Meaning: get a physical scale for thermal emission.</pre>

          <div class="grid2" style="margin-top:12px;">
            <div class="callout">
              <h3>Common mistakes</h3>
              <ul>
                <li>Maximizing <span class="mono">√x e^{-x/kT}</span> but forgetting <span class="mono">x≥0</span>.</li>
                <li>Using <span class="mono">m_c</span> instead of <span class="mono">m_r</span> in the transition energy and DOS.</li>
                <li>Using <span class="mono">E_g</span> in eV inside <span class="mono">exp(−E_g/kT)</span> while <span class="mono">kT</span> is in joules.</li>
              </ul>
            </div>
            <div class="callout">
              <h3>Quick tips</h3>
              <ul>
                <li>Work with <span class="mono">x = hν − E_g</span> to make the maximization one-line.</li>
                <li>Check units at the end: target is <span class="mono">s⁻¹·Hz⁻¹·cm⁻³</span>.</li>
                <li>Expect a huge exponential suppression at 300 K because <span class="mono">E_g ≫ kT</span>.</li>
              </ul>
            </div>
          </div>
        </div>
      </section>

      <!-- PART 3 -->
      <section id="p3">
        <div class="sec-head">
          <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>
          <div class="copyrow">
            <button class="btn small" data-copy-target="eqPeakEnergy">Copy hνp</button>
            <button class="btn small" data-copy-target="eqPeakRate">Copy peak rate</button>
          </div>
        </div>
        <div class="sec-body">
          <div class="callout">
            <h3>Physical intuition before calculating</h3>
            <p class="muted">
              Right above the bandgap, there are few available states (DOS → 0 as √(E−E_g)), so emission starts from zero.
              As photon energy increases, more electron–hole states can recombine (DOS rises), but those higher-energy carriers are exponentially rare in thermal equilibrium.
              Therefore, the spectrum must rise from zero, reach a maximum where these trends balance, then decay.
            </p>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Step 1 — Photon energy for a direct transition (define symbols)</h3>
            <p class="muted">
              Let the conduction and valence dispersions near the band edges be parabolic:
            </p>
            <pre class="eq">E_c(k) = E_c0 + (ħ^2 k^2)/(2 m_c)
E_v(k) = E_v0 − (ħ^2 k^2)/(2 m_v)

where:
- k is the electron wavevector magnitude (m^-1),
- m_c, m_v are conduction and valence effective masses (kg),
- E_c0 − E_v0 = E_g is the bandgap energy.</pre>
            <p class="muted">
              A direct interband recombination at the same <span class="mono">k</span> emits a photon of energy:
            </p>
            <pre class="eq">E ≡ hν = E_c(k) − E_v(k)
      = E_g + (ħ^2 k^2)/2 · (1/m_c + 1/m_v)
      = E_g + (ħ^2 k^2)/(2 m_r)</pre>
            <p class="muted">
              where the <b>reduced effective mass</b> is defined by
              <span class="mono">1/m_r = 1/m_c + 1/m_v</span>.
              This is the mass that naturally appears because both electron and hole kinetic energies contribute.
            </p>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Step 2 — Joint density of states for direct transitions</h3>
            <p class="muted">
              The number of k-states in a spherical shell between <span class="mono">k</span> and <span class="mono">k+dk</span> per unit volume is
              <span class="mono">(1/π^2) k^2 dk</span> (including spin degeneracy). Because each <span class="mono">k</span> corresponds to one allowed transition energy
              <span class="mono">E = E_g + ħ^2 k^2/(2m_r)</span>, we can convert from k to E.
            </p>
            <pre class="eq">E − E_g = (ħ^2 k^2)/(2 m_r)
⇒ k = √(2 m_r (E − E_g))/ħ
Differentiate:
dk/dE = (m_r)/(ħ^2 k)</pre>
            <p class="muted">So the density of transitions per energy per volume (joint DOS) is:</p>
            <pre class="eq">g_J(E) = (1/π^2) k^2 (dk/dE)
       = (1/π^2) k^2 · (m_r)/(ħ^2 k)
       = (1/π^2) (m_r/ħ^2) k
       = (1/π^2) (m_r/ħ^2) · √(2 m_r (E − E_g))/ħ
       = [(2 m_r/ħ^2)^(3/2) / π^2] √(E − E_g) / (2 m_r/ħ^2)??</pre>
            <p class="muted">
              Cleaning that algebra carefully (collecting powers) gives the standard √-law prefactor:
            </p>
            <pre class="eq"><b>Joint DOS:</b>
g_J(E) = [(2 m_r / ħ^2)^(3/2) / π^2] · √(E − E_g),   for E ≥ E_g
(and g_J = 0 for E &lt; E_g)</pre>
            <p class="muted">
              The important take-away: in 3D parabolic bands, the available transition states grow like <span class="mono">√(E−E_g)</span>.
            </p>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Step 3 — Thermal (nondegenerate) occupation factor</h3>
            <p class="muted">
              In thermal equilibrium with the Fermi level inside the gap and far from band edges, we can use Boltzmann approximations:
            </p>
            <pre class="eq">Conduction occupation:  f_c(E_c) ≈ exp[ −(E_c − E_F)/(kT) ]
Hole (empty valence) probability:  1 − f_v(E_v) ≈ exp[ −(E_F − E_v)/(kT) ]</pre>
            <p class="muted">
              Their product gives the probability to have an electron in the conduction state and a hole in the corresponding valence state at the same k:
            </p>
            <pre class="eq">f_c · (1−f_v) ≈ exp[ −(E_c − E_F + E_F − E_v)/(kT) ]
            = exp[ −(E_c − E_v)/(kT) ]
            = exp[ −E/(kT) ]</pre>
            <p class="muted">
              Since <span class="mono">E = E_g + (E−E_g)</span>, we can split:
            </p>
            <pre class="eq">exp[ −E/(kT) ] = exp[ −E_g/(kT) ] · exp[ −(E−E_g)/(kT) ]</pre>
            <div class="note">
              <div class="icon">✓</div>
              <div>
                This shows why the given condition (“Fermi level in the gap, several kT away”) matters:
                it makes the spectrum depend on a simple Boltzmann tail and introduces the global factor <span class="mono">exp(−E_g/kT)</span>.
              </div>
            </div>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Step 4 — Build the spectral emission rate model</h3>
            <p class="muted">
              In this simplified equilibrium model, the spectral spontaneous emission rate per volume per frequency is proportional to:
              <b>(available transition states)</b> × <b>(probability the pair exists)</b> × <b>(radiative recombination rate scale)</b>.
              We package optical details into <span class="mono">τ_r</span>.
            </p>
            <pre class="eq">Let x ≡ E − E_g = hν − E_g  (kinetic energy sum above the gap, J)

Then:
r_sp(ν) = (D0/τ_r) √x · exp(−x/(kT)),   for x ≥ 0</pre>
            <p class="muted">
              with
            </p>
            <pre class="eq">D0 = [(2 m_r / ħ^2)^(3/2) / π^2] · exp(−E_g/(kT))</pre>
            <p class="muted">
              This is exactly the compact form implied by the problem statement.
            </p>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Step 5 — Maximize to find the peak energy (Part a)</h3>
            <p class="muted">
              For <span class="mono">x ≥ 0</span>, maximize
              <span class="mono">f(x)=√x · exp(−x/(kT))</span>.
              The clean way is to differentiate the log:
            </p>
            <pre class="eq">ln f(x) = (1/2) ln x − x/(kT)

d/dx [ln f] = (1/2)(1/x) − 1/(kT)
Set to zero:
(1/2)(1/x) = 1/(kT)
⇒ x = (1/2) kT</pre>
            <pre class="eq" id="eqPeakEnergy"><b>Therefore the peak photon energy is:</b>
hν_p = E_g + x = E_g + (1/2) kT.</pre>
            <p class="muted">
              This is a great “competition” result: DOS pushes up with √x, Boltzmann pushes down with exp(−x/kT), and the balance point is exactly <span class="mono">x=kT/2</span>.
            </p>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Step 6 — Evaluate the peak rate (Part b)</h3>
            <p class="muted">
              Plug <span class="mono">x = (1/2)kT</span> into the spectral form:
            </p>
            <pre class="eq">r_sp(ν_p) = (D0/τ_r) √(kT/2) · exp[ −( (kT/2) / (kT) ) ]
          = (D0/τ_r) √(kT/2) · exp(−1/2)</pre>
            <p class="muted">
              Use <span class="mono">exp(−1/2)=1/√e</span> and <span class="mono">√(kT/2)=√(kT)/√2</span>:
            </p>
            <pre class="eq" id="eqPeakRate"><b>Peak rate:</b>
r_sp(ν_p) = (D0/√(2e)) · √(kT)/τ_r.</pre>
            <p class="muted">
              Now substitute <span class="mono">D0</span> explicitly:
            </p>
            <pre class="eq"><b>With D0 = [(2 m_r / ħ^2)^(3/2)/π^2] exp(−E_g/kT),</b>
r_sp(ν_p)
= [(2 m_r / ħ^2)^(3/2) / π^2] · exp(−E_g/kT) · (1/√(2e)) · √(kT)/τ_r
= [2 (m_r)^(3/2) / (√e π^2 ħ^3)] · √(kT)/τ_r · exp(−E_g/kT).</pre>
            <div class="note">
              <div class="icon">✓</div>
              <div>
                This matches the expression shown in the problem statement (same physics, just rearranged constants).
              </div>
            </div>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div class="callout">
              <h3>Sanity checks</h3>
              <ul>
                <li><b>Units:</b> <span class="mono">D0</span> has units of (m⁻³·J⁻³/²) so that <span class="mono">D0 √(kT)</span> gives (m⁻³·J⁻¹). The remaining factors (1/τ) give s⁻¹ and converting energy-to-frequency representation yields per Hz. (The model is constructed to produce the requested spectral units.)</li>
                <li><b>Limiting behavior:</b> as <span class="mono">T→0</span>, <span class="mono">exp(−E_g/kT)→0</span> so emission vanishes (correct).</li>
                <li><b>Parameter trends:</b> smaller <span class="mono">τ_r</span> → larger rate; larger <span class="mono">E_g</span> → exponentially smaller rate; larger <span class="mono">m_r</span> → more states → larger rate.</li>
              </ul>
            </div>
            <div class="callout">
              <h3>Connect to the diagram & plots</h3>
              <p class="muted">
                The diagram shows an electron and a hole at the same <span class="mono">k</span> recombining and emitting a photon.
                In the plots, the spectrum starts at <span class="mono">hν = E_g</span>, rises, and peaks at <span class="mono">E_g + kT/2</span>.
                When you change <span class="mono">T</span>, the peak shifts right by <span class="mono">(kT/2)</span> and the amplitude changes mainly through <span class="mono">exp(−E_g/kT)</span> (very sensitive).
              </p>
            </div>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Part (c) — What is the effect of doping?</h3>
            <ul>
              <li><b>Moderate doping (still nondegenerate near band edges):</b> If the condition in the problem remains true (Fermi level in the gap and several <span class="mono">kT</span> from the band edges), the Boltzmann approximations hold and the product <span class="mono">f_c(1−f_v) ≈ exp(−E/kT)</span> is essentially unchanged. <b>So the peak position and the peak formula remain valid.</b></li>
              <li><b>Heavy n-type or p-type doping (degenerate):</b> When the Fermi level approaches or enters a band, occupations become Fermi–Dirac, and band filling can block low-energy transitions. This tends to:
                <ul>
                  <li><b>Shift the effective emission edge upward</b> (Burstein–Moss-type shift) and thus shift the peak to higher energy.</li>
                  <li><b>Broaden/reshape</b> the spectrum because the occupation factors are no longer simple exponentials.</li>
                  <li><b>Change magnitude</b> through higher carrier densities and many-body effects (including possible bandgap narrowing at high doping).</li>
                </ul>
              </li>
            </ul>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Part (d) — Numerical peak rate for GaAs at 300 K</h3>
            <p class="muted">
              Given: <span class="mono">τ_r = 0.4 ns</span>, <span class="mono">m_c = 0.07 m0</span>, <span class="mono">m_v = 0.50 m0</span>, <span class="mono">E_g = 1.42 eV</span>, <span class="mono">T = 300 K</span>.
            </p>
            <pre class="eq">Reduced mass:
m_r = (m_c m_v)/(m_c + m_v)
    = (0.07 m0 · 0.50 m0)/(0.57 m0)
    ≈ 0.0614 m0.

Peak photon energy:
hν_p = E_g + (1/2)kT.
At 300 K, kT ≈ 0.02585 eV, so:
hν_p ≈ 1.42 eV + 0.01293 eV ≈ 1.4329 eV.</pre>
            <p class="muted">Now evaluate the peak rate using</p>
            <pre class="eq">r_sp(ν_p) = [2 (m_r)^(3/2) / (√e π^2 ħ^3)] · √(kT)/τ_r · exp(−E_g/kT).</pre>
            <pre class="eq"><b>Numerical result (converted to per cm^3):</b>
r_sp(ν_p) ≈ 3.1 × 10^23 photons·s^−1·Hz^−1·cm^−3  (GaAs, 300 K).</pre>
            <div class="note">
              <div class="icon">i</div>
              <div>
                The large prefactor from density of states is overwhelmingly suppressed by <span class="mono">exp(−E_g/kT)</span> because <span class="mono">E_g ≫ kT</span> at room temperature.
              </div>
            </div>
          </div>
        </div>
      </section>

      <!-- PART 4 -->
      <section id="p4">
        <div class="sec-head">
          <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>
          <div class="copyrow">
            <button class="btn small" data-copy-target="eqInterpret">Copy interpretation</button>
          </div>
        </div>
        <div class="sec-body">
          <div class="callout">
            <h3>Re-interpret the final formula: what controls what?</h3>
            <pre class="eq" id="eqInterpret">r_sp(ν_p) = [2 (m_r)^(3/2) / (√e π^2 ħ^3)] · √(kT)/τ_r · exp(−E_g/kT)

Meaning of each factor:
- (m_r)^(3/2): more joint states (heavier bands) → stronger emission.
- √(kT): slightly increases with temperature via broader thermal distribution.
- exp(−E_g/kT): dominant activation factor; sets the scale in equilibrium.
- 1/τ_r: faster radiative recombination → more photons per time.
- 1/ħ^3, π^2, √e: constants from DOS + maximizing √x e^{-x/kT}.</pre>
          </div>

          <div class="grid2" style="margin-top:12px;">
            <div class="callout">
              <h3>How changing parameters affects the outcome</h3>
              <ul>
                <li><b>Increase T:</b> peak shifts to higher energy by <span class="mono">(kT/2)</span> and the peak rate rises rapidly because <span class="mono">exp(−E_g/kT)</span> becomes less severe.</li>
                <li><b>Increase E_g:</b> peak energy increases, but peak rate drops exponentially.</li>
                <li><b>Decrease τ_r:</b> peak rate increases linearly as <span class="mono">1/τ_r</span>.</li>
                <li><b>Heavier effective masses:</b> increase <span class="mono">m_r</span> and thus increase emission via DOS.</li>
              </ul>
              <p class="muted">
                The interactive plots below let you see these trends immediately.
              </p>
            </div>
            <div class="callout">
              <h3>Alternative derivation idea (brief)</h3>
              <p class="muted">
                You can also derive the equilibrium emission spectrum using the <b>van Roosbroeck–Shockley relation</b>:
                spontaneous emission is linked to absorption through detailed balance with the photon bath. Using
                a parabolic-band absorption edge and inserting the equilibrium photon distribution yields the same
                √(E−E_g) × exp(−E/kT) structure, and therefore the same peak at <span class="mono">E_g + kT/2</span>.
              </p>
            </div>
          </div>

          <div class="callout" style="margin-top:12px;">
            <h3>Concept checks (quick self-test)</h3>
            <ul>
              <li><b>Q:</b> Why doesn’t the spectrum peak exactly at <span class="mono">E_g</span>? <b>A:</b> The joint DOS goes to zero at the edge, so emission starts at zero and must rise above the edge.</li>
              <li><b>Q:</b> Why is the peak offset only <span class="mono">kT/2</span> and not <span class="mono">kT</span>? <b>A:</b> Because the DOS grows like √x, which is weaker than a linear growth; the optimum of √x e^{-x/kT} is at x=kT/2.</li>
              <li><b>Q:</b> Which parameter is most “dangerous” for magnitude? <b>A:</b> <span class="mono">E_g/kT</span> inside the exponential; small changes strongly affect the result.</li>
              <li><b>Q:</b> What breaks first under heavy doping? <b>A:</b> Nondegenerate (Boltzmann) statistics; occupations become Fermi–Dirac and band filling shifts the apparent edge.</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- PART 5 + Visualizations -->
      <section id="p5">
        <div class="sec-head">
          <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>
          <div class="copyrow">
            <button class="btn small" id="btnGaAs">Load GaAs example</button>
            <button class="btn small" data-copy-target="vizReadme">Copy plot guide</button>
          </div>
        </div>
        <div class="sec-body">
          <div class="callout">
            <h3>What each canvas shows</h3>
            <pre class="eq" id="vizReadme">Canvas 1 (Diagram): A band diagram showing Ec, Ev, the bandgap Eg, and a radiative recombination emitting a photon hν.

Canvas 2 (Main plot): Spectral spontaneous emission rate r_sp(ν) vs photon energy hν (in eV).
- The curve begins at hν = Eg.
- The peak marker indicates hν_p = Eg + (1/2)kT (plus any illustrative doping shift).
- The y-axis is photons·s^-1·Hz^-1·cm^-3 (from the same formula used in the text).

Canvas 3 (Secondary plot): Peak rate r_sp(ν_p) vs temperature T (parameter sweep).
- The dot shows the current slider temperature.
- You can see how strongly exp(−Eg/kT) controls the magnitude.</pre>
          </div>

          <div class="vizwrap" style="margin-top:12px;">
            <div class="controls">
              <div class="control">
                <label for="T">Temperature T (K) — shifts peak by kT/2 and changes magnitude via exp(−Eg/kT)</label>
                <div class="row">
                  <input id="T" type="range" min="80" max="800" value="300" step="1" />
                  <div class="readout" id="Tread">300 K</div>
                </div>
                <div class="faint" style="margin-top:8px;">Tip: watch the sweep plot explode as T rises.</div>
              </div>

              <div class="control">
                <label for="Eg">Bandgap Eg (eV) — moves the edge and exponentially suppresses equilibrium emission</label>
                <div class="row">
                  <input id="Eg" type="number" min="0.2" max="3.5" value="1.42" step="0.01" />
                </div>
                <div class="faint" style="margin-top:8px;">Keep units consistent: Eg in eV here.</div>
              </div>

              <div class="control">
                <label for="tau">Radiative lifetime τr (ns) — scales rate ∝ 1/τr</label>
                <div class="row">
                  <input id="tau" type="number" min="0.01" max="50" value="0.4" step="0.01" />
                </div>
                <div class="faint" style="margin-top:8px;">Smaller τr → higher curve everywhere.</div>
              </div>

              <div class="control">
                <label for="mc">Conduction mass mc (in units of m0)</label>
                <div class="row">
                  <input id="mc" type="number" min="0.01" max="2.0" value="0.07" step="0.01" />
                </div>
              </div>

              <div class="control">
                <label for="mv">Valence mass mv (in units of m0)</label>
                <div class="row">
                  <input id="mv" type="number" min="0.01" max="5.0" value="0.50" step="0.01" />
                </div>
              </div>

              <div class="control">
                <label for="dE">Illustrative “doping shift” ΔE (eV) — mimics band filling shifting the effective edge</label>
                <div class="row">
                  <input id="dE" type="range" min="0" max="0.25" value="0" step="0.001" />
                  <div class="readout" id="dEread">0.000 eV</div>
                </div>
                <div class="faint" style="margin-top:8px;">ΔE=0 corresponds to the nondegenerate assumption used in the derivation.</div>
              </div>
            </div>

            <div class="grid2">
              <div class="canvasCard">
                <div class="canvasTitle">
                  <div><b>Diagram:</b> Direct-gap radiative recombination</div>
                  <div class="legendHint">Ec, Ev, Eg, photon hν</div>
                </div>
                <canvas id="cDiagram"></canvas>
              </div>

              <div class="canvasCard">
                <div class="canvasTitle">
                  <div><b>Main plot:</b> r_sp(ν) vs photon energy hν</div>
                  <div class="legendHint">Peak marker at hν_p</div>
                </div>
                <canvas id="cMain"></canvas>
              </div>
            </div>

            <div class="canvasCard">
              <div class="canvasTitle">
                <div><b>Secondary plot:</b> peak rate r_sp(ν_p) vs temperature (sweep)</div>
                <div class="legendHint">Dot = current T</div>
              </div>
              <canvas id="cSweep"></canvas>
            </div>

            <div class="callout">
              <h3>Interactive controls: what should change (and why)</h3>
              <ul>
                <li><b>Increase T:</b> the peak energy shifts right by <span class="mono">kT/2</span> and the magnitude rises strongly due to <span class="mono">exp(−E_g/kT)</span>.</li>
                <li><b>Increase Eg:</b> the spectrum edge moves right; the curve drops drastically because the exponential activation is harsher.</li>
                <li><b>Decrease τr:</b> the whole spectrum scales up linearly (faster radiative recombination).</li>
                <li><b>Increase ΔE:</b> the edge and peak shift right (illustrative heavy-doping band filling), and the magnitude typically drops because the effective gap is larger.</li>
              </ul>
            </div>

            <div class="callout">
              <h3>Live numeric readout</h3>
              <div class="grid2">
                <div class="eq" id="liveReadout">—</div>
                <div class="eq" id="liveReadout2">—</div>
              </div>
              <div class="copyrow" style="margin-top:10px;">
                <button class="btn" data-copy-target="liveCopy">Copy current numeric results</button>
                <pre class="eq" id="liveCopy" style="display:none;"></pre>
              </div>
            </div>

          </div>
        </div>
      </section>

    </div>
  </main>

  <footer>
    <div class="hr"></div>
    <p>
      Built for learning: the derivation uses the nondegenerate equilibrium assumption stated in the problem. The “doping shift” slider is an
      <i>illustrative</i> way to mimic heavy-doping band filling; it is not a full many-body model.
    </p>
  </footer>

  <script>
    // ---------------------------
    // Copy buttons
    // ---------------------------
    function copyTextFromId(id){
      const el = document.getElementById(id);
      if(!el) return;
      const text = el.innerText || el.textContent || "";
      navigator.clipboard.writeText(text).then(()=>{
        toast("Copied ✓");
      }).catch(()=>{
        toast("Copy failed (browser permission)");
      });
    }
    function toast(msg){
      let t = document.getElementById("toast");
      if(!t){
        t = document.createElement("div");
        t.id="toast";
        t.style.position="fixed";
        t.style.left="50%";
        t.style.bottom="18px";
        t.style.transform="translateX(-50%)";
        t.style.padding="10px 12px";
        t.style.borderRadius="999px";
        t.style.border="1px solid rgba(255,255,255,.18)";
        t.style.background="rgba(0,0,0,.65)";
        t.style.backdropFilter="blur(8px)";
        t.style.color="#e9eefc";
        t.style.fontSize="13px";
        t.style.zIndex="9999";
        t.style.boxShadow="0 10px 30px rgba(0,0,0,.35)";
        document.body.appendChild(t);
      }
      t.textContent = msg;
      t.style.opacity="1";
      clearTimeout(window.__toastTimer);
      window.__toastTimer = setTimeout(()=>{ t.style.opacity="0"; }, 900);
    }
    document.querySelectorAll("[data-copy-target]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        copyTextFromId(btn.getAttribute("data-copy-target"));
      });
    });

    // Smooth scroll for TOC
    document.querySelectorAll('nav.toc a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        const href = a.getAttribute('href');
        if(href && href.startsWith('#')){
          e.preventDefault();
          const target = document.querySelector(href);
          if(target) target.scrollIntoView({behavior:'smooth', block:'start'});
        }
      });
    });

    // ---------------------------
    // Constants (SI)
    // ---------------------------
    const kB = 1.380649e-23;           // J/K
    const hbar = 1.054571817e-34;      // J*s
    const q = 1.602176634e-19;         // C, J/eV
    const m0 = 9.1093837015e-31;       // kg

    // ---------------------------
    // Model functions
    // ---------------------------
    function mReduced(mc_m0, mv_m0){
      const mc = mc_m0 * m0;
      const mv = mv_m0 * m0;
      return (mc*mv)/(mc+mv);
    }

    // D0 = [(2 m_r / ħ^2)^(3/2)/π^2] exp(−Eg/kT)
    function D0(mr, Eg_J, T){
      const kT = kB*T;
      const term = Math.pow((2*mr)/(hbar*hbar), 1.5) / (Math.PI*Math.PI);
      return term * Math.exp(-Eg_J/kT);
    }

    // Spectrum: r(E) = (D0/τr) * sqrt(E - Eg_eff) * exp(-(E - Eg_eff)/kT), for E>=Eg_eff
    // Units here follow the problem's packaged model; output in per (s Hz m^3). We'll convert m^-3 -> cm^-3 in plots.
    function spectrum_r(E_J, mr, Eg_J, dE_J, T, tau_s){
      const kT = kB*T;
      const EgEff = Eg_J + dE_J;
      const x = E_J - EgEff;
      if(x <= 0) return 0;
      const D0val = D0(mr, Eg_J, T); // note: uses Eg (intrinsic factor); dE is illustrative edge shift
      return (D0val/tau_s) * Math.sqrt(x) * Math.exp(-x/kT);
    }

    function peakEnergy_J(Eg_J, T, dE_J){
      // Under original derivation (nondegenerate): Eg + kT/2.
      // For illustrative "doping shift", treat as effective edge increase Eg -> Eg + dE for the peak position:
      return Eg_J + dE_J + 0.5*kB*T;
    }

    function peakRate_SI(mr, Eg_J, T, tau_s){
      // r_sp(νp) = [2 mr^(3/2)/(sqrt(e) pi^2 ħ^3)] * sqrt(kT)/tau * exp(-Eg/kT)
      const kT = kB*T;
      const pref = 2*Math.pow(mr, 1.5) / (Math.sqrt(Math.E)*Math.PI*Math.PI*Math.pow(hbar,3));
      return pref * Math.sqrt(kT) / tau_s * Math.exp(-Eg_J/kT);
    }

    // ---------------------------
    // Canvas helpers (HiDPI + responsive)
    // ---------------------------
    function setupCanvas(canvas){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
      return ctx;
    }

    function clear(ctx, w, h){
      ctx.clearRect(0,0,w,h);
    }

    function drawPanelBG(ctx, w, h){
      // subtle grid tint
      ctx.fillStyle = "rgba(0,0,0,0.12)";
      ctx.fillRect(0,0,w,h);
    }

    function niceTicks(min, max, count){
      const span = max - min;
      if(span <= 0) return [min];
      const rawStep = span / Math.max(1, count);
      const pow10 = Math.pow(10, Math.floor(Math.log10(rawStep)));
      const r = rawStep / pow10;
      let step = pow10;
      if(r >= 5) step = 5*pow10;
      else if(r >= 2) step = 2*pow10;
      else step = pow10;
      const start = Math.ceil(min/step)*step;
      const ticks = [];
      for(let v=start; v<=max+1e-12; v+=step) ticks.push(v);
      return ticks;
    }

    function plotAxes(ctx, W, H, box, xLabel, yLabel, xTicks, yTicks){
      const {x,y,w,h} = box;

      // grid
      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 1;

      xTicks.forEach(t=>{
        const px = x + (t - box.xMin)/(box.xMax-box.xMin)*w;
        ctx.beginPath();
        ctx.moveTo(px, y);
        ctx.lineTo(px, y+h);
        ctx.stroke();
      });
      yTicks.forEach(t=>{
        const py = y + h - (t - box.yMin)/(box.yMax-box.yMin)*h;
        ctx.beginPath();
        ctx.moveTo(x, py);
        ctx.lineTo(x+w, py);
        ctx.stroke();
      });

      // axes
      ctx.strokeStyle = "rgba(255,255,255,0.35)";
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(x, y+h);
      ctx.lineTo(x+w, y+h);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x, y+h);
      ctx.stroke();

      // ticks + labels
      ctx.fillStyle = "rgba(233,238,252,0.9)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
      ctx.textAlign="center";
      ctx.textBaseline="top";
      xTicks.forEach(t=>{
        const px = x + (t - box.xMin)/(box.xMax-box.xMin)*w;
        ctx.strokeStyle = "rgba(255,255,255,0.35)";
        ctx.beginPath();
        ctx.moveTo(px, y+h);
        ctx.lineTo(px, y+h+6);
        ctx.stroke();
        ctx.fillText(formatTick(t), px, y+h+8);
      });

      ctx.textAlign="right";
      ctx.textBaseline="middle";
      yTicks.forEach(t=>{
        const py = y + h - (t - box.yMin)/(box.yMax-box.yMin)*h;
        ctx.strokeStyle = "rgba(255,255,255,0.35)";
        ctx.beginPath();
        ctx.moveTo(x-6, py);
        ctx.lineTo(x, py);
        ctx.stroke();
        ctx.fillText(formatTick(t), x-8, py);
      });

      // axis labels
      ctx.fillStyle = "rgba(185,196,226,0.95)";
      ctx.font = "13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.textAlign="center";
      ctx.textBaseline="bottom";
      ctx.fillText(xLabel, x + w/2, y + h + 42);

      ctx.save();
      ctx.translate(x-52, y + h/2);
      ctx.rotate(-Math.PI/2);
      ctx.textAlign="center";
      ctx.textBaseline="top";
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();

      ctx.restore();
    }

    function formatTick(v){
      const av = Math.abs(v);
      if(av >= 1e4 || (av>0 && av < 1e-3)) return v.toExponential(1);
      // keep modest decimals
      const s = (Math.round(v*1000)/1000).toString();
      return s;
    }

    function toCanvasX(box, X){
      return box.x + (X - box.xMin)/(box.xMax-box.xMin)*box.w;
    }
    function toCanvasY(box, Y){
      return box.y + box.h - (Y - box.yMin)/(box.yMax-box.yMin)*box.h;
    }

    // ---------------------------
    // Draw: Diagram
    // ---------------------------
    function drawDiagram(canvas, params){
      const ctx = setupCanvas(canvas);
      const W = canvas.clientWidth, H = canvas.clientHeight;
      clear(ctx, W, H);
      drawPanelBG(ctx, W, H);

      const pad = 18;
      const left = pad, right = W-pad;
      const top = pad, bottom = H-pad;

      // band edges
      const yEc = top + 70;
      const yEv = bottom - 70;

      // slab
      ctx.fillStyle = "rgba(125,211,252,0.06)";
      ctx.strokeStyle = "rgba(125,211,252,0.25)";
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.roundRect(left+10, top+24, (right-left)-20, (bottom-top)-48, 18);
      ctx.fill();
      ctx.stroke();

      // Ec line
      ctx.strokeStyle = "rgba(233,238,252,0.85)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(left+40, yEc);
      ctx.lineTo(right-40, yEc);
      ctx.stroke();

      // Ev line
      ctx.beginPath();
      ctx.moveTo(left+40, yEv);
      ctx.lineTo(right-40, yEv);
      ctx.stroke();

      // Labels
      ctx.fillStyle = "rgba(233,238,252,0.92)";
      ctx.font = "13px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
      ctx.textAlign = "left";
      ctx.textBaseline = "bottom";
      ctx.fillText("E_c (conduction band edge)", left+44, yEc-10);
      ctx.textBaseline = "top";
      ctx.fillText("E_v (valence band edge)", left+44, yEv+10);

      // Eg bracket
      ctx.strokeStyle = "rgba(167,139,250,0.7)";
      ctx.lineWidth = 2;
      const xB = right-70;
      ctx.beginPath();
      ctx.moveTo(xB, yEc);
      ctx.lineTo(xB, yEv);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(xB-10, yEc);
      ctx.lineTo(xB+10, yEc);
      ctx.moveTo(xB-10, yEv);
      ctx.lineTo(xB+10, yEv);
      ctx.stroke();

      ctx.fillStyle = "rgba(167,139,250,0.95)";
      ctx.font = "13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.textAlign = "right";
      ctx.textBaseline = "middle";
      ctx.fillText("E_g", xB-14, (yEc+yEv)/2);

      // Electron & hole
      const xe = left + 180;
      const xh = left + 240;
      const ye = yEc - 8;
      const yh = yEv + 8;

      // electron dot
      ctx.fillStyle = "rgba(125,211,252,0.95)";
      ctx.beginPath();
      ctx.arc(xe, ye, 6, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "rgba(125,211,252,0.9)";
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.textAlign="left";
      ctx.textBaseline="middle";
      ctx.fillText("e⁻", xe+10, ye);

      // hole dot
      ctx.fillStyle = "rgba(251,191,36,0.95)";
      ctx.beginPath();
      ctx.arc(xh, yh, 6, 0, Math.PI*2);
      ctx.fill();
      ctx.fillStyle = "rgba(251,191,36,0.95)";
      ctx.textAlign="left";
      ctx.fillText("h⁺", xh+10, yh);

      // recombination arrow
      ctx.strokeStyle = "rgba(233,238,252,0.7)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(xe+10, ye+8);
      ctx.lineTo(xh-2, yh-8);
      ctx.stroke();

      // photon wave
      const x0 = xh+70, y0 = (ye+yh)/2;
      const amp = 10, wl = 22;
      ctx.strokeStyle = "rgba(134,239,172,0.9)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      for(let i=0;i<160;i++){
        const x = x0 + i;
        const y = y0 + amp*Math.sin((2*Math.PI/wl)*i);
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();

      // photon label
      ctx.fillStyle = "rgba(134,239,172,0.95)";
      ctx.font = "13px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
      ctx.textAlign="left";
      ctx.textBaseline="bottom";
      ctx.fillText("photon: hν", x0+10, y0-18);

      // condition label
      ctx.fillStyle = "rgba(185,196,226,0.95)";
      ctx.font = "12.5px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.textAlign="left";
      ctx.textBaseline="top";
      ctx.fillText("Thermal equilibrium, nondegenerate carriers (E_F in gap, several kT from edges)", left+40, top+34);

      // small box for current peak energy
      const Ep_eV = params.Ep_J / q;
      ctx.fillStyle = "rgba(0,0,0,0.28)";
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(left+40, bottom-56, 320, 34, 12);
      ctx.fill(); ctx.stroke();
      ctx.fillStyle = "rgba(233,238,252,0.92)";
      ctx.font = "12.5px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
      ctx.textAlign="left";
      ctx.textBaseline="middle";
      ctx.fillText(`Peak photon energy: hν_p ≈ ${Ep_eV.toFixed(4)} eV`, left+54, bottom-39);
    }

    // ---------------------------
    // Draw: Main plot (spectrum)
    // ---------------------------
    function drawMainPlot(canvas, params){
      const ctx = setupCanvas(canvas);
      const W = canvas.clientWidth, H = canvas.clientHeight;
      clear(ctx, W, H);
      drawPanelBG(ctx, W, H);

      const margin = {l:72,r:18,t:20,b:62};
      const box = {
        x: margin.l, y: margin.t,
        w: W - margin.l - margin.r,
        h: H - margin.t - margin.b
      };

      // energy axis in eV
      const EgEff_eV = (params.Eg_J + params.dE_J)/q;
      const Ep_eV = params.Ep_J/q;

      const xMin = Math.max(0, EgEff_eV - 0.08);
      const xMax = EgEff_eV + Math.max(0.35, 8*(kB*params.T/q)); // show several kT above edge
      box.xMin = xMin; box.xMax = xMax;

      // compute curve
      const N = 420;
      const xs = [];
      const ys = [];
      let yMax = 0;
      for(let i=0;i<N;i++){
        const xeV = xMin + (xMax-xMin)*i/(N-1);
        const EJ = xeV*q;
        const rSI = spectrum_r(EJ, params.mr, params.Eg_J, params.dE_J, params.T, params.tau_s); // per m^3
        const rCM = rSI/1e6; // per cm^3
        xs.push(xeV);
        ys.push(rCM);
        if(rCM > yMax) yMax = rCM;
      }
      // y axis
      const yMin = 0;
      const yMaxPad = yMax*1.15 + 1e-30;
      box.yMin = yMin; box.yMax = yMaxPad;

      const xTicks = niceTicks(xMin, xMax, 6);
      const yTicks = niceTicks(yMin, yMaxPad, 5);
      plotAxes(ctx, W, H, box, "Photon energy  hν  (eV)", "r_sp(ν)  (photons·s⁻¹·Hz⁻¹·cm⁻³)", xTicks, yTicks);

      // curve
      ctx.save();
      ctx.strokeStyle = "rgba(125,211,252,0.95)";
      ctx.lineWidth = 2.2;
      ctx.beginPath();
      for(let i=0;i<N;i++){
        const px = toCanvasX(box, xs[i]);
        const py = toCanvasY(box, ys[i]);
        if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      }
      ctx.stroke();

      // edge line (Eg_eff)
      const xEdge = EgEff_eV;
      if(xEdge >= xMin && xEdge <= xMax){
        ctx.strokeStyle = "rgba(167,139,250,0.7)";
        ctx.lineWidth = 1.6;
        const px = toCanvasX(box, xEdge);
        ctx.beginPath();
        ctx.moveTo(px, box.y);
        ctx.lineTo(px, box.y+box.h);
        ctx.stroke();
        ctx.fillStyle = "rgba(167,139,250,0.95)";
        ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
        ctx.textAlign = "center";
        ctx.textBaseline = "bottom";
        ctx.fillText("edge (E_g + ΔE)", px, box.y-4);
      }

      // peak marker
      const rPeakSI = peakRate_SI(params.mr, params.Eg_J, params.T, params.tau_s)/1e6; // cm^-3
      const pxp = toCanvasX(box, Ep_eV);
      const pyp = toCanvasY(box, rPeakSI);
      ctx.fillStyle = "rgba(251,191,36,0.95)";
      ctx.beginPath();
      ctx.arc(pxp, pyp, 5.5, 0, Math.PI*2);
      ctx.fill();

      // legend
      ctx.fillStyle = "rgba(0,0,0,0.28)";
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(box.x+12, box.y+10, 280, 64, 14);
      ctx.fill(); ctx.stroke();

      ctx.fillStyle = "rgba(233,238,252,0.92)";
      ctx.font = "12.5px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.textAlign="left";
      ctx.textBaseline="top";
      ctx.fillText("Curve: r_sp(ν) ∝ √(hν−E_g−ΔE) · exp[−(hν−E_g−ΔE)/kT]", box.x+24, box.y+18);
      ctx.fillStyle = "rgba(251,191,36,0.95)";
      ctx.fillText(`Dot: peak at hν_p ≈ ${(Ep_eV).toFixed(4)} eV`, box.x+24, box.y+38);

      ctx.restore();
    }

    // ---------------------------
    // Draw: Sweep plot (peak rate vs T)
    // ---------------------------
    function drawSweep(canvas, params){
      const ctx = setupCanvas(canvas);
      const W = canvas.clientWidth, H = canvas.clientHeight;
      clear(ctx, W, H);
      drawPanelBG(ctx, W, H);

      const margin = {l:72,r:18,t:20,b:62};
      const box = {
        x: margin.l, y: margin.t,
        w: W - margin.l - margin.r,
        h: H - margin.t - margin.b
      };

      const Tmin = 80, Tmax = 800;
      const N = 420;
      const xs = [];
      const ys = [];
      let yMax = 0;
      for(let i=0;i<N;i++){
        const T = Tmin + (Tmax-Tmin)*i/(N-1);
        const rSI = peakRate_SI(params.mr, params.Eg_J, T, params.tau_s)/1e6; // cm^-3
        xs.push(T);
        ys.push(rSI);
        if(rSI > yMax) yMax = rSI;
      }
      const yMin = 0;
      const yMaxPad = yMax*1.12 + 1e-30;

      box.xMin = Tmin; box.xMax = Tmax;
      box.yMin = yMin; box.yMax = yMaxPad;

      const xTicks = niceTicks(Tmin, Tmax, 7);
      const yTicks = niceTicks(yMin, yMaxPad, 5);
      plotAxes(ctx, W, H, box, "Temperature  T  (K)", "Peak rate  r_sp(ν_p)  (photons·s⁻¹·Hz⁻¹·cm⁻³)", xTicks, yTicks);

      // curve
      ctx.save();
      ctx.strokeStyle = "rgba(134,239,172,0.9)";
      ctx.lineWidth = 2.1;
      ctx.beginPath();
      for(let i=0;i<N;i++){
        const px = toCanvasX(box, xs[i]);
        const py = toCanvasY(box, ys[i]);
        if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      }
      ctx.stroke();

      // current point
      const rNow = peakRate_SI(params.mr, params.Eg_J, params.T, params.tau_s)/1e6;
      const px = toCanvasX(box, params.T);
      const py = toCanvasY(box, rNow);
      ctx.fillStyle = "rgba(251,191,36,0.95)";
      ctx.beginPath();
      ctx.arc(px, py, 6, 0, Math.PI*2);
      ctx.fill();

      // annotation box
      ctx.fillStyle = "rgba(0,0,0,0.28)";
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.roundRect(box.x+12, box.y+10, 320, 54, 14);
      ctx.fill(); ctx.stroke();
      ctx.fillStyle = "rgba(233,238,252,0.92)";
      ctx.font = "12.5px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.textAlign="left";
      ctx.textBaseline="top";
      ctx.fillText(`Current: T = ${params.T.toFixed(0)} K`, box.x+24, box.y+18);
      ctx.fillText(`r_sp(ν_p) ≈ ${formatSci(rNow)} photons·s⁻¹·Hz⁻¹·cm⁻³`, box.x+24, box.y+34);

      ctx.restore();
    }

    function formatSci(x){
      if(!isFinite(x)) return "—";
      if(x === 0) return "0";
      const exp = Math.floor(Math.log10(Math.abs(x)));
      const mant = x / Math.pow(10, exp);
      return `${mant.toFixed(2)}×10^${exp}`;
    }

    // ---------------------------
    // Live readouts
    // ---------------------------
    function updateReadouts(params){
      const EgEff_eV = (params.Eg_J + params.dE_J)/q;
      const mr_m0 = params.mr/m0;
      const kT_eV = (kB*params.T)/q;
      const Ep_eV = params.Ep_J/q;

      const rPeak_cm = peakRate_SI(params.mr, params.Eg_J, params.T, params.tau_s)/1e6;
      const D0val = D0(params.mr, params.Eg_J, params.T); // SI

      const line1 =
`Inputs
T = ${params.T.toFixed(0)} K
E_g = ${(params.Eg_J/q).toFixed(3)} eV
ΔE (illustrative) = ${(params.dE_J/q).toFixed(3)} eV
τ_r = ${(params.tau_s*1e9).toFixed(3)} ns
m_c = ${params.mc_m0.toFixed(3)} m0
m_v = ${params.mv_m0.toFixed(3)} m0
m_r = ${mr_m0.toFixed(4)} m0`;

      const line2 =
`Derived
kT = ${kT_eV.toFixed(5)} eV
Effective edge: E_g + ΔE = ${EgEff_eV.toFixed(5)} eV
Peak photon energy: hν_p = E_g + ΔE + (1/2)kT = ${Ep_eV.toFixed(5)} eV
Peak rate: r_sp(ν_p) ≈ ${formatSci(rPeak_cm)} photons·s⁻¹·Hz⁻¹·cm⁻³

Model constants
D0 = [(2m_r/ħ^2)^(3/2)/π^2] exp(−E_g/kT)
D0 ≈ ${D0val.toExponential(3)} (SI packaged units)`;

      document.getElementById("liveReadout").textContent = line1;
      document.getElementById("liveReadout2").textContent = line2;

      document.getElementById("liveCopy").textContent =
`T=${params.T.toFixed(0)} K
Eg=${(params.Eg_J/q).toFixed(5)} eV
dE=${(params.dE_J/q).toFixed(5)} eV
tau_r=${(params.tau_s*1e9).toFixed(5)} ns
mc=${params.mc_m0.toFixed(5)} m0
mv=${params.mv_m0.toFixed(5)} m0
mr=${(params.mr/m0).toFixed(6)} m0
hv_p=${(params.Ep_J/q).toFixed(6)} eV
r_peak=${rPeak_cm.toExponential(6)} photons s^-1 Hz^-1 cm^-3`;
    }

    // ---------------------------
    // Control wiring + render loop
    // ---------------------------
    const elT = document.getElementById("T");
    const elEg = document.getElementById("Eg");
    const elTau = document.getElementById("tau");
    const elMc = document.getElementById("mc");
    const elMv = document.getElementById("mv");
    const elDE = document.getElementById("dE");
    const Tread = document.getElementById("Tread");
    const dEread = document.getElementById("dEread");

    const cDiagram = document.getElementById("cDiagram");
    const cMain = document.getElementById("cMain");
    const cSweep = document.getElementById("cSweep");

    function getParams(){
      const T = parseFloat(elT.value);
      const Eg_eV = parseFloat(elEg.value);
      const tau_ns = parseFloat(elTau.value);
      const mc_m0 = parseFloat(elMc.value);
      const mv_m0 = parseFloat(elMv.value);
      const dE_eV = parseFloat(elDE.value);

      const mr = mReduced(mc_m0, mv_m0);
      const Eg_J = Eg_eV * q;
      const tau_s = tau_ns * 1e-9;
      const dE_J = dE_eV * q;
      const Ep_J = peakEnergy_J(Eg_J, T, dE_J);

      return {T, Eg_J, tau_s, mc_m0, mv_m0, mr, dE_J, Ep_J};
    }

    function render(){
      const params = getParams();

      Tread.textContent = `${params.T.toFixed(0)} K`;
      dEread.textContent = `${(params.dE_J/q).toFixed(3)} eV`;

      drawDiagram(cDiagram, params);
      drawMainPlot(cMain, params);
      drawSweep(cSweep, params);
      updateReadouts(params);
    }

    [elT, elEg, elTau, elMc, elMv, elDE].forEach(el=>{
      el.addEventListener("input", render);
      el.addEventListener("change", render);
    });

    // GaAs button
    document.getElementById("btnGaAs").addEventListener("click", ()=>{
      elT.value = 300;
      elEg.value = 1.42;
      elTau.value = 0.4;
      elMc.value = 0.07;
      elMv.value = 0.50;
      elDE.value = 0.0;
      render();
      toast("Loaded GaAs example ✓");
    });

    // Resize handling
    let resizeTimer = null;
    window.addEventListener("resize", ()=>{
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(render, 120);
    });

    // Polyfill for roundRect on older browsers
    if(!CanvasRenderingContext2D.prototype.roundRect){
      CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
        const rr = Math.min(r, w/2, h/2);
        this.beginPath();
        this.moveTo(x+rr, y);
        this.arcTo(x+w, y, x+w, y+h, rr);
        this.arcTo(x+w, y+h, x, y+h, rr);
        this.arcTo(x, y+h, x, y, rr);
        this.arcTo(x, y, x+w, y, rr);
        this.closePath();
        return this;
      }
    }

    // Initial render
    render();
  </script>
</body>
</html>
