<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Validity of the δ(ν−ν0) Approximation for Absorption/Emission Rates (GaAs, 300 K)</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --card:#121c28;
      --text:#e9eef6;
      --muted:#a8b3c5;
      --faint:#7f8aa0;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.07);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 700px at 20% 10%, rgba(125,211,252,.12), transparent 60%),
                  radial-gradient(900px 600px at 80% 0%, rgba(167,139,250,.10), transparent 55%),
                  radial-gradient(1200px 900px at 50% 120%, rgba(52,211,153,.08), transparent 60%),
                  var(--bg);
      color:var(--text);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding:28px 18px 8px;
      max-width:1200px;
      margin:0 auto;
    }
    .title{
      display:flex; gap:16px; align-items:flex-start; flex-wrap:wrap;
    }
    .badge{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      padding:8px 10px;
      border-radius:999px;
      font-size:12px;
      color:var(--muted);
      letter-spacing:.2px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    h1{
      margin:0;
      font-size: clamp(24px, 3vw, 38px);
      letter-spacing:-.4px;
      line-height:1.15;
    }
    .subtitle{
      margin:10px 0 0;
      color:var(--muted);
      max-width: 80ch;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding:14px 18px 60px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      align-items:start;
    }

    /* Sticky TOC */
    nav{
      position:sticky;
      top:14px;
      align-self:start;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px 14px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    nav .toc-title{
      font-size:12px;
      letter-spacing:.18em;
      color:var(--faint);
      margin:4px 0 10px;
      text-transform:uppercase;
    }
    nav ul{
      list-style:none;
      padding:0; margin:0;
      display:flex;
      flex-direction:column;
      gap:8px;
    }
    nav li a{
      display:block;
      padding:8px 10px;
      border-radius:12px;
      border:1px solid transparent;
      color:var(--muted);
      font-size:14px;
      line-height:1.2;
    }
    nav li a:hover{
      background: rgba(125,211,252,.08);
      border-color: rgba(125,211,252,.18);
      color:var(--text);
      text-decoration:none;
    }

    /* Content */
    article{
      display:flex;
      flex-direction:column;
      gap:14px;
    }
    section{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:18px 18px 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    section h2{
      margin:0 0 10px;
      font-size:20px;
      letter-spacing:-.2px;
    }
    section h3{
      margin:14px 0 8px;
      font-size:16px;
      color:var(--text);
    }
    p{margin:10px 0;color:var(--muted)}
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:12px;
    }
    .grid3{
      display:grid;
      grid-template-columns:1fr 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
      nav{position:relative; top:auto}
      .grid2,.grid3{grid-template-columns:1fr}
    }

    .callout{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:12px 12px;
      margin:10px 0;
    }
    .callout strong{color:var(--text)}
    .callout.assump{border-color: rgba(52,211,153,.25)}
    .callout.keyeq{border-color: rgba(125,211,252,.25)}
    .callout.mist{border-color: rgba(251,191,36,.25)}
    .callout.answer{border-color: rgba(167,139,250,.28)}
    .mini{
      font-size:13px;
      color:var(--muted);
    }

    .eq{
      font-family: var(--mono);
      font-size: 13px;
      white-space: pre-wrap;
      background: rgba(0,0,0,.22);
      border:1px solid var(--line2);
      border-radius: 14px;
      padding:12px 12px;
      margin:10px 0 6px;
      position:relative;
      overflow:hidden;
    }
    .copyRow{
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:flex-start;
      flex-wrap:wrap;
      margin:6px 0 2px;
    }
    button.copy{
      appearance:none;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:12px;
    }
    button.copy:hover{background: rgba(125,211,252,.10); border-color: rgba(125,211,252,.22)}
    .pill{
      display:inline-flex; gap:8px; align-items:center;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
      padding:7px 10px;
      border-radius:999px;
      font-size:12px;
    }
    .pill b{color:var(--text); font-weight:600}
    .hr{
      height:1px; background:var(--line2); margin:12px 0;
    }

    /* Visualization area */
    figure{margin:0}
    .vizWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .canvasCard{
      border:1px solid var(--line);
      border-radius: 16px;
      background: rgba(0,0,0,.20);
      padding:10px;
      overflow:hidden;
    }
    canvas{width:100%; height:320px; display:block}
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .controls{grid-template-columns:1fr}
    }
    .control{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:10px 12px;
    }
    .control label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      font-size:13px;
      color:var(--muted);
    }
    .control input[type="range"]{width:100%}
    .control select{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      background: rgba(0,0,0,.25);
      border:1px solid var(--line);
      color:var(--text);
      outline:none;
    }
    .kpiRow{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .kpi{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      padding:10px 12px;
      border-radius: 14px;
      min-width: 180px;
    }
    .kpi .k{font-size:12px; color:var(--faint); letter-spacing:.12em; text-transform:uppercase}
    .kpi .v{font-size:16px; color:var(--text); margin-top:6px}
    footer{
      max-width:1200px;
      margin:0 auto;
      padding:0 18px 40px;
      color:var(--faint);
      font-size:12px;
    }

    /* Print-friendly */
    @media print{
      body{background:#fff; color:#000}
      nav{display:none}
      section{box-shadow:none; backdrop-filter:none}
      .canvasCard{break-inside:avoid}
      a{color:#000; text-decoration:underline}
    }

    /* Subtle animation */
    @keyframes fadeUp{
      from{opacity:0; transform:translateY(6px)}
      to{opacity:1; transform:translateY(0)}
    }
    section{animation: fadeUp .35s ease both}
  </style>
</head>
<body>
<header>
  <div class="title">
    <div class="badge">Photonics • Semiconductor Optics • Lineshape Approximation</div>
    <div>
      <h1>Validity of the Approximation <span style="font-family:var(--mono)"><b>g(ν;ν0) ≈ δ(ν−ν0)</b></span> for Absorption/Emission Rates (GaAs, 300 K)</h1>
      <p class="subtitle">
        We test when a narrow homogeneous linewidth lets you replace a convolution integral by a simple product:
        the spectrum becomes “the weighting function evaluated at ν”. We quantify this for GaAs at <b>T = 300 K</b> with
        collisional lifetime broadening given by <b>T₂ ≈ 1 ps</b>.
      </p>
    </div>
  </div>
</header>

<main>
  <nav aria-label="Table of contents">
    <div class="toc-title">Table of Contents</div>
    <ul>
      <li><a href="#quick">Quick Summary</a></li>
      <li><a href="#part0">PART 0 — Concept Primer</a></li>
      <li><a href="#part1">PART 1 — Problem Analysis</a></li>
      <li><a href="#part2">PART 2 — Strategy & Tips</a></li>
      <li><a href="#part3">PART 3 — Full Solution</a></li>
      <li><a href="#part4">PART 4 — Deeper Understanding</a></li>
      <li><a href="#part5">PART 5 — Visualization Guide</a></li>
    </ul>
    <div class="hr"></div>
    <div class="mini">
      Jump between sections while the plots remain interactive.
    </div>
  </nav>

  <article>
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul style="margin:10px 0 0; padding-left:18px; color:var(--muted)">
        <li><b>What this is about:</b> checking when a narrow homogeneous line <span style="font-family:var(--mono)">g(ν;ν0)</span> can be approximated by <span style="font-family:var(--mono)">δ(ν−ν0)</span> inside emission/absorption rate integrals.</li>
        <li><b>Key physics idea:</b> the rate spectrum is a <b>convolution</b> of a narrow line with a slowly-varying weighting function; if the weighting varies little across the linewidth, convolution ≈ evaluation.</li>
        <li><b>Governing structure:</b> <span style="font-family:var(--mono)">R(ν) = ∫ dν0 g(ν;ν0) W(ν0)</span>, with <span style="font-family:var(--mono)">W(ν0)=f_e(ν0)ρ(ν0)</span> (emission) or a thermal-equilibrium absorption weight.</li>
        <li><b>Lineshape model:</b> for collisional dephasing time <span style="font-family:var(--mono)">T₂</span>, <b>Lorentzian</b> with frequency FWHM <span style="font-family:var(--mono)">Δν = 1/(πT₂)</span>.</li>
        <li><b>GaAs at 300 K:</b> for <span style="font-family:var(--mono)">T₂=1 ps</span>, <span style="font-family:var(--mono)">Δν ≈ 3.18×10¹¹ Hz</span> ⇒ energy FWHM <span style="font-family:var(--mono)">ΔE ≈ hΔν ≈ 1.32 meV</span>, far smaller than thermal scales (<span style="font-family:var(--mono)">kT ≈ 25.9 meV</span>).</li>
        <li><b>Conclusion type:</b> a <b>width-comparison + quantitative error</b>: relative error scales roughly like <span style="font-family:var(--mono)">(ΔE/L)²</span> where <span style="font-family:var(--mono)">L</span> is the energy scale on which <span style="font-family:var(--mono)">W</span> changes (typically ~ <span style="font-family:var(--mono)">kT</span> or larger here).</li>
      </ul>

      <div class="callout answer">
        <strong>Bottom line:</strong> For GaAs at <b>T=300 K</b> with <b>T₂ ≈ 1 ps</b>, the Lorentzian linewidth (~<b>1.3 meV</b>) is much narrower than the variation scales of <b>carrier occupation</b> and <b>joint density of states</b> (tens of meV), so <span style="font-family:var(--mono)">g(ν;ν0)≈δ(ν−ν0)</span> is typically <b>very good</b> for both spontaneous emission and thermal-equilibrium absorption.
      </div>
    </section>

    <section id="part0">
      <h2>PART 0 — Concept Primer (THEORY BEFORE SOLVING)</h2>

      <h3>Core definitions (symbols + units)</h3>
      <p>
        We describe optical transitions with a <b>central transition frequency</b> <span style="font-family:var(--mono)">ν0</span> (Hz) or equivalently
        <span style="font-family:var(--mono)">E0 = hν0</span> (eV or J), where <span style="font-family:var(--mono)">h</span> is Planck’s constant.
      </p>

      <div class="callout keyeq">
        <strong>Normalized homogeneous lineshape</strong> (Lorentzian):
        <div class="eq" id="eq-lineshape">g(ν;ν0) = (1/π) * ( (Δν/2) / ( (ν-ν0)^2 + (Δν/2)^2 ) ),   with  ∫ g(ν;ν0) dν = 1</div>
        <div class="copyRow">
          <button class="copy" data-copy-target="eq-lineshape">Copy equation</button>
          <span class="pill"><b>Units</b>: g has units of 1/Hz so that ∫g dν = 1</span>
        </div>
      </div>

      <p>
        The <b>dephasing time</b> <span style="font-family:var(--mono)">T₂</span> (s) sets the homogeneous linewidth.
        For an exponential polarization decay ∝ exp(−t/T₂), the Lorentzian full width at half maximum (FWHM) in <b>frequency ν</b> is:
      </p>

      <div class="callout keyeq">
        <div class="eq" id="eq-fwhm">Δν_FWHM = 1/(π T2)   ⇔   ΔE_FWHM = h Δν_FWHM = h/(π T2)</div>
        <div class="copyRow">
          <button class="copy" data-copy-target="eq-fwhm">Copy equation</button>
          <span class="pill"><b>Key scale</b>: smaller T₂ → broader line</span>
        </div>
      </div>

      <h3>Physical meaning of key quantities</h3>
      <div class="grid2">
        <div class="callout">
          <strong>g(ν;ν0)</strong>
          <p class="mini">
            The probability density that an emitter whose “natural” transition is at ν0 actually emits/absorbs at ν due to
            <b>homogeneous broadening</b> (collisions, phonons, dephasing).
          </p>
        </div>
        <div class="callout">
          <strong>W(ν0) = f(ν0) ρ(ν0)</strong>
          <p class="mini">
            A <b>slowly varying weight</b> that counts how many transitions exist at ν0 and how strongly they contribute.
            Typical pieces:
            <b>occupation factors</b> (Fermi–Dirac or Boltzmann) and <b>density of states</b> / joint density of states.
          </p>
        </div>
      </div>

      <h3>Key principle: “narrow-kernel” approximation</h3>
      <p>
        Many spectra take the form of a convolution:
        the observed rate <span style="font-family:var(--mono)">R(ν)</span> is the homogeneous lineshape <span style="font-family:var(--mono)">g</span> convolved with a weight <span style="font-family:var(--mono)">W</span>.
        If <span style="font-family:var(--mono)">g</span> is much narrower than the scale over which <span style="font-family:var(--mono)">W</span> changes, then:
      </p>

      <div class="callout keyeq">
        <div class="eq" id="eq-delta">R(ν) = ∫ dν0 g(ν;ν0) W(ν0)  ≈  W(ν)   when g(ν;ν0) is sharply peaked at ν0=ν</div>
        <div class="copyRow">
          <button class="copy" data-copy-target="eq-delta">Copy equation</button>
          <span class="pill"><b>Interpretation</b>: convolution ≈ sampling</span>
        </div>
      </div>

      <h3>Common models/approximations (and why we use them)</h3>
      <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted)">
        <li><b>Homogeneous Lorentzian broadening</b>: good when dephasing is exponential in time (many collision/phonon processes).</li>
        <li><b>Nondegenerate carriers</b> at 300 K: often <span style="font-family:var(--mono)">f(E) ∝ exp(-(E-Eg)/kT)</span> is adequate for a width-scale comparison.</li>
        <li><b>3D direct-gap joint density of states</b>: near the band edge, <span style="font-family:var(--mono)">ρ(E) ∝ √(E−Eg)</span> (parabolic bands). This varies on energy scales ≫ meV.</li>
        <li><b>δ-approximation</b>: replaces the Lorentzian by a delta function, simplifying integrals and making analytic insight easy.</li>
      </ul>

      <h3>Mini intuition examples</h3>
      <div class="grid2">
        <div class="callout">
          <strong>Example 1 — Flat weight</strong>
          <p class="mini">
            If <span style="font-family:var(--mono)">W(ν0)</span> is constant across the linewidth, convolution returns the same constant exactly:
            <span style="font-family:var(--mono)">R(ν)=W</span>. The δ-approximation is exact.
          </p>
        </div>
        <div class="callout">
          <strong>Example 2 — Slowly sloped weight</strong>
          <p class="mini">
            If <span style="font-family:var(--mono)">W</span> changes linearly across the linewidth, symmetry of the Lorentzian makes the first-order correction small; leading errors come from curvature (second derivative).
          </p>
        </div>
      </div>

      <div class="callout mist">
        <strong>What to watch for (pitfalls)</strong>
        <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted)">
          <li><b>Mixing ν and ω</b>: linewidth formulas differ by factors of 2π. Here we use frequency ν (Hz): <span style="font-family:var(--mono)">Δν=1/(πT₂)</span>.</li>
          <li><b>Forgetting normalization</b>: <span style="font-family:var(--mono)">g</span> must integrate to 1 over ν.</li>
          <li><b>Using δ when W varies rapidly</b>: near sharp band edges, excitonic peaks, or cavity resonances, δ can fail.</li>
        </ul>
      </div>
    </section>

    <section id="part1">
      <h2>PART 1 — Problem Analysis (no solving yet)</h2>

      <h3>Restate the problem (in plain words)</h3>
      <p>
        In deriving optical absorption/emission rates, an integral over transition frequencies <span style="font-family:var(--mono)">ν0</span> contains a homogeneous lineshape
        <span style="font-family:var(--mono)">g(ν;ν0)</span>. The derivation approximated this sharply-peaked lineshape as a delta function:
        <span style="font-family:var(--mono)">g(ν;ν0) ≈ δ(ν−ν0)</span>.
        You must check that this is justified for <b>GaAs at T = 300 K</b> by comparing linewidths.
      </p>

      <div class="grid2">
        <div class="callout">
          <strong>Given</strong>
          <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted)">
            <li>Material: GaAs (direct gap)</li>
            <li>Temperature: <span style="font-family:var(--mono)">T = 300 K</span></li>
            <li>Homogeneous (collisional) dephasing time: <span style="font-family:var(--mono)">T₂ ≈ 1 ps</span></li>
            <li>Need to compare: widths of <span style="font-family:var(--mono)">g</span>, <span style="font-family:var(--mono)">f_e</span>, and <span style="font-family:var(--mono)">ρ</span></li>
          </ul>
        </div>
        <div class="callout">
          <strong>Unknowns / tasks</strong>
          <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted)">
            <li>(a) Show δ-approx is satisfactory for spontaneous emission rate integral by plotting and comparing widths.</li>
            <li>(b) Repeat width/validity check for absorption rate in thermal equilibrium.</li>
          </ul>
        </div>
      </div>

      <h3>Relevant principles (and why they apply)</h3>
      <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted)">
        <li><b>Convolution structure</b>: emission/absorption spectra often involve integrating a narrow homogeneous line against broader statistical weights.</li>
        <li><b>Time–frequency uncertainty for dephasing</b>: <span style="font-family:var(--mono)">T₂</span> determines Lorentzian width, setting the “kernel width” of the convolution.</li>
        <li><b>Thermal/quantum statistics</b>: at 300 K, carrier occupations and photon occupations vary on energy scales set by <span style="font-family:var(--mono)">kT</span> (tens of meV).</li>
        <li><b>Band-structure DOS near a direct gap</b>: joint DOS varies smoothly above <span style="font-family:var(--mono)">E_g</span>, typically over many meV.</li>
      </ul>

      <div class="callout assump">
        <strong>Assumptions (explicit)</strong>
        <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted)">
          <li>Homogeneous broadening is Lorentzian due to exponential dephasing with time constant <span style="font-family:var(--mono)">T₂</span>.</li>
          <li>We compare <b>variation scales</b>, not absolute magnitudes. For plotting we adopt standard smooth example forms for <span style="font-family:var(--mono)">f_e</span> and <span style="font-family:var(--mono)">ρ</span>.</li>
          <li>GaAs is treated as a 3D direct-gap semiconductor with a smooth joint DOS near the edge: <span style="font-family:var(--mono)">ρ(E) ∝ √(E−E_g)</span>.</li>
          <li>Thermal equilibrium absorption uses a photon occupation factor <span style="font-family:var(--mono)">n_B(E)=1/(exp(E/kT)-1)</span> (slowly varying on meV scales at optical energies).</li>
        </ul>
      </div>

      <h3>Possible approaches (compare)</h3>
      <div class="grid3">
        <div class="callout">
          <strong>Approach A — Width comparison</strong>
          <p class="mini">
            Compute <span style="font-family:var(--mono)">Δν</span> (or <span style="font-family:var(--mono)">ΔE</span>) for <span style="font-family:var(--mono)">g</span> and compare to characteristic scales over which
            <span style="font-family:var(--mono)">f_e</span> and <span style="font-family:var(--mono)">ρ</span> change.
          </p>
          <p class="mini"><b>Pros:</b> fast, conceptual. <b>Cons:</b> not a numerical error bound.</p>
        </div>
        <div class="callout">
          <strong>Approach B — Taylor expansion error</strong>
          <p class="mini">
            Expand <span style="font-family:var(--mono)">W(ν0)</span> around <span style="font-family:var(--mono)">ν</span> and estimate corrections from curvature.
          </p>
          <p class="mini"><b>Pros:</b> analytic scaling. <b>Cons:</b> Lorentzian has heavy tails; must be careful.</p>
        </div>
        <div class="callout">
          <strong>Approach C — Direct numerical check</strong>
          <p class="mini">
            Compute <span style="font-family:var(--mono)">R_exact = g * W</span> and compare to <span style="font-family:var(--mono)">R_delta = W</span>, plot relative error vs energy.
          </p>
          <p class="mini"><b>Pros:</b> concrete and visual. <b>Cons:</b> needs a model for <span style="font-family:var(--mono)">W</span>.</p>
        </div>
      </div>

      <p>
        <b>We will use A + C</b>: first, a clean scale argument (what the approximation needs), then a numerical demonstration using standard smooth GaAs-like example functions.
      </p>
    </section>

    <section id="part2">
      <h2>PART 2 — Strategy & Tips (roadmap only)</h2>

      <ol style="margin:8px 0 0; padding-left:20px; color:var(--muted)">
        <li>
          <b>Goal:</b> write the rate integral in a “convolution” form.<br/>
          <span class="mini"><b>Tool:</b> define <span style="font-family:var(--mono)">W(ν0)</span> as the product of slowly varying factors.</span>
        </li>
        <li>
          <b>Goal:</b> choose a normalized Lorentzian <span style="font-family:var(--mono)">g(ν;ν0)</span> and relate its width to <span style="font-family:var(--mono)">T₂</span>.<br/>
          <span class="mini"><b>Tool:</b> Fourier transform of exp(−t/T₂) → Lorentzian; use <span style="font-family:var(--mono)">Δν=1/(πT₂)</span>.</span>
        </li>
        <li>
          <b>Goal:</b> compute the numeric linewidth for <span style="font-family:var(--mono)">T₂=1 ps</span>.<br/>
          <span class="mini"><b>Meaning:</b> sets the “kernel width” that determines how much averaging occurs.</span>
        </li>
        <li>
          <b>Goal:</b> estimate how quickly <span style="font-family:var(--mono)">f_e</span> changes with energy at 300 K.<br/>
          <span class="mini"><b>Tool:</b> thermal scale <span style="font-family:var(--mono)">kT</span> ⇒ changes over ~ tens of meV.</span>
        </li>
        <li>
          <b>Goal:</b> estimate how quickly the GaAs joint DOS <span style="font-family:var(--mono)">ρ(E)</span> changes near the gap.<br/>
          <span class="mini"><b>Tool:</b> <span style="font-family:var(--mono)">ρ(E) ∝ √(E−E_g)</span> varies smoothly over many meV above the edge.</span>
        </li>
        <li>
          <b>Goal:</b> conclude δ-approx validity by comparing <span style="font-family:var(--mono)">ΔE</span> to the variation scale of <span style="font-family:var(--mono)">W(E)</span>.<br/>
          <span class="mini"><b>Tip:</b> if <span style="font-family:var(--mono)">ΔE ≪ kT</span> and also <span style="font-family:var(--mono)">ΔE ≪</span> any DOS feature width, the approximation is excellent.</span>
        </li>
        <li>
          <b>Goal:</b> repeat for absorption in thermal equilibrium by updating the weight function.<br/>
          <span class="mini"><b>Tool:</b> include the Bose factor <span style="font-family:var(--mono)">n_B(E)</span> (and/or detailed-balance relations).</span>
        </li>
        <li>
          <b>Goal:</b> verify visually: plot <span style="font-family:var(--mono)">g</span>, <span style="font-family:var(--mono)">f_e</span>, <span style="font-family:var(--mono)">ρ</span>, and also the relative error between <span style="font-family:var(--mono)">R_exact</span> and <span style="font-family:var(--mono)">R_delta</span>.<br/>
          <span class="mini"><b>Tip:</b> keep everything normalized to compare widths directly.</span>
        </li>
      </ol>

      <div class="callout mist">
        <strong>Common mistakes + quick tips</strong>
        <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted)">
          <li><b>Mistake:</b> comparing linewidth in ω to thermal scale in ν. <b>Tip:</b> convert both to energy <span style="font-family:var(--mono)">E=hν</span>.</li>
          <li><b>Mistake:</b> thinking δ-approx requires “infinitely narrow”. <b>Tip:</b> it only requires “narrow relative to W’s variation scale”.</li>
          <li><b>Mistake:</b> ignoring sharp features (excitons/cavities). <b>Tip:</b> δ fails if <span style="font-family:var(--mono)">ρ</span> or <span style="font-family:var(--mono)">f</span> has meV-scale structure.</li>
        </ul>
      </div>
    </section>

    <section id="part3">
      <h2>PART 3 — Full Solution (DETAILED + TEACHING)</h2>

      <h3>Physical intuition first (what we expect)</h3>
      <p>
        A Lorentzian lineshape with <span style="font-family:var(--mono)">T₂=1 ps</span> is only about ~1 meV wide in energy.
        At 300 K, thermal occupations vary on the scale <span style="font-family:var(--mono)">kT ≈ 26 meV</span>, and the GaAs joint DOS varies smoothly above the band edge.
        So across a ~1 meV window, the product <span style="font-family:var(--mono)">W(E)=f(E)ρ(E)</span> barely changes.
        That means the convolution with <span style="font-family:var(--mono)">g</span> should return almost the same curve as simply evaluating <span style="font-family:var(--mono)">W</span> at the observation energy.
      </p>

      <div class="hr"></div>

      <h3>Step 1 — Write the convolution structure</h3>
      <p>
        The problem statement (as shown) uses an integral where a narrow lineshape <span style="font-family:var(--mono)">g(ν;ν0)</span> multiplies other factors.
        Abstract the slowly varying part as a weight <span style="font-family:var(--mono)">W(ν0)</span>.
      </p>

      <div class="callout keyeq">
        <div class="eq" id="eq-conv">R(ν) = ∫ dν0  g(ν;ν0)  W(ν0)
where for spontaneous emission we can take  W(ν0) = f_e(ν0) ρ(ν0)  (up to constants).</div>
        <div class="copyRow">
          <button class="copy" data-copy-target="eq-conv">Copy equation</button>
          <span class="pill"><b>Structure</b>: R is a convolution kernel g applied to W</span>
        </div>
      </div>

      <p>
        <b>Why this helps:</b> If <span style="font-family:var(--mono)">g</span> is sharply peaked at <span style="font-family:var(--mono)">ν0=ν</span> and normalized, the integral behaves like sampling.
      </p>

      <h3>Step 2 — Specify the Lorentzian linewidth from T₂</h3>
      <p>
        For homogeneous broadening due to dephasing time <span style="font-family:var(--mono)">T₂</span>, a standard normalized Lorentzian in frequency is:
      </p>

      <div class="callout keyeq">
        <div class="eq" id="eq-lorentz">g(ν;ν0) = (1/π) * ( (Δν/2) / ( (ν-ν0)^2 + (Δν/2)^2 ) ),
Δν = 1/(π T2)  (FWHM in ν).</div>
        <div class="copyRow">
          <button class="copy" data-copy-target="eq-lorentz">Copy equation</button>
          <span class="pill"><b>Normalization</b>: ∫ g dν = 1</span>
        </div>
      </div>

      <p>
        Convert to energy using <span style="font-family:var(--mono)">E=hν</span>. Because <span style="font-family:var(--mono)">dE = h dν</span>, a normalized Lorentzian in energy has the same form,
        with <span style="font-family:var(--mono)">ΔE = hΔν = h/(πT₂)</span>.
      </p>

      <h3>Step 3 — Numeric linewidth for T₂ = 1 ps</h3>
      <p>
        Take <span style="font-family:var(--mono)">T₂ = 1×10⁻¹² s</span>.
      </p>
      <div class="callout">
        <div class="eq" id="eq-numbers">Δν = 1/(π T2) = 1/(π×10^-12 s) ≈ 3.18×10^11 Hz
ΔE = hΔν ≈ (6.626×10^-34 J·s)(3.18×10^11 s^-1) ≈ 2.11×10^-22 J ≈ 1.32 meV</div>
        <div class="copyRow">
          <button class="copy" data-copy-target="eq-numbers">Copy numbers</button>
          <span class="pill"><b>Result</b>: linewidth ~ 1.3 meV</span>
        </div>
      </div>

      <h3>Step 4 — Compare to thermal and DOS variation scales (GaAs, 300 K)</h3>
      <p>
        Thermal energy:
        <span style="font-family:var(--mono)">kT ≈ (8.617×10⁻⁵ eV/K)(300 K) ≈ 0.0259 eV = 25.9 meV</span>.
        That is about <b>20× larger</b> than the homogeneous linewidth found above.
      </p>
      <p>
        For a 3D direct-gap semiconductor with parabolic bands, the joint density of states near the band edge behaves like
        <span style="font-family:var(--mono)">ρ(E) ∝ √(E−E_g)</span>.
        This function changes significantly only when <span style="font-family:var(--mono)">E−E_g</span> changes by an amount comparable to itself—typically many meV (unless you are within an extremely tiny window right at the edge).
      </p>

      <div class="callout assump">
        <strong>Width comparison conclusion</strong>
        <p class="mini">
          The lineshape kernel width is <span style="font-family:var(--mono)">ΔE ~ 1.3 meV</span>, while <span style="font-family:var(--mono)">f_e(E)</span> changes on scale ~<span style="font-family:var(--mono)">kT ~ 26 meV</span> and
          <span style="font-family:var(--mono)">ρ(E)</span> is smooth on similar-or-larger scales above the gap. Therefore, across the Lorentzian width,
          <span style="font-family:var(--mono)">W(E)=f_e(E)ρ(E)</span> is nearly constant, so <span style="font-family:var(--mono)">g≈δ</span> is expected to be very accurate.
        </p>
      </div>

      <h3>Step 5 — Make the δ-approximation explicit</h3>
      <p>
        If <span style="font-family:var(--mono)">W</span> varies slowly across the linewidth, we approximate:
      </p>

      <div class="callout answer">
        <div class="eq" id="eq-final-a">Spontaneous emission (spectral rate shape):
R_exact(ν) = ∫ dν0 g(ν;ν0) f_e(ν0) ρ(ν0)
≈ f_e(ν) ρ(ν)   (δ-approximation).</div>
        <div class="copyRow">
          <button class="copy" data-copy-target="eq-final-a">Copy final form</button>
          <span class="pill"><b>Meaning</b>: the homogeneous line just “selects” ν0≈ν</span>
        </div>
      </div>

      <h3>Step 6 — Repeat for absorption in thermal equilibrium</h3>
      <p>
        In thermal equilibrium, absorption is governed by detailed balance and includes equilibrium occupation factors.
        The <b>same mathematical test</b> applies: absorption at ν is a convolution of <span style="font-family:var(--mono)">g</span> with a weight <span style="font-family:var(--mono)">W_abs(ν0)</span>.
      </p>
      <p>
        A common equilibrium factor is the photon Bose occupation at energy <span style="font-family:var(--mono)">E=hν</span>:
        <span style="font-family:var(--mono)">n_B(E)=1/(exp(E/kT)-1)</span>.
        At optical energies near the GaAs gap (<span style="font-family:var(--mono)">E_g≈1.42 eV</span>), <span style="font-family:var(--mono)">E/kT ≫ 1</span> so
        <span style="font-family:var(--mono)">n_B(E) ≈ exp(-E/kT)</span>, varying on the same tens-of-meV scale.
        Therefore it also changes very slowly across <span style="font-family:var(--mono)">ΔE ~ 1.3 meV</span>.
      </p>

      <div class="callout answer">
        <div class="eq" id="eq-final-b">Thermal-equilibrium absorption (spectral shape):
R_abs,exact(ν) = ∫ dν0 g(ν;ν0) W_abs(ν0)
≈ W_abs(ν)   (δ-approximation),
and W_abs typically includes DOS × carrier factors × photon occupation n_B(hν0).</div>
        <div class="copyRow">
          <button class="copy" data-copy-target="eq-final-b">Copy absorption result</button>
          <span class="pill"><b>Same criterion</b>: W_abs must be smooth over Δν</span>
        </div>
      </div>

      <h3>Sanity checks</h3>
      <div class="grid3">
        <div class="callout">
          <strong>Units</strong>
          <p class="mini">
            <span style="font-family:var(--mono)">g</span> has units 1/Hz (or 1/eV in energy form) so that convolution preserves the units of <span style="font-family:var(--mono)">W</span>.
          </p>
        </div>
        <div class="callout">
          <strong>Limiting case</strong>
          <p class="mini">
            If <span style="font-family:var(--mono)">T₂ → ∞</span>, then <span style="font-family:var(--mono)">Δν → 0</span> and the Lorentzian becomes a delta distribution, making the approximation exact.
          </p>
        </div>
        <div class="callout">
          <strong>Physical interpretation</strong>
          <p class="mini">
            Dephasing “smears” the transition frequency slightly; when this smear is tiny compared with thermal/DOS variation, the system behaves as if transitions occur at a well-defined frequency.
          </p>
        </div>
      </div>

      <div class="hr"></div>

      <h3>Interactive Visual Demonstration (plots + diagram)</h3>
      <p>
        The canvases below implement the width comparison and a direct numerical check by convolving a Lorentzian (set by <span style="font-family:var(--mono)">T₂</span>)
        with smooth GaAs-like example functions:
        <span style="font-family:var(--mono)">f_e(E) ∝ exp(-(E−E_g)/kT)</span> (nondegenerate example) and <span style="font-family:var(--mono)">ρ(E) ∝ √(E−E_g)</span>.
        For absorption in thermal equilibrium we additionally include <span style="font-family:var(--mono)">n_B(E)</span>.
      </p>

      <figure class="vizWrap" aria-label="Interactive visualizations">
        <div class="canvasCard">
          <canvas id="cDiagram" aria-label="Diagram canvas"></canvas>
        </div>
        <div class="canvasCard">
          <canvas id="cMain" aria-label="Main plot canvas"></canvas>
        </div>
        <div class="canvasCard">
          <canvas id="cSecondary" aria-label="Secondary plot canvas"></canvas>
        </div>

        <div class="controls" aria-label="Interactive controls">
          <div class="control">
            <label for="t2Slider">
              <span><b>T₂</b> (ps)</span>
              <span class="pill"><b id="t2Val">1.00</b></span>
            </label>
            <input id="t2Slider" type="range" min="0.10" max="5.00" step="0.01" value="1.00"/>
            <div class="mini">Changes Lorentzian linewidth and updates all plots.</div>
          </div>

          <div class="control">
            <label for="tempSlider">
              <span><b>T</b> (K)</span>
              <span class="pill"><b id="tVal">300</b></span>
            </label>
            <input id="tempSlider" type="range" min="50" max="600" step="1" value="300"/>
            <div class="mini">Changes thermal scale (occupation/Bose factor) and updates all plots.</div>
          </div>

          <div class="control">
            <label for="modeSelect">
              <span><b>Process</b></span>
              <span class="pill"><b id="modeVal">Spontaneous emission</b></span>
            </label>
            <select id="modeSelect">
              <option value="emission" selected>Spontaneous emission</option>
              <option value="absorption">Absorption (thermal equilibrium)</option>
            </select>
            <div class="mini">Switches the weight function W(E) used in the convolution.</div>
          </div>
        </div>

        <div class="kpiRow" aria-label="Computed key values">
          <div class="kpi">
            <div class="k">Δν (FWHM)</div>
            <div class="v" id="kpiDnu">—</div>
          </div>
          <div class="kpi">
            <div class="k">ΔE (FWHM)</div>
            <div class="v" id="kpiDe">—</div>
          </div>
          <div class="kpi">
            <div class="k">Max rel. error</div>
            <div class="v" id="kpiErr">—</div>
          </div>
        </div>
      </figure>
    </section>

    <section id="part4">
      <h2>PART 4 — Deeper Understanding (THEORY AROUND THE RESULT)</h2>

      <h3>Re-interpret the final formula</h3>
      <p>
        The δ-approximation turns a convolution into a point-evaluation. Physically, this means:
        the homogeneous broadening is so narrow that the material “does not average” over a range of transition energies—
        it effectively samples only transitions with <span style="font-family:var(--mono)">ν0 ≈ ν</span>.
      </p>
      <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted)">
        <li><b>T₂ controls the kernel width</b>: shorter <span style="font-family:var(--mono)">T₂</span> broadens <span style="font-family:var(--mono)">g</span>, increasing averaging and error.</li>
        <li><b>Temperature controls smoothness</b>: higher <span style="font-family:var(--mono)">T</span> makes thermal factors vary more slowly with energy (larger <span style="font-family:var(--mono)">kT</span>), typically improving δ-accuracy.</li>
        <li><b>DOS features can dominate</b>: near very sharp DOS structure (excitons, microcavities), δ can break even if <span style="font-family:var(--mono)">T₂</span> is “not too small”.</li>
      </ul>

      <h3>How changing parameters affects the outcome (connect to plots)</h3>
      <p>
        In the interactive plots, decreasing <span style="font-family:var(--mono)">T₂</span> broadens the Lorentzian.
        The secondary plot (relative error) grows because the convolution averages <span style="font-family:var(--mono)">W(E0)</span> over a wider region, deviating from <span style="font-family:var(--mono)">W(E)</span>.
        Increasing temperature makes <span style="font-family:var(--mono)">f(E)</span> and <span style="font-family:var(--mono)">n_B(E)</span> vary less sharply per meV, reducing error.
      </p>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        You can formalize the approximation by expanding <span style="font-family:var(--mono)">W</span> about <span style="font-family:var(--mono)">ν</span>:
        <span style="font-family:var(--mono)">W(ν0)=W(ν)+W'(ν)(ν0−ν)+…</span>.
        Symmetry of a centered kernel often cancels the first-order term, making the leading correction depend on curvature (second derivative).
        The result is an error estimate controlled by “kernel width squared × curvature”.
        (With a Lorentzian, one must handle tails carefully, but the scaling intuition remains.)
      </p>

      <h3>Concept check (self-test)</h3>
      <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted)">
        <li><b>Q:</b> If <span style="font-family:var(--mono)">T₂</span> increases, does δ-accuracy improve or worsen? <b>A:</b> Improve (linewidth shrinks).</li>
        <li><b>Q:</b> What sets the main “smoothness” scale of carrier occupations at 300 K? <b>A:</b> <span style="font-family:var(--mono)">kT ≈ 25.9 meV</span>.</li>
        <li><b>Q:</b> Where might δ fail in semiconductors even at 300 K? <b>A:</b> Near sharp spectral structures: excitonic peaks, cavity resonances, band-edge singularities in reduced dimensions.</li>
        <li><b>Q:</b> Why compare in energy rather than frequency? <b>A:</b> Thermal factors and DOS are naturally functions of energy; it avoids 2π confusion.</li>
      </ul>

      <div class="callout answer">
        <strong>Final answer (plain language):</strong>
        <p class="mini" style="margin-top:8px">
          For GaAs at 300 K with <span style="font-family:var(--mono)">T₂ ≈ 1 ps</span>, the homogeneous linewidth is only ~1.3 meV,
          far narrower than the energy scales over which <span style="font-family:var(--mono)">f_e</span>, <span style="font-family:var(--mono)">ρ</span>, and thermal-equilibrium absorption weights vary.
          Therefore <span style="font-family:var(--mono)">g(ν;ν0)≈δ(ν−ν0)</span> is satisfactory for both spontaneous emission and thermal absorption.
        </p>
        <div class="copyRow">
          <button class="copy" data-copy-text="For GaAs at 300 K with T2≈1 ps, ΔE_FWHM = h/(πT2) ≈ 1.3 meV ≪ kT ≈ 25.9 meV and ≪ typical DOS variation scales, so g(ν;ν0)≈δ(ν−ν0) is satisfactory for both spontaneous emission and thermal-equilibrium absorption.">Copy final answer</button>
          <span class="pill"><b>Type</b>: width argument + numerical check</span>
        </div>
      </div>
    </section>

    <section id="part5">
      <h2>PART 5 — Visualization Guide (HOW TO READ THE PLOTS)</h2>

      <h3>What each canvas shows</h3>
      <div class="grid2">
        <div class="callout">
          <strong>Diagram canvas</strong>
          <p class="mini">
            A cartoon of a GaAs interband transition at energy <span style="font-family:var(--mono)">E0</span>,
            with homogeneous broadening giving a Lorentzian spectral spread around <span style="font-family:var(--mono)">E0</span>.
            It also highlights the key idea: a <b>narrow kernel</b> sampling a <b>slowly varying</b> weight function.
          </p>
        </div>
        <div class="callout">
          <strong>Main plot canvas</strong>
          <p class="mini">
            Over an energy window above the GaAs gap <span style="font-family:var(--mono)">E_g</span>, it plots normalized:
            <span style="font-family:var(--mono)">g(E;E*)</span> (Lorentzian centered at a chosen <span style="font-family:var(--mono)">E*</span>),
            <span style="font-family:var(--mono)">f(E)</span>, and <span style="font-family:var(--mono)">ρ(E)</span>.
            The goal is a direct <b>width comparison</b>.
          </p>
        </div>
      </div>

      <div class="callout">
        <strong>Secondary plot canvas</strong>
        <p class="mini">
          It computes the exact convolution <span style="font-family:var(--mono)">R_exact(E)=∫ g(E−E0)W(E0)dE0</span> and compares it to
          <span style="font-family:var(--mono)">R_delta(E)=W(E)</span>, plotting the <b>relative error</b> across the energy range.
          This is the quantitative confirmation that δ-approx is good for the chosen parameters.
        </p>
      </div>

      <h3>Interactive controls (what changes and why)</h3>
      <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted)">
        <li><b>T₂ slider:</b> changes Lorentzian width (<span style="font-family:var(--mono)">ΔE=h/(πT₂)</span>). Smaller <span style="font-family:var(--mono)">T₂</span> broadens <span style="font-family:var(--mono)">g</span> and increases error.</li>
        <li><b>T slider:</b> changes thermal scale <span style="font-family:var(--mono)">kT</span> and thus the smoothness of <span style="font-family:var(--mono)">f(E)</span> (and <span style="font-family:var(--mono)">n_B(E)</span> in absorption mode).</li>
        <li><b>Process select:</b> switches the weight <span style="font-family:var(--mono)">W(E)</span> between emission-like and thermal-absorption-like forms. All plots update.</li>
      </ul>

      <div class="callout mist">
        <strong>Note about “example values” in plots</strong>
        <p class="mini" style="margin-top:8px">
          The problem asks to compare widths for GaAs; it does not fully specify carrier densities or quasi-Fermi levels.
          The plotted <span style="font-family:var(--mono)">f(E)</span> and <span style="font-family:var(--mono)">ρ(E)</span> are therefore standard, smooth, GaAs-like <b>example</b> models chosen to demonstrate the width criterion.
          The validity conclusion is driven primarily by the strong scale separation <span style="font-family:var(--mono)">ΔE ≪ kT</span>, which is robust.
        </p>
      </div>
    </section>
  </article>
</main>

<footer>
  <div>
    Built with vanilla HTML/CSS/JS. Equations are plain text (copyable). Plots are rendered on &lt;canvas&gt; with high-DPI handling and responsive resizing.
  </div>
</footer>

<script>
/* =========================
   Copy buttons
========================= */
(function(){
  function copyText(t){
    navigator.clipboard.writeText(t).then(()=>toast("Copied ✓")).catch(()=>toast("Copy failed"));
  }
  function toast(msg){
    const el=document.createElement("div");
    el.textContent=msg;
    el.style.position="fixed";
    el.style.left="50%";
    el.style.bottom="18px";
    el.style.transform="translateX(-50%)";
    el.style.padding="10px 12px";
    el.style.border="1px solid rgba(255,255,255,.15)";
    el.style.background="rgba(0,0,0,.65)";
    el.style.backdropFilter="blur(10px)";
    el.style.borderRadius="999px";
    el.style.color="#e9eef6";
    el.style.fontSize="12px";
    el.style.zIndex="9999";
    el.style.boxShadow="0 10px 30px rgba(0,0,0,.35)";
    document.body.appendChild(el);
    setTimeout(()=>{el.style.opacity="0"; el.style.transition="opacity .25s ease";}, 900);
    setTimeout(()=>{el.remove();}, 1250);
  }
  document.querySelectorAll("button.copy").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const tgt = btn.getAttribute("data-copy-target");
      const txt = btn.getAttribute("data-copy-text");
      if(txt){ copyText(txt); return; }
      if(tgt){
        const node = document.getElementById(tgt);
        if(node) copyText(node.textContent.trim());
      }
    });
  });
})();

/* =========================
   Math / physics helpers
========================= */
const CONST = {
  h_Js: 6.62607015e-34,
  h_eVs: 4.135667696e-15,
  kB_eV: 8.617333262145e-5,
  Eg_GaAs_eV: 1.424 // typical at 300 K; used only as reference for plotting window
};

function lorentz(x, gamma){
  // normalized Lorentzian in x with FWHM = gamma
  // L(x) = (1/π) * ( (gamma/2) / (x^2 + (gamma/2)^2 ) )
  const g2 = gamma/2;
  return (1/Math.PI) * (g2 / (x*x + g2*g2));
}

function clamp(a, lo, hi){ return Math.max(lo, Math.min(hi, a)); }

/* =========================
   Plotting utilities (canvas)
========================= */
function setupCanvas(canvas){
  const ctx = canvas.getContext("2d");
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.round(rect.width * dpr);
    canvas.height = Math.round(rect.height * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  }
  resize();
  return {ctx, resize};
}

function niceTicks(min, max, count){
  const span = max - min;
  if(span <= 0) return [min];
  const raw = span / count;
  const pow10 = Math.pow(10, Math.floor(Math.log10(raw)));
  const r = raw / pow10;
  let step;
  if(r < 1.5) step = 1 * pow10;
  else if(r < 3.5) step = 2 * pow10;
  else if(r < 7.5) step = 5 * pow10;
  else step = 10 * pow10;
  const start = Math.ceil(min / step) * step;
  const ticks = [];
  for(let v=start; v<=max+1e-12; v+=step) ticks.push(v);
  return ticks;
}

function drawAxes(ctx, box, xlim, ylim, opts){
  const {x, y, w, h} = box;
  const padL = opts.padL ?? 56, padR = opts.padR ?? 16, padT = opts.padT ?? 28, padB = opts.padB ?? 44;
  const px0 = x + padL, px1 = x + w - padR;
  const py0 = y + padT, py1 = y + h - padB;

  // background
  ctx.save();
  ctx.fillStyle = "rgba(0,0,0,.18)";
  ctx.fillRect(x, y, w, h);

  // title
  ctx.fillStyle = "rgba(233,238,246,.95)";
  ctx.font = "600 14px ui-sans-serif, system-ui";
  ctx.fillText(opts.title ?? "", x + 12, y + 18);

  // mapping
  const xToPx = (X)=> px0 + (X - xlim[0])/(xlim[1]-xlim[0])*(px1-px0);
  const yToPx = (Y)=> py1 - (Y - ylim[0])/(ylim[1]-ylim[0])*(py1-py0);

  // grid + ticks
  const xt = niceTicks(xlim[0], xlim[1], 6);
  const yt = niceTicks(ylim[0], ylim[1], 5);

  ctx.strokeStyle = "rgba(255,255,255,.07)";
  ctx.lineWidth = 1;

  // vertical grid
  xt.forEach(v=>{
    const px = xToPx(v);
    ctx.beginPath();
    ctx.moveTo(px, py0);
    ctx.lineTo(px, py1);
    ctx.stroke();
  });
  // horizontal grid
  yt.forEach(v=>{
    const py = yToPx(v);
    ctx.beginPath();
    ctx.moveTo(px0, py);
    ctx.lineTo(px1, py);
    ctx.stroke();
  });

  // axes
  ctx.strokeStyle = "rgba(255,255,255,.20)";
  ctx.beginPath();
  ctx.moveTo(px0, py0);
  ctx.lineTo(px0, py1);
  ctx.lineTo(px1, py1);
  ctx.stroke();

  // tick labels
  ctx.fillStyle = "rgba(168,179,197,.95)";
  ctx.font = "12px ui-sans-serif, system-ui";
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  xt.forEach(v=>{
    const px = xToPx(v);
    ctx.fillText(formatTick(v, opts.xTickFmt), px, py1 + 8);
  });
  ctx.textAlign = "right";
  ctx.textBaseline = "middle";
  yt.forEach(v=>{
    const py = yToPx(v);
    ctx.fillText(formatTick(v, opts.yTickFmt), px0 - 8, py);
  });

  // axis labels
  ctx.fillStyle = "rgba(233,238,246,.9)";
  ctx.font = "12px ui-sans-serif, system-ui";
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";
  ctx.fillText(opts.xLabel ?? "", (px0+px1)/2, y + h - 8);

  // y label rotated
  ctx.save();
  ctx.translate(x + 14, (py0+py1)/2);
  ctx.rotate(-Math.PI/2);
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  ctx.fillText(opts.yLabel ?? "", 0, 0);
  ctx.restore();

  ctx.restore();

  return {px0, px1, py0, py1, xToPx, yToPx};
}

function formatTick(v, fmt){
  if(typeof fmt === "function") return fmt(v);
  // default: trim
  const abs = Math.abs(v);
  if(abs >= 100) return v.toFixed(0);
  if(abs >= 10) return v.toFixed(1);
  if(abs >= 1) return v.toFixed(2);
  return v.toFixed(3);
}

function drawLine(ctx, map, xs, ys, style){
  ctx.save();
  ctx.strokeStyle = style.stroke ?? "rgba(125,211,252,.95)";
  ctx.lineWidth = style.width ?? 2;
  ctx.setLineDash(style.dash ?? []);
  ctx.beginPath();
  for(let i=0;i<xs.length;i++){
    const px = map.xToPx(xs[i]);
    const py = map.yToPx(ys[i]);
    if(i===0) ctx.moveTo(px, py);
    else ctx.lineTo(px, py);
  }
  ctx.stroke();
  ctx.restore();
}

function drawLegend(ctx, box, items){
  const x = box.x + 12, y = box.y + 30;
  ctx.save();
  ctx.font = "12px ui-sans-serif, system-ui";
  ctx.textAlign = "left";
  ctx.textBaseline = "middle";
  let yy = y;
  items.forEach(it=>{
    ctx.strokeStyle = it.stroke;
    ctx.lineWidth = 3;
    ctx.setLineDash(it.dash ?? []);
    ctx.beginPath();
    ctx.moveTo(x, yy);
    ctx.lineTo(x + 18, yy);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = "rgba(233,238,246,.90)";
    ctx.fillText(it.label, x + 26, yy);
    yy += 16;
  });
  ctx.restore();
}

/* =========================
   Models for f(E), ρ(E), W(E)
========================= */
function feBoltzmann(E, Eg, T){
  // Example nondegenerate electron occupation factor above gap:
  // f(E) ~ exp(-(E - Eg)/kT), normalized later
  const kT = CONST.kB_eV * T;
  if(E < Eg) return 0;
  return Math.exp(-(E - Eg)/kT);
}

function rhoJDOS(E, Eg){
  // Example 3D direct-gap joint DOS near edge: ρ(E) ∝ √(E - Eg)
  if(E <= Eg) return 0;
  return Math.sqrt(E - Eg);
}

function nBose(E, T){
  // photon occupation at energy E (eV) at temperature T (K)
  const kT = CONST.kB_eV * T;
  const x = E / kT;
  if(x > 200) return Math.exp(-x); // avoid overflow, good approximation
  const ex = Math.exp(x);
  return 1/(ex - 1);
}

function normalizeArray(arr){
  let m = 0;
  for(const v of arr) if(v > m) m = v;
  if(m <= 0) return arr.map(_=>0);
  return arr.map(v=>v/m);
}

/* =========================
   Convolution check: R_exact(E) = ∫ L(E-E0) W(E0) dE0
   with L normalized in energy: ∫ L dE = 1
========================= */
function convolveLorentz(Egrid, W, gammaE){
  const N = Egrid.length;
  const R = new Array(N).fill(0);
  // simple numerical quadrature (Riemann sum) with uniform grid spacing
  const dE = (Egrid[N-1] - Egrid[0])/(N-1);
  for(let i=0;i<N;i++){
    let sum = 0;
    const Ei = Egrid[i];
    for(let j=0;j<N;j++){
      const kernel = lorentz(Ei - Egrid[j], gammaE); // 1/eV
      sum += kernel * W[j];
    }
    R[i] = sum * dE; // dimensionless if W is dimensionless
  }
  return R;
}

/* =========================
   Diagram drawing
========================= */
function drawDiagram(ctx, w, h, state){
  ctx.clearRect(0,0,w,h);

  // panel background
  ctx.fillStyle = "rgba(0,0,0,.18)";
  ctx.fillRect(0,0,w,h);

  // title
  ctx.fillStyle = "rgba(233,238,246,.95)";
  ctx.font = "600 14px ui-sans-serif, system-ui";
  ctx.fillText("Physical setup: broadened interband transition + sampling approximation", 12, 18);

  // coordinate frame
  const margin = 18;
  const x0 = margin, y0 = 44, x1 = w - margin, y1 = h - margin;

  // left: band diagram
  const bandW = Math.min(260, (x1-x0)*0.42);
  const bx0 = x0, bx1 = x0 + bandW, by0 = y0, by1 = y1;

  // draw band box
  ctx.strokeStyle = "rgba(255,255,255,.14)";
  ctx.strokeRect(bx0, by0, bandW, by1-by0);

  // conduction and valence bands
  const midY = (by0+by1)/2;
  ctx.strokeStyle = "rgba(125,211,252,.85)";
  ctx.lineWidth = 2;

  // valence band curve
  ctx.beginPath();
  for(let i=0;i<=100;i++){
    const t = i/100;
    const x = bx0 + 18 + t*(bandW-36);
    const y = midY + 70 - 20*Math.sin(t*Math.PI);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // conduction band curve
  ctx.strokeStyle = "rgba(167,139,250,.85)";
  ctx.beginPath();
  for(let i=0;i<=100;i++){
    const t = i/100;
    const x = bx0 + 18 + t*(bandW-36);
    const y = midY - 70 + 20*Math.sin(t*Math.PI);
    if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
  }
  ctx.stroke();

  // Eg arrow
  const ax = bx1 - 38;
  ctx.strokeStyle = "rgba(233,238,246,.80)";
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(ax, midY+55);
  ctx.lineTo(ax, midY-55);
  ctx.stroke();
  // arrow heads
  ctx.beginPath();
  ctx.moveTo(ax-5, midY-50); ctx.lineTo(ax, midY-55); ctx.lineTo(ax+5, midY-50);
  ctx.moveTo(ax-5, midY+50); ctx.lineTo(ax, midY+55); ctx.lineTo(ax+5, midY+50);
  ctx.stroke();

  ctx.fillStyle = "rgba(233,238,246,.90)";
  ctx.font = "12px ui-sans-serif, system-ui";
  ctx.fillText("Conduction band", bx0+14, by0+18);
  ctx.fillText("Valence band", bx0+14, by1-10);
  ctx.fillText("Eg", ax+10, midY);

  // transition arrow
  const tx = bx0 + bandW*0.45;
  ctx.strokeStyle = "rgba(52,211,153,.90)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(tx, midY+45);
  ctx.lineTo(tx, midY-45);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(tx-6, midY-38); ctx.lineTo(tx, midY-45); ctx.lineTo(tx+6, midY-38);
  ctx.stroke();
  ctx.fillText("Interband transition (E0)", tx-72, midY-58);

  // right: kernel sampling cartoon
  const rx0 = bx1 + 16, rx1 = x1, ry0 = y0, ry1 = y1;
  ctx.strokeStyle = "rgba(255,255,255,.14)";
  ctx.strokeRect(rx0, ry0, rx1-rx0, ry1-ry0);

  const cx0 = rx0 + 40, cx1 = rx1 - 18, cy0 = ry0 + 26, cy1 = ry1 - 42;

  // axes
  ctx.strokeStyle = "rgba(255,255,255,.20)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(cx0, cy1);
  ctx.lineTo(cx1, cy1);
  ctx.moveTo(cx0, cy1);
  ctx.lineTo(cx0, cy0);
  ctx.stroke();

  ctx.fillStyle = "rgba(168,179,197,.95)";
  ctx.font = "12px ui-sans-serif, system-ui";
  ctx.fillText("Energy E", (cx0+cx1)/2, ry1-16);
  ctx.save();
  ctx.translate(rx0+14, (cy0+cy1)/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText("Amplitude", 0, 0);
  ctx.restore();

  // draw slow W(E) curve
  const N = 160;
  const Eg = CONST.Eg_GaAs_eV;
  const Emin = Eg + 0.00;
  const Emax = Eg + 0.10;
  const T = state.T;
  const gammaE = state.gammaE;

  const W = [];
  const Es = [];
  for(let i=0;i<N;i++){
    const t = i/(N-1);
    const E = Emin + t*(Emax-Emin);
    Es.push(E);
    let wv = feBoltzmann(E, Eg, T) * rhoJDOS(E, Eg);
    if(state.mode === "absorption") wv *= nBose(E, T);
    W.push(wv);
  }
  const Wn = normalizeArray(W);

  ctx.strokeStyle = "rgba(125,211,252,.85)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<N;i++){
    const t = i/(N-1);
    const px = cx0 + t*(cx1-cx0);
    const py = cy1 - Wn[i]*(cy1-cy0);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.stroke();

  // draw narrow kernel centered at E*
  const Estar = Eg + 0.04;
  const L = [];
  for(let i=0;i<N;i++){
    const E = Es[i];
    L.push(lorentz(E-Estar, gammaE));
  }
  const Ln = normalizeArray(L);

  ctx.strokeStyle = "rgba(167,139,250,.85)";
  ctx.setLineDash([6,4]);
  ctx.beginPath();
  for(let i=0;i<N;i++){
    const t = i/(N-1);
    const px = cx0 + t*(cx1-cx0);
    const py = cy1 - Ln[i]*(cy1-cy0);
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.stroke();
  ctx.setLineDash([]);

  // sampling arrow / label
  const pxStar = cx0 + ((Estar-Emin)/(Emax-Emin))*(cx1-cx0);
  ctx.strokeStyle = "rgba(52,211,153,.9)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(pxStar, cy1);
  ctx.lineTo(pxStar, cy0 + 10);
  ctx.stroke();
  ctx.fillStyle = "rgba(233,238,246,.90)";
  ctx.fillText("Kernel g(E;E*) narrow → R(E*) ≈ W(E*)", rx0+18, ry0+18);

  // legend
  ctx.fillStyle = "rgba(233,238,246,.90)";
  ctx.font = "12px ui-sans-serif, system-ui";
  ctx.fillText("W(E) (slow)", rx1-122, ry0+46);
  ctx.fillStyle = "rgba(233,238,246,.90)";
  ctx.fillText("g(E;E*) (narrow)", rx1-162, ry0+64);

  // color swatches
  ctx.strokeStyle = "rgba(125,211,252,.85)";
  ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(rx1-150, ry0+46); ctx.lineTo(rx1-130, ry0+46); ctx.stroke();
  ctx.strokeStyle = "rgba(167,139,250,.85)";
  ctx.setLineDash([6,4]);
  ctx.beginPath(); ctx.moveTo(rx1-190, ry0+64); ctx.lineTo(rx1-170, ry0+64); ctx.stroke();
  ctx.setLineDash([]);
}

/* =========================
   Main + secondary plots
========================= */
function drawMainPlot(ctx, w, h, state){
  ctx.clearRect(0,0,w,h);

  const Eg = CONST.Eg_GaAs_eV;
  const Emin = Eg + 0.00;
  const Emax = Eg + 0.10; // 100 meV window
  const N = 600;
  const Es = new Array(N);
  const fe = new Array(N);
  const rho = new Array(N);

  for(let i=0;i<N;i++){
    const t = i/(N-1);
    const E = Emin + t*(Emax-Emin);
    Es[i]=E;
    fe[i]=feBoltzmann(E, Eg, state.T);
    rho[i]=rhoJDOS(E, Eg);
  }

  const fen = normalizeArray(fe);
  const rhon = normalizeArray(rho);

  // Lorentzian centered at E* (choose near middle)
  const Estar = Eg + 0.04;
  const g = new Array(N);
  for(let i=0;i<N;i++){
    g[i]=lorentz(Es[i]-Estar, state.gammaE); // 1/eV
  }
  const gn = normalizeArray(g);

  // determine y-limits
  const ylim = [0, 1.05];
  const xlim = [Emin-Eg, Emax-Eg]; // plot relative to Eg in eV

  const map = drawAxes(ctx, {x:0,y:0,w,h}, xlim, ylim, {
    title: "Width comparison: Lorentzian g(E;E*) vs occupation f(E) and joint DOS ρ(E)",
    xLabel: "Excess photon energy  (E − Eg)  [eV]",
    yLabel: "Normalized amplitude  [a.u.]",
    xTickFmt: (v)=> (v*1000).toFixed(0), // show meV
    yTickFmt: (v)=> v.toFixed(1)
  });

  // draw lines
  const xs = Es.map(E=>E-Eg);
  drawLine(ctx, map, xs, gn, {stroke:"rgba(167,139,250,.90)", width:2.5, dash:[7,4]});
  drawLine(ctx, map, xs, fen, {stroke:"rgba(125,211,252,.92)", width:2.5});
  drawLine(ctx, map, xs, rhon, {stroke:"rgba(52,211,153,.90)", width:2.5, dash:[2,0]});

  // annotate FWHM of g
  const half = 0.5;
  // find indices where gn crosses half around center
  let iPeak = 0; for(let i=1;i<N;i++) if(gn[i]>gn[iPeak]) iPeak=i;
  let iL = iPeak, iR = iPeak;
  while(iL>0 && gn[iL] > half) iL--;
  while(iR<N-1 && gn[iR] > half) iR++;
  const EL = xs[iL], ER = xs[iR];

  ctx.save();
  ctx.strokeStyle = "rgba(251,191,36,.85)";
  ctx.lineWidth = 2;
  ctx.setLineDash([4,4]);
  ctx.beginPath();
  ctx.moveTo(map.xToPx(EL), map.yToPx(0));
  ctx.lineTo(map.xToPx(EL), map.yToPx(1.05));
  ctx.moveTo(map.xToPx(ER), map.yToPx(0));
  ctx.lineTo(map.xToPx(ER), map.yToPx(1.05));
  ctx.stroke();
  ctx.setLineDash([]);

  ctx.fillStyle = "rgba(251,191,36,.95)";
  ctx.font = "12px ui-sans-serif, system-ui";
  const fwhm_meV = (state.gammaE*1000).toFixed(2);
  ctx.fillText(`g FWHM ≈ ${fwhm_meV} meV`, map.xToPx( (EL+ER)/2 )-30, map.yToPx(1.02));
  ctx.restore();

  drawLegend(ctx, {x:0,y:0,w,h}, [
    {label:"g(E;E*) (Lorentzian, normalized)", stroke:"rgba(167,139,250,.90)", dash:[7,4]},
    {label:"f(E) (thermal example)", stroke:"rgba(125,211,252,.92)"},
    {label:"ρ(E) (joint DOS example)", stroke:"rgba(52,211,153,.90)"}
  ]);

  // small note
  ctx.save();
  ctx.fillStyle = "rgba(168,179,197,.9)";
  ctx.font = "12px ui-sans-serif, system-ui";
  ctx.fillText("Tick labels on x-axis are in meV (relative to Eg).", 12, h-10);
  ctx.restore();
}

function drawSecondaryPlot(ctx, w, h, state){
  ctx.clearRect(0,0,w,h);

  const Eg = CONST.Eg_GaAs_eV;
  const Emin = Eg + 0.00;
  const Emax = Eg + 0.10;
  const N = 320;
  const Es = new Array(N);
  const W = new Array(N);

  for(let i=0;i<N;i++){
    const t = i/(N-1);
    const E = Emin + t*(Emax-Emin);
    Es[i]=E;
    let wv = feBoltzmann(E, Eg, state.T) * rhoJDOS(E, Eg);
    if(state.mode === "absorption") wv *= nBose(E, state.T);
    W[i]=wv;
  }

  // Normalize W to avoid trivial scaling effects in error
  const Wn = normalizeArray(W);

  const R = convolveLorentz(Es, Wn, state.gammaE);
  // normalize R to compare shapes
  const Rn = normalizeArray(R);

  const relErr = new Array(N);
  let maxErr = 0;
  for(let i=0;i<N;i++){
    const denom = Math.max(1e-6, Wn[i]);
    relErr[i] = (Rn[i] - Wn[i]) / denom;
    maxErr = Math.max(maxErr, Math.abs(relErr[i]));
  }

  // axes (error plot)
  const xlim = [0, (Emax-Eg)]; // in eV, displayed in meV in ticks
  const ylim = [-0.20, 0.20]; // adjustable-ish
  const map = drawAxes(ctx, {x:0,y:0,w,h}, xlim, ylim, {
    title: "Quantitative check: relative error of δ-approximation",
    xLabel: "Excess photon energy  (E − Eg)  [eV]",
    yLabel: "Relative error  (R_exact − R_delta)/R_delta  [–]",
    xTickFmt: (v)=> (v*1000).toFixed(0),
    yTickFmt: (v)=> v.toFixed(2)
  });

  const xs = Es.map(E=>E-Eg);

  // draw zero line
  ctx.save();
  ctx.strokeStyle = "rgba(255,255,255,.20)";
  ctx.setLineDash([4,4]);
  ctx.beginPath();
  ctx.moveTo(map.xToPx(xlim[0]), map.yToPx(0));
  ctx.lineTo(map.xToPx(xlim[1]), map.yToPx(0));
  ctx.stroke();
  ctx.restore();

  // error curve
  drawLine(ctx, map, xs, relErr, {stroke:"rgba(251,191,36,.90)", width:2.5});

  // overlay W and R for context (scaled into a small band at top)
  // map them into y in [0.08,0.18] just for legend context
  const yBand0 = 0.08, yBand1 = 0.18;
  const Wband = Wn.map(v=> yBand0 + v*(yBand1-yBand0));
  const Rband = Rn.map(v=> yBand0 + v*(yBand1-yBand0));
  drawLine(ctx, map, xs, Wband, {stroke:"rgba(125,211,252,.65)", width:2, dash:[3,3]});
  drawLine(ctx, map, xs, Rband, {stroke:"rgba(167,139,250,.65)", width:2, dash:[8,4]});

  drawLegend(ctx, {x:0,y:0,w,h}, [
    {label:"Relative error", stroke:"rgba(251,191,36,.90)"},
    {label:"W(E) (scaled band)", stroke:"rgba(125,211,252,.65)", dash:[3,3]},
    {label:"R_exact(E)=g*W (scaled band)", stroke:"rgba(167,139,250,.65)", dash:[8,4]}
  ]);

  // KPI update
  state.maxErr = maxErr;
}

/* =========================
   Wiring + responsive resize
========================= */
const cDiagram = document.getElementById("cDiagram");
const cMain = document.getElementById("cMain");
const cSecondary = document.getElementById("cSecondary");

const d0 = setupCanvas(cDiagram);
const d1 = setupCanvas(cMain);
const d2 = setupCanvas(cSecondary);

const t2Slider = document.getElementById("t2Slider");
const tempSlider = document.getElementById("tempSlider");
const modeSelect = document.getElementById("modeSelect");

const t2Val = document.getElementById("t2Val");
const tVal = document.getElementById("tVal");
const modeVal = document.getElementById("modeVal");

const kpiDnu = document.getElementById("kpiDnu");
const kpiDe = document.getElementById("kpiDe");
const kpiErr = document.getElementById("kpiErr");

function computeState(){
  const T2_ps = parseFloat(t2Slider.value);
  const T = parseFloat(tempSlider.value);
  const mode = modeSelect.value;

  const T2_s = T2_ps * 1e-12;
  const dnu = 1/(Math.PI * T2_s); // Hz
  const dE_eV = (CONST.h_eVs * dnu); // eV
  const gammaE = dE_eV; // FWHM in eV

  return {T2_ps, T, mode, dnu, dE_eV, gammaE, maxErr:0};
}

function render(){
  const state = computeState();

  // labels
  t2Val.textContent = state.T2_ps.toFixed(2);
  tVal.textContent = state.T.toFixed(0);
  modeVal.textContent = (state.mode === "emission") ? "Spontaneous emission" : "Absorption (thermal equilibrium)";

  // KPIs
  const dnu_GHz = state.dnu/1e9;
  kpiDnu.textContent = dnu_GHz.toFixed(2) + " GHz";
  kpiDe.textContent = (state.dE_eV*1000).toFixed(3) + " meV";

  // draw
  drawDiagram(d0.ctx, cDiagram.clientWidth, cDiagram.clientHeight, state);
  drawMainPlot(d1.ctx, cMain.clientWidth, cMain.clientHeight, state);
  drawSecondaryPlot(d2.ctx, cSecondary.clientWidth, cSecondary.clientHeight, state);

  kpiErr.textContent = (state.maxErr*100).toFixed(2) + " %";
}

function resizeAll(){
  d0.resize(); d1.resize(); d2.resize();
  render();
}

[t2Slider, tempSlider, modeSelect].forEach(el=>{
  el.addEventListener("input", render);
  el.addEventListener("change", render);
});

window.addEventListener("resize", resizeAll);

// initial render
render();

/* =========================
   Small accessibility nicety: smooth scroll
========================= */
document.documentElement.style.scrollBehavior = "smooth";
</script>
</body>
</html>
