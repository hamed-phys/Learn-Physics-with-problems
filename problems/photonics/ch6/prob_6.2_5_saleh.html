<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Retardation in Total Internal Reflection (TE vs TM) — Glass–Air Interface</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#101827;
      --card:#0f1a2b;
      --text:#e8eefc;
      --muted:#b9c3da;
      --faint:#7f8aa3;
      --line:#22304a;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(900px 600px at 20% 10%, rgba(125,211,252,.12), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(167,139,250,.10), transparent 55%),
        radial-gradient(900px 600px at 70% 80%, rgba(52,211,153,.08), transparent 60%),
        linear-gradient(180deg, #070a10, var(--bg) 40%, #070a10);
      line-height:1.55;
    }

    header{
      position:relative;
      padding:28px 18px 8px;
      overflow:hidden;
    }
    header .wrap{
      max-width:1200px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.6fr .9fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      header .wrap{grid-template-columns:1fr}
    }
    h1{
      margin:0 0 10px;
      font-size: clamp(1.6rem, 2.6vw, 2.35rem);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      max-width:70ch;
    }

    .mini-toc{
      position:sticky;
      top:14px;
      align-self:start;
      background: rgba(16,24,39,.78);
      border:1px solid rgba(34,48,74,.8);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      padding:14px 14px 12px;
    }
    .mini-toc h2{
      font-size:.95rem;
      margin:0 0 10px;
      color:var(--text);
      letter-spacing:.2px;
    }
    .mini-toc a{
      display:block;
      padding:7px 10px;
      border-radius:12px;
      color:var(--muted);
      text-decoration:none;
      border:1px solid transparent;
      transition: transform .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
      font-size:.92rem;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .mini-toc a:hover{
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.22);
      color:var(--text);
      transform: translateY(-1px);
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 10px 18px 42px;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
      .mini-toc{position:relative; top:auto}
    }

    section, article{
      background: rgba(16,24,39,.62);
      border:1px solid rgba(34,48,74,.78);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:18px 18px 16px;
      backdrop-filter: blur(8px);
    }

    section h2{
      margin:0 0 10px;
      font-size:1.22rem;
      letter-spacing:.2px;
    }
    h3{
      margin:14px 0 8px;
      font-size:1.05rem;
      letter-spacing:.2px;
    }
    p{margin:10px 0; color:var(--text)}
    ul{margin:10px 0 10px 20px; color:var(--text)}
    li{margin:6px 0}
    .muted{color:var(--muted)}
    .faint{color:var(--faint)}
    .hr{
      height:1px;
      background: linear-gradient(90deg, transparent, rgba(125,211,252,.22), rgba(167,139,250,.18), transparent);
      margin:16px 0;
    }

    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
    }
    @media (max-width: 720px){
      .grid2{grid-template-columns:1fr}
    }

    .callout{
      border:1px solid rgba(34,48,74,.9);
      background: rgba(15,26,43,.55);
      border-radius:16px;
      padding:12px 12px 10px;
    }
    .callout strong{color:var(--text)}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(125,211,252,.25);
      background: rgba(125,211,252,.10);
      color:var(--text);
      font-size:.86rem;
      margin: 2px 6px 6px 0;
      user-select:none;
    }

    .eq{
      margin:10px 0;
      background: rgba(7,10,16,.55);
      border:1px solid rgba(34,48,74,.9);
      border-radius:14px;
      padding:10px 10px 8px;
      overflow:auto;
      position:relative;
    }
    .eq pre{
      margin:0;
      font-family:var(--mono);
      font-size:.93rem;
      color: #eaf2ff;
      white-space:pre;
    }
    .copyBtn{
      position:absolute;
      top:8px;
      right:8px;
      border:1px solid rgba(125,211,252,.35);
      background: rgba(125,211,252,.12);
      color: var(--text);
      padding:6px 10px;
      border-radius:12px;
      cursor:pointer;
      font-size:.86rem;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .copyBtn:hover{
      transform: translateY(-1px);
      background: rgba(125,211,252,.18);
      border-color: rgba(125,211,252,.55);
    }
    .copyNote{
      font-size:.86rem;
      color:var(--muted);
      margin-top:6px;
    }

    .vizPanel{
      padding:14px;
      display:grid;
      gap:12px;
    }
    figure{
      margin:0;
      background: rgba(7,10,16,.35);
      border:1px solid rgba(34,48,74,.9);
      border-radius:16px;
      padding:10px;
    }
    figcaption{
      margin-top:8px;
      color:var(--muted);
      font-size:.92rem;
    }
    canvas{
      width:100%;
      height:auto;
      display:block;
      border-radius:12px;
      background: rgba(3,6,10,.35);
    }

    .controls{
      display:grid;
      gap:10px;
      padding:12px;
      border:1px solid rgba(34,48,74,.9);
      border-radius:16px;
      background: rgba(15,26,43,.45);
    }
    .row{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    label{
      color:var(--muted);
      font-size:.94rem;
    }
    input[type="range"]{
      width:100%;
      accent-color: #7dd3fc;
    }
    select{
      width:100%;
      padding:10px 10px;
      border-radius:14px;
      border:1px solid rgba(34,48,74,.9);
      background: rgba(7,10,16,.55);
      color: var(--text);
      outline:none;
    }
    .pill{
      font-family:var(--mono);
      font-size:.9rem;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(34,48,74,.9);
      background: rgba(7,10,16,.55);
      color: var(--text);
      min-width: 140px;
      text-align:right;
    }

    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi .box{
      border:1px solid rgba(34,48,74,.9);
      border-radius:16px;
      background: rgba(7,10,16,.40);
      padding:10px 10px 8px;
    }
    .kpi .box .name{color:var(--muted); font-size:.9rem}
    .kpi .box .val{font-family:var(--mono); font-size:1.05rem; margin-top:4px}
    .kpi .box .hint{color:var(--faint); font-size:.85rem; margin-top:2px}

    .note{
      border-left: 3px solid rgba(167,139,250,.75);
      padding-left:12px;
      color:var(--muted);
    }

    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 30px;
      color:var(--faint);
      font-size:.92rem;
    }

    /* subtle entrance */
    section, article, figure, .mini-toc{
      animation: rise .35s ease both;
    }
    @keyframes rise{
      from{opacity:0; transform: translateY(8px)}
      to{opacity:1; transform: translateY(0)}
    }

    /* Print */
    @media print{
      body{background:#fff; color:#000}
      header, main, section, article{box-shadow:none; backdrop-filter:none}
      .mini-toc{display:none}
      canvas{border:1px solid #aaa}
      .copyBtn{display:none}
      section, article{border:1px solid #aaa}
      .eq{border:1px solid #aaa; background:#f6f6f6}
      .callout{border:1px solid #aaa; background:#fafafa}
      .tag{border:1px solid #777; background:#eee}
    }
  </style>
</head>
<body>
<!DOCTYPE html>
<header>
  <div class="wrap">
    <div>
      <h1>6.2-5 — Retardation Associated with Total Internal Reflection (TE vs TM)</h1>
      <p class="subtitle">
        We compute the <strong>relative phase shift</strong> between TE (s) and TM (p) polarizations caused by
        <strong>total internal reflection</strong> at a glass–air boundary, for an incidence angle
        <span class="tag">θ = 1.2 θ<sub>c</sub></span>
        with <span class="tag">n<sub>glass</sub> = 1.5</span> and <span class="tag">n<sub>air</sub> = 1.0</span>.
      </p>
      <p class="note">
        Key idea: under TIR the reflection coefficients have magnitude 1, but their <em>phases</em> depend on polarization.
        That polarization-dependent phase is what creates “retardation.”
      </p>
    </div>

    <nav class="mini-toc" aria-label="Mini table of contents">
      <h2>On this page</h2>
      <a href="#quick">Quick Summary</a>
      <a href="#part0">PART 0 — Concept Primer</a>
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a href="#part2">PART 2 — Strategy & Tips</a>
      <a href="#part3">PART 3 — Full Solution</a>
      <a href="#part4">PART 4 — Deeper Understanding</a>
      <a href="#part5">PART 5 — Visualization Guide</a>
    </nav>
  </div>
</header>

<main>
  <div class="leftCol">
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li><strong>What it’s about:</strong> Total internal reflection (TIR) produces <em>different reflection phases</em> for TE and TM waves.</li>
        <li><strong>Key physics idea:</strong> In TIR, the transmitted field is evanescent; energy doesn’t transmit, but boundary conditions force a polarization-dependent phase in reflection.</li>
        <li><strong>Critical angle:</strong> θ<sub>c</sub> = arcsin(n<sub>2</sub>/n<sub>1</sub>) for incidence from n<sub>1</sub> to n<sub>2</sub> with n<sub>1</sub> &gt; n<sub>2</sub>.</li>
        <li><strong>Governing equations:</strong> Fresnel reflection coefficients with complex transmitted angle; in TIR |r|=1 and r = e^{iφ}.</li>
        <li><strong>Phase formulas (TIR):</strong> φ<sub>TE</sub> = −2 arctan( a/c ), φ<sub>TM</sub> = −2 arctan( a/(m²c) ) with m = n<sub>2</sub>/n<sub>1</sub>, c = cosθ, a = √(sin²θ − m²).</li>
        <li><strong>Retardation:</strong> Δφ = φ<sub>TM</sub> − φ<sub>TE</sub> (TM relative to TE).</li>
        <li><strong>Numeric result here:</strong> For n<sub>1</sub>=1.5, n<sub>2</sub>=1, θ=1.2θ<sub>c</sub>, we get |Δφ| ≈ <strong>0.785 rad ≈ 45.0°</strong>.</li>
      </ul>
    </section>

    <section id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div class="callout">
          <strong>Core definitions</strong>
          <ul class="muted">
            <li><strong>Refractive index</strong> n (dimensionless): phase speed v = c/n.</li>
            <li><strong>Angle of incidence</strong> θ (rad or °): between incident ray and the surface normal.</li>
            <li><strong>Critical angle</strong> θ<sub>c</sub>: minimum θ for TIR when n<sub>1</sub> &gt; n<sub>2</sub>.</li>
            <li><strong>TE (s) polarization:</strong> electric field ⟂ plane of incidence.</li>
            <li><strong>TM (p) polarization:</strong> electric field ∥ plane of incidence.</li>
            <li><strong>Reflection coefficient</strong> r: complex amplitude ratio E<sub>r</sub>/E<sub>i</sub>.</li>
          </ul>
        </div>

        <div class="callout">
          <strong>Physical meaning</strong>
          <ul class="muted">
            <li>In ordinary reflection (below θ<sub>c</sub>), r can be real (phase 0 or π) or complex depending on materials.</li>
            <li>In <strong>TIR</strong>, there is no propagating transmitted wave: the field in medium 2 decays exponentially (evanescent).</li>
            <li>Even though <strong>|r|=1</strong>, the reflected wave picks up a phase φ that depends on polarization.</li>
            <li>The <strong>difference</strong> between φ<sub>TE</sub> and φ<sub>TM</sub> is a <em>retardation</em>, like a waveplate effect.</li>
          </ul>
        </div>
      </div>

      <h3>Key laws / principles (and when valid)</h3>
      <ul>
        <li><strong>Snell’s law:</strong> n<sub>1</sub> sinθ = n<sub>2</sub> sinθ<sub>t</sub>. Valid for planar interfaces, linear isotropic media.</li>
        <li><strong>Fresnel equations:</strong> Derived from Maxwell boundary conditions (tangential E and H continuous).</li>
        <li><strong>TIR condition:</strong> n<sub>1</sub> &gt; n<sub>2</sub> and θ &gt; θ<sub>c</sub> = arcsin(n<sub>2</sub>/n<sub>1</sub>).</li>
      </ul>

      <h3>Common models / approximations (why we use them)</h3>
      <ul class="muted">
        <li><strong>Lossless dielectrics:</strong> take n real, so energy conservation gives |r|=1 in TIR.</li>
        <li><strong>Plane-wave + planar interface:</strong> simplifies to analytic Fresnel coefficients (good local model for wide beams).</li>
        <li><strong>Ignore surface roughness and absorption:</strong> focuses on pure phase retardation mechanism.</li>
      </ul>

      <h3>Mini intuition examples</h3>
      <ul>
        <li>If θ is just barely above θ<sub>c</sub>, the evanescent field “leans” far into medium 2, and the phase shifts are small but begin to separate for TE/TM.</li>
        <li>If θ → 90°, both phases approach −π (roughly), but their <em>difference</em> tends to shrink for typical index ratios.</li>
      </ul>

      <div class="callout">
        <strong>What to watch for (pitfalls)</strong>
        <ul class="muted">
          <li><strong>Sign conventions:</strong> “TE relative to TM” vs “TM relative to TE” changes the sign of Δφ.</li>
          <li><strong>Angles:</strong> θ<sub>c</sub> is defined via <em>sin</em>, not cos. Use incidence from the high-index side.</li>
          <li><strong>Using wrong Fresnel form:</strong> TE and TM swap numerator/denominator factors of n.</li>
          <li><strong>Complex transmitted angle:</strong> in TIR, cosθ<sub>t</sub> becomes imaginary; that’s the source of phase.</li>
        </ul>
      </div>
    </section>

    <section id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Rewrite the problem (in plain words)</h3>
      <p>
        A plane wave in <strong>glass</strong> (n<sub>1</sub>=1.5) hits a flat boundary with <strong>air</strong> (n<sub>2</sub>=1.0).
        The incidence angle is θ = 1.2θ<sub>c</sub>, where θ<sub>c</sub> is the critical angle for TIR.
        Find the <strong>phase retardation</strong> between the reflected <strong>TE</strong> and <strong>TM</strong> components caused by TIR.
      </p>

      <div class="grid2">
        <div class="callout">
          <strong>Given</strong>
          <ul class="muted">
            <li>n<sub>1</sub> = 1.5 (incident medium: glass)</li>
            <li>n<sub>2</sub> = 1.0 (transmission medium: air)</li>
            <li>θ = 1.2 θ<sub>c</sub></li>
            <li>Lossless, planar interface, plane-wave incidence</li>
          </ul>
        </div>
        <div class="callout">
          <strong>Unknowns / what must be found</strong>
          <ul class="muted">
            <li>φ<sub>TE</sub> (phase of TE reflection coefficient)</li>
            <li>φ<sub>TM</sub> (phase of TM reflection coefficient)</li>
            <li>Retardation Δφ between them (with a clear convention)</li>
          </ul>
        </div>
      </div>

      <h3>Relevant principles (and why they apply)</h3>
      <ul>
        <li><strong>Snell’s law</strong> determines θ<sub>c</sub> and the evanescent nature of transmission when θ&gt;θ<sub>c</sub>.</li>
        <li><strong>Fresnel reflection coefficients</strong> give the polarization-dependent complex reflection amplitude.</li>
        <li><strong>Energy conservation in lossless media</strong> implies |r|=1 in TIR, so r is a pure phase factor e^{iφ}.</li>
      </ul>
      <p class="muted">
        We do <em>not</em> need interference in a multilayer, absorption, or beam optics; this is a single-interface Fresnel/TIR problem.
      </p>

      <div class="callout">
        <strong>Assumptions (explicit)</strong>
        <ul class="muted">
          <li>Linear, isotropic, non-magnetic media (μ ≈ μ<sub>0</sub>).</li>
          <li>Real refractive indices (negligible absorption).</li>
          <li>Perfectly planar interface; monochromatic plane wave; steady state.</li>
          <li>Angles measured from the normal; TE ≡ s, TM ≡ p.</li>
        </ul>
      </div>

      <h3>Possible approaches (compare 2–3)</h3>
      <ul>
        <li><strong>Approach A (best):</strong> Use Fresnel coefficients, substitute complex cosθ<sub>t</sub> in TIR, extract phases. <span class="muted">Fast, standard, transparent.</span></li>
        <li><strong>Approach B:</strong> Use impedance/admittance formulation (optical admittances for s and p) to get reflection phase. <span class="muted">Elegant, good for multilayers.</span></li>
        <li><strong>Approach C:</strong> Derive from Maxwell boundary conditions directly with evanescent transmitted field. <span class="muted">Most fundamental but longer.</span></li>
      </ul>
      <p><strong>Choice:</strong> Approach A — it is the most direct and matches what the problem asks (phase retardation from TIR at a single boundary).</p>
    </section>

    <section id="part2">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>
      <ol>
        <li><strong>Compute θ<sub>c</sub></strong> using Snell’s law (goal: identify the TIR threshold).</li>
        <li><strong>Compute θ</strong> = 1.2θ<sub>c</sub> (goal: confirm θ&gt;θ<sub>c</sub> so TIR applies).</li>
        <li><strong>Introduce m = n<sub>2</sub>/n<sub>1</sub></strong> (goal: keep formulas compact).</li>
        <li><strong>Form the TIR “evanescence parameter”</strong> a = √(sin²θ − m²) (goal: represent the imaginary part of cosθ<sub>t</sub>).</li>
        <li><strong>Write Fresnel r<sub>TE</sub>, r<sub>TM</sub></strong> in a “(real − i real)/(real + i real)” form (goal: extract phase cleanly).</li>
        <li><strong>Extract phases</strong> via (x − iy)/(x + iy) = exp(−2i arctan(y/x)) (goal: get φ<sub>TE</sub>, φ<sub>TM</sub>).</li>
        <li><strong>Compute retardation</strong> Δφ = φ<sub>TM</sub> − φ<sub>TE</sub> (goal: the asked quantity).</li>
        <li><strong>Sanity checks</strong>: |r|=1, limits near θ<sub>c</sub> and large θ, and sign convention.</li>
      </ol>

      <div class="callout">
        <strong>Common mistakes & quick tips</strong>
        <ul class="muted">
          <li>Use incidence from <strong>glass → air</strong> (high → low index) or TIR will not occur.</li>
          <li>Don’t plug a real θ<sub>t</sub> when θ&gt;θ<sub>c</sub>; θ<sub>t</sub> is complex.</li>
          <li>Track which polarization is TE (s) and TM (p). TE uses the “cos − i a” form with <em>c</em>; TM uses <em>m²c</em> in the denominator of the arctan.</li>
        </ul>
      </div>
    </section>

    <section id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Qualitative expectation (before math)</h3>
      <p>
        Under TIR, the reflected wave keeps the same amplitude (|r|=1), but picks up a phase shift φ.
        Because TE and TM apply different boundary conditions (different combinations of E and H tangential continuity),
        their phases differ. Therefore, a beam that contains both TE and TM components becomes <strong>elliptically polarized</strong>
        after reflection (unless it started purely TE or purely TM).
      </p>

      <div class="hr"></div>

      <h3>Step 1 — Critical angle and incidence angle</h3>
      <p>
        Let the incident medium be glass (n<sub>1</sub>=1.5) and the transmitted medium be air (n<sub>2</sub>=1.0).
        The critical angle is
        <strong>θ<sub>c</sub> = arcsin(n<sub>2</sub>/n<sub>1</sub>)</strong>.
      </p>

      <div class="eq" data-copy="theta_c = asin(n2/n1)">
        <button class="copyBtn" type="button">Copy</button>
        <pre>θc = asin(n2/n1)</pre>
        <div class="copyNote">Critical angle for n1 &gt; n2 (angles measured from the normal).</div>
      </div>

      <p>
        Define the index ratio (dimensionless):
        <strong>m = n<sub>2</sub>/n<sub>1</sub></strong>.
      </p>

      <div class="eq" data-copy="m = n2/n1">
        <button class="copyBtn" type="button">Copy</button>
        <pre>m = n2/n1</pre>
      </div>

      <p>
        The given incidence is θ = 1.2θ<sub>c</sub>. With n<sub>1</sub>=1.5 and n<sub>2</sub>=1:
      </p>
      <ul class="muted">
        <li>m = 1/1.5 = 2/3</li>
        <li>θ<sub>c</sub> = arcsin(2/3) ≈ 41.81°</li>
        <li>θ = 1.2θ<sub>c</sub> ≈ 50.17° (indeed &gt; θ<sub>c</sub>, so TIR applies)</li>
      </ul>

      <div class="hr"></div>

      <h3>Step 2 — Handle TIR: the evanescent parameter</h3>
      <p>
        Snell’s law: n<sub>1</sub> sinθ = n<sub>2</sub> sinθ<sub>t</sub>. For θ&gt;θ<sub>c</sub>, sinθ<sub>t</sub>&gt;1, so θ<sub>t</sub> is complex.
        Instead of working with θ<sub>t</sub> directly, we rewrite cosθ<sub>t</sub>:
      </p>
      <p class="muted">
        From sinθ<sub>t</sub> = (n<sub>1</sub>/n<sub>2</sub>) sinθ = (1/m) sinθ, we get
        cos²θ<sub>t</sub> = 1 − sin²θ<sub>t</sub> = 1 − (sin²θ / m²) &lt; 0, hence cosθ<sub>t</sub> = iκ (purely imaginary).
      </p>

      <p>
        A compact real parameter that appears in both polarizations is:
      </p>

      <div class="eq" data-copy="a = sqrt(sin(theta)^2 - m^2)   (valid for theta>theta_c)">
        <button class="copyBtn" type="button">Copy</button>
        <pre>a = sqrt( sin(theta)^2 - m^2 )   (theta &gt; theta_c)</pre>
        <div class="copyNote">a is real and positive in TIR; it measures how “deep” into TIR you are.</div>
      </div>

      <p>
        Also define c = cosθ (real).
      </p>

      <div class="hr"></div>

      <h3>Step 3 — Fresnel reflection coefficients in TIR form</h3>
      <p>
        For incidence from medium 1 to 2, the Fresnel reflection coefficients are:
      </p>

      <div class="eq" data-copy="r_TE = (n1*cosθ - n2*cosθt)/(n1*cosθ + n2*cosθt)\nr_TM = (n2*cosθ - n1*cosθt)/(n2*cosθ + n1*cosθt)">
        <button class="copyBtn" type="button">Copy</button>
        <pre>r_TE = (n1*cosθ - n2*cosθt)/(n1*cosθ + n2*cosθt)
r_TM = (n2*cosθ - n1*cosθt)/(n2*cosθ + n1*cosθt)</pre>
        <div class="copyNote">TE ≡ s polarization; TM ≡ p polarization.</div>
      </div>

      <p>
        In TIR, cosθ<sub>t</sub> is imaginary. Using the parameter a above, one can show these simplify to:
      </p>

      <div class="eq" data-copy="Let m = n2/n1, c = cosθ, a = sqrt(sin^2θ - m^2)\nThen: r_TE = (c - i a)/(c + i a)\n      r_TM = (m^2 c - i a)/(m^2 c + i a)">
        <button class="copyBtn" type="button">Copy</button>
        <pre>Let m = n2/n1, c = cosθ, a = sqrt(sin^2θ - m^2)
Then: r_TE = (c - i a)/(c + i a)
      r_TM = (m^2 c - i a)/(m^2 c + i a)</pre>
      </div>

      <p class="muted">
        Why this form is great: each coefficient is a ratio of complex conjugates, so |r|=1 automatically.
        That means each reflection is a pure phase: r = e^{iφ}.
      </p>

      <h3>Step 4 — Extract the phases</h3>
      <p>
        Use the identity (for real x&gt;0 and y≥0):
      </p>

      <div class="eq" data-copy="(x - i y)/(x + i y) = exp( -2 i arctan(y/x) )">
        <button class="copyBtn" type="button">Copy</button>
        <pre>(x - i y)/(x + i y) = exp( -2 i arctan(y/x) )</pre>
      </div>

      <p>
        Apply it to TE with x=c and y=a:
      </p>

      <div class="eq" data-copy="phi_TE = -2 * arctan( a/c )">
        <button class="copyBtn" type="button">Copy</button>
        <pre>φTE = -2 arctan( a / c )</pre>
      </div>

      <p>
        Apply it to TM with x=m²c and y=a:
      </p>

      <div class="eq" data-copy="phi_TM = -2 * arctan( a/(m^2*c) )">
        <button class="copyBtn" type="button">Copy</button>
        <pre>φTM = -2 arctan( a / (m^2 c) )</pre>
      </div>

      <h3>Step 5 — Retardation between TM and TE</h3>
      <p>
        Define the phase retardation as:
        <strong>Δφ = φ<sub>TM</sub> − φ<sub>TE</sub></strong>
        (TM relative to TE). Then:
      </p>

      <div class="eq" data-copy="Delta_phi = phi_TM - phi_TE = -2[ arctan(a/(m^2 c)) - arctan(a/c) ]">
        <button class="copyBtn" type="button">Copy</button>
        <pre>Δφ = φTM − φTE = −2[ arctan(a/(m^2 c)) − arctan(a/c) ]</pre>
      </div>

      <div class="hr"></div>

      <h3>Step 6 — Plug in numbers</h3>
      <p>
        With n<sub>1</sub>=1.5, n<sub>2</sub>=1.0:
        m = 2/3, θ<sub>c</sub>=arcsin(2/3)≈41.81°, θ=1.2θ<sub>c</sub>≈50.17°.
        Compute:
      </p>
      <ul class="muted">
        <li>c = cosθ ≈ cos(50.17°) ≈ 0.640</li>
        <li>sinθ ≈ 0.768</li>
        <li>a = √(sin²θ − m²) = √(0.768² − (2/3)²) ≈ √(0.589 − 0.444) ≈ 0.381</li>
      </ul>
      <p>
        Then
        φ<sub>TE</sub> = −2 arctan(a/c) and φ<sub>TM</sub> = −2 arctan(a/(m²c)).
        Numerically, this gives approximately:
      </p>
      <ul>
        <li>φ<sub>TE</sub> ≈ −1.074 rad (≈ −61.5°)</li>
        <li>φ<sub>TM</sub> ≈ −1.859 rad (≈ −106.5°)</li>
        <li>Δφ = φ<sub>TM</sub> − φ<sub>TE</sub> ≈ −0.785 rad (≈ −45.0°)</li>
      </ul>

      <div class="callout" style="border-color: rgba(52,211,153,.55); background: rgba(52,211,153,.08);">
        <strong>Final Answer (with convention stated)</strong>
        <div class="eq" data-copy="For n1=1.5 (glass), n2=1.0 (air), θ=1.2 θc:
θc = asin(n2/n1) = asin(2/3) ≈ 41.81°
θ ≈ 50.17°
Phase retardation Δφ = φTM − φTE ≈ −0.785 rad ≈ −45.0°
(Magnitude |Δφ| ≈ 0.785 rad ≈ 45.0°; TE leads TM by ~45°.)">
          <button class="copyBtn" type="button">Copy</button>
          <pre>For n1=1.5 (glass), n2=1.0 (air), θ=1.2 θc:
θc = asin(n2/n1) = asin(2/3) ≈ 41.81°
θ ≈ 50.17°
Phase retardation Δφ = φTM − φTE ≈ −0.785 rad ≈ −45.0°
(Magnitude |Δφ| ≈ 0.785 rad ≈ 45.0°; TE leads TM by ~45°.)</pre>
        </div>
      </div>

      <h3>Sanity checks</h3>
      <ul>
        <li><strong>|r|=1 check:</strong> (x−iy)/(x+iy) has unit magnitude — correct for lossless TIR.</li>
        <li><strong>Units:</strong> phases are dimensionless (radians) — consistent.</li>
        <li><strong>Limiting behavior:</strong> As θ→θ<sub>c</sub><sup>+</sup>, a→0, both φ→0 and Δφ→0 (no retardation right at threshold).</li>
        <li><strong>Physical meaning:</strong> The interface acts like a polarization retarder; a mixed polarization becomes elliptically polarized after reflection.</li>
      </ul>

      <p class="muted">
        Connection to the diagram/plots: the diagram shows the evanescent field in air; the plots show how φ<sub>TE</sub>, φ<sub>TM</sub>, and Δφ vary as θ moves above θ<sub>c</sub>.
      </p>
    </section>

    <section id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Interpreting the final formulas</h3>
      <p>
        The retardation depends primarily on:
        <strong>how far above critical you are</strong> (through <code>a = √(sin²θ − m²)</code>)
        and the <strong>index ratio</strong> <code>m = n2/n1</code>.
      </p>
      <ul class="muted">
        <li><strong>a</strong> increases as θ increases above θ<sub>c</sub>, strengthening the phase shifts.</li>
        <li><strong>TE vs TM difference:</strong> TM effectively replaces c by m²c in the arctan, making its phase generally more negative (larger magnitude) for n<sub>1</sub>&gt;n<sub>2</sub>.</li>
        <li><strong>m² factor:</strong> comes from the different way magnetic field continuity couples to E in TM polarization.</li>
      </ul>

      <h3>Parameter changes (connect to the interactive plots)</h3>
      <ul>
        <li>If you increase <strong>θ/θ<sub>c</sub></strong> (move deeper into TIR), φ<sub>TE</sub> and φ<sub>TM</sub> both move away from 0 (more phase shift), and Δφ typically changes nonlinearly.</li>
        <li>If you increase <strong>n<sub>1</sub></strong> while keeping n<sub>2</sub> fixed, θ<sub>c</sub> gets smaller and the same θ/θ<sub>c</sub> corresponds to a different absolute θ; the retardation curve changes.</li>
        <li>When Δφ ≈ ±π/2, a single reflection can convert 45° linear polarization into near-circular polarization (this is the idea behind Fresnel rhombs, using two reflections to get ~π/2 total).</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p class="muted">
        You can derive the same phases using <strong>optical admittance</strong> (effective wave impedance) for s and p polarizations:
        write the boundary as r = (Y<sub>1</sub> − Y<sub>2</sub>)/(Y<sub>1</sub> + Y<sub>2</sub>), where Y becomes imaginary in TIR.
        The phase then follows from the argument of that complex ratio.
      </p>

      <h3>Concept-check (quick self-test)</h3>
      <ul>
        <li><strong>Q:</strong> Why can |r|=1 yet still have polarization change? <strong>A:</strong> Because polarization depends on <em>relative phase</em> between components, not just amplitude.</li>
        <li><strong>Q:</strong> What physical field exists in air during TIR? <strong>A:</strong> An evanescent field that decays exponentially away from the interface.</li>
        <li><strong>Q:</strong> If the incident wave is purely TE, does retardation matter? <strong>A:</strong> No, because there is no TE–TM phase difference to create ellipticity.</li>
        <li><strong>Q:</strong> What happens to Δφ as θ→θ<sub>c</sub><sup>+</sup>? <strong>A:</strong> Δφ→0 because the evanescent parameter a→0.</li>
      </ul>
    </section>

    <section id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>
      <ul>
        <li><strong>Diagram canvas:</strong> Shows the glass–air interface, incident/reflected rays, the normal, the incidence angle θ, and an indicative evanescent field in air.</li>
        <li><strong>Main plot:</strong> “Reflection phase vs incidence angle” shows φ<sub>TE</sub>(θ) and φ<sub>TM</sub>(θ) (in degrees), for θ from θ<sub>c</sub> to a high angle. A marker indicates the current θ set by the slider.</li>
        <li><strong>Secondary plot:</strong> “Polarization ellipse from retardation” shows the Lissajous ellipse for
          <code>E_TE = cos(ωt)</code> and <code>E_TM = cos(ωt + Δφ)</code> (example equal amplitudes), demonstrating how a phase difference creates ellipticity.</li>
        <li><strong>Interactive control:</strong> Slider changes <strong>k = θ/θ<sub>c</sub></strong>. When k&gt;1, you are in TIR. All canvases update live, including the computed phases and Δφ.</li>
      </ul>
      <p class="muted">
        The plotted symbols match the text:
        n<sub>1</sub>, n<sub>2</sub>, θ<sub>c</sub>, θ, φ<sub>TE</sub>, φ<sub>TM</sub>, and Δφ.
      </p>
    </section>
  </div>

  <aside class="rightCol">
    <article class="vizPanel" aria-label="Interactive visualizations">
      <h2 style="margin:0 0 2px;">Interactive Visualizations</h2>
      <p class="muted" style="margin:0 0 8px;">
        Adjust <strong>k = θ/θ<sub>c</sub></strong> to explore how TIR changes the TE/TM reflection phases and their retardation.
      </p>

      <div class="controls">
        <div class="row">
          <label for="kSlider">Incidence factor k = θ/θc (TIR when k &gt; 1)</label>
          <div class="pill" id="kRead">k = 1.200</div>
        </div>
        <input id="kSlider" type="range" min="1.000" max="1.800" step="0.001" value="1.200" />

        <div class="row">
          <label for="n1Sel">n1 (incident medium)</label>
          <select id="n1Sel">
            <option value="1.33">1.33 (water)</option>
            <option value="1.50" selected>1.50 (glass)</option>
            <option value="1.70">1.70</option>
            <option value="2.00">2.00</option>
          </select>
        </div>
        <div class="row">
          <label for="n2Sel">n2 (transmission medium)</label>
          <select id="n2Sel">
            <option value="1.00" selected>1.00 (air)</option>
            <option value="1.33">1.33 (water)</option>
          </select>
        </div>

        <div class="kpi">
          <div class="box">
            <div class="name">θc</div>
            <div class="val" id="thetaCVal">—</div>
            <div class="hint">critical angle (deg)</div>
          </div>
          <div class="box">
            <div class="name">θ</div>
            <div class="val" id="thetaVal">—</div>
            <div class="hint">incidence (deg)</div>
          </div>
          <div class="box">
            <div class="name">φTE</div>
            <div class="val" id="phiTEVal">—</div>
            <div class="hint">phase (deg)</div>
          </div>
          <div class="box">
            <div class="name">φTM</div>
            <div class="val" id="phiTMVal">—</div>
            <div class="hint">phase (deg)</div>
          </div>
          <div class="box" style="grid-column:1 / span 2;">
            <div class="name">Δφ = φTM − φTE</div>
            <div class="val" id="dphiVal">—</div>
            <div class="hint">retardation (deg). Sign indicates which leads.</div>
          </div>
        </div>
      </div>

      <figure>
        <canvas id="cDiagram" width="900" height="520" aria-label="TIR diagram"></canvas>
        <figcaption>
          Labeled geometry: glass–air interface, incidence angle θ, and evanescent field in air (illustrative).
        </figcaption>
      </figure>

      <figure>
        <canvas id="cMain" width="900" height="560" aria-label="Main plot: phases vs angle"></canvas>
        <figcaption>
          Main plot: TE and TM reflection phases vs incidence angle. Marker shows current θ.
        </figcaption>
      </figure>

      <figure>
        <canvas id="cSecondary" width="900" height="560" aria-label="Secondary plot: polarization ellipse"></canvas>
        <figcaption>
          Secondary plot: example polarization ellipse produced by Δφ (assuming equal TE/TM amplitudes).
        </figcaption>
      </figure>
    </article>
  </aside>
</main>

<footer>
  <div class="hr"></div>
  <p>
    Built as a self-contained learning article (vanilla HTML/CSS/JS). Tip: use the slider to see how the retardation evolves above the critical angle.
  </p>
</footer>

<script>
(function(){
  // ---------- Utility ----------
  const $ = (id)=>document.getElementById(id);
  const rad2deg = (r)=> r*180/Math.PI;
  const deg2rad = (d)=> d*Math.PI/180;

  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

  function setHiDPICanvas(canvas){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    // Maintain aspect ratio from initial intrinsic size
    const cssW = rect.width;
    const aspect = canvas.height / canvas.width;
    const cssH = cssW * aspect;
    canvas.style.height = cssH + "px";
    const w = Math.max(2, Math.floor(cssW * dpr));
    const h = Math.max(2, Math.floor(cssH * dpr));
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w; canvas.height = h;
    }
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {ctx, cssW, cssH, dpr};
  }

  function drawAxes(ctx, box, opts){
    const {x0,y0,w,h} = box;
    const {
      xMin,xMax,yMin,yMax,
      xLabel,yLabel,title,
      grid=true,
      xTicks=6, yTicks=6
    } = opts;

    // background
    ctx.save();
    ctx.translate(x0,y0);
    ctx.clearRect(0,0,w,h);

    // panel
    ctx.fillStyle = "rgba(3,6,10,0.18)";
    ctx.fillRect(0,0,w,h);

    // margins inside plot region
    const ml=56, mr=16, mt=38, mb=46;
    const px0=ml, py0=mt, pw=w-ml-mr, ph=h-mt-mb;

    // grid & ticks
    ctx.lineWidth = 1;
    ctx.strokeStyle = "rgba(34,48,74,0.9)";
    ctx.fillStyle = "rgba(185,195,218,0.92)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";

    function x2p(x){ return px0 + (x-xMin)/(xMax-xMin)*pw; }
    function y2p(y){ return py0 + (1-(y-yMin)/(yMax-yMin))*ph; }

    if(grid){
      // x grid
      for(let i=0;i<=xTicks;i++){
        const xv = xMin + (xMax-xMin)*i/xTicks;
        const xp = x2p(xv);
        ctx.strokeStyle = "rgba(34,48,74,0.55)";
        ctx.beginPath(); ctx.moveTo(xp, py0); ctx.lineTo(xp, py0+ph); ctx.stroke();
        // tick label
        ctx.fillStyle = "rgba(185,195,218,0.92)";
        const s = (Math.abs(xv) >= 10 ? xv.toFixed(0) : xv.toFixed(1));
        ctx.fillText(s, xp-10, py0+ph+18);
      }
      // y grid
      for(let j=0;j<=yTicks;j++){
        const yv = yMin + (yMax-yMin)*j/yTicks;
        const yp = y2p(yv);
        ctx.strokeStyle = "rgba(34,48,74,0.55)";
        ctx.beginPath(); ctx.moveTo(px0, yp); ctx.lineTo(px0+pw, yp); ctx.stroke();
        ctx.fillStyle = "rgba(185,195,218,0.92)";
        const s = (Math.abs(yv) >= 10 ? yv.toFixed(0) : yv.toFixed(1));
        ctx.fillText(s, 6, yp+4);
      }
    }

    // axes border
    ctx.strokeStyle = "rgba(125,211,252,0.20)";
    ctx.lineWidth = 1.2;
    ctx.strokeRect(px0,py0,pw,ph);

    // titles & labels
    ctx.fillStyle = "rgba(232,238,252,0.96)";
    ctx.font = "600 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(title, 14, 22);

    ctx.fillStyle = "rgba(185,195,218,0.95)";
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    // xLabel
    ctx.fillText(xLabel, px0 + pw/2 - ctx.measureText(xLabel).width/2, py0+ph+38);

    // yLabel (rotated)
    ctx.save();
    ctx.translate(18, py0 + ph/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
    ctx.restore();

    ctx.restore();
    return {
      plotRect:{x:x0+56, y:y0+38, w:w-56-16, h:h-38-46},
      x2p:(x)=> (x0+56) + (x-xMin)/(xMax-xMin)*(w-56-16),
      y2p:(y)=> (y0+38) + (1-(y-yMin)/(yMax-yMin))*(h-38-46)
    };
  }

  function drawLegend(ctx, x, y, items){
    ctx.save();
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillStyle = "rgba(232,238,252,0.9)";
    const pad=8, lh=18;
    const w = Math.max(...items.map(it=>ctx.measureText(it.label).width)) + 44;
    const h = items.length*lh + pad*2;
    ctx.fillStyle = "rgba(16,24,39,0.78)";
    ctx.strokeStyle = "rgba(34,48,74,0.9)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    const r=12;
    roundRect(ctx, x, y, w, h, r);
    ctx.fill();
    ctx.stroke();
    for(let i=0;i<items.length;i++){
      const yy = y + pad + i*lh + 12;
      ctx.strokeStyle = items[i].color;
      ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(x+10, yy-4); ctx.lineTo(x+28, yy-4); ctx.stroke();
      ctx.fillStyle = "rgba(232,238,252,0.9)";
      ctx.fillText(items[i].label, x+34, yy);
    }
    ctx.restore();
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function fmtDeg(x){ return (x>=0?"+":"") + x.toFixed(2) + "°"; }
  function fmtDegNoSign(x){ return x.toFixed(2) + "°"; }

  // ---------- Physics core ----------
  function computePhases(n1, n2, k){
    // k = theta/theta_c, theta_c = asin(n2/n1), valid only for n1>n2 and k>=1
    const m = n2/n1;
    const thetaC = Math.asin(clamp(m, -1, 1));
    let theta = k * thetaC;

    // clamp theta to < 89.9° to avoid numeric issues in plotting
    const thetaMax = deg2rad(89.9);
    theta = Math.min(theta, thetaMax);

    const s = Math.sin(theta);
    const c = Math.cos(theta);
    // TIR requires s > m
    const a = Math.sqrt(Math.max(0, s*s - m*m));

    // phases in radians (principal from formula)
    const phiTE = -2 * Math.atan2(a, c);
    const phiTM = -2 * Math.atan2(a, (m*m)*c);

    const dphi = phiTM - phiTE;
    return {n1,n2,m,k,thetaC,theta,phiTE,phiTM,dphi,a,c,s};
  }

  // ---------- Drawing ----------
  function drawDiagram(canvas, state){
    const {ctx, cssW, cssH} = setHiDPICanvas(canvas);
    const W = cssW, H = cssH;
    ctx.clearRect(0,0,W,H);

    // background
    ctx.fillStyle = "rgba(3,6,10,0.18)";
    ctx.fillRect(0,0,W,H);

    const midY = H*0.53;
    const left = 20, right = W-20;

    // Interface
    ctx.strokeStyle = "rgba(125,211,252,0.55)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(left, midY);
    ctx.lineTo(right, midY);
    ctx.stroke();

    // Media labels
    ctx.font = "600 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillStyle = "rgba(232,238,252,0.95)";
    ctx.fillText(`Medium 1 (incident): n1 = ${state.n1.toFixed(2)}`, left+6, midY+22);
    ctx.fillText(`Medium 2: n2 = ${state.n2.toFixed(2)}`, left+6, midY-12);

    // Normal
    const xN = W*0.58;
    ctx.strokeStyle = "rgba(167,139,250,0.6)";
    ctx.lineWidth = 2;
    ctx.setLineDash([6,6]);
    ctx.beginPath();
    ctx.moveTo(xN, midY-160);
    ctx.lineTo(xN, midY+160);
    ctx.stroke();
    ctx.setLineDash([]);

    // Rays
    const theta = state.theta; // from normal
    const L = Math.min(W,H)*0.46;

    // Incident ray endpoint (in medium 1, below interface)
    const incStart = {x: xN - L*Math.sin(theta), y: midY + L*Math.cos(theta)};
    const hit = {x: xN, y: midY};
    const reflEnd = {x: xN + L*Math.sin(theta), y: midY + L*Math.cos(theta)};

    // Incident arrow
    drawArrow(ctx, incStart.x, incStart.y, hit.x, hit.y, "rgba(232,238,252,0.9)");
    // Reflected arrow
    drawArrow(ctx, hit.x, hit.y, reflEnd.x, reflEnd.y, "rgba(232,238,252,0.9)");

    // Evanescent indication in medium 2: decaying sinusoid along interface normal
    const evX0 = xN + 22;
    const evY0 = midY - 6;
    const evLen = 150;
    ctx.strokeStyle = "rgba(52,211,153,0.65)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<=120;i++){
      const t = i/120;
      const y = evY0 - t*evLen;
      const amp = 18*Math.exp(-3.2*t);
      const x = evX0 + amp*Math.sin(2*Math.PI*3*t);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.stroke();

    ctx.fillStyle = "rgba(52,211,153,0.9)";
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText("Evanescent field (decays into medium 2)", evX0+24, midY-110);

    // Angle arc
    const r = 46;
    ctx.strokeStyle = "rgba(251,191,36,0.85)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(xN, midY, r, -Math.PI/2, -Math.PI/2 + theta, false);
    ctx.stroke();
    // arc label
    ctx.fillStyle = "rgba(251,191,36,0.95)";
    ctx.font = "600 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(`θ = ${rad2deg(theta).toFixed(2)}°`, xN + 10, midY + 20);

    // Polarization note
    ctx.fillStyle = "rgba(185,195,218,0.95)";
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText("TE (s): E ⟂ plane of incidence", left+6, midY+52);
    ctx.fillText("TM (p): E ∥ plane of incidence", left+6, midY+70);

    // Title
    ctx.fillStyle = "rgba(232,238,252,0.95)";
    ctx.font = "700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText("TIR Geometry at a Planar Interface", left+6, 22);
  }

  function drawArrow(ctx, x1,y1,x2,y2,color){
    ctx.save();
    ctx.strokeStyle = color;
    ctx.fillStyle = color;
    ctx.lineWidth = 2.4;
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(x2,y2);
    ctx.stroke();
    const ang = Math.atan2(y2-y1, x2-x1);
    const ah = 10;
    ctx.beginPath();
    ctx.moveTo(x2,y2);
    ctx.lineTo(x2 - ah*Math.cos(ang - 0.35), y2 - ah*Math.sin(ang - 0.35));
    ctx.lineTo(x2 - ah*Math.cos(ang + 0.35), y2 - ah*Math.sin(ang + 0.35));
    ctx.closePath();
    ctx.fill();
    ctx.restore();
  }

  function drawMainPlot(canvas, state){
    const {ctx, cssW, cssH} = setHiDPICanvas(canvas);
    const W=cssW, H=cssH;

    const thetaCdeg = rad2deg(state.thetaC);
    const xMin = thetaCdeg;
    const xMax = 89.0;
    // Phase degrees range: typically between 0 and -180
    const yMin = -180;
    const yMax = 0;

    const ax = drawAxes(ctx, {x0:0,y0:0,w:W,h:H}, {
      xMin,xMax,yMin,yMax,
      xLabel:"Incidence angle θ (degrees)",
      yLabel:"Reflection phase φ (degrees)",
      title:"Reflection Phase vs Incidence Angle (Total Internal Reflection)",
      xTicks:7, yTicks:6, grid:true
    });

    // Curves
    const N=300;
    const colTE = "rgba(125,211,252,0.95)";
    const colTM = "rgba(167,139,250,0.95)";
    const colMark = "rgba(251,191,36,0.95)";

    // Compute along theta range using same n1,n2
    ctx.lineWidth = 2.6;

    // TE
    ctx.strokeStyle = colTE;
    ctx.beginPath();
    for(let i=0;i<=N;i++){
      const thDeg = xMin + (xMax-xMin)*i/N;
      const th = deg2rad(thDeg);
      const n1=state.n1, n2=state.n2;
      const m=n2/n1;
      const s=Math.sin(th), c=Math.cos(th);
      const a=Math.sqrt(Math.max(0, s*s - m*m));
      const phiTE = -2*Math.atan2(a,c);
      const y = rad2deg(phiTE);
      const xp=ax.x2p(thDeg), yp=ax.y2p(y);
      if(i===0) ctx.moveTo(xp,yp);
      else ctx.lineTo(xp,yp);
    }
    ctx.stroke();

    // TM
    ctx.strokeStyle = colTM;
    ctx.beginPath();
    for(let i=0;i<=N;i++){
      const thDeg = xMin + (xMax-xMin)*i/N;
      const th = deg2rad(thDeg);
      const n1=state.n1, n2=state.n2;
      const m=n2/n1;
      const s=Math.sin(th), c=Math.cos(th);
      const a=Math.sqrt(Math.max(0, s*s - m*m));
      const phiTM = -2*Math.atan2(a,(m*m)*c);
      const y = rad2deg(phiTM);
      const xp=ax.x2p(thDeg), yp=ax.y2p(y);
      if(i===0) ctx.moveTo(xp,yp);
      else ctx.lineTo(xp,yp);
    }
    ctx.stroke();

    // Marker for current theta
    const thCurDeg = rad2deg(state.theta);
    const phiTEcurDeg = rad2deg(state.phiTE);
    const phiTMcurDeg = rad2deg(state.phiTM);

    ctx.save();
    ctx.strokeStyle = colMark;
    ctx.lineWidth = 1.6;
    ctx.setLineDash([6,6]);
    const xcur = ax.x2p(thCurDeg);
    ctx.beginPath();
    ctx.moveTo(xcur, ax.plotRect.y);
    ctx.lineTo(xcur, ax.plotRect.y + ax.plotRect.h);
    ctx.stroke();
    ctx.setLineDash([]);
    // points
    drawPoint(ctx, ax.x2p(thCurDeg), ax.y2p(phiTEcurDeg), colTE);
    drawPoint(ctx, ax.x2p(thCurDeg), ax.y2p(phiTMcurDeg), colTM);

    // annotate
    ctx.fillStyle = "rgba(232,238,252,0.92)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    const label = `θ=${thCurDeg.toFixed(2)}°`;
    ctx.fillText(label, xcur + 6, ax.plotRect.y + 14);
    ctx.restore();

    drawLegend(ctx, W-210, 50, [
      {label:"TE (s): φTE", color: colTE},
      {label:"TM (p): φTM", color: colTM}
    ]);
  }

  function drawPoint(ctx, x,y,color){
    ctx.save();
    ctx.fillStyle = color;
    ctx.beginPath();
    ctx.arc(x,y,4.2,0,Math.PI*2);
    ctx.fill();
    ctx.restore();
  }

  function drawSecondary(canvas, state){
    const {ctx, cssW, cssH} = setHiDPICanvas(canvas);
    const W=cssW, H=cssH;

    // We'll plot polarization ellipse in Ex-Ey plane (normalized)
    const xMin=-1.2, xMax=1.2, yMin=-1.2, yMax=1.2;

    const ax = drawAxes(ctx, {x0:0,y0:0,w:W,h:H}, {
      xMin,xMax,yMin,yMax,
      xLabel:"E_TE (normalized)",
      yLabel:"E_TM (normalized)",
      title:"Polarization Ellipse from Retardation (Example: equal amplitudes)",
      xTicks:6, yTicks:6, grid:true
    });

    // Lissajous: Ex = cos(t), Ey = cos(t + Δφ)
    const dphi = state.dphi;
    const N=600;
    ctx.lineWidth = 2.6;
    ctx.strokeStyle = "rgba(52,211,153,0.90)";
    ctx.beginPath();
    for(let i=0;i<=N;i++){
      const t = 2*Math.PI*i/N;
      const Ex = Math.cos(t);
      const Ey = Math.cos(t + dphi);
      const x = ax.x2p(Ex);
      const y = ax.y2p(Ey);
      if(i===0) ctx.moveTo(x,y);
      else ctx.lineTo(x,y);
    }
    ctx.stroke();

    // Direction arrow (sense of rotation) using a short segment
    const t0 = 0.0;
    const dt = 0.18;
    const xA = ax.x2p(Math.cos(t0));
    const yA = ax.y2p(Math.cos(t0 + dphi));
    const xB = ax.x2p(Math.cos(t0 + dt));
    const yB = ax.y2p(Math.cos(t0 + dt + dphi));
    drawArrow(ctx, xA, yA, xB, yB, "rgba(251,191,36,0.9)");

    // annotate Δφ
    ctx.fillStyle = "rgba(232,238,252,0.92)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    const txt = `Δφ = φTM − φTE = ${rad2deg(dphi).toFixed(2)}°`;
    ctx.fillText(txt, ax.plotRect.x + 10, ax.plotRect.y + 16);

    // note on meaning
    ctx.fillStyle = "rgba(185,195,218,0.95)";
    ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText("If Δφ = 0° → line; if |Δφ| ≈ 90° → near-circle (equal amplitudes).", ax.plotRect.x + 10, ax.plotRect.y + 34);

    drawLegend(ctx, W-260, 50, [
      {label:"Ellipse: (cos t, cos(t+Δφ))", color:"rgba(52,211,153,0.90)"},
      {label:"Arrow: time direction", color:"rgba(251,191,36,0.9)"}
    ]);
  }

  // ---------- UI + Update ----------
  function updateAll(){
    const k = parseFloat($("kSlider").value);
    const n1 = parseFloat($("n1Sel").value);
    const n2 = parseFloat($("n2Sel").value);

    $("kRead").textContent = `k = ${k.toFixed(3)}`;

    // If n1 <= n2, TIR doesn't occur; still compute but warn visually
    let state = computePhases(n1,n2,k);

    // Compute display
    const thetaCdeg = rad2deg(state.thetaC);
    const thetadeg = rad2deg(state.theta);
    const phiTEdeg = rad2deg(state.phiTE);
    const phiTMdeg = rad2deg(state.phiTM);
    const dphideg = rad2deg(state.dphi);

    $("thetaCVal").textContent = fmtDegNoSign(thetaCdeg);
    $("thetaVal").textContent  = fmtDegNoSign(thetadeg);
    $("phiTEVal").textContent  = fmtDeg(phiTEdeg);
    $("phiTMVal").textContent  = fmtDeg(phiTMdeg);
    $("dphiVal").textContent   = fmtDeg(dphideg);

    // Red hint if TIR not valid
    const tirValid = (n1 > n2) && (Math.sin(state.theta) > (n2/n1) + 1e-12);
    const dphiBox = $("dphiVal").parentElement;
    dphiBox.style.borderColor = tirValid ? "rgba(34,48,74,.9)" : "rgba(251,113,133,.65)";
    dphiBox.style.background = tirValid ? "rgba(7,10,16,.40)" : "rgba(251,113,133,.08)";

    // Draw
    drawDiagram($("cDiagram"), state);
    drawMainPlot($("cMain"), state);
    drawSecondary($("cSecondary"), state);
  }

  // copy buttons
  function setupCopy(){
    document.querySelectorAll(".eq .copyBtn").forEach(btn=>{
      btn.addEventListener("click", async ()=>{
        const eq = btn.closest(".eq");
        const txt = eq.getAttribute("data-copy") || eq.innerText;
        try{
          await navigator.clipboard.writeText(txt.trim());
          const old = btn.textContent;
          btn.textContent = "Copied!";
          setTimeout(()=>btn.textContent=old, 900);
        }catch(e){
          const old = btn.textContent;
          btn.textContent = "Copy failed";
          setTimeout(()=>btn.textContent=old, 1100);
        }
      });
    });
  }

  // Smooth scrolling for TOC
  function setupTOC(){
    document.querySelectorAll('a[href^="#"]').forEach(a=>{
      a.addEventListener("click", (ev)=>{
        const href = a.getAttribute("href");
        if(!href || href.length<2) return;
        const el = document.querySelector(href);
        if(!el) return;
        ev.preventDefault();
        el.scrollIntoView({behavior:"smooth", block:"start"});
        history.replaceState(null, "", href);
      });
    });
  }

  // Resize redraw
  let resizeTimer=null;
  window.addEventListener("resize", ()=>{
    clearTimeout(resizeTimer);
    resizeTimer=setTimeout(updateAll, 80);
  });

  $("kSlider").addEventListener("input", updateAll);
  $("n1Sel").addEventListener("change", updateAll);
  $("n2Sel").addEventListener("change", updateAll);

  setupCopy();
  setupTOC();
  updateAll();
})();
</script>
</body>
</html>
