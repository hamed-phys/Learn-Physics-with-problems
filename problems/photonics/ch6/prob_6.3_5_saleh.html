<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Transmission Through a LiNbO₃ Plate (Birefringence, Walk-off, Retardation)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1630;
      --card:#121b3a;
      --text:#e9ecff;
      --muted:#b9c0ff;
      --faint:#7f89d6;
      --accent:#7cf0ff;
      --accent2:#a9ff9a;
      --warn:#ffd27c;
      --danger:#ff7ca8;
      --line:rgba(255,255,255,0.10);
      --shadow:0 16px 40px rgba(0,0,0,0.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1000px 700px at 20% 10%, rgba(124,240,255,0.10), transparent 60%),
        radial-gradient(900px 600px at 80% 20%, rgba(169,255,154,0.10), transparent 55%),
        radial-gradient(1200px 900px at 50% 90%, rgba(255,124,168,0.08), transparent 60%),
        var(--bg);
      color:var(--text);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding:28px 18px 12px;
      max-width:1200px;
      margin:0 auto;
    }
    .hero{
      display:grid;
      grid-template-columns: 1.4fr 0.9fr;
      gap:18px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .hero{grid-template-columns:1fr}
    }
    .titleCard{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px 18px 16px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .titleCard::before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(700px 200px at 10% 0%, rgba(124,240,255,0.18), transparent 65%),
                  radial-gradient(500px 200px at 80% 20%, rgba(169,255,154,0.14), transparent 60%);
      pointer-events:none;
      filter:saturate(1.1);
    }
    .titleCard > *{position:relative}
    h1{
      margin:0 0 8px;
      font-size: clamp(22px, 2.6vw, 34px);
      letter-spacing:0.2px;
    }
    .subtitle{
      color:var(--muted);
      margin:0;
      font-size: clamp(14px, 1.4vw, 16px);
    }

    .toc{
      background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:14px 14px 10px;
      box-shadow:var(--shadow);
      position:sticky;
      top:12px;
      align-self:start;
    }
    .toc h2{
      margin:0 0 8px;
      font-size:14px;
      color:var(--muted);
      letter-spacing:0.3px;
      text-transform:uppercase;
    }
    .toc a{
      display:block;
      padding:7px 10px;
      border-radius:12px;
      color:var(--text);
      font-size:14px;
      border:1px solid transparent;
    }
    .toc a:hover{
      background:rgba(124,240,255,0.08);
      border-color:rgba(124,240,255,0.20);
      text-decoration:none;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 10px 18px 70px;
      display:grid;
      grid-template-columns: 1fr;
      gap:16px;
    }

    section{
      background:linear-gradient(180deg, rgba(255,255,255,0.05), rgba(255,255,255,0.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      padding:18px;
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    section h2{
      margin:0 0 10px;
      font-size:18px;
      letter-spacing:0.2px;
    }
    section h3{
      margin:14px 0 8px;
      font-size:16px;
      color:var(--muted);
    }
    .grid2{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 900px){
      .grid2{grid-template-columns:1fr}
    }

    .callouts{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
    }
    .box{
      grid-column: span 12;
      background:rgba(18,27,58,0.70);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px 12px 10px;
      position:relative;
      overflow:hidden;
    }
    .box strong{color:var(--text)}
    .box.assumptions{border-left:4px solid var(--warn)}
    .box.keyeq{border-left:4px solid var(--accent)}
    .box.mistakes{border-left:4px solid var(--danger)}
    .box.final{border-left:4px solid var(--accent2)}
    .box p{margin:0 0 6px; color:var(--muted)}
    .box ul{margin:8px 0 0 18px; color:var(--muted)}
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
    }
    @media(max-width:900px){
      .kpiRow{grid-template-columns:1fr 1fr}
    }
    @media(max-width:520px){
      .kpiRow{grid-template-columns:1fr}
    }
    .kpi{
      background:rgba(255,255,255,0.04);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 10px 8px;
    }
    .kpi .label{font-size:12px; color:var(--faint); text-transform:uppercase; letter-spacing:0.4px}
    .kpi .value{font-size:16px; margin-top:4px; font-family:var(--mono)}
    .kpi .hint{font-size:12px; color:var(--muted); margin-top:4px}

    .eqWrap{
      display:flex;
      gap:10px;
      align-items:stretch;
      flex-wrap:wrap;
    }
    pre.eq{
      margin:10px 0 0;
      padding:10px 12px;
      border-radius:14px;
      background:rgba(0,0,0,0.25);
      border:1px solid var(--line);
      overflow:auto;
      font-family:var(--mono);
      font-size:13px;
      color:var(--text);
      flex: 1 1 520px;
      min-width: 280px;
    }
    button.copyBtn{
      appearance:none;
      border:none;
      cursor:pointer;
      border-radius:12px;
      padding:10px 12px;
      color:var(--text);
      background:rgba(124,240,255,0.14);
      border:1px solid rgba(124,240,255,0.28);
      font-weight:600;
      letter-spacing:0.2px;
      transition: transform 160ms ease, background 160ms ease;
      align-self:flex-start;
    }
    button.copyBtn:hover{transform: translateY(-1px); background:rgba(124,240,255,0.18)}
    button.copyBtn:active{transform: translateY(0px) scale(0.99)}
    .small{font-size:13px; color:var(--muted)}
    .muted{color:var(--muted)}
    .hr{
      height:1px; background:var(--line);
      margin:14px 0;
    }

    /* Visualization area */
    figure{
      margin:0;
      padding:0;
    }
    .vizGrid{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap:14px;
    }
    @media(max-width: 980px){
      .vizGrid{grid-template-columns:1fr}
    }
    .canvasCard{
      background:rgba(18,27,58,0.68);
      border:1px solid var(--line);
      border-radius:16px;
      padding:12px;
      overflow:hidden;
    }
    .canvasTitle{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      margin-bottom:8px;
    }
    .canvasTitle .t{
      font-weight:700;
      letter-spacing:0.2px;
    }
    .canvasTitle .s{
      color:var(--muted);
      font-size:12px;
      font-family:var(--mono);
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius:14px;
      background:rgba(0,0,0,0.22);
      border:1px solid rgba(255,255,255,0.08);
    }
    .controls{
      display:grid;
      gap:10px;
    }
    .control{
      background:rgba(255,255,255,0.04);
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 10px 8px;
    }
    .control label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .control .readout{
      font-family:var(--mono);
      color:var(--text);
      font-size:13px;
      white-space:nowrap;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    .pillRow{
      display:flex;
      flex-wrap:wrap;
      gap:8px;
      margin-top:10px;
    }
    .pill{
      font-family:var(--mono);
      font-size:12px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background:rgba(0,0,0,0.18);
      color:var(--text);
    }

    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 22px;
      color:var(--muted);
      font-size:13px;
    }

    /* Subtle entrance */
    @media (prefers-reduced-motion: no-preference){
      section{animation:fadeUp 420ms ease both}
      section:nth-child(2){animation-delay:30ms}
      section:nth-child(3){animation-delay:60ms}
      section:nth-child(4){animation-delay:90ms}
      section:nth-child(5){animation-delay:120ms}
      section:nth-child(6){animation-delay:150ms}
      @keyframes fadeUp{
        from{opacity:0; transform: translateY(10px)}
        to{opacity:1; transform: translateY(0)}
      }
    }

    /* Print */
    @media print{
      body{background:#fff; color:#000}
      .toc, .controls, button.copyBtn{display:none !important}
      section, .titleCard{box-shadow:none}
      section, .titleCard, .canvasCard, pre.eq{border:1px solid #bbb; background:#fff}
      a{color:#000; text-decoration:underline}
      canvas{border:1px solid #bbb}
    }
  </style>
</head>

<body>
<header>
  <div class="hero">
    <div class="titleCard">
      <h1>Transmission Through a LiNbO<sub>3</sub> Plate: Lateral Walk-off &amp; Retardation</h1>
      <p class="subtitle">
        Unpolarized He–Ne beam (λ = 633 nm) normally incident on a tilted-optic-axis uniaxial crystal.
        We compute (i) the <b>lateral shift</b> between ordinary and extraordinary beams and (ii) their <b>phase retardation</b>.
      </p>
      <div class="pillRow" aria-label="Problem parameters">
        <span class="pill">λ = 633 nm</span>
        <span class="pill">d = 1 cm</span>
        <span class="pill">n<sub>o</sub> = 2.20</span>
        <span class="pill">n<sub>e</sub> = 2.29</span>
        <span class="pill">optic axis tilt θ = 45°</span>
      </div>
    </div>

    <nav class="toc" aria-label="Table of contents">
      <h2>On this page</h2>
      <a href="#qs">Quick Summary</a>
      <a href="#p0">PART 0 — Concept Primer</a>
      <a href="#p1">PART 1 — Problem Analysis</a>
      <a href="#p2">PART 2 — Strategy &amp; Tips</a>
      <a href="#p3">PART 3 — Full Solution</a>
      <a href="#p4">PART 4 — Deeper Understanding</a>
      <a href="#p5">PART 5 — Visualization Guide</a>
      <a href="#viz">Interactive Visualizations</a>
    </nav>
  </div>
</header>

<main>
  <section id="qs">
    <h2>Quick Summary</h2>
    <ul class="muted">
      <li>We study a <b>uniaxial birefringent</b> crystal plate (LiNbO<sub>3</sub>) with its optic axis at <b>45°</b> to the surface normal.</li>
      <li>At normal incidence, both waves have the same <b>wave-normal direction</b> (k along the plate normal), but the extraordinary wave’s <b>energy flow (Poynting vector)</b> can tilt: this causes <b>walk-off</b> and a lateral shift.</li>
      <li><b>Extraordinary phase index</b> depends on the angle θ between k and the optic axis:
        <span class="muted">1/n<sub>e,eff</sub>(θ)<sup>2</sup> = cos²θ/n<sub>e</sub>² + sin²θ/n<sub>o</sub>²</span>.
      </li>
      <li><b>Walk-off angle</b> (between extraordinary ray and k) is
        <span class="muted">tan ρ = (n<sub>o</sub>² − n<sub>e</sub>²) sinθ cosθ / (n<sub>e</sub>² cos²θ + n<sub>o</sub>² sin²θ)</span>.</li>
      <li><b>Lateral shift</b> at the exit face: Δx = d · tan|ρ| (ordinary stays on-axis for normal incidence).</li>
      <li><b>Retardation</b> (phase) between ordinary and extraordinary after thickness d:
        Δφ = (2π/λ) (n<sub>e,eff</sub>(θ) − n<sub>o</sub>) d.</li>
      <li>Numerically (θ=45°, d=1 cm): <b>Δx ≈ 0.401 mm</b>, and <b>Δφ ≈ 4.33×10³ rad</b> (≈ 689.53 waves; modulo 2π: ≈ 3.34 rad).</li>
    </ul>
  </section>

  <section id="p0">
    <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

    <article>
      <h3>0.1 Core definitions (symbols &amp; units)</h3>
      <ul class="muted">
        <li><b>λ</b> — vacuum wavelength (m). Here: 633 nm.</li>
        <li><b>d</b> — plate thickness (m). Here: 1 cm.</li>
        <li><b>n<sub>o</sub>, n<sub>e</sub></b> — ordinary and extraordinary <b>principal refractive indices</b> (dimensionless).</li>
        <li><b>θ</b> — angle between the <b>wave normal</b> (k direction) and the <b>optic axis</b> (rad or °).</li>
        <li><b>n<sub>e,eff</sub>(θ)</b> — <b>effective extraordinary phase index</b> for propagation at angle θ (dimensionless).</li>
        <li><b>ρ</b> — <b>walk-off angle</b> between extraordinary energy flow (ray/Poynting vector) and k (rad or °).</li>
        <li><b>Δx</b> — lateral beam separation at output (m).</li>
        <li><b>Δφ</b> — relative phase retardation between o and e components (rad), equivalently <b>ΔN</b> in waves.</li>
      </ul>

      <h3>0.2 Physical meaning: phase vs. energy directions</h3>
      <p class="muted">
        In anisotropic media, two directions matter:
        (i) the <b>wave normal</b> (direction of k, i.e., phase-front normal) and
        (ii) the <b>ray direction</b> (direction of energy transport, given by the Poynting vector <b>S</b>).
        For the <b>ordinary</b> wave in a uniaxial crystal, the medium behaves isotropically, so <b>S ∥ k</b>.
        For the <b>extraordinary</b> wave, <b>S is generally not parallel to k</b>. This mismatch is the origin of
        <b>walk-off</b>: even with normal incidence, the extraordinary beam can drift sideways inside the plate.
      </p>

      <h3>0.3 Key laws &amp; validity conditions</h3>
      <div class="callouts">
        <div class="box assumptions">
          <p><strong>Assumptions we will use (typical for crystal optics):</strong></p>
          <ul>
            <li>Monochromatic, plane-wave (or narrow paraxial beam) approximation.</li>
            <li>Lossless, homogeneous LiNbO<sub>3</sub> with given indices (no absorption).</li>
            <li>Normal incidence from air; interfaces are plane and parallel.</li>
            <li>Uniaxial crystal model: one optic axis; principal indices n<sub>o</sub>, n<sub>e</sub>.</li>
            <li>We neglect Fresnel reflection details because the problem asks for geometry (shift) and phase retardation.</li>
          </ul>
        </div>
      </div>
      <p class="muted">
        At <b>normal incidence</b>, the tangential component of k is zero. Boundary conditions enforce the transmitted
        k to remain along the surface normal. So both o- and e-waves have k along the plate normal. The ordinary beam
        then stays centered; the extraordinary beam can still walk off because its energy direction differs from k.
      </p>

      <h3>0.4 Useful models/approximations (and why we use them)</h3>
      <ul class="muted">
        <li><b>Index ellipsoid model</b>: gives the extraordinary phase index as a function of direction relative to optic axis.</li>
        <li><b>Ray (walk-off) formula</b>: relates anisotropy to the angle between <b>S</b> and <b>k</b>.</li>
        <li><b>Optical path difference</b>: retardation uses phase indices along the same geometric thickness d.</li>
      </ul>

      <h3>0.5 Mini intuition examples (quick)</h3>
      <ul class="muted">
        <li>If θ = 0° (k along optic axis): the extraordinary wave “sees” index n<sub>e</sub>, but symmetry implies <b>no walk-off</b> (ρ = 0).</li>
        <li>If θ = 90° (k ⟂ optic axis): extraordinary phase index approaches n<sub>o</sub>, and again <b>walk-off goes to zero</b> (ρ = 0). Walk-off is strongest at intermediate angles.</li>
      </ul>

      <div class="box mistakes">
        <p><strong>What to watch for (common pitfalls):</strong></p>
        <ul>
          <li>Confusing <b>extraordinary phase index</b> n<sub>e,eff</sub>(θ) with the principal index n<sub>e</sub>.</li>
          <li>Assuming “normal incidence ⇒ no lateral shift.” That is true for isotropic media and for the ordinary wave, but <b>not</b> for the extraordinary ray in anisotropic media.</li>
          <li>Mixing up θ (angle between optic axis and k) with ρ (walk-off angle between S and k).</li>
          <li>For retardation, using geometric path difference instead of <b>optical</b> path difference (index matters).</li>
        </ul>
      </div>
    </article>
  </section>

  <section id="p1">
    <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

    <article class="grid2">
      <div>
        <h3>1.1 Restate the problem</h3>
        <p class="muted">
          A He–Ne laser beam (λ = 633 nm), unpolarized, is normally incident on a 1 cm thick LiNbO<sub>3</sub> plate.
          The crystal is cut so that its optic axis makes a 45° angle with the plate normal.
          Given n<sub>e</sub> = 2.29 and n<sub>o</sub> = 2.20, find:
          (i) the <b>lateral shift</b> at the output face between the ordinary and extraordinary transmitted beams,
          and (ii) the <b>retardation</b> (phase difference) accumulated between them through the plate.
        </p>

        <h3>1.2 Given quantities</h3>
        <ul class="muted">
          <li>λ = 633 nm</li>
          <li>d = 1 cm</li>
          <li>n<sub>o</sub> = 2.20</li>
          <li>n<sub>e</sub> = 2.29</li>
          <li>θ = 45° (optic axis relative to plate normal; with normal incidence, this is also angle between optic axis and k)</li>
        </ul>

        <h3>1.3 Unknowns (what to find)</h3>
        <ul class="muted">
          <li>Lateral shift at output: Δx (m or mm)</li>
          <li>Retardation: Δφ (rad) or ΔN (waves), optionally modulo 2π</li>
        </ul>
      </div>

      <div>
        <h3>1.4 Relevant principles (and why)</h3>
        <ul class="muted">
          <li><b>Crystal birefringence</b>: uniaxial LiNbO<sub>3</sub> supports ordinary and extraordinary waves with different indices.</li>
          <li><b>Boundary conditions at an interface</b>: normal incidence implies transmitted wave normals remain along the surface normal (k along normal).</li>
          <li><b>Extraordinary index ellipsoid</b>: gives n<sub>e,eff</sub>(θ) for phase accumulation.</li>
          <li><b>Walk-off (ray vs. wave normal)</b>: extraordinary energy flow can tilt by ρ, causing lateral drift Δx.</li>
        </ul>

        <h3>1.5 Assumptions (explicit)</h3>
        <div class="box assumptions">
          <ul>
            <li>The incident beam is narrow/paraxial so “beam center” follows ray direction.</li>
            <li>We treat the plate as a parallel slab: entry and exit faces are parallel.</li>
            <li>Indices provided are appropriate at 633 nm and temperature effects are neglected.</li>
            <li>We ignore multiple internal reflections for retardation (single-pass phase difference).</li>
          </ul>
        </div>

        <h3>1.6 Possible approaches (compare briefly)</h3>
        <ul class="muted">
          <li><b>Index ellipsoid + known walk-off formula (best here)</b>: quickest, analytic, directly uses n<sub>o</sub>, n<sub>e</sub>, θ.</li>
          <li><b>Full electromagnetic derivation</b>: solve anisotropic wave equation and compute S = E×H; rigorous but long.</li>
          <li><b>Numerical ray tracing</b>: flexible for complex cuts, but overkill for a single uniaxial slab.</li>
        </ul>
        <p class="muted"><b>Choice:</b> Use the index-ellipsoid formula for n<sub>e,eff</sub>(θ) and the standard uniaxial walk-off expression for ρ, then compute Δx and Δφ.</p>
      </div>
    </article>
  </section>

  <section id="p2">
    <h2>PART 2 — Strategy &amp; Tips (Roadmap Only)</h2>
    <article>
      <ol class="muted">
        <li>
          <b>Goal:</b> Fix geometry and angles.<br/>
          <b>Tool:</b> Normal incidence ⇒ transmitted k is along plate normal.<br/>
          <b>Meaning:</b> θ (optic axis vs. normal) is also θ (optic axis vs. k) inside.
        </li>
        <li>
          <b>Goal:</b> Compute extraordinary <b>phase</b> index n<sub>e,eff</sub>(θ).<br/>
          <b>Tool:</b> Uniaxial index ellipsoid relation for phase index.<br/>
          <b>Meaning:</b> Sets the extraordinary phase accumulation through thickness d.
        </li>
        <li>
          <b>Goal:</b> Compute walk-off angle ρ for the extraordinary <b>ray</b>.<br/>
          <b>Tool:</b> Standard uniaxial walk-off formula tanρ(θ).<br/>
          <b>Meaning:</b> Determines the sideways drift of the extraordinary beam energy.
        </li>
        <li>
          <b>Goal:</b> Convert walk-off into an output lateral shift Δx.<br/>
          <b>Tool:</b> Geometry in a slab: Δx = d·tan|ρ| (ordinary stays centered at normal incidence).<br/>
          <b>Meaning:</b> Physical separation between o and e beam centers at the exit.
        </li>
        <li>
          <b>Goal:</b> Compute retardation Δφ (and optionally waves ΔN).<br/>
          <b>Tool:</b> Optical path difference: Δφ = (2π/λ)(n<sub>e,eff</sub> − n<sub>o</sub>)d.<br/>
          <b>Meaning:</b> How much the polarization components dephase after the slab.
        </li>
        <li>
          <b>Goal:</b> Sanity checks.<br/>
          <b>Tool:</b> Units, limiting cases θ→0°, 90° and signs.<br/>
          <b>Meaning:</b> Confirms physics consistency.
        </li>
      </ol>

      <div class="box mistakes">
        <p><strong>Quick tips &amp; common mistakes:</strong></p>
        <ul>
          <li>Use <b>n<sub>e,eff</sub>(θ)</b> for retardation, not n<sub>e</sub> directly (unless θ=0°).</li>
          <li>Walk-off uses <b>n<sub>o</sub>, n<sub>e</sub></b> and θ; it is not the same as refraction angle (here incidence is normal).</li>
          <li>Report retardation both as <b>absolute</b> phase and as <b>modulo 2π</b> if you care about interference/polarimetry.</li>
        </ul>
      </div>
    </article>
  </section>

  <section id="p3">
    <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

    <article>
      <h3>3.1 Physical intuition (before calculating)</h3>
      <p class="muted">
        Because the beam is normally incident, the transmitted wavefront normals (k directions) inside the plate are along the normal.
        The ordinary wave behaves like it’s in an isotropic medium with index n<sub>o</sub>, so it travels straight through (no lateral drift).
        The extraordinary wave, however, experiences anisotropy because the optic axis is tilted relative to k (θ = 45°). Its energy flow direction
        tilts slightly relative to k (walk-off), causing the extraordinary beam to exit laterally shifted. Meanwhile, because the ordinary and extraordinary
        phase indices differ, the two components accumulate different optical phase, producing retardation.
      </p>

      <div class="hr"></div>

      <h3>3.2 Extraordinary phase index n<sub>e,eff</sub>(θ)</h3>
      <p class="muted">
        For a uniaxial crystal, the extraordinary <b>phase</b> refractive index depends on the angle θ between the wave normal k and the optic axis:
      </p>

      <div class="eqWrap">
        <button class="copyBtn" data-copy="1/n_e_eff(θ)^2 = cos^2(θ)/n_e^2 + sin^2(θ)/n_o^2">Copy equation</button>
        <pre class="eq" id="eq1">1/n_e_eff(θ)^2 = cos^2(θ)/n_e^2 + sin^2(θ)/n_o^2</pre>
      </div>

      <p class="muted">
        Here, k is along the plate normal (normal incidence), and the optic axis is at θ = 45° to that normal, so θ = 45° inside.
        Compute:
      </p>
      <pre class="eq" id="eq2">Given: n_e = 2.29, n_o = 2.20, θ = 45°
Compute:
n_e_eff(45°) = 1 / sqrt( cos^2(45°)/n_e^2 + sin^2(45°)/n_o^2 )</pre>

      <p class="muted">
        Using cos²45° = sin²45° = 1/2:
      </p>
      <pre class="eq" id="eq3">n_e_eff(45°) = 1 / sqrt( (1/2)/n_e^2 + (1/2)/n_o^2 )
           ≈ 1 / sqrt( 0.5/2.29^2 + 0.5/2.20^2 )
           ≈ 2.24365</pre>

      <p class="muted">
        <b>Interpretation:</b> the extraordinary wave’s phase fronts advance as if the index were ~2.244 for this propagation direction.
      </p>

      <div class="hr"></div>

      <h3>3.3 Walk-off angle ρ (extraordinary ray vs. wave normal)</h3>
      <p class="muted">
        For a uniaxial crystal, the extraordinary ray (energy flow) generally deviates from k. A standard closed-form expression for the walk-off angle is:
      </p>

      <div class="eqWrap">
        <button class="copyBtn" data-copy="tan ρ = (n_o^2 − n_e^2) sinθ cosθ / (n_e^2 cos^2θ + n_o^2 sin^2θ)">Copy equation</button>
        <pre class="eq" id="eq4">tan ρ = (n_o^2 − n_e^2) sinθ cosθ / (n_e^2 cos^2θ + n_o^2 sin^2θ)</pre>
      </div>

      <p class="muted">
        <b>What did we do and why?</b> This formula comes from the geometry of the index ellipsoid and the fact that the ray direction is normal
        to the wave-vector surface (group velocity direction). It quantifies how anisotropy “pushes” energy sideways.
      </p>

      <p class="muted">
        Insert θ = 45°, n<sub>o</sub> = 2.20, n<sub>e</sub> = 2.29:
      </p>

      <pre class="eq" id="eq5">sinθ cosθ = (1/2)
Denominator = n_e^2 cos^2θ + n_o^2 sin^2θ = (n_e^2 + n_o^2)/2

tanρ = (n_o^2 − n_e^2)(1/2) / ((n_e^2 + n_o^2)/2)
     = (n_o^2 − n_e^2)/(n_e^2 + n_o^2)

Numerically:
n_o^2 = 4.8400
n_e^2 = 5.2441
tanρ ≈ (4.84 − 5.2441)/(5.2441 + 4.84) ≈ −0.040073
ρ ≈ arctan(−0.040073) ≈ −2.295°</pre>

      <p class="muted">
        The sign indicates the direction of the sideways tilt relative to the optic-axis projection in the plane of incidence (a convention issue).
        For the <b>magnitude</b> of beam separation we use |ρ|.
      </p>

      <div class="hr"></div>

      <h3>3.4 Lateral shift at the output face</h3>
      <p class="muted">
        Inside a parallel plate, if the extraordinary ray makes an angle ρ relative to the normal, the sideways displacement after traveling thickness d is:
      </p>

      <div class="eqWrap">
        <button class="copyBtn" data-copy="Δx = d · tan|ρ|">Copy equation</button>
        <pre class="eq" id="eq6">Δx = d · tan|ρ|</pre>
      </div>

      <p class="muted">
        Here the ordinary beam remains centered (no drift) because incidence is normal and the ordinary ray satisfies S ∥ k.
        Thus Δx is the separation between extraordinary and ordinary output beam centers.
      </p>

      <pre class="eq" id="eq7">d = 1 cm = 0.01 m
tan|ρ| = |−0.040073| = 0.040073

Δx = 0.01 × 0.040073 ≈ 4.007×10^−4 m = 0.4007 mm</pre>

      <div class="hr"></div>

      <h3>3.5 Retardation between ordinary and extraordinary beams</h3>
      <p class="muted">
        Retardation comes from different <b>phase indices</b> over the same geometric thickness d (because k is normal for both at normal incidence).
        The phase difference is:
      </p>

      <div class="eqWrap">
        <button class="copyBtn" data-copy="Δφ = (2π/λ) · (n_e_eff(θ) − n_o) · d">Copy equation</button>
        <pre class="eq" id="eq8">Δφ = (2π/λ) · (n_e_eff(θ) − n_o) · d</pre>
      </div>

      <p class="muted">
        First compute the index difference:
        Δn = n<sub>e,eff</sub>(45°) − n<sub>o</sub> ≈ 2.24365 − 2.20 = 0.04365.
        Optical path difference: Δ(OPL) = Δn · d.
      </p>

      <pre class="eq" id="eq9">Δn ≈ 0.0436473
Δ(OPL) = Δn d ≈ 0.0436473 × 0.01 = 4.36473×10^−4 m

λ = 633 nm = 6.33×10^−7 m

Δφ = (2π/λ) Δ(OPL)
    ≈ 2π × (4.36473×10^−4 / 6.33×10^−7)
    ≈ 4.332×10^3 rad</pre>

      <p class="muted">
        Sometimes it’s clearer in <b>waves</b>:
        ΔN = Δφ/(2π) = Δ(OPL)/λ.
      </p>

      <pre class="eq" id="eq10">ΔN = Δ(OPL)/λ ≈ (4.36473×10^−4) / (6.33×10^−7) ≈ 6.8953×10^2 waves
So ΔN ≈ 689.53 waves

Modulo 1 wave: 0.53 waves
Equivalent modulo 2π: Δφ mod 2π ≈ 3.34 rad ≈ 191.15°</pre>

      <div class="callouts">
        <div class="box final">
          <p><strong>Final Answer (numerical, for θ = 45°, d = 1 cm, λ = 633 nm):</strong></p>
          <div class="eqWrap">
            <button class="copyBtn" id="copyFinal"
              data-copy="Lateral shift: Δx ≈ 0.4007 mm (extraordinary relative to ordinary).
Retardation: Δφ ≈ 4.33×10^3 rad = 689.53 waves (mod 2π: 3.34 rad ≈ 191.15°).">
              Copy final answer
            </button>
            <pre class="eq" id="finalBlock">Lateral shift:  Δx ≈ 0.4007 mm  (extraordinary relative to ordinary)

Retardation:   Δφ ≈ 4.33×10^3 rad
              ΔN ≈ 689.53 waves
              (mod 2π: Δφ ≈ 3.34 rad ≈ 191.15°)</pre>
          </div>
          <p class="small">
            Direction note: the computed ρ is negative by the chosen sign convention; the <b>separation magnitude</b> is |Δx|.
          </p>
        </div>
      </div>

      <h3>3.6 Sanity checks</h3>
      <ul class="muted">
        <li><b>Units:</b> Δx = d·tanρ has units of meters; Δφ is dimensionless (radians). ✔</li>
        <li><b>Limiting case θ→0° or 90°:</b> sinθcosθ→0 ⇒ ρ→0 ⇒ Δx→0. ✔</li>
        <li><b>Sign reasoning:</b> Only the extraordinary ray walks off; ordinary stays on-axis at normal incidence. ✔</li>
        <li><b>Magnitude:</b> A few degrees walk-off over 1 cm gives ~0.4 mm shift, which is physically plausible. ✔</li>
      </ul>

      <p class="muted">
        <b>Connection to the diagram/plots:</b> The diagram shows k along the plate normal for both components, while the extraordinary ray exits shifted.
        The plots let you vary θ (and thickness) to see how walk-off and retardation change together.
      </p>
    </article>
  </section>

  <section id="p4">
    <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>
    <article class="grid2">
      <div>
        <h3>4.1 Re-interpreting the formulas</h3>
        <p class="muted">
          Two different angle-dependent effects appear:
        </p>
        <ul class="muted">
          <li><b>Phase (retardation):</b> controlled by Δn(θ)=n<sub>e,eff</sub>(θ)−n<sub>o</sub>. Larger |Δn| and larger d produce larger Δφ.</li>
          <li><b>Geometry (walk-off):</b> controlled by sinθcosθ and the anisotropy (n<sub>e</sub>²−n<sub>o</sub>²). It vanishes when θ is 0° or 90°.</li>
        </ul>

        <h3>4.2 How changing parameters affects outcomes</h3>
        <ul class="muted">
          <li>Increase <b>d</b>: Δx scales ∝ d, and Δφ scales ∝ d (both grow linearly).</li>
          <li>Change <b>θ</b>: Δx peaks at intermediate angles; Δφ changes because n<sub>e,eff</sub>(θ) changes smoothly between n<sub>e</sub> and n<sub>o</sub>.</li>
          <li>Change <b>λ</b>: Δφ ∝ 1/λ (shorter wavelength → more retardation); Δx is wavelength-independent in this simple index model.</li>
        </ul>
      </div>

      <div>
        <h3>4.3 Alternative derivation idea (brief)</h3>
        <p class="muted">
          Instead of using the walk-off formula directly, you can:
          (i) write the uniaxial dispersion relation (wave-vector surface),
          (ii) compute group velocity direction (∇<sub>k</sub>ω) which is parallel to energy flow in a lossless medium,
          and (iii) extract the angle between group velocity and k. This reproduces the same ρ(θ).
        </p>

        <h3>4.4 Concept checks (with answers)</h3>
        <ul class="muted">
          <li><b>Q:</b> Why can the extraordinary beam shift laterally even at normal incidence?<br/>
              <b>A:</b> Because in anisotropic media, the extraordinary energy flow direction S need not be parallel to k.</li>
          <li><b>Q:</b> If θ = 90°, what happens to Δx and why?<br/>
              <b>A:</b> Δx → 0 because sinθcosθ = 0, eliminating walk-off.</li>
          <li><b>Q:</b> What determines whether retardation is “many waves” or “fraction of a wave”?<br/>
              <b>A:</b> The thickness d relative to the beat length L<sub>b</sub> = λ/|Δn|; thick plates accumulate many waves.</li>
          <li><b>Q:</b> Which index appears in Snell’s law for the extraordinary wave?<br/>
              <b>A:</b> For direction-dependent phase refraction, use n<sub>e,eff</sub>(θ) tied to k; but here incidence is normal so k stays normal regardless.</li>
        </ul>
      </div>
    </article>
  </section>

  <section id="p5">
    <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>
    <article class="muted">
      <ul>
        <li><b>Diagram canvas:</b> Shows the plate, the optic axis at angle θ, the ordinary beam traveling straight, and the extraordinary beam exiting shifted by Δx.</li>
        <li><b>Main plot (Walk-off &amp; lateral shift):</b> Plots Δx(θ) for the current thickness d. A marker shows your current θ setting.</li>
        <li><b>Secondary plot (Retardation):</b> Plots retardation in waves ΔN(θ)=Δ(OPL)/λ for the current thickness d, with a marker at current θ.</li>
        <li><b>Interactive controls:</b> Changing θ updates n<sub>e,eff</sub>(θ), ρ(θ), Δx, and Δφ simultaneously. Changing d scales both Δx and Δφ linearly.</li>
      </ul>
      <p class="muted">
        Tip: try θ near 0°, 45°, and 90° to see walk-off vanish at the endpoints while retardation remains generally nonzero.
      </p>
    </article>
  </section>

  <section id="viz">
    <h2>Interactive Visualizations</h2>

    <div class="vizGrid">
      <div class="canvasCard">
        <div class="canvasTitle">
          <div class="t">Diagram — Geometry &amp; Walk-off</div>
          <div class="s">k along normal; extraordinary ray tilted by ρ</div>
        </div>
        <canvas id="cDiagram" aria-label="Diagram canvas"></canvas>
      </div>

      <div class="controls" aria-label="Interactive controls">
        <div class="control">
          <label for="theta">
            <span>Optic axis angle θ (deg) <span class="small">(between optic axis and plate normal)</span></span>
            <span class="readout" id="thetaOut">45.0°</span>
          </label>
          <input id="theta" type="range" min="0" max="90" value="45" step="0.1"/>
        </div>
        <div class="control">
          <label for="thick">
            <span>Plate thickness d (cm)</span>
            <span class="readout" id="thickOut">1.00 cm</span>
          </label>
          <input id="thick" type="range" min="0.1" max="5" value="1" step="0.01"/>
        </div>
        <div class="control">
          <label>
            <span>Computed outputs (live)</span>
            <span class="readout" id="liveTag">LiNbO3 @ 633 nm</span>
          </label>
          <div class="kpiRow">
            <div class="kpi">
              <div class="label">n_e_eff(θ)</div>
              <div class="value" id="kpi_neff">2.24365</div>
              <div class="hint">extraordinary phase index</div>
            </div>
            <div class="kpi">
              <div class="label">walk-off |ρ|</div>
              <div class="value" id="kpi_rho">2.295°</div>
              <div class="hint">extraordinary ray tilt</div>
            </div>
            <div class="kpi">
              <div class="label">lateral shift Δx</div>
              <div class="value" id="kpi_dx">0.401 mm</div>
              <div class="hint">at exit face</div>
            </div>
            <div class="kpi">
              <div class="label">retardation ΔN</div>
              <div class="value" id="kpi_waves">689.53 waves</div>
              <div class="hint">Δφ = 2πΔN</div>
            </div>
          </div>
          <div class="pillRow" style="margin-top:10px">
            <span class="pill" id="pill_phase">Δφ mod 2π: 3.336 rad</span>
            <span class="pill" id="pill_deg">≈ 191.15°</span>
            <span class="pill" id="pill_opl">Δ(OPL): 4.365e-4 m</span>
          </div>
        </div>
      </div>
    </div>

    <div class="grid2" style="margin-top:14px">
      <div class="canvasCard">
        <div class="canvasTitle">
          <div class="t">Main Plot — Lateral shift Δx vs θ</div>
          <div class="s">units: mm (depends on d)</div>
        </div>
        <canvas id="cMain" aria-label="Main plot canvas"></canvas>
      </div>
      <div class="canvasCard">
        <div class="canvasTitle">
          <div class="t">Secondary Plot — Retardation ΔN vs θ</div>
          <div class="s">units: waves (depends on d, λ)</div>
        </div>
        <canvas id="cSecond" aria-label="Secondary plot canvas"></canvas>
      </div>
    </div>

    <div class="box keyeq" style="margin-top:14px">
      <p><strong>Equations used by the interactive tool (same as in the solution):</strong></p>
      <div class="eqWrap">
        <button class="copyBtn" data-copy="n_e_eff(θ) = 1/sqrt(cos^2θ/n_e^2 + sin^2θ/n_o^2)
tan ρ = (n_o^2 − n_e^2) sinθ cosθ / (n_e^2 cos^2θ + n_o^2 sin^2θ)
Δx = d tan|ρ|
ΔN = (n_e_eff(θ) − n_o) d / λ
Δφ = 2π ΔN">Copy all</button>
        <pre class="eq">n_e_eff(θ) = 1/sqrt(cos^2θ/n_e^2 + sin^2θ/n_o^2)
tan ρ = (n_o^2 − n_e^2) sinθ cosθ / (n_e^2 cos^2θ + n_o^2 sin^2θ)
Δx = d tan|ρ|
ΔN = (n_e_eff(θ) − n_o) d / λ
Δφ = 2π ΔN</pre>
      </div>
      <p class="small">Note: This is a standard uniaxial-crystal walk-off model (lossless, homogeneous, paraxial beam).</p>
    </div>
  </section>
</main>

<footer>
  <p>
    Built as a self-contained learning article (vanilla HTML/CSS/JS). Use the sliders to explore how anisotropy creates both
    <b>phase retardation</b> and <b>geometric walk-off</b> in a tilted-optic-axis LiNbO<sub>3</sub> slab.
  </p>
</footer>

<script>
(function(){
  // -----------------------
  // Constants (problem data)
  // -----------------------
  const params = {
    lambda: 633e-9,  // m
    no: 2.20,
    ne: 2.29,
    thetaDeg: 45.0,
    d_cm: 1.00
  };

  // -------------
  // DOM elements
  // -------------
  const elTheta = document.getElementById('theta');
  const elThick = document.getElementById('thick');
  const thetaOut = document.getElementById('thetaOut');
  const thickOut = document.getElementById('thickOut');

  const kpi_neff = document.getElementById('kpi_neff');
  const kpi_rho = document.getElementById('kpi_rho');
  const kpi_dx = document.getElementById('kpi_dx');
  const kpi_waves = document.getElementById('kpi_waves');
  const pill_phase = document.getElementById('pill_phase');
  const pill_deg = document.getElementById('pill_deg');
  const pill_opl = document.getElementById('pill_opl');

  // Copy buttons
  function copyText(txt){
    if(!navigator.clipboard){
      // Fallback
      const ta=document.createElement('textarea');
      ta.value=txt; document.body.appendChild(ta);
      ta.select(); try{document.execCommand('copy');}catch(e){}
      document.body.removeChild(ta);
      return;
    }
    navigator.clipboard.writeText(txt);
  }
  document.querySelectorAll('[data-copy]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      copyText(btn.getAttribute('data-copy'));
      btn.textContent = 'Copied!';
      setTimeout(()=> btn.textContent = btn.id === 'copyFinal' ? 'Copy final answer' : 'Copy equation', 900);
      if(btn.getAttribute('data-copy').includes('\n')) {
        // restore for multiline copy buttons that aren't "Copy equation"
        setTimeout(()=>{
          if(btn.id === 'copyFinal') btn.textContent = 'Copy final answer';
          else if(btn.textContent === 'Copy equation') {}
          else btn.textContent = 'Copy equation';
        }, 1200);
      }
    });
  });

  // -----------------------
  // Core physics functions
  // -----------------------
  function deg2rad(d){ return d*Math.PI/180; }

  // Extraordinary effective phase index
  function neEff(thetaRad, ne, no){
    const c = Math.cos(thetaRad);
    const s = Math.sin(thetaRad);
    const inv2 = (c*c)/(ne*ne) + (s*s)/(no*no);
    return 1/Math.sqrt(inv2);
  }

  // Walk-off angle rho (radians)
  function walkoffRho(thetaRad, ne, no){
    const c = Math.cos(thetaRad);
    const s = Math.sin(thetaRad);
    const num = (no*no - ne*ne) * s * c;
    const den = (ne*ne)*(c*c) + (no*no)*(s*s);
    return Math.atan2(num, den); // since tan rho = num/den
  }

  // Retardation in waves and phase
  function retardation(thetaRad, d_m, lambda, ne, no){
    const neff = neEff(thetaRad, ne, no);
    const dn = neff - no;
    const opl = dn * d_m;
    const waves = opl / lambda;         // ΔN
    const phase = 2*Math.PI*waves;      // Δφ
    const mod = ((phase % (2*Math.PI)) + (2*Math.PI)) % (2*Math.PI);
    return {neff, dn, opl, waves, phase, mod};
  }

  // Lateral shift (m) due to walk-off
  function lateralShift(thetaRad, d_m, ne, no){
    const rho = walkoffRho(thetaRad, ne, no);
    const dx = d_m * Math.tan(Math.abs(rho));
    return {rho, dx};
  }

  // -----------------------
  // Canvas utilities
  // -----------------------
  function setupCanvas(canvas){
    const ctx = canvas.getContext('2d');
    function resize(){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(280, rect.width);
      const h = rect.height; // controlled by CSS
      canvas.width = Math.round(w*dpr);
      canvas.height = Math.round(h*dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {w, h};
    }
    return {ctx, resize};
  }

  function clear(ctx, w, h){
    ctx.clearRect(0,0,w,h);
  }

  function drawPanelBg(ctx, w, h){
    // subtle vignette
    const g = ctx.createRadialGradient(w*0.35,h*0.25, 10, w*0.5,h*0.5, Math.max(w,h)*0.8);
    g.addColorStop(0, 'rgba(124,240,255,0.06)');
    g.addColorStop(1, 'rgba(0,0,0,0.0)');
    ctx.fillStyle = 'rgba(0,0,0,0.22)';
    ctx.fillRect(0,0,w,h);
    ctx.fillStyle = g;
    ctx.fillRect(0,0,w,h);
  }

  function niceTicks(min, max, n=6){
    // simple "nice" tick generator
    const span = max-min;
    if(span<=0) return [min];
    const raw = span/(n-1);
    const pow = Math.pow(10, Math.floor(Math.log10(raw)));
    const frac = raw/pow;
    let niceFrac = 1;
    if(frac<1.5) niceFrac=1;
    else if(frac<3) niceFrac=2;
    else if(frac<7) niceFrac=5;
    else niceFrac=10;
    const step = niceFrac*pow;
    const start = Math.ceil(min/step)*step;
    const ticks=[];
    for(let v=start; v<=max+1e-12; v+=step) ticks.push(v);
    return ticks;
  }

  function drawAxes(ctx, w, h, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
    // box: {x,y,w,h,padL,padR,padT,padB}
    const {x,y} = box;
    const iw = box.w - box.padL - box.padR;
    const ih = box.h - box.padT - box.padB;

    // title
    ctx.fillStyle = 'rgba(233,236,255,0.92)';
    ctx.font = '700 13px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillText(title, x+box.padL, y+16);

    // plot region
    const px = x + box.padL;
    const py = y + box.padT;
    const rx = px;
    const ry = py + 12; // leave room for title
    const rh = ih - 12;

    // frame
    ctx.strokeStyle = 'rgba(255,255,255,0.12)';
    ctx.lineWidth = 1;
    ctx.strokeRect(rx, ry, iw, rh);

    // grid and ticks
    const xTicks = niceTicks(xMin, xMax, 6);
    const yTicks = niceTicks(yMin, yMax, 6);

    ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    ctx.fillStyle = 'rgba(185,192,255,0.85)';

    // x grid
    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    xTicks.forEach(v=>{
      const t = (v-xMin)/(xMax-xMin);
      const X = rx + t*iw;
      ctx.beginPath();
      ctx.moveTo(X, ry);
      ctx.lineTo(X, ry+rh);
      ctx.stroke();
      const s = (Math.abs(v) < 1e-9) ? '0' : (Math.round(v*1000)/1000).toString();
      ctx.fillText(s, X-8, ry+rh+16);
    });

    // y grid
    yTicks.forEach(v=>{
      const t = (v-yMin)/(yMax-yMin);
      const Y = ry + rh - t*rh;
      ctx.beginPath();
      ctx.moveTo(rx, Y);
      ctx.lineTo(rx+iw, Y);
      ctx.stroke();
      const s = (Math.abs(v) < 1e-9) ? '0' : (Math.round(v*1000)/1000).toString();
      ctx.fillText(s, rx-42, Y+4);
    });

    // labels
    ctx.fillStyle = 'rgba(185,192,255,0.95)';
    ctx.font = '600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillText(xLabel, rx + iw/2 - ctx.measureText(xLabel).width/2, ry+rh+34);

    // rotated y label
    ctx.save();
    ctx.translate(rx-54, ry + rh/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
    ctx.restore();

    function xToPx(v){ return rx + (v-xMin)/(xMax-xMin)*iw; }
    function yToPx(v){ return ry + rh - (v-yMin)/(yMax-yMin)*rh; }

    return {rx, ry, rw:iw, rh, xToPx, yToPx};
  }

  function drawLine(ctx, pts, strokeStyle){
    ctx.strokeStyle = strokeStyle;
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<pts.length;i++){
      const p=pts[i];
      if(i===0) ctx.moveTo(p.x,p.y);
      else ctx.lineTo(p.x,p.y);
    }
    ctx.stroke();
  }

  function drawMarker(ctx, x, y, label){
    ctx.fillStyle = 'rgba(124,240,255,0.95)';
    ctx.beginPath(); ctx.arc(x,y,4.2,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = 'rgba(0,0,0,0.35)';
    ctx.lineWidth = 2;
    ctx.beginPath(); ctx.arc(x,y,4.2,0,Math.PI*2); ctx.stroke();

    ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    ctx.fillStyle = 'rgba(233,236,255,0.92)';
    ctx.fillText(label, x+8, y-8);
  }

  // -----------------------
  // Drawing: Diagram
  // -----------------------
  const diag = setupCanvas(document.getElementById('cDiagram'));
  const mainP = setupCanvas(document.getElementById('cMain'));
  const secP  = setupCanvas(document.getElementById('cSecond'));

  function drawDiagram(state){
    const {ctx, resize} = diag;
    const {w,h} = resize();
    clear(ctx,w,h);
    drawPanelBg(ctx,w,h);

    // geometry
    const margin = 18;
    const plateX = w*0.55;
    const plateW = w*0.20;
    const plateY = h*0.18;
    const plateH = h*0.64;

    // axes
    const cx = w*0.18;
    const cy = h*0.50;
    const normalLen = h*0.33;

    // plate
    ctx.fillStyle = 'rgba(169,255,154,0.08)';
    ctx.strokeStyle = 'rgba(169,255,154,0.35)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.roundRect(plateX, plateY, plateW, plateH, 14);
    ctx.fill(); ctx.stroke();

    // normal line (k direction)
    const nX = plateX - w*0.10;
    const nY1 = plateY + plateH/2 - normalLen/2;
    const nY2 = plateY + plateH/2 + normalLen/2;

    ctx.strokeStyle = 'rgba(124,240,255,0.55)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(nX, nY1);
    ctx.lineTo(nX, nY2);
    ctx.stroke();

    // arrow for k (downwards)
    ctx.fillStyle = 'rgba(124,240,255,0.9)';
    ctx.beginPath();
    ctx.moveTo(nX, nY2);
    ctx.lineTo(nX-6, nY2-12);
    ctx.lineTo(nX+6, nY2-12);
    ctx.closePath();
    ctx.fill();

    // label k
    ctx.font = '700 12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
    ctx.fillStyle = 'rgba(233,236,255,0.92)';
    ctx.fillText('k (wave normal)', nX-50, nY1-8);

    // optic axis arrow at theta to normal (in plane)
    const theta = state.thetaRad;
    const oaLen = h*0.22;
    const oaBaseX = nX;
    const oaBaseY = plateY + plateH/2;
    const oaX = oaBaseX + oaLen*Math.sin(theta);
    const oaY = oaBaseY - oaLen*Math.cos(theta);

    ctx.strokeStyle = 'rgba(255,210,124,0.75)';
    ctx.lineWidth = 2.5;
    ctx.beginPath();
    ctx.moveTo(oaBaseX, oaBaseY);
    ctx.lineTo(oaX, oaY);
    ctx.stroke();

    // arrow head
    const ang = Math.atan2(oaY-oaBaseY, oaX-oaBaseX);
    ctx.fillStyle = 'rgba(255,210,124,0.92)';
    ctx.beginPath();
    ctx.moveTo(oaX, oaY);
    ctx.lineTo(oaX-10*Math.cos(ang-0.55), oaY-10*Math.sin(ang-0.55));
    ctx.lineTo(oaX-10*Math.cos(ang+0.55), oaY-10*Math.sin(ang+0.55));
    ctx.closePath();
    ctx.fill();

    ctx.fillStyle = 'rgba(233,236,255,0.92)';
    ctx.fillText('optic axis', oaX+6, oaY-2);

    // draw theta arc
    const arcR = 24;
    ctx.strokeStyle = 'rgba(255,210,124,0.55)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(oaBaseX, oaBaseY, arcR, -Math.PI/2, -Math.PI/2 + theta, false);
    ctx.stroke();
    ctx.fillStyle = 'rgba(185,192,255,0.9)';
    ctx.fillText('θ', oaBaseX + arcR + 6, oaBaseY - 6);

    // incoming beam
    const inX = nX;
    const inTop = plateY - 6;
    const inBot = plateY + plateH + 6;
    ctx.strokeStyle = 'rgba(124,240,255,0.65)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(inX, inTop);
    ctx.lineTo(inX, plateY);
    ctx.stroke();

    // inside plate: ordinary (straight) and extraordinary (tilted by rho)
    const enterY = plateY + 8;
    const exitY = plateY + plateH - 8;
    const plateMidX = plateX + plateW/2;

    // ordinary path (straight)
    ctx.strokeStyle = 'rgba(124,240,255,0.9)';
    ctx.setLineDash([]);
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(plateMidX, enterY);
    ctx.lineTo(plateMidX, exitY);
    ctx.stroke();

    // label ordinary
    ctx.fillStyle = 'rgba(124,240,255,0.92)';
    ctx.fillText('ordinary (S ∥ k)', plateMidX - 90, plateY + 18);

    // extraordinary path (tilted inside, then exits parallel slab => still tilted in air? In reality refraction at exit,
    // but the question asks lateral shift at output face. We show the shifted exit point and outgoing direction.
    const rho = state.rho; // can be negative; we show magnitude direction in plane
    const rhoShow = rho; // keep sign to show direction
    const dxInside = (exitY - enterY) * Math.tan(rhoShow); // approximate using vertical travel
    const exExitX = plateMidX + dxInside;

    ctx.strokeStyle = 'rgba(169,255,154,0.92)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(plateMidX, enterY);
    ctx.lineTo(exExitX, exitY);
    ctx.stroke();

    // outgoing ordinary beam
    ctx.strokeStyle = 'rgba(124,240,255,0.65)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(plateMidX, exitY);
    ctx.lineTo(plateMidX, inBot);
    ctx.stroke();

    // outgoing extraordinary beam (from shifted exit point)
    ctx.strokeStyle = 'rgba(169,255,154,0.65)';
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(exExitX, exitY);
    ctx.lineTo(exExitX + (inBot-exitY)*Math.tan(rhoShow), inBot);
    ctx.stroke();

    // mark lateral shift at exit face
    ctx.strokeStyle = 'rgba(233,236,255,0.55)';
    ctx.lineWidth = 2;
    ctx.setLineDash([6,6]);
    ctx.beginPath();
    ctx.moveTo(plateMidX, exitY);
    ctx.lineTo(exExitX, exitY);
    ctx.stroke();
    ctx.setLineDash([]);

    ctx.fillStyle = 'rgba(233,236,255,0.92)';
    ctx.fillText('Δx', (plateMidX+exExitX)/2 - 8, exitY - 10);

    // label extraordinary
    ctx.fillStyle = 'rgba(169,255,154,0.92)';
    ctx.fillText('extraordinary (walk-off ρ)', exExitX - 130, plateY + 40);

    // plate label
    ctx.fillStyle = 'rgba(185,192,255,0.9)';
    ctx.fillText('LiNbO₃ plate', plateX+10, plateY+plateH+20);

    // small legend
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillStyle = 'rgba(185,192,255,0.9)';
    ctx.fillText('Blue: ordinary (o)   Green: extraordinary (e)', margin, h - 16);
  }

  // -----------------------
  // Drawing: Plots
  // -----------------------
  function computeCurves(d_m){
    const ptsShift = [];
    const ptsWaves = [];
    const ne = params.ne, no = params.no, lambda = params.lambda;

    let yMinS=Infinity, yMaxS=-Infinity;
    let yMinW=Infinity, yMaxW=-Infinity;

    for(let i=0;i<=180;i++){
      const thDeg = i*(90/180);
      const th = deg2rad(thDeg);

      const {rho, dx} = lateralShift(th, d_m, ne, no);
      const {waves} = retardation(th, d_m, lambda, ne, no);

      const dxmm = dx*1e3;

      ptsShift.push({x: thDeg, y: dxmm});
      ptsWaves.push({x: thDeg, y: waves});

      yMinS = Math.min(yMinS, dxmm);
      yMaxS = Math.max(yMaxS, dxmm);
      yMinW = Math.min(yMinW, waves);
      yMaxW = Math.max(yMaxW, waves);
    }

    // pad ranges
    const padS = (yMaxS-yMinS)*0.10 + 1e-6;
    const padW = (yMaxW-yMinW)*0.08 + 1e-6;

    return {
      ptsShift, ptsWaves,
      shiftRange: {min: Math.max(0, yMinS - padS), max: yMaxS + padS},
      waveRange: {min: Math.max(0, yMinW - padW), max: yMaxW + padW}
    };
  }

  function drawMainPlot(state){
    const {ctx, resize} = mainP;
    const {w,h} = resize();
    clear(ctx,w,h);
    drawPanelBg(ctx,w,h);

    const box = {x:0, y:0, w, h, padL:64, padR:18, padT:18, padB:44};
    const curves = state.curves;

    const xMin=0, xMax=90;
    const yMin=curves.shiftRange.min;
    const yMax=curves.shiftRange.max;

    const ax = drawAxes(ctx,w,h,box,xMin,xMax,yMin,yMax,'θ (deg)','Δx (mm)',
      'Lateral shift at exit face vs optic-axis angle');

    // line
    const pts = curves.ptsShift.map(p=>({x: ax.xToPx(p.x), y: ax.yToPx(p.y)}));
    drawLine(ctx, pts, 'rgba(124,240,255,0.85)');

    // marker at current theta
    const th = state.thetaDeg;
    const {dx} = state;
    const mx = ax.xToPx(th);
    const my = ax.yToPx(dx*1e3);
    drawMarker(ctx, mx, my, `θ=${th.toFixed(1)}°`);

    // legend
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillStyle = 'rgba(233,236,255,0.90)';
    ctx.fillText('Curve: Δx(θ) for current thickness d', ax.rx+8, ax.ry+ax.rh-10);
  }

  function drawSecondPlot(state){
    const {ctx, resize} = secP;
    const {w,h} = resize();
    clear(ctx,w,h);
    drawPanelBg(ctx,w,h);

    const box = {x:0, y:0, w, h, padL:64, padR:18, padT:18, padB:44};
    const curves = state.curves;

    const xMin=0, xMax=90;
    const yMin=curves.waveRange.min;
    const yMax=curves.waveRange.max;

    const ax = drawAxes(ctx,w,h,box,xMin,xMax,yMin,yMax,'θ (deg)','ΔN (waves)',
      'Retardation (optical path difference / λ) vs optic-axis angle');

    const pts = curves.ptsWaves.map(p=>({x: ax.xToPx(p.x), y: ax.yToPx(p.y)}));
    drawLine(ctx, pts, 'rgba(169,255,154,0.85)');

    // marker
    const th = state.thetaDeg;
    const mx = ax.xToPx(th);
    const my = ax.yToPx(state.waves);
    drawMarker(ctx, mx, my, `ΔN=${state.waves.toFixed(2)}`);

    // small note
    ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
    ctx.fillStyle = 'rgba(233,236,255,0.90)';
    ctx.fillText('ΔN grows linearly with thickness d and scales as 1/λ', ax.rx+8, ax.ry+ax.rh-10);
  }

  // -----------------------
  // State update + render
  // -----------------------
  function computeState(){
    const thetaDeg = params.thetaDeg;
    const thetaRad = deg2rad(thetaDeg);
    const d_m = params.d_cm * 1e-2;

    const ret = retardation(thetaRad, d_m, params.lambda, params.ne, params.no);
    const lat = lateralShift(thetaRad, d_m, params.ne, params.no);

    const curves = computeCurves(d_m);

    return {
      thetaDeg, thetaRad,
      d_m,
      neff: ret.neff,
      rho: lat.rho,
      dx: lat.dx,
      waves: ret.waves,
      phase: ret.phase,
      mod: ret.mod,
      opl: ret.opl,
      curves
    };
  }

  function formatSci(x){
    if(x === 0) return '0';
    const a = x.toExponential(3);
    // nicer: 4.365e-4
    return a.replace('e', 'e');
  }

  function render(){
    const state = computeState();

    // Update readouts
    thetaOut.textContent = `${state.thetaDeg.toFixed(1)}°`;
    thickOut.textContent = `${params.d_cm.toFixed(2)} cm`;

    kpi_neff.textContent = state.neff.toFixed(5);
    kpi_rho.textContent = `${Math.abs(state.rho*180/Math.PI).toFixed(3)}°`;
    kpi_dx.textContent = `${(state.dx*1e3).toFixed(3)} mm`;
    kpi_waves.textContent = `${state.waves.toFixed(2)} waves`;

    pill_phase.textContent = `Δφ mod 2π: ${state.mod.toFixed(3)} rad`;
    pill_deg.textContent = `≈ ${(state.mod*180/Math.PI).toFixed(2)}°`;
    pill_opl.textContent = `Δ(OPL): ${formatSci(state.opl)} m`;

    // Draw
    drawDiagram(state);
    drawMainPlot(state);
    drawSecondPlot(state);
  }

  // Events
  elTheta.addEventListener('input', ()=>{
    params.thetaDeg = parseFloat(elTheta.value);
    render();
  });
  elThick.addEventListener('input', ()=>{
    params.d_cm = parseFloat(elThick.value);
    render();
  });

  // Re-render on resize (responsive canvases)
  let resizeTimer = null;
  window.addEventListener('resize', ()=>{
    clearTimeout(resizeTimer);
    resizeTimer = setTimeout(render, 80);
  });

  // Initial
  // Ensure roundRect exists for older browsers
  if(!CanvasRenderingContext2D.prototype.roundRect){
    CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      this.beginPath();
      this.moveTo(x+rr,y);
      this.arcTo(x+w,y,x+w,y+h,rr);
      this.arcTo(x+w,y+h,x,y+h,rr);
      this.arcTo(x,y+h,x,y,rr);
      this.arcTo(x,y,x+w,y,rr);
      this.closePath();
      return this;
    };
  }

  render();
})();
</script>
</body>
</html>
