<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>6.3-3 Double Refraction in Quartz — Wavevectors vs Rays (Ordinary & Extraordinary)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0f1830;
      --text:#eaf0ff;
      --muted:#b9c3e6;
      --faint:#7f8ab4;
      --accent:#8ee6ff;
      --accent2:#a7ffb5;
      --warn:#ffd28e;
      --danger:#ff9db0;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 20% 10%, rgba(142,230,255,.18), transparent 55%),
        radial-gradient(900px 600px at 80% 30%, rgba(167,255,181,.14), transparent 55%),
        radial-gradient(900px 600px at 60% 90%, rgba(255,210,142,.10), transparent 55%),
        linear-gradient(180deg, #070a14, var(--bg));
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding:32px 18px 12px;
      max-width:1200px;
      margin:0 auto;
    }
    .hero{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .hero{grid-template-columns:1fr}
    }
    .titleCard{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      padding:22px 22px 18px;
      position:relative;
      overflow:hidden;
    }
    .titleCard:before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(600px 220px at 20% 0%, rgba(142,230,255,.10), transparent 60%),
                  radial-gradient(500px 250px at 90% 10%, rgba(167,255,181,.10), transparent 60%);
      pointer-events:none;
      filter: blur(0.2px);
    }
    .titleCard > *{position:relative}
    h1{
      font-size: clamp(22px, 3vw, 34px);
      margin:0 0 8px;
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      margin:0;
      max-width:70ch;
    }
    .meta{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top:14px;
    }
    .pill{
      font-size:13px;
      color:var(--muted);
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background:rgba(0,0,0,.18);
      backdrop-filter: blur(6px);
    }
    .tocCard{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      padding:14px;
      position:relative;
      overflow:hidden;
    }
    .tocCard h2{
      font-size:14px;
      margin:4px 0 10px;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.12em;
    }
    .toc{
      position:sticky;
      top:12px;
      max-height: calc(100vh - 24px);
      overflow:auto;
      padding-right:6px;
    }
    .toc a{
      display:block;
      padding:8px 10px;
      border-radius:12px;
      color:var(--text);
      border:1px solid transparent;
      transition: all .18s ease;
      font-size:14px;
    }
    .toc a:hover{
      background:rgba(142,230,255,.08);
      border-color: rgba(142,230,255,.18);
      text-decoration:none;
      transform: translateX(2px);
    }
    main{
      max-width:1200px;
      margin:0 auto;
      padding:12px 18px 40px;
    }
    section{
      margin:18px 0;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius:var(--radius2);
      box-shadow:var(--shadow);
      overflow:hidden;
    }
    section .secInner{
      padding:18px 18px 22px;
    }
    section header{
      padding:0;
      margin:0;
      max-width: none;
    }
    h2{
      margin:0 0 10px;
      font-size: clamp(18px, 2.2vw, 24px);
    }
    h3{
      margin:18px 0 8px;
      font-size: 17px;
      color: var(--accent);
    }
    p{margin:10px 0; color:var(--text)}
    ul{margin:10px 0 0 18px; color:var(--text)}
    li{margin:6px 0}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid2{grid-template-columns:1fr}
    }
    .callout{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.18);
      padding:14px 14px 12px;
    }
    .callout strong{color:var(--accent2)}
    .callout.warn strong{color:var(--warn)}
    .callout.danger strong{color:var(--danger)}
    .eq{
      font-family:var(--mono);
      font-size: 13.5px;
      line-height:1.45;
      color:#f3f6ff;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px 12px;
      overflow:auto;
      position:relative;
    }
    .eq .copyBtn{
      position:absolute;
      top:10px;
      right:10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.06);
      color:var(--text);
      font-size:12px;
      padding:6px 10px;
      cursor:pointer;
      transition: transform .14s ease, background .14s ease;
    }
    .eq .copyBtn:hover{transform: translateY(-1px); background:rgba(142,230,255,.12)}
    .eq .copyBtn:active{transform: translateY(0px) scale(.98)}
    .twoCol{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .twoCol{grid-template-columns:1fr}
    }
    figure{
      margin:0;
      border-top:1px solid var(--line);
      background:rgba(0,0,0,.14);
    }
    .vizWrap{
      padding:14px 14px 16px;
    }
    .vizGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .vizGrid{grid-template-columns:1fr}
    }
    .canvasCard{
      border:1px solid var(--line);
      border-radius:18px;
      background:rgba(0,0,0,.18);
      padding:12px;
      overflow:hidden;
    }
    .canvasTitle{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:flex-end;
      margin:0 0 8px;
    }
    .canvasTitle h4{
      margin:0;
      font-size:14px;
      color:var(--muted);
      letter-spacing:.03em;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius:14px;
      background:rgba(7,10,20,.55);
      border:1px solid rgba(255,255,255,.08);
    }
    .controls{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap:12px;
      margin-bottom:12px;
    }
    @media (max-width: 980px){
      .controls{grid-template-columns:1fr}
    }
    .ctrl{
      border:1px solid var(--line);
      border-radius:16px;
      background:rgba(0,0,0,.18);
      padding:12px 12px 10px;
    }
    .ctrl label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      align-items:baseline;
      font-size:13px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .ctrl input[type="range"]{width:100%}
    .ctrl .val{
      font-family:var(--mono);
      font-size:13px;
      color:var(--text);
    }
    .small{
      font-size:13px;
      color:var(--muted);
    }
    .footer{
      padding:22px 18px 40px;
      max-width:1200px;
      margin:0 auto;
      color:var(--faint);
      font-size:13px;
    }
    .divider{
      height:1px;
      background: var(--line);
      margin:14px 0;
    }
    .kbd{
      font-family:var(--mono);
      font-size:12px;
      border:1px solid rgba(255,255,255,.18);
      background:rgba(255,255,255,.06);
      padding:2px 6px;
      border-radius:8px;
      color:var(--text);
    }
    /* Print-friendly */
    @media print{
      body{background:#fff; color:#000}
      section, .titleCard, .tocCard{box-shadow:none}
      .tocCard{display:none}
      .eq{background:#f6f6f6; color:#000}
      .callout{background:#f6f6f6}
      canvas{border:1px solid #999; background:#fff}
      a{color:#000; text-decoration:underline}
    }
  </style>
</head>
<body>
  <header>
    <div class="hero">
      <div class="titleCard">
        <h1>Double Refraction in a Uniaxial Crystal (Quartz): Directions of <span style="color:var(--accent)">Wavevectors</span> and <span style="color:var(--accent2)">Rays</span></h1>
        <p class="subtitle">
          An unpolarized plane wave hits a quartz interface. It splits into an <b>ordinary</b> and an <b>extraordinary</b> component.
          We will distinguish <b>phase propagation direction</b> (wavevector <span class="kbd">k</span>) from <b>energy flow direction</b> (ray / Poynting vector <span class="kbd">S</span>).
        </p>
        <div class="meta">
          <span class="pill">Topic: Crystal optics • birefringence</span>
          <span class="pill">Key idea: tangential <span class="kbd">k</span> is conserved</span>
          <span class="pill">Ordinary: <span class="kbd">S ∥ k</span></span>
          <span class="pill">Extraordinary: <span class="kbd">S</span> “walks off” from <span class="kbd">k</span></span>
        </div>
      </div>

      <aside class="tocCard">
        <div class="toc">
          <h2>Table of Contents</h2>
          <a href="#quick">Quick Summary</a>
          <a href="#part0">PART 0 — Concept Primer</a>
          <a href="#part1">PART 1 — Problem Analysis</a>
          <a href="#part2">PART 2 — Strategy & Tips</a>
          <a href="#part3">PART 3 — Full Solution</a>
          <a href="#part4">PART 4 — Deeper Understanding</a>
          <a href="#part5">PART 5 — Visualization Guide</a>
          <a href="#viz">Interactive Visualizations</a>
        </div>
      </aside>
    </div>
  </header>

  <main>
    <!-- Quick Summary -->
    <section id="quick">
      <div class="secInner">
        <h2>Quick Summary</h2>
        <ul>
          <li><b>What this is about:</b> Refraction at an air–quartz interface where an unpolarized beam splits into <b>ordinary</b> and <b>extraordinary</b> transmitted waves.</li>
          <li><b>Key physics idea:</b> At a planar interface, the <b>tangential component</b> of the wavevector is conserved for each transmitted mode (<span class="kbd">k</span>-matching).</li>
          <li><b>Ordinary wave:</b> behaves like isotropic refraction with index <span class="kbd">n<sub>o</sub></span>; <b>ray direction equals wavevector direction</b>.</li>
          <li><b>Extraordinary wave:</b> has a <b>direction-dependent phase index</b> <span class="kbd">n(θ)</span> determined by the angle to the optic axis; its <b>ray (energy) direction is generally not parallel to k</b> (walk-off).</li>
          <li><b>Governing equations:</b> Snell-type relation from tangential <span class="kbd">k</span>-continuity and the uniaxial extraordinary index surface.</li>
          <li><b>Numeric results (given case θ<sub>i</sub>=30°):</b> both transmitted wavevectors are at ≈ <b>18.895°</b> from the normal (very close because <span class="kbd">n<sub>e</sub>≈n<sub>o</sub></span>).</li>
          <li><b>Ray directions:</b> ordinary ray: same as its wavevector; extraordinary ray: shifted by a small walk-off ≈ <b>0.127°</b> (for this geometry and indices).</li>
          <li><b>Final result type:</b> numeric directions + a clear method usable for any incidence angle (see interactive plots).</li>
        </ul>
      </div>
    </section>

    <!-- PART 0 -->
    <section id="part0">
      <div class="secInner">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <div class="grid2">
          <div class="callout">
            <strong>Core definitions</strong>
            <ul>
              <li><span class="kbd">k</span> — wavevector (units: 1/m). Direction of <b>phase propagation</b>. Magnitude: <span class="kbd">|k| = n(θ) k<sub>0</sub></span>, where <span class="kbd">k<sub>0</sub>=2π/λ</span>.</li>
              <li><span class="kbd">S</span> — Poynting vector (units: W/m²). Direction of <b>energy flow</b> (the “ray direction”).</li>
              <li><span class="kbd">n<sub>o</sub>, n<sub>e</sub></span> — ordinary and extraordinary refractive indices (dimensionless) of a <b>uniaxial</b> crystal.</li>
              <li><span class="kbd">θ</span> — angle between the extraordinary wavevector and the optic axis (radians or degrees).</li>
            </ul>
          </div>

          <div class="callout warn">
            <strong>Physical meaning (what matters)</strong>
            <ul>
              <li><b>Boundary condition uses k, not S:</b> At a flat interface, the <b>phase</b> must match along the boundary, so the <b>tangential component of k</b> is continuous.</li>
              <li><b>Ordinary wave:</b> sees the medium as isotropic → <span class="kbd">S ∥ k</span>.</li>
              <li><b>Extraordinary wave:</b> anisotropy makes <span class="kbd">S</span> deviate from <span class="kbd">k</span> → “beam walk-off.”</li>
            </ul>
          </div>
        </div>

        <h3>Key laws / principles (and validity)</h3>
        <ul>
          <li><b>Tangential k continuity</b> (phase matching): for a planar interface, <span class="kbd">k<sub>t,‖</sub> = k<sub>i,‖</sub></span>. Valid for linear, homogeneous media with a flat boundary.</li>
          <li><b>Ordinary refraction:</b> Snell’s law with <span class="kbd">n<sub>o</sub></span> because the ordinary wave has a spherical wave-normal surface.</li>
          <li><b>Extraordinary phase index:</b> in a uniaxial crystal, the extraordinary phase refractive index depends on direction:
            <div class="eq" data-copy="1/n(θ)^2 = cos^2θ / n_e^2 + sin^2θ / n_o^2">
              <button class="copyBtn" type="button">Copy</button>
              1/n(θ)^2 = cos^2(θ) / n_e^2 + sin^2(θ) / n_o^2
            </div>
          </li>
          <li><b>Ray (walk-off) angle ρ</b> (principal section): extraordinary energy flow is generally not parallel to k. A widely used expression is:
            <div class="eq" data-copy="tan ρ = (n_o^2 - n_e^2) sinθ cosθ / (n_o^2 sin^2θ + n_e^2 cos^2θ)">
              <button class="copyBtn" type="button">Copy</button>
              tan(ρ) = (n_o^2 - n_e^2) sin(θ) cos(θ) / (n_o^2 sin^2(θ) + n_e^2 cos^2(θ))
            </div>
            Here θ is the angle between the extraordinary <span class="kbd">k</span> and the optic axis. The sign tells whether the ray tilts toward or away from the optic axis.
          </li>
        </ul>

        <h3>Common approximations (why we use them)</h3>
        <ul>
          <li><b>Plane-wave / geometric optics limit:</b> Wavelength ≪ device dimensions, so we talk about directions of k and rays.</li>
          <li><b>Sharp interface, no absorption:</b> allows simple boundary phase matching and real refractive indices.</li>
          <li><b>Uniaxial model:</b> quartz can be treated as uniaxial at the given wavelength, with two principal indices.</li>
        </ul>

        <div class="twoCol">
          <div>
            <h3>Mini intuition examples</h3>
            <ul>
              <li>If the optic axis is <b>perpendicular</b> to the propagation direction, the extraordinary index tends toward <span class="kbd">n(θ)≈n<sub>o</sub></span> (because sinθ≈1).</li>
              <li>If the optic axis is <b>parallel</b> to the propagation direction, the extraordinary index tends toward <span class="kbd">n(θ)≈n<sub>e</sub></span> (because cosθ≈1).</li>
            </ul>
          </div>
          <div class="callout danger">
            <strong>What to watch for (pitfalls)</strong>
            <ul>
              <li>Using Snell’s law with <span class="kbd">n<sub>e</sub></span> directly for the extraordinary wave (wrong in general).</li>
              <li>Confusing <b>wavevector direction</b> (phase) with <b>ray direction</b> (energy).</li>
              <li>For extraordinary waves, forgetting that <span class="kbd">n(θ)</span> depends on the unknown refracted direction — it’s an implicit problem.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PART 1 -->
    <section id="part1">
      <div class="secInner">
        <h2>PART 1 — Problem Analysis (No solving yet)</h2>

        <h3>Problem restatement (in plain words)</h3>
        <p>
          A plane wave in air (free space) hits a flat quartz surface at incidence angle <b>30°</b>.
          Quartz is uniaxial with <span class="kbd">n<sub>e</sub>=1.553</span>, <span class="kbd">n<sub>o</sub>=1.544</span>.
          The <b>optic axis lies in the plane of incidence</b> and is <b>perpendicular to the incident wave direction</b> (in air).
          Find the directions (angles) of the transmitted <b>wavevectors</b> and <b>rays</b> for the two refracted components.
        </p>

        <div class="grid2">
          <div class="callout">
            <strong>Given</strong>
            <ul>
              <li>Incidence medium: air, <span class="kbd">n<sub>1</sub>≈1</span></li>
              <li>Crystal: uniaxial quartz, <span class="kbd">n<sub>o</sub>=1.544</span>, <span class="kbd">n<sub>e</sub>=1.553</span></li>
              <li>Incidence angle: <span class="kbd">θ<sub>i</sub>=30°</span></li>
              <li>Optic axis in plane of incidence and ⟂ incident direction</li>
            </ul>
          </div>
          <div class="callout">
            <strong>Unknowns</strong>
            <ul>
              <li>Ordinary transmitted wavevector direction <span class="kbd">θ<sub>o,k</sub></span></li>
              <li>Extraordinary transmitted wavevector direction <span class="kbd">θ<sub>e,k</sub></span></li>
              <li>Ordinary ray direction <span class="kbd">θ<sub>o,S</sub></span> (same as <span class="kbd">θ<sub>o,k</sub></span>)</li>
              <li>Extraordinary ray direction <span class="kbd">θ<sub>e,S</sub></span> (includes walk-off)</li>
            </ul>
          </div>
        </div>

        <h3>Relevant principles (and why they apply)</h3>
        <ul>
          <li><b>Phase matching at the boundary:</b> the interface is planar, so the phase along the interface must match → <b>tangential k is conserved</b>. This determines wavevector directions.</li>
          <li><b>Uniaxial dispersion:</b> quartz supports two eigenmodes for a given propagation direction: ordinary (index <span class="kbd">n<sub>o</sub></span>) and extraordinary (index <span class="kbd">n(θ)</span> depends on direction relative to optic axis).</li>
          <li><b>Energy flow:</b> the <b>rays</b> follow the Poynting vector. For ordinary waves <span class="kbd">S ∥ k</span>, but for extraordinary waves generally <span class="kbd">S</span> is tilted relative to <span class="kbd">k</span>.</li>
        </ul>

        <h3>Assumptions (explicit)</h3>
        <div class="callout">
          <ul>
            <li>Linear, homogeneous, lossless media; monochromatic plane wave.</li>
            <li>Flat interface; no surface roughness.</li>
            <li>Geometric (ray) interpretation is valid; ignore beam divergence and finite beam width.</li>
            <li>We treat the indices as constants (no dispersion modeling beyond given values).</li>
          </ul>
        </div>

        <h3>Possible approaches (compare briefly)</h3>
        <ul>
          <li><b>Approach A (best here):</b> Use tangential <span class="kbd">k</span>-continuity + uniaxial extraordinary index formula to find <span class="kbd">θ<sub>e,k</sub></span> implicitly, then compute walk-off for the ray. <i>Pros:</i> direct, compact, standard in crystal optics. <i>Cons:</i> extraordinary angle requires a small numeric solve.</li>
          <li><b>Approach B:</b> Full Maxwell eigenmode boundary-value solution (field matching) to obtain both modes and directions. <i>Pros:</i> complete polarization amplitudes too. <i>Cons:</i> much heavier than needed when only directions are asked.</li>
          <li><b>Approach C:</b> Huygens construction using wave-normal and ray surfaces (graphical). <i>Pros:</i> very intuitive for birefringence. <i>Cons:</i> needs accurate plotting; less convenient for crisp numbers.</li>
        </ul>
        <p><b>Choice:</b> Approach A — it targets exactly what the problem asks: wavevector directions and ray directions.</p>
      </div>
    </section>

    <!-- PART 2 -->
    <section id="part2">
      <div class="secInner">
        <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

        <ol>
          <li><b>Set geometry axes:</b> define the interface normal and plane of incidence. <span class="small">(Tool: coordinate geometry)</span> <br/>
            <span class="small">Meaning: angles will be measured from the normal inside the crystal.</span>
          </li>
          <li><b>Encode the optic axis orientation:</b> use “optic axis in plane of incidence and ⟂ incident k in air” to determine its angle relative to the normal. <br/>
            <span class="small">Meaning: this fixes the angle θ between extraordinary k and the optic axis.</span>
          </li>
          <li><b>Ordinary wavevector direction:</b> apply Snell’s law with <span class="kbd">n<sub>o</sub></span>. <br/>
            <span class="small">Meaning: ordinary phase propagation is isotropic.</span>
          </li>
          <li><b>Extraordinary wavevector direction:</b> impose tangential k continuity:
            <span class="kbd">sin θ<sub>e,k</sub> = (n<sub>1</sub>/n(θ)) sin θ<sub>i</sub></span>,
            but <span class="kbd">n(θ)</span> depends on the unknown direction via θ (angle to optic axis). <br/>
            <span class="small">Meaning: solve an implicit equation for θ<sub>e,k</sub>.</span>
          </li>
          <li><b>Compute walk-off angle ρ:</b> use the walk-off formula in the principal section. <br/>
            <span class="small">Meaning: ray direction differs from wavevector direction for extraordinary.</span>
          </li>
          <li><b>Report directions:</b> give both wavevector angles and ray angles, and indicate their sides in the plane of incidence. <br/>
            <span class="small">Meaning: you can sketch the double refraction geometry unambiguously.</span>
          </li>
          <li><b>Sanity checks:</b> verify angles are real (no total internal reflection here), compare to isotropic estimate, and check limiting behavior (birefringence → 0 gives same angles).</li>
        </ol>

        <div class="grid2">
          <div class="callout warn">
            <strong>Common mistakes</strong>
            <ul>
              <li>Using <span class="kbd">n<sub>e</sub></span> in Snell’s law for the extraordinary wave (should use <span class="kbd">n(θ)</span>).</li>
              <li>Reporting only wavevector directions (but the question also asks for rays).</li>
              <li>Mixing up the angle θ to the optic axis with the transmitted angle to the normal.</li>
            </ul>
          </div>
          <div class="callout">
            <strong>Quick tips</strong>
            <ul>
              <li>Do the ordinary wave first — it anchors the scale of angles.</li>
              <li>For extraordinary: solve <span class="kbd">θ<sub>e,k</sub></span> numerically; with small birefringence the result is close to the ordinary one.</li>
              <li>Walk-off is often small in quartz — but conceptually important.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PART 3 -->
    <section id="part3">
      <div class="secInner">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Physical intuition before calculating</h3>
        <p>
          Quartz here has very small birefringence: <span class="kbd">n<sub>e</sub>−n<sub>o</sub>≈0.009</span>.
          So we expect the ordinary and extraordinary transmitted <b>wavevector</b> directions to be <b>very close</b>.
          The real “double refraction” distinction will show up as (i) <b>two polarizations</b> with slightly different phase indices,
          and (ii) a small <b>walk-off</b> of the extraordinary <b>ray</b> direction relative to its wavevector.
        </p>

        <h3>Step 1 — Geometry and optic axis direction</h3>
        <p>
          Let the interface normal point into the crystal along +z, and the plane of incidence be the x–z plane.
          The incident wavevector in air makes angle <span class="kbd">θ<sub>i</sub>=30°</span> with the normal,
          so a unit direction is
          <span class="kbd">k̂<sub>i</sub> = (sinθ<sub>i</sub>, 0, cosθ<sub>i</sub>)</span>.
        </p>
        <p>
          The optic axis lies in the x–z plane and is perpendicular to the incident direction:
          <span class="kbd">â · k̂<sub>i</sub> = 0</span>.
          A unit vector in the same plane satisfying this is
          <span class="kbd">â = (−cosθ<sub>i</sub>, 0, sinθ<sub>i</sub>)</span>.
          This means the optic axis makes an angle
          <span class="kbd">α = arccos(â·ẑ) = arccos(sinθ<sub>i</sub>)</span>
          with the +z normal. For θ<sub>i</sub>=30°, <span class="kbd">α = 60°</span>.
        </p>

        <div class="callout">
          <strong>Important geometric consequence</strong>
          <p style="margin:8px 0 0; color:var(--muted)">
            In the plane of incidence, the optic axis is tilted 60° from the normal but on the opposite side of the normal relative to the incident beam (so it is perpendicular to the incident direction in air).
            This fixes the angle between the extraordinary wavevector and the optic axis.
          </p>
        </div>

        <h3>Step 2 — Ordinary transmitted wavevector direction</h3>
        <p>
          The ordinary wave sees a direction-independent refractive index <span class="kbd">n<sub>o</sub></span>.
          Tangential <span class="kbd">k</span>-matching reduces to Snell’s law:
        </p>

        <div class="eq" data-copy="n1 sin(θi) = n_o sin(θo,k)  (ordinary)">
          <button class="copyBtn" type="button">Copy</button>
          n1 sin(θi) = n_o sin(θo,k)    (ordinary)
        </div>

        <p>With <span class="kbd">n1≈1</span>, <span class="kbd">θi=30°</span>, <span class="kbd">n_o=1.544</span>:</p>
        <div class="eq" data-copy="sin(θo,k) = sin(30°)/1.544 = 0.5/1.544 = 0.3238  ⇒  θo,k ≈ 18.895°">
          <button class="copyBtn" type="button">Copy</button>
          sin(θo,k) = sin(30°)/1.544 = 0.5/1.544 = 0.3238  ⇒  θo,k ≈ 18.895°
        </div>

        <p>
          For the ordinary wave in a lossless dielectric, the ray direction equals the wavevector direction:
          <span class="kbd">θ<sub>o,S</sub> = θ<sub>o,k</sub></span>.
        </p>

        <h3>Step 3 — Extraordinary transmitted wavevector direction (implicit refraction)</h3>
        <p>
          For the extraordinary wave, the <b>phase refractive index</b> depends on the angle θ between its wavevector and the optic axis:
        </p>

        <div class="eq" data-copy="1/n(θ)^2 = cos^2θ / n_e^2 + sin^2θ / n_o^2  (extraordinary phase index)">
          <button class="copyBtn" type="button">Copy</button>
          1/n(θ)^2 = cos^2(θ) / n_e^2 + sin^2(θ) / n_o^2   (extraordinary phase index)
        </div>

        <p>
          Tangential <span class="kbd">k</span>-continuity gives the Snell-like relation:
        </p>
        <div class="eq" data-copy="n1 sin(θi) = n(θ) sin(θe,k)  (extraordinary, phase matching)">
          <button class="copyBtn" type="button">Copy</button>
          n1 sin(θi) = n(θ) sin(θe,k)   (extraordinary, phase matching)
        </div>

        <p>
          But θ is not the same as θ<sub>e,k</sub>. In the plane of incidence, if the optic axis is at angle α=60° on the opposite side,
          then the angle between the extraordinary k and the optic axis is
          <span class="kbd">θ = θ<sub>e,k</sub> + α</span>.
          So here: <span class="kbd">θ = θ<sub>e,k</sub> + 60°</span>.
        </p>

        <p>
          Therefore we must solve the implicit equation:
        </p>

        <div class="eq" data-copy="sin(θe,k) = sin(θi) / n(θe,k + α),  with α=60°">
          <button class="copyBtn" type="button">Copy</button>
          sin(θe,k) = sin(θi) / n(θe,k + α),   with α = 60°
        </div>

        <p>
          Numerically (with <span class="kbd">n_e=1.553</span>, <span class="kbd">n_o=1.544</span>, θ<sub>i</sub>=30°, α=60°),
          the solution is:
          <span class="kbd">θ<sub>e,k</sub> ≈ 18.891°</span>.
          It is extremely close to the ordinary value because birefringence is small and the geometry makes θ close to 90° (where <span class="kbd">n(θ)≈n_o</span>).
        </p>

        <h3>Step 4 — Extraordinary ray direction (walk-off)</h3>
        <p>
          The extraordinary ray (energy flow) direction is tilted relative to the extraordinary wavevector by a walk-off angle ρ.
          Using the principal-section expression:
        </p>

        <div class="eq" data-copy="tan(ρ) = (n_o^2 - n_e^2) sinθ cosθ / (n_o^2 sin^2θ + n_e^2 cos^2θ)">
          <button class="copyBtn" type="button">Copy</button>
          tan(ρ) = (n_o^2 - n_e^2) sin(θ) cos(θ) / (n_o^2 sin^2(θ) + n_e^2 cos^2(θ))
        </div>

        <p>
          Here θ is the angle between extraordinary <span class="kbd">k</span> and the optic axis:
          <span class="kbd">θ = θ<sub>e,k</sub> + 60° ≈ 78.891°</span>.
          Plugging in <span class="kbd">n_o=1.544</span>, <span class="kbd">n_e=1.553</span> gives:
          <span class="kbd">ρ ≈ −0.127°</span>.
        </p>

        <p>
          The negative sign (with the convention above) means the ray tilts <b>away from the optic axis</b> for this positive uniaxial case (<span class="kbd">n_e > n_o</span>).
          Since the optic axis is on the opposite side of the normal, “away from it” means the extraordinary ray is tilted slightly <b>further</b> toward the incident side.
          Thus the extraordinary ray angle from the normal is approximately:
          <span class="kbd">θ<sub>e,S</sub> ≈ θ<sub>e,k</sub> + |ρ| ≈ 19.017°</span>.
        </p>

        <div class="callout">
          <strong>Sanity checks</strong>
          <ul>
            <li><b>Units:</b> all angles are dimensionless (degrees here); Snell relations use sine ratios → consistent.</li>
            <li><b>Limiting case:</b> if <span class="kbd">n_e → n_o</span>, then <span class="kbd">n(θ)</span> becomes constant and ρ→0; ordinary and extraordinary become identical — correct.</li>
            <li><b>Direction reasoning:</b> ordinary has <span class="kbd">S ∥ k</span>; extraordinary has small walk-off whose magnitude is small because birefringence is small and θ is not near 45° where sinθ cosθ is largest.</li>
          </ul>
        </div>

        <h3>Final results (directions of wavevectors and rays)</h3>
        <div class="eq" data-copy="Given θi=30°, n_o=1.544, n_e=1.553, optic axis in plane of incidence and ⟂ incident k:\n\nOrdinary component:\n  Wavevector angle: θo,k = arcsin( sinθi / n_o ) ≈ 18.895° (from the normal, in the incidence plane)\n  Ray angle:       θo,S = θo,k ≈ 18.895°\n\nExtraordinary component:\n  Wavevector angle θe,k solves: sin(θe,k) = sin(θi)/n(θe,k+60°)\n  with 1/n(θ)^2 = cos^2θ/n_e^2 + sin^2θ/n_o^2\n  ⇒ θe,k ≈ 18.891°\n  Walk-off: ρ ≈ −0.127° (ray tilted away from the optic axis)\n  Ray angle: θe,S ≈ 19.017° (from the normal, in the incidence plane)">
          <button class="copyBtn" type="button">Copy</button>
Given θi=30°, n_o=1.544, n_e=1.553, optic axis in plane of incidence and ⟂ incident k:

Ordinary component:
  Wavevector angle: θo,k = arcsin( sinθi / n_o ) ≈ 18.895° (from the normal, in the incidence plane)
  Ray angle:       θo,S = θo,k ≈ 18.895°

Extraordinary component:
  Wavevector angle θe,k solves: sin(θe,k) = sin(θi)/n(θe,k+60°)
  with 1/n(θ)^2 = cos^2θ/n_e^2 + sin^2θ/n_o^2
  ⇒ θe,k ≈ 18.891°
  Walk-off: ρ ≈ −0.127° (ray tilted away from the optic axis)
  Ray angle: θe,S ≈ 19.017° (from the normal, in the incidence plane)
        </div>

        <p>
          <b>Connection to the diagram/plots:</b> In the visualization below, you’ll see two transmitted <span class="kbd">k</span> directions (very close),
          and the extraordinary ray slightly separated due to walk-off. Use the slider to change θ<sub>i</sub> and watch how the extraordinary solution becomes more distinct as geometry changes.
        </p>
      </div>
    </section>

    <!-- PART 4 -->
    <section id="part4">
      <div class="secInner">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpreting the formulas</h3>
        <ul>
          <li><span class="kbd">n(θ)</span> is a <b>phase index</b>: it controls how fast phase fronts move along <span class="kbd">k</span>. It is governed by the uniaxial index ellipsoid and depends on the angle to the optic axis.</li>
          <li>The equation <span class="kbd">n1 sinθi = n(θ) sinθe,k</span> is really about <b>matching phase along the interface</b> (the x-direction here): it picks the allowed transmitted wave normals.</li>
          <li>The walk-off expression shows that ρ is proportional to <span class="kbd">(n_o^2 - n_e^2) sinθ cosθ</span>:
            <ul>
              <li>It vanishes if the material is isotropic (<span class="kbd">n_o=n_e</span>).</li>
              <li>It vanishes if θ is near 0° or 90° (because <span class="kbd">sinθ cosθ</span> is small).</li>
              <li>Its sign flips between positive and negative uniaxial crystals.</li>
            </ul>
          </li>
        </ul>

        <h3>How changing parameters affects the outcome (connect to plots)</h3>
        <ul>
          <li><b>Increase θ<sub>i</sub>:</b> ordinary and extraordinary wavevector angles both increase, but extraordinary may deviate depending on how θ changes relative to the optic axis.</li>
          <li><b>Increase birefringence (|n<sub>e</sub>−n<sub>o</sub>|):</b> the separation between ordinary and extraordinary behaviors grows, and walk-off increases.</li>
          <li><b>Rotate optic axis (conceptually):</b> changes θ, thus changes both the extraordinary phase index and walk-off dramatically. (In this problem, the optic axis is fixed by “perpendicular to incident k.”)</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p>
          Instead of using the scalar extraordinary index formula, you can derive the same result by:
          (i) writing the dielectric tensor for a uniaxial crystal,
          (ii) solving the Fresnel wave equation (eigenproblem) for allowed <span class="kbd">k</span> at fixed tangential component,
          and (iii) computing the group velocity direction (ray direction) from the gradient of the dispersion relation.
          This is more general and automatically handles arbitrary axis orientations, but is heavier algebraically.
        </p>

        <h3>Concept check (self-test)</h3>
        <ul>
          <li><b>Q:</b> Which vector is constrained to have a continuous tangential component at the boundary, <span class="kbd">k</span> or <span class="kbd">S</span>? <br/><b>A:</b> <span class="kbd">k</span>, because it enforces phase matching along the interface.</li>
          <li><b>Q:</b> Why does the ordinary wave obey Snell’s law with <span class="kbd">n<sub>o</sub></span>? <br/><b>A:</b> Its wave-normal surface is spherical (isotropic) so its phase index is direction-independent.</li>
          <li><b>Q:</b> Can the extraordinary ray and wavevector point in different directions? <br/><b>A:</b> Yes; anisotropy makes the energy velocity (ray) not parallel to the phase velocity (wave normal).</li>
          <li><b>Q:</b> Why are the ordinary and extraordinary wavevector angles almost identical here? <br/><b>A:</b> Birefringence is small and the optic-axis geometry makes θ close to 90°, where <span class="kbd">n(θ)≈n<sub>o</sub></span>.</li>
        </ul>
      </div>
    </section>

    <!-- PART 5 -->
    <section id="part5">
      <div class="secInner">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <div class="grid2">
          <div class="callout">
            <strong>Diagram canvas</strong>
            <ul>
              <li>Shows the interface, normal, incident beam, optic axis, and the two refracted <span class="kbd">k</span> directions.</li>
              <li>Also shows the extraordinary <span class="kbd">S</span> direction slightly separated from <span class="kbd">k</span> (walk-off).</li>
              <li>Angles are measured from the normal (inside the crystal) unless labeled “incident.”</li>
            </ul>
          </div>
          <div class="callout">
            <strong>Main plot</strong>
            <ul>
              <li>Plots transmitted wavevector angles <span class="kbd">θ<sub>o,k</sub></span> and <span class="kbd">θ<sub>e,k</sub></span> vs incidence angle <span class="kbd">θ<sub>i</sub></span>.</li>
              <li>Reveals how extraordinary refraction depends on direction through <span class="kbd">n(θ)</span>.</li>
            </ul>
          </div>
        </div>

        <div class="callout warn" style="margin-top:14px;">
          <strong>Secondary plot + interactive control</strong>
          <ul>
            <li>The secondary plot shows the extraordinary walk-off <span class="kbd">ρ</span> vs incidence angle <span class="kbd">θ<sub>i</sub></span>.</li>
            <li>Use the slider to change <span class="kbd">θ<sub>i</sub></span>. All canvases update live: diagram + both plots.</li>
            <li>Watch for where <span class="kbd">|ρ|</span> increases: it tends to be larger when θ (to optic axis) is closer to ~45° and when birefringence is larger.</li>
          </ul>
        </div>
      </div>

      <figure id="viz">
        <div class="vizWrap">
          <div class="controls">
            <div class="ctrl">
              <label>
                <span>Incidence angle <span class="kbd">θ<sub>i</sub></span> (degrees)</span>
                <span class="val" id="thetaIVal">30.0°</span>
              </label>
              <input id="thetaISlider" type="range" min="0" max="70" step="0.1" value="30">
              <div class="small">Changes the geometry (and optic-axis tilt α = 90° − θ<sub>i</sub>).</div>
            </div>

            <div class="ctrl">
              <label>
                <span>Ordinary index <span class="kbd">n<sub>o</sub></span></span>
                <span class="val" id="noVal">1.544</span>
              </label>
              <input id="noSlider" type="range" min="1.40" max="1.70" step="0.001" value="1.544">
              <div class="small">For exploration. Problem uses 1.544.</div>
            </div>

            <div class="ctrl">
              <label>
                <span>Extraordinary index <span class="kbd">n<sub>e</sub></span></span>
                <span class="val" id="neVal">1.553</span>
              </label>
              <input id="neSlider" type="range" min="1.40" max="1.70" step="0.001" value="1.553">
              <div class="small">For exploration. Problem uses 1.553.</div>
            </div>
          </div>

          <div class="vizGrid">
            <div class="canvasCard">
              <div class="canvasTitle">
                <h4>Diagram — Interface, optic axis, wavevectors (<span class="kbd">k</span>) and rays (<span class="kbd">S</span>)</h4>
                <div class="small" id="diagReadout"></div>
              </div>
              <canvas id="diagramCanvas" aria-label="diagram canvas"></canvas>
            </div>

            <div class="canvasCard">
              <div class="canvasTitle">
                <h4>Main plot — Transmitted wavevector angles vs incidence angle</h4>
                <div class="small" id="mainReadout"></div>
              </div>
              <canvas id="mainPlotCanvas" aria-label="main plot canvas"></canvas>
            </div>

            <div class="canvasCard" style="grid-column: 1 / -1;">
              <div class="canvasTitle">
                <h4>Secondary plot — Extraordinary walk-off ρ vs incidence angle</h4>
                <div class="small" id="secReadout"></div>
              </div>
              <canvas id="secPlotCanvas" aria-label="secondary plot canvas"></canvas>
            </div>
          </div>
        </div>
      </figure>
    </section>
  </main>

  <footer class="footer">
    <div class="divider"></div>
    <p>
      Built as a self-contained learning article: theory → analysis → solution → interpretation → interactive visualization.
      Tip: use the <span class="kbd">Copy</span> buttons on equations and the final answer block to paste into notes.
    </p>
  </footer>

  <script>
    // ---------- Utilities ----------
    const DEG = Math.PI/180;

    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

    function copyText(txt){
      if(navigator.clipboard && navigator.clipboard.writeText){
        navigator.clipboard.writeText(txt).catch(()=>fallbackCopy(txt));
      } else {
        fallbackCopy(txt);
      }
    }
    function fallbackCopy(txt){
      const ta=document.createElement('textarea');
      ta.value=txt; ta.style.position='fixed'; ta.style.left='-9999px';
      document.body.appendChild(ta);
      ta.focus(); ta.select();
      try{ document.execCommand('copy'); }catch(e){}
      document.body.removeChild(ta);
    }

    // Attach copy buttons for .eq blocks
    document.querySelectorAll('.eq').forEach(eq=>{
      const btn = eq.querySelector('.copyBtn');
      if(!btn) return;
      btn.addEventListener('click', ()=>{
        const txt = eq.getAttribute('data-copy') || eq.innerText;
        copyText(txt.trim());
        btn.textContent='Copied!';
        setTimeout(()=>btn.textContent='Copy', 800);
      });
    });

    // Smooth scroll for TOC
    document.querySelectorAll('.toc a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        const href = a.getAttribute('href');
        if(href && href.startsWith('#')){
          e.preventDefault();
          const el = document.querySelector(href);
          if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
        }
      });
    });

    // ---------- Physics model ----------
    // Geometry: interface normal is +z, plane of incidence x-z.
    // Incident wavevector is on +x side at angle theta_i from +z.
    // Optic axis lies in x-z plane, perpendicular to incident k in air.
    // We choose optic axis direction on -x side, making an angle alpha = 90° - theta_i with +z.
    // Thus angle between extraordinary k and optic axis is theta = theta_e_k + alpha (since opposite sides).
    function nExtraPhase(theta, no, ne){
      // theta is angle between k and optic axis (radians)
      const c = Math.cos(theta), s = Math.sin(theta);
      const inv2 = (c*c)/(ne*ne) + (s*s)/(no*no);
      return 1/Math.sqrt(inv2);
    }

    function solveThetaExtraK(theta_i, no, ne){
      // Solve sin(theta_t) = sin(theta_i)/n(theta_t + alpha)
      // where alpha = 90° - theta_i (in radians).
      // Use robust bisection on [0, arcsin( sin(theta_i) / min(no,ne) ) ] expanded safely.
      const alpha = (Math.PI/2) - theta_i;

      const sI = Math.sin(theta_i);

      function f(theta_t){
        const nEff = nExtraPhase(theta_t + alpha, no, ne);
        return Math.sin(theta_t) - (sI / nEff);
      }

      // bracket
      let lo = 0;
      let hi = Math.min(Math.PI/2 - 1e-6, Math.asin(Math.min(0.999999, sI / Math.min(no, ne))) + 0.2);
      hi = clamp(hi, 1e-6, Math.PI/2 - 1e-6);

      // ensure sign change; if not, widen hi
      let flo = f(lo);
      let fhi = f(hi);
      let tries = 0;
      while(flo*fhi > 0 && tries < 30){
        hi = clamp(hi + 0.05, 1e-6, Math.PI/2 - 1e-6);
        fhi = f(hi);
        tries++;
      }

      // If still no sign change (rare), fall back to Newton-ish scan
      if(flo*fhi > 0){
        let bestT = hi, bestAbs = Math.abs(fhi);
        for(let t=0; t<=hi; t+=hi/200){
          const ft = f(t);
          const a = Math.abs(ft);
          if(a < bestAbs){ bestAbs=a; bestT=t; }
        }
        return bestT;
      }

      // bisection
      for(let i=0;i<70;i++){
        const mid = 0.5*(lo+hi);
        const fm = f(mid);
        if(flo*fm <= 0){ hi=mid; fhi=fm; }
        else { lo=mid; flo=fm; }
      }
      return 0.5*(lo+hi);
    }

    function thetaOrdK(theta_i, no){
      const val = Math.sin(theta_i)/no;
      return Math.asin(clamp(val, -1, 1));
    }

    function walkoffRho(thetaBetween, no, ne){
      // tan ρ = (no^2 - ne^2) sinθ cosθ / (no^2 sin^2θ + ne^2 cos^2θ)
      const s = Math.sin(thetaBetween), c = Math.cos(thetaBetween);
      const num = (no*no - ne*ne) * s * c;
      const den = (no*no)*(s*s) + (ne*ne)*(c*c);
      return Math.atan2(num, den); // preserves sign
    }

    function computeAll(thetaIDeg, no, ne){
      const theta_i = thetaIDeg * DEG;
      const alpha = (Math.PI/2) - theta_i;

      const theta_ok = thetaOrdK(theta_i, no);

      const theta_ek = solveThetaExtraK(theta_i, no, ne);
      const theta_between = theta_ek + alpha; // angle between k_e and optic axis (opposite sides)
      const rho = walkoffRho(theta_between, no, ne);

      // Ray direction: for our chosen geometry (optic axis on opposite side),
      // negative rho corresponds to tilt away from optic axis → slightly larger angle from the normal on the incident side.
      // We'll implement: theta_eS = theta_ek + (-rho) (i.e., add |rho| when rho negative).
      const theta_eS = theta_ek - rho;

      return {
        theta_i, alpha,
        theta_ok, theta_oS: theta_ok,
        theta_ek, theta_between,
        rho, theta_eS
      };
    }

    // ---------- Canvas helpers ----------
    function setupCanvas(canvas){
      const ctx = canvas.getContext('2d');
      function resize(){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        const w = Math.max(300, rect.width);
        const h = Math.max(260, rect.height);
        canvas.width = Math.round(w*dpr);
        canvas.height = Math.round(h*dpr);
        ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
        return {w, h, dpr};
      }
      return {ctx, resize};
    }

    function clear(ctx,w,h){
      ctx.clearRect(0,0,w,h);
      // subtle background grid
      ctx.save();
      ctx.globalAlpha = 0.10;
      ctx.strokeStyle = '#ffffff';
      ctx.lineWidth = 1;
      const step = 28;
      for(let x=0;x<=w;x+=step){
        ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,h); ctx.stroke();
      }
      for(let y=0;y<=h;y+=step){
        ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(w,y); ctx.stroke();
      }
      ctx.restore();
    }

    function drawAxes(ctx, box, xLabel, yLabel, title){
      const {x,y,w,h} = box;
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,.55)';
      ctx.lineWidth = 1;
      ctx.fillStyle = 'rgba(255,255,255,.85)';
      ctx.font = '13px system-ui, -apple-system, Segoe UI, Roboto, Arial';

      // title
      ctx.fillText(title, x+6, y+16);

      // axes frame
      ctx.strokeStyle = 'rgba(255,255,255,.30)';
      ctx.strokeRect(x, y, w, h);

      // labels
      ctx.fillStyle = 'rgba(255,255,255,.80)';
      ctx.fillText(xLabel, x + w - ctx.measureText(xLabel).width - 8, y + h - 8);

      ctx.save();
      ctx.translate(x+10, y+18);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();

      ctx.restore();
    }

    function plotLine(ctx, box, xs, ys, xMin, xMax, yMin, yMax, style){
      const {x,y,w,h} = box;
      const padL=44, padR=14, padT=26, padB=30;
      const X0=x+padL, Y0=y+padT, W=w-padL-padR, H=h-padT-padB;

      // gridlines + ticks
      ctx.save();
      ctx.strokeStyle='rgba(255,255,255,.16)';
      ctx.fillStyle='rgba(255,255,255,.70)';
      ctx.lineWidth=1;
      ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

      const nx=6, ny=6;
      for(let i=0;i<=nx;i++){
        const gx = X0 + (i/nx)*W;
        ctx.beginPath(); ctx.moveTo(gx, Y0); ctx.lineTo(gx, Y0+H); ctx.stroke();
        const xv = xMin + (i/nx)*(xMax-xMin);
        const txt = xv.toFixed(0);
        ctx.fillText(txt, gx-8, Y0+H+18);
      }
      for(let j=0;j<=ny;j++){
        const gy = Y0 + (j/ny)*H;
        ctx.beginPath(); ctx.moveTo(X0, gy); ctx.lineTo(X0+W, gy); ctx.stroke();
        const yv = yMax - (j/ny)*(yMax-yMin);
        const txt = yv.toFixed(1);
        ctx.fillText(txt, X0-40, gy+4);
      }

      // mapping
      function mx(xv){ return X0 + ( (xv-xMin)/(xMax-xMin) )*W; }
      function my(yv){ return Y0 + ( (yMax-yv)/(yMax-yMin) )*H; }

      // line
      ctx.strokeStyle = style.stroke;
      ctx.lineWidth = style.width || 2;
      ctx.beginPath();
      for(let i=0;i<xs.length;i++){
        const px=mx(xs[i]), py=my(ys[i]);
        if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      }
      ctx.stroke();

      ctx.restore();

      return {X0,Y0,W,H, mx, my};
    }

    function legend(ctx, x, y, items){
      ctx.save();
      ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      let yy=y;
      items.forEach(it=>{
        ctx.fillStyle=it.stroke;
        ctx.fillRect(x, yy-10, 14, 3);
        ctx.fillStyle='rgba(255,255,255,.85)';
        ctx.fillText(it.label, x+20, yy-6);
        yy += 16;
      });
      ctx.restore();
    }

    function arrow(ctx, x1,y1,x2,y2, color, width){
      const dx=x2-x1, dy=y2-y1;
      const L=Math.hypot(dx,dy) || 1;
      const ux=dx/L, uy=dy/L;
      const head=10;
      ctx.save();
      ctx.strokeStyle=color;
      ctx.fillStyle=color;
      ctx.lineWidth=width||2;
      ctx.beginPath(); ctx.moveTo(x1,y1); ctx.lineTo(x2,y2); ctx.stroke();
      // head
      ctx.beginPath();
      ctx.moveTo(x2,y2);
      ctx.lineTo(x2 - head*ux + 0.6*head*(-uy), y2 - head*uy + 0.6*head*(ux));
      ctx.lineTo(x2 - head*ux - 0.6*head*(-uy), y2 - head*uy - 0.6*head*(ux));
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    function label(ctx, txt, x,y, color){
      ctx.save();
      ctx.font='12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillStyle=color||'rgba(255,255,255,.85)';
      ctx.fillText(txt, x, y);
      ctx.restore();
    }

    // ---------- Renderers ----------
    const diagram = setupCanvas(document.getElementById('diagramCanvas'));
    const mainPlot = setupCanvas(document.getElementById('mainPlotCanvas'));
    const secPlot = setupCanvas(document.getElementById('secPlotCanvas'));

    function renderDiagram(state, sizes){
      const {ctx} = diagram;
      const {w,h} = sizes;
      clear(ctx,w,h);

      const cx = w*0.52;
      const cy = h*0.56;

      // interface line: horizontal
      const yInt = h*0.50;
      ctx.save();
      ctx.strokeStyle='rgba(255,255,255,.55)';
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.moveTo(20,yInt); ctx.lineTo(w-20,yInt);
      ctx.stroke();
      ctx.restore();
      label(ctx,'air (n≈1)', 24, yInt-10, 'rgba(255,255,255,.75)');
      label(ctx,'quartz (uniaxial)', 24, yInt+18, 'rgba(255,255,255,.75)');

      // normal at interface
      arrow(ctx, cx, yInt, cx, yInt-120, 'rgba(255,255,255,.85)', 2);
      label(ctx,'normal (+z)', cx+6, yInt-110, 'rgba(255,255,255,.85)');

      // scale for rays
      const L1 = 120;

      // incident k in air: angle theta_i from normal, toward +x
      const th_i = state.theta_i;
      const incEndX = cx + L1*Math.sin(th_i);
      const incEndY = yInt - L1*Math.cos(th_i);
      arrow(ctx, cx, yInt, incEndX, incEndY, 'rgba(142,230,255,.95)', 2.4);
      label(ctx, `k_i (θi=${(th_i/DEG).toFixed(1)}°)`, incEndX+6, incEndY+4, 'rgba(142,230,255,.95)');

      // optic axis direction in air region for visualization (line), on opposite side: angle alpha from normal, toward -x
      const alpha = state.alpha;
      const oaEndX = cx - 100*Math.sin(alpha);
      const oaEndY = yInt - 100*Math.cos(alpha);
      arrow(ctx, cx, yInt, oaEndX, oaEndY, 'rgba(255,210,142,.95)', 2.2);
      label(ctx, `optic axis â (α=${(alpha/DEG).toFixed(1)}°)`, oaEndX-120, oaEndY-6, 'rgba(255,210,142,.95)');

      // transmitted ordinary k (and S): angle theta_ok from normal, into crystal (+z direction is down on canvas)
      const th_ok = state.theta_ok;
      const okEndX = cx + 125*Math.sin(th_ok);
      const okEndY = yInt + 125*Math.cos(th_ok);
      arrow(ctx, cx, yInt, okEndX, okEndY, 'rgba(167,255,181,.95)', 2.6);
      label(ctx, `k_o = S_o (θ≈${(th_ok/DEG).toFixed(3)}°)`, okEndX+6, okEndY+4, 'rgba(167,255,181,.95)');

      // transmitted extraordinary k: angle theta_ek
      const th_ek = state.theta_ek;
      const ekEndX = cx + 125*Math.sin(th_ek);
      const ekEndY = yInt + 125*Math.cos(th_ek);
      arrow(ctx, cx, yInt, ekEndX, ekEndY, 'rgba(142,230,255,.90)', 2.2);
      label(ctx, `k_e (θ≈${(th_ek/DEG).toFixed(3)}°)`, ekEndX+6, ekEndY+4, 'rgba(142,230,255,.90)');

      // extraordinary ray S: angle theta_eS
      const th_eS = state.theta_eS;
      const eSEndX = cx + 150*Math.sin(th_eS);
      const eSEndY = yInt + 150*Math.cos(th_eS);
      arrow(ctx, cx, yInt, eSEndX, eSEndY, 'rgba(255,157,176,.92)', 2.2);
      label(ctx, `S_e (walk-off ρ≈${(state.rho/DEG).toFixed(3)}°)`, eSEndX+6, eSEndY+4, 'rgba(255,157,176,.92)');

      // Angle markers
      function arcAngle(theta, color, labelTxt, offset){
        const r=38;
        ctx.save();
        ctx.strokeStyle=color;
        ctx.lineWidth=2;
        const start = -Math.PI/2; // normal direction upward
        const end = start + theta; // to the right
        ctx.beginPath();
        ctx.arc(cx, yInt, r, start, end, false);
        ctx.stroke();
        ctx.restore();
        const tx = cx + (r+offset)*Math.sin(theta/2);
        const ty = yInt - (r+offset)*Math.cos(theta/2);
        label(ctx, labelTxt, tx+6, ty+4, color);
      }
      arcAngle(th_i, 'rgba(142,230,255,.95)', 'θi', 6);
      // internal angles downwards: we can annotate near bottom
      label(ctx, `θo,k≈${(th_ok/DEG).toFixed(3)}°`, cx+10, yInt+86, 'rgba(167,255,181,.95)');
      label(ctx, `θe,k≈${(th_ek/DEG).toFixed(3)}°`, cx+10, yInt+104, 'rgba(142,230,255,.90)');
      label(ctx, `θe,S≈${(th_eS/DEG).toFixed(3)}°`, cx+10, yInt+122, 'rgba(255,157,176,.92)');

      // legend
      legend(ctx, 18, 22, [
        {stroke:'rgba(142,230,255,.95)', label:'Incident k_i / extraordinary k_e'},
        {stroke:'rgba(167,255,181,.95)', label:'Ordinary k_o and S_o'},
        {stroke:'rgba(255,157,176,.92)', label:'Extraordinary ray S_e'},
        {stroke:'rgba(255,210,142,.95)', label:'Optic axis â'}
      ]);

      document.getElementById('diagReadout').textContent =
        `θo,k=${(th_ok/DEG).toFixed(3)}°, θe,k=${(th_ek/DEG).toFixed(3)}°, ρ=${(state.rho/DEG).toFixed(3)}°`;
    }

    function renderMainPlot(thetaIDeg, no, ne, sizes){
      const {ctx} = mainPlot;
      const {w,h} = sizes;
      clear(ctx,w,h);

      const box = {x:10,y:10,w:w-20,h:h-20};
      drawAxes(ctx, box, 'θi (deg)', 'θt,k (deg)', 'Transmitted wavevector angles');

      // Sweep theta_i
      const xs=[], yo=[], ye=[];
      for(let ti=0; ti<=70.0001; ti+=1){
        const st = computeAll(ti, no, ne);
        xs.push(ti);
        yo.push(st.theta_ok/DEG);
        ye.push(st.theta_ek/DEG);
      }

      const yMin = 0;
      const yMax = Math.max(...yo, ...ye, 1)*1.05;

      const plotBox = {x:10,y:10,w:w-20,h:h-20};
      plotLine(ctx, plotBox, xs, yo, 0, 70, yMin, yMax, {stroke:'rgba(167,255,181,.95)', width:2.5});
      plotLine(ctx, plotBox, xs, ye, 0, 70, yMin, yMax, {stroke:'rgba(142,230,255,.95)', width:2.5});

      // Current point
      const cur = computeAll(thetaIDeg, no, ne);
      const padL=44, padR=14, padT=26, padB=30;
      const X0=plotBox.x+padL, Y0=plotBox.y+padT, W=plotBox.w-padL-padR, H=plotBox.h-padT-padB;
      const mx = (xv)=> X0 + ((xv-0)/(70-0))*W;
      const my = (yv)=> Y0 + ((yMax-yv)/(yMax-yMin))*H;

      ctx.save();
      ctx.fillStyle='rgba(255,255,255,.9)';
      ctx.strokeStyle='rgba(255,255,255,.55)';
      ctx.lineWidth=1;
      const px = mx(thetaIDeg);
      // ordinary marker
      ctx.beginPath(); ctx.arc(px, my(cur.theta_ok/DEG), 4.2, 0, Math.PI*2); ctx.fill();
      // extraordinary marker
      ctx.beginPath(); ctx.arc(px, my(cur.theta_ek/DEG), 4.2, 0, Math.PI*2); ctx.fill();
      ctx.restore();

      legend(ctx, w-260, 40, [
        {stroke:'rgba(167,255,181,.95)', label:'Ordinary θo,k'},
        {stroke:'rgba(142,230,255,.95)', label:'Extraordinary θe,k'}
      ]);

      document.getElementById('mainReadout').textContent =
        `At θi=${thetaIDeg.toFixed(1)}° → θo,k=${(cur.theta_ok/DEG).toFixed(3)}°, θe,k=${(cur.theta_ek/DEG).toFixed(3)}°`;
    }

    function renderSecPlot(thetaIDeg, no, ne, sizes){
      const {ctx} = secPlot;
      const {w,h} = sizes;
      clear(ctx,w,h);

      const box = {x:10,y:10,w:w-20,h:h-20};
      drawAxes(ctx, box, 'θi (deg)', 'ρ (deg)', 'Extraordinary walk-off (ray vs wavevector)');

      const xs=[], rhos=[];
      for(let ti=0; ti<=70.0001; ti+=1){
        const st = computeAll(ti, no, ne);
        rhos.push(st.rho/DEG);
        xs.push(ti);
      }

      // choose symmetric y-range
      const maxAbs = Math.max(0.05, ...rhos.map(v=>Math.abs(v))) * 1.15;
      const yMin = -maxAbs;
      const yMax =  maxAbs;

      const plotBox = {x:10,y:10,w:w-20,h:h-20};
      plotLine(ctx, plotBox, xs, rhos, 0, 70, yMin, yMax, {stroke:'rgba(255,157,176,.92)', width:2.5});

      // zero line emphasize
      ctx.save();
      const padL=44, padR=14, padT=26, padB=30;
      const X0=plotBox.x+padL, Y0=plotBox.y+padT, W=plotBox.w-padL-padR, H=plotBox.h-padT-padB;
      const my = (yv)=> Y0 + ((yMax-yv)/(yMax-yMin))*H;
      ctx.strokeStyle='rgba(255,255,255,.35)';
      ctx.lineWidth=1.2;
      ctx.beginPath(); ctx.moveTo(X0, my(0)); ctx.lineTo(X0+W, my(0)); ctx.stroke();
      ctx.restore();

      // current marker
      const cur = computeAll(thetaIDeg, no, ne);
      const mx = (xv)=> X0 + ((xv-0)/(70-0))*W;
      ctx.save();
      ctx.fillStyle='rgba(255,255,255,.9)';
      ctx.beginPath(); ctx.arc(mx(thetaIDeg), my(cur.rho/DEG), 4.5, 0, Math.PI*2); ctx.fill();
      ctx.restore();

      legend(ctx, w-260, 40, [
        {stroke:'rgba(255,157,176,.92)', label:'ρ (deg)'}
      ]);

      document.getElementById('secReadout').textContent =
        `At θi=${thetaIDeg.toFixed(1)}° → ρ=${(cur.rho/DEG).toFixed(3)}° (sign indicates tilt vs optic axis)`;
    }

    // ---------- Controller ----------
    const thetaISlider = document.getElementById('thetaISlider');
    const noSlider = document.getElementById('noSlider');
    const neSlider = document.getElementById('neSlider');
    const thetaIVal = document.getElementById('thetaIVal');
    const noVal = document.getElementById('noVal');
    const neVal = document.getElementById('neVal');

    function update(){
      const thetaIDeg = parseFloat(thetaISlider.value);
      const no = parseFloat(noSlider.value);
      const ne = parseFloat(neSlider.value);

      thetaIVal.textContent = thetaIDeg.toFixed(1) + '°';
      noVal.textContent = no.toFixed(3);
      neVal.textContent = ne.toFixed(3);

      const st = computeAll(thetaIDeg, no, ne);

      // resize canvases each update for responsive layout
      const s1 = diagram.resize();
      const s2 = mainPlot.resize();
      const s3 = secPlot.resize();

      renderDiagram(st, s1);
      renderMainPlot(thetaIDeg, no, ne, s2);
      renderSecPlot(thetaIDeg, no, ne, s3);
    }

    [thetaISlider, noSlider, neSlider].forEach(el=>el.addEventListener('input', update));
    window.addEventListener('resize', ()=>update());

    // Initialize
    update();
  </script>
</body>
</html>
