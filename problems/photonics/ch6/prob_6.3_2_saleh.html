<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Maximum Extraordinary (Walk-off) Effect in Quartz — Where k–S Angle is Largest</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101833;
      --card:#0f1730;
      --text:#eaf0ff;
      --muted:#aab6de;
      --faint:#7f8ab3;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.16);
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(125,211,252,.18), transparent 55%),
        radial-gradient(900px 650px at 85% 25%, rgba(167,139,250,.15), transparent 55%),
        radial-gradient(1200px 800px at 50% 120%, rgba(52,211,153,.08), transparent 60%),
        var(--bg);
      line-height:1.6;
    }

    header{
      padding: 34px 18px 20px;
      max-width: 1200px;
      margin: 0 auto;
    }
    header .hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap: 18px;
      align-items: stretch;
    }
    .titleCard{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 18px 18px 16px;
      position:relative;
      overflow:hidden;
    }
    .titleCard::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 250px at 10% 0%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(600px 250px at 90% 20%, rgba(167,139,250,.16), transparent 60%);
      pointer-events:none;
      filter: blur(0.2px);
    }
    .titleCard > *{ position:relative; }
    h1{
      margin: 0 0 6px;
      font-size: clamp(22px, 3.0vw, 34px);
      letter-spacing: .2px;
      line-height: 1.18;
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      font-size: 14.5px;
    }
    .metaRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      margin-top: 12px;
      color: var(--faint);
      font-size: 12.5px;
    }
    .pill{
      border:1px solid var(--line);
      background: rgba(255,255,255,.03);
      padding: 6px 10px;
      border-radius: 999px;
      display:inline-flex;
      align-items:center;
      gap:8px;
      white-space:nowrap;
    }
    .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(125,211,252,.12);
    }

    .tocCard{
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 14px 14px 10px;
      position: sticky;
      top: 10px;
      align-self: start;
      max-height: calc(100vh - 20px);
      overflow:auto;
    }
    .tocCard h2{
      margin: 4px 0 10px;
      font-size: 14px;
      color: var(--muted);
      letter-spacing: .4px;
      text-transform: uppercase;
    }
    .toc{
      list-style:none;
      padding:0; margin:0;
      display:grid;
      gap: 8px;
    }
    .toc a{
      display:block;
      text-decoration:none;
      color: var(--text);
      font-size: 13.5px;
      padding: 8px 10px;
      border-radius: 12px;
      border: 1px solid transparent;
      background: rgba(0,0,0,.10);
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
    }
    .toc a:hover{
      transform: translateY(-1px);
      background: rgba(125,211,252,.09);
      border-color: rgba(125,211,252,.22);
    }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 18px 56px;
    }

    .grid{
      display:grid;
      grid-template-columns: 1fr;
      gap: 14px;
    }

    section{
      background: rgba(255,255,255,.04);
      border: 1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding: 18px;
      overflow:hidden;
    }
    section h2{
      margin: 0 0 10px;
      font-size: 18px;
      letter-spacing: .2px;
    }
    section h3{
      margin: 16px 0 8px;
      font-size: 15.5px;
      color: var(--muted);
    }
    p{ margin: 10px 0; color: var(--text); }
    ul{ margin: 8px 0 0 20px; color: var(--text); }
    li{ margin: 6px 0; }

    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
      align-items:start;
    }

    .callouts{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap: 12px;
      margin-top: 10px;
    }
    .box{
      grid-column: span 12;
      border-radius: var(--radius);
      border: 1px solid var(--line2);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.025));
      padding: 12px 12px 10px;
      position:relative;
      overflow:hidden;
    }
    .box .label{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      letter-spacing: .35px;
      text-transform: uppercase;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .badge{
      width: 10px; height: 10px; border-radius: 3px;
      background: var(--accent2);
      box-shadow: 0 0 0 3px rgba(167,139,250,.12);
    }
    .box.assumptions .badge{ background: var(--ok); box-shadow: 0 0 0 3px rgba(52,211,153,.12); }
    .box.mistakes .badge{ background: var(--warn); box-shadow: 0 0 0 3px rgba(251,191,36,.14); }
    .box.final .badge{ background: var(--accent); box-shadow: 0 0 0 3px rgba(125,211,252,.14); }

    .eqRow{
      display:flex;
      align-items:flex-start;
      justify-content:space-between;
      gap: 10px;
      margin-top: 8px;
    }
    .equation{
      font-family: var(--mono);
      font-size: 13.5px;
      color: #dbe7ff;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px 10px;
      overflow:auto;
      flex: 1;
      white-space: pre;
    }
    .copyBtn{
      flex: 0 0 auto;
      appearance:none;
      border: 1px solid rgba(255,255,255,.16);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 12px;
      padding: 10px 10px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size: 13px;
      user-select:none;
    }
    .copyBtn:hover{
      transform: translateY(-1px);
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.28);
    }
    .copyBtn:active{ transform: translateY(0px) scale(.99); }
    .tiny{
      font-size: 12.5px;
      color: var(--muted);
    }

    .vizWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    .vizTop{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap: 12px;
      align-items: start;
    }
    figure{
      margin:0;
      border: 1px solid var(--line2);
      border-radius: var(--radius2);
      background: rgba(0,0,0,.18);
      padding: 10px;
      overflow:hidden;
    }
    figcaption{
      margin-top: 8px;
      color: var(--muted);
      font-size: 12.5px;
    }
    canvas{
      width:100%;
      height: 320px;
      display:block;
      border-radius: 14px;
      background: rgba(0,0,0,.22);
      border: 1px solid rgba(255,255,255,.10);
    }

    .controls{
      border: 1px solid var(--line2);
      border-radius: var(--radius2);
      background: rgba(0,0,0,.16);
      padding: 12px;
    }
    .controls h3{
      margin: 0 0 10px;
      font-size: 14.5px;
      color: var(--muted);
    }
    .ctrl{
      display:grid;
      gap: 6px;
      margin: 10px 0;
    }
    .ctrl label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap: 10px;
      color: var(--text);
      font-size: 13.5px;
    }
    .ctrl label span{
      color: var(--muted);
      font-size: 12.5px;
      white-space:nowrap;
    }
    input[type="range"]{
      width:100%;
    }
    select{
      width:100%;
      border-radius: 12px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--text);
      outline:none;
    }
    .readout{
      margin-top: 10px;
      padding: 10px;
      border-radius: 14px;
      border: 1px dashed rgba(255,255,255,.18);
      color: var(--text);
      background: rgba(255,255,255,.03);
      font-size: 13px;
    }
    .readout b{ color: #f2f6ff; }

    footer{
      max-width: 1200px;
      margin: 0 auto;
      padding: 20px 18px 36px;
      color: var(--muted);
      font-size: 12.5px;
    }
    .sep{
      height:1px;
      background: var(--line);
      margin: 12px 0;
    }

    /* responsive */
    @media (max-width: 980px){
      header .hero{ grid-template-columns: 1fr; }
      .tocCard{ position: relative; top: 0; max-height: none; }
      .twoCol{ grid-template-columns: 1fr; }
      .vizTop{ grid-template-columns: 1fr; }
      canvas{ height: 300px; }
    }

    /* print */
    @media print{
      body{ background: #fff; color:#000; }
      header, main, section, figure, .titleCard, .tocCard{ box-shadow:none !important; }
      .tocCard{ display:none; }
      section{ break-inside: avoid; background:#fff; border:1px solid #ddd; }
      .equation{ background:#f7f7f7; color:#000; border:1px solid #ddd; }
      canvas{ border:1px solid #ccc; background:#fff; }
      .copyBtn, .controls{ display:none; }
    }
  </style>
</head>
<body>
  <header>
    <div class="hero">
      <div class="titleCard">
        <h1>6.3-2 — Maximum Extraordinary Effect (Walk-off) in Quartz</h1>
        <p class="subtitle">
          Find the propagation direction in uniaxial quartz (n<sub>e</sub>=1.553, n<sub>o</sub>=1.544)
          that maximizes the angle between the extraordinary wavevector <b>k</b> (wave-normal) and the Poynting vector <b>S</b> (ray direction).
        </p>
        <div class="metaRow">
          <span class="pill"><span class="dot"></span>Topic: anisotropic waves &amp; energy flow</span>
          <span class="pill"><span class="dot" style="background:var(--accent2); box-shadow:0 0 0 3px rgba(167,139,250,.12)"></span>Key result: max walk-off angle</span>
          <span class="pill"><span class="dot" style="background:var(--ok); box-shadow:0 0 0 3px rgba(52,211,153,.12)"></span>Quartz: positive uniaxial (n<sub>e</sub>&gt;n<sub>o</sub>)</span>
        </div>
      </div>

      <nav class="tocCard" aria-label="Table of contents">
        <h2>Contents</h2>
        <ol class="toc">
          <li><a href="#quick">Quick Summary</a></li>
          <li><a href="#part0">PART 0 — Concept Primer</a></li>
          <li><a href="#part1">PART 1 — Problem Analysis</a></li>
          <li><a href="#part2">PART 2 — Strategy &amp; Tips</a></li>
          <li><a href="#part3">PART 3 — Full Solution</a></li>
          <li><a href="#part4">PART 4 — Deeper Understanding</a></li>
          <li><a href="#part5">PART 5 — Visualization Guide</a></li>
          <li><a href="#viz">Interactive Visualizations</a></li>
        </ol>
      </nav>
    </div>
  </header>

  <main>
    <div class="grid">
      <section id="quick">
        <h2>Quick Summary</h2>
        <ul>
          <li>This problem is about <b>walk-off</b> in uniaxial crystals: for the <b>extraordinary</b> wave, energy flow (<b>S</b>) is generally <b>not parallel</b> to the wavevector (<b>k</b>).</li>
          <li>The key physics idea: the extraordinary wave has a direction-dependent effective index and an anisotropic dispersion surface, so the <b>group velocity</b> (and thus <b>Poynting vector</b>) points in a different direction than the phase normal.</li>
          <li>We use the standard uniaxial walk-off relation
            <b>tan&nbsp;ρ = ((n<sub>o</sub><sup>2</sup> − n<sub>e</sub><sup>2</sup>) sinθ cosθ) / (n<sub>o</sub><sup>2</sup> cos²θ + n<sub>e</sub><sup>2</sup> sin²θ)</b>,
            where θ is the angle between <b>k</b> and the optic axis, and ρ is the angle between <b>S</b> and <b>k</b>.</li>
          <li>Maximizing |ρ| gives a clean symbolic result:
            <b>tanθ<sub>max</sub> = n<sub>o</sub>/n<sub>e</sub></b> (within 0–90°).</li>
          <li>For quartz (n<sub>o</sub>=1.544, n<sub>e</sub>=1.553):
            <b>θ<sub>max</sub> ≈ 44.83°</b> from the optic axis.</li>
          <li>The maximum walk-off magnitude is
            <b>tan|ρ|<sub>max</sub> = (n<sub>e</sub><sup>2</sup> − n<sub>o</sub><sup>2</sup>)/(2 n<sub>o</sub> n<sub>e</sub>)</b>,
            giving <b>|ρ|<sub>max</sub> ≈ 0.333°</b> in quartz (small but measurable).</li>
          <li>Final result type: <b>symbolic direction + numeric evaluation</b> for the given indices.</li>
        </ul>
      </section>

      <section id="part0">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <article>
          <h3>Core definitions (symbols &amp; units)</h3>
          <ul>
            <li><b>Wavevector</b> <b>k</b> (units: rad/m): points along the direction of phase propagation; its direction is the <b>wave-normal</b>.</li>
            <li><b>Poynting vector</b> <b>S</b> (units: W/m²): time-averaged energy flux density. Its direction is the <b>ray direction</b> (direction of energy transport).</li>
            <li><b>Optic axis</b>: special crystal axis for a uniaxial crystal. Along it, the ordinary and extraordinary indices coincide.</li>
            <li><b>n<sub>o</sub></b>, <b>n<sub>e</sub></b> (dimensionless): ordinary and extraordinary refractive indices (at the wavelength of interest).</li>
            <li><b>θ</b> (radians or degrees): angle between <b>k</b> and the optic axis.</li>
            <li><b>ρ</b> (radians or degrees): <b>walk-off angle</b> between <b>S</b> and <b>k</b> for the extraordinary wave.</li>
          </ul>

          <h3>Physical meaning (what these quantities “do”)</h3>
          <p>
            In isotropic media, the dispersion relation is spherical in k-space, so the energy (group velocity) points in the same direction as the wavevector:
            <b>S ∥ k</b>. In an anisotropic crystal, the extraordinary wave sees a direction-dependent phase velocity, producing a distorted (ellipsoidal) dispersion surface.
            The energy flow direction corresponds to the normal of the constant-frequency surface (group velocity), so <b>S generally tilts relative to k</b>.
          </p>

          <h3>Key principles and validity conditions</h3>
          <ul>
            <li><b>Linear, homogeneous, lossless medium</b>: permittivity tensor is real; no absorption → average <b>S</b> is along group velocity.</li>
            <li><b>Uniaxial crystal model</b>: two principal indices n<sub>o</sub> and n<sub>e</sub>; optic axis defines symmetry.</li>
            <li><b>Extraordinary wave</b>: field polarization and phase propagation are coupled to the optic axis; thus the direction-dependent behavior arises.</li>
            <li><b>Geometrical optics regime</b>: wavelength small compared to beam size so “ray direction” is meaningful.</li>
          </ul>

          <h3>Common models/approximations (and why they help)</h3>
          <ul>
            <li><b>Index ellipsoid / wave-normal surface</b>: provides a compact geometric way to relate k-direction to phase index and to ray direction.</li>
            <li><b>Small-angle walk-off approximation</b>: often ρ is small (as in quartz here), so tanρ ≈ ρ (radians). We will keep exact tan/atan for correctness, then note smallness.</li>
          </ul>

          <h3>Mini intuition examples</h3>
          <ul>
            <li><b>Along the optic axis (θ = 0)</b>: symmetry is highest; extraordinary and ordinary behave the same → <b>ρ = 0</b>.</li>
            <li><b>Perpendicular to optic axis (θ = 90°)</b>: the extraordinary wave reduces to an effective ordinary-like condition for direction; the walk-off again goes to <b>ρ = 0</b> because sinθ cosθ = 0.</li>
          </ul>

          <div class="callouts">
            <div class="box mistakes">
              <div class="label"><span class="badge"></span>What to watch for (pitfalls)</div>
              <ul>
                <li><b>Mixing up θ</b>: here θ is between <b>k</b> and the optic axis, not between <b>S</b> and the optic axis.</li>
                <li>Thinking <b>S ∥ k always</b>: only true in isotropic media (or special directions in anisotropic media).</li>
                <li>Using Δn = n<sub>e</sub>−n<sub>o</sub> directly in formulas that actually need <b>n² differences</b> (n<sub>e</sub><sup>2</sup>−n<sub>o</sub><sup>2</sup>).</li>
                <li>Sign confusion: for <b>positive uniaxial</b> (n<sub>e</sub>&gt;n<sub>o</sub>), the ray tends to tilt <b>toward the optic axis</b> (ρ negative with our sign convention).</li>
              </ul>
            </div>
          </div>
        </article>
      </section>

      <section id="part1">
        <h2>PART 1 — Problem Analysis (No solving yet)</h2>

        <article>
          <h3>Problem restatement (in plain words)</h3>
          <p>
            Quartz is a uniaxial crystal with ordinary index n<sub>o</sub>=1.544 and extraordinary index n<sub>e</sub>=1.553.
            For an extraordinary wave, the Poynting vector <b>S</b> (energy/ray direction) is generally not parallel to the wavevector <b>k</b>.
            We must find the propagation direction (i.e., the angle θ between <b>k</b> and the optic axis) for which the angle between <b>k</b> and <b>S</b> is <b>maximum</b>.
          </p>

          <h3>Given</h3>
          <ul>
            <li>n<sub>o</sub> = 1.544 (ordinary refractive index)</li>
            <li>n<sub>e</sub> = 1.553 (extraordinary refractive index)</li>
            <li>Uniaxial crystal (quartz); n<sub>e</sub> &gt; n<sub>o</sub> → <b>positive uniaxial</b></li>
          </ul>

          <h3>Unknowns</h3>
          <ul>
            <li>θ<sub>max</sub>: angle between <b>k</b> and the optic axis that maximizes the walk-off angle ρ</li>
            <li>Optionally, the maximum walk-off magnitude |ρ|<sub>max</sub> for quartz</li>
          </ul>

          <h3>What must be found</h3>
          <ul>
            <li>Direction of propagation in terms of θ<sub>max</sub> (a single angle, assuming rotational symmetry around the optic axis).</li>
          </ul>

          <h3>Relevant physical principles (and why)</h3>
          <ul>
            <li><b>Anisotropic dispersion</b>: extraordinary waves have direction-dependent phase index, so group velocity (hence <b>S</b>) is not collinear with <b>k</b>.</li>
            <li><b>Walk-off formula for uniaxial crystals</b>: provides ρ(θ) directly from indices n<sub>o</sub>, n<sub>e</sub>.</li>
          </ul>
          <p class="tiny">
            We do <i>not</i> need boundary refraction (Snell’s law) or Fresnel reflection: the question is internal to the crystal and asks for the direction that maximizes the k–S separation.
          </p>

          <div class="callouts">
            <div class="box assumptions">
              <div class="label"><span class="badge"></span>Assumptions</div>
              <ul>
                <li>Quartz is treated as a <b>lossless, homogeneous, linear</b> uniaxial dielectric at the given indices.</li>
                <li>We analyze the <b>extraordinary wave</b> (the only one that exhibits walk-off in this way).</li>
                <li>Geometrical optics / plane-wave picture is valid: <b>k</b> and <b>S</b> are well-defined directions.</li>
                <li>We measure θ in the range 0° to 90° due to symmetry (other directions follow by rotation about the optic axis).</li>
              </ul>
            </div>
          </div>

          <h3>Possible approaches (compare)</h3>
          <ul>
            <li><b>(A) Use the standard walk-off formula</b> ρ(θ) for a uniaxial crystal, then maximize it.
              <br><span class="tiny">Pros: shortest, analytic, directly uses given n<sub>o</sub>, n<sub>e</sub>. Cons: requires knowing/accepting the formula.</span>
            </li>
            <li><b>(B) Derive from wave-normal and ray surfaces</b>: use the index ellipsoid, obtain ray direction from normal to the extraordinary wave surface, then compute ρ and maximize.
              <br><span class="tiny">Pros: more “from first principles.” Cons: longer geometry; easy to get lost in algebra.</span>
            </li>
            <li><b>(C) Group-velocity method</b>: treat ω(k) surface and compute v<sub>g</sub>=∇<sub>k</sub>ω direction.
              <br><span class="tiny">Pros: physically deep. Cons: requires more formal dispersion framework.</span>
            </li>
          </ul>

          <p>
            <b>We choose (A)</b> because it yields a clean closed-form maximization and is the most instructional for quick problem solving—then we connect it back to the geometric meaning.
          </p>
        </article>
      </section>

      <section id="part2">
        <h2>PART 2 — Strategy &amp; Tips (Roadmap only)</h2>

        <article>
          <ol>
            <li><b>Goal:</b> express the walk-off angle ρ as a function of θ.
              <br><span class="tiny">Tool: uniaxial extraordinary walk-off relation tanρ(θ).</span>
            </li>
            <li><b>Goal:</b> rewrite tanρ(θ) in a simpler form using t = tanθ.
              <br><span class="tiny">Meaning: turns trig into a rational function that is easy to maximize.</span>
            </li>
            <li><b>Goal:</b> maximize |ρ| by maximizing |tanρ| (monotonic for small angles and still valid in 0–90°).
              <br><span class="tiny">Tool: calculus on a rational function g(t).</span>
            </li>
            <li><b>Goal:</b> solve for t at the maximum and convert back to θ.
              <br><span class="tiny">Meaning: direction of propagation (k relative to optic axis).</span>
            </li>
            <li><b>Goal:</b> evaluate numerically for quartz.
              <br><span class="tiny">Meaning: get a concrete angle and the maximum walk-off.</span>
            </li>
            <li><b>Goal:</b> sanity checks.
              <br><span class="tiny">Check: ρ(0)=ρ(90°)=0, max near ~45°; magnitude small for weak birefringence.</span>
            </li>
          </ol>

          <div class="callouts">
            <div class="box mistakes">
              <div class="label"><span class="badge"></span>Common mistakes &amp; quick tips</div>
              <ul>
                <li><b>Maximizing ρ instead of |ρ|</b>: depending on sign convention, ρ may be negative for positive uniaxial crystals. Use magnitude.</li>
                <li><b>Forgetting n²</b>: the clean maximum comes from n<sub>o</sub><sup>2</sup> and n<sub>e</sub><sup>2</sup>, not n directly.</li>
                <li><b>Overcomplicating</b>: once you set t = tanθ, the maximization is one derivative and one line.</li>
              </ul>
            </div>
          </div>
        </article>
      </section>

      <section id="part3">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <article>
          <h3>Physical intuition first</h3>
          <p>
            The extraordinary wave “feels” the optic axis. If the wave propagates exactly along or exactly perpendicular to the optic axis, symmetry forces the energy flow to align with the phase normal, so ρ = 0.
            Therefore, the maximum walk-off must occur for an <b>intermediate</b> θ, plausibly near 45°.
            The small difference between n<sub>e</sub> and n<sub>o</sub> in quartz suggests the maximum ρ will be <b>small</b> (fractions of a degree).
          </p>

          <h3>Step 1 — Write the walk-off relation</h3>
          <p>
            For a uniaxial crystal, the extraordinary wave has a k–S misalignment given by the standard walk-off formula
            (θ = angle between <b>k</b> and optic axis; ρ = angle between <b>S</b> and <b>k</b>):
          </p>

          <div class="box">
            <div class="label"><span class="badge"></span>Key equation</div>
            <div class="eqRow">
              <div class="equation" id="eq_walkoff">tan(ρ) = ((n_o^2 - n_e^2) sinθ cosθ) / (n_o^2 cos^2θ + n_e^2 sin^2θ)</div>
              <button class="copyBtn" data-copy="#eq_walkoff">Copy</button>
            </div>
            <p class="tiny">
              Note: if n<sub>e</sub>&gt;n<sub>o</sub> (positive uniaxial), then (n<sub>o</sub><sup>2</sup>−n<sub>e</sub><sup>2</sup>)&lt;0, so ρ is negative in this convention (ray tilts toward the optic axis). The <b>maximum effect</b> means maximum <b>|ρ|</b>.
            </p>
          </div>

          <h3>Step 2 — Simplify using t = tanθ</h3>
          <p>
            Let <b>t = tanθ</b>. Then sinθ cosθ = t/(1+t²), cos²θ = 1/(1+t²), sin²θ = t²/(1+t²).
            Substitute into tanρ:
          </p>

          <div class="eqRow">
            <div class="equation" id="eq_simplify">tan(ρ) = (n_o^2 - n_e^2) * [t/(1+t^2)]  /  [ (n_o^2/(1+t^2)) + (n_e^2 t^2/(1+t^2)) ]
       = (n_o^2 - n_e^2) * t / (n_o^2 + n_e^2 t^2)</div>
            <button class="copyBtn" data-copy="#eq_simplify">Copy</button>
          </div>

          <p>
            This is the key simplification: a rational function of t.
          </p>

          <h3>Step 3 — Maximize the magnitude</h3>
          <p>
            The factor (n<sub>o</sub><sup>2</sup>−n<sub>e</sub><sup>2</sup>) is constant. So maximizing |tanρ| over θ ∈ [0,90°] is equivalent to maximizing:
          </p>

          <div class="eqRow">
            <div class="equation" id="eq_g">g(t) = t / (n_o^2 + n_e^2 t^2),   with  t ≥ 0</div>
            <button class="copyBtn" data-copy="#eq_g">Copy</button>
          </div>

          <p>Differentiate g(t):</p>
          <div class="equation" id="eq_deriv">g'(t) = (n_o^2 + n_e^2 t^2 - t(2 n_e^2 t)) / (n_o^2 + n_e^2 t^2)^2
     = (n_o^2 - n_e^2 t^2) / (n_o^2 + n_e^2 t^2)^2</div>

          <p>
            Set g′(t)=0 for an extremum:
          </p>
          <div class="equation" id="eq_tmax">n_o^2 - n_e^2 t^2 = 0  →  t^2 = (n_o^2)/(n_e^2)  →  t = n_o/n_e</div>

          <p>
            Since g(0)=0 and g(t→∞)→0, this interior critical point is a <b>maximum</b>.
            Therefore:
          </p>

          <div class="box final">
            <div class="label"><span class="badge"></span>Direction for maximum walk-off (symbolic)</div>
            <div class="eqRow">
              <div class="equation" id="eq_thetaMax">tan(θ_max) = n_o / n_e
θ_max = arctan(n_o / n_e)</div>
              <button class="copyBtn" data-copy="#eq_thetaMax">Copy</button>
            </div>
          </div>

          <h3>Step 4 — Maximum walk-off magnitude (optional but informative)</h3>
          <p>
            Evaluate tanρ at t = n<sub>o</sub>/n<sub>e</sub>. Using tanρ = (n<sub>o</sub><sup>2</sup>−n<sub>e</sub><sup>2</sup>) t /(n<sub>o</sub><sup>2</sup>+n<sub>e</sub><sup>2</sup>t²):
          </p>

          <div class="eqRow">
            <div class="equation" id="eq_rhoMax">tan(ρ_max) = (n_o^2 - n_e^2) * (n_o/n_e) / (n_o^2 + n_e^2*(n_o^2/n_e^2))
           = (n_o^2 - n_e^2) / (2 n_o n_e)

So  tan(|ρ|_max) = (n_e^2 - n_o^2) / (2 n_o n_e)</div>
            <button class="copyBtn" data-copy="#eq_rhoMax">Copy</button>
            </div>

          <h3>Step 5 — Plug in quartz numbers</h3>
          <p>
            For quartz: n<sub>o</sub>=1.544, n<sub>e</sub>=1.553.
          </p>

          <div class="box final">
            <div class="label"><span class="badge"></span>Final numeric result (quartz)</div>
            <div class="eqRow">
              <div class="equation" id="eq_final">θ_max = arctan(1.544 / 1.553) ≈ 44.83°  (angle between k and optic axis)

tan(|ρ|_max) = (1.553^2 - 1.544^2) / (2·1.544·1.553) ≈ 0.005812
|ρ|_max = arctan(0.005812) ≈ 0.333°</div>
              <button class="copyBtn" data-copy="#eq_final">Copy</button>
            </div>
            <p class="tiny">
              Sign note: for positive uniaxial (n<sub>e</sub>&gt;n<sub>o</sub>), ρ is negative in the convention used by the formula, meaning <b>S tilts slightly toward the optic axis</b>.
              The <b>maximum angle between k and S</b> is the magnitude |ρ|.
            </p>
          </div>

          <h3>Sanity checks</h3>
          <ul>
            <li><b>Limiting directions:</b> at θ=0° or 90°, sinθ cosθ = 0 → tanρ = 0 → ρ=0 ✓</li>
            <li><b>Where is the max?</b> θ<sub>max</sub> ≈ 44.8° is near 45° ✓</li>
            <li><b>Units:</b> all indices are dimensionless; tanρ is dimensionless; ρ is an angle ✓</li>
            <li><b>Magnitude:</b> birefringence is small (~0.009), so |ρ| is small (~0.3°) ✓</li>
          </ul>

          <p>
            Connect to the diagram and plots below: at θ≈44.8°, the diagram shows k and S separated the most; the first plot peaks there; the second plot shows how the ray angle ψ (angle of S from optic axis) differs from θ.
          </p>
        </article>
      </section>

      <section id="part4">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <article>
          <h3>Re-interpreting the final formulas</h3>
          <ul>
            <li><b>θ<sub>max</sub> = arctan(n<sub>o</sub>/n<sub>e</sub>)</b> tells you the maximum occurs when the wave-normal is tilted such that tanθ matches the ratio of indices.</li>
            <li><b>tan|ρ|<sub>max</sub> = (n<sub>e</sub><sup>2</sup>−n<sub>o</sub><sup>2</sup>)/(2n<sub>o</sub>n<sub>e</sub>)</b> shows what controls the effect:
              <ul>
                <li>It grows with the <b>squared-index birefringence</b> (n<sub>e</sub><sup>2</sup>−n<sub>o</sub><sup>2</sup>).</li>
                <li>It is reduced by larger average index (through the product 2n<sub>o</sub>n<sub>e</sub>).</li>
              </ul>
            </li>
          </ul>

          <h3>How parameter changes affect the outcome (connect to plots)</h3>
          <ul>
            <li>If you increase birefringence (make n<sub>e</sub> farther from n<sub>o</sub>), the peak |ρ| increases, and the peak location shifts slightly away from 45° according to arctan(n<sub>o</sub>/n<sub>e</sub>).</li>
            <li>Switching between <b>positive</b> and <b>negative</b> uniaxial (toggle in the controls) flips the sign of ρ, meaning the ray tilts to the opposite side of k, while the magnitude curve stays the same.</li>
          </ul>

          <h3>Alternative derivation idea (brief)</h3>
          <p>
            A geometric route uses the extraordinary wave-normal surface (an ellipsoid in k-space). The ray (energy) direction is normal to the constant-frequency surface, so you can obtain the ray angle ψ from the ellipsoid normal and then ρ = ψ − θ.
            This yields an equivalent relation:
          </p>
          <div class="eqRow">
            <div class="equation" id="eq_alt">tan(ψ) = (n_o^2 / n_e^2) tan(θ)
and  ρ = ψ - θ</div>
            <button class="copyBtn" data-copy="#eq_alt">Copy</button>
          </div>

          <h3>Concept checks (quick self-test)</h3>
          <ul>
            <li><b>Q:</b> Why is ρ zero at θ=0°? <b>A:</b> symmetry about the optic axis forces S ∥ k along that axis.</li>
            <li><b>Q:</b> Does the ordinary wave have walk-off? <b>A:</b> In a uniaxial crystal, the ordinary wave has isotropic behavior in the plane perpendicular to k; its ray and wave-normal directions coincide (no walk-off in this sense).</li>
            <li><b>Q:</b> If birefringence goes to zero (n<sub>e</sub>→n<sub>o</sub>), what happens? <b>A:</b> tanρ → 0 for all θ, so S ∥ k everywhere (isotropic limit).</li>
            <li><b>Q:</b> For positive uniaxial, does S bend toward or away from the optic axis? <b>A:</b> Toward the optic axis (negative ρ in the convention used), as the plots show.</li>
          </ul>
        </article>
      </section>

      <section id="part5">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <article>
          <ul>
            <li><b>Diagram canvas:</b> shows the optic axis, the wavevector <b>k</b> at angle θ from the optic axis, and the Poynting vector <b>S</b> at angle ψ. The walk-off angle is ρ = ψ − θ, drawn as the small arc between k and S.</li>
            <li><b>Main plot:</b> graphs the walk-off <b>ρ(θ)</b> (degrees) versus θ (degrees). The peak (in magnitude) marks the maximum extraordinary effect.</li>
            <li><b>Secondary plot:</b> graphs <b>ψ(θ)</b> versus θ, showing how the ray direction differs from the wave-normal direction across angles.</li>
            <li><b>Interactive controls:</b>
              <ul>
                <li><b>Birefringence slider</b> changes Δn = |n<sub>e</sub>−n<sub>o</sub>| (exploration). Quartz defaults to Δn = 0.009.</li>
                <li><b>Uniaxial type selector</b> chooses positive (n<sub>e</sub>&gt;n<sub>o</sub>) or negative (n<sub>e</sub>&lt;n<sub>o</sub>), flipping the sign of ρ while keeping |ρ| the same.</li>
              </ul>
            </li>
            <li>As you change parameters, <b>all canvases update live</b>: the diagram angle between k and S changes, the ρ(θ) curve changes height, and the ψ(θ) curve shifts accordingly.</li>
          </ul>
        </article>
      </section>

      <section id="viz">
        <h2>Interactive Visualizations</h2>

        <div class="vizWrap">
          <div class="vizTop">
            <figure>
              <canvas id="cDiagram" aria-label="Geometry diagram"></canvas>
              <figcaption>
                Labeled geometry: optic axis, wavevector <b>k</b> (phase normal), Poynting vector <b>S</b> (ray), and walk-off angle ρ.
              </figcaption>
            </figure>

            <div class="controls" role="group" aria-label="Interactive controls">
              <h3>Controls (live updates)</h3>

              <div class="ctrl">
                <label for="selType">
                  Uniaxial type
                  <span>sign of ρ</span>
                </label>
                <select id="selType">
                  <option value="positive" selected>Positive (n_e &gt; n_o)</option>
                  <option value="negative">Negative (n_e &lt; n_o)</option>
                </select>
              </div>

              <div class="ctrl">
                <label for="rngDn">
                  Birefringence Δn = |n_e − n_o|
                  <span id="dnVal">0.009</span>
                </label>
                <input id="rngDn" type="range" min="0" max="0.08" step="0.001" value="0.009"/>
              </div>

              <div class="ctrl">
                <label for="rngTheta">
                  Selected θ (diagram)
                  <span id="thVal">44.83°</span>
                </label>
                <input id="rngTheta" type="range" min="0" max="89.9" step="0.1" value="44.83"/>
              </div>

              <div class="readout" id="readout">
                <div><b>Quartz defaults:</b> n<sub>o</sub>=1.544, n<sub>e</sub>=1.553</div>
                <div>Computed θ<sub>max</sub>: <b id="thMaxOut">44.83°</b></div>
                <div>Max |ρ|: <b id="rhoMaxOut">0.333°</b></div>
                <div>At selected θ: ρ = <b id="rhoAtOut">0.333°</b>, ψ = <b id="psiAtOut">44.50°</b></div>
              </div>
            </div>
          </div>

          <figure>
            <canvas id="cMain" aria-label="Main plot of walk-off angle"></canvas>
            <figcaption>
              Main quantitative plot: walk-off <b>ρ(θ)</b> in degrees versus θ in degrees, with the maximum marked.
            </figcaption>
          </figure>

          <figure>
            <canvas id="cSecondary" aria-label="Secondary plot of ray angle"></canvas>
            <figcaption>
              Secondary plot: ray angle <b>ψ(θ)</b> (direction of <b>S</b> relative to optic axis) versus θ (direction of <b>k</b>).
            </figcaption>
          </figure>
        </div>
      </section>
    </div>
  </main>

  <footer>
    <div class="sep"></div>
    <div>
      Notes: The slider/select are for learning exploration. The problem’s quartz values are the defaults. Formulas shown are for uniaxial, lossless media in the plane containing the optic axis and the propagation direction.
    </div>
  </footer>

  <script>
    // ---------- Smooth scrolling (TOC) ----------
    document.querySelectorAll('.toc a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const id = a.getAttribute('href');
        const el = document.querySelector(id);
        if(!el) return;
        el.scrollIntoView({behavior:'smooth', block:'start'});
        history.replaceState(null, '', id);
      });
    });

    // ---------- Copy buttons ----------
    function copyText(txt){
      if(navigator.clipboard && navigator.clipboard.writeText){
        return navigator.clipboard.writeText(txt);
      }
      // fallback
      const ta = document.createElement('textarea');
      ta.value = txt;
      ta.setAttribute('readonly','');
      ta.style.position='fixed';
      ta.style.left='-9999px';
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      return Promise.resolve();
    }

    document.querySelectorAll('.copyBtn').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const sel = btn.getAttribute('data-copy');
        const el = document.querySelector(sel);
        if(!el) return;
        const txt = el.textContent.replace(/\u00A0/g,' ').trim();
        try{
          await copyText(txt);
          const old = btn.textContent;
          btn.textContent = 'Copied!';
          setTimeout(()=>btn.textContent=old, 900);
        }catch(e){
          const old = btn.textContent;
          btn.textContent = 'Copy failed';
          setTimeout(()=>btn.textContent=old, 1100);
        }
      });
    });

    // ---------- Math helpers ----------
    const DEG = Math.PI/180;
    function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

    // Uniaxial walk-off:
    // tan(ρ) = ((n_o^2 - n_e^2) sinθ cosθ) / (n_o^2 cos^2θ + n_e^2 sin^2θ)
    // Using t=tanθ: tan(ρ) = (n_o^2 - n_e^2) t / (n_o^2 + n_e^2 t^2)
    function tanRho(theta, no, ne){
      const t = Math.tan(theta);
      const num = (no*no - ne*ne) * t;
      const den = (no*no + ne*ne * t*t);
      return num/den;
    }
    function rho(theta, no, ne){
      return Math.atan(tanRho(theta,no,ne));
    }
    // Ray angle psi relative to optic axis:
    // tan(ψ) = (n_o^2 / n_e^2) tan(θ)
    function psi(theta, no, ne){
      const t = Math.tan(theta);
      return Math.atan( (no*no/(ne*ne)) * t );
    }

    // Maximum condition:
    // t_max = n_o / n_e  => θ_max = arctan(n_o/n_e)
    function thetaMax(no, ne){
      return Math.atan(no/ne);
    }
    // tan(|rho|_max) = |n_e^2 - n_o^2| / (2 n_o n_e)
    function rhoMaxAbs(no, ne){
      const t = Math.abs(ne*ne - no*no) / (2*no*ne);
      return Math.atan(t);
    }

    // ---------- Canvas plotting utilities ----------
    function setupCanvas(canvas){
      const ctx = canvas.getContext('2d');
      function resize(){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        const w = Math.max(2, Math.floor(rect.width * dpr));
        const h = Math.max(2, Math.floor(rect.height * dpr));
        if(canvas.width !== w || canvas.height !== h){
          canvas.width = w; canvas.height = h;
        }
        ctx.setTransform(1,0,0,1,0,0);
        ctx.scale(dpr, dpr);
        return {w: rect.width, h: rect.height, dpr};
      }
      return {ctx, resize};
    }

    function drawGridAxes(ctx, W, H, pad, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
      // background
      ctx.clearRect(0,0,W,H);

      // Title
      ctx.save();
      ctx.fillStyle = 'rgba(234,240,255,0.92)';
      ctx.font = '600 14px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';
      ctx.fillText(title, pad, 10);
      ctx.restore();

      const plot = {
        x0: pad, y0: pad+14,
        x1: W - pad, y1: H - pad
      };

      // gridlines
      const gridX = 8, gridY = 6;
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.10)';
      ctx.lineWidth = 1;
      for(let i=0;i<=gridX;i++){
        const x = plot.x0 + (plot.x1-plot.x0)*i/gridX;
        ctx.beginPath();
        ctx.moveTo(x, plot.y0);
        ctx.lineTo(x, plot.y1);
        ctx.stroke();
      }
      for(let j=0;j<=gridY;j++){
        const y = plot.y0 + (plot.y1-plot.y0)*j/gridY;
        ctx.beginPath();
        ctx.moveTo(plot.x0, y);
        ctx.lineTo(plot.x1, y);
        ctx.stroke();
      }
      ctx.restore();

      // axes box
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.22)';
      ctx.lineWidth = 1.2;
      ctx.strokeRect(plot.x0, plot.y0, plot.x1-plot.x0, plot.y1-plot.y0);
      ctx.restore();

      // ticks + labels
      ctx.save();
      ctx.fillStyle = 'rgba(234,240,255,0.86)';
      ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';

      for(let i=0;i<=gridX;i++){
        const x = plot.x0 + (plot.x1-plot.x0)*i/gridX;
        const val = xMin + (xMax-xMin)*i/gridX;
        ctx.fillText(val.toFixed(0), x, plot.y1 + 6);
      }

      ctx.textAlign = 'right';
      ctx.textBaseline = 'middle';
      for(let j=0;j<=gridY;j++){
        const y = plot.y1 - (plot.y1-plot.y0)*j/gridY;
        const val = yMin + (yMax-yMin)*j/gridY;
        ctx.fillText(val.toFixed(3), plot.x0 - 6, y);
      }
      ctx.restore();

      // axis labels
      ctx.save();
      ctx.fillStyle = 'rgba(170,182,222,0.95)';
      ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = 'center';
      ctx.textBaseline = 'bottom';
      ctx.fillText(xLabel, (plot.x0+plot.x1)/2, H-4);

      ctx.translate(12, (plot.y0+plot.y1)/2);
      ctx.rotate(-Math.PI/2);
      ctx.textAlign = 'center';
      ctx.textBaseline = 'top';
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();

      function xPix(x){ return plot.x0 + (x- xMin) * (plot.x1-plot.x0) / (xMax-xMin); }
      function yPix(y){ return plot.y1 - (y- yMin) * (plot.y1-plot.y0) / (yMax-yMin); }

      return {plot, xPix, yPix};
    }

    function drawLine(ctx, points, stroke){
      ctx.save();
      ctx.strokeStyle = stroke;
      ctx.lineWidth = 2;
      ctx.beginPath();
      points.forEach((p,i)=>{
        if(i===0) ctx.moveTo(p.x, p.y);
        else ctx.lineTo(p.x, p.y);
      });
      ctx.stroke();
      ctx.restore();
    }

    function drawMarker(ctx, x, y, label, color){
      ctx.save();
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(x,y,4.2,0,Math.PI*2);
      ctx.fill();

      ctx.fillStyle = 'rgba(234,240,255,0.92)';
      ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = 'left';
      ctx.textBaseline = 'bottom';
      ctx.fillText(label, x+8, y-6);
      ctx.restore();
    }

    // ---------- Diagram drawing ----------
    function drawDiagram(ctx, W, H, no, ne, thetaDeg){
      ctx.clearRect(0,0,W,H);
      const pad = 18;
      const cx = W*0.52, cy = H*0.78;
      const R = Math.min(W,H)*0.48;

      // compute angles
      const theta = clamp(thetaDeg, 0, 89.9) * DEG;
      const psiA = psi(theta, no, ne);
      const rhoA = psiA - theta;

      // base
      ctx.save();
      ctx.strokeStyle = 'rgba(255,255,255,0.18)';
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.arc(cx, cy, R*0.80, Math.PI, 2*Math.PI);
      ctx.stroke();
      ctx.restore();

      // axes: optic axis vertical up
      function arrow(x0,y0,x1,y1, color, w=2){
        ctx.save();
        ctx.strokeStyle = color;
        ctx.fillStyle = color;
        ctx.lineWidth = w;
        ctx.beginPath();
        ctx.moveTo(x0,y0);
        ctx.lineTo(x1,y1);
        ctx.stroke();
        const ang = Math.atan2(y1-y0, x1-x0);
        const ah = 10;
        ctx.beginPath();
        ctx.moveTo(x1,y1);
        ctx.lineTo(x1 - ah*Math.cos(ang - 0.45), y1 - ah*Math.sin(ang - 0.45));
        ctx.lineTo(x1 - ah*Math.cos(ang + 0.45), y1 - ah*Math.sin(ang + 0.45));
        ctx.closePath();
        ctx.fill();
        ctx.restore();
      }

      // Title
      ctx.save();
      ctx.fillStyle = 'rgba(234,240,255,0.92)';
      ctx.font = '600 14px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';
      ctx.fillText('Geometry (optic axis, k, S, walk-off ρ)', pad, 10);
      ctx.restore();

      // optic axis
      arrow(cx, cy, cx, cy - R*0.92, 'rgba(125,211,252,0.95)', 2.4);
      ctx.save();
      ctx.fillStyle = 'rgba(125,211,252,0.95)';
      ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = 'left';
      ctx.textBaseline = 'middle';
      ctx.fillText('optic axis', cx+10, cy - R*0.86);
      ctx.restore();

      // k direction at angle theta from optic axis (rotate from vertical toward right)
      const kAng = -Math.PI/2 + theta; // measured from +x axis? Using coordinate with 0 along +x, -pi/2 vertical up.
      const kx = cx + R*0.78*Math.cos(kAng);
      const ky = cy + R*0.78*Math.sin(kAng);
      arrow(cx, cy, kx, ky, 'rgba(167,139,250,0.95)', 2.6);
      ctx.save();
      ctx.fillStyle = 'rgba(167,139,250,0.95)';
      ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = 'left';
      ctx.textBaseline = 'middle';
      ctx.fillText('k (wave-normal)', kx+10, ky);
      ctx.restore();

      // S direction at angle psi from optic axis
      const sAng = -Math.PI/2 + psiA;
      const sx = cx + R*0.74*Math.cos(sAng);
      const sy = cy + R*0.74*Math.sin(sAng);
      arrow(cx, cy, sx, sy, 'rgba(52,211,153,0.95)', 2.6);
      ctx.save();
      ctx.fillStyle = 'rgba(52,211,153,0.95)';
      ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = 'left';
      ctx.textBaseline = 'middle';
      ctx.fillText('S (ray)', sx+10, sy);
      ctx.restore();

      // draw theta arc between optic axis and k
      function arcLabel(r, a0, a1, color, text, tx){
        ctx.save();
        ctx.strokeStyle = color;
        ctx.lineWidth = 1.8;
        ctx.beginPath();
        ctx.arc(cx, cy, r, a0, a1);
        ctx.stroke();
        const am = (a0+a1)/2;
        ctx.fillStyle = 'rgba(234,240,255,0.92)';
        ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
        ctx.textAlign = 'center';
        ctx.textBaseline = 'middle';
        ctx.fillText(text, cx + (r+14)*Math.cos(am), cy + (r+14)*Math.sin(am));
        ctx.restore();
      }
      const aOpt = -Math.PI/2;
      arcLabel(R*0.28, aOpt, kAng, 'rgba(167,139,250,0.7)', 'θ', '');

      // draw rho arc between k and S (small arc)
      const rArc = R*0.38;
      const a0 = kAng;
      const a1 = sAng;
      // choose direction short
      arcLabel(rArc, a0, a1, 'rgba(52,211,153,0.75)', 'ρ', '');

      // legend text
      ctx.save();
      ctx.fillStyle = 'rgba(170,182,222,0.95)';
      ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';
      const rhoDeg = rhoA / DEG;
      const psiDeg = psiA / DEG;
      ctx.fillText(`θ = ${thetaDeg.toFixed(2)}°`, pad, H - 54);
      ctx.fillText(`ψ = ${psiDeg.toFixed(2)}°`, pad, H - 34);
      ctx.fillText(`ρ = ψ − θ = ${rhoDeg.toFixed(3)}°`, pad, H - 14);
      ctx.restore();
    }

    // ---------- Plot drawing ----------
    function computeCurves(no, ne){
      const N = 360;
      const xs = [];
      const rhoDegs = [];
      const psiDegs = [];
      for(let i=0;i<=N;i++){
        const th = (89.9*i/N) * DEG;
        xs.push(th/DEG);
        rhoDegs.push(rho(th,no,ne)/DEG);
        psiDegs.push(psi(th,no,ne)/DEG);
      }
      return {xs, rhoDegs, psiDegs};
    }

    function drawMainPlot(ctx, W, H, no, ne){
      const pad = 46;
      // Determine y-range based on current indices
      const {xs, rhoDegs} = computeCurves(no, ne);
      let yMin = Math.min(...rhoDegs), yMax = Math.max(...rhoDegs);
      // expand a bit
      const span = Math.max(1e-6, yMax-yMin);
      yMin -= 0.15*span; yMax += 0.15*span;

      const axes = drawGridAxes(
        ctx, W, H, pad,
        0, 90, yMin, yMax,
        'θ (degrees, between k and optic axis)',
        'ρ (degrees, between S and k)',
        'Main Plot: Walk-off angle ρ(θ)'
      );

      const pts = xs.map((x,i)=>({x: axes.xPix(x), y: axes.yPix(rhoDegs[i])}));
      drawLine(ctx, pts, 'rgba(125,211,252,0.92)');

      // Find max |rho|
      let imax = 0;
      let best = -1;
      for(let i=0;i<rhoDegs.length;i++){
        const a = Math.abs(rhoDegs[i]);
        if(a>best){ best=a; imax=i; }
      }
      drawMarker(ctx, axes.xPix(xs[imax]), axes.yPix(rhoDegs[imax]), `max |ρ| ≈ ${best.toFixed(3)}°`, 'rgba(251,191,36,0.95)');

      // legend
      ctx.save();
      ctx.fillStyle = 'rgba(234,240,255,0.88)';
      ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';
      ctx.fillText('Curve: ρ(θ)', pad, pad+18);
      ctx.restore();
    }

    function drawSecondaryPlot(ctx, W, H, no, ne){
      const pad = 46;
      const {xs, psiDegs} = computeCurves(no, ne);

      // y range close to x range but slightly smaller
      let yMin = 0;
      let yMax = Math.max(...psiDegs);
      yMax = Math.max(1, yMax);
      const axes = drawGridAxes(
        ctx, W, H, pad,
        0, 90, yMin, 90,
        'θ (degrees, wave-normal angle)',
        'ψ (degrees, ray angle)',
        'Secondary Plot: Ray angle ψ(θ)'
      );

      // ψ curve
      const pts = xs.map((x,i)=>({x: axes.xPix(x), y: axes.yPix(psiDegs[i])}));
      drawLine(ctx, pts, 'rgba(52,211,153,0.92)');

      // y=x reference (no walk-off line)
      const ref = [{x: axes.xPix(0), y: axes.yPix(0)}, {x: axes.xPix(90), y: axes.yPix(90)}];
      ctx.save();
      ctx.setLineDash([6,6]);
      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      ctx.moveTo(ref[0].x, ref[0].y);
      ctx.lineTo(ref[1].x, ref[1].y);
      ctx.stroke();
      ctx.restore();

      // legend
      ctx.save();
      ctx.fillStyle = 'rgba(234,240,255,0.88)';
      ctx.font = '12px ' + getComputedStyle(document.documentElement).getPropertyValue('--sans');
      ctx.textAlign = 'left';
      ctx.textBaseline = 'top';
      ctx.fillText('Green: ψ(θ) (ray direction)', pad, pad+18);
      ctx.fillStyle = 'rgba(170,182,222,0.9)';
      ctx.fillText('Dashed: ψ = θ (no walk-off)', pad, pad+36);
      ctx.restore();
    }

    // ---------- State + UI ----------
    const noQuartz = 1.544; // fixed as "given"
    const cDiagram = setupCanvas(document.getElementById('cDiagram'));
    const cMain = setupCanvas(document.getElementById('cMain'));
    const cSecondary = setupCanvas(document.getElementById('cSecondary'));

    const selType = document.getElementById('selType');
    const rngDn = document.getElementById('rngDn');
    const rngTheta = document.getElementById('rngTheta');
    const dnVal = document.getElementById('dnVal');
    const thVal = document.getElementById('thVal');

    const thMaxOut = document.getElementById('thMaxOut');
    const rhoMaxOut = document.getElementById('rhoMaxOut');
    const rhoAtOut = document.getElementById('rhoAtOut');
    const psiAtOut = document.getElementById('psiAtOut');

    function getIndices(){
      const dn = parseFloat(rngDn.value); // magnitude
      const type = selType.value;
      const ne = (type === 'positive') ? (noQuartz + dn) : (noQuartz - dn);
      return {no: noQuartz, ne: Math.max(0.9, ne), dn, type};
    }

    function updateReadout(no, ne){
      const thMax = thetaMax(no, ne);
      const rhoMax = rhoMaxAbs(no, ne);
      thMaxOut.textContent = (thMax/DEG).toFixed(2) + '°';
      rhoMaxOut.textContent = (rhoMax/DEG).toFixed(3) + '°';

      const thSel = parseFloat(rngTheta.value) * DEG;
      const rhoSel = (psi(thSel,no,ne) - thSel);
      rhoAtOut.textContent = (rhoSel/DEG).toFixed(3) + '°';
      psiAtOut.textContent = (psi(thSel,no,ne)/DEG).toFixed(2) + '°';
    }

    function redrawAll(){
      const {no, ne, dn} = getIndices();

      dnVal.textContent = dn.toFixed(3);
      thVal.textContent = parseFloat(rngTheta.value).toFixed(2) + '°';

      // resize canvases
      const d = cDiagram.resize();
      const m = cMain.resize();
      const s = cSecondary.resize();

      // draw
      drawDiagram(cDiagram.ctx, d.w, d.h, no, ne, parseFloat(rngTheta.value));
      drawMainPlot(cMain.ctx, m.w, m.h, no, ne);
      drawSecondaryPlot(cSecondary.ctx, s.w, s.h, no, ne);

      updateReadout(no, ne);
    }

    // Events
    [selType, rngDn, rngTheta].forEach(el=>{
      el.addEventListener('input', redrawAll);
      el.addEventListener('change', redrawAll);
    });

    // Keep theta slider roughly aligned to computed theta_max when dn/type changes (gentle nudge)
    function snapThetaToMax(){
      const {no, ne} = getIndices();
      const thM = thetaMax(no, ne)/DEG;
      // if user hasn't moved far from old value, gently snap
      const curr = parseFloat(rngTheta.value);
      if(Math.abs(curr - thM) < 6){
        rngTheta.value = thM.toFixed(2);
      }
    }
    selType.addEventListener('change', ()=>{ snapThetaToMax(); redrawAll(); });
    rngDn.addEventListener('change', ()=>{ snapThetaToMax(); redrawAll(); });

    // Resize observer for responsiveness
    const ro = new ResizeObserver(()=>redrawAll());
    ro.observe(document.getElementById('cDiagram'));
    ro.observe(document.getElementById('cMain'));
    ro.observe(document.getElementById('cSecondary'));

    // Initialize with quartz maximum direction
    (function init(){
      // Set theta slider to quartz theta_max exactly
      const thM = thetaMax(noQuartz, noQuartz + parseFloat(rngDn.value))/DEG;
      rngTheta.value = thM.toFixed(2);
      redrawAll();
    })();
  </script>
</body>
</html>
