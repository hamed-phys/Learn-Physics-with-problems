<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="color-scheme" content="light dark" />
  <title>Standing Waves & Fringe Visibility — Intensity vs z and Visibility vs Intensity Ratio</title>
  <style>
    :root{
      --bg: #0b0d12;
      --panel: #121624;
      --panel2:#0f1320;
      --text:#e8ecff;
      --muted:#aab3d6;
      --accent:#78a6ff;
      --accent2:#7dffcf;
      --warn:#ffcc66;
      --danger:#ff6b88;
      --line: rgba(255,255,255,.10);
      --shadow: 0 10px 35px rgba(0,0,0,.35);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    @media (prefers-color-scheme: light){
      :root{
        --bg:#f6f7fb;
        --panel:#ffffff;
        --panel2:#ffffff;
        --text:#101426;
        --muted:#4b5675;
        --line: rgba(16,20,38,.12);
        --shadow: 0 12px 32px rgba(16,20,38,.12);
      }
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(120,166,255,.18), transparent 60%),
        radial-gradient(900px 500px at 85% 15%, rgba(125,255,207,.12), transparent 55%),
        radial-gradient(900px 500px at 40% 95%, rgba(255,204,102,.10), transparent 60%),
        var(--bg);
      line-height:1.55;
    }

    header{
      padding:28px 18px 18px;
      max-width:1200px;
      margin:0 auto;
    }
    .titlebar{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 900px){
      .titlebar{grid-template-columns:1fr}
    }
    .hero{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:18px 18px 16px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(700px 250px at 20% 0%, rgba(120,166,255,.16), transparent 60%);
      pointer-events:none;
    }
    h1{
      margin:0 0 8px;
      font-size: clamp(20px, 2.6vw, 34px);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: 14px;
    }

    .summary{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    .summary h2{
      margin:0 0 8px;
      font-size: 16px;
      letter-spacing:.2px;
    }
    .summary ul{
      margin:0;
      padding-left:18px;
      color: var(--muted);
    }
    .summary li{margin:6px 0}

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 34px;
      display:grid;
      grid-template-columns: 290px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }

    /* Sticky mini-TOC */
    nav.toc{
      position: sticky;
      top: 12px;
      align-self:start;
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .toc-head{
      padding:14px 14px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
    }
    .toc-head strong{font-size:13px; letter-spacing:.3px}
    .chip{
      font-size:12px;
      color:var(--muted);
      border:1px solid var(--line);
      padding:4px 10px;
      border-radius:999px;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.01));
    }
    .toc a{
      display:block;
      padding:10px 14px;
      color: var(--muted);
      text-decoration:none;
      border-bottom:1px solid rgba(255,255,255,.06);
      transition: transform .15s ease, background .15s ease, color .15s ease;
      font-size: 13px;
    }
    .toc a:last-child{border-bottom:none}
    .toc a:hover{
      background: rgba(120,166,255,.10);
      color: var(--text);
      transform: translateX(2px);
    }

    article{
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    section.card{
      background: var(--panel);
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:16px;
      overflow:hidden;
    }
    section.card h2{
      margin:0 0 10px;
      font-size: 18px;
      letter-spacing:.15px;
    }
    section.card h3{
      margin:14px 0 8px;
      font-size: 15px;
      letter-spacing:.1px;
      color: var(--text);
    }
    .muted{color:var(--muted)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 900px){ .grid2{grid-template-columns:1fr} }

    .callout{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: 14px;
      padding:12px;
    }
    .callout strong{color:var(--accent)}
    .warn strong{color: var(--warn)}
    .danger strong{color: var(--danger)}

    .eq{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      border:1px dashed rgba(120,166,255,.35);
      background: rgba(120,166,255,.08);
      border-radius: 14px;
      padding:12px 12px 10px;
      margin:10px 0;
      overflow:auto;
    }
    .eq code{
      font-family: var(--mono);
      font-size: 13px;
      color: var(--text);
      white-space: pre;
    }
    .btn{
      appearance:none;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.08), rgba(255,255,255,.02));
      color: var(--text);
      padding:7px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:12px;
      transition: transform .12s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{transform: translateY(-1px); border-color: rgba(120,166,255,.35); background: rgba(120,166,255,.10)}
    .btn:active{transform: translateY(0px)}
    .btn.small{padding:6px 9px; font-size:11px}
    .row{
      display:flex; gap:10px; flex-wrap:wrap; align-items:center;
    }

    figure.viz{
      margin:0;
      border:1px solid var(--line);
      border-radius: 16px;
      background: var(--panel2);
      padding:12px;
      overflow:hidden;
    }
    figure.viz figcaption{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin:0 0 10px;
      color: var(--muted);
      font-size: 12px;
    }
    .canvasWrap{
      width:100%;
      aspect-ratio: 16/9;
      border-radius: 14px;
      overflow:hidden;
      background:
        radial-gradient(600px 240px at 20% 0%, rgba(120,166,255,.10), transparent 60%),
        radial-gradient(500px 220px at 85% 25%, rgba(125,255,207,.08), transparent 55%),
        rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.06);
    }
    @media (prefers-color-scheme: light){
      .canvasWrap{
        background:
          radial-gradient(600px 240px at 20% 0%, rgba(120,166,255,.10), transparent 60%),
          radial-gradient(500px 220px at 85% 25%, rgba(125,255,207,.08), transparent 55%),
          rgba(16,20,38,.04);
      }
    }
    canvas{width:100%; height:100%; display:block}

    .controls{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:12px;
      margin-top:12px;
      align-items:start;
    }
    @media (max-width: 900px){ .controls{grid-template-columns:1fr} }
    .ctrl{
      border:1px solid var(--line);
      border-radius: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      padding:12px;
    }
    .ctrl label{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size: 12px;
      margin-bottom:8px;
    }
    .ctrl label span.val{
      font-family: var(--mono);
      color: var(--text);
      font-size: 12px;
    }
    input[type="range"]{width:100%}
    select{
      width:100%;
      border:1px solid var(--line);
      border-radius: 12px;
      padding:8px 10px;
      background: rgba(255,255,255,.04);
      color: var(--text);
    }
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
      margin-top:12px;
    }
    .kpi .box{
      border:1px solid var(--line);
      border-radius: 14px;
      padding:10px;
      background: rgba(0,0,0,.08);
    }
    @media (prefers-color-scheme: light){
      .kpi .box{background: rgba(16,20,38,.03)}
    }
    .kpi .box .name{color: var(--muted); font-size: 12px}
    .kpi .box .num{font-family: var(--mono); font-size: 13px; margin-top:4px}

    .boxFinal{
      border:1px solid rgba(125,255,207,.35);
      background: rgba(125,255,207,.08);
      border-radius: 16px;
      padding: 12px;
      margin-top: 10px;
    }
    .boxFinal .hd{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .boxFinal .hd strong{color: var(--accent2)}
    .boxFinal code{font-family: var(--mono); font-size: 13px; white-space: pre-wrap}

    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 10px 18px 28px;
      color: var(--muted);
      font-size: 12px;
    }

    /* Print-friendly */
    @media print{
      :root{
        --bg:#fff; --panel:#fff; --panel2:#fff; --text:#000; --muted:#333; --line:#ccc; --shadow:none;
      }
      nav.toc{display:none}
      .canvasWrap{border:1px solid #ccc}
      .btn{display:none}
      body{background:#fff}
      section.card, .hero, .summary{box-shadow:none}
    }

    /* Subtle entrance animation */
    @media (prefers-reduced-motion: no-preference){
      .hero, .summary, section.card, nav.toc{animation: pop .38s ease both}
      .summary{animation-delay:.04s}
      nav.toc{animation-delay:.06s}
      section.card{animation-delay:.08s}
      @keyframes pop{
        from{opacity:0; transform: translateY(8px)}
        to{opacity:1; transform: translateY(0)}
      }
    }
  </style>
</head>

<body>
<header>
  <div class="titlebar">
    <div class="hero">
      <h1>Standing Waves & Fringe Visibility (1D interference along <span style="font-family:var(--mono)">z</span>)</h1>
      <p class="subtitle">
        Two counter-propagating plane waves → spatially varying time-averaged intensity <span style="font-family:var(--mono)">I(z)</span>.
        Then compute interference visibility <span style="font-family:var(--mono)">V</span> and maximize it.
      </p>
    </div>

    <div class="summary" id="quick-summary">
      <h2>Quick Summary</h2>
      <ul>
        <li>Model the fields as <span style="font-family:var(--mono)">E1 = E01 cos(kz − ωt)</span>, <span style="font-family:var(--mono)">E2 = E02 cos(kz + ωt + φ)</span>.</li>
        <li>Time-averaged intensity is proportional to <span style="font-family:var(--mono)">⟨E^2⟩</span>, producing an interference term that depends on <span style="font-family:var(--mono)">z</span>.</li>
        <li><span style="font-family:var(--mono)">I(z) = I1 + I2 + 2√(I1 I2) cos(2kz + φ)</span> with <span style="font-family:var(--mono)">k = 2π/λ</span>.</li>
        <li>Max/min: <span style="font-family:var(--mono)">Imax=(√I1+√I2)^2</span>, <span style="font-family:var(--mono)">Imin=(√I1−√I2)^2</span>.</li>
        <li>Visibility: <span style="font-family:var(--mono)">V = (Imax−Imin)/(Imax+Imin) = 2√(I1 I2)/(I1+I2)</span>.</li>
        <li>Visibility is maximum when <span style="font-family:var(--mono)">I1=I2</span> (equal intensities), giving <span style="font-family:var(--mono)">Vmax=1</span>.</li>
      </ul>
    </div>
  </div>
</header>

<main>
  <nav class="toc" aria-label="Table of contents">
    <div class="toc-head">
      <strong>On this page</strong>
      <span class="chip">sticky TOC</span>
    </div>
    <a href="#part1">PART 1 — Problem Analysis</a>
    <a href="#part2">PART 2 — Strategy & Tips</a>
    <a href="#viz">Interactive Visualizations</a>
    <a href="#part3">PART 3 — Full Solution</a>
    <a href="#final">Final Results</a>
  </nav>

  <article>
    <section class="card" id="part1">
      <h2>PART 1 — Problem Analysis (no solving yet)</h2>

      <h3>1) Restate the problem</h3>
      <p class="muted">
        Two monochromatic plane waves with the same wavelength <span style="font-family:var(--mono)">λ</span> travel in opposite directions along the
        <span style="font-family:var(--mono)">z</span>-axis. Find the time-averaged intensity of their superposition as a function of position
        <span style="font-family:var(--mono)">z</span>, and sketch <span style="font-family:var(--mono)">I</span> versus <span style="font-family:var(--mono)">z</span>.
        Then define the fringe visibility
        <span style="font-family:var(--mono)">V = (Imax − Imin)/(Imax + Imin)</span>, derive <span style="font-family:var(--mono)">V</span> in terms of
        <span style="font-family:var(--mono)">I1/I2</span>, and find the ratio that maximizes visibility.
      </p>

      <div class="grid2">
        <div class="callout">
          <strong>Given</strong>
          <ul class="muted" style="margin:8px 0 0; padding-left:18px">
            <li>Two plane waves, same wavelength <span style="font-family:var(--mono)">λ</span>, propagate along <span style="font-family:var(--mono)">±z</span>.</li>
            <li>Intensities (or amplitudes) of the two waves: <span style="font-family:var(--mono)">I1</span>, <span style="font-family:var(--mono)">I2</span> (in general not equal).</li>
            <li>Possible constant relative phase <span style="font-family:var(--mono)">φ</span> (can be included without loss of generality).</li>
          </ul>
        </div>

        <div class="callout warn">
          <strong>Unknowns / What to find</strong>
          <ul class="muted" style="margin:8px 0 0; padding-left:18px">
            <li>The spatial intensity pattern <span style="font-family:var(--mono)">I(z)</span> from interference.</li>
            <li>The maxima/minima <span style="font-family:var(--mono)">Imax</span>, <span style="font-family:var(--mono)">Imin</span>.</li>
            <li>The visibility <span style="font-family:var(--mono)">V</span> as a function of <span style="font-family:var(--mono)">I1/I2</span>.</li>
            <li>The intensity ratio that maximizes <span style="font-family:var(--mono)">V</span>.</li>
          </ul>
        </div>
      </div>

      <h3>2) Relevant physical principles (and why they apply)</h3>
      <ul class="muted">
        <li><strong>Superposition of electromagnetic fields:</strong> In linear media, the total field is the sum of fields.</li>
        <li><strong>Intensity as a time average:</strong> For harmonic waves, measurable intensity is proportional to the time-average of the squared field magnitude,
          <span style="font-family:var(--mono)">I ∝ ⟨E^2⟩</span> (or Poynting vector magnitude averaged over a cycle).</li>
        <li><strong>Interference term:</strong> When adding two coherent waves, a cross-term produces spatial variation, giving fringes/standing-wave nodes.</li>
      </ul>

      <h3>3) Possible approaches (compare briefly)</h3>
      <ol class="muted">
        <li><strong>Trig approach (fast & transparent):</strong> Write the two real fields as cosines, add them, square, and time-average using identities.</li>
        <li><strong>Complex phasor approach (clean algebra):</strong> Use complex exponentials, compute <span style="font-family:var(--mono)">|Ẽ(z)|^2</span> for the phasor sum, then map to intensity.</li>
        <li><strong>Poynting-vector approach (most “EM”):</strong> Build full <span style="font-family:var(--mono)">E</span> and <span style="font-family:var(--mono)">H</span>, compute
          <span style="font-family:var(--mono)">⟨S⟩</span>. More work than needed here.</li>
      </ol>

      <div class="callout">
        <strong>Chosen approach:</strong>
        <span class="muted">Use the trig/phasor interference method. It directly yields the standard result
        <span style="font-family:var(--mono)">I(z)=I1+I2+2√(I1 I2)cos(Δphase)</span> with minimal overhead.</span>
      </div>
    </section>

    <section class="card" id="part2">
      <h2>PART 2 — Strategy & Tips (roadmap only)</h2>

      <h3>Step-by-step plan (no algebra yet)</h3>
      <ol class="muted">
        <li><strong>Write the two waves:</strong> choose consistent forms for counter-propagating waves, include a relative phase <span style="font-family:var(--mono)">φ</span>.</li>
        <li><strong>Add fields:</strong> <span style="font-family:var(--mono)">E = E1 + E2</span>.</li>
        <li><strong>Relate intensity to field:</strong> use <span style="font-family:var(--mono)">I(z) ∝ ⟨E^2(z,t)⟩t</span> (time average over one optical period).</li>
        <li><strong>Evaluate the time average:</strong> use identities like <span style="font-family:var(--mono)">⟨cos^2⟩=1/2</span>, <span style="font-family:var(--mono)">⟨cos a cos b⟩=(1/2)cos(a−b)</span>.</li>
        <li><strong>Express results in intensities:</strong> connect amplitudes to intensities via <span style="font-family:var(--mono)">I ∝ E0^2</span>, giving cross-term <span style="font-family:var(--mono)">2√(I1 I2)</span>.</li>
        <li><strong>Find extrema:</strong> identify <span style="font-family:var(--mono)">cos</span> term range to get <span style="font-family:var(--mono)">Imax</span>, <span style="font-family:var(--mono)">Imin</span>.</li>
        <li><strong>Compute visibility:</strong> plug <span style="font-family:var(--mono)">Imax</span>, <span style="font-family:var(--mono)">Imin</span> into definition of <span style="font-family:var(--mono)">V</span>.</li>
        <li><strong>Maximize visibility:</strong> write <span style="font-family:var(--mono)">V</span> in terms of ratio <span style="font-family:var(--mono)">r=I1/I2</span> and maximize (symmetry or calculus).</li>
      </ol>

      <div class="grid2">
        <div class="callout warn">
          <strong>Common mistakes</strong>
          <ul class="muted" style="margin:8px 0 0; padding-left:18px">
            <li>Forgetting the time average: using instantaneous <span style="font-family:var(--mono)">E^2</span> instead of <span style="font-family:var(--mono)">⟨E^2⟩</span>.</li>
            <li>Dropping the cross term: the interference pattern is entirely from the cross term.</li>
            <li>Confusing <span style="font-family:var(--mono)">k</span> with <span style="font-family:var(--mono)">2k</span>: counter-propagating waves yield <span style="font-family:var(--mono)">cos(2kz+φ)</span> in the intensity.</li>
          </ul>
        </div>
        <div class="callout">
          <strong>Quick tips</strong>
          <ul class="muted" style="margin:8px 0 0; padding-left:18px">
            <li>Use <span style="font-family:var(--mono)">k=2π/λ</span> early so the spatial period is obvious.</li>
            <li>Remember <span style="font-family:var(--mono)">Imax</span> occurs when the cosine term is <span style="font-family:var(--mono)">+1</span>, <span style="font-family:var(--mono)">Imin</span> when it is <span style="font-family:var(--mono)">−1</span>.</li>
            <li>Visibility symmetry: swapping <span style="font-family:var(--mono)">I1</span> and <span style="font-family:var(--mono)">I2</span> should not change <span style="font-family:var(--mono)">V</span>.</li>
          </ul>
        </div>
      </div>
    </section>

    <section class="card" id="viz">
      <h2>Interactive Visualizations</h2>
      <p class="muted">
        Controls adjust the intensity ratio <span style="font-family:var(--mono)">r = I1/I2</span>, wavelength <span style="font-family:var(--mono)">λ</span> (example units),
        and relative phase <span style="font-family:var(--mono)">φ</span>. All plots update live.
      </p>

      <div class="grid2">
        <figure class="viz" aria-label="Diagram of setup">
          <figcaption>
            <span><strong style="color:var(--accent)">Diagram:</strong> counter-propagating plane waves along <span style="font-family:var(--mono)">z</span></span>
            <button class="btn small" data-copy-target="#eq-diagram-note">Copy note</button>
          </figcaption>
          <div class="canvasWrap"><canvas id="cDiagram"></canvas></div>
          <div class="eq" id="eq-diagram-note" style="margin-top:10px">
            <code>Setup: Wave 1 travels +z, Wave 2 travels −z (same λ), superpose → standing-wave intensity pattern I(z).</code>
            <button class="btn" data-copy-target="#eq-diagram-note">Copy</button>
          </div>
        </figure>

        <figure class="viz" aria-label="Intensity vs position plot">
          <figcaption>
            <span><strong style="color:var(--accent)">Main plot:</strong> <span style="font-family:var(--mono)">I(z)</span> vs <span style="font-family:var(--mono)">z</span></span>
            <button class="btn small" data-copy-target="#eq-Iz">Copy I(z)</button>
          </figcaption>
          <div class="canvasWrap"><canvas id="cMain"></canvas></div>
          <div class="eq" id="eq-Iz" style="margin-top:10px">
            <code>I(z) = I1 + I2 + 2*sqrt(I1*I2)*cos(2*k*z + φ),   k = 2π/λ</code>
            <button class="btn" data-copy-target="#eq-Iz">Copy</button>
          </div>

          <div class="kpi" aria-label="Computed values">
            <div class="box">
              <div class="name">Imax (example units)</div>
              <div class="num" id="kpiImax">—</div>
            </div>
            <div class="box">
              <div class="name">Imin (example units)</div>
              <div class="num" id="kpiImin">—</div>
            </div>
            <div class="box">
              <div class="name">Visibility V</div>
              <div class="num" id="kpiV">—</div>
            </div>
            <div class="box">
              <div class="name">Fringe period in z</div>
              <div class="num" id="kpiPeriod">—</div>
            </div>
          </div>
        </figure>
      </div>

      <figure class="viz" aria-label="Visibility vs ratio plot" style="margin-top:14px">
        <figcaption>
          <span><strong style="color:var(--accent)">Parameter sweep:</strong> <span style="font-family:var(--mono)">V</span> vs <span style="font-family:var(--mono)">r = I1/I2</span></span>
          <button class="btn small" data-copy-target="#eq-Vr">Copy V(r)</button>
        </figcaption>
        <div class="canvasWrap"><canvas id="cSweep"></canvas></div>
        <div class="eq" id="eq-Vr" style="margin-top:10px">
          <code>Let r = I1/I2.  Then V(r) = 2*sqrt(r)/(1 + r).  Maximum at r = 1 → Vmax = 1.</code>
          <button class="btn" data-copy-target="#eq-Vr">Copy</button>
        </div>

        <div class="controls" aria-label="Interactive controls">
          <div class="ctrl">
            <label for="rSlider">
              <span>Intensity ratio <span style="font-family:var(--mono)">r = I1/I2</span></span>
              <span class="val" id="rVal">—</span>
            </label>
            <input id="rSlider" type="range" min="0" max="5" step="0.01" value="1.00" />
            <div class="row" style="margin-top:10px">
              <button class="btn" id="btnEqual">Set r = 1 (max visibility)</button>
              <button class="btn" id="btnFlip">Swap (r → 1/r)</button>
            </div>
          </div>

          <div class="ctrl">
            <label for="lambdaSlider">
              <span>Wavelength <span style="font-family:var(--mono)">λ</span> (example units)</span>
              <span class="val" id="lambdaVal">—</span>
            </label>
            <input id="lambdaSlider" type="range" min="0.5" max="3.0" step="0.01" value="1.00" />

            <label for="phiSlider" style="margin-top:12px">
              <span>Relative phase <span style="font-family:var(--mono)">φ</span> (rad)</span>
              <span class="val" id="phiVal">—</span>
            </label>
            <input id="phiSlider" type="range" min="0" max="6.283185307" step="0.001" value="0.00" />

            <label for="zSpanSel" style="margin-top:12px">
              <span>Plot span in <span style="font-family:var(--mono)">z</span></span>
              <span class="val" id="zSpanVal">—</span>
            </label>
            <select id="zSpanSel">
              <option value="1">0 to 1λ</option>
              <option value="2">0 to 2λ</option>
              <option value="3" selected>0 to 3λ</option>
              <option value="4">0 to 4λ</option>
            </select>
          </div>
        </div>
      </figure>
    </section>

    <section class="card" id="part3">
      <h2>PART 3 — Full Solution</h2>

      <h3>Physical intuition</h3>
      <p class="muted">
        Two waves traveling in opposite directions can create a <em>standing-wave pattern</em> because their phase difference at a point
        depends on position. Where they add in phase, the intensity is large (antinodes). Where they add out of phase, the intensity is
        small (nodes). If the two waves have unequal strengths, the minima do not generally go to zero, so the contrast decreases.
      </p>

      <h3>3.1 Field model and definitions</h3>
      <p class="muted">
        Take two linearly polarized plane waves (same polarization, same frequency) moving along <span style="font-family:var(--mono)">±z</span>:
      </p>

      <div class="eq" id="eq-fields">
        <code>E1(z,t) = E01 cos(kz − ωt)
E2(z,t) = E02 cos(kz + ωt + φ)
with   k = 2π/λ</code>
        <button class="btn" data-copy-target="#eq-fields">Copy</button>
      </div>

      <p class="muted">
        The total field is <span style="font-family:var(--mono)">E = E1 + E2</span>. For harmonic light, the measurable (cycle-averaged) intensity satisfies
        <span style="font-family:var(--mono)">I(z) ∝ ⟨E^2(z,t)⟩</span>. (The proportionality constant depends on medium impedance, etc., but cancels in visibility.)
      </p>

      <h3>3.2 Compute the time-averaged intensity I(z)</h3>
      <p class="muted">Start from:</p>
      <div class="eq" id="eq-expand">
        <code>E^2 = (E1 + E2)^2 = E1^2 + E2^2 + 2E1E2</code>
        <button class="btn" data-copy-target="#eq-expand">Copy</button>
      </div>

      <p class="muted">
        Time-average each term over one optical period. Use standard averages for cosines:
      </p>
      <div class="eq" id="eq-averages">
        <code>⟨cos^2(… )⟩ = 1/2
⟨cos A cos B⟩ = (1/2) cos(A − B)   (because the cos(A+B) term averages to 0 in time)</code>
        <button class="btn" data-copy-target="#eq-averages">Copy</button>
      </div>

      <p class="muted">
        Apply these:
      </p>
      <ul class="muted">
        <li>
          <span style="font-family:var(--mono)">⟨E1^2⟩ = ⟨E01^2 cos^2(kz − ωt)⟩ = (E01^2)/2</span>
        </li>
        <li>
          <span style="font-family:var(--mono)">⟨E2^2⟩ = (E02^2)/2</span>
        </li>
        <li>
          For the cross term, let <span style="font-family:var(--mono)">A = kz − ωt</span>, <span style="font-family:var(--mono)">B = kz + ωt + φ</span>.
          Then <span style="font-family:var(--mono)">A − B = −2ωt − φ</span>? Careful: with the chosen forms,
          <span style="font-family:var(--mono)">A − B = (kz − ωt) − (kz + ωt + φ) = −2ωt − φ</span>, whose time-average would be zero.
          That indicates we should instead treat the second wave as <span style="font-family:var(--mono)">E2 = E02 cos(−kz − ωt + φ)</span> (same frequency, opposite direction),
          or equivalently <span style="font-family:var(--mono)">E2 = E02 cos(kz + ωt + φ)</span> but compute the interference via equal-time phase difference in space using phasors.
          The cleanest consistent route is the phasor method below (same final result).
        </li>
      </ul>

      <div class="callout danger">
        <strong>Important consistency note:</strong>
        <span class="muted">
          For counter-propagating waves at the same frequency, the interference pattern is stationary in space after time averaging and must contain
          <span style="font-family:var(--mono)">cos(2kz + φ)</span>. The phasor method guarantees this cleanly.
        </span>
      </div>

      <h3>3.3 Phasor derivation (robust and standard)</h3>
      <p class="muted">
        Represent the real electric fields as the real part of complex fields:
        <span style="font-family:var(--mono)">E(z,t) = Re{ Ẽ(z) e^{-iωt} }</span>.
        For waves traveling in <span style="font-family:var(--mono)">±z</span>:
      </p>

      <div class="eq" id="eq-phasors">
        <code>Ẽ1(z) = E01 e^{+ikz}
Ẽ2(z) = E02 e^{-ikz} e^{iφ}
Total phasor:  Ẽ(z) = Ẽ1 + Ẽ2</code>
        <button class="btn" data-copy-target="#eq-phasors">Copy</button>
      </div>

      <p class="muted">
        The time-averaged intensity is proportional to the squared magnitude of the phasor:
        <span style="font-family:var(--mono)">I(z) ∝ |Ẽ(z)|^2</span>.
        Compute:
      </p>

      <div class="eq" id="eq-mag">
        <code>|Ẽ|^2 = (Ẽ1 + Ẽ2)(Ẽ1* + Ẽ2*)
       = |Ẽ1|^2 + |Ẽ2|^2 + Ẽ1 Ẽ2* + Ẽ1* Ẽ2</code>
        <button class="btn" data-copy-target="#eq-mag">Copy</button>
      </div>

      <p class="muted">
        Now evaluate each term:
      </p>
      <ul class="muted">
        <li><span style="font-family:var(--mono)">|Ẽ1|^2 = E01^2</span>, <span style="font-family:var(--mono)">|Ẽ2|^2 = E02^2</span>.</li>
        <li>
          <span style="font-family:var(--mono)">Ẽ1 Ẽ2* = (E01 e^{ikz})(E02 e^{+ikz} e^{-iφ}) = E01 E02 e^{i(2kz − φ)}</span>.
        </li>
        <li>
          <span style="font-family:var(--mono)">Ẽ1* Ẽ2 = E01 E02 e^{-i(2kz − φ)}</span>.
        </li>
        <li>Sum the last two terms: <span style="font-family:var(--mono)">E01 E02 [e^{i(2kz − φ)} + e^{-i(2kz − φ)}] = 2E01 E02 cos(2kz − φ)</span>.</li>
      </ul>

      <p class="muted">
        Therefore,
      </p>
      <div class="eq" id="eq-Iamp">
        <code>I(z) ∝ E01^2 + E02^2 + 2E01 E02 cos(2kz − φ)</code>
        <button class="btn" data-copy-target="#eq-Iamp">Copy</button>
      </div>

      <p class="muted">
        Convert to intensities. Since (for fixed medium) intensity is proportional to amplitude squared,
        <span style="font-family:var(--mono)">I1 ∝ E01^2</span> and <span style="font-family:var(--mono)">I2 ∝ E02^2</span>.
        That implies <span style="font-family:var(--mono)">E01 E02 ∝ √(I1 I2)</span>. Absorbing the same proportionality constant into <span style="font-family:var(--mono)">I</span>,
        we get the standard interference formula:
      </p>

      <div class="eq" id="eq-Iz2">
        <code>I(z) = I1 + I2 + 2*sqrt(I1*I2)*cos(2*k*z + φ)</code>
        <button class="btn" data-copy-target="#eq-Iz2">Copy</button>
      </div>

      <p class="muted">
        (A shift <span style="font-family:var(--mono)">φ → −φ</span> is physically irrelevant; it just shifts the pattern along <span style="font-family:var(--mono)">z</span>.)
        The cosine depends on <span style="font-family:var(--mono)">2kz</span>, so the spatial period is:
      </p>
      <div class="eq" id="eq-period">
        <code>cos(2kz) repeats when 2kΔz = 2π  ⇒  Δz = π/k = λ/2</code>
        <button class="btn" data-copy-target="#eq-period">Copy</button>
      </div>

      <h3>3.4 Sketch / features of I(z)</h3>
      <ul class="muted">
        <li><strong>Fringe spacing:</strong> maxima repeat every <span style="font-family:var(--mono)">λ/2</span> along <span style="font-family:var(--mono)">z</span>.</li>
        <li><strong>Maxima/minima values:</strong> since <span style="font-family:var(--mono)">cos</span> ranges from <span style="font-family:var(--mono)">−1</span> to <span style="font-family:var(--mono)">+1</span>:</li>
      </ul>
      <div class="eq" id="eq-extrema">
        <code>Imax = I1 + I2 + 2*sqrt(I1*I2) = (sqrt(I1) + sqrt(I2))^2
Imin = I1 + I2 − 2*sqrt(I1*I2) = (sqrt(I1) − sqrt(I2))^2</code>
        <button class="btn" data-copy-target="#eq-extrema">Copy</button>
      </div>

      <h3>3.5 Fringe visibility V and its maximum</h3>
      <p class="muted">
        Using the definition <span style="font-family:var(--mono)">V = (Imax − Imin)/(Imax + Imin)</span> and the expressions above:
      </p>
      <div class="eq" id="eq-Vderive">
        <code>Imax − Imin = 4*sqrt(I1*I2)
Imax + Imin = 2*(I1 + I2)

⇒  V = (4*sqrt(I1*I2)) / (2*(I1 + I2))
   = 2*sqrt(I1*I2) / (I1 + I2)</code>
        <button class="btn" data-copy-target="#eq-Vderive">Copy</button>
      </div>

      <p class="muted">
        Let <span style="font-family:var(--mono)">r = I1/I2</span>. Divide numerator and denominator by <span style="font-family:var(--mono)">I2</span>:
      </p>
      <div class="eq" id="eq-Vr2">
        <code>V(r) = 2*sqrt(r) / (1 + r)</code>
        <button class="btn" data-copy-target="#eq-Vr2">Copy</button>
      </div>

      <p class="muted">
        To maximize <span style="font-family:var(--mono)">V(r)</span>, note the symmetry <span style="font-family:var(--mono)">V(r)=V(1/r)</span> and that
        the function peaks when the two intensities match. Formally, you can check that the maximum occurs at <span style="font-family:var(--mono)">r=1</span>.
        Then:
      </p>
      <div class="eq" id="eq-Vmax">
        <code>r = 1  ⇒  I1 = I2  ⇒  Vmax = 1</code>
        <button class="btn" data-copy-target="#eq-Vmax">Copy</button>
      </div>

      <h3>3.6 Sanity checks</h3>
      <div class="grid2">
        <div class="callout">
          <strong>Units</strong>
          <p class="muted" style="margin:8px 0 0">
            <span style="font-family:var(--mono)">I(z)</span> has units of intensity (e.g., W/m²). The cosine term is dimensionless. <span style="font-family:var(--mono)">kz</span> is dimensionless since <span style="font-family:var(--mono)">k</span> is 1/length.
          </p>
        </div>
        <div class="callout">
          <strong>Limiting cases</strong>
          <ul class="muted" style="margin:8px 0 0; padding-left:18px">
            <li>If <span style="font-family:var(--mono)">I2 → 0</span>: then <span style="font-family:var(--mono)">I(z) → I1</span> (no fringes), and <span style="font-family:var(--mono)">V → 0</span>.</li>
            <li>If <span style="font-family:var(--mono)">I1 = I2</span>: then <span style="font-family:var(--mono)">Imin = 0</span>, perfect nodes, and <span style="font-family:var(--mono)">V=1</span>.</li>
          </ul>
        </div>
      </div>

      <div class="callout">
        <strong>Physical interpretation</strong>
        <p class="muted" style="margin:8px 0 0">
          The contrast is governed by how comparable the field amplitudes are. Equal amplitudes allow complete destructive interference (true nodes),
          while imbalance leaves residual intensity at minima, reducing visibility.
        </p>
      </div>
    </section>

    <section class="card" id="final">
      <h2>Final Results</h2>

      <div class="boxFinal" id="finalBox">
        <div class="hd">
          <strong>Boxed answers (copy-ready)</strong>
          <button class="btn" data-copy-target="#finalText">Copy final answers</button>
        </div>
        <code id="finalText">Standing-wave (counter-propagating) intensity:
I(z) = I1 + I2 + 2*sqrt(I1*I2)*cos(2*k*z + φ),   k = 2π/λ
Fringe spacing in z: Δz = λ/2

Extrema:
Imax = (sqrt(I1) + sqrt(I2))^2
Imin = (sqrt(I1) − sqrt(I2))^2

Visibility:
V = (Imax − Imin)/(Imax + Imin) = 2*sqrt(I1*I2)/(I1 + I2)
Let r = I1/I2:  V(r) = 2*sqrt(r)/(1 + r)
Maximum visibility at r = 1 (I1 = I2), giving Vmax = 1.</code>
      </div>

      <p class="muted" style="margin-top:10px">
        The interactive plots above illustrate both the spatial pattern <span style="font-family:var(--mono)">I(z)</span> and how visibility changes as you vary
        <span style="font-family:var(--mono)">r = I1/I2</span>.
      </p>
    </section>
  </article>
</main>

<footer>
  <div>
    Built with vanilla HTML/CSS/JS. Canvas plots are high-DPI aware and responsive.
  </div>
</footer>

<script>
/* ===========================
   Copy buttons (plain text)
   =========================== */
(function(){
  function copyText(text){
    if(navigator.clipboard && navigator.clipboard.writeText){
      return navigator.clipboard.writeText(text);
    }
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = text;
    ta.style.position='fixed';
    ta.style.left='-9999px';
    ta.style.top='-9999px';
    document.body.appendChild(ta);
    ta.focus();
    ta.select();
    try{ document.execCommand('copy'); } catch(e){}
    document.body.removeChild(ta);
    return Promise.resolve();
  }

  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-copy-target]');
    if(!btn) return;
    const sel = btn.getAttribute('data-copy-target');
    const el = document.querySelector(sel);
    if(!el) return;
    const text = (el.innerText || el.textContent || '').trim();
    const old = btn.textContent;
    btn.textContent = 'Copied ✓';
    copyText(text).finally(()=>{
      setTimeout(()=>btn.textContent = old, 900);
    });
  });
})();

/* ===========================
   Smooth TOC scrolling
   =========================== */
(function(){
  document.querySelectorAll('nav.toc a[href^="#"]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const id = a.getAttribute('href');
      const target = document.querySelector(id);
      if(!target) return;
      target.scrollIntoView({behavior:'smooth', block:'start'});
      history.replaceState(null, '', id);
    });
  });
})();

/* ===========================
   Plotting utilities
   =========================== */
function clamp(x,a,b){ return Math.max(a, Math.min(b, x)); }

function formatNum(x, digits=4){
  if(!isFinite(x)) return '—';
  const ax = Math.abs(x);
  if(ax !== 0 && (ax < 1e-3 || ax > 1e4)) return x.toExponential(3);
  return x.toFixed(digits).replace(/\.?0+$/,'');
}

function setupHiDPICanvas(canvas){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(2, Math.floor(rect.width * dpr));
  const h = Math.max(2, Math.floor(rect.height * dpr));
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w; canvas.height = h;
  }
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  return {ctx, wCSS: rect.width, hCSS: rect.height, dpr};
}

function drawAxes(ctx, box, xMin, xMax, yMin, yMax, opts){
  const {
    title='', xLabel='', yLabel='',
    grid=true, ticks=6, yTicks=5,
    fg='rgba(255,255,255,.85)',
    muted='rgba(255,255,255,.45)',
    gridCol='rgba(255,255,255,.08)'
  } = opts || {};

  const {x,y,w,h} = box;

  // Background
  ctx.save();
  ctx.fillStyle = 'rgba(0,0,0,0)';
  ctx.fillRect(x,y,w,h);

  // Title
  ctx.fillStyle = fg;
  ctx.font = '600 13px ui-sans-serif, system-ui';
  ctx.textAlign = 'left';
  ctx.textBaseline = 'top';
  ctx.fillText(title, x, y-18);

  // Grid + ticks
  ctx.strokeStyle = muted;
  ctx.lineWidth = 1;

  const plot = {x:x, y:y, w:w, h:h};

  function X(u){ return plot.x + (u - xMin) * plot.w / (xMax - xMin); }
  function Y(v){ return plot.y + plot.h - (v - yMin) * plot.h / (yMax - yMin); }

  if(grid){
    ctx.strokeStyle = gridCol;
    ctx.lineWidth = 1;
    // vertical grid lines
    for(let i=0;i<=ticks;i++){
      const u = xMin + (xMax-xMin)*i/ticks;
      const xp = X(u);
      ctx.beginPath();
      ctx.moveTo(xp, plot.y);
      ctx.lineTo(xp, plot.y + plot.h);
      ctx.stroke();
    }
    // horizontal grid lines
    for(let j=0;j<=yTicks;j++){
      const v = yMin + (yMax-yMin)*j/yTicks;
      const yp = Y(v);
      ctx.beginPath();
      ctx.moveTo(plot.x, yp);
      ctx.lineTo(plot.x + plot.w, yp);
      ctx.stroke();
    }
  }

  // Axes border
  ctx.strokeStyle = 'rgba(255,255,255,.20)';
  ctx.lineWidth = 1;
  ctx.strokeRect(plot.x, plot.y, plot.w, plot.h);

  // Tick labels
  ctx.fillStyle = muted;
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  for(let i=0;i<=ticks;i++){
    const u = xMin + (xMax-xMin)*i/ticks;
    const xp = X(u);
    const s = formatNum(u, 3);
    ctx.fillText(s, xp, plot.y + plot.h + 6);
  }
  ctx.textAlign = 'right';
  ctx.textBaseline = 'middle';
  for(let j=0;j<=yTicks;j++){
    const v = yMin + (yMax-yMin)*j/yTicks;
    const yp = Y(v);
    const s = formatNum(v, 3);
    ctx.fillText(s, plot.x - 6, yp);
  }

  // Axis labels
  ctx.fillStyle = fg;
  ctx.font = '600 12px ui-sans-serif, system-ui';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillText(xLabel, plot.x + plot.w/2, plot.y + plot.h + 26);

  ctx.save();
  ctx.translate(plot.x - 42, plot.y + plot.h/2);
  ctx.rotate(-Math.PI/2);
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillText(yLabel, 0, 0);
  ctx.restore();

  ctx.restore();
  return {plot, X, Y};
}

function drawLine(ctx, X, Y, xs, ys, style){
  ctx.save();
  ctx.strokeStyle = style?.stroke || 'rgba(120,166,255,.95)';
  ctx.lineWidth = style?.lineWidth || 2;
  ctx.beginPath();
  for(let i=0;i<xs.length;i++){
    const xp = X(xs[i]), yp = Y(ys[i]);
    if(i===0) ctx.moveTo(xp, yp);
    else ctx.lineTo(xp, yp);
  }
  ctx.stroke();
  ctx.restore();
}

function drawMarker(ctx, x, y, style){
  ctx.save();
  ctx.fillStyle = style?.fill || 'rgba(125,255,207,.95)';
  ctx.strokeStyle = style?.stroke || 'rgba(0,0,0,.35)';
  ctx.lineWidth = style?.lineWidth || 1;
  const r = style?.r || 5;
  ctx.beginPath();
  ctx.arc(x, y, r, 0, Math.PI*2);
  ctx.fill();
  ctx.stroke();
  ctx.restore();
}

function drawLegend(ctx, items, x, y){
  ctx.save();
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.textAlign = 'left';
  ctx.textBaseline = 'middle';
  let yy = y;
  items.forEach(it=>{
    ctx.strokeStyle = it.color;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(x, yy);
    ctx.lineTo(x+18, yy);
    ctx.stroke();
    ctx.fillStyle = 'rgba(255,255,255,.75)';
    ctx.fillText(it.label, x+26, yy);
    yy += 16;
  });
  ctx.restore();
}

/* ===========================
   Physics model
   =========================== */
function computeIofZ(z, lambda, r, I2, phi){
  // I1 = r I2
  const I1 = r * I2;
  const k = 2*Math.PI / lambda;
  return I1 + I2 + 2*Math.sqrt(I1*I2) * Math.cos(2*k*z + phi);
}
function computeExtrema(r, I2){
  const I1 = r*I2;
  const s1 = Math.sqrt(I1), s2 = Math.sqrt(I2);
  return {
    Imax: (s1 + s2)*(s1 + s2),
    Imin: (s1 - s2)*(s1 - s2)
  };
}
function computeVisibility(r){
  if(r<=0) return 0;
  return 2*Math.sqrt(r)/(1+r);
}

/* ===========================
   Canvases
   =========================== */
const canv = {
  diagram: document.getElementById('cDiagram'),
  main: document.getElementById('cMain'),
  sweep: document.getElementById('cSweep')
};

const UI = {
  rSlider: document.getElementById('rSlider'),
  lambdaSlider: document.getElementById('lambdaSlider'),
  phiSlider: document.getElementById('phiSlider'),
  zSpanSel: document.getElementById('zSpanSel'),
  rVal: document.getElementById('rVal'),
  lambdaVal: document.getElementById('lambdaVal'),
  phiVal: document.getElementById('phiVal'),
  zSpanVal: document.getElementById('zSpanVal'),
  kpiImax: document.getElementById('kpiImax'),
  kpiImin: document.getElementById('kpiImin'),
  kpiV: document.getElementById('kpiV'),
  kpiPeriod: document.getElementById('kpiPeriod'),
  btnEqual: document.getElementById('btnEqual'),
  btnFlip: document.getElementById('btnFlip')
};

const state = {
  I2: 1.0,       // example baseline intensity
  r: 1.0,
  lambda: 1.0,
  phi: 0.0,
  zSpanInLambda: 3
};

function getThemeColors(){
  // sample current computed colors via CSS variables
  const cs = getComputedStyle(document.documentElement);
  // fallback for canvas text/grid in both schemes
  const isLight = cs.getPropertyValue('--bg').trim().toLowerCase() === '#f6f7fb';
  return {
    fg: isLight ? 'rgba(16,20,38,.92)' : 'rgba(255,255,255,.90)',
    muted: isLight ? 'rgba(16,20,38,.55)' : 'rgba(255,255,255,.55)',
    grid: isLight ? 'rgba(16,20,38,.10)' : 'rgba(255,255,255,.10)',
    curve: isLight ? 'rgba(60,110,255,.95)' : 'rgba(120,166,255,.95)',
    accent2: isLight ? 'rgba(0,160,110,.95)' : 'rgba(125,255,207,.95)',
    warn: isLight ? 'rgba(180,120,0,.95)' : 'rgba(255,204,102,.95)',
    border: isLight ? 'rgba(16,20,38,.18)' : 'rgba(255,255,255,.18)',
    panelFade: isLight ? 'rgba(255,255,255,.65)' : 'rgba(0,0,0,.25)'
  };
}

function drawDiagram(){
  const {ctx, wCSS, hCSS} = setupHiDPICanvas(canv.diagram);
  const C = getThemeColors();
  ctx.clearRect(0,0,wCSS,hCSS);

  // Canvas margins
  const pad = 16;
  const x0 = pad, y0 = pad, w = wCSS - 2*pad, h = hCSS - 2*pad;

  // Soft panel
  ctx.fillStyle = C.panelFade;
  ctx.strokeStyle = C.border;
  ctx.lineWidth = 1;
  roundRect(ctx, x0, y0, w, h, 14, true, true);

  // Axis line (z)
  const midY = y0 + h*0.55;
  ctx.strokeStyle = C.fg;
  ctx.globalAlpha = 0.35;
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x0 + 18, midY);
  ctx.lineTo(x0 + w - 18, midY);
  ctx.stroke();
  ctx.globalAlpha = 1;

  // z arrow
  arrow(ctx, x0 + 18, midY, x0 + w - 10, midY, C.fg, 2);
  ctx.fillStyle = C.fg;
  ctx.font = '600 13px ui-sans-serif, system-ui';
  ctx.fillText('z', x0 + w - 22, midY - 10);

  // Two wave arrows
  const yTop = y0 + h*0.28;
  const yBot = y0 + h*0.80;

  // Wave 1 (+z)
  arrow(ctx, x0 + 34, yTop, x0 + w - 34, yTop, C.curve, 3);
  ctx.fillStyle = C.curve;
  ctx.font = '600 12px ui-monospace, SFMono-Regular, Menlo';
  ctx.fillText('Wave 1: +z   (I1)', x0 + 36, yTop - 18);

  // Wave 2 (-z)
  arrow(ctx, x0 + w - 34, yBot, x0 + 34, yBot, C.accent2, 3);
  ctx.fillStyle = C.accent2;
  ctx.font = '600 12px ui-monospace, SFMono-Regular, Menlo';
  ctx.fillText('Wave 2: −z   (I2)', x0 + 36, yBot - 18);

  // Standing-wave label
  ctx.fillStyle = C.fg;
  ctx.font = '600 13px ui-sans-serif, system-ui';
  ctx.fillText('Superposition → stationary intensity fringes (nodes/antinodes)', x0 + 18, y0 + 18);

  // Show a small sinusoidal "envelope" along midline as a hint
  const n = 240;
  const xs = [];
  const ys = [];
  for(let i=0;i<n;i++){
    const t = i/(n-1);
    const x = x0 + 18 + t*(w-36);
    const z = t*state.zSpanInLambda*state.lambda;
    const I = computeIofZ(z, state.lambda, state.r, state.I2, state.phi);
    const ext = computeExtrema(state.r, state.I2);
    const Imin = ext.Imin, Imax = ext.Imax;
    const norm = (I - Imin) / Math.max(1e-9,(Imax - Imin));
    const amp = 18 + 26*norm;
    const y = midY - amp*Math.sin(2*Math.PI*2*t);
    xs.push(x); ys.push(y);
  }
  ctx.strokeStyle = 'rgba(255,255,255,.18)';
  if(C.fg.startsWith('rgba(16')) ctx.strokeStyle = 'rgba(16,20,38,.20)';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(xs[0], ys[0]);
  for(let i=1;i<n;i++) ctx.lineTo(xs[i], ys[i]);
  ctx.stroke();

  // Node/antinode labels
  ctx.fillStyle = C.muted;
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.fillText('antinodes', x0 + w*0.18, midY + 28);
  ctx.fillText('nodes', x0 + w*0.52, midY + 28);
}

function drawMainPlot(){
  const {ctx, wCSS, hCSS} = setupHiDPICanvas(canv.main);
  const C = getThemeColors();
  ctx.clearRect(0,0,wCSS,hCSS);

  const margin = {l:64, r:18, t:34, b:56};
  const plotBox = {
    x: margin.l,
    y: margin.t,
    w: wCSS - margin.l - margin.r,
    h: hCSS - margin.t - margin.b
  };

  const zMax = state.zSpanInLambda * state.lambda;
  // sample points
  const N = 800;
  const xs = new Array(N);
  const ys = new Array(N);

  let yMin = Infinity, yMax = -Infinity;
  for(let i=0;i<N;i++){
    const z = zMax * i/(N-1);
    const I = computeIofZ(z, state.lambda, state.r, state.I2, state.phi);
    xs[i] = z; ys[i] = I;
    if(I < yMin) yMin = I;
    if(I > yMax) yMax = I;
  }
  // pad y range
  const padY = 0.08*(yMax - yMin || 1);
  yMin -= padY; yMax += padY;

  const ax = drawAxes(ctx, plotBox, 0, zMax, yMin, yMax, {
    title: 'Time-averaged intensity pattern',
    xLabel: 'z (example length units)',
    yLabel: 'I(z) (example intensity units)',
    fg: C.fg, muted: C.muted, gridCol: C.grid,
    ticks: 6, yTicks: 5, grid: true
  });

  drawLine(ctx, ax.X, ax.Y, xs, ys, {stroke: C.curve, lineWidth: 2.5});

  // Reference lines at Imax, Imin
  const ext = computeExtrema(state.r, state.I2);
  const Imax = ext.Imax, Imin = ext.Imin;

  ctx.save();
  ctx.setLineDash([6,5]);
  ctx.strokeStyle = C.accent2;
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(ax.plot.x, ax.Y(Imax));
  ctx.lineTo(ax.plot.x + ax.plot.w, ax.Y(Imax));
  ctx.stroke();

  ctx.strokeStyle = C.warn;
  ctx.beginPath();
  ctx.moveTo(ax.plot.x, ax.Y(Imin));
  ctx.lineTo(ax.plot.x + ax.plot.w, ax.Y(Imin));
  ctx.stroke();
  ctx.restore();

  drawLegend(ctx, [
    {label:'I(z)', color: C.curve},
    {label:'Imax', color: C.accent2},
    {label:'Imin', color: C.warn}
  ], ax.plot.x + 10, ax.plot.y + 14);
}

function drawSweepPlot(){
  const {ctx, wCSS, hCSS} = setupHiDPICanvas(canv.sweep);
  const C = getThemeColors();
  ctx.clearRect(0,0,wCSS,hCSS);

  const margin = {l:70, r:18, t:34, b:56};
  const plotBox = {
    x: margin.l,
    y: margin.t,
    w: wCSS - margin.l - margin.r,
    h: hCSS - margin.t - margin.b
  };

  const rMin = 0.001;
  const rMax = 5.0;
  const N = 600;
  const xs = new Array(N);
  const ys = new Array(N);
  let yMin = 0, yMax = 1.05;
  for(let i=0;i<N;i++){
    const r = rMin + (rMax - rMin) * i/(N-1);
    xs[i] = r;
    ys[i] = computeVisibility(r);
  }

  const ax = drawAxes(ctx, plotBox, 0, rMax, 0, 1.05, {
    title: 'Visibility vs intensity ratio',
    xLabel: 'r = I1/I2 (dimensionless)',
    yLabel: 'V (dimensionless)',
    fg: C.fg, muted: C.muted, gridCol: C.grid,
    ticks: 5, yTicks: 5, grid: true
  });

  drawLine(ctx, ax.X, ax.Y, xs, ys, {stroke: C.curve, lineWidth: 2.5});

  // highlight current r
  const r = clamp(state.r, 0, rMax);
  const v = computeVisibility(Math.max(r, 1e-9));
  drawMarker(ctx, ax.X(r), ax.Y(v), {fill: C.accent2, stroke: 'rgba(0,0,0,.25)', r: 6});

  // draw vertical line at r=1
  ctx.save();
  ctx.setLineDash([5,5]);
  ctx.strokeStyle = 'rgba(255,255,255,.25)';
  if(C.fg.startsWith('rgba(16')) ctx.strokeStyle = 'rgba(16,20,38,.25)';
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.moveTo(ax.X(1), ax.plot.y);
  ctx.lineTo(ax.X(1), ax.plot.y + ax.plot.h);
  ctx.stroke();
  ctx.restore();

  // annotation
  ctx.save();
  ctx.fillStyle = C.muted;
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.textAlign = 'left';
  ctx.textBaseline = 'top';
  ctx.fillText('Peak at r = 1 → V = 1', ax.X(1) + 8, ax.plot.y + 8);
  ctx.restore();
}

/* Rounded rect + arrow helpers */
function roundRect(ctx, x, y, w, h, r, fill, stroke){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

function arrow(ctx, x1, y1, x2, y2, color, width){
  const head = 10;
  const dx = x2-x1, dy = y2-y1;
  const L = Math.hypot(dx,dy) || 1;
  const ux = dx/L, uy = dy/L;
  const hx = x2 - ux*head, hy = y2 - uy*head;
  const px = -uy, py = ux;

  ctx.save();
  ctx.strokeStyle = color;
  ctx.fillStyle = color;
  ctx.lineWidth = width;
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(hx,hy);
  ctx.stroke();

  ctx.beginPath();
  ctx.moveTo(x2,y2);
  ctx.lineTo(hx + px*(head*0.55), hy + py*(head*0.55));
  ctx.lineTo(hx - px*(head*0.55), hy - py*(head*0.55));
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

/* ===========================
   UI update + render loop
   =========================== */
function updateDerived(){
  const ext = computeExtrema(state.r, state.I2);
  const V = computeVisibility(state.r);
  UI.kpiImax.textContent = formatNum(ext.Imax, 6);
  UI.kpiImin.textContent = formatNum(ext.Imin, 6);
  UI.kpiV.textContent = formatNum(V, 6);

  // For I(z)=...cos(2kz+phi), period is λ/2
  UI.kpiPeriod.textContent = formatNum(state.lambda/2, 6) + ' (same units as λ)';

  UI.rVal.textContent = formatNum(state.r, 4);
  UI.lambdaVal.textContent = formatNum(state.lambda, 4);
  UI.phiVal.textContent = formatNum(state.phi, 4);
  UI.zSpanVal.textContent = '0 to ' + state.zSpanInLambda + 'λ';
}

function renderAll(){
  updateDerived();
  drawDiagram();
  drawMainPlot();
  drawSweepPlot();
}

function readUI(){
  state.r = parseFloat(UI.rSlider.value);
  state.lambda = parseFloat(UI.lambdaSlider.value);
  state.phi = parseFloat(UI.phiSlider.value);
  state.zSpanInLambda = parseInt(UI.zSpanSel.value, 10) || 3;
}

['input','change'].forEach(ev=>{
  UI.rSlider.addEventListener(ev, ()=>{ readUI(); renderAll(); });
  UI.lambdaSlider.addEventListener(ev, ()=>{ readUI(); renderAll(); });
  UI.phiSlider.addEventListener(ev, ()=>{ readUI(); renderAll(); });
  UI.zSpanSel.addEventListener(ev, ()=>{ readUI(); renderAll(); });
});

UI.btnEqual.addEventListener('click', ()=>{
  UI.rSlider.value = '1.00';
  readUI(); renderAll();
});
UI.btnFlip.addEventListener('click', ()=>{
  const r = parseFloat(UI.rSlider.value);
  const rr = (r<=0) ? 5 : 1/r;
  UI.rSlider.value = String(clamp(rr, 0, 5));
  readUI(); renderAll();
});

/* Responsive resizing */
(function(){
  const ro = new ResizeObserver(()=>renderAll());
  ro.observe(canv.diagram.parentElement);
  ro.observe(canv.main.parentElement);
  ro.observe(canv.sweep.parentElement);
  window.addEventListener('resize', ()=>renderAll(), {passive:true});
})();

/* Initial draw */
readUI();
renderAll();
</script>
</body>
</html>
