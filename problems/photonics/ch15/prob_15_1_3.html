<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Laser Amplifier Gain & Population Difference (Nd:glass)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0f1730;
      --text:#e8ecff;
      --muted:#b9c2ff;
      --faint:rgba(232,236,255,.08);
      --faint2:rgba(232,236,255,.14);
      --accent:#7aa7ff;
      --accent2:#7dffcf;
      --warn:#ffd37a;
      --ok:#9dff7a;
      --bad:#ff7aa2;
      --shadow: 0 18px 50px rgba(0,0,0,.35);
      --radius:18px;
      --radius2:14px;
      --maxw: 1120px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 18% 10%, rgba(122,167,255,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 25%, rgba(125,255,207,.14), transparent 55%),
        radial-gradient(900px 700px at 50% 110%, rgba(255,122,162,.08), transparent 60%),
        var(--bg);
      line-height:1.55;
    }
    header{
      padding:32px 18px 18px;
      position:relative;
    }
    .wrap{
      width:min(var(--maxw), calc(100% - 32px));
      margin:0 auto;
    }
    .hero{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:stretch;
    }
    @media (max-width: 900px){
      .hero{grid-template-columns:1fr}
    }
    .titleCard{
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--faint);
      border-radius:var(--radius);
      padding:22px 22px 16px;
      box-shadow:var(--shadow);
      overflow:hidden;
      position:relative;
    }
    .titleCard:before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(600px 220px at 18% 10%, rgba(122,167,255,.20), transparent 60%),
        radial-gradient(500px 260px at 80% 30%, rgba(125,255,207,.14), transparent 60%);
      filter: blur(0px);
      pointer-events:none;
      opacity:.9;
    }
    .titleCard > *{position:relative}
    h1{
      margin:0 0 10px;
      font-size: clamp(22px, 2.6vw, 34px);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:14.8px;
    }
    .metaGrid{
      display:grid;
      grid-template-columns:1fr 1fr;
      gap:10px;
      margin-top:14px;
    }
    .pill{
      background:rgba(255,255,255,.05);
      border:1px solid var(--faint);
      border-radius:999px;
      padding:8px 10px;
      font-size:12.5px;
      color:var(--muted);
      display:flex;
      gap:8px;
      align-items:center;
      justify-content:space-between;
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }
    .pill b{color:var(--text); font-weight:650}
    .sideCard{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--faint);
      border-radius:var(--radius);
      padding:16px;
      box-shadow:var(--shadow);
    }

    main{
      padding:10px 18px 48px;
    }

    /* Layout: sticky TOC */
    .layout{
      display:grid;
      grid-template-columns: 290px 1fr;
      gap:18px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns:1fr}
    }
    nav.toc{
      position: sticky;
      top:14px;
      align-self:start;
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--faint);
      border-radius:var(--radius);
      padding:14px 14px 10px;
      box-shadow:var(--shadow);
    }
    @media (max-width: 980px){
      nav.toc{position:relative; top:0}
    }
    .toc h2{
      margin:0 0 8px;
      font-size:13px;
      letter-spacing:.14em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .toc a{
      display:block;
      padding:8px 10px;
      border-radius:10px;
      color:var(--text);
      text-decoration:none;
      border:1px solid transparent;
      font-size:13.5px;
      opacity:.92;
    }
    .toc a:hover{
      border-color:var(--faint2);
      background:rgba(255,255,255,.04);
      opacity:1;
      transform: translateX(2px);
      transition: transform .12s ease, background .12s ease, border-color .12s ease, opacity .12s ease;
    }

    section{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--faint);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px 16px;
      margin-bottom:18px;
      overflow:hidden;
    }
    section h2{
      margin:0 0 10px;
      font-size:18.5px;
    }
    section h3{
      margin:14px 0 8px;
      font-size:15.5px;
      color:var(--text);
    }
    p{margin:10px 0; color:rgba(232,236,255,.92)}
    ul{margin:10px 0 10px 20px; color:rgba(232,236,255,.92)}
    li{margin:6px 0}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 860px){
      .grid2{grid-template-columns:1fr}
    }
    .callout{
      border-radius:var(--radius2);
      border:1px solid var(--faint2);
      background:rgba(0,0,0,.14);
      padding:12px 12px 10px;
    }
    .callout h4{
      margin:0 0 6px;
      font-size:13px;
      letter-spacing:.12em;
      text-transform:uppercase;
      color:var(--muted);
    }
    .keyEq{
      border-left: 3px solid var(--accent);
    }
    .assump{
      border-left: 3px solid var(--warn);
    }
    .mistakes{
      border-left: 3px solid var(--bad);
    }
    .final{
      border-left: 3px solid var(--ok);
    }
    .eq{
      display:inline-block;
      font-family:var(--mono);
      padding:2px 6px;
      border-radius:10px;
      background:rgba(255,255,255,.06);
      border:1px solid var(--faint);
      color:rgba(232,236,255,.95);
      white-space:nowrap;
    }
    .eqBlock{
      font-family:var(--mono);
      font-size:13.3px;
      line-height:1.55;
      padding:10px 10px;
      border-radius:14px;
      background:rgba(255,255,255,.05);
      border:1px solid var(--faint);
      overflow:auto;
      position:relative;
    }
    .copyRow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
      margin-top:10px;
    }
    button.copy{
      cursor:pointer;
      border-radius:12px;
      border:1px solid var(--faint2);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      font-size:12.8px;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    button.copy:hover{
      transform: translateY(-1px);
      background:rgba(255,255,255,.08);
      border-color:rgba(122,167,255,.35);
    }
    .miniNote{
      font-size:12.6px;
      color:rgba(185,194,255,.92);
    }

    /* Visualization */
    .vizGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
      margin-top:8px;
    }
    @media (max-width: 900px){
      .vizGrid{grid-template-columns:1fr}
    }
    figure{
      margin:0;
      padding:0;
    }
    .canvasCard{
      border-radius:var(--radius2);
      border:1px solid var(--faint2);
      background:rgba(0,0,0,.14);
      overflow:hidden;
      display:flex;
      flex-direction:column;
      min-height:310px;
    }
    .canvasHeader{
      padding:10px 12px;
      border-bottom:1px solid var(--faint);
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
    }
    .canvasHeader .t{
      font-size:13.5px;
      color:var(--text);
      font-weight:650;
    }
    .canvasHeader .s{
      font-size:12.4px;
      color:var(--muted);
      white-space:nowrap;
    }
    canvas{
      width:100%;
      height:280px;
      display:block;
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    @media (max-width: 900px){
      .controls{grid-template-columns:1fr}
    }
    .ctrl{
      border-radius:var(--radius2);
      border:1px solid var(--faint2);
      background:rgba(0,0,0,.14);
      padding:10px 12px;
    }
    .ctrl label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:12.7px;
      color:var(--muted);
      margin-bottom:6px;
    }
    .ctrl input[type="range"]{width:100%}
    .ctrl select{
      width:100%;
      border-radius:12px;
      border:1px solid var(--faint2);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:8px 10px;
      font-size:13px;
      outline:none;
    }

    footer{
      padding:18px;
      color:rgba(185,194,255,.9);
      text-align:center;
      font-size:12.8px;
    }

    /* Print friendly */
    @media print{
      body{background:#fff; color:#000}
      section, nav.toc, .titleCard, .sideCard{box-shadow:none}
      nav.toc{display:none}
      .eq, .eqBlock{border:1px solid #ddd; background:#f7f7f7; color:#000}
      .callout{background:#fafafa; border-color:#ddd}
      button.copy{display:none}
      canvas{display:none}
      .canvasHeader{display:none}
      .canvasCard{min-height:auto}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap hero">
    <div class="titleCard">
      <h1>Laser Amplifier Gain &amp; Required Population Difference (Nd:glass at 1.06&nbsp;&micro;m)</h1>
      <p class="subtitle">
        We connect measurable amplifier gain to the microscopic stimulated-emission cross section to find the inversion (population difference) density needed inside a doped glass rod.
      </p>
      <div class="metaGrid">
        <div class="pill"><span>Medium</span><b>Nd<sup>3+</sup>:glass (phosphate)</b></div>
        <div class="pill"><span>Wavelength</span><b>&lambda;<sub>0</sub> &approx; 1.06&nbsp;&micro;m</b></div>
        <div class="pill"><span>Rod length</span><b>L = 15&nbsp;cm</b></div>
        <div class="pill"><span>Total gain</span><b>G = 10</b></div>
      </div>
    </div>

    <div class="sideCard">
      <div class="callout keyEq">
        <h4>Key equation</h4>
        <div class="eqBlock" id="eq_key">G = exp(g0 L),   g0 = σ · ΔN   ⟹   ΔN = (ln G)/(σ L)</div>
        <div class="copyRow">
          <button class="copy" data-copy="G = exp(g0 L),   g0 = σ · ΔN   =>   ΔN = (ln G)/(σ L)">Copy equation</button>
        </div>
      </div>
      <p class="miniNote" style="margin-top:10px">
        Here <span class="eq">ΔN</span> is the population difference (upper minus lower laser level) per cm<sup>3</sup>.
      </p>
    </div>
  </div>
</header>

<main>
  <div class="wrap layout">
    <nav class="toc" aria-label="Table of contents">
      <h2>Contents</h2>
      <a href="#quick">Quick Summary</a>
      <a href="#part0">PART 0 — Concept Primer</a>
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a href="#part2">PART 2 — Strategy &amp; Tips</a>
      <a href="#part3">PART 3 — Full Solution</a>
      <a href="#part4">PART 4 — Deeper Understanding</a>
      <a href="#part5">PART 5 — Visualization Guide</a>
    </nav>

    <article>
      <section id="quick">
        <h2>Quick Summary</h2>
        <ul>
          <li><b>What this is:</b> A 15&nbsp;cm Nd<sup>3+</sup>:glass rod acts as a <b>small-signal laser amplifier</b> with total gain <span class="eq">G = 10</span> at <span class="eq">&lambda; = 1.06&nbsp;&micro;m</span>.</li>
          <li><b>Key physics idea:</b> In the small-signal regime, intensity grows exponentially: <span class="eq">I(z)=I(0)e^{g_0 z}</span>.</li>
          <li><b>Governing link (microscopic → macroscopic):</b> The gain coefficient is set by stimulated emission: <span class="eq">g_0 = \u03C3 \u0394N</span> (when emission and absorption cross sections are treated equally at the line).</li>
          <li><b>Master equation:</b> <span class="eq">\u0394N = (ln G)/(\u03C3 L)</span>.</li>
          <li><b>Data used:</b> From the table for Nd<sup>3+</sup>:glass (phosphate): <span class="eq">\u03C3 \u2248 4\u00D710\u221220 cm^2</span> near 1.06&nbsp;&micro;m.</li>
          <li><b>Final result type:</b> Numeric inversion density in <span class="eq">cm^{-3}</span>.</li>
        </ul>
      </section>

      <section id="part0">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <div class="grid2">
          <div class="callout">
            <h4>Core definitions (symbols &amp; units)</h4>
            <ul>
              <li><span class="eq">I(z)</span>: optical intensity (W/m<sup>2</sup> or W/cm<sup>2</sup>).</li>
              <li><span class="eq">g_0</span>: small-signal gain coefficient (cm<sup>&minus;1</sup>).</li>
              <li><span class="eq">G</span>: total (single-pass) intensity gain, dimensionless.</li>
              <li><span class="eq">\u03C3</span>: stimulated-emission (effective) cross section (cm<sup>2</sup>).</li>
              <li><span class="eq">\u0394N = N_2 - N_1</span>: population difference / inversion density (cm<sup>&minus;3</sup>).</li>
              <li><span class="eq">L</span>: amplifier length (cm).</li>
            </ul>
          </div>

          <div class="callout">
            <h4>Physical meaning</h4>
            <p>
              Think of <span class="eq">\u03C3</span> as an effective “target area” that quantifies how strongly one excited ion can
              stimulate emission into the passing light field. If there are more ions in the upper laser level than in the
              lower one (positive <span class="eq">\u0394N</span>), the medium provides net gain.
            </p>
            <p>
              The macroscopic exponential gain arises because each tiny slice of length <span class="eq">dz</span> multiplies the intensity
              by <span class="eq">1 + g_0 dz</span>, and multiplying many slices becomes an exponential.
            </p>
          </div>
        </div>

        <h3>Key principles &amp; validity</h3>
        <ul>
          <li><b>Small-signal approximation:</b> the signal is weak enough that it does <b>not</b> noticeably deplete the inversion (no saturation).</li>
          <li><b>Beer–Lambert–type growth:</b> <span class="eq">dI/dz = g_0 I</span> for net gain (or <span class="eq">dI/dz = -\alpha I</span> for loss).</li>
          <li><b>Homogeneous medium &amp; constant inversion:</b> assume <span class="eq">\u03C3</span> and <span class="eq">\u0394N</span> are uniform along the rod.</li>
        </ul>

        <div class="callout keyEq">
          <h4>Common model used in amplifiers</h4>
          <div class="eqBlock" id="eq_model">
dI/dz = (σ_e N2 - σ_a N1) I  ≈  σ (N2 - N1) I  = σ ΔN I
⇒ I(L)/I(0) = exp(σ ΔN L) = G
          </div>
          <div class="copyRow">
            <button class="copy" data-copy="dI/dz = (σe N2 - σa N1) I ≈ σ (N2 - N1) I = σ ΔN I;  G = exp(σ ΔN L)">Copy model</button>
          </div>
        </div>

        <h3>Mini intuition examples</h3>
        <ul>
          <li>If <span class="eq">\u0394N = 0</span>, then <span class="eq">g_0 = 0</span> and <span class="eq">G = 1</span>: no amplification.</li>
          <li>Doubling the length <span class="eq">L</span> (while keeping <span class="eq">\u03C3</span> and <span class="eq">\u0394N</span> fixed) squares the gain in exponent form: <span class="eq">G \to G^2</span> because <span class="eq">ln G ∝ L</span>.</li>
        </ul>

        <div class="callout mistakes">
          <h4>What to watch for (pitfalls)</h4>
          <ul>
            <li><b>Confusing gain coefficient and total gain:</b> <span class="eq">g_0</span> has units; <span class="eq">G</span> is dimensionless.</li>
            <li><b>Mixing log bases:</b> physics uses natural log in exponentials: <span class="eq">G = e^{g_0 L}</span> so use <span class="eq">ln</span>, not <span class="eq">log10</span>.</li>
            <li><b>Unit consistency:</b> if <span class="eq">\u03C3</span> is in cm<sup>2</sup> and <span class="eq">L</span> in cm, then <span class="eq">\u0394N</span> comes out in cm<sup>&minus;3</sup>.</li>
            <li><b>Hidden assumption:</b> using <span class="eq">g_0 = \u03C3 \u0394N</span> assumes an effective cross section at the operating wavelength (near line center) and a simple inversion picture.</li>
          </ul>
        </div>
      </section>

      <section id="part1">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <h3>Problem restatement (in plain words)</h3>
        <p>
          A Nd<sup>3+</sup>:glass rod of length 15&nbsp;cm is used as a laser amplifier. At wavelength
          <span class="eq">\u03BB = 1.06&nbsp;\u03BCm</span>, the measured <b>small-signal</b> total gain is <span class="eq">G = 10</span>.
          Using the stimulated-emission cross-section for Nd:glass from the given table, find the
          <b>population difference</b> (inversion density) <span class="eq">\u0394N</span> required to achieve that gain.
        </p>

        <div class="grid2">
          <div class="callout">
            <h4>Given</h4>
            <ul>
              <li><span class="eq">L = 15&nbsp;cm</span></li>
              <li><span class="eq">\u03BB \approx 1.06&nbsp;\u03BCm</span></li>
              <li><span class="eq">G = 10</span> (small-signal)</li>
              <li>From table (Nd<sup>3+</sup>:glass, phosphate): <span class="eq">\u03C3 \approx 4 \u00D7 10^{-20}\;cm^2</span> near 1.06&nbsp;\u03BCm</li>
            </ul>
          </div>

          <div class="callout">
            <h4>Unknown</h4>
            <ul>
              <li><span class="eq">\u0394N = N_2 - N_1</span> in <span class="eq">cm^{-3}</span></li>
            </ul>
            <h4 style="margin-top:10px">What must be found</h4>
            <p>The inversion density that makes the exponential gain equal to 10 over 15&nbsp;cm.</p>
          </div>
        </div>

        <h3>Relevant principles (and why)</h3>
        <ul>
          <li><b>Small-signal amplifier law:</b> The phrase “small-signal gain” tells us the inversion is essentially constant during amplification, so <span class="eq">dI/dz = g_0 I</span> applies.</li>
          <li><b>Microscopic gain:</b> Stimulated emission scales with cross section and inversion density, giving <span class="eq">g_0 \approx \u03C3 \u0394N</span>.</li>
          <li><b>Why not saturation models?</b> Saturation requires a strong signal and introduces intensity-dependent gain. The problem explicitly uses small-signal gain, so we avoid those complications.</li>
        </ul>

        <div class="callout assump">
          <h4>Assumptions (explicit)</h4>
          <ul>
            <li>Uniform inversion <span class="eq">\u0394N</span> along the rod (no spatial pumping variations in the model).</li>
            <li>Operation near the relevant transition peak so the listed <span class="eq">\u03C3</span> is an appropriate effective cross section.</li>
            <li>Effective “net” cross section approximated by a single value <span class="eq">\u03C3</span> so <span class="eq">g_0 = \u03C3 \u0394N</span>.</li>
            <li>Losses (scattering/host absorption) are neglected or already folded into the stated gain.</li>
          </ul>
        </div>

        <h3>Possible approaches (compare)</h3>
        <ul>
          <li><b>Approach A (best):</b> Use <span class="eq">G = e^{g_0 L}</span> and <span class="eq">g_0=\u03C3 \u0394N</span> → direct solve. <b>Fast</b>, minimal assumptions beyond small-signal.</li>
          <li><b>Approach B:</b> Use decibel gain <span class="eq">G_{dB}=10\log_{10}G</span> then convert back to <span class="eq">g_0</span>. Works, but adds an unnecessary conversion step.</li>
          <li><b>Approach C:</b> Build a rate-equation pump model to compute <span class="eq">N_2</span> from pump power. Not needed because the problem asks only for the inversion required, not how to pump it.</li>
        </ul>
        <p><b>We choose Approach A</b> because it uses exactly the provided gain, length, and cross section with the fewest extra assumptions.</p>
      </section>

      <section id="part2">
        <h2>PART 2 — Strategy &amp; Tips (Roadmap Only)</h2>
        <ol>
          <li><b>Translate “total gain” into a gain coefficient</b>: use <span class="eq">G = e^{g_0 L}</span>. <br><span class="miniNote">Meaning: the rod multiplies intensity by a factor G after length L.</span></li>
          <li><b>Solve for <span class="eq">g_0</span></b>: compute <span class="eq">g_0 = (\ln G)/L</span>. <br><span class="miniNote">Meaning: average exponential growth rate per cm.</span></li>
          <li><b>Relate <span class="eq">g_0</span> to inversion</b>: use <span class="eq">g_0 = \u03C3 \u0394N</span>. <br><span class="miniNote">Meaning: more inverted ions per volume gives larger gain.</span></li>
          <li><b>Solve for <span class="eq">\u0394N</span></b>: <span class="eq">\u0394N = (\ln G)/(\u03C3 L)</span>. <br><span class="miniNote">Meaning: the required population difference density.</span></li>
          <li><b>Check units</b>: cm<sup>&minus;1</sup> divided by cm<sup>2</sup> gives cm<sup>&minus;3</sup>. <br><span class="miniNote">Meaning: your result is a density.</span></li>
        </ol>

        <div class="callout mistakes">
          <h4>Common mistakes &amp; quick tips</h4>
          <ul>
            <li>Use <span class="eq">ln</span>, not <span class="eq">log10</span>, because the gain law is exponential in base <span class="eq">e</span>.</li>
            <li>Keep <span class="eq">\u03C3</span> in <b>cm<sup>2</sup></b> if <span class="eq">L</span> is in <b>cm</b>. Don’t mix meters and centimeters midstream.</li>
            <li>Be clear that this is a <b>population difference</b> (inversion), not total dopant concentration.</li>
          </ul>
        </div>
      </section>

      <section id="part3">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Physical intuition (before math)</h3>
        <p>
          A gain of 10 over 15&nbsp;cm means the light is multiplied by ten in one pass. Exponential growth implies that the
          gain per centimeter is modest (not 10 per cm!), because the multiplication is spread over the whole length.
          Once we know the per-length gain <span class="eq">g_0</span>, the inversion density follows by dividing by the microscopic
          interaction strength <span class="eq">\u03C3</span>.
        </p>

        <h3>Step 1 — Write the small-signal gain law</h3>
        <p>For a uniform small-signal gain coefficient <span class="eq">g_0</span> (cm<sup>&minus;1</sup>):</p>
        <div class="eqBlock" id="eq1">dI/dz = g0 I  ⟹  I(L) = I(0) exp(g0 L)</div>
        <p>
          <b>What we did:</b> used the standard amplifier differential equation (same math as Beer–Lambert, but with a positive coefficient).
          <br><b>Why:</b> “small-signal” means the medium doesn’t change appreciably during amplification.
        </p>

        <h3>Step 2 — Express total gain and solve for <span class="eq">g_0</span></h3>
        <p>Total intensity gain is <span class="eq">G = I(L)/I(0)</span>, so:</p>
        <div class="eqBlock" id="eq2">G = exp(g0 L)  ⟹  g0 = (ln G)/L</div>
        <p>
          <b>Meaning:</b> <span class="eq">g_0</span> is the logarithmic gain per unit length: it tells how fast the exponential grows per cm.
        </p>

        <h3>Step 3 — Connect gain coefficient to population difference</h3>
        <p>
          In a simple inversion model at the operating wavelength, the net stimulated gain is proportional to the population
          difference <span class="eq">\u0394N = N_2 - N_1</span>:
        </p>
        <div class="eqBlock" id="eq3">g0 ≈ σ ΔN</div>
        <p>
          <b>What we did:</b> used the microscopic cross section model. <br>
          <b>Why it’s reasonable here:</b> the problem provides a single cross section value from a transitions table, signaling the intended
          “effective cross section” treatment.
        </p>

        <h3>Step 4 — Solve for <span class="eq">\u0394N</span> and plug numbers</h3>
        <p>Combine steps 2 and 3:</p>
        <div class="eqBlock" id="eq4">ΔN = (ln G)/(σ L)</div>

        <p>Insert the values:</p>
        <ul>
          <li><span class="eq">G = 10</span> ⇒ <span class="eq">ln G = ln(10) = 2.302585...</span></li>
          <li><span class="eq">L = 15 cm</span></li>
          <li>From the table for Nd<sup>3+</sup>:glass (phosphate) near 1.06&nbsp;&micro;m: <span class="eq">σ ≈ 4 × 10^-20 cm^2</span></li>
        </ul>

        <div class="eqBlock" id="eq5">
g0 = (ln 10)/15 cm = 2.302585 / 15  cm^-1 = 0.1535057 cm^-1

ΔN = g0/σ = (0.1535057 cm^-1) / (4×10^-20 cm^2)
   = 3.8376×10^18 cm^-3
        </div>

        <div class="callout final">
          <h4>Final answer</h4>
          <p style="margin:8px 0 6px">
            Required population difference (inversion density):
          </p>
          <div class="eqBlock" id="finalAns">ΔN ≈ 3.84 × 10^18  cm^-3</div>
          <div class="copyRow">
            <button class="copy" data-copy="ΔN ≈ 3.84 × 10^18 cm^-3">Copy final answer</button>
          </div>
        </div>

        <h3>Sanity checks</h3>
        <div class="grid2">
          <div class="callout">
            <h4>Units/dimensions</h4>
            <p>
              <span class="eq">ln G</span> is unitless. With <span class="eq">σ</span> in cm<sup>2</sup> and <span class="eq">L</span> in cm,
              <span class="eq">ΔN</span> has units:
              <span class="eq">1 / (cm^2·cm) = cm^-3</span>. ✔
            </p>
          </div>
          <div class="callout">
            <h4>Limiting cases &amp; sign</h4>
            <ul>
              <li>If <span class="eq">G→1</span>, then <span class="eq">ln G→0</span> so <span class="eq">ΔN→0</span>. ✔</li>
              <li>Larger <span class="eq">σ</span> means stronger interaction, so required <span class="eq">ΔN</span> decreases. ✔</li>
              <li>Because <span class="eq">G&gt;1</span>, <span class="eq">ln G&gt;0</span>, so <span class="eq">ΔN&gt;0</span> (true inversion). ✔</li>
            </ul>
          </div>
        </div>

        <p>
          <b>Connection to the diagram and plots:</b> The rod is modeled as a uniform gain medium. The plotted curves show how
          the required <span class="eq">\u0394N</span> scales linearly with <span class="eq">ln G</span> and inversely with length <span class="eq">L</span>,
          exactly as <span class="eq">\u0394N = (ln G)/(\u03C3 L)</span> predicts.
        </p>
      </section>

      <section id="part4">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpreting the final formula</h3>
        <p>
          The result
          <span class="eq">\u0394N = (ln G)/(\u03C3 L)</span>
          can be read as:
        </p>
        <ul>
          <li><b>\u0394N scales with “how much gain you want”</b> via <span class="eq">ln G</span> (doubling G does not double \u0394N; it adds in log-space).</li>
          <li><b>\u0394N decreases with length</b>: a longer rod needs less inversion density because the light interacts longer.</li>
          <li><b>\u0394N decreases with cross section</b>: a larger <span class="eq">\u03C3</span> means each excited ion is more effective at amplifying.</li>
        </ul>

        <h3>How parameter changes affect the outcome (tie to interactive plots)</h3>
        <ul>
          <li>If you slide <b>Gain G</b> upward, the required inversion rises roughly like <span class="eq">ln G</span> (slowly at first, faster at large G).</li>
          <li>If you increase <b>Length L</b>, the required inversion falls like <span class="eq">1/L</span>.</li>
          <li>If you switch the <b>Medium</b> (changing <span class="eq">\u03C3</span>), the entire curve rescales: higher <span class="eq">\u03C3</span> shifts required inversion downward.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p>
          Start from the photon flux equation: the stimulated emission rate per volume is proportional to
          <span class="eq">\u03C3 \u03A6 \u0394N</span> (where <span class="eq">\u03A6</span> is photon flux). Converting photon flux to intensity and
          relating emitted power in a slice <span class="eq">dz</span> to the increase in intensity reproduces
          <span class="eq">dI/dz = \u03C3 \u0394N I</span>.
        </p>

        <h3>Concept checks (with answers)</h3>
        <ul>
          <li><b>Q:</b> Why does the gain use <span class="eq">ln</span>? <b>A:</b> Because the solution of <span class="eq">dI/dz = gI</span> is <span class="eq">I \propto e^{gz}</span>, so solving for <span class="eq">g</span> requires a natural log.</li>
          <li><b>Q:</b> If you double the rod length at fixed inversion, what happens to <span class="eq">G</span>? <b>A:</b> <span class="eq">G \to e^{g(2L)} = (e^{gL})^2 = G^2</span>.</li>
          <li><b>Q:</b> Does this calculation tell you the pump power needed? <b>A:</b> No—only the inversion density required; pump requirements need rate equations, efficiencies, and losses.</li>
          <li><b>Q:</b> What breaks first if the input signal is large? <b>A:</b> Small-signal assumption: the inversion depletes and gain saturates (becomes intensity-dependent).</li>
        </ul>
      </section>

      <section id="part5">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <div class="vizGrid">
          <figure class="canvasCard">
            <div class="canvasHeader">
              <div class="t">Diagram: Nd:glass rod amplifier (small-signal model)</div>
              <div class="s">Geometry + symbols</div>
            </div>
            <canvas id="cDiagram" aria-label="Amplifier diagram canvas"></canvas>
          </figure>

          <figure class="canvasCard">
            <div class="canvasHeader">
              <div class="t">Main plot: Total gain G vs inversion density ΔN</div>
              <div class="s">Uses G = exp(σ ΔN L)</div>
            </div>
            <canvas id="cMain" aria-label="Main plot canvas"></canvas>
          </figure>

          <figure class="canvasCard">
            <div class="canvasHeader">
              <div class="t">Secondary plot: Required ΔN vs rod length L</div>
              <div class="s">Uses ΔN = (ln G)/(σ L)</div>
            </div>
            <canvas id="cSecondary" aria-label="Secondary plot canvas"></canvas>
          </figure>

          <div class="canvasCard" style="min-height:auto">
            <div class="canvasHeader">
              <div class="t">Interactive controls (updates all canvases)</div>
              <div class="s">Try changing gain / length / medium</div>
            </div>
            <div style="padding:12px">
              <div class="controls">
                <div class="ctrl">
                  <label>
                    <span>Target total gain <span class="eq">G</span></span>
                    <span id="vG" class="eq"></span>
                  </label>
                  <input id="sG" type="range" min="1.1" max="50" step="0.1" value="10"/>
                  <div class="miniNote">Raises <span class="eq">ln G</span> → increases required <span class="eq">\u0394N</span>.</div>
                </div>

                <div class="ctrl">
                  <label>
                    <span>Rod length <span class="eq">L</span> (cm)</span>
                    <span id="vL" class="eq"></span>
                  </label>
                  <input id="sL" type="range" min="2" max="30" step="0.1" value="15"/>
                  <div class="miniNote">Longer L → lower required <span class="eq">\u0394N</span> (inverse scaling).</div>
                </div>

                <div class="ctrl">
                  <label>
                    <span>Medium (sets <span class="eq">\u03C3</span>)</span>
                    <span id="vSigma" class="eq"></span>
                  </label>
                  <select id="selMed">
                    <option value="4e-20" selected>Nd3+:glass (phosphate) — σ = 4×10^-20 cm^2</option>
                    <option value="3e-19">Nd:YAG — σ = 3×10^-19 cm^2 (comparison)</option>
                  </select>
                  <div class="miniNote">Higher σ shifts curves down (needs less inversion).</div>
                </div>
              </div>

              <div class="callout final" style="margin-top:12px">
                <h4>Live computed result</h4>
                <div class="eqBlock" id="liveAns">ΔN = ...</div>
                <div class="copyRow">
                  <button class="copy" id="copyLive">Copy live answer</button>
                </div>
              </div>

              <p class="miniNote" style="margin:10px 0 0">
                <b>What each canvas shows:</b>
                The diagram labels <span class="eq">I(0)</span>, <span class="eq">I(L)</span>, <span class="eq">L</span>, and the gain law.
                The main plot shows how <span class="eq">G</span> grows exponentially with <span class="eq">\u0394N</span>.
                The secondary plot shows the required <span class="eq">\u0394N</span> dropping as <span class="eq">1/L</span>.
              </p>
            </div>
          </div>
        </div>
      </section>
    </article>
  </div>
</main>

<footer>
  Built as a self-contained learning article (vanilla HTML/CSS/JS). Copy buttons copy plain text.
</footer>

<script>
/* --------------------------
   Copy buttons
---------------------------*/
(function(){
  function copyText(t){
    if(!navigator.clipboard){
      const ta = document.createElement('textarea');
      ta.value = t;
      document.body.appendChild(ta);
      ta.select();
      document.execCommand('copy');
      document.body.removeChild(ta);
      return;
    }
    navigator.clipboard.writeText(t);
  }
  document.querySelectorAll('button.copy[data-copy]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      copyText(btn.getAttribute('data-copy'));
      btn.textContent = 'Copied!';
      setTimeout(()=>btn.textContent='Copy', 900);
      // restore original label if it wasn't "Copy"
      const original = btn.getAttribute('data-original');
      if(original){
        setTimeout(()=>btn.textContent=original, 950);
      }
    });
    if(!btn.getAttribute('data-original')){
      btn.setAttribute('data-original', btn.textContent);
    }
  });
  window.__copyText = copyText;
})();

/* --------------------------
   Math helpers
---------------------------*/
function ln(x){ return Math.log(x); }
function fmtSci(x, sig=3){
  if(!isFinite(x)) return "—";
  if(x === 0) return "0";
  const sign = x < 0 ? "-" : "";
  x = Math.abs(x);
  const exp = Math.floor(Math.log10(x));
  const m = x / Math.pow(10, exp);
  const mant = m.toFixed(Math.max(0, sig-1));
  return `${sign}${mant}×10^${exp}`;
}
function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

/* --------------------------
   High-DPI canvas setup
---------------------------*/
function setupCanvas(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(2, Math.floor(rect.width * dpr));
  const h = Math.max(2, Math.floor(rect.height * dpr));
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w;
    canvas.height = h;
  }
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  return {ctx, w: rect.width, h: rect.height, dpr};
}

/* --------------------------
   Plotting primitives
---------------------------*/
function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
  const {x, y, w, h} = box;
  // background
  ctx.save();
  ctx.fillStyle = 'rgba(255,255,255,0.00)';
  ctx.fillRect(x,y,w,h);

  // title
  ctx.fillStyle = 'rgba(232,236,255,0.92)';
  ctx.font = '600 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText(title, x+8, y+16);

  // plot area
  const padL = 52, padR = 16, padT = 28, padB = 42;
  const px = x + padL, py = y + padT;
  const pw = w - padL - padR, ph = h - padT - padB;

  // grid
  ctx.strokeStyle = 'rgba(232,236,255,0.10)';
  ctx.lineWidth = 1;
  const nGrid = 5;
  for(let i=0;i<=nGrid;i++){
    const gx = px + (pw*i/nGrid);
    const gy = py + (ph*i/nGrid);
    ctx.beginPath(); ctx.moveTo(gx, py); ctx.lineTo(gx, py+ph); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(px, gy); ctx.lineTo(px+pw, gy); ctx.stroke();
  }

  // axes
  ctx.strokeStyle = 'rgba(232,236,255,0.35)';
  ctx.lineWidth = 1.25;
  ctx.beginPath(); ctx.moveTo(px, py+ph); ctx.lineTo(px+pw, py+ph); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(px, py); ctx.lineTo(px, py+ph); ctx.stroke();

  // ticks & labels
  ctx.fillStyle = 'rgba(185,194,255,0.92)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace';

  function xToPx(xv){ return px + (xv - xMin)*pw/(xMax - xMin); }
  function yToPx(yv){ return py + ph - (yv - yMin)*ph/(yMax - yMin); }

  const nTicks = 5;
  for(let i=0;i<=nTicks;i++){
    const xv = xMin + (xMax-xMin)*i/nTicks;
    const xp = xToPx(xv);
    ctx.strokeStyle = 'rgba(232,236,255,0.35)';
    ctx.beginPath(); ctx.moveTo(xp, py+ph); ctx.lineTo(xp, py+ph+6); ctx.stroke();
    const s = (Math.abs(xv) >= 1e4 || Math.abs(xv) < 1e-2) ? fmtSci(xv,2) : (xv).toFixed(2);
    ctx.fillText(s, xp-18, py+ph+20);
  }
  for(let i=0;i<=nTicks;i++){
    const yv = yMin + (yMax-yMin)*i/nTicks;
    const yp = yToPx(yv);
    ctx.strokeStyle = 'rgba(232,236,255,0.35)';
    ctx.beginPath(); ctx.moveTo(px-6, yp); ctx.lineTo(px, yp); ctx.stroke();
    const s = (Math.abs(yv) >= 1e4 || Math.abs(yv) < 1e-2) ? fmtSci(yv,2) : (yv).toFixed(2);
    ctx.fillText(s, px-48, yp+4);
  }

  // axis labels
  ctx.fillStyle = 'rgba(232,236,255,0.9)';
  ctx.font = '600 12.5px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText(xLabel, px + pw/2 - ctx.measureText(xLabel).width/2, py+ph+36);

  // y label rotated
  ctx.save();
  ctx.translate(px-38, py+ph/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
  ctx.restore();

  ctx.restore();
  return {plot:{px,py,pw,ph}, xToPx, yToPx};
}

function drawLine(ctx, xToPx, yToPx, xs, ys){
  ctx.beginPath();
  for(let i=0;i<xs.length;i++){
    const xp = xToPx(xs[i]);
    const yp = yToPx(ys[i]);
    if(i===0) ctx.moveTo(xp, yp);
    else ctx.lineTo(xp, yp);
  }
  ctx.stroke();
}

function drawMarker(ctx, x, y, label){
  ctx.save();
  ctx.fillStyle = 'rgba(125,255,207,0.95)';
  ctx.strokeStyle = 'rgba(0,0,0,0.35)';
  ctx.lineWidth = 2;
  ctx.beginPath(); ctx.arc(x,y,5.5,0,Math.PI*2); ctx.fill(); ctx.stroke();

  if(label){
    ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace';
    ctx.fillStyle = 'rgba(232,236,255,0.92)';
    const pad=6;
    const tw = ctx.measureText(label).width;
    ctx.fillStyle = 'rgba(0,0,0,0.45)';
    ctx.beginPath();
    const bx = x+10, by = y-18;
    ctx.roundRect ? ctx.roundRect(bx, by, tw+pad*2, 20, 8) : ctx.rect(bx, by, tw+pad*2, 20);
    ctx.fill();
    ctx.fillStyle = 'rgba(232,236,255,0.92)';
    ctx.fillText(label, bx+pad, by+14);
  }
  ctx.restore();
}

/* --------------------------
   Diagram drawing
---------------------------*/
function drawDiagram(state){
  const canvas = document.getElementById('cDiagram');
  const {ctx, w, h} = setupCanvas(canvas);
  ctx.clearRect(0,0,w,h);

  // Frame
  const margin = 10;
  const box = {x: margin, y: margin, w: w-2*margin, h: h-2*margin};

  // Title
  ctx.fillStyle = 'rgba(232,236,255,0.92)';
  ctx.font = '600 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText('Small-signal rod amplifier model', box.x+8, box.y+16);

  // Draw rod
  const rodX = box.x + 70;
  const rodY = box.y + 70;
  const rodW = box.w - 140;
  const rodH = 56;

  // Beam line
  ctx.strokeStyle = 'rgba(122,167,255,0.55)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(box.x+18, rodY + rodH/2);
  ctx.lineTo(box.x+box.w-18, rodY + rodH/2);
  ctx.stroke();

  // Arrowheads
  function arrow(x1,y1,x2,y2){
    const ang = Math.atan2(y2-y1,x2-x1);
    const L=10;
    ctx.beginPath();
    ctx.moveTo(x2,y2);
    ctx.lineTo(x2 - L*Math.cos(ang-0.35), y2 - L*Math.sin(ang-0.35));
    ctx.lineTo(x2 - L*Math.cos(ang+0.35), y2 - L*Math.sin(ang+0.35));
    ctx.closePath();
    ctx.fillStyle = 'rgba(122,167,255,0.75)';
    ctx.fill();
  }
  arrow(box.x+18, rodY + rodH/2, box.x+box.w-18, rodY + rodH/2);

  // Rod body
  ctx.fillStyle = 'rgba(255,255,255,0.06)';
  ctx.strokeStyle = 'rgba(232,236,255,0.18)';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  const r=14;
  // rounded rect
  if(ctx.roundRect){
    ctx.roundRect(rodX, rodY, rodW, rodH, r);
  }else{
    ctx.rect(rodX, rodY, rodW, rodH);
  }
  ctx.fill();
  ctx.stroke();

  // Dopant dots
  ctx.fillStyle = 'rgba(125,255,207,0.35)';
  for(let i=0;i<50;i++){
    const x = rodX + 10 + Math.random()*(rodW-20);
    const y = rodY + 10 + Math.random()*(rodH-20);
    ctx.beginPath(); ctx.arc(x,y,1.6,0,Math.PI*2); ctx.fill();
  }

  // Labels
  ctx.fillStyle = 'rgba(232,236,255,0.92)';
  ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
  ctx.fillText('Input: I(0)', box.x+18, rodY+rodH/2 - 10);
  ctx.fillText('Output: I(L)', box.x+box.w-90, rodY+rodH/2 - 10);

  // Length bracket
  const yB = rodY + rodH + 28;
  ctx.strokeStyle = 'rgba(255,211,122,0.7)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(rodX, yB);
  ctx.lineTo(rodX+rodW, yB);
  ctx.stroke();
  // ends
  ctx.beginPath(); ctx.moveTo(rodX, yB-8); ctx.lineTo(rodX, yB+8); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(rodX+rodW, yB-8); ctx.lineTo(rodX+rodW, yB+8); ctx.stroke();
  ctx.fillStyle = 'rgba(255,211,122,0.9)';
  ctx.font = '600 12.5px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  const Ltxt = `L = ${state.L.toFixed(1)} cm`;
  ctx.fillText(Ltxt, rodX+rodW/2 - ctx.measureText(Ltxt).width/2, yB+22);

  // Gain law
  ctx.fillStyle = 'rgba(185,194,255,0.95)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace';
  const law = 'G = I(L)/I(0) = exp(σ ΔN L)';
  ctx.fillText(law, box.x+18, box.y+box.h-24);

  // Medium
  ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillStyle = 'rgba(232,236,255,0.9)';
  ctx.fillText(`Medium: ${state.mediumLabel}`, rodX, rodY-10);
}

/* --------------------------
   Main plot: G vs ΔN
---------------------------*/
function drawMainPlot(state){
  const canvas = document.getElementById('cMain');
  const {ctx, w, h} = setupCanvas(canvas);
  ctx.clearRect(0,0,w,h);

  const margin = 10;
  const box = {x: margin, y: margin, w: w-2*margin, h: h-2*margin};

  // Define ranges for ΔN
  const Nreq = state.deltaN;
  const Nmax = Math.max(1.2*Nreq, 8e18);
  const Nmin = 0;

  // y range for G
  const Gmin = 1;
  const Gmax = Math.max(1.25*state.G, 20);

  const ax = drawAxes(
    ctx, box,
    Nmin, Nmax,
    Gmin, Gmax,
    'ΔN (cm^-3)',
    'Total gain G (dimensionless)',
    'G vs ΔN at fixed L and σ'
  );

  // Curve
  const xs=[], ys=[];
  const n=220;
  for(let i=0;i<n;i++){
    const N = Nmin + (Nmax-Nmin)*i/(n-1);
    const G = Math.exp(state.sigma * N * state.L);
    xs.push(N);
    ys.push(clamp(G, Gmin, Gmax*1.2));
  }
  ctx.save();
  ctx.strokeStyle = 'rgba(122,167,255,0.95)';
  ctx.lineWidth = 2.2;
  drawLine(ctx, ax.xToPx, ax.yToPx, xs, ys);
  ctx.restore();

  // Marker at required point
  const xP = ax.xToPx(Nreq);
  const yP = ax.yToPx(state.G);
  drawMarker(ctx, xP, yP, `Required: ΔN ≈ ${fmtSci(Nreq,3)} cm^-3`);

  // Legend
  ctx.save();
  ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillStyle = 'rgba(232,236,255,0.92)';
  const legX = box.x + box.w - 210;
  const legY = box.y + 32;
  ctx.fillStyle = 'rgba(0,0,0,0.35)';
  if(ctx.roundRect){ ctx.beginPath(); ctx.roundRect(legX, legY, 192, 58, 12); ctx.fill(); }
  else{ ctx.fillRect(legX, legY, 192, 58); }
  ctx.strokeStyle = 'rgba(232,236,255,0.14)';
  ctx.strokeRect(legX, legY, 192, 58);
  ctx.fillStyle = 'rgba(232,236,255,0.92)';
  ctx.fillText('Curve: G = exp(σ ΔN L)', legX+12, legY+22);
  ctx.fillText(`L=${state.L.toFixed(1)} cm, σ=${fmtSci(state.sigma,2)} cm^2`, legX+12, legY+42);
  ctx.restore();
}

/* --------------------------
   Secondary plot: Required ΔN vs L
---------------------------*/
function drawSecondaryPlot(state){
  const canvas = document.getElementById('cSecondary');
  const {ctx, w, h} = setupCanvas(canvas);
  ctx.clearRect(0,0,w,h);

  const margin = 10;
  const box = {x: margin, y: margin, w: w-2*margin, h: h-2*margin};

  const Lmin = 2, Lmax = 30;
  const Nreq = state.deltaN;
  // scale y based on min length
  const N_at_Lmin = (Math.log(state.G))/(state.sigma*Lmin);
  const Nmax = Math.max(1.1*N_at_Lmin, 1e19);
  const Nmin = 0;

  const ax = drawAxes(
    ctx, box,
    Lmin, Lmax,
    Nmin, Nmax,
    'Rod length L (cm)',
    'Required ΔN (cm^-3)',
    'Required inversion vs length'
  );

  const xs=[], ys=[];
  const n=220;
  for(let i=0;i<n;i++){
    const L = Lmin + (Lmax-Lmin)*i/(n-1);
    const N = (Math.log(state.G))/(state.sigma*L);
    xs.push(L);
    ys.push(N);
  }
  ctx.save();
  ctx.strokeStyle = 'rgba(255,211,122,0.95)';
  ctx.lineWidth = 2.2;
  drawLine(ctx, ax.xToPx, ax.yToPx, xs, ys);
  ctx.restore();

  // Marker at current L
  const xP = ax.xToPx(state.L);
  const yP = ax.yToPx(Nreq);
  drawMarker(ctx, xP, yP, `At L=${state.L.toFixed(1)} cm: ΔN≈${fmtSci(Nreq,3)}`);

  // Note text
  ctx.save();
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace';
  ctx.fillStyle = 'rgba(185,194,255,0.92)';
  ctx.fillText('Scaling: ΔN ∝ 1/L', box.x+14, box.y+box.h-16);
  ctx.restore();
}

/* --------------------------
   State + UI
---------------------------*/
const ui = {
  sG: document.getElementById('sG'),
  sL: document.getElementById('sL'),
  selMed: document.getElementById('selMed'),
  vG: document.getElementById('vG'),
  vL: document.getElementById('vL'),
  vSigma: document.getElementById('vSigma'),
  liveAns: document.getElementById('liveAns'),
  copyLive: document.getElementById('copyLive'),
};

function computeState(){
  const G = parseFloat(ui.sG.value);
  const L = parseFloat(ui.sL.value);
  const sigma = parseFloat(ui.selMed.value); // cm^2
  const mediumLabel = ui.selMed.options[ui.selMed.selectedIndex].text.split('—')[0].trim();

  const deltaN = (Math.log(G)) / (sigma * L); // cm^-3
  const g0 = Math.log(G) / L; // cm^-1

  return {G, L, sigma, deltaN, g0, mediumLabel};
}

function render(){
  const st = computeState();

  ui.vG.textContent = st.G.toFixed(1);
  ui.vL.textContent = st.L.toFixed(1);
  ui.vSigma.textContent = fmtSci(st.sigma, 2) + ' cm^2';

  ui.liveAns.textContent =
`ΔN = (ln G)/(σ L)
= (ln ${st.G.toFixed(1)}) / (${fmtSci(st.sigma,2)} × ${st.L.toFixed(1)} cm)
≈ ${fmtSci(st.deltaN,3)} cm^-3

(Equivalent gain coefficient: g0 = (ln G)/L ≈ ${st.g0.toFixed(4)} cm^-1)`;

  ui.copyLive.onclick = () => {
    window.__copyText(`ΔN ≈ ${st.deltaN} cm^-3`);
    ui.copyLive.textContent = 'Copied!';
    setTimeout(()=>ui.copyLive.textContent='Copy live answer', 900);
  };

  drawDiagram(st);
  drawMainPlot(st);
  drawSecondaryPlot(st);
}

['input','change'].forEach(ev=>{
  ui.sG.addEventListener(ev, render);
  ui.sL.addEventListener(ev, render);
  ui.selMed.addEventListener(ev, render);
});

window.addEventListener('resize', ()=>{
  // re-render on resize for crisp scaling
  render();
});

// initial render
render();
</script>
</body>
</html>
