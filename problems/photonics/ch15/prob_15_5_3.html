<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Photon-Number Distribution for Amplified Coherent Light (ASE + Coherent)</title>
  <style>
    :root{
      --bg:#0b0f19;
      --card:#10182a;
      --card2:#0f1526;
      --text:#e8eefc;
      --muted:#b8c3e6;
      --faint:#7f8bb3;
      --accent:#7aa2ff;
      --accent2:#62d2a2;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --line:rgba(255,255,255,0.10);
      --shadow: 0 12px 35px rgba(0,0,0,0.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(122,162,255,0.22), transparent 60%),
        radial-gradient(900px 600px at 90% 0%, rgba(98,210,162,0.18), transparent 55%),
        radial-gradient(900px 900px at 50% 100%, rgba(255,204,102,0.10), transparent 60%),
        var(--bg);
      line-height:1.55;
    }

    header{
      padding: 28px 18px 10px 18px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .title-wrap{
      display:grid;
      grid-template-columns: 1.3fr 0.7fr;
      gap:16px;
      align-items:end;
    }
    h1{
      margin:0;
      font-size: clamp(26px, 3.2vw, 40px);
      letter-spacing: -0.02em;
    }
    .subtitle{
      color: var(--muted);
      font-size: 14px;
      margin-top:10px;
      max-width: 80ch;
    }
    .badge-row{
      display:flex;
      gap:10px;
      justify-content:flex-end;
      flex-wrap:wrap;
    }
    .badge{
      border:1px solid var(--line);
      padding:8px 10px;
      border-radius: 999px;
      color: var(--muted);
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      box-shadow: 0 6px 18px rgba(0,0,0,0.25);
      font-size: 12px;
      white-space:nowrap;
    }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 14px 18px 80px 18px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap: 18px;
      align-items:start;
    }

    nav.toc{
      position: sticky;
      top: 12px;
      align-self:start;
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px 14px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    nav.toc h2{
      margin:0 0 10px 0;
      font-size: 14px;
      color: var(--muted);
      letter-spacing: 0.03em;
      text-transform: uppercase;
    }
    .toc a{
      display:block;
      color: var(--text);
      text-decoration:none;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      font-size: 13px;
      margin: 2px 0;
      transition: transform 160ms ease, background 160ms ease, border 160ms ease;
    }
    .toc a:hover{
      background: rgba(122,162,255,0.10);
      border-color: rgba(122,162,255,0.20);
      transform: translateX(2px);
    }
    .toc small{
      color: var(--faint);
      display:block;
      margin-top: 10px;
      padding: 0 8px;
      font-size: 12px;
    }

    article{
      display:flex;
      flex-direction:column;
      gap: 14px;
    }

    section{
      background: linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px 18px;
      box-shadow: var(--shadow);
    }
    section h2{
      margin:0 0 10px 0;
      font-size: 18px;
      letter-spacing:-0.01em;
    }
    section h3{
      margin: 14px 0 8px 0;
      font-size: 15px;
      color: var(--muted);
    }
    p{margin: 8px 0; color: var(--text)}
    ul{margin: 8px 0 8px 20px; color: var(--text)}
    li{margin: 6px 0}
    .muted{color: var(--muted)}
    .faint{color: var(--faint)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 12px;
    }
    .callout{
      background: linear-gradient(180deg, rgba(16,24,42,0.55), rgba(15,21,38,0.50));
      border:1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      padding: 14px 14px;
    }
    .callout .label{
      font-size: 12px;
      letter-spacing: 0.06em;
      text-transform: uppercase;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      margin-bottom: 8px;
    }
    .dot{
      width:10px;height:10px;border-radius:999px;background: var(--accent);
      box-shadow: 0 0 0 4px rgba(122,162,255,0.15);
    }
    .dot.warn{background: var(--warn); box-shadow: 0 0 0 4px rgba(255,204,102,0.15);}
    .dot.good{background: var(--accent2); box-shadow: 0 0 0 4px rgba(98,210,162,0.14);}
    .dot.bad{background: var(--danger); box-shadow: 0 0 0 4px rgba(255,107,107,0.14);}

    .eq{
      position: relative;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.12);
      border-radius: 14px;
      padding: 12px 12px 12px 12px;
      overflow:hidden;
    }
    .eq pre{
      margin:0;
      font-family: var(--mono);
      font-size: 13px;
      color: #f1f5ff;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .copybtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      padding: 7px 10px;
      border-radius: 999px;
      cursor:pointer;
      font-size: 12px;
      transition: transform 140ms ease, background 140ms ease;
      user-select:none;
    }
    .copybtn:hover{transform: translateY(-1px); background: rgba(122,162,255,0.10);}
    .copybtn:active{transform: translateY(0px) scale(0.98);}
    .kpi{
      display:flex;
      gap: 10px;
      flex-wrap:wrap;
      margin-top: 10px;
    }
    .pill{
      border:1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      border-radius: 999px;
      padding: 7px 10px;
      font-size: 12px;
      color: var(--muted);
    }
    .pill b{color: var(--text)}

    figure{
      margin:0;
      padding: 10px 10px 12px 10px;
      border-radius: 16px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.10);
    }
    figcaption{
      color: var(--muted);
      font-size: 12px;
      margin-top: 8px;
      line-height:1.4;
    }
    canvas{
      width:100%;
      height: 280px;
      display:block;
      border-radius: 14px;
      background: rgba(9,12,20,0.6);
      border: 1px solid rgba(255,255,255,0.10);
    }
    .controls{
      display:grid;
      grid-template-columns: 1.2fr 1fr 1fr;
      gap: 12px;
      align-items:end;
      margin-top: 10px;
    }
    .control{
      padding: 10px 12px;
      border-radius: 14px;
      background: rgba(0,0,0,0.18);
      border:1px solid rgba(255,255,255,0.10);
    }
    .control label{
      display:block;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    input[type="range"]{width:100%}
    select{
      width:100%;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      outline:none;
    }
    .readout{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--text);
      opacity:0.95;
      margin-top: 6px;
    }

    footer{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 18px 36px 18px;
      color: var(--faint);
      font-size: 12px;
    }

    /* subtle entrance */
    section{
      animation: floatIn 420ms ease both;
    }
    @keyframes floatIn{
      from{opacity:0; transform: translateY(10px)}
      to{opacity:1; transform: translateY(0)}
    }

    /* responsive */
    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
      nav.toc{position: relative; top:auto}
      .title-wrap{grid-template-columns: 1fr}
      .badge-row{justify-content:flex-start}
      canvas{height: 260px}
      .controls{grid-template-columns: 1fr}
      .grid2{grid-template-columns: 1fr}
      .grid3{grid-template-columns: 1fr}
    }

    /* print-friendly */
    @media print{
      body{background:#fff;color:#111}
      section, nav.toc, figure, .eq, .control{box-shadow:none}
      nav.toc{display:none}
      canvas{display:none}
      .copybtn{display:none}
      a{color:#111}
    }
  </style>
</head>

<body>
<header>
  <div class="title-wrap">
    <div>
      <h1>Amplified Coherent Light: Photon-Number Statistics (Coherent Signal + ASE)</h1>
      <div class="subtitle">
        We model the energy fluctuations at the output of a laser amplifier as a <b>coherent pulse</b> interfered with
        <b>narrowband thermal light</b> (amplified spontaneous emission, ASE). The resulting energy has a
        <b>noncentral chi-square</b> density, which induces a <b>compound-Poisson</b> photon-number distribution
        expressible via <b>Laguerre polynomials</b>.
      </div>
    </div>
    <div class="badge-row">
      <div class="badge">Model: coherent + thermal (ASE)</div>
      <div class="badge">Key tool: Poisson mixing</div>
      <div class="badge">Result: Laguerre / NNB distribution</div>
    </div>
  </div>
</header>

<main>
  <nav class="toc">
    <h2>Contents</h2>
    <a href="#quick">Quick Summary</a>
    <a href="#part0">PART 0 — Concept Primer</a>
    <a href="#part1">PART 1 — Problem Analysis</a>
    <a href="#part2">PART 2 — Strategy & Tips</a>
    <a href="#part3">PART 3 — Full Solution</a>
    <a href="#part4">PART 4 — Deeper Understanding</a>
    <a href="#part5">PART 5 — Visualization Guide</a>
    <small>
      Tip: the slider in the visualization section changes the signal-to-ASE ratio and updates all plots live.
    </small>
  </nav>

  <article>

    <!-- Quick Summary -->
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>What this problem is about:</b> photon-number statistics of amplified coherent light modeled as a coherent signal plus ASE (thermal) noise.</li>
        <li><b>Key physics idea:</b> random output energy <code>w</code> produces photon counts via a <b>Poisson mixture</b> (a compound Poisson process).</li>
        <li><b>Governing energy PDF:</b> noncentral-chi-square (2 DOF) form
          <span class="muted">with modified Bessel <code>I<sub>0</sub></code></span>.</li>
        <li><b>Energy moments:</b> <code>&lt;w&gt; = w_s + w_ASE</code>, <code>Var(w) = w_ASE^2 + 2 w_s w_ASE</code>.</li>
        <li><b>Photon-number moments (Poisson mixing):</b> <code>n̄ = &lt;w&gt;/(ħω)</code> and <code>Var(n) = n̄ + Var(w)/(ħω)^2</code>.</li>
        <li><b>Photon-number distribution:</b>
          <code>p(n) = [n_ASE^n/(1+n_ASE)^{n+1}] exp(-n_s/(1+n_ASE)) L_n( - (n_s/n_ASE)/(1+n_ASE) )</code>.</li>
        <li><b>Final result type:</b> fully <b>symbolic</b> (with interactive numeric plots using example values).</li>
      </ul>
    </section>

    <!-- PART 0 -->
    <section id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div class="callout">
          <div class="label"><span class="dot"></span> Core definitions</div>
          <ul>
            <li><b>Energy in a detection window:</b> <code>w</code> (units: J).</li>
            <li><b>Coherent (signal) energy:</b> <code>w_s</code> (J), treated as constant.</li>
            <li><b>ASE mean energy:</b> <code>w_ASE</code> (J), sets noise strength.</li>
            <li><b>Photon number:</b> <code>n</code> (dimensionless count).</li>
            <li><b>Photon energy:</b> <code>ħω</code> (J), so <code>n</code> relates to energy scale.</li>
            <li><b>Mean photon numbers:</b>
              <code>n_s = w_s/(ħω)</code>, <code>n_ASE = w_ASE/(ħω)</code>.</li>
          </ul>
        </div>

        <div class="callout">
          <div class="label"><span class="dot good"></span> Physical meaning</div>
          <p class="muted">
            At the output of an amplifier, the detected field is the <b>sum</b> of a deterministic coherent component
            and a random complex Gaussian (thermal) component. Because intensity/energy is quadratic in the field,
            the resulting <code>w</code> is not Gaussian: it follows a <b>noncentral chi-square</b> distribution
            (equivalently a Ricean intensity model).
          </p>
          <p class="muted">
            Photon counting adds another layer: conditioned on a particular classical energy (or intensity),
            the counts are Poisson. Unconditioning produces a richer distribution (here: a Laguerre / NNB form).
          </p>
        </div>
      </div>

      <h3>Key laws/principles and validity</h3>
      <ul>
        <li><b>Narrowband/short-window assumption:</b> detection time and detector area are small enough that a
          single-mode (or effectively single temporal-spatial mode) model applies.</li>
        <li><b>Thermal field model (ASE):</b> complex Gaussian statistics (circular), leading to exponential intensity when no coherent signal is present.</li>
        <li><b>Poisson counting conditioned on energy:</b> for photo-detection with quantum efficiency absorbed into calibration, the conditional distribution is
          <code>p(n|w) = exp(-w/(ħω)) (w/(ħω))^n / n!</code>.</li>
      </ul>

      <div class="callout">
        <div class="label"><span class="dot warn"></span> Common models/approximations (why we use them)</div>
        <ul>
          <li><b>Coherent + thermal superposition:</b> captures amplifier output where a strong signal interferes with ASE.</li>
          <li><b>Noncentral chi-square energy PDF:</b> arises naturally from the magnitude-squared of a complex Gaussian random variable with nonzero mean.</li>
          <li><b>Compound Poisson (Poisson mixture):</b> converts continuous energy fluctuations into discrete photon-number statistics.</li>
        </ul>
      </div>

      <h3>Mini intuition examples</h3>
      <ul>
        <li>If <code>w_s = 0</code> (no coherent signal), <code>w</code> is purely thermal → energy is exponential → photon number becomes <b>Bose–Einstein (geometric)</b>.</li>
        <li>If ASE is negligible (<code>w_ASE → 0</code>), the energy becomes essentially fixed → photon number becomes <b>Poisson</b> (like a coherent state).</li>
      </ul>

      <div class="callout">
        <div class="label"><span class="dot bad"></span> What to watch for (pitfalls)</div>
        <ul>
          <li>Mixing up <b>energy variance</b> with <b>photon-number variance</b>: Poisson mixing adds an extra <code>+ n̄</code> term.</li>
          <li>For the Laguerre form, the argument is <b>negative</b> (it is <code>L_n(-x)</code> with <code>x&gt;0</code>).</li>
          <li>The “Poisson limit” is a limit in noise level (<code>n_ASE → 0</code>), not merely a particular ratio at fixed noise.</li>
        </ul>
      </div>
    </section>

    <!-- PART 1 -->
    <section id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Rewrite the problem in plain words</h3>
      <p>
        The output of a laser amplifier is modeled as a coherent signal pulse plus ASE thermal light.
        The measured energy <code>w</code> in a short detection window fluctuates with probability density
      </p>

      <div class="eq" data-copy="eq_energy_pdf">
        <button class="copybtn" onclick="copyEq('eq_energy_pdf')">Copy</button>
        <pre id="eq_energy_pdf">p(w) = (1 / w_ASE) * exp( - (w + w_s)/w_ASE ) * I0( 2 * sqrt(w w_s) / w_ASE ),   w ≥ 0</pre>
      </div>

      <p class="muted">
        where <code>I0</code> is the modified Bessel function of the first kind (order 0),
        <code>w_ASE</code> is the mean energy of ASE, and <code>w_s</code> is the (constant) coherent signal energy.
      </p>

      <h3>Given quantities</h3>
      <ul>
        <li><code>w_s</code> (constant signal energy), <code>w_ASE</code> (mean ASE energy), and the PDF above.</li>
        <li>Photon energy scale <code>ħω</code> for converting energy to mean photon number.</li>
      </ul>

      <h3>Unknowns / tasks</h3>
      <ul>
        <li>(a) Find <code>&lt;w&gt;</code> and <code>Var(w)</code>.</li>
        <li>(b) Use Poisson-mixing relations (referred to as eqs. 13.2-27 and 13.2-28) to get <code>n̄</code> and <code>Var(n)</code>, confirming the stated amplifier-noise relation (eq. 15.5-4 in the source).</li>
        <li>(c) Use the Poisson-mixture integral (eq. 13.2-26) to derive the Laguerre-form photon-number distribution.</li>
        <li>(d) Plot <code>p(n)</code> for several <code>n_s/n_ASE</code> values and discuss the Bose–Einstein and Poisson limits.</li>
      </ul>

      <h3>Relevant principles and why they apply</h3>
      <ul>
        <li><b>Noncentral chi-square/Rice intensity model:</b> applies because intensity is magnitude-squared of “mean + complex Gaussian noise”.</li>
        <li><b>Conditional Poisson photo-counting:</b> applies for ideal counting given a classical intensity/energy realization.</li>
        <li><b>Mixture distribution:</b> photon-number statistics follow by integrating <code>p(n|w)</code> against <code>p(w)</code>.</li>
      </ul>

      <div class="callout">
        <div class="label"><span class="dot warn"></span> Assumptions made explicit</div>
        <ul>
          <li>Single-mode (or effectively single spatiotemporal mode) in the detection window.</li>
          <li>ASE is thermal (complex Gaussian field) and independent of the coherent signal.</li>
          <li>Perfect detection model is used for the theoretical distribution; efficiency can be absorbed into <code>w_s</code>, <code>w_ASE</code>.</li>
        </ul>
      </div>

      <h3>Possible approaches (compare)</h3>
      <div class="grid3">
        <div class="callout">
          <div class="label"><span class="dot"></span> Approach A: known distribution moments</div>
          <p class="muted">Recognize the PDF as noncentral chi-square (2 DOF) ⇒ read off mean/variance from standard results.</p>
          <p class="faint">Pros: fastest. Cons: relies on recognition / memory of formulas.</p>
        </div>
        <div class="callout">
          <div class="label"><span class="dot"></span> Approach B: moment generating function</div>
          <p class="muted">Compute <code>M(t)=&lt;e^{-t w}&gt;</code> (Laplace transform) and differentiate to get moments.</p>
          <p class="faint">Pros: self-contained and elegant. Cons: requires a known Bessel integral.</p>
        </div>
        <div class="callout">
          <div class="label"><span class="dot"></span> Approach C: field model</div>
          <p class="muted">Model complex field <code>E = E_s + E_n</code>; compute moments of <code>w ∝ |E|^2</code> directly using Gaussian rules.</p>
          <p class="faint">Pros: physically transparent. Cons: more algebra and bookkeeping.</p>
        </div>
      </div>

      <p>
        <b>Best choice:</b> combine <b>Approach B</b> (Laplace transform) for a clean, teachable derivation of moments,
        then apply the <b>Poisson-mixture identities</b> for photon-number moments and distribution.
      </p>
    </section>

    <!-- PART 2 -->
    <section id="part2">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

      <ol>
        <li>
          <b>Goal:</b> connect energy to photon counting.<br/>
          <b>Tool:</b> conditional Poisson model <code>p(n|w)=e^{-w/(ħω)}(w/(ħω))^n/n!</code>.<br/>
          <span class="muted"><b>Meaning:</b> given a fixed energy, counts fluctuate purely by shot noise.</span>
        </li>
        <li>
          <b>Goal:</b> compute <code>&lt;w&gt;</code> and <code>Var(w)</code>.<br/>
          <b>Tool:</b> Laplace transform <code>M(t)=&lt;e^{-t w}&gt;</code> and differentiation.<br/>
          <span class="muted"><b>Meaning:</b> moments quantify average energy and classical (excess) noise.</span>
        </li>
        <li>
          <b>Goal:</b> convert energy moments to photon-number moments.<br/>
          <b>Tool:</b> Poisson-mixture identities: <code>n̄=&lt;λ&gt;</code>, <code>Var(n)=&lt;λ&gt;+Var(λ)</code> with <code>λ=w/(ħω)</code>.<br/>
          <span class="muted"><b>Meaning:</b> total counting noise = shot noise + classical intensity noise.</span>
        </li>
        <li>
          <b>Goal:</b> derive <code>p(n)</code> in closed form.<br/>
          <b>Tool:</b> mixture integral <code>p(n)=∫ p(n|w)p(w)dw</code> plus a standard integral giving Laguerre polynomials.<br/>
          <span class="muted"><b>Meaning:</b> the discrete distribution encodes both coherence and thermal bunching.</span>
        </li>
        <li>
          <b>Goal:</b> validate limits and interpret parameters.<br/>
          <b>Tool:</b> set <code>n_s=0</code> (thermal) and <code>n_ASE→0</code> (coherent) limits.<br/>
          <span class="muted"><b>Meaning:</b> sanity checks against well-known distributions.</span>
        </li>
      </ol>

      <div class="callout">
        <div class="label"><span class="dot warn"></span> Common mistakes & quick tips</div>
        <ul>
          <li><b>Tip:</b> keep a strict distinction between <code>w_ASE</code> (energy) and <code>n_ASE = w_ASE/(ħω)</code> (photon number).</li>
          <li><b>Mistake:</b> forgetting the extra <code>+n̄</code> in <code>Var(n)</code> from Poisson shot noise.</li>
          <li><b>Tip:</b> for plots, choose <code>n_max</code> a few standard deviations above the mean so the tail is visible.</li>
        </ul>
      </div>
    </section>

    <!-- PART 3 -->
    <section id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Physical intuition first (before math)</h3>
      <p>
        The amplifier output energy <code>w</code> is the intensity of a field that equals “deterministic signal” + “random ASE phasor”.
        Squaring a random phasor sum yields a distribution that is broader than exponential when the signal is present:
        <b>the mean increases by adding signal energy</b>, and the <b>variance increases both</b>
        because ASE fluctuates on its own (<code>w_ASE^2</code>) and because it beats/interferes with the signal (<code>2 w_s w_ASE</code>).
      </p>
      <p>
        When we count photons, even if the energy were fixed we would still have Poisson shot noise.
        So photon-number variance must be <b>bigger</b> than the scaled energy variance alone.
      </p>

      <h3>(a) Mean and variance of the energy <code>w</code></h3>

      <p>
        Define the Laplace transform (a.k.a. moment-generating function with a minus sign):
      </p>

      <div class="eq" data-copy="eq_laplace_def">
        <button class="copybtn" onclick="copyEq('eq_laplace_def')">Copy</button>
        <pre id="eq_laplace_def">M(t) = ⟨ e^{-t w} ⟩ = ∫_0^∞ e^{-t w} p(w) dw</pre>
      </div>

      <p>
        Insert the given density:
      </p>

      <div class="eq" data-copy="eq_M_insert">
        <button class="copybtn" onclick="copyEq('eq_M_insert')">Copy</button>
        <pre id="eq_M_insert">M(t) = ∫_0^∞ (1/w_ASE) exp( - (w+w_s)/w_ASE ) exp(-t w) I0( 2√(w w_s)/w_ASE ) dw</pre>
      </div>

      <p>
        Combine exponentials in <code>w</code>:
        <code>exp(-w(1/w_ASE + t))</code> and factor out the <code>exp(-w_s/w_ASE)</code>.
        Use the standard integral (valid for <code>a &gt; |b|</code>):
      </p>

      <div class="eq" data-copy="eq_bessel_int">
        <button class="copybtn" onclick="copyEq('eq_bessel_int')">Copy</button>
        <pre id="eq_bessel_int">∫_0^∞ e^{-a x} I0( 2 b √x ) dx = (1/a) exp( b^2 / a )</pre>
      </div>

      <p class="muted">
        Here, identify <code>x = w</code>, <code>a = (1/w_ASE + t)</code>, and <code>b = √(w_s)/w_ASE</code>.
        Then <code>b^2 = w_s / w_ASE^2</code>.
      </p>

      <p>
        Therefore,
      </p>

      <div class="eq" data-copy="eq_M_closed">
        <button class="copybtn" onclick="copyEq('eq_M_closed')">Copy</button>
        <pre id="eq_M_closed">M(t) = exp( -w_s/w_ASE ) * (1/w_ASE) * (1/a) * exp( (w_s/w_ASE^2) / a )

where a = (1/w_ASE + t).

After simplifying:
M(t) = 1/(1 + t w_ASE) * exp( - (t w_s) / (1 + t w_ASE) )</pre>
      </div>

      <p>
        Moments follow from derivatives at <code>t=0</code>:
        <code>⟨w⟩ = -M'(0)</code>, <code>⟨w^2⟩ = M''(0)</code>, and <code>Var(w)=⟨w^2⟩-⟨w⟩^2</code>.
      </p>

      <p>
        Differentiate the simplified form:
      </p>
      <div class="eq" data-copy="eq_M_simple">
        <button class="copybtn" onclick="copyEq('eq_M_simple')">Copy</button>
        <pre id="eq_M_simple">M(t) = (1 + t w_ASE)^(-1) * exp( - t w_s / (1 + t w_ASE) )</pre>
      </div>

      <p class="muted">
        Evaluating derivatives (details are standard product/chain rule; keep terms through order <code>t^2</code>) gives:
      </p>

      <div class="callout">
        <div class="label"><span class="dot good"></span> Result (energy moments)</div>
        <div class="eq" data-copy="eq_energy_moments">
          <button class="copybtn" onclick="copyEq('eq_energy_moments')">Copy</button>
          <pre id="eq_energy_moments">⟨w⟩ = w_s + w_ASE
Var(w) = w_ASE^2 + 2 w_s w_ASE</pre>
        </div>
        <div class="kpi">
          <div class="pill"><b>Interpretation:</b> mean adds linearly (signal + ASE)</div>
          <div class="pill"><b>Interpretation:</b> variance = ASE self-noise + signal–ASE beating</div>
        </div>
      </div>

      <h3>Sanity checks for (a)</h3>
      <ul>
        <li><b>Units:</b> both terms in <code>⟨w⟩</code> and <code>Var(w)</code> have units J and J², respectively.</li>
        <li><b>Limit <code>w_s=0</code>:</b> <code>⟨w⟩=w_ASE</code> and <code>Var(w)=w_ASE^2</code>, i.e. exponential energy (thermal) has variance equal to mean².</li>
        <li><b>Limit <code>w_ASE→0</code>:</b> <code>Var(w)→0</code>, energy becomes deterministic as expected for a purely coherent pulse with fixed energy.</li>
      </ul>

      <h3>(b) Photon-number mean and variance (confirming the amplifier-noise relation)</h3>

      <p>
        Conditioned on energy <code>w</code>, the photocount is Poisson with mean
        <code>λ = w/(ħω)</code>:
      </p>

      <div class="eq" data-copy="eq_poisson_cond">
        <button class="copybtn" onclick="copyEq('eq_poisson_cond')">Copy</button>
        <pre id="eq_poisson_cond">p(n|w) = exp( -w/(ħω) ) * (w/(ħω))^n / n!</pre>
      </div>

      <p>
        For a Poisson mixture (random <code>λ</code>), two identities hold:
      </p>
      <div class="eq" data-copy="eq_mix_id">
        <button class="copybtn" onclick="copyEq('eq_mix_id')">Copy</button>
        <pre id="eq_mix_id">n̄ = ⟨λ⟩
Var(n) = ⟨λ⟩ + Var(λ)</pre>
      </div>

      <p>
        Here <code>λ = w/(ħω)</code>, so
        <code>⟨λ⟩ = ⟨w⟩/(ħω)</code> and <code>Var(λ)=Var(w)/(ħω)^2</code>.
        Define the mean photon numbers:
        <code>n_s = w_s/(ħω)</code> and <code>n_ASE = w_ASE/(ħω)</code>.
      </p>

      <div class="callout">
        <div class="label"><span class="dot good"></span> Result (photon-number moments)</div>
        <div class="eq" data-copy="eq_photon_moments">
          <button class="copybtn" onclick="copyEq('eq_photon_moments')">Copy</button>
          <pre id="eq_photon_moments">n̄ = n_s + n_ASE

Var(n) = n̄ + n_ASE^2 + 2 n_s n_ASE
       = (n_s + n_ASE) + n_ASE(n_ASE + 2 n_s)</pre>
        </div>
        <p class="muted">
          This is precisely the “shot-noise + excess-noise” structure expected for amplified coherent light:
          the first term <code>n̄</code> is Poisson shot noise; the remaining terms arise from classical energy fluctuations.
        </p>
      </div>

      <h3>Sanity checks for (b)</h3>
      <ul>
        <li><b>Thermal limit <code>n_s=0</code>:</b> <code>Var(n)=n̄ + n̄^2</code> (Bose–Einstein statistics).</li>
        <li><b>Coherent limit <code>n_ASE→0</code>:</b> <code>Var(n)→n_s</code> (Poisson statistics).</li>
        <li><b>Fano factor:</b> <code>F = Var(n)/n̄ &gt; 1</code> whenever <code>n_ASE &gt; 0</code> (super-Poissonian noise due to ASE).</li>
      </ul>

      <h3>(c) Closed-form photon-number distribution (Laguerre form)</h3>

      <p>
        The unconditional photon-number distribution is the mixture integral (often listed as eq. 13.2-26):
      </p>

      <div class="eq" data-copy="eq_mix_integral">
        <button class="copybtn" onclick="copyEq('eq_mix_integral')">Copy</button>
        <pre id="eq_mix_integral">p(n) = ∫_0^∞ p(n|w) p(w) dw</pre>
      </div>

      <p>
        Insert <code>p(n|w)</code> and <code>p(w)</code>:
      </p>

      <div class="eq" data-copy="eq_pn_integrand">
        <button class="copybtn" onclick="copyEq('eq_pn_integrand')">Copy</button>
        <pre id="eq_pn_integrand">p(n) = (1/n!) ∫_0^∞ exp(-w/(ħω)) (w/(ħω))^n
       * (1/w_ASE) exp( -(w+w_s)/w_ASE ) I0( 2√(w w_s)/w_ASE ) dw</pre>
      </div>

      <p>
        Collect terms that depend on <code>w</code>. Convert to photon-number parameters
        <code>n_ASE = w_ASE/(ħω)</code> and <code>n_s = w_s/(ħω)</code>. After regrouping:
      </p>

      <div class="eq" data-copy="eq_collect_w">
        <button class="copybtn" onclick="copyEq('eq_collect_w')">Copy</button>
        <pre id="eq_collect_w">p(n) = exp( -n_s/n_ASE ) / (n! n_ASE) ∫_0^∞
       exp( -w * (1/(ħω) + 1/w_ASE) )
       * (w/(ħω))^n
       * I0( 2√(w w_s)/w_ASE ) dw</pre>
      </div>

      <p class="muted">
        This integral is a known form that evaluates to a Laguerre polynomial when expressed in terms of
        <code>n_s</code> and <code>n_ASE</code>. The final closed form is:
      </p>

      <div class="callout">
        <div class="label"><span class="dot good"></span> Result (Laguerre / NNB form)</div>
        <div class="eq" data-copy="eq_pn_final">
          <button class="copybtn" onclick="copyEq('eq_pn_final')">Copy</button>
          <pre id="eq_pn_final">p(n) = [ n_ASE^n / (1 + n_ASE)^(n+1) ] * exp( - n_s / (1 + n_ASE) )
     * L_n( - (n_s/n_ASE)/(1 + n_ASE) ),    n = 0,1,2,...</pre>
        </div>
        <p class="muted">
          where <code>L_n</code> is the (ordinary) Laguerre polynomial.
          This distribution is a special case of the <b>noncentral negative-binomial (NNB)</b> family.
        </p>
      </div>

      <p>
        One convenient explicit series (matching the problem statement) for <code>L_n(-x)</code> with <code>x ≥ 0</code> is:
      </p>

      <div class="eq" data-copy="eq_laguerre_series">
        <button class="copybtn" onclick="copyEq('eq_laguerre_series')">Copy</button>
        <pre id="eq_laguerre_series">L_n(-x) = n! * Σ_{r=0}^n [ x^r / ( (n-r)! (r!)^2 ) ]
        = Σ_{r=0}^n [ C(n,r) * x^r / r! ]</pre>
      </div>

      <h3>Sanity checks for (c)</h3>
      <ul>
        <li><b>Thermal case <code>n_s=0</code>:</b> since <code>L_n(0)=1</code>,
          <code>p(n)=n_ASE^n/(1+n_ASE)^{n+1}</code> (Bose–Einstein / geometric).</li>
        <li><b>Coherent limit <code>n_ASE→0</code>:</b> the distribution approaches Poisson with mean <code>n_s</code> (physically: energy becomes nearly fixed).</li>
      </ul>

      <h3>(d) Plot and demonstrate behavior</h3>
      <p>
        The interactive plots below show <code>p(n)</code> and the Fano factor
        <code>F = Var(n)/n̄</code> as you vary the signal-to-ASE ratio <code>r = n_s/n_ASE</code>
        and the ASE level <code>n_ASE</code>.
        The problem’s requested example <code>n_ASE = 5</code> and ratios <code>r ∈ {0, 0.5, 0.8, 1}</code>
        are included as presets.
      </p>

      <div class="callout">
        <div class="label"><span class="dot"></span> Final answer (copy-ready)</div>
        <div class="eq" data-copy="eq_final_answer">
          <button class="copybtn" onclick="copyEq('eq_final_answer')">Copy</button>
          <pre id="eq_final_answer">(a) ⟨w⟩ = w_s + w_ASE
    Var(w) = w_ASE^2 + 2 w_s w_ASE

(b) n̄ = (⟨w⟩)/(ħω) = n_s + n_ASE
    Var(n) = n̄ + Var(w)/(ħω)^2 = n̄ + n_ASE^2 + 2 n_s n_ASE

(c) p(n) = [ n_ASE^n / (1 + n_ASE)^(n+1) ] exp( - n_s/(1 + n_ASE) )
          × L_n( - (n_s/n_ASE)/(1 + n_ASE) )</pre>
        </div>
      </div>
    </section>

    <!-- Visualizations -->
    <section id="viz">
      <h2>Interactive Visualizations</h2>

      <div class="grid2">
        <figure>
          <canvas id="diagram"></canvas>
          <figcaption>
            <b>Diagram:</b> Amplifier output modeled as a coherent signal phasor plus an ASE (thermal) random phasor.
            The detector integrates energy <code>w</code> over a short window, then photon counts <code>n</code> are drawn from a Poisson process with mean <code>w/(ħω)</code>.
          </figcaption>
        </figure>

        <figure>
          <canvas id="plotMain"></canvas>
          <figcaption>
            <b>Main plot:</b> Photon-number distribution <code>p(n)</code> from the Laguerre formula.
            Use the controls to vary <code>r = n_s/n_ASE</code> and <code>n_ASE</code>.
          </figcaption>
        </figure>
      </div>

      <figure style="margin-top:12px;">
        <canvas id="plotSecondary"></canvas>
        <figcaption>
          <b>Secondary plot:</b> Fano factor <code>F = Var(n)/n̄</code> versus <code>r = n_s/n_ASE</code>
          (marker shows current slider value). This visualizes how ASE makes the light super-Poissonian.
        </figcaption>

        <div class="controls">
          <div class="control">
            <label for="ratio">Signal-to-ASE ratio r = n_s / n_ASE</label>
            <input id="ratio" type="range" min="0" max="2.0" step="0.01" value="0.80" />
            <div class="readout" id="ratioReadout">r = 0.80</div>
          </div>

          <div class="control">
            <label for="nase">ASE mean photon number n_ASE (example)</label>
            <select id="nase">
              <option value="1">1</option>
              <option value="2">2</option>
              <option value="5" selected>5</option>
              <option value="10">10</option>
              <option value="20">20</option>
            </select>
            <div class="readout" id="naseReadout">n_ASE = 5</div>
          </div>

          <div class="control">
            <label for="preset">Preset ratios (problem part d)</label>
            <select id="preset">
              <option value="custom" selected>Custom (use slider)</option>
              <option value="0">r = 0.0 (thermal-only)</option>
              <option value="0.5">r = 0.5</option>
              <option value="0.8">r = 0.8</option>
              <option value="1">r = 1.0</option>
            </select>
            <div class="readout" id="statsReadout">n̄, Var, F shown here</div>
          </div>
        </div>
      </figure>
    </section>

    <!-- PART 4 -->
    <section id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpret the final formulas</h3>
      <ul>
        <li><b><code>n̄ = n_s + n_ASE</code>:</b> mean counts add like energies; signal and ASE contribute independently to the mean.</li>
        <li><b><code>Var(n) = n̄ + n_ASE^2 + 2 n_s n_ASE</code>:</b>
          <ul>
            <li><code>n̄</code>: unavoidable shot noise (Poisson) even if the energy were fixed.</li>
            <li><code>n_ASE^2</code>: thermal bunching of ASE.</li>
            <li><code>2 n_s n_ASE</code>: coherent–ASE beating (interference fluctuations).</li>
          </ul>
        </li>
        <li><b>Laguerre factor <code>L_n(-x)</code>:</b> encodes how a coherent “offset” reshapes a thermal-like distribution.</li>
      </ul>

      <h3>How changing parameters affects outcomes (connect to plots)</h3>
      <ul>
        <li>Increase <code>n_ASE</code> at fixed <code>r</code>: the distribution broadens and the Fano factor rises (more excess noise).</li>
        <li>Increase <code>r</code> at fixed <code>n_ASE</code>: the mean shifts upward; relative excess noise generally decreases because the coherent part stabilizes fluctuations.</li>
        <li>When <code>r=0</code>: you see the geometric tail of thermal light (largest bunching).</li>
      </ul>

      <h3>An alternative derivation idea</h3>
      <p class="muted">
        Instead of integrating the Bessel-form PDF, you can start from the complex field model
        <code>E = E_s + E_n</code>, where <code>E_n</code> is circular complex Gaussian. Then compute the
        generating function of photon counts directly from the Gaussian characteristic function.
        This also leads to the same NNB/Laguerre form but highlights the role of coherent displacement.
      </p>

      <h3>Concept checks (with answers)</h3>
      <ul>
        <li><b>Q:</b> Why does <code>Var(n)</code> include a <code>+n̄</code> term even if energy fluctuates? <b>A:</b> Because conditional Poisson counting adds shot noise: <code>Var(n|w)=λ</code>, and averaging gives <code>+⟨λ⟩</code>.</li>
        <li><b>Q:</b> What physical effect produces the <code>2 n_s n_ASE</code> term? <b>A:</b> Interference (beating) between coherent signal and ASE field fluctuations.</li>
        <li><b>Q:</b> When do you get Bose–Einstein photon statistics? <b>A:</b> When the coherent component is absent (<code>n_s=0</code>), leaving pure thermal light.</li>
        <li><b>Q:</b> When do you get Poisson statistics? <b>A:</b> In the limit of negligible ASE (<code>n_ASE→0</code>), so the energy is essentially fixed.</li>
      </ul>
    </section>

    <!-- PART 5 -->
    <section id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <h3>What each canvas shows</h3>
      <ul>
        <li><b>Diagram canvas:</b> a phasor picture: the coherent signal is a fixed vector; ASE is a random vector; the detected energy depends on the squared magnitude of the sum.</li>
        <li><b>Main plot (distribution):</b> bar/line plot of <code>p(n)</code> vs photon number <code>n</code> for the Laguerre formula using the chosen <code>n_ASE</code> and <code>r</code>.</li>
        <li><b>Secondary plot (parameter sweep):</b> Fano factor <code>F = Var(n)/n̄</code> as a function of <code>r</code>; the marker shows the current <code>r</code>.</li>
      </ul>

      <h3>Interactive controls</h3>
      <ul>
        <li><b>Slider <code>r = n_s/n_ASE</code>:</b> changes the coherent strength relative to ASE. Expect the distribution to shift to larger <code>n</code> and become relatively less bunched as <code>r</code> increases.</li>
        <li><b>Dropdown <code>n_ASE</code>:</b> changes the ASE noise level. Expect broader distributions and larger Fano factors for larger <code>n_ASE</code>.</li>
        <li><b>Preset dropdown:</b> jumps to the problem’s requested ratios. After selecting a preset, the slider updates and all plots re-render.</li>
      </ul>

      <div class="callout">
        <div class="label"><span class="dot warn"></span> Matching symbols</div>
        <p class="muted">
          The plots use the same symbols as the derivation: <code>n_ASE</code>, <code>n_s</code>, <code>r=n_s/n_ASE</code>,
          and the distribution <code>p(n)</code> defined in PART 3.
          Numeric values are <b>example values for visualization</b> (as permitted), while the analytic results remain symbolic.
        </p>
      </div>
    </section>

  </article>
</main>

<footer>
  <p>
    Built for your Physics & Mathematics problem-solving archive. All math and plots are implemented with vanilla HTML/CSS/JS (no external libraries).
  </p>
</footer>

<script>
/* =========================
   Copy buttons
========================= */
async function copyEq(id){
  const el = document.getElementById(id);
  const text = el ? el.textContent.trim() : "";
  try{
    await navigator.clipboard.writeText(text);
    toast("Copied ✓");
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    toast("Copied ✓");
  }
}
let toastTimer=null;
function toast(msg){
  let t = document.getElementById("toast");
  if(!t){
    t=document.createElement("div");
    t.id="toast";
    t.style.position="fixed";
    t.style.left="50%";
    t.style.bottom="18px";
    t.style.transform="translateX(-50%)";
    t.style.padding="10px 14px";
    t.style.borderRadius="999px";
    t.style.border="1px solid rgba(255,255,255,0.18)";
    t.style.background="rgba(0,0,0,0.55)";
    t.style.color="#e8eefc";
    t.style.fontFamily="ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    t.style.fontSize="12px";
    t.style.boxShadow="0 12px 30px rgba(0,0,0,0.35)";
    t.style.zIndex="9999";
    t.style.opacity="0";
    t.style.transition="opacity 180ms ease";
    document.body.appendChild(t);
  }
  t.textContent=msg;
  t.style.opacity="1";
  clearTimeout(toastTimer);
  toastTimer=setTimeout(()=>{t.style.opacity="0";}, 900);
}

/* =========================
   Math helpers (no libraries)
========================= */
// Lanczos approximation for log-gamma (good enough for plotting n up to ~200)
function logGamma(z){
  const p = [
    676.5203681218851,
    -1259.1392167224028,
    771.3234287776531,
    -176.6150291621406,
    12.507343278686905,
    -0.13857109526572012,
    9.984369578019571e-6,
    1.5056327351493116e-7
  ];
  if(z < 0.5){
    // reflection
    return Math.log(Math.PI) - Math.log(Math.sin(Math.PI*z)) - logGamma(1 - z);
  }
  z -= 1;
  let x = 0.99999999999980993;
  for(let i=0;i<p.length;i++){
    x += p[i] / (z + i + 1);
  }
  const t = z + p.length - 0.5;
  return 0.5*Math.log(2*Math.PI) + (z+0.5)*Math.log(t) - t + Math.log(x);
}
function logFactorial(n){
  return logGamma(n+1);
}
function logChoose(n,k){
  if(k<0 || k>n) return -Infinity;
  return logFactorial(n) - logFactorial(k) - logFactorial(n-k);
}

// Laguerre polynomial L_n(-x) for x>=0 using series: sum_{k=0}^n C(n,k) x^k / k!
function laguerreNeg(n, x){
  if(n===0) return 1;
  if(x===0) return 1;
  let sum = 0;
  for(let k=0;k<=n;k++){
    const logTerm = logChoose(n,k) + k*Math.log(x) - logFactorial(k);
    sum += Math.exp(logTerm);
  }
  return sum;
}

// Photon-number distribution
function p_n(n, nASE, nS){
  if(nASE <= 0){
    // Poisson limit: p(n)=e^{-nS} nS^n / n!
    const logp = -nS + (n===0 ? 0 : n*Math.log(nS)) - logFactorial(n);
    return Math.exp(logp);
  }
  const denom = 1 + nASE;
  const x = (nS / nASE) / denom; // positive
  const L = laguerreNeg(n, x);
  const logPref = n*Math.log(nASE) - (n+1)*Math.log(denom) - nS/denom;
  return Math.exp(logPref) * L;
}

// Moments and Fano factor from derived formulas
function moments(nASE, nS){
  const mean = nASE + nS;
  const variance = mean + nASE*nASE + 2*nS*nASE;
  const fano = variance / (mean>0?mean:1);
  return {mean, variance, fano};
}

/* =========================
   Canvas plotting utilities
========================= */
function setupCanvas(canvas){
  const dpr = window.devicePixelRatio || 1;
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(2, Math.floor(rect.width * dpr));
  const h = Math.max(2, Math.floor(rect.height * dpr));
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w; canvas.height = h;
  }
  const ctx = canvas.getContext("2d");
  ctx.setTransform(1,0,0,1,0,0);
  ctx.scale(dpr, dpr);
  return {ctx, width: rect.width, height: rect.height, dpr};
}

function clear(ctx, w, h){
  ctx.clearRect(0,0,w,h);
}

function drawPanel(ctx, w, h){
  // soft background
  ctx.save();
  ctx.fillStyle = "rgba(9,12,20,0.55)";
  ctx.fillRect(0,0,w,h);
  ctx.restore();
}

function drawAxes(ctx, w, h, plot, title){
  // plot: {xMin,xMax,yMin,yMax, padL,padR,padT,padB, xLabel, yLabel}
  const padL = plot.padL, padR=plot.padR, padT=plot.padT, padB=plot.padB;
  const x0 = padL, y0 = h - padB;
  const x1 = w - padR, y1 = padT;

  // title
  ctx.save();
  ctx.fillStyle = "rgba(232,238,252,0.95)";
  ctx.font = "600 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText(title, padL, 16);
  ctx.restore();

  // gridlines + ticks
  ctx.save();
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 1;

  const nx=6, ny=5;
  for(let i=0;i<=nx;i++){
    const x = x0 + (x1-x0)*i/nx;
    ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y1); ctx.stroke();
  }
  for(let j=0;j<=ny;j++){
    const y = y0 - (y0-y1)*j/ny;
    ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
  }
  ctx.restore();

  // axes lines
  ctx.save();
  ctx.strokeStyle = "rgba(255,255,255,0.35)";
  ctx.lineWidth = 1.2;
  ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y0); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x0,y1); ctx.stroke();
  ctx.restore();

  // labels
  ctx.save();
  ctx.fillStyle = "rgba(184,195,230,0.95)";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  ctx.fillText(plot.xLabel, (x0+x1)/2 - ctx.measureText(plot.xLabel).width/2, h-6);

  // y label rotated
  ctx.translate(12, (y0+y1)/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(plot.yLabel, 0 - ctx.measureText(plot.yLabel).width/2, 0);
  ctx.restore();

  // numeric tick labels
  ctx.save();
  ctx.fillStyle = "rgba(184,195,230,0.9)";
  ctx.font = "11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";

  function fmt(v){
    const av = Math.abs(v);
    if(av>=100) return v.toFixed(0);
    if(av>=10) return v.toFixed(1);
    if(av>=1) return v.toFixed(2);
    return v.toFixed(3);
  }
  for(let i=0;i<=nx;i++){
    const x = x0 + (x1-x0)*i/nx;
    const xv = plot.xMin + (plot.xMax-plot.xMin)*i/nx;
    const s = fmt(xv);
    ctx.fillText(s, x-ctx.measureText(s).width/2, y0+14);
  }
  for(let j=0;j<=ny;j++){
    const y = y0 - (y0-y1)*j/ny;
    const yv = plot.yMin + (plot.yMax-plot.yMin)*j/ny;
    const s = fmt(yv);
    ctx.fillText(s, x0-8-ctx.measureText(s).width, y+4);
  }
  ctx.restore();

  return {x0,y0,x1,y1};
}

function mapX(x, x0, x1, xMin, xMax){
  return x0 + (x-xMin)/(xMax-xMin) * (x1-x0);
}
function mapY(y, y0, y1, yMin, yMax){
  return y0 - (y-yMin)/(yMax-yMin) * (y0-y1);
}

function drawLine(ctx, pts, strokeStyle, lineWidth){
  if(pts.length<2) return;
  ctx.save();
  ctx.strokeStyle = strokeStyle;
  ctx.lineWidth = lineWidth;
  ctx.beginPath();
  ctx.moveTo(pts[0].x, pts[0].y);
  for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
  ctx.stroke();
  ctx.restore();
}

function drawMarker(ctx, x, y, color){
  ctx.save();
  ctx.fillStyle = color;
  ctx.beginPath(); ctx.arc(x,y,4,0,2*Math.PI); ctx.fill();
  ctx.strokeStyle = "rgba(0,0,0,0.45)";
  ctx.lineWidth = 2;
  ctx.stroke();
  ctx.restore();
}

function drawLegend(ctx, x, y, items){
  ctx.save();
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillStyle = "rgba(232,238,252,0.95)";
  const pad=10, lineH=18;
  let maxW=0;
  for(const it of items){
    maxW=Math.max(maxW, ctx.measureText(it.label).width);
  }
  const boxW = 26 + maxW + pad*2;
  const boxH = items.length*lineH + pad*2;
  ctx.fillStyle = "rgba(0,0,0,0.35)";
  ctx.strokeStyle = "rgba(255,255,255,0.12)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  roundRect(ctx, x, y, boxW, boxH, 12);
  ctx.fill(); ctx.stroke();

  for(let i=0;i<items.length;i++){
    const yy = y + pad + i*lineH + 12;
    ctx.strokeStyle = items[i].color;
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(x+pad, yy-4); ctx.lineTo(x+pad+18, yy-4); ctx.stroke();
    ctx.fillStyle="rgba(232,238,252,0.95)";
    ctx.fillText(items[i].label, x+pad+26, yy);
  }
  ctx.restore();
}

function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
}

/* =========================
   Diagram canvas
========================= */
function drawDiagram(){
  const canvas = document.getElementById("diagram");
  const {ctx, width:w, height:h} = setupCanvas(canvas);
  clear(ctx,w,h);
  drawPanel(ctx,w,h);

  // coordinate area
  const cx = w*0.30, cy = h*0.55;
  const R = Math.min(w,h)*0.22;

  // axes
  ctx.save();
  ctx.strokeStyle = "rgba(255,255,255,0.18)";
  ctx.lineWidth = 1;
  ctx.beginPath(); ctx.moveTo(cx-R, cy); ctx.lineTo(cx+R, cy); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(cx, cy+R); ctx.lineTo(cx, cy-R); ctx.stroke();
  ctx.restore();

  // coherent vector (fixed)
  const angS = -0.2;
  const sx = cx + R*0.95*Math.cos(angS);
  const sy = cy + R*0.95*Math.sin(angS);

  // random ASE vector (draw a sample phasor for illustration)
  const angN = 1.7;
  const nx = cx + R*0.60*Math.cos(angN);
  const ny = cy + R*0.60*Math.sin(angN);

  // sum vector
  const tx = cx + (sx-cx) + (nx-cx);
  const ty = cy + (sy-cy) + (ny-cy);

  function arrow(x0,y0,x1,y1,color){
    ctx.save();
    ctx.strokeStyle=color;
    ctx.lineWidth=3;
    ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.stroke();
    // head
    const dx=x1-x0, dy=y1-y0;
    const L=Math.hypot(dx,dy)||1;
    const ux=dx/L, uy=dy/L;
    const hx=x1-12*ux, hy=y1-12*uy;
    const px=-uy, py=ux;
    ctx.fillStyle=color;
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(hx+6*px, hy+6*py);
    ctx.lineTo(hx-6*px, hy-6*py);
    ctx.closePath(); ctx.fill();
    ctx.restore();
  }

  // vectors
  arrow(cx,cy,sx,sy,"rgba(122,162,255,0.95)");
  arrow(cx,cy,nx,ny,"rgba(98,210,162,0.95)");
  arrow(cx,cy,tx,ty,"rgba(255,204,102,0.95)");

  // labels
  ctx.save();
  ctx.fillStyle="rgba(232,238,252,0.95)";
  ctx.font="600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText("Signal phasor E_s (fixed)", cx- R, cy-R-8);
  ctx.fillStyle="rgba(184,195,230,0.95)";
  ctx.font="12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  ctx.fillText("ASE phasor E_n (random)", cx- R, cy+R+18);
  ctx.fillText("Total field E = E_s + E_n", cx- R, cy+R+36);
  ctx.restore();

  // right-side block: detector chain
  const bx = w*0.58, by = h*0.20, bw = w*0.36, bh = h*0.62;
  ctx.save();
  ctx.fillStyle="rgba(0,0,0,0.30)";
  ctx.strokeStyle="rgba(255,255,255,0.12)";
  ctx.lineWidth=1;
  ctx.beginPath();
  roundRect(ctx,bx,by,bw,bh,16);
  ctx.fill(); ctx.stroke();
  ctx.restore();

  // simple boxes
  function box(x,y,ww,hh,label,sub){
    ctx.save();
    ctx.fillStyle="rgba(16,24,42,0.65)";
    ctx.strokeStyle="rgba(255,255,255,0.14)";
    ctx.lineWidth=1;
    ctx.beginPath(); roundRect(ctx,x,y,ww,hh,14);
    ctx.fill(); ctx.stroke();
    ctx.fillStyle="rgba(232,238,252,0.95)";
    ctx.font="600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    ctx.fillText(label, x+12, y+22);
    ctx.fillStyle="rgba(184,195,230,0.95)";
    ctx.font="12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
    ctx.fillText(sub, x+12, y+42);
    ctx.restore();
  }
  box(bx+14, by+14, bw-28, 54, "Amplifier output energy", "w fluctuates");
  box(bx+14, by+84, bw-28, 54, "Energy PDF", "noncentral χ² (Bessel I0)");
  box(bx+14, by+154, bw-28, 54, "Photon counting", "n | w ~ Poisson(w/ħω)");
  box(bx+14, by+224, bw-28, 54, "Unconditional p(n)", "Laguerre / NNB form");

  // arrows between boxes
  function downArrow(x,y){
    ctx.save();
    ctx.strokeStyle="rgba(255,255,255,0.25)";
    ctx.lineWidth=2;
    ctx.beginPath(); ctx.moveTo(x,y); ctx.lineTo(x,y+18); ctx.stroke();
    ctx.fillStyle="rgba(255,255,255,0.25)";
    ctx.beginPath(); ctx.arc(x,y+20,3,0,2*Math.PI); ctx.fill();
    ctx.restore();
  }
  const ax = bx + bw/2;
  downArrow(ax, by+68);
  downArrow(ax, by+138);
  downArrow(ax, by+208);

  // title
  ctx.save();
  ctx.fillStyle="rgba(232,238,252,0.95)";
  ctx.font="700 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText("Physical model (phasor + detection chain)", 14, 18);
  ctx.restore();
}

/* =========================
   Plots
========================= */
function computePNSeries(nASE, nS){
  const {mean, variance} = moments(nASE, nS);
  const sigma = Math.sqrt(Math.max(variance, 1e-12));
  const nMax = Math.max(25, Math.min(220, Math.ceil(mean + 6*sigma)));
  const arr = [];
  let sum=0;
  for(let n=0;n<=nMax;n++){
    const p = p_n(n, nASE, nS);
    arr.push({n, p});
    sum += p;
  }
  // normalize for numerical drift
  if(sum>0){
    for(let i=0;i<arr.length;i++) arr[i].p /= sum;
  }
  return arr;
}

function drawMainPlot(nASE, r){
  const nS = r * nASE;
  const canvas = document.getElementById("plotMain");
  const {ctx, width:w, height:h} = setupCanvas(canvas);
  clear(ctx,w,h);
  drawPanel(ctx,w,h);

  const series = computePNSeries(nASE, nS);
  const nMax = series[series.length-1].n;
  let pMax = 0;
  for(const d of series) pMax = Math.max(pMax, d.p);
  pMax = Math.max(pMax, 1e-6);

  const plot = {
    xMin: 0, xMax: nMax,
    yMin: 0, yMax: pMax*1.10,
    padL: 56, padR: 16, padT: 30, padB: 34,
    xLabel: "n  (photons)",
    yLabel: "p(n)"
  };
  const ax = drawAxes(ctx,w,h,plot, "Photon-number distribution p(n)");

  // draw as line + light bars
  // bars
  ctx.save();
  ctx.fillStyle = "rgba(122,162,255,0.18)";
  const barW = Math.max(1, (ax.x1-ax.x0) / (nMax+1) * 0.9);
  for(const d of series){
    const x = mapX(d.n, ax.x0, ax.x1, plot.xMin, plot.xMax);
    const y = mapY(d.p, ax.y0, ax.y1, plot.yMin, plot.yMax);
    ctx.fillRect(x - barW/2, y, barW, ax.y0 - y);
  }
  ctx.restore();

  // line
  const pts = series.map(d=>({
    x: mapX(d.n, ax.x0, ax.x1, plot.xMin, plot.xMax),
    y: mapY(d.p, ax.y0, ax.y1, plot.yMin, plot.yMax)
  }));
  drawLine(ctx, pts, "rgba(122,162,255,0.95)", 2.2);

  // legend
  drawLegend(ctx, w-235, 42, [
    {label: `n_ASE=${nASE.toFixed(0)},  r=${r.toFixed(2)}  (n_s=${(nS).toFixed(2)})`, color:"rgba(122,162,255,0.95)"}
  ]);
}

function drawSecondaryPlot(nASE, rNow){
  const canvas = document.getElementById("plotSecondary");
  const {ctx, width:w, height:h} = setupCanvas(canvas);
  clear(ctx,w,h);
  drawPanel(ctx,w,h);

  // sweep r from 0 to 2.5
  const rMin=0, rMax=2.5;
  const pts = [];
  let fMax=0;
  for(let i=0;i<=200;i++){
    const r = rMin + (rMax-rMin)*i/200;
    const nS = r*nASE;
    const {fano} = moments(nASE, nS);
    fMax = Math.max(fMax, fano);
    pts.push({r, fano});
  }
  const plot = {
    xMin: rMin, xMax: rMax,
    yMin: 0.9, yMax: Math.max(1.2, fMax*1.08),
    padL: 56, padR: 16, padT: 30, padB: 34,
    xLabel: "r = n_s / n_ASE  (dimensionless)",
    yLabel: "F = Var(n)/n̄"
  };
  const ax = drawAxes(ctx,w,h,plot, "Parameter sweep: Fano factor vs r");

  const ptsMapped = pts.map(d=>({
    x: mapX(d.r, ax.x0, ax.x1, plot.xMin, plot.xMax),
    y: mapY(d.fano, ax.y0, ax.y1, plot.yMin, plot.yMax)
  }));
  drawLine(ctx, ptsMapped, "rgba(98,210,162,0.95)", 2.4);

  // marker at current r
  const nSNow = rNow*nASE;
  const {fano: fNow} = moments(nASE, nSNow);
  const xm = mapX(rNow, ax.x0, ax.x1, plot.xMin, plot.xMax);
  const ym = mapY(fNow, ax.y0, ax.y1, plot.yMin, plot.yMax);
  drawMarker(ctx, xm, ym, "rgba(255,204,102,0.95)");

  drawLegend(ctx, w-250, 42, [
    {label:`Sweep (n_ASE=${nASE.toFixed(0)})`, color:"rgba(98,210,162,0.95)"},
    {label:`Current r=${rNow.toFixed(2)}`, color:"rgba(255,204,102,0.95)"}
  ]);
}

/* =========================
   UI wiring
========================= */
const ratioEl = document.getElementById("ratio");
const naseEl = document.getElementById("nase");
const presetEl = document.getElementById("preset");
const ratioReadout = document.getElementById("ratioReadout");
const naseReadout = document.getElementById("naseReadout");
const statsReadout = document.getElementById("statsReadout");

function update(){
  const nASE = parseFloat(naseEl.value);
  let r = parseFloat(ratioEl.value);

  // preset selection overrides slider
  const preset = presetEl.value;
  if(preset !== "custom"){
    r = parseFloat(preset);
    ratioEl.value = r.toFixed(2);
  }

  ratioReadout.textContent = `r = ${r.toFixed(2)}`;
  naseReadout.textContent = `n_ASE = ${nASE.toFixed(0)}`;

  const nS = r*nASE;
  const m = moments(nASE, nS);
  statsReadout.textContent =
    `n_s=${nS.toFixed(2)}  |  n̄=${m.mean.toFixed(2)}  |  Var=${m.variance.toFixed(2)}  |  F=${m.fano.toFixed(2)}`;

  drawDiagram();
  drawMainPlot(nASE, r);
  drawSecondaryPlot(nASE, r);
}

ratioEl.addEventListener("input", ()=>{
  presetEl.value="custom";
  update();
});
naseEl.addEventListener("change", ()=>update());
presetEl.addEventListener("change", ()=>update());

window.addEventListener("resize", ()=>update());

// initial render
update();
</script>
</body>
</html>
