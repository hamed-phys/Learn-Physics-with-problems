<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Two Laser Lines in a Four-Level Atomic System — Rate Equations, Steady State, and Competing Inversions</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#111a2a;
      --panel2:#0f1626;
      --text:#e9eef7;
      --muted:#b9c4da;
      --faint:#7f8aa3;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --ok:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 25%, rgba(167,139,250,.16), transparent 55%),
        radial-gradient(900px 700px at 50% 90%, rgba(52,211,153,.08), transparent 60%),
        var(--bg);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding:28px 18px 18px;
      border-bottom:1px solid var(--line);
      position:relative;
      overflow:hidden;
    }
    header .wrap{
      max-width:1200px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap:18px;
      align-items:start;
    }
    h1{
      margin:0 0 10px 0;
      font-size:clamp(1.6rem, 2.7vw, 2.4rem);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      margin:0;
      font-size:1.02rem;
      max-width:70ch;
    }
    .badgeRow{
      display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end;
      padding-top:6px;
    }
    .pill{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      padding:8px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:.86rem;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
      white-space:nowrap;
    }
    main{
      max-width:1200px;
      margin:0 auto;
      padding:20px 18px 60px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:18px;
      align-items:start;
    }
    nav.toc{
      position:sticky;
      top:12px;
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius:var(--radius);
      padding:14px 14px 10px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    nav.toc h2{
      margin:0 0 10px 0;
      font-size:1.0rem;
      color:var(--text);
    }
    nav.toc a{
      display:block;
      padding:7px 10px;
      border-radius:12px;
      color:var(--muted);
      font-size:.92rem;
      border:1px solid transparent;
    }
    nav.toc a:hover{
      background:rgba(125,211,252,.08);
      border-color:rgba(125,211,252,.18);
      color:var(--text);
      text-decoration:none;
    }
    .content{
      display:flex;
      flex-direction:column;
      gap:18px;
      min-width:0;
    }
    section, article{
      border:1px solid var(--line);
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius:var(--radius);
      padding:18px 18px 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    section h2{
      margin:0 0 10px 0;
      font-size:1.25rem;
      letter-spacing:.2px;
    }
    section h3{
      margin:18px 0 10px 0;
      font-size:1.08rem;
      color:var(--text);
    }
    p{margin:10px 0; color:var(--muted)}
    ul,ol{margin:10px 0 10px 20px; color:var(--muted)}
    li{margin:6px 0}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
    }
    .card{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:16px;
      padding:12px 12px 10px;
    }
    .callout{
      border-left:4px solid var(--accent);
      background:rgba(125,211,252,.08);
      padding:12px 12px 10px;
      border-radius:14px;
      margin:12px 0;
    }
    .callout.warn{border-left-color:var(--warn); background:rgba(251,191,36,.08)}
    .callout.ok{border-left-color:var(--ok); background:rgba(52,211,153,.08)}
    .callout.bad{border-left-color:var(--bad); background:rgba(251,113,133,.09)}
    .eq{
      position:relative;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      border-radius:14px;
      padding:12px 44px 10px 12px;
      margin:10px 0;
      overflow:hidden;
    }
    .eq pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family:var(--mono);
      font-size:.92rem;
      color:#f2f6ff;
      line-height:1.35;
    }
    .copyBtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      border-radius:10px;
      padding:7px 10px;
      font-size:.82rem;
      cursor:pointer;
      transition: transform .08s ease, background .15s ease, border-color .15s ease;
      user-select:none;
    }
    .copyBtn:hover{
      background:rgba(125,211,252,.10);
      border-color:rgba(125,211,252,.22);
    }
    .copyBtn:active{transform:scale(.98)}
    .mini{
      font-size:.92rem;
      color:var(--muted);
    }
    .kpiRow{
      display:grid;
      grid-template-columns: repeat(4, 1fr);
      gap:10px;
      margin-top:10px;
    }
    .kpi{
      border:1px solid var(--line);
      background:rgba(0,0,0,.20);
      border-radius:14px;
      padding:10px 10px 8px;
      min-height:72px;
    }
    .kpi .label{color:var(--faint); font-size:.82rem}
    .kpi .val{font-family:var(--mono); font-size:1.0rem; margin-top:6px}
    .kpi .hint{color:var(--muted); font-size:.82rem; margin-top:6px}
    figure{
      margin:0;
      border:1px solid var(--line);
      background:rgba(0,0,0,.22);
      border-radius:16px;
      padding:10px;
      overflow:hidden;
    }
    figcaption{
      margin-top:8px;
      color:var(--muted);
      font-size:.9rem;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius:14px;
      background:rgba(0,0,0,.14);
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .ctrl{
      border:1px solid var(--line);
      background:rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px 10px 8px;
    }
    .ctrl label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:.9rem;
      margin-bottom:8px;
    }
    .ctrl .readout{
      font-family:var(--mono);
      color:#f2f6ff;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    select{
      width:100%;
      border-radius:12px;
      border:1px solid var(--line);
      background:rgba(255,255,255,.06);
      color:var(--text);
      padding:10px;
      outline:none;
    }
    .footer{
      max-width:1200px;
      margin:0 auto;
      padding:20px 18px 40px;
      color:var(--faint);
      font-size:.9rem;
    }
    .hr{
      height:1px;
      background:var(--line);
      margin:12px 0;
    }
    .note{
      color:var(--muted);
      font-size:.92rem;
    }
    .boxedFinal{
      border:1px solid rgba(52,211,153,.30);
      background:rgba(52,211,153,.08);
      border-radius:16px;
      padding:14px 14px 10px;
      margin-top:10px;
      position:relative;
    }
    .boxedFinal h3{margin:0 0 8px 0}
    .boxedFinal .eq{margin:10px 0 0 0}
    @media (max-width: 980px){
      header .wrap{grid-template-columns:1fr}
      .badgeRow{justify-content:flex-start}
      main{grid-template-columns:1fr}
      nav.toc{position:relative; top:auto}
      canvas{height:300px}
      .kpiRow{grid-template-columns:1fr 1fr}
      .controls{grid-template-columns:1fr}
    }
    @media print{
      body{background:#fff; color:#000}
      header, nav.toc, .controls, .copyBtn{display:none !important}
      section, article, figure{box-shadow:none; background:#fff; border:1px solid #ccc}
      p,li{color:#000}
      .eq{background:#f7f7f7}
      canvas{display:none}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div>
      <h1>Two Laser Lines in a Four-Level System: Coupled Rate Equations, Steady State, and Competing Inversions</h1>
      <p class="subtitle">
        We analyze a 4-level atomic system with <span style="color:var(--text)">two pumps</span> (0→3 and 0→2) and <span style="color:var(--text)">two possible laser transitions</span> (3→1 and 2→1).
        You’ll derive the rate equations, solve steady-state populations symbolically, and see how radiation on one transition can suppress inversion on the other through a shared lower level.
      </p>
    </div>
    <div class="badgeRow">
      <div class="pill">Topic: Laser rate equations</div>
      <div class="pill">Core idea: shared lower level coupling</div>
      <div class="pill">Outputs: symbolic steady state + inversion conditions</div>
    </div>
  </div>
</header>

<main>
  <nav class="toc" aria-label="Table of contents">
    <h2>Table of Contents</h2>
    <a href="#quick">Quick Summary</a>
    <a href="#part0">PART 0 — Concept Primer</a>
    <a href="#part1">PART 1 — Problem Analysis</a>
    <a href="#part2">PART 2 — Strategy & Tips</a>
    <a href="#part3">PART 3 — Full Solution</a>
    <a href="#part4">PART 4 — Deeper Understanding</a>
    <a href="#part5">PART 5 — Visualization Guide</a>
  </nav>

  <div class="content">

    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>System:</b> 4 levels {0,1,2,3}. Pumps drive <b>0→3</b> at rate <b>R<sub>3</sub></b> and <b>0→2</b> at rate <b>R<sub>2</sub></b>.</li>
        <li><b>Laser lines:</b> possible stimulated transitions <b>3→1</b> and <b>2→1</b> (shared lower level 1).</li>
        <li><b>Key physics:</b> rate equations + conservation <b>N = N<sub>0</sub>+N<sub>1</sub>+N<sub>2</sub>+N<sub>3</sub></b> → coupled linear steady-state solution.</li>
        <li><b>Governing tools:</b> pumping terms (∝N<sub>0</sub>), spontaneous decay with lifetimes (τ), and radiation-induced net rates <b>W<sub>31</sub>, W<sub>21</sub></b> (stimulated emission/absorption).</li>
        <li><b>Steady state:</b> closed-form symbolic expressions for <b>N<sub>0</sub>, N<sub>1</sub>, N<sub>2</sub>, N<sub>3</sub></b> in terms of <b>R<sub>2</sub>, R<sub>3</sub>, τ<sub>1</sub>, τ<sub>21</sub>, τ<sub>31</sub>, W<sub>21</sub>, W<sub>31</sub></b>.</li>
        <li><b>Simultaneous inversions:</b> require <b>N<sub>3</sub>−N<sub>1</sub> &gt; 0</b> and <b>N<sub>2</sub>−N<sub>1</sub> &gt; 0</b>, giving simple inequality conditions on pump/lifetimes.</li>
        <li><b>Competition result:</b> increasing radiation on <b>2→1</b> (raising W<sub>21</sub>) typically increases population flow into level 1 and can <b>reduce the inversion</b> on <b>3→1</b>; a clean derivative criterion shows when this suppression is guaranteed.</li>
      </ul>
    </section>

    <section id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <h3>Core definitions (symbols + units)</h3>
      <div class="grid2">
        <div class="card">
          <p class="mini"><b>Populations</b></p>
          <ul>
            <li>N<sub>i</sub> = population density (or fraction) in level i (units: m<sup>−3</sup> or dimensionless if normalized)</li>
            <li>N = total population density (constant): N = Σ N<sub>i</sub></li>
          </ul>
        </div>
        <div class="card">
          <p class="mini"><b>Rates and lifetimes</b></p>
          <ul>
            <li>R<sub>3</sub>, R<sub>2</sub> = pump rates out of level 0 (units: s<sup>−1</sup>)</li>
            <li>τ<sub>31</sub>, τ<sub>21</sub> = spontaneous lifetimes for 3→1 and 2→1 (units: s)</li>
            <li>τ<sub>1</sub> = lifetime for 1→0 (units: s)</li>
            <li>W<sub>31</sub>, W<sub>21</sub> = radiation-induced coupling coefficients (units: s<sup>−1</sup>)</li>
          </ul>
        </div>
      </div>

      <h3>Physical meaning (what these quantities represent)</h3>
      <ul>
        <li><b>Pumps:</b> move atoms from ground (0) into upper manifolds (3 and 2). In a simple “rate” picture, pump flow is proportional to how many atoms remain in 0: pump term = R·N<sub>0</sub>.</li>
        <li><b>Lifetimes:</b> summarize spontaneous decay channels: e.g. level 3 empties to level 1 at rate N<sub>3</sub>/τ<sub>31</sub>.</li>
        <li><b>Radiation-induced rates:</b> in semiclassical laser theory, an optical field at the transition frequency drives <i>both</i> stimulated emission and absorption. Net flow is proportional to the <b>population difference</b> (inversion):
          net(3↔1) ∝ (N<sub>3</sub> − N<sub>1</sub>), net(2↔1) ∝ (N<sub>2</sub> − N<sub>1</sub>).
        </li>
      </ul>

      <div class="callout">
        <b>Key idea:</b> If two transitions share the same lower level (here level 1), radiation on one line can change N<sub>1</sub>, which changes the inversion of the other line.
      </div>

      <h3>Laws/principles and validity</h3>
      <ul>
        <li><b>Rate-equation (population) model:</b> valid when coherence can be ignored and we track only average populations (typical for many laser steady-state analyses).</li>
        <li><b>Population conservation:</b> total N constant if no ionization/creation: Σ dN<sub>i</sub>/dt = 0.</li>
        <li><b>Assumptions used in this problem:</b> no 3→2 decay; negligible 3→0 and 2→0 decay; only 1→0 matters for returning population to ground.</li>
      </ul>

      <h3>Common models/approximations (why we use them)</h3>
      <ul>
        <li><b>Linear stimulated rate model:</b> W<sub>ij</sub>(N<sub>i</sub>−N<sub>j</sub>) is a compact way to represent net induced transitions when degeneracies are ignored (or absorbed into W).</li>
        <li><b>Steady state:</b> set time derivatives to zero to find long-time populations that determine whether inversion exists.</li>
      </ul>

      <h3>Mini intuition examples (no long algebra)</h3>
      <ul>
        <li>If τ<sub>1</sub> is very small (fast 1→0), level 1 stays nearly empty → inversions are easier.</li>
        <li>If strong radiation drives 2→1, it can dump population into level 1, raising N<sub>1</sub> and making it harder for 3 to exceed 1 (hurting 3→1 gain).</li>
      </ul>

      <h3>What to watch for (pitfalls)</h3>
      <ul>
        <li>For stimulated terms, remember the sign: net induced flow from i→j is <b>+W(N<sub>i</sub>−N<sub>j</sub>)</b> into j and <b>−W(N<sub>i</sub>−N<sub>j</sub>)</b> out of i.</li>
        <li>Don’t forget population conservation when eliminating N<sub>1</sub>.</li>
        <li>Simultaneous inversion conditions must be checked against physical positivity of all populations.</li>
      </ul>
    </section>

    <section id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Rewrite the problem in plain language</h3>
      <p>
        We have an atomic system with four energy levels 0 (ground), 1, 2, 3. Two pumps excite atoms from level 0 to levels 3 and 2 at rates R<sub>3</sub> and R<sub>2</sub>, respectively.
        There is no decay from 3 to 2. Decays from 3 and 2 directly to the ground are negligible. Population inversion may occur on either transition 3→1 or 2→1 (two possible laser lines).
        Using lifetimes τ<sub>1</sub>, τ<sub>31</sub>, τ<sub>21</sub>, we must:
        (i) write rate equations (for 0,2,3 using elimination),
        (ii) find steady-state N<sub>1</sub>, N<sub>2</sub>, N<sub>3</sub>,
        (iii) assess simultaneous inversions,
        (iv) show radiation on 2→1 reduces the population difference for 3→1.
      </p>

      <div class="grid2">
        <div class="card">
          <p class="mini"><b>Given</b></p>
          <ul>
            <li>Levels: 0,1,2,3</li>
            <li>Pumps: 0→3 at R<sub>3</sub>, 0→2 at R<sub>2</sub></li>
            <li>Spontaneous lifetimes: τ<sub>31</sub> (3→1), τ<sub>21</sub> (2→1), τ<sub>1</sub> (1→0)</li>
            <li>No 3→2; negligible 3→0 and 2→0</li>
          </ul>
        </div>
        <div class="card">
          <p class="mini"><b>Unknowns</b></p>
          <ul>
            <li>N<sub>0</sub>, N<sub>1</sub>, N<sub>2</sub>, N<sub>3</sub>(t)</li>
            <li>Steady-state values and inversion conditions</li>
            <li>Effect of radiation (modeled by W<sub>31</sub>, W<sub>21</sub>)</li>
          </ul>
        </div>
      </div>

      <h3>Relevant principles (and why they apply)</h3>
      <ul>
        <li><b>Population rate equations:</b> Because the problem is about pumps, decays, and inversions (not coherence), a kinetic population model is the natural tool.</li>
        <li><b>Steady-state analysis:</b> Laser operation and inversion thresholds are typically determined by long-time fixed points.</li>
        <li><b>Coupling via shared level:</b> Both laser lines terminate in level 1, so anything that changes N<sub>1</sub> modifies both inversions.</li>
      </ul>

      <div class="callout warn">
        <b>Assumptions (explicit):</b>
        <ul>
          <li>Total population N is constant.</li>
          <li>Only decay paths are 3→1, 2→1, and 1→0 (as specified).</li>
          <li>No 3→2 decay.</li>
          <li>Radiation on a transition is represented by a net induced rate W (stimulated emission minus absorption), proportional to the population difference.</li>
          <li>Degeneracy factors are ignored or absorbed into W (so the net term is W(N<sub>upper</sub>−N<sub>lower</sub>)).</li>
        </ul>
      </div>

      <h3>Possible approaches (compare briefly)</h3>
      <ol>
        <li><b>Direct 4-equation solve:</b> write dN<sub>0</sub>/dt…dN<sub>3</sub>/dt and solve steady state with ΣN<sub>i</sub>=N. (Straightforward, but slightly redundant.)</li>
        <li><b>Eliminate N<sub>1</sub> early:</b> use N<sub>1</sub>=N−N<sub>0</sub>−N<sub>2</sub>−N<sub>3</sub> and write only equations for (0,2,3). (Compact and matches the problem request.)</li>
        <li><b>Matrix form:</b> express steady state as A·x=b and solve symbolically. (Clean for algebra, best for teaching.)</li>
      </ol>
      <p><b>Choice:</b> We will eliminate N<sub>1</sub> and solve the resulting linear system in matrix form, because it directly delivers the requested rate equations for levels 0,2,3 and gives a transparent steady-state solution.</p>
    </section>

    <section id="part2">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>
      <ol>
        <li><b>Define all populations</b> N<sub>0</sub>…N<sub>3</sub> and conservation N=ΣN<sub>i</sub>. <span class="note">Physically: closed atomic ensemble.</span></li>
        <li><b>Write pumping flows</b> 0→3 and 0→2 as R<sub>3</sub>N<sub>0</sub> and R<sub>2</sub>N<sub>0</sub>. <span class="note">Physically: pump needs atoms in 0.</span></li>
        <li><b>Write spontaneous decays</b> 3→1: N<sub>3</sub>/τ<sub>31</sub>, 2→1: N<sub>2</sub>/τ<sub>21</sub>, 1→0: N<sub>1</sub>/τ<sub>1</sub>.</li>
        <li><b>Add radiation-induced terms</b> W<sub>31</sub>(N<sub>3</sub>−N<sub>1</sub>) and W<sub>21</sub>(N<sub>2</sub>−N<sub>1</sub>) with correct signs in each level’s equation.</li>
        <li><b>Eliminate N<sub>1</sub></b> using N<sub>1</sub>=N−N<sub>0</sub>−N<sub>2</sub>−N<sub>3</sub>, giving equations only in N<sub>0</sub>, N<sub>2</sub>, N<sub>3</sub>.</li>
        <li><b>Set steady state</b> (d/dt=0) and solve the 3 linear equations for N<sub>0</sub>, N<sub>2</sub>, N<sub>3</sub>.</li>
        <li><b>Recover N<sub>1</sub></b> from conservation.</li>
        <li><b>Form inversions</b> Δ<sub>31</sub>=N<sub>3</sub>−N<sub>1</sub>, Δ<sub>21</sub>=N<sub>2</sub>−N<sub>1</sub>, then find conditions for both &gt;0.</li>
        <li><b>Competition proof</b> compute ∂Δ<sub>31</sub>/∂W<sub>21</sub> and interpret its sign: radiation on 2→1 modifies the shared level N<sub>1</sub>.</li>
      </ol>

      <div class="callout warn">
        <b>Common mistakes:</b>
        <ul>
          <li>Forgetting that pumps remove atoms from N<sub>0</sub> (negative term in dN<sub>0</sub>/dt).</li>
          <li>Putting stimulated terms only as “loss” from upper level (they are bidirectional; net depends on inversion).</li>
          <li>Checking inversion inequalities without ensuring populations remain positive and sum to N.</li>
        </ul>
      </div>
    </section>

    <section id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Qualitative expectation before calculating</h3>
      <p>
        Pumping out of level 0 fills levels 2 and 3. Those upper levels empty into level 1, and level 1 empties back to 0.
        If level 1 empties “fast enough” (small τ<sub>1</sub>) compared with how quickly levels 2 and 3 feed it, then N<sub>1</sub> stays small and inversions Δ<sub>31</sub> and Δ<sub>21</sub> can become positive.
        However, if radiation strongly drives 2↔1, it tends to push N<sub>2</sub> and N<sub>1</sub> toward each other and can also raise N<sub>1</sub>, which can reduce Δ<sub>31</sub>=N<sub>3</sub>−N<sub>1</sub>.
      </p>

      <h3>Step 1 — Write the full rate equations (all four levels)</h3>
      <p class="note">
        We include radiation-induced net rates for the two optical transitions:
        <b>W<sub>31</sub>(N<sub>3</sub>−N<sub>1</sub>)</b> and <b>W<sub>21</sub>(N<sub>2</sub>−N<sub>1</sub>)</b>.
        If W=0, that transition is “dark” (no applied radiation).
      </p>

      <div class="eq" id="eq-full">
        <button class="copyBtn" data-copy="#eq-full pre">Copy</button>
        <pre>
dN3/dt =  + R3 N0  - (N3/τ31) - W31 (N3 - N1)

dN2/dt =  + R2 N0  - (N2/τ21) - W21 (N2 - N1)

dN1/dt =  + (N3/τ31) + (N2/τ21) + W31 (N3 - N1) + W21 (N2 - N1) - (N1/τ1)

dN0/dt =  - R3 N0 - R2 N0 + (N1/τ1)

Constraint: N = N0 + N1 + N2 + N3  (constant)
        </pre>
      </div>

      <div class="callout ok">
        <b>Why the signs look like this:</b>
        <ul>
          <li>Whenever population leaves a level, that term is negative in that level’s equation.</li>
          <li>Spontaneous 3→1 adds to N<sub>1</sub> but removes from N<sub>3</sub>.</li>
          <li>Stimulated terms are bidirectional; net flow out of the upper level is W(N<sub>upper</sub>−N<sub>lower</sub>).</li>
        </ul>
      </div>

      <h3>Step 2 — Eliminate N<sub>1</sub> to get equations for levels 0, 2, 3</h3>
      <p>
        From conservation: <b>N<sub>1</sub> = N − N<sub>0</sub> − N<sub>2</sub> − N<sub>3</sub></b>.
        Substitute this into the (0,2,3) equations.
      </p>

      <div class="eq" id="eq-reduced">
        <button class="copyBtn" data-copy="#eq-reduced pre">Copy</button>
        <pre>
Let N1 = N - N0 - N2 - N3.

Then:

dN0/dt = - (R2 + R3) N0 + (1/τ1) (N - N0 - N2 - N3)

dN3/dt =   R3 N0 - (1/τ31 + W31) N3 + W31 (N - N0 - N2 - N3)

dN2/dt =   R2 N0 - (1/τ21 + W21) N2 + W21 (N - N0 - N2 - N3)
        </pre>
      </div>

      <div class="callout warn">
        <b>Important:</b> these equations are still exact within the stated assumptions. We have not approximated anything beyond the model and the given decay-path assumptions.
      </div>

      <h3>Step 3 — Solve the steady state</h3>
      <p>
        Set <b>dN<sub>0</sub>/dt = dN<sub>2</sub>/dt = dN<sub>3</sub>/dt = 0</b>. This gives a linear system in (N<sub>0</sub>, N<sub>2</sub>, N<sub>3</sub>), and then N<sub>1</sub> follows from conservation.
        Define a common positive denominator <b>D</b> (for compactness).
      </p>

      <div class="eq" id="eq-D">
        <button class="copyBtn" data-copy="#eq-D pre">Copy</button>
        <pre>
Define:

D =
  1 + W31 τ31 + W21 τ21 + W21 W31 τ21 τ31
+ R2 τ1 + R2 τ21 + R3 τ1 + R3 τ31
+ 2 R2 W31 τ1 τ31 + R2 W31 τ21 τ31 + 2 R3 W31 τ1 τ31
+ 2 R2 W21 τ1 τ21 + 2 R3 W21 τ1 τ21 + R3 W21 τ21 τ31
+ 3 R2 W21 W31 τ1 τ21 τ31 + 3 R3 W21 W31 τ1 τ21 τ31
        </pre>
      </div>

      <div class="boxedFinal" id="final">
        <h3>Steady-state populations (symbolic)</h3>
        <p class="note">These hold for any nonnegative rates and lifetimes, within the model assumptions.</p>

        <div class="eq" id="eq-final">
          <button class="copyBtn" data-copy="#eq-final pre">Copy</button>
          <pre>
N0 = N (1 + W21 τ21)(1 + W31 τ31) / D

N1 = N τ1 (R2 + R3)(1 + W21 τ21)(1 + W31 τ31) / D

N2 = N τ21 (1 + W31 τ31) [ R2 + (R2 + R3) W21 τ1 ] / D

N3 = N τ31 (1 + W21 τ21) [ R3 + (R2 + R3) W31 τ1 ] / D
          </pre>
        </div>

        <div class="eq" id="eq-inversions">
          <button class="copyBtn" data-copy="#eq-inversions pre">Copy</button>
          <pre>
Population differences (inversions):

Δ31 = N3 - N1 = N (1 + W21 τ21) [ R3 τ31 - (R2 + R3) τ1 ] / D

Δ21 = N2 - N1 = N (1 + W31 τ31) [ R2 τ21 - (R2 + R3) τ1 ] / D
          </pre>
        </div>
      </div>

      <h3>Sanity checks</h3>
      <div class="grid2">
        <div class="card">
          <p class="mini"><b>Units/dimensions</b></p>
          <ul>
            <li>R, W have units s<sup>−1</sup>; τ has units s.</li>
            <li>Products like Wτ and Rτ are dimensionless.</li>
            <li>D is dimensionless, so N<sub>i</sub> has same units as N.</li>
          </ul>
        </div>
        <div class="card">
          <p class="mini"><b>Limiting cases</b></p>
          <ul>
            <li>If R<sub>2</sub>=R<sub>3</sub>=0, then steady state gives N<sub>0</sub>=N and others 0.</li>
            <li>If τ<sub>1</sub>→0 (very fast 1→0), then N<sub>1</sub>→0 and inversions become easier.</li>
            <li>If W<sub>21</sub>→∞, the 2↔1 transition is strongly mixed, tending to reduce |N<sub>2</sub>−N<sub>1</sub>|.</li>
          </ul>
        </div>
      </div>

      <h3>Step 4 — Conditions for simultaneous population inversions</h3>
      <p>
        Since D&gt;0 and (1+Wτ)&gt;0, the <b>sign</b> of each inversion is controlled by the bracketed terms:
      </p>
      <div class="eq" id="eq-conds">
        <button class="copyBtn" data-copy="#eq-conds pre">Copy</button>
        <pre>
Δ31 > 0  ⇔  R3 τ31 > (R2 + R3) τ1

Δ21 > 0  ⇔  R2 τ21 > (R2 + R3) τ1
        </pre>
      </div>

      <p>
        Therefore, <b>simultaneous inversion on both lines</b> is possible if and only if:
      </p>
      <div class="eq" id="eq-both">
        <button class="copyBtn" data-copy="#eq-both pre">Copy</button>
        <pre>
R3 τ31 > (R2 + R3) τ1   AND   R2 τ21 > (R2 + R3) τ1.
        </pre>
      </div>

      <div class="callout">
        <b>Interpretation:</b> level 1 must empty fast enough (small τ<sub>1</sub>) compared with the “effective supply” from the pumped upper levels. Both pumped manifolds must be able to stay above level 1.
      </div>

      <h3>Step 5 — Show radiation on 2→1 reduces the 3→1 population difference</h3>
      <p>
        Radiation on the 2→1 transition is encoded by W<sub>21</sub>. From the closed-form inversion:
      </p>

      <div class="eq" id="eq-d31-form">
        <button class="copyBtn" data-copy="#eq-d31-form pre">Copy</button>
        <pre>
Δ31(W21) = N (1 + W21 τ21) [ R3 τ31 - (R2 + R3) τ1 ] / D(W21)
        </pre>
      </div>

      <p>
        Here D is <b>linear</b> in W<sub>21</sub>, so Δ<sub>31</sub>(W<sub>21</sub>) has the form
        <span style="font-family:var(--mono); color:#f2f6ff;">Δ31 = A (1 + W21 τ21)/(b + a W21)</span>,
        where A, a, b are positive constants for fixed (R, τ, W<sub>31</sub>).
        Differentiating shows the sign is independent of W<sub>21</sub>:
      </p>

      <div class="eq" id="eq-deriv">
        <button class="copyBtn" data-copy="#eq-deriv pre">Copy</button>
        <pre>
∂Δ31/∂W21  ∝  (τ21 b - a)
         = - τ21 (1 + W31 τ31) [ (R2 + R3) τ1 - R2 τ21 ].

So:

If (R2 + R3) τ1 > R2 τ21, then ∂Δ31/∂W21 < 0,
meaning increasing radiation on 2→1 decreases Δ31.
        </pre>
      </div>

      <div class="callout ok">
        <b>Physical picture of the suppression:</b>
        Driving 2↔1 with radiation tends to push N<sub>2</sub> toward N<sub>1</sub> (reducing Δ<sub>21</sub>) and can raise N<sub>1</sub> by feeding level 1 more effectively.
        Since Δ<sub>31</sub>=N<sub>3</sub>−N<sub>1</sub> shares the same lower level, a larger N<sub>1</sub> reduces the available inversion for the 3→1 line.
      </div>

      <div class="callout warn">
        <b>Subtle but important:</b>
        The derivative criterion shows when this reduction is guaranteed. In regimes where the 2→1 line itself is strongly inverted
        (R2 τ21 sufficiently large), the coupling can become more nuanced because W<sub>21</sub> also changes N<sub>0</sub> and redistributes population across the loop.
        The interactive plots below let you explore both behaviors with consistent equations.
      </div>

      <p>
        Finally, note that even without taking derivatives, you can see the “competition channel” directly:
        W<sub>21</sub> appears in N<sub>1</sub> and therefore in Δ<sub>31</sub>, because both laser lines terminate at level 1.
      </p>
    </section>

    <section id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Reinterpreting the formulas</h3>
      <ul>
        <li><b>Inversion drivers:</b> The bracket terms
          <span style="font-family:var(--mono); color:#f2f6ff;">R3 τ31 - (R2+R3) τ1</span> and
          <span style="font-family:var(--mono); color:#f2f6ff;">R2 τ21 - (R2+R3) τ1</span>
          are the “core inequalities” that decide if each transition can be inverted.
        </li>
        <li><b>Radiation factors:</b> (1+W<sub>21</sub>τ<sub>21</sub>) and (1+W<sub>31</sub>τ<sub>31</sub>) appear as prefactors because stimulated coupling effectively adds extra exchange pathways between the relevant pair of levels.</li>
        <li><b>The denominator D:</b> is where all couplings “talk” to each other. When W<sub>21</sub> is increased, D generally increases (more rapid cycling), which can reduce inversions even if numerators also change.</li>
      </ul>

      <h3>How changing parameters affects outcomes (connect to plots)</h3>
      <ul>
        <li>Increasing <b>R<sub>3</sub></b> tends to increase N<sub>3</sub> and helps Δ<sub>31</sub>, but it also increases N<sub>1</sub> because more atoms eventually pass through level 1.</li>
        <li>Increasing <b>R<sub>2</sub></b> helps Δ<sub>21</sub>, but can harm Δ<sub>31</sub> because it can elevate the shared lower level N<sub>1</sub> (depending on τ’s and W’s).</li>
        <li>Increasing <b>W<sub>21</sub></b> tends to reduce |Δ<sub>21</sub>| (it mixes 2 and 1), and frequently reduces Δ<sub>31</sub> by raising N<sub>1</sub>.</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        Instead of eliminating N<sub>1</sub>, you can write the 4 steady-state equations plus the conservation constraint and solve with a 4×4 matrix plus constraint reduction.
        This can be convenient if you want to include additional decay channels (e.g., small 2→0) because you can keep the same algebraic structure and just modify the matrix entries.
      </p>

      <h3>Concept checks (quick self-test)</h3>
      <ul>
        <li><b>Q:</b> Why can two laser lines “compete” even though they involve different upper levels? <b>A:</b> They share the same lower level (1), so changing N<sub>1</sub> changes both inversions.</li>
        <li><b>Q:</b> What parameter most directly helps both inversions at once? <b>A:</b> Making τ<sub>1</sub> small (fast depopulation of level 1).</li>
        <li><b>Q:</b> If Δ<sub>21</sub>&lt;0, what does radiation at 2→1 do? <b>A:</b> It tends to drive absorption (net flow 1→2), altering N<sub>1</sub> and potentially suppressing Δ<sub>31</sub> as shown by the derivative criterion.</li>
      </ul>
    </section>

    <section id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <div class="grid2">
        <figure>
          <canvas id="diagram" aria-label="Energy level diagram"></canvas>
          <figcaption>
            <b>Diagram:</b> Four energy levels with pumps (0→3, 0→2), decays (3→1, 2→1, 1→0), and optional radiation-driven couplings (wavy arrows).
          </figcaption>
        </figure>

        <figure>
          <canvas id="plotMain" aria-label="Main plot: inversions vs W21"></canvas>
          <figcaption>
            <b>Main plot:</b> Δ<sub>31</sub>=N<sub>3</sub>−N<sub>1</sub> and Δ<sub>21</sub>=N<sub>2</sub>−N<sub>1</sub> versus W<sub>21</sub> (example values).
          </figcaption>
        </figure>
      </div>

      <div class="grid2" style="margin-top:14px;">
        <figure>
          <canvas id="plotSecondary" aria-label="Secondary plot: populations vs W21"></canvas>
          <figcaption>
            <b>Secondary plot:</b> Steady-state populations N<sub>0</sub>, N<sub>1</sub>, N<sub>2</sub>, N<sub>3</sub> versus W<sub>21</sub>.
          </figcaption>
        </figure>

        <div class="card">
          <h3 style="margin-top:0">Interactive controls (update all canvases)</h3>
          <p class="note">
            These are <b>example values</b> for visualization only. The analytic results above remain symbolic and general.
          </p>

          <div class="controls">
            <div class="ctrl">
              <label>
                <span>Radiation coupling W<sub>21</sub> (s⁻¹)</span>
                <span class="readout" id="w21Read">0</span>
              </label>
              <input id="w21" type="range" min="0" max="5000" step="10" value="0"/>
              <div class="note">Swept on plots; slider sets the highlighted operating point.</div>
            </div>

            <div class="ctrl">
              <label>
                <span>Pump R<sub>2</sub> (s⁻¹)</span>
                <span class="readout" id="r2Read">0</span>
              </label>
              <input id="r2" type="range" min="0" max="6000" step="50" value="2000"/>
              <div class="note">Changes how strongly level 2 competes via level 1.</div>
            </div>

            <div class="ctrl">
              <label>
                <span>Pump R<sub>3</sub> (s⁻¹)</span>
                <span class="readout" id="r3Read">0</span>
              </label>
              <input id="r3" type="range" min="0" max="6000" step="50" value="2500"/>
              <div class="note">Boosts upper level 3 and the 3→1 inversion tendency.</div>
            </div>

            <div class="ctrl">
              <label>
                <span>Radiation coupling W<sub>31</sub> (s⁻¹)</span>
                <span class="readout" id="w31Read">0</span>
              </label>
              <input id="w31" type="range" min="0" max="5000" step="10" value="0"/>
              <div class="note">Optional: emulate radiation on 3→1 as well.</div>
            </div>

            <div class="ctrl">
              <label><span>Select lifetime set (example)</span></label>
              <select id="tauPreset">
                <option value="A">Set A (τ1=1.0 ms, τ21=3.0 ms, τ31=4.0 ms)</option>
                <option value="B">Set B (τ1=0.3 ms, τ21=5.0 ms, τ31=5.0 ms)</option>
                <option value="C">Set C (τ1=2.0 ms, τ21=2.5 ms, τ31=3.0 ms)</option>
              </select>
              <div class="note">Try different τ’s to see when suppression is strongest.</div>
            </div>

            <div class="ctrl">
              <label><span>Normalization</span></label>
              <select id="normMode">
                <option value="frac" selected>Normalize total population: N=1 (fractions)</option>
                <option value="dens">Use N=1e18 m⁻³ (densities)</option>
              </select>
              <div class="note">Same physics; just rescales vertical axes.</div>
            </div>
          </div>

          <div class="hr"></div>

          <div class="kpiRow">
            <div class="kpi">
              <div class="label">Δ31 at slider</div>
              <div class="val" id="kpiD31">—</div>
              <div class="hint" id="kpiD31hint">N3−N1</div>
            </div>
            <div class="kpi">
              <div class="label">Δ21 at slider</div>
              <div class="val" id="kpiD21">—</div>
              <div class="hint" id="kpiD21hint">N2−N1</div>
            </div>
            <div class="kpi">
              <div class="label">Both inverted?</div>
              <div class="val" id="kpiBoth">—</div>
              <div class="hint">Δ31&gt;0 and Δ21&gt;0</div>
            </div>
            <div class="kpi">
              <div class="label">Suppression criterion</div>
              <div class="val" id="kpiCrit">—</div>
              <div class="hint">(R2+R3)τ1 &gt; R2τ21 ?</div>
            </div>
          </div>
        </div>
      </div>

      <div class="callout">
        <b>What should change when you move W<sub>21</sub>?</b>
        <ul>
          <li>Δ<sub>21</sub>(W<sub>21</sub>) typically moves toward zero (mixing level 2 and 1).</li>
          <li>N<sub>1</sub> often increases due to stronger cycling through level 1.</li>
          <li>Δ<sub>31</sub> can decrease (suppression) when the criterion in the solution indicates ∂Δ<sub>31</sub>/∂W<sub>21</sub>&lt;0.</li>
        </ul>
      </div>
    </section>

  </div>
</main>

<footer class="footer">
  <div class="hr"></div>
  <p>
    Built as a self-contained learning article (vanilla HTML/CSS/JS). Equations and plots use the same symbols.
    Example parameters are for visualization only; the boxed formulas are the symbolic solution.
  </p>
</footer>

<script>
(function(){
  // ---------- Utility ----------
  const $ = (sel)=>document.querySelector(sel);

  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
  function fmt(x){
    if(!isFinite(x)) return "—";
    const ax=Math.abs(x);
    if(ax===0) return "0";
    if(ax>=1e6 || ax<1e-3) return x.toExponential(3);
    return x.toFixed(6).replace(/0+$/,'').replace(/\.$/,'');
  }
  function niceTicks(min,max,nt=6){
    if(!(max>min)) return {min,max,step:1, ticks:[min]};
    const span=max-min;
    const raw=span/nt;
    const pow=Math.pow(10, Math.floor(Math.log10(raw)));
    const r=raw/pow;
    let step;
    if(r<1.5) step=1*pow;
    else if(r<3.2) step=2*pow;
    else if(r<7.0) step=5*pow;
    else step=10*pow;
    const niceMin=Math.floor(min/step)*step;
    const niceMax=Math.ceil(max/step)*step;
    const ticks=[];
    for(let v=niceMin; v<=niceMax+1e-12; v+=step) ticks.push(v);
    return {min:niceMin, max:niceMax, step, ticks};
  }

  async function copyText(text){
    try{
      await navigator.clipboard.writeText(text);
      return true;
    }catch(e){
      // fallback
      const ta=document.createElement("textarea");
      ta.value=text; document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand("copy"); }catch(_){}
      document.body.removeChild(ta);
      return true;
    }
  }

  // Copy buttons
  document.addEventListener("click",(e)=>{
    const b=e.target.closest(".copyBtn");
    if(!b) return;
    const targetSel=b.getAttribute("data-copy");
    const pre=$(targetSel);
    if(!pre) return;
    copyText(pre.textContent.trim()).then(()=>{
      const old=b.textContent;
      b.textContent="Copied!";
      setTimeout(()=>b.textContent=old, 900);
    });
  });

  // ---------- Model equations (steady state) ----------
  // Using the derived symbolic formulas (degeneracy absorbed, N constant):
  // N0 = N (1 + W21 τ21)(1 + W31 τ31)/D
  // N1 = N τ1 (R2 + R3)(1 + W21 τ21)(1 + W31 τ31)/D
  // N2 = N τ21 (1 + W31 τ31)[ R2 + (R2 + R3) W21 τ1 ]/D
  // N3 = N τ31 (1 + W21 τ21)[ R3 + (R2 + R3) W31 τ1 ]/D
  // D expanded exactly as in the article.

  function computeD(R2,R3,t1,t21,t31,W21,W31){
    const D =
      1 + W31*t31 + W21*t21 + W21*W31*t21*t31
      + R2*t1 + R2*t21 + R3*t1 + R3*t31
      + 2*R2*W31*t1*t31 + R2*W31*t21*t31 + 2*R3*W31*t1*t31
      + 2*R2*W21*t1*t21 + 2*R3*W21*t1*t21 + R3*W21*t21*t31
      + 3*R2*W21*W31*t1*t21*t31 + 3*R3*W21*W31*t1*t21*t31;
    return D;
  }

  function steadyState(N, R2,R3,t1,t21,t31,W21,W31){
    const D = computeD(R2,R3,t1,t21,t31,W21,W31);
    const f21 = (1 + W21*t21);
    const f31 = (1 + W31*t31);

    const N0 = N * f21 * f31 / D;
    const N1 = N * t1 * (R2+R3) * f21 * f31 / D;
    const N2 = N * t21 * f31 * ( R2 + (R2+R3)*W21*t1 ) / D;
    const N3 = N * t31 * f21 * ( R3 + (R2+R3)*W31*t1 ) / D;

    const D31 = N3 - N1;
    const D21 = N2 - N1;
    return {N0,N1,N2,N3,D31,D21,D};
  }

  function inversionConditions(R2,R3,t1,t21,t31){
    const c31 = (R3*t31 > (R2+R3)*t1);
    const c21 = (R2*t21 > (R2+R3)*t1);
    return {c31,c21};
  }

  function suppressionCriterion(R2,R3,t1,t21){
    // From the derivative sign derived in the article:
    // If (R2+R3)τ1 > R2 τ21 then ∂Δ31/∂W21 < 0 (for fixed other parameters, W31>=0).
    return ((R2+R3)*t1 > R2*t21);
  }

  // ---------- Canvas helpers ----------
  function setupCanvas(canvas){
    const ctx=canvas.getContext("2d");
    function resize(){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.max(2, Math.floor(rect.width * dpr));
      canvas.height = Math.max(2, Math.floor(rect.height * dpr));
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
    }
    resize();
    return {ctx, resize};
  }

  function drawAxes(ctx, box, xMin,xMax,yMin,yMax, xLabel,yLabel, title){
    const {x,y,w,h}=box;
    ctx.save();
    // background
    ctx.clearRect(x,y,w,h);
    ctx.fillStyle="rgba(0,0,0,0)";
    ctx.fillRect(x,y,w,h);

    const padL=54, padR=18, padT=34, padB=46;
    const px0=x+padL, px1=x+w-padR;
    const py0=y+padT, py1=y+h-padB;

    // title
    ctx.fillStyle="rgba(233,238,247,0.95)";
    ctx.font="600 14px ui-sans-serif, system-ui";
    ctx.fillText(title, x+12, y+20);

    // grid + ticks
    const xt=niceTicks(xMin,xMax,6);
    const yt=niceTicks(yMin,yMax,6);

    // grid lines
    ctx.strokeStyle="rgba(255,255,255,0.10)";
    ctx.lineWidth=1;
    ctx.beginPath();
    xt.ticks.forEach(tv=>{
      const u = (tv-xt.min)/(xt.max-xt.min);
      const X = px0 + u*(px1-px0);
      ctx.moveTo(X, py0);
      ctx.lineTo(X, py1);
    });
    yt.ticks.forEach(tv=>{
      const u = (tv-yt.min)/(yt.max-yt.min);
      const Y = py1 - u*(py1-py0);
      ctx.moveTo(px0, Y);
      ctx.lineTo(px1, Y);
    });
    ctx.stroke();

    // axes
    ctx.strokeStyle="rgba(255,255,255,0.35)";
    ctx.lineWidth=1.2;
    ctx.beginPath();
    ctx.moveTo(px0, py0);
    ctx.lineTo(px0, py1);
    ctx.lineTo(px1, py1);
    ctx.stroke();

    // tick labels
    ctx.fillStyle="rgba(185,196,218,0.95)";
    ctx.font="12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";

    // x labels
    xt.ticks.forEach(tv=>{
      const u = (tv-xt.min)/(xt.max-xt.min);
      const X = px0 + u*(px1-px0);
      ctx.beginPath();
      ctx.moveTo(X, py1);
      ctx.lineTo(X, py1+5);
      ctx.strokeStyle="rgba(255,255,255,0.35)";
      ctx.stroke();
      const s = (Math.abs(tv)>=1000 ? tv.toFixed(0) : tv.toFixed(0));
      ctx.fillText(s, X-ctx.measureText(s).width/2, py1+18);
    });

    // y labels
    yt.ticks.forEach(tv=>{
      const u=(tv-yt.min)/(yt.max-yt.min);
      const Y = py1 - u*(py1-py0);
      ctx.beginPath();
      ctx.moveTo(px0-5, Y);
      ctx.lineTo(px0, Y);
      ctx.strokeStyle="rgba(255,255,255,0.35)";
      ctx.stroke();
      const s = (Math.abs(tv)>=1e6 ? tv.toExponential(1) : (Math.abs(tv)<1e-3 && tv!==0 ? tv.toExponential(1) : tv.toFixed(3).replace(/0+$/,'').replace(/\.$/,'')));
      ctx.fillText(s, px0-10-ctx.measureText(s).width, Y+4);
    });

    // axis labels
    ctx.fillStyle="rgba(233,238,247,0.92)";
    ctx.font="13px ui-sans-serif, system-ui";
    ctx.fillText(xLabel, (px0+px1)/2 - ctx.measureText(xLabel).width/2, y+h-12);

    ctx.save();
    ctx.translate(x+16, (py0+py1)/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
    ctx.restore();

    ctx.restore();

    return {px0,px1,py0,py1, xt,yt};
  }

  function plotLine(ctx, axes, xs, ys, colorStyle){
    const {px0,px1,py0,py1, xt,yt}=axes;
    ctx.save();
    ctx.strokeStyle=colorStyle;
    ctx.lineWidth=2;
    ctx.beginPath();
    for(let i=0;i<xs.length;i++){
      const x = xs[i], y = ys[i];
      const u=(x-xt.min)/(xt.max-xt.min);
      const v=(y-yt.min)/(yt.max-yt.min);
      const X = px0 + u*(px1-px0);
      const Y = py1 - v*(py1-py0);
      if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
    }
    ctx.stroke();
    ctx.restore();
  }

  function plotMarker(ctx, axes, x, y, colorStyle){
    const {px0,px1,py0,py1, xt,yt}=axes;
    const u=(x-xt.min)/(xt.max-xt.min);
    const v=(y-yt.min)/(yt.max-yt.min);
    const X = px0 + u*(px1-px0);
    const Y = py1 - v*(py1-py0);
    ctx.save();
    ctx.fillStyle=colorStyle;
    ctx.beginPath();
    ctx.arc(X,Y,4.5,0,Math.PI*2);
    ctx.fill();
    ctx.strokeStyle="rgba(0,0,0,0.5)";
    ctx.lineWidth=1;
    ctx.stroke();
    ctx.restore();
  }

  function legend(ctx, box, items){
    const {x,y,w}=box;
    ctx.save();
    ctx.font="12.5px ui-sans-serif, system-ui";
    let lx=x+12, ly=y+30;
    items.forEach(it=>{
      ctx.fillStyle=it.color;
      ctx.fillRect(lx, ly-10, 12, 3);
      ctx.fillStyle="rgba(185,196,218,0.95)";
      ctx.fillText(it.label, lx+18, ly-6);
      lx += 18 + ctx.measureText(it.label).width + 18;
      if(lx > x+w-120){ lx=x+12; ly += 16; }
    });
    ctx.restore();
  }

  // ---------- Diagram drawing ----------
  function drawWavyArrow(ctx, x0,y0,x1,y1, amp=4, waves=10){
    const dx=x1-x0, dy=y1-y0;
    const L=Math.hypot(dx,dy);
    const ux=dx/L, uy=dy/L;
    const nx=-uy, ny=ux;

    ctx.beginPath();
    for(let i=0;i<=waves*20;i++){
      const t=i/(waves*20);
      const s=t*L;
      const wig = Math.sin(t*waves*2*Math.PI)*amp;
      const X = x0 + ux*s + nx*wig;
      const Y = y0 + uy*s + ny*wig;
      if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
    }
    ctx.stroke();

    // arrow head
    const ah=10;
    const ax=x1-ux*ah, ay=y1-uy*ah;
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(ax + nx*5, ay + ny*5);
    ctx.lineTo(ax - nx*5, ay - ny*5);
    ctx.closePath();
    ctx.fill();
  }

  function drawArrow(ctx, x0,y0,x1,y1){
    ctx.beginPath();
    ctx.moveTo(x0,y0);
    ctx.lineTo(x1,y1);
    ctx.stroke();
    const dx=x1-x0, dy=y1-y0;
    const L=Math.hypot(dx,dy)||1;
    const ux=dx/L, uy=dy/L;
    const nx=-uy, ny=ux;
    const ah=10;
    const ax=x1-ux*ah, ay=y1-uy*ah;
    ctx.beginPath();
    ctx.moveTo(x1,y1);
    ctx.lineTo(ax + nx*5, ay + ny*5);
    ctx.lineTo(ax - nx*5, ay - ny*5);
    ctx.closePath();
    ctx.fill();
  }

  function drawDiagram(state){
    const canvas=$("#diagram");
    const {ctx}=diagramCtx;
    const rect=canvas.getBoundingClientRect();
    const W=rect.width, H=rect.height;
    ctx.clearRect(0,0,W,H);

    const pad=18;
    const left=pad, right=W-pad, top=pad, bottom=H-pad;
    const midX=(left+right)*0.5;

    // Title
    ctx.fillStyle="rgba(233,238,247,0.95)";
    ctx.font="600 14px ui-sans-serif, system-ui";
    ctx.fillText("Energy-level diagram (with pumps and two laser lines)", left, top+4);

    // Level positions
    const y0=bottom-40, y1=bottom-110, y2=bottom-190, y3=bottom-270;
    const xL=left+35, xR=right-35;

    function level(y, label){
      ctx.strokeStyle="rgba(255,255,255,0.45)";
      ctx.lineWidth=2;
      ctx.beginPath();
      ctx.moveTo(xL, y);
      ctx.lineTo(xR, y);
      ctx.stroke();
      ctx.fillStyle="rgba(185,196,218,0.95)";
      ctx.font="12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      ctx.fillText(label, xL-26, y+4);
    }

    level(y3,"3");
    level(y2,"2");
    level(y1,"1");
    level(y0,"0");

    // Pumps (0->3, 0->2)
    ctx.strokeStyle="rgba(125,211,252,0.85)";
    ctx.fillStyle="rgba(125,211,252,0.85)";
    ctx.lineWidth=2.2;
    drawArrow(ctx, midX-90, y0-2, midX-30, y3+2);
    drawArrow(ctx, midX-40, y0-2, midX+10, y2+2);

    ctx.fillStyle="rgba(185,196,218,0.95)";
    ctx.font="12.5px ui-sans-serif, system-ui";
    ctx.fillText(`Pump: 0→3 at R3`, midX-130, y3+18);
    ctx.fillText(`Pump: 0→2 at R2`, midX-20, y2+18);

    // Spontaneous decays (3->1, 2->1, 1->0)
    ctx.strokeStyle="rgba(251,191,36,0.85)";
    ctx.fillStyle="rgba(251,191,36,0.85)";
    ctx.lineWidth=2;
    drawArrow(ctx, midX+90, y3-2, midX+40, y1+2);
    drawArrow(ctx, midX+50, y2-2, midX+20, y1+2);

    ctx.strokeStyle="rgba(52,211,153,0.80)";
    ctx.fillStyle="rgba(52,211,153,0.80)";
    drawArrow(ctx, midX+10, y1-2, midX-10, y0+2);

    ctx.fillStyle="rgba(185,196,218,0.95)";
    ctx.font="12.5px ui-sans-serif, system-ui";
    ctx.fillText(`Decay: 3→1 (τ31)`, midX+50, y3-18);
    ctx.fillText(`Decay: 2→1 (τ21)`, midX+10, y2-18);
    ctx.fillText(`Decay: 1→0 (τ1)`,  midX-10, y1-18);

    // Radiation-induced couplings (wavy arrows) for 3↔1 and 2↔1
    const w21 = state.W21, w31 = state.W31;

    // 3<->1
    if(w31>0){
      ctx.strokeStyle="rgba(167,139,250,0.95)";
      ctx.fillStyle="rgba(167,139,250,0.95)";
      ctx.lineWidth=2;
      drawWavyArrow(ctx, xR-30, y3+4, xR-30, y1-4, 3.8, 8);
      ctx.fillStyle="rgba(185,196,218,0.95)";
      ctx.font="12.5px ui-sans-serif, system-ui";
      ctx.fillText(`Radiation on 3↔1 (W31)`, xR-210, (y3+y1)/2);
    }else{
      ctx.fillStyle="rgba(127,138,163,0.85)";
      ctx.font="12.5px ui-sans-serif, system-ui";
      ctx.fillText(`No radiation on 3↔1 (W31=0)`, xR-240, (y3+y1)/2);
    }

    // 2<->1
    if(w21>0){
      ctx.strokeStyle="rgba(167,139,250,0.95)";
      ctx.fillStyle="rgba(167,139,250,0.95)";
      ctx.lineWidth=2;
      drawWavyArrow(ctx, xL+30, y2+4, xL+30, y1-4, 3.8, 6);
      ctx.fillStyle="rgba(185,196,218,0.95)";
      ctx.font="12.5px ui-sans-serif, system-ui";
      ctx.fillText(`Radiation on 2↔1 (W21)`, xL+50, (y2+y1)/2);
    }else{
      ctx.fillStyle="rgba(127,138,163,0.85)";
      ctx.font="12.5px ui-sans-serif, system-ui";
      ctx.fillText(`No radiation on 2↔1 (W21=0)`, xL+50, (y2+y1)/2);
    }

    // Explicit statement: no 3->2
    ctx.fillStyle="rgba(127,138,163,0.85)";
    ctx.font="12px ui-sans-serif, system-ui";
    ctx.fillText("Assumption: no 3→2 decay; 3→0 and 2→0 negligible", left, bottom);

    // Small legend
    ctx.save();
    ctx.globalAlpha=0.95;
    ctx.fillStyle="rgba(0,0,0,0.28)";
    ctx.strokeStyle="rgba(255,255,255,0.12)";
    ctx.lineWidth=1;
    const bx=left, by=top+18, bw=clamp(W-2*pad, 200, 520), bh=52;
    ctx.beginPath();
    ctx.roundRect(bx, by, bw, bh, 14);
    ctx.fill(); ctx.stroke();

    ctx.font="12px ui-sans-serif, system-ui";
    ctx.fillStyle="rgba(185,196,218,0.95)";
    ctx.fillText("Colors: pumps", bx+14, by+20);
    ctx.fillStyle="rgba(125,211,252,0.9)";
    ctx.fillRect(bx+86, by+14, 18, 4);

    ctx.fillStyle="rgba(185,196,218,0.95)";
    ctx.fillText("decays", bx+120, by+20);
    ctx.fillStyle="rgba(251,191,36,0.9)";
    ctx.fillRect(bx+168, by+14, 18, 4);

    ctx.fillStyle="rgba(185,196,218,0.95)";
    ctx.fillText("ground return", bx+202, by+20);
    ctx.fillStyle="rgba(52,211,153,0.85)";
    ctx.fillRect(bx+296, by+14, 18, 4);

    ctx.fillStyle="rgba(185,196,218,0.95)";
    ctx.fillText("radiation coupling", bx+330, by+20);
    ctx.fillStyle="rgba(167,139,250,0.9)";
    ctx.fillRect(bx+452, by+14, 18, 4);

    ctx.restore();
  }

  // ---------- Plotting ----------
  function drawMainPlot(params){
    const canvas=$("#plotMain");
    const {ctx}=mainCtx;
    const rect=canvas.getBoundingClientRect();
    const W=rect.width, H=rect.height;
    ctx.clearRect(0,0,W,H);

    const {N, R2,R3,t1,t21,t31,W31, W21_current} = params;

    // Sweep W21
    const W21max = 5000;
    const n=260;
    const xs=[], y31=[], y21=[];
    for(let i=0;i<n;i++){
      const w21 = W21max*i/(n-1);
      const s = steadyState(N,R2,R3,t1,t21,t31,w21,W31);
      xs.push(w21);
      y31.push(s.D31);
      y21.push(s.D21);
    }

    // Determine y range
    let ymin=Infinity, ymax=-Infinity;
    [...y31,...y21].forEach(v=>{
      ymin=Math.min(ymin,v);
      ymax=Math.max(ymax,v);
    });
    // Add padding
    const pad=(ymax-ymin)*0.12 || 0.05;
    ymin -= pad; ymax += pad;
    if(!(ymax>ymin)){ ymin-=1; ymax+=1; }

    const axes = drawAxes(ctx, {x:0,y:0,w:W,h:H}, 0,W21max,ymin,ymax, "W21 (s⁻¹)", "Inversion Δ (same units as N)", "Main plot: inversions vs W21 (Δ31 and Δ21)");
    // Lines
    plotLine(ctx, axes, xs, y31, "rgba(125,211,252,0.95)");
    plotLine(ctx, axes, xs, y21, "rgba(167,139,250,0.95)");

    // Operating point marker
    const sNow = steadyState(N,R2,R3,t1,t21,t31,W21_current,W31);
    plotMarker(ctx, axes, W21_current, sNow.D31, "rgba(125,211,252,0.95)");
    plotMarker(ctx, axes, W21_current, sNow.D21, "rgba(167,139,250,0.95)");

    // Legend
    legend(ctx, {x:0,y:0,w:W,h:H}, [
      {label:"Δ31 = N3 − N1", color:"rgba(125,211,252,0.95)"},
      {label:"Δ21 = N2 − N1", color:"rgba(167,139,250,0.95)"}
    ]);
  }

  function drawSecondaryPlot(params){
    const canvas=$("#plotSecondary");
    const {ctx}=secCtx;
    const rect=canvas.getBoundingClientRect();
    const W=rect.width, H=rect.height;
    ctx.clearRect(0,0,W,H);

    const {N, R2,R3,t1,t21,t31,W31, W21_current} = params;

    // Sweep W21
    const W21max = 5000;
    const n=260;
    const xs=[], y0=[], y1=[], y2=[], y3=[];
    for(let i=0;i<n;i++){
      const w21 = W21max*i/(n-1);
      const s = steadyState(N,R2,R3,t1,t21,t31,w21,W31);
      xs.push(w21);
      y0.push(s.N0); y1.push(s.N1); y2.push(s.N2); y3.push(s.N3);
    }

    // y range: [0, max]
    let ymax=0;
    [...y0,...y1,...y2,...y3].forEach(v=>{ ymax=Math.max(ymax,v); });
    ymax = ymax*1.15 + (ymax===0 ? 1 : 0);
    const axes = drawAxes(ctx, {x:0,y:0,w:W,h:H}, 0,W21max, 0,ymax, "W21 (s⁻¹)", "Population (same units as N)", "Secondary plot: steady-state populations vs W21");

    plotLine(ctx, axes, xs, y0, "rgba(52,211,153,0.95)");
    plotLine(ctx, axes, xs, y1, "rgba(251,191,36,0.95)");
    plotLine(ctx, axes, xs, y2, "rgba(167,139,250,0.95)");
    plotLine(ctx, axes, xs, y3, "rgba(125,211,252,0.95)");

    const sNow = steadyState(N,R2,R3,t1,t21,t31,W21_current,W31);
    plotMarker(ctx, axes, W21_current, sNow.N0, "rgba(52,211,153,0.95)");
    plotMarker(ctx, axes, W21_current, sNow.N1, "rgba(251,191,36,0.95)");
    plotMarker(ctx, axes, W21_current, sNow.N2, "rgba(167,139,250,0.95)");
    plotMarker(ctx, axes, W21_current, sNow.N3, "rgba(125,211,252,0.95)");

    legend(ctx, {x:0,y:0,w:W,h:H}, [
      {label:"N0", color:"rgba(52,211,153,0.95)"},
      {label:"N1", color:"rgba(251,191,36,0.95)"},
      {label:"N2", color:"rgba(167,139,250,0.95)"},
      {label:"N3", color:"rgba(125,211,252,0.95)"}
    ]);
  }

  // ---------- Controls + state ----------
  const diagramCtx = setupCanvas($("#diagram"));
  const mainCtx    = setupCanvas($("#plotMain"));
  const secCtx     = setupCanvas($("#plotSecondary"));

  function getTauPreset(){
    const v=$("#tauPreset").value;
    if(v==="A") return {t1:1.0e-3, t21:3.0e-3, t31:4.0e-3};
    if(v==="B") return {t1:0.3e-3, t21:5.0e-3, t31:5.0e-3};
    return {t1:2.0e-3, t21:2.5e-3, t31:3.0e-3}; // C
  }

  function getN(){
    return ($("#normMode").value==="dens") ? 1e18 : 1.0;
  }

  function updateReadouts(){
    $("#w21Read").textContent = $("#w21").value;
    $("#r2Read").textContent = $("#r2").value;
    $("#r3Read").textContent = $("#r3").value;
    $("#w31Read").textContent = $("#w31").value;
  }

  function updateKPIs(params, sNow){
    $("#kpiD31").textContent = fmt(sNow.D31);
    $("#kpiD21").textContent = fmt(sNow.D21);

    const both = (sNow.D31>0 && sNow.D21>0);
    $("#kpiBoth").textContent = both ? "YES" : "NO";
    $("#kpiBoth").style.color = both ? "var(--ok)" : "var(--bad)";

    const crit = suppressionCriterion(params.R2, params.R3, params.t1, params.t21);
    $("#kpiCrit").textContent = crit ? "TRUE" : "FALSE";
    $("#kpiCrit").style.color = crit ? "var(--ok)" : "var(--warn)";
  }

  function renderAll(){
    updateReadouts();

    const taus = getTauPreset();
    const N = getN();
    const R2 = parseFloat($("#r2").value);
    const R3 = parseFloat($("#r3").value);
    const W21_current = parseFloat($("#w21").value);
    const W31 = parseFloat($("#w31").value);

    const params = {N, R2,R3, W21_current, W31, ...taus};

    // Diagram uses the current (slider) values
    drawDiagram({W21: W21_current, W31: W31});

    // Plots
    drawMainPlot(params);
    drawSecondaryPlot(params);

    // KPIs at slider
    const sNow = steadyState(N,R2,R3,taus.t1,taus.t21,taus.t31,W21_current,W31);
    updateKPIs(params, sNow);
  }

  // Resize observer for crisp + responsive rendering
  const ro = new ResizeObserver(()=>{
    diagramCtx.resize();
    mainCtx.resize();
    secCtx.resize();
    renderAll();
  });
  ro.observe($("#diagram"));
  ro.observe($("#plotMain"));
  ro.observe($("#plotSecondary"));

  // Hook controls
  ["w21","r2","r3","w31","tauPreset","normMode"].forEach(id=>{
    $("#"+id).addEventListener("input", renderAll);
    $("#"+id).addEventListener("change", renderAll);
  });

  // Initialize
  renderAll();

})();
</script>
</body>
</html>
