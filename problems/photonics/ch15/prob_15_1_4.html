<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Amplification of a Broadband Signal in a Lorentzian-Gain Medium</title>
  <style>
    :root{
      --bg:#0b0e14;
      --panel:#101726;
      --panel2:#0f1522;
      --text:#e9eefc;
      --muted:#b6c2e2;
      --faint:#7f8bb0;
      --accent:#78a6ff;
      --accent2:#78ffd6;
      --warn:#ffcf6e;
      --bad:#ff6e8a;
      --good:#7dff8a;
      --border:rgba(255,255,255,0.10);
      --shadow: 0 10px 30px rgba(0,0,0,0.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% -10%, rgba(120,166,255,0.22), transparent 60%),
        radial-gradient(900px 600px at 110% 20%, rgba(120,255,214,0.14), transparent 55%),
        radial-gradient(900px 600px at 30% 110%, rgba(255,207,110,0.10), transparent 55%),
        var(--bg);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding:28px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }
    .titleWrap{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      padding:20px 18px;
      box-shadow:var(--shadow);
      position:relative;
      overflow:hidden;
    }
    .titleWrap::before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(400px 220px at 20% 10%, rgba(120,166,255,0.22), transparent 70%),
                  radial-gradient(380px 220px at 85% 30%, rgba(120,255,214,0.14), transparent 70%);
      filter: blur(8px);
      opacity:0.9;
      pointer-events:none;
    }
    h1{
      margin:0;
      font-size:clamp(20px, 2.4vw, 34px);
      letter-spacing:0.2px;
      position:relative;
      z-index:1;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size:clamp(13px, 1.2vw, 15px);
      position:relative;
      z-index:1;
      max-width: 80ch;
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 10px 18px 56px;
      display:grid;
      grid-template-columns: 310px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
      .toc{position:relative; top:0}
    }

    .toc{
      position:sticky;
      top:14px;
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px 14px 10px;
    }
    .toc h2{
      font-size:14px;
      margin:0 0 8px;
      letter-spacing:0.4px;
      color:var(--muted);
      text-transform:uppercase;
    }
    .toc a{
      display:block;
      padding:8px 10px;
      margin:4px 0;
      border-radius:12px;
      color:var(--text);
      border:1px solid transparent;
      background:rgba(0,0,0,0.15);
      transition: transform .12s ease, border-color .12s ease, background .12s ease;
    }
    .toc a:hover{
      transform: translateY(-1px);
      border-color: rgba(120,166,255,0.35);
      background:rgba(120,166,255,0.10);
      text-decoration:none;
    }
    .toc .mini{
      margin-top:8px;
      padding:10px;
      background:rgba(0,0,0,0.18);
      border:1px solid var(--border);
      border-radius:14px;
      color:var(--muted);
      font-size:13px;
    }

    section{
      background:linear-gradient(180deg, rgba(255,255,255,0.06), rgba(255,255,255,0.02));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px;
      margin-bottom:14px;
      overflow:hidden;
      position:relative;
    }
    section h2{
      margin:0 0 10px;
      font-size:18px;
      letter-spacing:0.2px;
    }
    section h3{
      margin:16px 0 8px;
      font-size:15px;
      color:var(--muted);
    }
    p{margin:8px 0}
    ul{margin:8px 0 8px 20px}
    li{margin:6px 0}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 820px){
      .grid2{grid-template-columns:1fr}
    }
    .callout{
      border:1px solid var(--border);
      border-radius:16px;
      padding:12px 12px;
      background:rgba(0,0,0,0.18);
    }
    .callout strong{color:var(--text)}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size:12px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.20);
      color:var(--muted);
      margin-right:8px;
      margin-top:6px;
    }
    .tag .dot{
      width:8px; height:8px; border-radius:50%;
      background: var(--accent);
      box-shadow: 0 0 0 3px rgba(120,166,255,0.14);
    }
    .eq{
      position:relative;
      margin:10px 0;
      border:1px solid rgba(120,166,255,0.25);
      background:rgba(120,166,255,0.08);
      border-radius:16px;
      padding:12px 12px 12px 12px;
      overflow:hidden;
    }
    .eq pre{
      margin:0;
      font-family:var(--mono);
      font-size:13px;
      white-space:pre-wrap;
      color:var(--text);
    }
    .copyBtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.25);
      color:var(--text);
      border-radius:12px;
      padding:7px 10px;
      font-size:12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .copyBtn:hover{
      transform: translateY(-1px);
      background:rgba(120,255,214,0.10);
      border-color: rgba(120,255,214,0.35);
    }
    .copyToast{
      position:fixed;
      left:50%;
      bottom:20px;
      transform:translateX(-50%);
      background:rgba(0,0,0,0.70);
      border:1px solid var(--border);
      color:var(--text);
      padding:10px 12px;
      border-radius:999px;
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index:9999;
    }
    .copyToast.show{
      opacity:1;
      transform:translateX(-50%) translateY(-4px);
    }

    .vizWrap{
      display:grid;
      grid-template-columns: 1.05fr 0.95fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){
      .vizWrap{grid-template-columns:1fr}
    }
    .canvasCard{
      border:1px solid var(--border);
      border-radius:18px;
      overflow:hidden;
      background:rgba(0,0,0,0.18);
    }
    .canvasHeader{
      padding:10px 12px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:12px;
      border-bottom:1px solid var(--border);
      background:rgba(0,0,0,0.16);
    }
    .canvasHeader .title{
      font-size:13px;
      color:var(--muted);
      letter-spacing:0.2px;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
    }
    .controls{
      display:grid;
      gap:10px;
      border:1px solid var(--border);
      border-radius:18px;
      padding:12px;
      background:rgba(0,0,0,0.18);
    }
    .controlRow{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:10px;
      align-items:center;
    }
    label{
      font-size:13px;
      color:var(--muted);
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }
    .readout{
      font-family:var(--mono);
      font-size:12px;
      color:var(--text);
      padding:6px 8px;
      border:1px solid var(--border);
      border-radius:12px;
      background:rgba(0,0,0,0.22);
      min-width: 110px;
      text-align:right;
    }
    .kpis{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    .kpi{
      border:1px solid var(--border);
      border-radius:16px;
      padding:10px 10px;
      background:rgba(0,0,0,0.18);
    }
    .kpi .k{
      font-size:12px;
      color:var(--muted);
    }
    .kpi .v{
      font-family:var(--mono);
      font-size:14px;
      margin-top:6px;
    }
    .pill{
      display:inline-block;
      padding:4px 10px;
      border-radius:999px;
      border:1px solid var(--border);
      background:rgba(0,0,0,0.22);
      font-size:12px;
      color:var(--muted);
      margin-left:8px;
    }
    .footer{
      max-width:1200px;
      margin:0 auto;
      padding:0 18px 36px;
      color:var(--faint);
      font-size:12px;
    }

    /* subtle entrance */
    @keyframes rise { from{opacity:0; transform:translateY(6px)} to{opacity:1; transform:translateY(0)} }
    section{ animation: rise .35s ease both; }
    section:nth-child(1){animation-delay:.02s}
    section:nth-child(2){animation-delay:.05s}
    section:nth-child(3){animation-delay:.08s}
    section:nth-child(4){animation-delay:.11s}
    section:nth-child(5){animation-delay:.14s}
    section:nth-child(6){animation-delay:.17s}

    /* print-friendly */
    @media print{
      body{background:#fff; color:#000}
      header, main, .footer{max-width: 100%; padding:0}
      .toc{display:none}
      section{box-shadow:none; border:1px solid #ccc; background:#fff}
      .copyBtn{display:none}
      canvas{display:none}
    }
  </style>
</head>
<body>
  <header>
    <div class="titleWrap">
      <h1>Amplification of a Broadband Signal in a Lorentzian-Gain Medium</h1>
      <p class="subtitle">
        We estimate the <b>net gain or loss</b> for a light wave whose spectrum is flat over a finite bandwidth,
        when the medium’s gain varies with frequency as a <b>Lorentzian lineshape</b> and there is an additional
        frequency-independent loss.
      </p>
    </div>
  </header>

  <main>
    <nav class="toc" aria-label="Table of contents">
      <h2>Contents</h2>
      <a href="#quick" data-toc>Quick Summary</a>
      <a href="#part0" data-toc>PART 0 — Concept Primer</a>
      <a href="#part1" data-toc>PART 1 — Problem Analysis</a>
      <a href="#part2" data-toc>PART 2 — Strategy & Tips</a>
      <a href="#part3" data-toc>PART 3 — Full Solution</a>
      <a href="#part4" data-toc>PART 4 — Deeper Understanding</a>
      <a href="#part5" data-toc>PART 5 — Visualization Guide</a>
      <div class="mini" id="miniStatus">
        Interactive plots below let you sweep the <b>signal bandwidth</b> and watch the <b>average gain</b> and <b>net amplification</b> update live.
      </div>
    </nav>

    <article>
      <section id="quick">
        <h2>Quick Summary</h2>
        <ul>
          <li><b>What this is about:</b> amplification (or attenuation) of a <b>broadband</b> optical signal passing through a medium with <b>frequency-dependent gain</b>.</li>
          <li><b>Key idea:</b> a broadband signal experiences the <b>spectrum-averaged</b> gain coefficient, not just the peak gain at line center.</li>
          <li><b>Model:</b> Lorentzian gain profile with peak gain coefficient <span class="pill">γ(ν₀)=γ₀</span> and linewidth <span class="pill">Δν (FWHM)</span>.</li>
          <li><b>Governing law (small-signal/unsaturated):</b> intensity evolves as <span class="pill">I(L)=I(0)·exp[(γ̄−α_s)L]</span>.</li>
          <li><b>Broadband averaging:</b> for a flat spectrum over <span class="pill">ν₀±B</span>, <span class="pill">γ̄=(1/2B)∫_{ν₀−B}^{ν₀+B}γ(ν)dν</span>.</li>
          <li><b>Given:</b> Δν=1 THz, γ₀=0.1 cm⁻¹, α_s=0.05 cm⁻¹, L=1 cm, and a flat spectrum over bandwidth <span class="pill">2Δν</span> (so half-width B=Δν).</li>
          <li><b>Result type:</b> closed-form symbolic expression for γ̄, then a numeric net gain factor over 1 cm.</li>
        </ul>
      </section>

      <section id="part0">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <div class="grid2">
          <div class="callout">
            <div class="tag"><span class="dot"></span><b>Core definitions</b></div>
            <ul>
              <li><b>Frequency</b> ν (Hz): optical oscillation rate; here near ν₀.</li>
              <li><b>Gain coefficient</b> γ(ν) (length⁻¹): exponential amplification per unit length at frequency ν.</li>
              <li><b>Loss coefficient</b> α (length⁻¹): exponential attenuation per unit length (absorption/scatter).</li>
              <li><b>Linewidth</b> Δν (Hz): width of spectral line; in many optics texts, Δν is the <b>FWHM</b> of a Lorentzian.</li>
              <li><b>Uniform (flat) power spectral density</b>: signal power is evenly distributed across a finite frequency interval.</li>
            </ul>
          </div>

          <div class="callout">
            <div class="tag"><span class="dot" style="background:var(--accent2)"></span><b>Physical meaning</b></div>
            <p>
              If the medium’s gain is strongest at ν₀ but weaker off-resonance, then a broadband signal “samples” many frequencies.
              The medium amplifies each frequency component differently, and the net result depends on an <b>average over the signal spectrum</b>.
            </p>
            <p>
              An <b>additional loss α<sub>s</sub></b> that is independent of ν subtracts from the gain for <i>every</i> frequency component.
            </p>
          </div>
        </div>

        <h3>Key laws / principles and validity</h3>
        <div class="callout">
          <ul>
            <li><b>Small-signal (unsaturated) amplification:</b> assumes the population inversion is not significantly depleted by the propagating wave.</li>
            <li><b>Independent spectral components:</b> assumes linear propagation so each frequency component grows/decays exponentially with its own coefficient.</li>
            <li><b>Beer–Lambert / exponential law:</b> for intensity (or power in a guided mode) along z:
              <span class="pill">dI/dz = (γ(ν) − α_s) I</span>.
            </li>
          </ul>
        </div>

        <h3>Common models / approximations</h3>
        <ul>
          <li><b>Lorentzian lineshape:</b> typical for homogeneous broadening (e.g., lifetime / collision broadening).</li>
          <li><b>Flat-top spectrum approximation:</b> simplifies averaging: constant spectral density inside the band and zero outside.</li>
          <li><b>Use of averaged gain γ̄:</b> appropriate when you only care about <b>total</b> transmitted power and the input spectrum is specified.</li>
        </ul>

        <h3>Mini intuition examples</h3>
        <ul>
          <li>If the signal bandwidth is <b>much narrower</b> than the linewidth, most power sits near ν₀ ⇒ γ̄ ≈ γ₀ (nearly peak gain).</li>
          <li>If the signal bandwidth is <b>much broader</b> than the linewidth, most power is far off resonance ⇒ γ̄ becomes small and the medium can become net lossy.</li>
        </ul>

        <h3>What to watch for (pitfalls)</h3>
        <div class="callout">
          <ul>
            <li><b>Linewidth convention:</b> Lorentzian can be written with HWHM or FWHM; here we treat Δν as the <b>FWHM</b>.</li>
            <li><b>Bandwidth wording:</b> “bandwidth 2Δν” means the flat spectrum spans ν₀−Δν to ν₀+Δν (half-width B=Δν).</li>
            <li><b>Gain vs intensity:</b> γ is a <i>power/intensity</i> gain coefficient here; use exp[(γ−α)L] accordingly.</li>
          </ul>
        </div>
      </section>

      <section id="part1">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <h3>Rewrite the problem in plain words</h3>
        <p>
          A medium has an inverted two-level transition whose <b>gain spectrum</b> is Lorentzian, centered at ν₀=5×10¹⁴ Hz
          with linewidth Δν=1 THz. The peak gain coefficient at ν₀ is γ(ν₀)=0.1 cm⁻¹. The medium also has an extra,
          frequency-independent loss α<sub>s</sub>=0.05 cm⁻¹. A light wave with <b>uniform power spectral density</b> over a band
          of total width 2Δν centered at ν₀ traverses L=1 cm. Estimate whether it experiences net gain or loss and by how much.
        </p>

        <div class="grid2">
          <div class="callout">
            <div class="tag"><span class="dot"></span><b>Given</b></div>
            <ul>
              <li>Center frequency: ν₀ = 5×10¹⁴ Hz</li>
              <li>Linewidth (Lorentzian, FWHM): Δν = 1 THz</li>
              <li>Peak gain coefficient: γ(ν₀)=γ₀ = 0.1 cm⁻¹</li>
              <li>Additional loss: α<sub>s</sub> = 0.05 cm⁻¹ (independent of ν)</li>
              <li>Propagation length: L = 1 cm</li>
              <li>Signal spectrum: flat over bandwidth 2Δν ⇒ ν ∈ [ν₀−Δν, ν₀+Δν]</li>
            </ul>
          </div>

          <div class="callout">
            <div class="tag"><span class="dot" style="background:var(--accent2)"></span><b>Unknowns / what to find</b></div>
            <ul>
              <li>Spectrum-averaged gain coefficient γ̄ over the signal band</li>
              <li>Net coefficient: (γ̄ − α<sub>s</sub>)</li>
              <li>Net amplification factor for intensity (or power): G = exp[(γ̄ − α<sub>s</sub>)L]</li>
              <li>Whether G&gt;1 (gain) or G&lt;1 (loss), and by how much over 1 cm</li>
            </ul>
          </div>
        </div>

        <h3>Relevant principles and why they apply</h3>
        <ul>
          <li><b>Frequency-dependent gain:</b> Two-level homogeneous broadening produces a Lorentzian gain profile.</li>
          <li><b>Linear superposition of spectral components:</b> With small-signal amplification, each frequency grows exponentially and independently, so total output power is the spectral integral of amplified components.</li>
          <li><b>Frequency-independent loss:</b> Adds a constant attenuation term for all ν, so it subtracts directly from gain in the exponent.</li>
        </ul>

        <h3>Assumptions (explicit)</h3>
        <div class="callout">
          <ul>
            <li><b>Small-signal (unsaturated) regime:</b> inversion remains fixed; γ(ν) does not change with z.</li>
            <li><b>No dispersion reshaping needed</b> for the estimate: we treat the spectrum as remaining effectively flat for averaging purposes (or equivalently we compute average growth for total power).</li>
            <li><b>Single-pass, uniform medium</b> of length L=1 cm.</li>
            <li><b>Δν is the Lorentzian FWHM</b> (standard “linewidth” convention in many optics problems).</li>
          </ul>
        </div>

        <h3>Possible approaches (compare briefly)</h3>
        <ul>
          <li><b>(A) Average gain coefficient approach (best here):</b> compute γ̄ over the band, then apply I(L)=I(0)exp[(γ̄−α<sub>s</sub>)L]. <i>Pros:</i> clean analytic answer. <i>Cons:</i> ignores subtle spectral reshaping details.</li>
          <li><b>(B) Integrate output spectrum explicitly:</b> P_out = ∫ S_in(ν) exp[(γ(ν)−α<sub>s</sub>)L] dν. <i>Pros:</i> more accurate if gain varies strongly. <i>Cons:</i> algebra heavier; usually not needed for short L and modest variation.</li>
          <li><b>(C) Narrowband approximation:</b> set γ≈γ₀ if bandwidth≪Δν. <i>Pros:</i> simplest. <i>Cons:</i> not applicable because bandwidth is comparable to Δν.</li>
        </ul>
        <p>
          <b>Chosen approach:</b> (A) spectrum-averaged gain coefficient, because the problem asks for an estimate and provides a flat spectrum and a Lorentzian line (perfect for analytic averaging).
        </p>
      </section>

      <section id="part2">
        <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>
        <ol>
          <li><b>Write the Lorentzian gain model</b> with the correct linewidth convention (FWHM Δν).<br>
            <span class="pill">Tool:</span> Lorentzian lineshape.</li>
          <li><b>Define the signal band</b> for the uniform spectrum: ν ∈ [ν₀−B, ν₀+B] with B=Δν (because bandwidth is 2Δν).<br>
            <span class="pill">Meaning:</span> B is the half-width of the flat-top spectrum.</li>
          <li><b>Compute the band-averaged gain coefficient</b> γ̄ = (1/2B)∫ γ(ν)dν.<br>
            <span class="pill">Tool:</span> substitution + arctangent integral.</li>
          <li><b>Combine with loss</b>: net coefficient = γ̄ − α<sub>s</sub>.<br>
            <span class="pill">Meaning:</span> competition between averaged stimulated emission and background loss.</li>
          <li><b>Compute net amplification over L</b>: G = exp[(γ̄ − α<sub>s</sub>)L].<br>
            <span class="pill">Meaning:</span> multiplicative factor for intensity/power.</li>
          <li><b>Sanity checks</b>: units, sign, limiting bandwidth cases (B→0 and B→∞).</li>
        </ol>

        <div class="grid2">
          <div class="callout">
            <div class="tag"><span class="dot" style="background:var(--warn)"></span><b>Common mistakes</b></div>
            <ul>
              <li>Mixing up FWHM and HWHM in the Lorentzian (a factor of 2 error).</li>
              <li>Averaging <i>gain factors</i> exp(…) vs averaging <i>coefficients</i> γ(ν) (different approximations).</li>
              <li>Forgetting that “bandwidth 2Δν” means half-width B=Δν.</li>
            </ul>
          </div>
          <div class="callout">
            <div class="tag"><span class="dot" style="background:var(--accent2)"></span><b>Quick tips</b></div>
            <ul>
              <li>With Lorentzian γ(ν)=γ₀/(1+4((ν−ν₀)/Δν)²), the average over ±B gives a neat arctan.</li>
              <li>Keep everything in <b>cm⁻¹</b> for coefficients and <b>cm</b> for length so the exponent is dimensionless.</li>
              <li>Use detuning δ = ν−ν₀ to simplify integrals and plots.</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="part3">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Physical intuition (before math)</h3>
        <p>
          The gain peaks at ν₀ with γ₀=0.1 cm⁻¹, but the signal spreads its power uniformly over ν₀±Δν.
          Because a Lorentzian drops away from the center, the <b>average gain γ̄</b> across the band will be <b>smaller than γ₀</b>.
          Then the constant loss α<sub>s</sub>=0.05 cm⁻¹ competes against that averaged gain. The net sign of (γ̄−α<sub>s</sub>)
          tells us whether the medium amplifies or attenuates the broadband signal.
        </p>

        <h3>Step 1 — Write the Lorentzian gain profile (define every symbol)</h3>
        <p>
          Let ν be the optical frequency (Hz). Define the detuning δ = ν − ν₀. The Lorentzian gain coefficient (units cm⁻¹) with
          full width at half maximum (FWHM) equal to Δν is commonly written as
        </p>

        <div class="eq" data-copy="eq1">
          <button class="copyBtn" data-copy-btn="eq1">Copy</button>
          <pre id="eq1">γ(ν) = γ0 / ( 1 + 4 * ((ν - ν0)/Δν)^2 )</pre>
        </div>

        <p>
          Here:
          <span class="pill">γ0 = γ(ν0) = 0.1 cm⁻1</span>,
          <span class="pill">ν0 = 5×10^14 Hz</span>,
          <span class="pill">Δν = 1 THz</span>.
        </p>
        <p class="callout">
          <b>Why this form matches “FWHM = Δν”:</b> At |ν−ν₀| = Δν/2, the denominator becomes 1 + 4(1/2)² = 2, so γ drops to γ₀/2,
          which is exactly the half-maximum condition that defines the FWHM.
        </p>

        <h3>Step 2 — Define the broadband signal band and the averaging rule</h3>
        <p>
          The input power spectral density is <b>uniform</b> over a total bandwidth 2Δν centered at ν₀.
          That means the signal occupies
          ν ∈ [ν₀ − Δν, ν₀ + Δν].
        </p>
        <p>
          For a flat spectrum, an estimate for the effective gain coefficient experienced by the total power is the simple band average
        </p>

        <div class="eq" data-copy="eq2">
          <button class="copyBtn" data-copy-btn="eq2">Copy</button>
          <pre id="eq2">γ̄ = (1 / (2B)) * ∫[ν0-B to ν0+B] γ(ν) dν    with B = Δν</pre>
        </div>

        <p>
          We will keep it slightly general by using B as the half-width (so the full bandwidth is 2B), and then set B=Δν at the end.
        </p>

        <h3>Step 3 — Compute the integral (show steps, no jumps)</h3>
        <p>
          Substitute the Lorentzian expression into the average:
        </p>
        <p style="font-family:var(--mono); font-size:13px;">
          γ̄ = (1/(2B)) ∫(ν0−B→ν0+B) [ γ0 / (1 + 4((ν−ν0)/Δν)^2 ) ] dν
        </p>

        <p>
          Let u = (ν − ν₀)/Δν. Then ν = ν₀ + uΔν and dν = Δν du.
          When ν = ν₀ ± B, we have u = ±(B/Δν).
        </p>

        <p style="font-family:var(--mono); font-size:13px;">
          γ̄ = (1/(2B)) ∫(u=−B/Δν→+B/Δν) [ γ0 / (1 + 4u^2) ] (Δν du)
        </p>

        <p>
          Pull constants out:
        </p>
        <p style="font-family:var(--mono); font-size:13px;">
          γ̄ = (γ0 Δν / (2B)) ∫(−B/Δν→+B/Δν) du / (1 + 4u^2)
        </p>

        <p>
          Use the standard integral ∫ du/(1+a²u²) = (1/a) arctan(au). Here a=2, so:
        </p>
        <p style="font-family:var(--mono); font-size:13px;">
          ∫ du/(1+4u^2) = (1/2) arctan(2u)
        </p>

        <p>
          Evaluate between limits:
        </p>
        <p style="font-family:var(--mono); font-size:13px;">
          ∫(−b→+b) du/(1+4u^2) = (1/2)[ arctan(2b) − arctan(−2b) ]
                             = (1/2)[ arctan(2b) + arctan(2b) ]
                             = arctan(2b)</p>
        <p>
          where b = B/Δν.
        </p>

        <p>
          Therefore:
        </p>

        <div class="eq" data-copy="eq3">
          <button class="copyBtn" data-copy-btn="eq3">Copy</button>
          <pre id="eq3">γ̄(B) = γ0 * (Δν/(2B)) * arctan( 2B/Δν )</pre>
        </div>

        <p>
          <b>What we did and why:</b> we averaged the frequency-dependent gain over a flat input band.
          The Lorentzian integrates to an arctangent, giving a compact formula that shows explicitly how the effective gain decreases as the band widens.
        </p>

        <h3>Step 4 — Insert the problem’s bandwidth and subtract the additional loss</h3>
        <p>
          The problem states a uniform spectrum with bandwidth 2Δν, so the half-width is B=Δν. Plugging B=Δν into γ̄(B):
        </p>
        <p style="font-family:var(--mono); font-size:13px;">
          γ̄ = γ0 * (Δν/(2Δν)) * arctan(2Δν/Δν) = γ0 * (1/2) * arctan(2)
        </p>

        <div class="eq" data-copy="eq4">
          <button class="copyBtn" data-copy-btn="eq4">Copy</button>
          <pre id="eq4">For bandwidth 2Δν (half-width B=Δν):
γ̄ = (γ0/2) * arctan(2)</pre>
        </div>

        <p>
          Now include frequency-independent loss α<sub>s</sub> by forming the net coefficient:
        </p>

        <div class="eq" data-copy="eq5">
          <button class="copyBtn" data-copy-btn="eq5">Copy</button>
          <pre id="eq5">g_net = γ̄ − αs</pre>
        </div>

        <h3>Step 5 — Compute numerical values and the net gain/loss over L=1 cm</h3>
        <p>
          Use arctan(2) ≈ 1.107148717 (radians). With γ₀=0.1 cm⁻¹:
        </p>
        <p style="font-family:var(--mono); font-size:13px;">
          γ̄ = (0.1/2) * 1.107148717  cm⁻¹  = 0.0553574 cm⁻¹
        </p>
        <p>
          Subtract α<sub>s</sub>=0.05 cm⁻¹:
        </p>
        <p style="font-family:var(--mono); font-size:13px;">
          g_net = 0.0553574 − 0.05 = 0.0053574 cm⁻¹
        </p>

        <p>
          The intensity (or power) gain factor over length L is:
        </p>

        <div class="eq" data-copy="eq6">
          <button class="copyBtn" data-copy-btn="eq6">Copy</button>
          <pre id="eq6">G = exp( (γ̄ − αs) L )</pre>
        </div>

        <p>
          With L=1 cm:
        </p>
        <p style="font-family:var(--mono); font-size:13px;">
          G = exp(0.0053574 * 1) ≈ 1.00537
        </p>

        <div class="eq" data-copy="finalAnswer" style="border-color: rgba(125,255,138,0.35); background: rgba(125,255,138,0.08);">
          <button class="copyBtn" data-copy-btn="finalAnswer">Copy</button>
          <pre id="finalAnswer">FINAL (for bandwidth 2Δν, Δν=1 THz, γ0=0.1 cm^-1, αs=0.05 cm^-1, L=1 cm)

Average gain coefficient:
γ̄ = (γ0/2) * arctan(2) = 0.05536 cm^-1

Net coefficient:
g_net = γ̄ − αs = 0.00536 cm^-1

Net intensity (power) factor over 1 cm:
G = exp(g_net L) = exp(0.00536) ≈ 1.00537  → about +0.54% gain</pre>
        </div>

        <h3>Sanity checks</h3>
        <div class="grid2">
          <div class="callout">
            <b>Units:</b>
            <ul>
              <li>γ̄ and α<sub>s</sub> are in cm⁻¹, L is in cm ⇒ (γ̄−α<sub>s</sub>)L is dimensionless ⇒ exp(…) valid.</li>
            </ul>
          </div>
          <div class="callout">
            <b>Limiting cases (from γ̄(B) = γ0 (Δν/2B) arctan(2B/Δν)):</b>
            <ul>
              <li>B→0: arctan(2B/Δν)≈2B/Δν ⇒ γ̄→γ0 (narrowband recovers peak).</li>
              <li>B→∞: arctan(∞)=π/2 ⇒ γ̄≈γ0 (Δν/2B)(π/2) ∝ 1/B → 0 (very broadband averages to near zero gain).</li>
            </ul>
          </div>
        </div>

        <p>
          <b>Physical interpretation:</b> even though the peak gain is 0.1 cm⁻¹, spreading the signal across ±Δν lowers the effective gain to
          about 0.055 cm⁻¹. Because the loss is 0.05 cm⁻¹, the medium is only <b>slightly net amplifying</b> over 1 cm.
        </p>

        <h3>Connect to the diagram and plots</h3>
        <p>
          The diagram shows a broadband input traversing a length L of inverted medium. The main plot shows the Lorentzian γ(ν)
          and the flat spectral band; the average gain γ̄ is the horizontal level that represents the band-averaged height under the curve.
          The secondary plot shows how net amplification changes as you widen or narrow the signal bandwidth.
        </p>
      </section>

      <section id="part4">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpreting the final formula</h3>
        <p>
          The average gain for a flat-top spectrum of half-width B is
          <span class="pill">γ̄(B)=γ0 (Δν/(2B)) arctan(2B/Δν)</span>.
          Each factor has a clear role:
        </p>
        <ul>
          <li><b>γ₀</b> sets the overall scale (how strong the inversion-driven gain is at line center).</li>
          <li><b>Δν</b> sets how quickly gain falls off with detuning (broader lines keep gain high over a wider band).</li>
          <li><b>B</b> is the signal half-bandwidth (wider signals include more off-resonant power, reducing γ̄).</li>
          <li><b>arctan(2B/Δν)</b> captures the Lorentzian “area” sampled by the signal band.</li>
          <li><b>α<sub>s</sub></b> subtracts uniformly and can flip the sign from net gain to net loss.</li>
        </ul>

        <h3>How changing parameters affects the outcome (connect to plots)</h3>
        <ul>
          <li>Increasing <b>bandwidth</b> (larger B) decreases γ̄ and thus decreases net gain. Eventually γ̄ &lt; α<sub>s</sub> and the medium becomes net lossy.</li>
          <li>Increasing <b>γ₀</b> (stronger inversion or better overlap) shifts everything upward, making net gain more likely.</li>
          <li>Increasing <b>α<sub>s</sub></b> (more background loss) shifts net gain downward linearly.</li>
          <li>Increasing <b>L</b> increases the magnitude of the exponent: small positive g_net can become noticeable gain over long paths; small negative g_net can cause big loss.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p>
          Instead of averaging γ(ν), you can compute total transmitted power by integrating the amplified spectrum:
          P_out = ∫ S_in(ν) exp[(γ(ν)−α<sub>s</sub>)L] dν. For short L or weak variation, exp can be linearized to recover the average-gain approximation.
          This approach is more accurate when L is large and the gain varies strongly across the band.
        </p>

        <h3>Concept check (quick self-test)</h3>
        <ul>
          <li><b>Q:</b> If the signal bandwidth shrinks to almost zero around ν₀, what does γ̄ approach?<br><b>A:</b> γ̄ → γ₀.</li>
          <li><b>Q:</b> Why can a medium with γ(ν₀)=0.1 cm⁻¹ still give net loss for a broadband signal?<br><b>A:</b> Because most spectral components are off-resonant where γ(ν) is smaller, so γ̄ can drop below α<sub>s</sub>.</li>
          <li><b>Q:</b> What condition marks the crossover between net gain and net loss?<br><b>A:</b> γ̄(B) = α<sub>s</sub> (so g_net=0).</li>
          <li><b>Q:</b> What does Δν physically represent in this Lorentzian model?<br><b>A:</b> The FWHM of the gain line: detuning ±Δν/2 reduces the gain to half its peak.</li>
        </ul>
      </section>

      <section id="part5">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <div class="vizWrap">
          <div class="canvasCard">
            <div class="canvasHeader">
              <div class="title">Diagram — Broadband signal through an inverted gain medium</div>
              <span class="pill">L = 1 cm</span>
            </div>
            <canvas id="cDiagram" aria-label="Physical setup diagram"></canvas>
          </div>

          <div class="controls">
            <div class="tag"><span class="dot"></span><b>Interactive Control</b> <span class="pill">updates all canvases</span></div>

            <div class="controlRow">
              <label for="bw">Signal half-bandwidth B in units of linewidth Δν (B = k·Δν)</label>
              <div class="readout" id="bwRead">k = 1.00</div>
            </div>
            <input id="bw" type="range" min="0.10" max="5.00" step="0.01" value="1.00"/>

            <div class="kpis">
              <div class="kpi">
                <div class="k">Average gain γ̄ (cm⁻¹)</div>
                <div class="v" id="kpiGbar">0.05536</div>
              </div>
              <div class="kpi">
                <div class="k">Net factor G over 1 cm</div>
                <div class="v" id="kpiG">1.00537</div>
              </div>
            </div>

            <div class="callout">
              <b>What the slider changes:</b>
              <p style="margin:6px 0 0;">
                It changes the signal’s half-bandwidth <b>B</b>. Wider bands include more off-resonant frequencies where the gain is smaller,
                reducing <b>γ̄</b> and potentially turning net gain into net loss.
              </p>
            </div>
          </div>
        </div>

        <div style="height:12px"></div>

        <div class="vizWrap">
          <div class="canvasCard">
            <div class="canvasHeader">
              <div class="title">Main plot — Lorentzian gain γ(ν) and the flat signal band</div>
              <span class="pill">Δν = 1 THz, γ0 = 0.1 cm⁻¹</span>
            </div>
            <canvas id="cMain" aria-label="Lorentzian gain and band average plot"></canvas>
          </div>

          <div class="canvasCard">
            <div class="canvasHeader">
              <div class="title">Secondary plot — Net amplification vs bandwidth</div>
              <span class="pill">αs = 0.05 cm⁻¹</span>
            </div>
            <canvas id="cSweep" aria-label="Bandwidth sweep plot"></canvas>
          </div>
        </div>

        <h3>What each canvas shows</h3>
        <ul>
          <li><b>Diagram:</b> a block of inverted medium (length L) with a broadband input spectrum centered at ν₀ and an output after gain/loss.</li>
          <li><b>Main plot:</b> Lorentzian gain coefficient γ(ν) vs detuning (ν−ν₀) in THz. The shaded region is the signal band ν₀±B; a horizontal line marks the computed average γ̄.</li>
          <li><b>Secondary plot:</b> net intensity factor G(k)=exp[(γ̄(k)−α<sub>s</sub>)L] as bandwidth parameter k=B/Δν changes. The line G=1 marks the gain/loss boundary.</li>
        </ul>
      </section>
    </article>
  </main>

  <div class="footer">
    Built as a self-contained learning article (vanilla HTML/CSS/JS). Uses Δν as Lorentzian FWHM and a flat-top input spectrum of bandwidth 2Δν.
  </div>

  <div class="copyToast" id="toast">Copied.</div>

  <script>
    // ---------- Utility: smooth scroll for TOC ----------
    document.querySelectorAll('[data-toc]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const id = a.getAttribute('href');
        const el = document.querySelector(id);
        if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });

    // ---------- Copy buttons ----------
    const toast = document.getElementById('toast');
    function showToast(msg){
      toast.textContent = msg;
      toast.classList.add('show');
      setTimeout(()=>toast.classList.remove('show'), 900);
    }
    document.querySelectorAll('[data-copy-btn]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const targetId = btn.getAttribute('data-copy-btn');
        const text = document.getElementById(targetId)?.textContent ?? '';
        try{
          await navigator.clipboard.writeText(text.trim());
          showToast('Copied to clipboard.');
        }catch(err){
          // fallback
          const ta = document.createElement('textarea');
          ta.value = text.trim();
          document.body.appendChild(ta);
          ta.select();
          document.execCommand('copy');
          document.body.removeChild(ta);
          showToast('Copied (fallback).');
        }
      });
    });

    // ---------- Physics parameters (match the text) ----------
    const params = {
      nu0_Hz: 5e14,     // center frequency (not essential for detuning plots)
      dnu_THz: 1.0,     // linewidth Δν (FWHM) in THz for plotting convenience
      gamma0: 0.1,      // cm^-1 peak gain
      alphaS: 0.05,     // cm^-1 additional loss
      L: 1.0            // cm
    };

    // Lorentzian gain with FWHM = Δν:
    // γ(δ) = γ0 / (1 + 4*(δ/Δν)^2), where δ is detuning in same units as Δν.
    function gammaOfDetuning_THz(delta_THz){
      const x = delta_THz / params.dnu_THz;
      return params.gamma0 / (1 + 4*x*x);
    }

    // Average gain over flat-top band ν0±B; define k = B/Δν.
    // γ̄(k) = γ0 * (Δν/(2B)) * arctan(2B/Δν) = γ0 * (1/(2k)) * arctan(2k).
    function gammaBarOfK(k){
      return params.gamma0 * (Math.atan(2*k) / (2*k));
    }

    function netFactorOfK(k){
      const gbar = gammaBarOfK(k);
      const gnet = gbar - params.alphaS;
      return Math.exp(gnet * params.L);
    }

    // ---------- Canvas rendering helpers (HiDPI, responsive) ----------
    function setupCanvas(canvas, logicalHeight){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(10, rect.width);
      const h = logicalHeight ?? rect.height;
      canvas.width = Math.round(w * dpr);
      canvas.height = Math.round(h * dpr);
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0);
      ctx.imageSmoothingEnabled = true;
      return {ctx, w, h, dpr};
    }

    function drawPanelBG(ctx, w, h){
      // subtle vignette
      const g = ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0, "rgba(255,255,255,0.03)");
      g.addColorStop(1, "rgba(0,0,0,0.05)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);
    }

    function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
      const {x,y,w,h} = box;
      ctx.save();
      // Title
      ctx.fillStyle = "rgba(233,238,252,0.92)";
      ctx.font = "600 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText(title, x, y - 10);

      // Axes lines
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.rect(x,y,w,h);
      ctx.stroke();

      // Grid + ticks
      const nx = 6, ny = 5;
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      ctx.fillStyle = "rgba(182,194,226,0.9)";

      // Gridlines
      ctx.strokeStyle = "rgba(255,255,255,0.08)";
      for(let i=1;i<nx;i++){
        const xx = x + (i/nx)*w;
        ctx.beginPath(); ctx.moveTo(xx, y); ctx.lineTo(xx, y+h); ctx.stroke();
      }
      for(let j=1;j<ny;j++){
        const yy = y + (j/ny)*h;
        ctx.beginPath(); ctx.moveTo(x, yy); ctx.lineTo(x+w, yy); ctx.stroke();
      }

      // Tick labels
      ctx.fillStyle = "rgba(182,194,226,0.9)";
      for(let i=0;i<=nx;i++){
        const t = i/nx;
        const val = xMin + t*(xMax-xMin);
        const xx = x + t*w;
        const s = (Math.abs(val) < 1e-9 ? "0" : (Math.round(val*100)/100).toString());
        ctx.fillText(s, xx-10, y+h+18);
      }
      for(let j=0;j<=ny;j++){
        const t = 1 - j/ny;
        const val = yMin + t*(yMax-yMin);
        const yy = y + j*(h/ny);
        const s = (Math.round(val*1000)/1000).toString();
        ctx.fillText(s, x-52, yy+4);
      }

      // Labels
      ctx.fillStyle = "rgba(182,194,226,0.95)";
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText(xLabel, x + w/2 - ctx.measureText(xLabel).width/2, y+h+38);

      ctx.save();
      ctx.translate(x-70, y + h/2);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
      ctx.restore();

      ctx.restore();
    }

    function mapX(val, xMin, xMax, box){
      return box.x + (val - xMin) / (xMax - xMin) * box.w;
    }
    function mapY(val, yMin, yMax, box){
      return box.y + (1 - (val - yMin) / (yMax - yMin)) * box.h;
    }

    function drawLine(ctx, pts, strokeStyle, lineWidth){
      ctx.save();
      ctx.strokeStyle = strokeStyle;
      ctx.lineWidth = lineWidth || 2;
      ctx.beginPath();
      pts.forEach((p,i)=>{
        if(i===0) ctx.moveTo(p[0],p[1]);
        else ctx.lineTo(p[0],p[1]);
      });
      ctx.stroke();
      ctx.restore();
    }

    function drawLegend(ctx, x, y, items){
      ctx.save();
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillStyle = "rgba(233,238,252,0.92)";
      let yy = y;
      items.forEach(it=>{
        ctx.fillStyle = it.color;
        ctx.fillRect(x, yy-9, 14, 3);
        ctx.fillStyle = "rgba(233,238,252,0.92)";
        ctx.fillText(it.label, x+20, yy);
        yy += 18;
      });
      ctx.restore();
    }

    // ---------- Diagram canvas ----------
    function renderDiagram(canvas, k){
      const {ctx,w,h} = setupCanvas(canvas, 320);
      ctx.clearRect(0,0,w,h);
      drawPanelBG(ctx,w,h);

      // margins
      const pad = 18;
      const midY = h*0.55;

      // Input spectrum icon (left)
      ctx.save();
      ctx.fillStyle = "rgba(182,194,226,0.9)";
      ctx.font = "600 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText("Broadband input", pad, pad+6);

      // draw flat-top spectrum rectangle
      const specX = pad, specY = pad+18, specW = 170, specH = 70;
      ctx.strokeStyle = "rgba(120,166,255,0.55)";
      ctx.lineWidth = 1.5;
      ctx.strokeRect(specX, specY, specW, specH);

      // inside: a flat-top bar with jitter
      ctx.fillStyle = "rgba(120,166,255,0.16)";
      ctx.fillRect(specX+10, specY+18, specW-20, 28);

      ctx.fillStyle = "rgba(233,238,252,0.9)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      ctx.fillText("center at ν0", specX+12, specY+58);
      ctx.fillText("bandwidth = 2B", specX+12, specY+74);

      // Medium block
      const blockX = w*0.34, blockY = h*0.35, blockW = w*0.36, blockH = h*0.28;
      const grd = ctx.createLinearGradient(blockX, blockY, blockX+blockW, blockY+blockH);
      grd.addColorStop(0, "rgba(120,255,214,0.14)");
      grd.addColorStop(1, "rgba(120,166,255,0.12)");
      ctx.fillStyle = grd;
      ctx.strokeStyle = "rgba(255,255,255,0.18)";
      ctx.lineWidth = 1.2;
      roundRect(ctx, blockX, blockY, blockW, blockH, 16, true, true);

      // labels on medium
      ctx.fillStyle = "rgba(233,238,252,0.92)";
      ctx.font = "600 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText("Inverted gain medium", blockX+14, blockY+22);

      ctx.fillStyle = "rgba(182,194,226,0.95)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      ctx.fillText(`γ(ν): Lorentzian`, blockX+14, blockY+44);
      ctx.fillText(`αs: constant loss`, blockX+14, blockY+62);
      ctx.fillText(`Length L = ${params.L.toFixed(2)} cm`, blockX+14, blockY+80);

      // arrows
      drawArrow(ctx, specX+specW+20, midY, blockX-10, midY, "rgba(233,238,252,0.70)");
      drawArrow(ctx, blockX+blockW+10, midY, w-pad, midY, "rgba(233,238,252,0.70)");

      // output label + net result
      ctx.fillStyle = "rgba(182,194,226,0.9)";
      ctx.font = "600 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText("Output", w-pad-70, pad+6);

      const gbar = gammaBarOfK(k);
      const gnet = gbar - params.alphaS;
      const G = Math.exp(gnet*params.L);

      const badgeX = w-pad-210, badgeY = pad+18, badgeW = 192, badgeH = 74;
      ctx.fillStyle = "rgba(0,0,0,0.22)";
      ctx.strokeStyle = "rgba(255,255,255,0.14)";
      roundRect(ctx, badgeX, badgeY, badgeW, badgeH, 16, true, true);

      const statusColor = (G>=1) ? "rgba(125,255,138,0.90)" : "rgba(255,110,138,0.90)";
      ctx.fillStyle = statusColor;
      ctx.font = "700 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText(G>=1 ? "Net Gain" : "Net Loss", badgeX+14, badgeY+24);

      ctx.fillStyle = "rgba(233,238,252,0.92)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      ctx.fillText(`γ̄ = ${gbar.toFixed(5)} cm⁻¹`, badgeX+14, badgeY+46);
      ctx.fillText(`G = ${G.toFixed(5)}`, badgeX+14, badgeY+64);

      // bandwidth note at bottom
      ctx.fillStyle = "rgba(182,194,226,0.85)";
      ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
      ctx.fillText(`Interactive parameter: k = B/Δν = ${k.toFixed(2)} (so bandwidth = 2B = ${ (2*k*params.dnu_THz).toFixed(2) } THz)`, pad, h-pad);

      ctx.restore();
    }

    function roundRect(ctx, x, y, w, h, r, fill, stroke){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
      if(fill) ctx.fill();
      if(stroke) ctx.stroke();
    }

    function drawArrow(ctx, x1, y1, x2, y2, color){
      const head = 10;
      const dx = x2-x1, dy = y2-y1;
      const ang = Math.atan2(dy,dx);
      ctx.save();
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(x2,y2);
      ctx.stroke();
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(x2,y2);
      ctx.lineTo(x2 - head*Math.cos(ang - Math.PI/6), y2 - head*Math.sin(ang - Math.PI/6));
      ctx.lineTo(x2 - head*Math.cos(ang + Math.PI/6), y2 - head*Math.sin(ang + Math.PI/6));
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    // ---------- Main plot canvas: Lorentzian + band + average line ----------
    function renderMain(canvas, k){
      const {ctx,w,h} = setupCanvas(canvas, 320);
      ctx.clearRect(0,0,w,h);
      drawPanelBG(ctx,w,h);

      const padL=70, padR=18, padT=34, padB=54;
      const box = {x:padL, y:padT, w:w-padL-padR, h:h-padT-padB};

      // choose plotting x-range in THz detuning
      const xMin = -5*params.dnu_THz;
      const xMax =  5*params.dnu_THz;

      // y-range: from 0 to a bit above gamma0
      const yMin = 0;
      const yMax = params.gamma0 * 1.05;

      drawAxes(ctx, box, xMin, xMax, yMin, yMax,
              "Detuning δ = ν − ν0 (THz)", "Gain coefficient γ (cm⁻¹)",
              "Lorentzian gain profile and effective average γ̄ over the signal band");

      // shaded band: δ ∈ [-B, +B], B=kΔν
      const B = k*params.dnu_THz;
      const xBand1 = mapX(-B, xMin, xMax, box);
      const xBand2 = mapX(+B, xMin, xMax, box);
      ctx.save();
      ctx.fillStyle = "rgba(120,166,255,0.10)";
      ctx.fillRect(xBand1, box.y, xBand2-xBand1, box.h);
      ctx.strokeStyle = "rgba(120,166,255,0.35)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      ctx.moveTo(xBand1, box.y);
      ctx.lineTo(xBand1, box.y+box.h);
      ctx.moveTo(xBand2, box.y);
      ctx.lineTo(xBand2, box.y+box.h);
      ctx.stroke();
      ctx.restore();

      // Lorentzian curve
      const N = 600;
      const pts = [];
      for(let i=0;i<=N;i++){
        const x = xMin + (i/N)*(xMax-xMin);
        const y = gammaOfDetuning_THz(x);
        pts.push([mapX(x,xMin,xMax,box), mapY(y,yMin,yMax,box)]);
      }
      drawLine(ctx, pts, "rgba(120,255,214,0.85)", 2.5);

      // average gain line
      const gbar = gammaBarOfK(k);
      const ybar = mapY(gbar, yMin, yMax, box);
      ctx.save();
      ctx.strokeStyle = "rgba(255,207,110,0.75)";
      ctx.lineWidth = 2;
      ctx.setLineDash([6,4]);
      ctx.beginPath();
      ctx.moveTo(box.x, ybar);
      ctx.lineTo(box.x+box.w, ybar);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = "rgba(255,207,110,0.95)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      ctx.fillText(`γ̄ = ${gbar.toFixed(5)} cm⁻¹`, box.x+8, ybar-8);
      ctx.restore();

      // mark alpha_s for reference (not "gain", but a competing loss)
      const yAlpha = mapY(params.alphaS, yMin, yMax, box);
      ctx.save();
      ctx.strokeStyle = "rgba(255,110,138,0.65)";
      ctx.lineWidth = 1.8;
      ctx.setLineDash([4,4]);
      ctx.beginPath();
      ctx.moveTo(box.x, yAlpha);
      ctx.lineTo(box.x+box.w, yAlpha);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = "rgba(255,110,138,0.90)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      ctx.fillText(`αs = ${params.alphaS.toFixed(3)} cm⁻¹`, box.x+8, yAlpha+16);
      ctx.restore();

      // legend
      drawLegend(ctx, box.x + box.w - 220, box.y + 20, [
        {color:"rgba(120,255,214,0.85)", label:"γ(ν) Lorentzian"},
        {color:"rgba(120,166,255,0.55)", label:"signal band ν0±B"},
        {color:"rgba(255,207,110,0.85)", label:"average γ̄ over band"},
        {color:"rgba(255,110,138,0.85)", label:"loss αs (reference)"}
      ]);
    }

    // ---------- Sweep plot: net factor vs k ----------
    function renderSweep(canvas, kNow){
      const {ctx,w,h} = setupCanvas(canvas, 320);
      ctx.clearRect(0,0,w,h);
      drawPanelBG(ctx,w,h);

      const padL=70, padR=18, padT=34, padB=54;
      const box = {x:padL, y:padT, w:w-padL-padR, h:h-padT-padB};

      const xMin = 0.1, xMax = 5.0; // k range
      // y range for net factor: choose based on extremes in range
      let minG=Infinity, maxG=-Infinity;
      for(let i=0;i<=250;i++){
        const kk = xMin + (i/250)*(xMax-xMin);
        const G = netFactorOfK(kk);
        minG = Math.min(minG, G);
        maxG = Math.max(maxG, G);
      }
      // padding
      const yMin = Math.max(0, minG - 0.01);
      const yMax = maxG + 0.01;

      drawAxes(ctx, box, xMin, xMax, yMin, yMax,
              "Bandwidth parameter k = B/Δν (dimensionless)", "Net factor G = exp[(γ̄−αs)L]",
              "How net amplification changes as the signal bandwidth widens");

      // curve
      const pts = [];
      const N=450;
      for(let i=0;i<=N;i++){
        const kk = xMin + (i/N)*(xMax-xMin);
        const G = netFactorOfK(kk);
        pts.push([mapX(kk,xMin,xMax,box), mapY(G,yMin,yMax,box)]);
      }
      drawLine(ctx, pts, "rgba(120,166,255,0.85)", 2.5);

      // G=1 reference line
      const y1 = mapY(1.0, yMin, yMax, box);
      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,0.22)";
      ctx.lineWidth = 1.5;
      ctx.setLineDash([5,5]);
      ctx.beginPath();
      ctx.moveTo(box.x, y1);
      ctx.lineTo(box.x+box.w, y1);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.fillStyle = "rgba(233,238,252,0.9)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      ctx.fillText("G = 1 (gain/loss boundary)", box.x+8, y1-8);
      ctx.restore();

      // vertical marker at current k
      const xK = mapX(kNow, xMin, xMax, box);
      const Gnow = netFactorOfK(kNow);
      const yK = mapY(Gnow, yMin, yMax, box);
      ctx.save();
      ctx.strokeStyle = "rgba(255,207,110,0.70)";
      ctx.lineWidth = 1.8;
      ctx.beginPath();
      ctx.moveTo(xK, box.y);
      ctx.lineTo(xK, box.y+box.h);
      ctx.stroke();
      ctx.fillStyle = "rgba(255,207,110,0.95)";
      ctx.beginPath();
      ctx.arc(xK, yK, 4.2, 0, Math.PI*2);
      ctx.fill();
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      ctx.fillText(`k=${kNow.toFixed(2)}, G=${Gnow.toFixed(5)}`, xK+8, yK-10);
      ctx.restore();

      // legend
      drawLegend(ctx, box.x + box.w - 210, box.y + 20, [
        {color:"rgba(120,166,255,0.85)", label:"G(k) for given γ0, αs, L"},
        {color:"rgba(255,207,110,0.85)", label:"current k marker"}
      ]);
    }

    // ---------- UI wiring ----------
    const bw = document.getElementById('bw');
    const bwRead = document.getElementById('bwRead');
    const kpiGbar = document.getElementById('kpiGbar');
    const kpiG = document.getElementById('kpiG');

    const cDiagram = document.getElementById('cDiagram');
    const cMain = document.getElementById('cMain');
    const cSweep = document.getElementById('cSweep');

    function updateAll(){
      const k = parseFloat(bw.value);
      bwRead.textContent = `k = ${k.toFixed(2)}`;

      const gbar = gammaBarOfK(k);
      const G = netFactorOfK(k);

      kpiGbar.textContent = gbar.toFixed(5);
      kpiG.textContent = G.toFixed(5);

      renderDiagram(cDiagram, k);
      renderMain(cMain, k);
      renderSweep(cSweep, k);

      // mini status
      const status = (G>=1) ? `Net gain (+${((G-1)*100).toFixed(2)}%)` : `Net loss (${((G-1)*100).toFixed(2)}%)`;
      document.getElementById('miniStatus').innerHTML =
        `Slider: <b>k = B/Δν</b>. Current: <b>${status}</b><br>
         Uses γ̄(k)=γ0·[atan(2k)/(2k)] and G=exp[(γ̄−αs)L].`;
    }

    bw.addEventListener('input', updateAll);

    // Re-render on resize (responsive)
    let resizeTimer=null;
    window.addEventListener('resize', ()=>{
      clearTimeout(resizeTimer);
      resizeTimer=setTimeout(updateAll, 120);
    });

    // Initial render
    updateAll();
  </script>
</body>
</html>
