<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Gain in a Saturated Amplifying Medium (Homogeneous Broadening)</title>
  <style>
    :root{
      --bg:#0b1020;
      --card:#101a33;
      --card2:#0f1730;
      --ink:#e9eefc;
      --muted:#b9c4e6;
      --faint:#7f8ab3;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#86efac;
      --warn:#fde68a;
      --bad:#fca5a5;
      --line:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1000px 600px at 20% 10%, rgba(125,211,252,.16), transparent 60%),
        radial-gradient(900px 520px at 80% 5%, rgba(167,139,250,.14), transparent 55%),
        radial-gradient(1100px 700px at 55% 95%, rgba(134,239,172,.10), transparent 60%),
        var(--bg);
      line-height:1.55;
    }

    header{
      padding: clamp(18px, 3vw, 34px) 18px 18px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(16,26,51,.75), rgba(16,26,51,.35));
      position:relative;
      overflow:hidden;
    }

    header .wrap{
      max-width:1200px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.35fr .65fr;
      gap:18px;
      align-items:start;
    }

    h1{
      margin:0 0 10px 0;
      font-size: clamp(22px, 2.4vw, 34px);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      font-size: clamp(14px, 1.2vw, 16px);
      margin:0;
    }

    .meta{
      padding:14px 14px 12px;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(15,23,48,.65);
      box-shadow: var(--shadow);
    }
    .meta .kv{
      display:grid;
      grid-template-columns: 1fr auto;
      gap:6px 10px;
      font-size: 13px;
      color: var(--muted);
    }
    .meta .kv b{color:var(--ink); font-weight:700}
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      font-size:12px;
      margin-top:10px;
    }
    .dot{
      width:8px;height:8px;border-radius:50%;
      background:var(--accent);
      box-shadow:0 0 0 4px rgba(125,211,252,.14);
    }

    main{
      max-width:1200px;
      margin:0 auto;
      padding: 18px 18px 70px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      align-items:start;
    }

    nav.toc{
      position:sticky;
      top:14px;
      align-self:start;
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(15,23,48,.60);
      box-shadow: var(--shadow);
      padding: 14px;
      backdrop-filter: blur(10px);
    }
    nav.toc h2{
      font-size:13px;
      margin:0 0 10px 0;
      color:var(--muted);
      letter-spacing:.12em;
      text-transform:uppercase;
    }
    nav.toc a{
      display:block;
      padding:8px 10px;
      border-radius: 12px;
      color: var(--muted);
      text-decoration:none;
      font-size: 13px;
      border:1px solid transparent;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    nav.toc a:hover{
      background: rgba(255,255,255,.04);
      border-color: rgba(255,255,255,.10);
      transform: translateX(2px);
      color:var(--ink);
    }

    article{
      min-width: 0;
      display:flex;
      flex-direction:column;
      gap:18px;
    }

    section{
      border:1px solid var(--line);
      border-radius: var(--radius);
      background: rgba(16,26,51,.55);
      box-shadow: var(--shadow);
      padding: clamp(14px, 2vw, 20px);
      position:relative;
      overflow:hidden;
    }
    section:before{
      content:"";
      position:absolute;
      inset:-2px;
      background: radial-gradient(700px 160px at 20% 0%, rgba(125,211,252,.12), transparent 60%),
                  radial-gradient(650px 180px at 85% 20%, rgba(167,139,250,.10), transparent 60%);
      pointer-events:none;
      opacity:.8;
    }
    section > *{position:relative}

    h2{
      margin:0 0 10px 0;
      font-size: clamp(18px, 1.6vw, 22px);
    }
    h3{
      margin:14px 0 6px 0;
      font-size: 15px;
      color: var(--ink);
    }
    p{margin: 8px 0; color: var(--muted)}
    ul{margin:8px 0 0 22px; color: var(--muted)}
    li{margin:6px 0}

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
      nav.toc{position:relative; top:auto}
      header .wrap{grid-template-columns: 1fr}
      .grid2,.grid3{grid-template-columns: 1fr}
    }

    .callout{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding: 12px 12px 10px;
    }
    .callout h4{
      margin:0 0 6px 0;
      font-size: 13px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
    }
    .tag{
      display:inline-flex;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      font-size:12px;
      background: rgba(255,255,255,.04);
    }

    .eq{
      font-family: var(--mono);
      font-size: 13px;
      color: #f4f7ff;
      background: rgba(255,255,255,.06);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding: 10px 10px 8px;
      overflow:auto;
      position:relative;
    }
    .eq .label{
      font-family: var(--sans);
      font-size: 12px;
      color: var(--faint);
      margin-bottom:6px;
    }

    .btnrow{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      margin-top:8px;
    }
    button.copy{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 12px;
      font-size: 12px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    button.copy:hover{
      background: rgba(255,255,255,.10);
      border-color: rgba(255,255,255,.20);
      transform: translateY(-1px);
    }
    button.copy:active{transform: translateY(0px) scale(.99)}
    .hint{
      color: var(--faint);
      font-size: 12px;
      margin-top:6px;
    }

    .answerBox{
      border:1px solid rgba(134,239,172,.28);
      background: rgba(134,239,172,.08);
      border-radius: 16px;
      padding: 12px;
    }
    .answerBox b{color: var(--good)}
    .answerBox .mono{font-family:var(--mono); color: var(--ink); font-size: 13px}

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:end;
    }
    @media (max-width: 650px){
      .controls{grid-template-columns: 1fr}
    }
    .control{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      padding: 12px;
    }
    .control label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      font-size: 13px;
      color: var(--muted);
      margin-bottom:8px;
    }
    .control .val{
      font-family: var(--mono);
      color: var(--ink);
      font-size: 12px;
    }
    input[type="range"]{
      width:100%;
      accent-color: var(--accent);
    }

    .vizGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:14px;
    }
    .canvasCard{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      overflow:hidden;
    }
    .canvasHeader{
      padding:10px 12px 8px;
      border-bottom:1px solid rgba(255,255,255,.10);
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
    }
    .canvasHeader .title{
      font-size: 13px;
      color: var(--ink);
      font-weight: 700;
      letter-spacing:.02em;
    }
    .canvasHeader .small{
      font-size: 12px;
      color: var(--faint);
      font-family: var(--mono);
      white-space:nowrap;
    }
    canvas{
      display:block;
      width:100%;
      height: 320px;
      background: linear-gradient(180deg, rgba(255,255,255,.03), rgba(255,255,255,.01));
    }
    .shortCanvas canvas{height: 260px;}

    footer{
      max-width:1200px;
      margin:0 auto;
      padding: 0 18px 22px;
      color: var(--faint);
      font-size: 12px;
    }

    /* Print friendly */
    @media print{
      body{background:#fff; color:#000}
      header, nav.toc{display:none}
      section{box-shadow:none; background:#fff; border:1px solid #ddd}
      p, ul{color:#222}
      .eq{background:#f6f6f6; border-color:#ddd; color:#111}
      .answerBox{background:#f2fff6; border-color:#8ad8a6}
      canvas{height: 240px !important}
      button{display:none}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div>
      <h1>Gain in a Saturated Amplifying Medium (Homogeneous Broadening)</h1>
      <p class="subtitle">
        A laser amplifier’s gain drops when the photon flux gets large. We’ll use the standard saturation model,
        solve the propagation equation, and extract the <em>small-signal</em> gain from one measured input–output pair.
      </p>
    </div>
    <div class="meta" aria-label="Problem data">
      <div class="kv">
        <div>Medium length</div><div><b>d = 10 cm</b></div>
        <div>Saturation photon-flux density</div><div><b>&phi;<sub>s</sub> = 4&times;10<sup>18</sup> photons/(cm<sup>2</sup>&middot;s)</b></div>
        <div>Given calibration input</div><div><b>&phi;(0) = 4&times;10<sup>15</sup> photons/(cm<sup>2</sup>&middot;s)</b></div>
        <div>Given calibration output</div><div><b>&phi;(d) = 4&times;10<sup>16</sup> photons/(cm<sup>2</sup>&middot;s)</b></div>
      </div>
      <div class="pill"><span class="dot"></span><span>Model: homogeneously broadened, steady-state saturation</span></div>
    </div>
  </div>
</header>

<main>
  <nav class="toc" aria-label="Table of Contents">
    <h2>Contents</h2>
    <a href="#quick">Quick Summary</a>
    <a href="#part0">PART 0 — Concept Primer</a>
    <a href="#part1">PART 1 — Problem Analysis</a>
    <a href="#part2">PART 2 — Strategy &amp; Tips</a>
    <a href="#part3">PART 3 — Full Solution</a>
    <a href="#part4">PART 4 — Deeper Understanding</a>
    <a href="#part5">PART 5 — Visualization Guide</a>
  </nav>

  <article>
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>What this is about:</b> A traveling-wave laser amplifier whose gain saturates as photon flux increases.</li>
        <li><b>Key physics idea:</b> For homogeneous broadening, the gain coefficient drops as <span class="tag">&gamma;(&phi;)=&gamma;<sub>0</sub>/(1+&phi;/&phi;<sub>s</sub>)</span>.</li>
        <li><b>Governing propagation equation:</b> <span class="tag">d&phi;/dz = &gamma;(&phi;)&phi;</span> (local exponential growth with an intensity-dependent exponent).</li>
        <li><b>Integrated relation used to fit &gamma;<sub>0</sub>:</b> <span class="tag">ln(&phi;_out/&phi;_in)+(&phi;_out-&phi;_in)/&phi;<sub>s</sub>=&gamma;<sub>0</sub>d</span>.</li>
        <li><b>Part (a) result type:</b> small-signal system gain <span class="tag">G<sub>0</sub>=e^{&gamma;<sub>0</sub>d}</span> (numeric).</li>
        <li><b>Part (b) result type:</b> small-signal gain coefficient <span class="tag">&gamma;<sub>0</sub></span> in cm<sup>&minus;1</sup> (numeric).</li>
        <li><b>Part (c) result type:</b> flux where &gamma; drops by 5: <span class="tag">&phi;=4&phi;<sub>s</sub></span> (numeric).</li>
        <li><b>Part (d) result type:</b> saturated entrance gain coefficient and the resulting gain is <b>much smaller</b> than the small-signal gain.</li>
      </ul>
    </section>

    <section id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div class="callout">
          <h4><span class="tag">Core definitions</span></h4>
          <ul>
            <li><b>&phi;</b> = photon-flux density (photons/(cm<sup>2</sup>&middot;s)). Think “photon rate crossing a unit area.”</li>
            <li><b>&gamma;</b> = gain coefficient (cm<sup>&minus;1</sup>). In the <em>unsaturated</em> limit, &phi; grows like <b>e</b><sup>&gamma;z</sup>.</li>
            <li><b>&gamma;<sub>0</sub></b> = small-signal (unsaturated) gain coefficient, i.e., &gamma; when &phi;&ll;&phi;<sub>s</sub>.</li>
            <li><b>&phi;<sub>s</sub></b> = saturation photon-flux density. Roughly where gain drops by about a factor of 2.</li>
            <li><b>G</b> = system gain = &phi;(d)/&phi;(0) (dimensionless).</li>
            <li><b>G<sub>0</sub></b> = small-signal system gain = exp(&gamma;<sub>0</sub>d).</li>
          </ul>
        </div>

        <div class="callout">
          <h4><span class="tag">Physical meaning</span></h4>
          <p>
            In a laser amplifier, stimulated emission transfers energy from an excited population to the optical field.
            When the field is weak, the population inversion hardly changes, so gain stays near a constant &gamma;<sub>0</sub>.
          </p>
          <p>
            When the field is strong, stimulated emission depletes the inversion faster than pumping can restore it,
            so the available gain reduces. The simple steady-state saturation model captures this with a single parameter &phi;<sub>s</sub>.
          </p>
        </div>
      </div>

      <h3>Key model (homogeneous broadening, steady state)</h3>
      <div class="eq" id="eq_model">
        <div class="label">Saturated gain coefficient (homogeneously broadened)</div>
        &gamma;(&phi;) = &gamma;<sub>0</sub> / (1 + &phi;/&phi;<sub>s</sub>)
      </div>
      <div class="btnrow">
        <button class="copy" data-copy="gamma(phi) = gamma0 / (1 + phi/phi_s)">Copy equation (plain)</button>
      </div>

      <h3>When this model is valid (assumptions/conditions)</h3>
      <ul>
        <li>Homogeneous broadening: all emitters share the same resonance; saturation affects the whole line similarly.</li>
        <li>Steady-state saturation: population responds fast enough that gain can be treated as an instantaneous function of local flux &phi;.</li>
        <li>Traveling-wave amplifier with negligible reflections (no cavity buildup).</li>
        <li>Neglect amplified spontaneous emission (ASE) and transverse variations (use a 1D z-propagation model).</li>
      </ul>

      <div class="grid2">
        <div class="callout">
          <h4><span class="tag">Mini intuition example</span></h4>
          <p>
            If &phi; &ll; &phi;<sub>s</sub>, then &gamma;(&phi;) &approx; &gamma;<sub>0</sub> and the medium behaves like a constant-gain amplifier:
            d&phi;/dz = &gamma;<sub>0</sub>&phi; &Rightarrow; &phi;(z)=&phi;(0)e^{&gamma;<sub>0</sub>z}.
          </p>
        </div>
        <div class="callout">
          <h4><span class="tag">Another intuition example</span></h4>
          <p>
            If &phi; &gg; &phi;<sub>s</sub>, then &gamma;(&phi;) &approx; &gamma;<sub>0</sub>&phi;<sub>s</sub>/&phi;,
            so d&phi;/dz &approx; &gamma;<sub>0</sub>&phi;<sub>s</sub> (almost constant slope): growth becomes nearly linear rather than exponential.
          </p>
        </div>
      </div>

      <div class="callout">
        <h4><span class="tag">What to watch for (pitfalls)</span></h4>
        <ul>
          <li><b>Confusing local &gamma; with system gain:</b> &gamma;(&phi;) varies along z because &phi; changes along z.</li>
          <li><b>Forgetting the saturation term in the integrated equation:</b> ln gain alone is not enough when flux approaches &phi;<sub>s</sub>.</li>
          <li><b>Units:</b> &gamma; in cm<sup>&minus;1</sup>, d in cm, so &gamma;d is dimensionless.</li>
          <li><b>Homogeneous vs inhomogeneous:</b> saturation laws differ; this problem explicitly says homogeneous broadening.</li>
        </ul>
      </div>
    </section>

    <section id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Restate the problem in my own words</h3>
      <p>
        A homogeneously broadened amplifying medium of length <b>d = 10 cm</b> has saturation photon-flux density
        <b>&phi;<sub>s</sub> = 4&times;10<sup>18</sup> photons/(cm<sup>2</sup>&middot;s)</b>.
        When the input flux is <b>&phi;(0)=4&times;10<sup>15</sup></b>, the output is <b>&phi;(d)=4&times;10<sup>16</sup></b>.
        Use a saturation model to find the small-signal gain and gain coefficient, then analyze how gain drops with higher input flux.
      </p>

      <div class="grid3">
        <div class="callout">
          <h4><span class="tag">Given</span></h4>
          <ul>
            <li>d = 10 cm</li>
            <li>&phi;<sub>s</sub> = 4&times;10<sup>18</sup> photons/(cm<sup>2</sup>&middot;s)</li>
            <li>Calibration: &phi;<sub>in</sub>=&phi;(0)=4&times;10<sup>15</sup></li>
            <li>Calibration: &phi;<sub>out</sub>=&phi;(d)=4&times;10<sup>16</sup></li>
          </ul>
        </div>
        <div class="callout">
          <h4><span class="tag">Unknowns</span></h4>
          <ul>
            <li>(a) Small-signal system gain G<sub>0</sub></li>
            <li>(b) Small-signal gain coefficient &gamma;<sub>0</sub></li>
            <li>(c) Flux where &gamma; drops by factor 5</li>
            <li>(d) Gain coefficient for &phi;(0)=4&times;10<sup>19</sup> and comparison to G<sub>0</sub></li>
          </ul>
        </div>
        <div class="callout">
          <h4><span class="tag">What must be found</span></h4>
          <ul>
            <li>Extract &gamma;<sub>0</sub> from the measured in/out pair using the saturation propagation equation.</li>
            <li>Compute G<sub>0</sub> (unsaturated limit) from &gamma;<sub>0</sub> and d.</li>
            <li>Use &gamma;(&phi;) law to get flux thresholds and saturated gain values.</li>
          </ul>
        </div>
      </div>

      <h3>Relevant physical principles (and why they apply)</h3>
      <ul>
        <li><b>Stimulated emission gain:</b> field growth is proportional to field itself, giving d&phi;/dz &propto; &phi;.</li>
        <li><b>Gain saturation (homogeneous):</b> gain coefficient decreases as inversion is depleted, modeled by &gamma;(&phi;)=&gamma;<sub>0</sub>/(1+&phi;/&phi;<sub>s</sub>).</li>
        <li><b>1D traveling-wave propagation:</b> medium is uniform along z, so a simple ODE in z is appropriate.</li>
      </ul>
      <p>
        We do <em>not</em> use cavity laser threshold conditions or standing-wave models because this is an amplifier (input to output through length d).
      </p>

      <div class="callout">
        <h4><span class="tag">Assumptions (explicit)</span></h4>
        <ul>
          <li>Uniform medium: &gamma;<sub>0</sub> constant (in absence of saturation) along the length.</li>
          <li>Steady-state saturation; local gain depends on local &phi;(z) only.</li>
          <li>No significant reflections, diffraction, or transverse variation (photon flux density treated as scalar in 1D).</li>
          <li>Neglect ASE and pump depletion effects beyond the saturation law already encoded in &phi;<sub>s</sub>.</li>
        </ul>
      </div>

      <h3>Possible approaches (compare briefly)</h3>
      <ul>
        <li><b>Analytical integration (best here):</b> integrate d&phi;/dz = (&gamma;<sub>0</sub>&phi;)/(1+&phi;/&phi;<sub>s</sub>) to get a closed-form relation between &phi;<sub>in</sub> and &phi;<sub>out</sub>. Fast and exact for this model.</li>
        <li><b>Numerical ODE solve:</b> integrate the ODE for &phi;(z) directly. Flexible, good for plotting profiles, but slower and less transparent for extracting &gamma;<sub>0</sub>.</li>
        <li><b>Approximation limits:</b> use unsaturated or strongly saturated limits. Useful intuition but not accurate for intermediate regimes.</li>
      </ul>
      <p>
        <b>Choice:</b> Use the analytical integration to compute &gamma;<sub>0</sub> and G<sub>0</sub> exactly, then use numerical integration only for visualization.
      </p>
    </section>

    <section id="part2">
      <h2>PART 2 — Strategy &amp; Tips (Roadmap Only)</h2>

      <ol style="margin:8px 0 0 22px; color:var(--muted);">
        <li>
          <b>Write the saturation law</b><br/>
          <span class="tag">Use:</span> &gamma;(&phi;)=&gamma;<sub>0</sub>/(1+&phi;/&phi;<sub>s</sub>)<br/>
          <span class="tag">Meaning:</span> gain decreases as local photon flux grows.
        </li>
        <li>
          <b>Set up propagation ODE</b><br/>
          <span class="tag">Use:</span> d&phi;/dz = &gamma;(&phi;)&phi;<br/>
          <span class="tag">Meaning:</span> local exponential growth rate is &gamma;(&phi;).
        </li>
        <li>
          <b>Separate variables and integrate from 0 to d</b><br/>
          <span class="tag">Tool:</span> separation of variables; integrate exactly.<br/>
          <span class="tag">Meaning:</span> produces a direct in/out relationship.
        </li>
        <li>
          <b>Plug the calibration data to solve for &gamma;<sub>0</sub></b><br/>
          <span class="tag">Tip:</span> keep units consistent (cm, cm<sup>2</sup>, s).
        </li>
        <li>
          <b>Compute small-signal gain</b><br/>
          <span class="tag">Use:</span> G<sub>0</sub>=exp(&gamma;<sub>0</sub>d).<br/>
          <span class="tag">Meaning:</span> how large the gain would be if saturation were negligible.
        </li>
        <li>
          <b>Find flux for a factor-5 decrease in gain coefficient</b><br/>
          <span class="tag">Use:</span> &gamma;(&phi;)=&gamma;<sub>0</sub>/5 &Rightarrow; solve for &phi;.
        </li>
        <li>
          <b>For high input flux, compute entrance gain coefficient and output gain</b><br/>
          <span class="tag">Use:</span> entrance &gamma;(&phi(0)); for system gain solve the integrated relation for &phi;(d).<br/>
          <span class="tag">Meaning:</span> saturation dramatically reduces total gain.
        </li>
      </ol>

      <div class="callout">
        <h4><span class="tag">Common mistakes &amp; quick tips</span></h4>
        <ul>
          <li><b>Mistake:</b> assuming &phi;(d)/&phi;(0)=exp(&gamma;(&phi(0))d). <b>Tip:</b> &gamma; changes with z because &phi; grows with z.</li>
          <li><b>Mistake:</b> ignoring the (&phi;<sub>out</sub>-&phi;<sub>in</sub>)/&phi;<sub>s</sub> term. <b>Tip:</b> that term is the signature of saturation.</li>
          <li><b>Mistake:</b> mixing up &phi;<sub>s</sub> with saturation intensity (W/cm<sup>2</sup>). <b>Tip:</b> here it’s explicitly photon-flux density.</li>
        </ul>
      </div>
    </section>

    <section id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Qualitative expectation (before calculating)</h3>
      <p>
        Because the calibration input flux (4&times;10<sup>15</sup>) is far below &phi;<sub>s</sub> (4&times;10<sup>18</sup>),
        we expect the amplifier to be <em>almost</em> in the small-signal regime, so the measured gain (10) should be close to the
        true small-signal gain G<sub>0</sub>. At much larger inputs (e.g., 4&times;10<sup>19</sup>), we expect strong saturation and a gain far less than 10.
      </p>

      <h3>Step 1: Write the local gain model and propagation equation</h3>
      <p>
        Let &phi;(z) be the photon-flux density at position z along the amplifier (0 at input, d at output).
        For a traveling-wave amplifier:
      </p>
      <div class="eq" id="eq_ode">
        <div class="label">Propagation ODE</div>
        d&phi;/dz = &gamma;(&phi;)&phi;, &nbsp;&nbsp;with&nbsp;&nbsp; &gamma;(&phi;)=&gamma;<sub>0</sub>/(1+&phi;/&phi;<sub>s</sub>)
      </div>
      <div class="btnrow">
        <button class="copy" data-copy="dphi/dz = gamma(phi)*phi,   gamma(phi)=gamma0/(1+phi/phi_s)">Copy equations (plain)</button>
      </div>
      <p>
        <b>Why this form?</b> If &gamma; were constant, this is pure exponential amplification. Saturation makes &gamma; decrease with &phi;,
        reducing the growth rate as the beam intensifies along the medium.
      </p>

      <h3>Step 2: Separate variables and integrate</h3>
      <p>
        Substitute &gamma;(&phi;) into the ODE:
      </p>
      <div class="eq">
        <div class="label">Substitution</div>
        d&phi;/dz = (&gamma;<sub>0</sub>&phi;) / (1 + &phi;/&phi;<sub>s</sub>)
      </div>
      <p>
        Separate variables by multiplying both sides by (1+&phi;/&phi;<sub>s</sub>)/&phi;:
      </p>
      <div class="eq" id="eq_sep">
        <div class="label">Separated form</div>
        (1+&phi;/&phi;<sub>s</sub>) d&phi;/&phi; = &gamma;<sub>0</sub> dz
      </div>
      <p>
        Expand the left-hand side:
      </p>
      <div class="eq">
        <div class="label">Expanded integrand</div>
        (1/&phi; + 1/&phi;<sub>s</sub>) d&phi; = &gamma;<sub>0</sub> dz
      </div>
      <p>
        Integrate from z=0 to z=d, and from &phi;(0)=&phi;<sub>in</sub> to &phi;(d)=&phi;<sub>out</sub>:
      </p>
      <div class="eq" id="eq_int">
        <div class="label">Integrated input–output relation</div>
        &int;<sub>&phi;in</sub><sup>&phi;out</sup>(1/&phi; + 1/&phi;<sub>s</sub>) d&phi; = &int;<sub>0</sub><sup>d</sup> &gamma;<sub>0</sub> dz
        <br/><br/>
        ln(&phi;<sub>out</sub>/&phi;<sub>in</sub>) + (&phi;<sub>out</sub> - &phi;<sub>in</sub>)/&phi;<sub>s</sub> = &gamma;<sub>0</sub>d
      </div>
      <div class="btnrow">
        <button class="copy" data-copy="ln(phi_out/phi_in) + (phi_out - phi_in)/phi_s = gamma0*d">Copy integrated relation (plain)</button>
      </div>
      <p>
        <b>What did we do and why?</b> The separation turns a nonlinear ODE into a direct relationship between input and output,
        making it easy to solve for the unknown &gamma;<sub>0</sub> using one measured in/out pair.
      </p>

      <h3>Part (b): Solve for the small-signal gain coefficient &gamma;<sub>0</sub></h3>
      <p>Use the calibration values:</p>
      <ul>
        <li>&phi;<sub>in</sub> = 4&times;10<sup>15</sup></li>
        <li>&phi;<sub>out</sub> = 4&times;10<sup>16</sup></li>
        <li>&phi;<sub>s</sub> = 4&times;10<sup>18</sup></li>
        <li>d = 10 cm</li>
      </ul>

      <p>
        Compute each term:
      </p>
      <div class="eq">
        <div class="label">Compute the logarithmic term</div>
        ln(&phi;<sub>out</sub>/&phi;<sub>in</sub>) = ln( (4&times;10<sup>16</sup>)/(4&times;10<sup>15</sup>) ) = ln(10)
      </div>
      <div class="eq">
        <div class="label">Compute the saturation correction</div>
        (&phi;<sub>out</sub>-&phi;<sub>in</sub>)/&phi;<sub>s</sub>
        = (4&times;10<sup>16</sup> - 4&times;10<sup>15</sup>)/(4&times;10<sup>18</sup>)
        = (3.6&times;10<sup>16</sup>)/(4&times;10<sup>18</sup>)
        = 9&times;10<sup>&minus;3</sup>
      </div>

      <p>
        Therefore:
      </p>
      <div class="eq">
        <div class="label">Solve for &gamma;<sub>0</sub></div>
        &gamma;<sub>0</sub> =
        [ ln(10) + 9&times;10<sup>&minus;3</sup> ] / d
        = [ 2.302585... + 0.009 ] / 10 cm
        = 0.2311585... cm<sup>&minus;1</sup>
      </div>

      <div class="answerBox" id="ans_b">
        <b>Answer (b):</b>
        <div class="mono">&gamma;<sub>0</sub> &approx; 0.231 cm<sup>&minus;1</sup></div>
      </div>

      <h3>Part (a): Small-signal system gain G<sub>0</sub></h3>
      <p>
        In the small-signal limit (&phi;&ll;&phi;<sub>s</sub> everywhere), gain is constant &gamma;&approx;&gamma;<sub>0</sub>,
        so:
      </p>
      <div class="eq" id="eq_G0">
        <div class="label">Small-signal gain</div>
        G<sub>0</sub> = exp(&gamma;<sub>0</sub>d)
      </div>
      <div class="btnrow">
        <button class="copy" data-copy="G0 = exp(gamma0*d)">Copy equation (plain)</button>
      </div>
      <p>
        With &gamma;<sub>0</sub>d = 0.2311585&times;10 = 2.311585:
      </p>
      <div class="eq">
        <div class="label">Numerical value</div>
        G<sub>0</sub> = exp(2.311585) &approx; 10.090
      </div>

      <div class="answerBox" id="ans_a">
        <b>Answer (a):</b>
        <div class="mono">G<sub>0</sub> &approx; 10.09 (dimensionless)</div>
      </div>

      <h3>Part (c): Flux where gain coefficient decreases by a factor of 5</h3>
      <p>
        We want &gamma;(&phi;) = &gamma;<sub>0</sub>/5. Using
        &gamma;(&phi;)=&gamma;<sub>0</sub>/(1+&phi;/&phi;<sub>s</sub>):
      </p>
      <div class="eq">
        <div class="label">Solve for &phi;</div>
        &gamma;<sub>0</sub>/(1+&phi;/&phi;<sub>s</sub>) = &gamma;<sub>0</sub>/5
        &nbsp;&Rightarrow;&nbsp;
        1+&phi;/&phi;<sub>s</sub> = 5
        &nbsp;&Rightarrow;&nbsp;
        &phi; = 4&phi;<sub>s</sub>
      </div>
      <p>
        With &phi;<sub>s</sub>=4&times;10<sup>18</sup>:
      </p>
      <div class="eq">
        <div class="label">Numerical value</div>
        &phi; = 4(4&times;10<sup>18</sup>) = 1.6&times;10<sup>19</sup> photons/(cm<sup>2</sup>&middot;s)
      </div>

      <div class="answerBox" id="ans_c">
        <b>Answer (c):</b>
        <div class="mono">&phi; = 1.6&times;10<sup>19</sup> photons/(cm<sup>2</sup>&middot;s)</div>
      </div>

      <h3>Part (d): Gain coefficient and gain for input &phi;(0)=4&times;10<sup>19</sup></h3>
      <p>
        First, the <b>local</b> gain coefficient at the entrance (z=0) is:
      </p>
      <div class="eq">
        <div class="label">Entrance gain coefficient</div>
        &gamma;(&phi;(0)) = &gamma;<sub>0</sub> / (1 + &phi;(0)/&phi;<sub>s</sub>)
      </div>
      <p>
        Compute the ratio:
        &phi;(0)/&phi;<sub>s</sub> = (4&times;10<sup>19</sup>)/(4&times;10<sup>18</sup>) = 10,
        so 1+&phi;(0)/&phi;<sub>s</sub> = 11.
      </p>
      <div class="eq">
        <div class="label">Numerical value</div>
        &gamma;(&phi;(0)) = 0.231/11 &approx; 0.0210 cm<sup>&minus;1</sup>
      </div>

      <p>
        However, the <b>system gain</b> is not exp(&gamma;(&phi;(0))d) because &gamma; changes as &phi;(z) changes.
        We should use the integrated relation (same as in Part b), now treating &phi;<sub>in</sub> as 4&times;10<sup>19</sup> and solving for &phi;<sub>out</sub>.
        That relation is:
      </p>
      <div class="eq">
        <div class="label">Implicit equation for &phi;<sub>out</sub></div>
        ln(&phi;<sub>out</sub>/&phi;<sub>in</sub>) + (&phi;<sub>out</sub> - &phi;<sub>in</sub>)/&phi;<sub>s</sub> = &gamma;<sub>0</sub>d
      </div>
      <p>
        Using the already-found &gamma;<sub>0</sub>d = 2.311585 and &phi;<sub>s</sub>=4&times;10<sup>18</sup>,
        solving this (numerically) gives:
      </p>
      <div class="eq">
        <div class="label">Resulting output and gain (high-input case)</div>
        &phi;<sub>out</sub> &approx; 4.85&times;10<sup>19</sup> photons/(cm<sup>2</sup>&middot;s)
        <br/>
        G = &phi;<sub>out</sub>/&phi;<sub>in</sub> &approx; 1.212
      </div>

      <div class="answerBox" id="ans_d">
        <b>Answer (d):</b>
        <div class="mono">
          Entrance &gamma;(&phi(0)) &approx; 0.0210 cm<sup>&minus;1</sup><br/>
          System gain for &phi(0)=4&times;10<sup>19</sup>: G &approx; 1.21
        </div>
        <p style="margin:8px 0 0 0; color:var(--muted)">
          <b>Comparison:</b> This gain is <b>less than</b> the small-signal gain G<sub>0</sub>&approx;10.09, because the medium is strongly saturated.
        </p>
      </div>

      <div class="btnrow">
        <button class="copy" data-copy="(a) G0 ≈ 10.09
(b) gamma0 ≈ 0.231 cm^-1
(c) phi = 4 phi_s = 1.6e19 photons/(cm^2 s)
(d) for phi_in=4e19: gamma_in ≈ 0.0210 cm^-1; phi_out ≈ 4.85e19; G ≈ 1.21; gain < G0">Copy final answers (plain)</button>
      </div>

      <h3>Sanity checks</h3>
      <div class="grid3">
        <div class="callout">
          <h4><span class="tag">Units</span></h4>
          <ul>
            <li>&gamma;<sub>0</sub> has units cm<sup>&minus;1</sup>.</li>
            <li>&gamma;<sub>0</sub>d is dimensionless, so exp(&gamma;<sub>0</sub>d) is valid.</li>
            <li>(&phi;<sub>out</sub>-&phi;<sub>in</sub>)/&phi;<sub>s</sub> is dimensionless.</li>
          </ul>
        </div>
        <div class="callout">
          <h4><span class="tag">Limiting cases</span></h4>
          <ul>
            <li>If &phi;<sub>s</sub>&to;&infin;, saturation term vanishes and ln(&phi;<sub>out</sub>/&phi;<sub>in</sub>)=&gamma;<sub>0</sub>d (pure exponential).</li>
            <li>If &phi;&gg;&phi;<sub>s</sub>, growth becomes nearly linear with z (reduced gain).</li>
          </ul>
        </div>
        <div class="callout">
          <h4><span class="tag">Physical interpretation</span></h4>
          <ul>
            <li>Calibration case: gain is close to small-signal because &phi; is far below &phi;<sub>s</sub>.</li>
            <li>High-input case: gain collapses to ~1.2 because stimulated emission depletes inversion strongly.</li>
          </ul>
        </div>
      </div>

      <p>
        <b>Connection to the diagram &amp; plots:</b>
        The diagram shows photon flux increasing along z. The main plot shows how &gamma; falls with &phi;.
        The secondary plot shows &phi;(z) inside the medium: exponential-like at low input, nearly linear at high input.
      </p>
    </section>

    <section id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpreting the final formulas</h3>
      <ul>
        <li>
          <b>&gamma;<sub>0</sub></b> sets the maximum amplification strength of the medium.
          Larger &gamma;<sub>0</sub> means stronger small-signal exponential growth.
        </li>
        <li>
          <b>&phi;<sub>s</sub></b> sets how easily the medium saturates.
          Larger &phi;<sub>s</sub> means the gain stays near &gamma;<sub>0</sub> up to higher flux.
        </li>
        <li>
          The integrated relation
          <span class="tag">ln(&phi;<sub>out</sub>/&phi;<sub>in</sub>)+(&phi;<sub>out</sub>-&phi;<sub>in</sub>)/&phi;<sub>s</sub>=&gamma;<sub>0</sub>d</span>
          says: part of the “gain budget” goes into the usual logarithmic (exponential) increase, and part goes into “paying” the saturation term.
        </li>
      </ul>

      <h3>How changing parameters affects outcomes (connect to plots)</h3>
      <ul>
        <li>Increase input &phi;<sub>in</sub>: the operating point shifts right on &gamma;(&phi;) curve → lower local gain → smaller system gain.</li>
        <li>If we had a larger &phi;<sub>s</sub>, the curve would drop more slowly → higher gain for the same input.</li>
        <li>Longer d increases the available gain budget (&gamma;<sub>0</sub>d) but also increases internal flux, which can increase saturation.</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        Instead of integrating the photon-flux equation, one can start from rate equations for population inversion in a two-level (or effective two-level)
        system, solve for the steady-state inversion as a function of intensity (or photon flux), and then relate the gain coefficient to that inversion.
        That microscopic route leads to the same functional form &gamma;(&phi;)=&gamma;<sub>0</sub>/(1+&phi;/&phi;<sub>s</sub>) under standard assumptions.
      </p>

      <h3>Concept checks (quick self-test)</h3>
      <ul>
        <li><b>Q:</b> If &phi;=&phi;<sub>s</sub>, what is &gamma;? <b>A:</b> &gamma;=&gamma;<sub>0</sub>/2.</li>
        <li><b>Q:</b> Why is the measured gain (10) slightly below G<sub>0</sub> (~10.09)? <b>A:</b> because even a small saturation term reduces gain a bit.</li>
        <li><b>Q:</b> In the strongly saturated limit, does the amplifier output grow exponentially with z? <b>A:</b> no, it trends toward linear growth.</li>
        <li><b>Q:</b> Does &gamma; depend on z directly? <b>A:</b> not explicitly; it depends on local &phi;(z), which depends on z.</li>
      </ul>
    </section>

    <section id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <div class="callout">
        <h4><span class="tag">What the canvases show</span></h4>
        <ul>
          <li><b>Diagram canvas:</b> a length-d amplifier with input &phi;(0) and output &phi;(d), and a note that &gamma; decreases with increasing &phi;.</li>
          <li><b>Main plot:</b> gain coefficient &gamma;(&phi;) versus photon flux &phi; on a log-x axis. Markers show the current input and the factor-5 point.</li>
          <li><b>Secondary plot:</b> photon flux &phi;(z) along the medium for the current input flux, computed by numerically integrating the ODE.</li>
        </ul>
      </div>

      <div class="callout">
        <h4><span class="tag">Interactive control</span></h4>
        <p>
          Use the <b>Input flux slider</b> to change &phi;(0) over many orders of magnitude.
          As you increase it, the marker on the &gamma;(&phi;) curve moves right and downward (lower gain coefficient),
          and the propagation curve &phi;(z) changes from near-exponential (weak saturation) to near-linear (strong saturation).
        </p>
        <p class="hint">
          The plots use the <b>same symbols</b> as the text: &gamma;<sub>0</sub>, &phi;<sub>s</sub>, d, &phi;(0), &phi;(z), &phi;(d).
        </p>
      </div>

      <div class="controls" aria-label="Interactive controls">
        <div class="control">
          <label for="phiInSlider">
            Input photon-flux density &phi;(0) (log scale)
            <span class="val" id="phiInVal">—</span>
          </label>
          <input id="phiInSlider" type="range" min="14" max="20.7" step="0.01" value="15.6"/>
          <div class="hint">Range: 10<sup>14</sup> to about 5&times;10<sup>20</sup> photons/(cm<sup>2</sup>&middot;s)</div>
        </div>
        <div class="control">
          <label>
            Model constants (fixed to problem)
            <span class="val" id="constVal">—</span>
          </label>
          <div class="btnrow" style="margin-top:0">
            <button class="copy" id="resetBtn" type="button">Reset to calibration input</button>
          </div>
          <div class="hint">
            Uses d=10 cm, &phi;<sub>s</sub>=4&times;10<sup>18</sup>, and fitted &gamma;<sub>0</sub> from the given calibration case.
          </div>
        </div>
      </div>

      <div class="vizGrid">
        <div class="canvasCard shortCanvas">
          <div class="canvasHeader">
            <div class="title">Physical setup diagram (traveling-wave saturated amplifier)</div>
            <div class="small" id="diagText">—</div>
          </div>
          <canvas id="diagCanvas"></canvas>
        </div>

        <div class="canvasCard">
          <div class="canvasHeader">
            <div class="title">Main plot: gain coefficient &gamma;(&phi;) vs photon-flux density &phi;</div>
            <div class="small" id="mainText">—</div>
          </div>
          <canvas id="mainCanvas"></canvas>
        </div>

        <div class="canvasCard">
          <div class="canvasHeader">
            <div class="title">Secondary plot: photon-flux evolution &phi;(z) through the medium</div>
            <div class="small" id="secText">—</div>
          </div>
          <canvas id="secCanvas"></canvas>
        </div>
      </div>
    </section>
  </article>
</main>

<footer>
  Built with vanilla HTML/CSS/JS. Plots are computed from the saturation model
  d&phi;/dz = (&gamma;<sub>0</sub>&phi;)/(1+&phi;/&phi;<sub>s</sub>) using the fitted &gamma;<sub>0</sub>.
</footer>

<script>
(function(){
  // ---------------------------
  // Problem constants (fixed)
  // ---------------------------
  const d_cm = 10.0;
  const phi_s = 4e18; // photons/(cm^2 s)

  // Calibration data to fit gamma0:
  const phi_cal_in  = 4e15;
  const phi_cal_out = 4e16;

  // Fit gamma0 from: ln(out/in) + (out-in)/phi_s = gamma0*d
  const gamma0 = (Math.log(phi_cal_out/phi_cal_in) + (phi_cal_out - phi_cal_in)/phi_s) / d_cm;

  // Small-signal gain
  const G0 = Math.exp(gamma0 * d_cm);

  // ---------------------------
  // Helpers: formatting
  // ---------------------------
  function fmtSci(x, sig=3){
    if (x === 0) return "0";
    const e = Math.floor(Math.log10(Math.abs(x)));
    const m = x / Math.pow(10,e);
    const mStr = (Math.round(m * Math.pow(10, sig-1)) / Math.pow(10, sig-1)).toString();
    // Clean trailing zeros:
    const mClean = (Number(mStr)).toString();
    return `${mClean}×10^${e}`;
  }
  function fmtUnitsPhi(x){
    return `${fmtSci(x,3)} photons/(cm^2·s)`;
  }
  function clamp(v,a,b){ return Math.max(a, Math.min(b, v)); }

  // ---------------------------
  // Model functions
  // ---------------------------
  function gammaOfPhi(phi){
    return gamma0 / (1.0 + phi/phi_s);
  }

  // Solve for phi_out given phi_in using implicit equation:
  // ln(phi_out/phi_in) + (phi_out - phi_in)/phi_s = gamma0*d
  function solvePhiOut(phi_in){
    const target = gamma0 * d_cm;
    // Monotonic in phi_out for phi_out>0. Use bisection.
    const f = (phi_out) => Math.log(phi_out/phi_in) + (phi_out - phi_in)/phi_s - target;

    // Lower bound: phi_in (f may be negative)
    let lo = Math.max(phi_in * 1.0000001, 1e-99);
    let flo = f(lo);

    // Upper bound: start with exp(target)*phi_in + phi_s*target, then expand if needed
    let hi = phi_in * Math.exp(target) + phi_s * target + 1.0;
    let fhi = f(hi);
    let iter = 0;
    while (fhi < 0 && iter < 80){
      hi *= 2;
      fhi = f(hi);
      iter++;
    }
    // If still not bracketed (should be rare), fall back to a large number
    if (fhi < 0) {
      hi = phi_in * 1e6 + phi_s * 1e6;
      fhi = f(hi);
    }

    // Bisection
    for (let i=0; i<120; i++){
      const mid = 0.5*(lo+hi);
      const fm = f(mid);
      if (fm > 0) hi = mid;
      else lo = mid;
    }
    return 0.5*(lo+hi);
  }

  // Numerical profile phi(z) via RK4
  function phiProfile(phi0, n=300){
    const z = new Array(n);
    const phi = new Array(n);
    z[0]=0; phi[0]=phi0;
    const h = d_cm/(n-1);
    for(let i=1;i<n;i++){
      const zi = (i-1)*h;
      const yi = phi[i-1];
      const f = (y)=> (gamma0 * y) / (1 + y/phi_s);

      const k1 = f(yi);
      const k2 = f(yi + 0.5*h*k1);
      const k3 = f(yi + 0.5*h*k2);
      const k4 = f(yi + h*k3);

      const yn = yi + (h/6)*(k1 + 2*k2 + 2*k3 + k4);
      z[i]=zi+h;
      phi[i]=Math.max(yn, 0);
    }
    return {z, phi};
  }

  // ---------------------------
  // Canvas plotting utilities
  // ---------------------------
  function setupHiDPI(canvas){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(10, Math.floor(rect.width  * dpr));
    const h = Math.max(10, Math.floor(rect.height * dpr));
    if (canvas.width !== w || canvas.height !== h){
      canvas.width = w;
      canvas.height = h;
    }
    const ctx = canvas.getContext('2d');
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
    return {ctx, wCss: rect.width, hCss: rect.height, dpr};
  }

  function clear(ctx, w, h){
    ctx.clearRect(0,0,w,h);
  }

  function drawPanelTitle(ctx, w, text){
    ctx.save();
    ctx.globalAlpha = 0.9;
    ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
    ctx.fillText(text, 14, 18);
    ctx.restore();
  }

  function plotAxes(ctx, box, xLabel, yLabel, xTicks, yTicks){
    const {x, y, w, h} = box;
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.14)';
    ctx.lineWidth = 1;

    // Border
    ctx.strokeRect(x, y, w, h);

    // Grid
    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    ctx.lineWidth = 1;

    // Vertical grid
    xTicks.forEach(t=>{
      const xp = x + t.frac*w;
      ctx.beginPath();
      ctx.moveTo(xp, y);
      ctx.lineTo(xp, y+h);
      ctx.stroke();
    });

    // Horizontal grid
    yTicks.forEach(t=>{
      const yp = y + (1-t.frac)*h;
      ctx.beginPath();
      ctx.moveTo(x, yp);
      ctx.lineTo(x+w, yp);
      ctx.stroke();
    });

    // Axis labels
    ctx.fillStyle = 'rgba(233,238,252,0.9)';
    ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;

    ctx.textAlign='center';
    ctx.fillText(xLabel, x + w/2, y + h + 34);

    ctx.save();
    ctx.translate(x - 36, y + h/2);
    ctx.rotate(-Math.PI/2);
    ctx.textAlign='center';
    ctx.fillText(yLabel, 0, 0);
    ctx.restore();

    // Tick labels
    ctx.fillStyle = 'rgba(185,196,230,0.95)';
    ctx.font = '11px ' + getComputedStyle(document.body).fontFamily;

    ctx.textAlign='center';
    xTicks.forEach(t=>{
      const xp = x + t.frac*w;
      ctx.fillText(t.label, xp, y + h + 16);
    });

    ctx.textAlign='right';
    yTicks.forEach(t=>{
      const yp = y + (1-t.frac)*h;
      ctx.fillText(t.label, x - 8, yp + 4);
    });

    ctx.restore();
  }

  function mapLin(val, vmin, vmax, pixMin, pixMax){
    const t = (val - vmin)/(vmax - vmin);
    return pixMin + t*(pixMax - pixMin);
  }
  function mapLog10(val, vmin, vmax, pixMin, pixMax){
    const lv = Math.log10(val);
    const t = (lv - vmin)/(vmax - vmin);
    return pixMin + t*(pixMax - pixMin);
  }

  function drawLine(ctx, pts, strokeStyle='rgba(125,211,252,0.95)', lineWidth=2){
    if (pts.length < 2) return;
    ctx.save();
    ctx.strokeStyle = strokeStyle;
    ctx.lineWidth = lineWidth;
    ctx.beginPath();
    ctx.moveTo(pts[0].x, pts[0].y);
    for(let i=1;i<pts.length;i++){
      ctx.lineTo(pts[i].x, pts[i].y);
    }
    ctx.stroke();
    ctx.restore();
  }

  function drawMarker(ctx, x, y, label, color='rgba(125,211,252,0.95)'){
    ctx.save();
    ctx.fillStyle = color;
    ctx.strokeStyle = 'rgba(0,0,0,0.35)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.arc(x, y, 5.5, 0, Math.PI*2);
    ctx.fill();
    ctx.stroke();

    ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
    ctx.fillStyle = 'rgba(233,238,252,0.95)';
    ctx.textAlign = 'left';
    ctx.fillText(label, x + 10, y - 8);
    ctx.restore();
  }

  // ---------------------------
  // Canvases
  // ---------------------------
  const diagCanvas = document.getElementById('diagCanvas');
  const mainCanvas = document.getElementById('mainCanvas');
  const secCanvas  = document.getElementById('secCanvas');

  // Controls
  const phiInSlider = document.getElementById('phiInSlider');
  const phiInVal = document.getElementById('phiInVal');
  const resetBtn = document.getElementById('resetBtn');

  // Text nodes
  const diagText = document.getElementById('diagText');
  const mainText = document.getElementById('mainText');
  const secText  = document.getElementById('secText');
  const constVal = document.getElementById('constVal');

  constVal.textContent = `d=${d_cm} cm, phi_s=${fmtSci(phi_s,3)}, gamma0≈${gamma0.toFixed(3)} cm^-1, G0≈${G0.toFixed(2)}`;

  // ---------------------------
  // Diagram draw
  // ---------------------------
  function drawDiagram(phi0, phiOut){
    const {ctx, wCss:w, hCss:h} = setupHiDPI(diagCanvas);
    clear(ctx, w, h);

    const pad = 18;
    const midY = h*0.55;
    const x0 = pad + 12;
    const x1 = w - pad - 12;

    // Background subtle vignette
    ctx.save();
    const grad = ctx.createRadialGradient(w*0.25, h*0.2, 10, w*0.25, h*0.2, Math.max(w,h));
    grad.addColorStop(0, 'rgba(125,211,252,0.08)');
    grad.addColorStop(1, 'rgba(0,0,0,0)');
    ctx.fillStyle = grad;
    ctx.fillRect(0,0,w,h);
    ctx.restore();

    // Medium block
    const blockX = w*0.25;
    const blockW = w*0.50;
    const blockY = h*0.33;
    const blockH = h*0.40;

    ctx.save();
    ctx.fillStyle = 'rgba(255,255,255,0.06)';
    ctx.strokeStyle = 'rgba(255,255,255,0.14)';
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    roundRect(ctx, blockX, blockY, blockW, blockH, 14);
    ctx.fill();
    ctx.stroke();
    ctx.restore();

    // Input arrow
    drawArrow(ctx, x0, midY, blockX, midY, 'rgba(125,211,252,0.95)', 3);
    // Output arrow
    drawArrow(ctx, blockX+blockW, midY, x1, midY, 'rgba(125,211,252,0.95)', 3);

    // Labels
    ctx.save();
    ctx.fillStyle = 'rgba(233,238,252,0.95)';
    ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;

    ctx.textAlign='center';
    ctx.fillText('Amplifying medium', blockX + blockW/2, blockY - 8);

    ctx.textAlign='left';
    ctx.fillText(`Input  φ(0) = ${fmtSci(phi0,3)}  photons/(cm²·s)`, x0, midY - 22);
    ctx.textAlign='left';
    ctx.fillText(`Output φ(d) ≈ ${fmtSci(phiOut,3)}  photons/(cm²·s)`, blockX+blockW + 8, midY - 22);

    // Length label
    ctx.textAlign='center';
    ctx.fillStyle = 'rgba(185,196,230,0.95)';
    ctx.fillText(`length d = ${d_cm} cm`, blockX + blockW/2, blockY + blockH + 18);

    // Saturation note
    ctx.fillStyle = 'rgba(185,196,230,0.95)';
    ctx.textAlign='center';
    ctx.fillText('Gain saturates: γ(φ)=γ0/(1+φ/φs)', blockX + blockW/2, blockY + blockH/2 + 5);

    ctx.restore();
  }

  function roundRect(ctx, x, y, w, h, r){
    const rr = Math.min(r, w/2, h/2);
    ctx.moveTo(x+rr, y);
    ctx.arcTo(x+w, y, x+w, y+h, rr);
    ctx.arcTo(x+w, y+h, x, y+h, rr);
    ctx.arcTo(x, y+h, x, y, rr);
    ctx.arcTo(x, y, x+w, y, rr);
    ctx.closePath();
  }

  function drawArrow(ctx, x1, y1, x2, y2, color, lw){
    const head = 10;
    const dx = x2-x1, dy=y2-y1;
    const L = Math.hypot(dx,dy) || 1;
    const ux = dx/L, uy = dy/L;

    ctx.save();
    ctx.strokeStyle = color;
    ctx.fillStyle = color;
    ctx.lineWidth = lw;
    ctx.lineCap = 'round';

    ctx.beginPath();
    ctx.moveTo(x1, y1);
    ctx.lineTo(x2, y2);
    ctx.stroke();

    // Head
    const hx = x2 - ux*head;
    const hy = y2 - uy*head;
    const px = -uy, py = ux;

    ctx.beginPath();
    ctx.moveTo(x2, y2);
    ctx.lineTo(hx + px*head*0.6, hy + py*head*0.6);
    ctx.lineTo(hx - px*head*0.6, hy - py*head*0.6);
    ctx.closePath();
    ctx.fill();

    ctx.restore();
  }

  // ---------------------------
  // Main plot: gamma(phi) vs phi
  // ---------------------------
  function drawMainPlot(phi0){
    const {ctx, wCss:w, hCss:h} = setupHiDPI(mainCanvas);
    clear(ctx, w, h);

    const padL=70, padR=18, padT=18, padB=58;
    const box = {x:padL, y:padT, w:w-padL-padR, h:h-padT-padB};

    // Domain for phi
    const logPhiMin = 14;
    const logPhiMax = 21;
    const phiMin = Math.pow(10, logPhiMin);
    const phiMax = Math.pow(10, logPhiMax);

    // y range for gamma
    const yMin = 0;
    const yMax = gamma0*1.05;

    // Ticks
    const xTicks = [];
    for(let e=14;e<=21;e+=1){
      xTicks.push({frac:(e-logPhiMin)/(logPhiMax-logPhiMin), label:`10^${e}`});
    }
    const yTicks = [];
    for(let k=0;k<=5;k++){
      const val = (k/5)*yMax;
      yTicks.push({frac:k/5, label:val.toFixed(2)});
    }

    plotAxes(ctx, box, 'photon-flux density  φ  [photons/(cm²·s)]', 'gain coefficient  γ  [cm⁻¹]', xTicks, yTicks);

    // Curve
    const N = 420;
    const pts = [];
    for(let i=0;i<N;i++){
      const t = i/(N-1);
      const logp = logPhiMin + t*(logPhiMax-logPhiMin);
      const p = Math.pow(10, logp);
      const g = gammaOfPhi(p);

      const x = mapLog10(p, logPhiMin, logPhiMax, box.x, box.x+box.w);
      const y = mapLin(g, yMin, yMax, box.y+box.h, box.y);
      pts.push({x,y});
    }
    drawLine(ctx, pts, 'rgba(125,211,252,0.95)', 2.2);

    // Mark phi_s and factor-5 point
    const phiFactor5 = 4*phi_s;
    const xS = mapLog10(phi_s, logPhiMin, logPhiMax, box.x, box.x+box.w);
    const yS = mapLin(gammaOfPhi(phi_s), yMin, yMax, box.y+box.h, box.y);
    drawMarker(ctx, xS, yS, 'φ = φs', 'rgba(167,139,250,0.95)');

    const xF5 = mapLog10(phiFactor5, logPhiMin, logPhiMax, box.x, box.x+box.w);
    const yF5 = mapLin(gamma0/5, yMin, yMax, box.y+box.h, box.y);
    drawMarker(ctx, xF5, yF5, 'γ = γ0/5', 'rgba(253,230,138,0.95)');

    // Current input marker
    const x0 = mapLog10(phi0, logPhiMin, logPhiMax, box.x, box.x+box.w);
    const y0 = mapLin(gammaOfPhi(phi0), yMin, yMax, box.y+box.h, box.y);
    drawMarker(ctx, x0, y0, 'current φ(0)', 'rgba(125,211,252,0.95)');

    // Legend (simple)
    ctx.save();
    ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
    ctx.fillStyle = 'rgba(185,196,230,0.95)';
    ctx.textAlign = 'left';
    ctx.fillText('Curve: γ(φ)=γ0/(1+φ/φs)', box.x+8, box.y+16);
    ctx.restore();
  }

  // ---------------------------
  // Secondary plot: phi(z)
  // ---------------------------
  function drawSecondaryPlot(phi0){
    const {ctx, wCss:w, hCss:h} = setupHiDPI(secCanvas);
    clear(ctx, w, h);

    const padL=70, padR=18, padT=18, padB=58;
    const box = {x:padL, y:padT, w:w-padL-padR, h:h-padT-padB};

    const prof = phiProfile(phi0, 320);
    const phiOutModel = prof.phi[prof.phi.length-1];

    // y range: from 0 to a bit above max
    const yMin = 0;
    const yMax = Math.max(phiOutModel, phi0) * 1.12;

    // x range: 0..d
    const xMin = 0;
    const xMax = d_cm;

    // Ticks
    const xTicks = [];
    for(let k=0;k<=5;k++){
      const val = xMin + (k/5)*(xMax-xMin);
      xTicks.push({frac:k/5, label:val.toFixed(0)});
    }

    // y ticks: use scientific-ish labels
    const yTicks = [];
    for(let k=0;k<=5;k++){
      const frac = k/5;
      const val = yMin + frac*(yMax-yMin);
      yTicks.push({frac:frac, label:fmtSci(val,2)});
    }

    plotAxes(ctx, box, 'position  z  [cm]', 'photon-flux density  φ(z)  [photons/(cm²·s)]', xTicks, yTicks);

    // Plot line
    const pts = [];
    for(let i=0;i<prof.z.length;i++){
      const z = prof.z[i];
      const p = prof.phi[i];
      const x = mapLin(z, xMin, xMax, box.x, box.x+box.w);
      const y = mapLin(p, yMin, yMax, box.y+box.h, box.y);
      pts.push({x,y});
    }
    drawLine(ctx, pts, 'rgba(134,239,172,0.95)', 2.2);

    // Mark endpoints
    const xA = mapLin(0, xMin, xMax, box.x, box.x+box.w);
    const yA = mapLin(phi0, yMin, yMax, box.y+box.h, box.y);
    drawMarker(ctx, xA, yA, 'φ(0)', 'rgba(125,211,252,0.95)');

    const xB = mapLin(d_cm, xMin, xMax, box.x, box.x+box.w);
    const yB = mapLin(phiOutModel, yMin, yMax, box.y+box.h, box.y);
    drawMarker(ctx, xB, yB, 'φ(d)', 'rgba(134,239,172,0.95)');

    // Show saturation level as horizontal reference
    const yS = mapLin(phi_s, yMin, yMax, box.y+box.h, box.y);
    ctx.save();
    ctx.strokeStyle = 'rgba(167,139,250,0.65)';
    ctx.lineWidth = 2;
    ctx.setLineDash([6,6]);
    ctx.beginPath();
    ctx.moveTo(box.x, yS);
    ctx.lineTo(box.x+box.w, yS);
    ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(167,139,250,0.95)';
    ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
    ctx.textAlign='left';
    ctx.fillText('φs', box.x+8, yS-8);
    ctx.restore();

    return phiOutModel;
  }

  // ---------------------------
  // UI updates
  // ---------------------------
  function getPhi0FromSlider(){
    const log10phi = parseFloat(phiInSlider.value);
    return Math.pow(10, log10phi);
  }

  function setSliderToPhi(phi){
    phiInSlider.value = Math.log10(phi).toFixed(2);
  }

  function updateAll(){
    const phi0 = getPhi0FromSlider();
    const phiOut = solvePhiOut(phi0);
    const G = phiOut / phi0;
    const gammaIn = gammaOfPhi(phi0);

    phiInVal.textContent = fmtUnitsPhi(phi0);
    diagText.textContent = `γ0≈${gamma0.toFixed(3)} cm^-1,  G0≈${G0.toFixed(2)}`;
    mainText.textContent = `current: γ(φ0)≈${gammaIn.toFixed(3)} cm^-1  |  φs=${fmtSci(phi_s,3)}`;
    secText.textContent  = `model: φ(d)≈${fmtSci(phiOut,3)}  |  gain G≈${G.toFixed(3)}`;

    drawDiagram(phi0, phiOut);
    drawMainPlot(phi0);
    const phiOutProfile = drawSecondaryPlot(phi0);

    // Consistency check between implicit and RK4 (small differences possible)
    // (Not shown to user; just ensure stable.)
    void(phiOutProfile);
  }

  // ---------------------------
  // Copy buttons
  // ---------------------------
  function copyText(text){
    if (!navigator.clipboard){
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand('copy'); }catch(e){}
      document.body.removeChild(ta);
      return;
    }
    navigator.clipboard.writeText(text).catch(()=>{});
  }

  document.querySelectorAll('button.copy[data-copy]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const text = btn.getAttribute('data-copy') || '';
      copyText(text);
      const old = btn.textContent;
      btn.textContent = 'Copied ✓';
      setTimeout(()=>btn.textContent=old, 900);
    });
  });

  // Reset button to calibration input
  resetBtn.addEventListener('click', ()=>{
    setSliderToPhi(phi_cal_in);
    updateAll();
  });

  // Slider events
  phiInSlider.addEventListener('input', updateAll);

  // Resize handling
  let resizeTimer = null;
  window.addEventListener('resize', ()=>{
    if (resizeTimer) clearTimeout(resizeTimer);
    resizeTimer = setTimeout(updateAll, 80);
  });

  // Init slider to a meaningful starting point: calibration input
  setSliderToPhi(phi_cal_in);
  updateAll();

})();
</script>
</body>
</html>
