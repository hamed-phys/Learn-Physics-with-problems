<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Resonant Absorption in Thermal Equilibrium — Two-Level Medium, Lorentzian Line, Saturation</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#101a2a;
      --panel2:#0f1523;
      --card:#0f1d33;
      --text:#e9eef7;
      --muted:#a9b6cc;
      --faint:#6f7f9a;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --border:rgba(255,255,255,0.10);
      --shadow: 0 16px 40px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{ box-sizing:border-box; }
    html,body{ height:100%; }
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 800px at 20% -10%, rgba(125,211,252,0.12), transparent 60%),
        radial-gradient(900px 600px at 110% 10%, rgba(167,139,250,0.10), transparent 55%),
        linear-gradient(180deg, var(--bg), #070a10 70%, #05070c);
      line-height:1.55;
    }
    a{ color: var(--accent); text-decoration:none; }
    a:hover{ text-decoration:underline; }
    header{
      padding: 28px 18px 8px;
      border-bottom: 1px solid var(--border);
      background: linear-gradient(180deg, rgba(16,26,42,0.75), rgba(16,26,42,0.10));
      backdrop-filter: blur(6px);
      position: sticky;
      top:0;
      z-index: 50;
    }
    .wrap{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 16px 54px;
    }
    .title{
      display:flex;
      flex-wrap:wrap;
      gap:12px 16px;
      align-items: baseline;
      justify-content: space-between;
    }
    h1{
      margin:0;
      font-size: clamp(20px, 3.0vw, 34px);
      letter-spacing: 0.2px;
    }
    .subtitle{
      margin: 6px 0 0;
      color: var(--muted);
      max-width: 78ch;
    }
    .grid{
      display:grid;
      grid-template-columns: 330px 1fr;
      gap: 16px;
      margin-top: 16px;
      align-items:start;
    }
    @media (max-width: 980px){
      .grid{ grid-template-columns: 1fr; }
      header{ position: relative; }
    }
    nav.toc{
      position: sticky;
      top: 92px;
      align-self: start;
      background: rgba(16,26,42,0.65);
      border: 1px solid var(--border);
      border-radius: 16px;
      padding: 14px 12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(8px);
    }
    @media (max-width: 980px){
      nav.toc{ position: relative; top: 0; }
    }
    .toc h2{
      font-size: 13px;
      margin: 0 0 10px;
      color: var(--muted);
      letter-spacing: .6px;
      text-transform: uppercase;
    }
    .toc a{
      display:block;
      padding: 7px 10px;
      border-radius: 10px;
      color: var(--text);
      border: 1px solid transparent;
      font-size: 14px;
      opacity: .95;
    }
    .toc a:hover{
      background: rgba(125,211,252,0.10);
      border-color: rgba(125,211,252,0.25);
      text-decoration:none;
    }
    main{
      min-width:0;
    }
    section{
      background: rgba(16,26,42,0.55);
      border: 1px solid var(--border);
      border-radius: 18px;
      padding: 18px 16px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
      margin-bottom: 16px;
      overflow: hidden;
    }
    section h2{
      margin:0 0 10px;
      font-size: 18px;
      letter-spacing:.2px;
    }
    section h3{
      margin: 14px 0 8px;
      font-size: 16px;
      color: #d9e6ff;
    }
    p{ margin: 10px 0; color: rgba(233,238,247,.95); }
    ul{ margin: 8px 0 8px 20px; color: rgba(233,238,247,.95); }
    li{ margin: 6px 0; }
    .muted{ color: var(--muted); }
    .faint{ color: var(--faint); }
    .note{
      font-size: 13px;
      color: var(--muted);
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 820px){ .row{ grid-template-columns: 1fr; } }
    .card{
      background: linear-gradient(180deg, rgba(15,29,51,0.8), rgba(15,21,35,0.7));
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 16px;
      padding: 14px 14px;
    }
    .callout{
      border-left: 3px solid var(--accent);
      background: rgba(125,211,252,0.08);
    }
    .warn{
      border-left-color: var(--warn);
      background: rgba(251,191,36,0.08);
    }
    .ok{
      border-left-color: var(--good);
      background: rgba(52,211,153,0.08);
    }
    .bad{
      border-left-color: var(--bad);
      background: rgba(251,113,133,0.08);
    }
    .eqbox{
      background: rgba(10,14,24,0.65);
      border: 1px solid rgba(255,255,255,0.10);
      border-radius: 14px;
      padding: 12px 12px;
      margin: 10px 0;
      position: relative;
      overflow:hidden;
    }
    .eq{
      font-family: var(--mono);
      font-size: 13px;
      color: #eaf2ff;
      white-space: pre-wrap;
      word-break: break-word;
    }
    .copybtn{
      position:absolute;
      right:10px;
      top:10px;
      padding: 7px 10px;
      font-size: 12px;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.06);
      color: var(--text);
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      user-select:none;
    }
    .copybtn:hover{ background: rgba(255,255,255,0.10); transform: translateY(-1px); }
    .copybtn:active{ transform: translateY(0px) scale(0.99); }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      padding: 6px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(255,255,255,0.06);
      font-size: 12px;
      color: var(--muted);
    }
    .kpi{
      display:grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 10px;
      margin-top: 10px;
    }
    @media (max-width: 560px){ .kpi{ grid-template-columns: 1fr; } }
    .kpi .card{
      padding: 12px;
    }
    .k{
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .v{
      font-family: var(--mono);
      font-size: 14px;
      color: #f2f7ff;
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .control{
      padding: 12px;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.20);
    }
    .control label{
      display:flex;
      align-items: baseline;
      justify-content: space-between;
      gap: 12px;
      color: var(--muted);
      font-size: 12px;
      margin-bottom: 8px;
    }
    input[type="range"]{
      width: 100%;
      accent-color: var(--accent);
    }
    select{
      width:100%;
      border-radius: 12px;
      padding: 10px 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(0,0,0,0.25);
      color: var(--text);
      outline: none;
    }
    .viz{
      display:grid;
      grid-template-columns: 1fr;
      gap: 12px;
      margin-top: 10px;
    }
    canvas{
      width:100%;
      height: 320px;
      border-radius: 16px;
      border: 1px solid rgba(255,255,255,0.12);
      background: rgba(0,0,0,0.22);
      display:block;
    }
    .viz .caption{
      color: var(--muted);
      font-size: 13px;
      margin-top: 4px;
    }
    .split{
      display:grid;
      grid-template-columns: 1.2fr 0.8fr;
      gap: 12px;
    }
    @media (max-width: 900px){ .split{ grid-template-columns: 1fr; } }
    footer{
      margin-top: 18px;
      padding-top: 10px;
      border-top: 1px solid rgba(255,255,255,0.12);
      color: var(--muted);
      font-size: 13px;
    }
    .mini{
      font-size: 12px;
      color: var(--muted);
    }
    .fadeIn{
      animation: fadeIn .5s ease both;
    }
    @keyframes fadeIn{
      from{ opacity:0; transform: translateY(6px); }
      to{ opacity:1; transform: translateY(0px); }
    }
    @media print{
      body{ background: #fff; color:#000; }
      header, nav.toc{ display:none; }
      section{ box-shadow:none; background:#fff; border:1px solid #ddd; }
      .eqbox{ background:#f6f6f6; }
      .copybtn, .controls{ display:none !important; }
      a{ color:#000; text-decoration: underline; }
      canvas{ border:1px solid #bbb; background:#fff; }
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <h1>Resonant Absorption of a Two-Level Medium in Thermal Equilibrium</h1>
        <span class="pill">vanilla HTML/CSS/JS • Lorentzian line • saturation</span>
      </div>
      <p class="subtitle">
        We analyze a dense two-level atomic medium with a Lorentzian linewidth, compute thermal populations at two temperatures,
        derive small-signal absorption, plot its frequency dependence, and find the saturation photon-flux density.
      </p>
    </div>
  </header>

  <div class="wrap grid">
    <nav class="toc" aria-label="Table of contents">
      <h2>Table of Contents</h2>
      <a href="#quick" data-scroll>Quick Summary</a>
      <a href="#part0" data-scroll>PART 0 — Concept Primer</a>
      <a href="#part1" data-scroll>PART 1 — Problem Analysis</a>
      <a href="#part2" data-scroll>PART 2 — Strategy & Tips</a>
      <a href="#part3" data-scroll>PART 3 — Full Solution</a>
      <a href="#part4" data-scroll>PART 4 — Deeper Understanding</a>
      <a href="#part5" data-scroll>PART 5 — Visualization Guide</a>
    </nav>

    <main>
      <section id="quick" class="fadeIn">
        <h2>Quick Summary</h2>
        <ul>
          <li><b>What this is:</b> resonant absorption (and saturation) of light by a <b>two-level</b> atomic medium in <b>thermal equilibrium</b>.</li>
          <li><b>Key physics idea:</b> net absorption depends on the <b>population difference</b> (ground vs excited) and on the <b>spectral lineshape</b> (Lorentzian).</li>
          <li><b>Thermal populations:</b> <span class="eq">N2/N1 = exp(−ΔE/kT)</span>, with <span class="eq">N1+N2 = N</span>.</li>
          <li><b>Line shape:</b> homogeneous Lorentzian with FWHM <span class="eq">Δν</span>, so <span class="eq">L(Δ) = 1 / (1 + (2Δ/Δν)^2)</span>.</li>
          <li><b>Absorption cross-section (line center):</b> <span class="eq">σ0 = λ0^2 A21 / (4π^2 Δν)</span>, using <span class="eq">A21 = 1/τsp</span>.</li>
          <li><b>Small-signal attenuation:</b> <span class="eq">α(ν) = (n1 − n2) σ0 L(ν−ν0)</span> (assuming equal degeneracies).</li>
          <li><b>Saturation:</b> on resonance, attenuation halves when <span class="eq">φ = φs</span> with <span class="eq">φs = 1/(2σ0 τsp)</span> (photon-flux density).</li>
          <li><b>Result type:</b> both <b>symbolic formulas</b> and <b>numerical values</b> for the given medium; plots show <span class="eq">α(ν)</span> and <span class="eq">φ(d)</span> vs <span class="eq">φ(0)</span>.</li>
        </ul>
      </section>

      <section id="part0" class="fadeIn">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <div class="row">
          <div class="card callout">
            <h3>Core definitions (symbols & units)</h3>
            <ul>
              <li><b>Two levels:</b> ground <span class="eq">|1⟩</span> and excited <span class="eq">|2⟩</span>, energy gap <span class="eq">ΔE = E2 − E1</span> (J or eV).</li>
              <li><b>Thermal populations:</b> <span class="eq">N1, N2</span> (counts), <span class="eq">n1, n2</span> (number densities, m<sup>−3</sup>).</li>
              <li><b>Spontaneous emission:</b> Einstein <span class="eq">A21</span> (s<sup>−1</sup>) with lifetime <span class="eq">τsp = 1/A21</span>.</li>
              <li><b>Absorption cross-section:</b> <span class="eq">σ(ν)</span> (m<sup>2</sup>), effective “area” for absorption at frequency <span class="eq">ν</span>.</li>
              <li><b>Attenuation coefficient:</b> <span class="eq">α(ν)</span> (m<sup>−1</sup>), defined by <span class="eq">dφ/dz = −α φ</span> in the linear (unsaturated) regime.</li>
              <li><b>Photon-flux density:</b> <span class="eq">φ</span> (photons·m<sup>−2</sup>·s<sup>−1</sup>) for a narrowband beam.</li>
              <li><b>Lorentzian linewidth:</b> FWHM <span class="eq">Δν</span> (Hz). Detuning <span class="eq">Δ = ν − ν0</span>.</li>
            </ul>
          </div>

          <div class="card">
            <h3>Physical meaning</h3>
            <ul>
              <li><b>Population difference</b> controls whether the medium absorbs or amplifies:
                if <span class="eq">n1 &gt; n2</span> it absorbs; if inverted <span class="eq">n2 &gt; n1</span> it would amplify (laser gain).</li>
              <li><b>Lorentzian lineshape</b> expresses homogeneous broadening: atoms respond strongest near <span class="eq">ν0</span> and less when detuned.</li>
              <li><b>Saturation</b> occurs when the light drives transitions so fast that the population difference shrinks; absorption then “bleaches.”</li>
            </ul>

            <h3>Key laws/principles & validity</h3>
            <ul>
              <li><b>Boltzmann distribution</b> for thermal equilibrium populations (valid when collisions/thermalization maintain equilibrium).</li>
              <li><b>Einstein A–B relations</b> tie spontaneous emission to stimulated processes.</li>
              <li><b>Beer–Lambert law</b> <span class="eq">φ(d) = φ(0) e^{−α d}</span> holds when <b>α is constant</b> (linear regime, no saturation).</li>
              <li><b>Saturable absorption model</b> used here assumes a two-level system with population relaxation time ≈ <span class="eq">τsp</span> and homogeneous broadening.</li>
            </ul>
          </div>
        </div>

        <div class="row">
          <div class="card">
            <h3>Common models/approximations (and why)</h3>
            <ul>
              <li><b>Equal degeneracies</b> (<span class="eq">g1 = g2</span>) unless stated; then <span class="eq">B12 = B21</span> and net absorption depends on <span class="eq">(n1 − n2)</span>.</li>
              <li><b>Lorentzian homogeneous line</b> with given FWHM <span class="eq">Δν</span>: convenient closed-form factor <span class="eq">L(Δ)</span>.</li>
              <li><b>Narrowband incident beam</b> so we treat <span class="eq">σ(ν)</span> at the beam frequency.</li>
              <li><b>Small photon flux</b> means we can ignore saturation initially to get <span class="eq">α(ν)</span>.</li>
            </ul>

            <h3>Mini intuition examples</h3>
            <ul>
              <li>If <span class="eq">kT ≪ ΔE</span>, almost nobody is in level 2 ⇒ spontaneous emission is negligible; absorption is maximal (all atoms available to absorb).</li>
              <li>If you detune by one linewidth (<span class="eq">Δ = Δν</span>), the Lorentzian drops to <span class="eq">1/(1+4)=0.2</span> ⇒ absorption is only 20% of its peak.</li>
            </ul>
          </div>

          <div class="card warn">
            <h3>What to watch for (pitfalls)</h3>
            <ul>
              <li><b>Units:</b> <span class="eq">α</span> is m<sup>−1</sup>, while number density is m<sup>−3</sup> and cross-section is m<sup>2</sup>.</li>
              <li><b>Net absorption vs absorption alone:</b> stimulated emission subtracts; use <span class="eq">(n1 − n2)</span>, not just <span class="eq">n1</span>.</li>
              <li><b>Linewidth meaning:</b> here <span class="eq">Δν</span> is FWHM; the half-width at half maximum is <span class="eq">Δν/2</span>.</li>
              <li><b>Saturation parameter:</b> off-resonance saturation requires higher flux; don’t use the on-resonance <span class="eq">φs</span> blindly.</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="part1" class="fadeIn">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <p><b>Problem restatement (in plain words):</b> A 1 cm<sup>3</sup> medium with <span class="eq">N = 10^23</span> two-level atoms has transition energy <span class="eq">ΔE = 2.48 eV</span> (wavelength <span class="eq">λ0 = 0.5 μm</span>). The excited state lifetime is <span class="eq">τsp = 1 ms</span> and the homogeneous linewidth is Lorentzian with FWHM <span class="eq">Δν = 1 GHz</span>. For two temperatures defined by <span class="eq">kT1 = 0.026 eV</span> and <span class="eq">kT2 = 0.26 eV</span>, find populations, spontaneous emission rate, absorption coefficient (small flux), its frequency dependence, the saturation photon-flux density for halving absorption, and the transmitted flux behavior with saturation.</p>

        <div class="row">
          <div class="card">
            <h3>Given</h3>
            <ul>
              <li>Volume: <span class="eq">V = 1 cm^3 = 10^−6 m^3</span></li>
              <li>Total atoms: <span class="eq">N = 10^23</span> ⇒ number density <span class="eq">n = N/V</span></li>
              <li>Energy gap: <span class="eq">ΔE = 2.48 eV</span> (also consistent with <span class="eq">λ0 = 0.5 μm</span>)</li>
              <li>Spontaneous lifetime: <span class="eq">τsp = 1 ms</span> ⇒ <span class="eq">A21 = 1/τsp</span></li>
              <li>Lorentzian FWHM: <span class="eq">Δν = 1 GHz</span></li>
              <li>Thermal energies: <span class="eq">kT1 = 0.026 eV</span>, <span class="eq">kT2 = 0.26 eV</span></li>
            </ul>
          </div>
          <div class="card">
            <h3>Unknowns (what to find)</h3>
            <ul>
              <li>(a) <span class="eq">N1, N2</span> at <span class="eq">T1</span> and <span class="eq">T2</span></li>
              <li>(b) Spontaneous photons emitted per second: <span class="eq">Rsp = N2 A21</span></li>
              <li>(c) Small-signal attenuation at <span class="eq">λ0</span>: <span class="eq">α(ν0)</span></li>
              <li>(d) Frequency dependence <span class="eq">α(ν)</span> (Lorentzian) and key parameters</li>
              <li>(e) Saturation photon flux <span class="eq">φs</span> for <span class="eq">α → α/2</span></li>
              <li>(f) Transmitted flux <span class="eq">φ(d)</span> vs input <span class="eq">φ(0)</span> at <span class="eq">ν0</span> and <span class="eq">ν0+Δν</span></li>
            </ul>
          </div>
        </div>

        <div class="row">
          <div class="card callout">
            <h3>Relevant principles (and why they apply)</h3>
            <ul>
              <li><b>Boltzmann equilibrium:</b> the problem explicitly says thermal equilibrium, so level populations follow <span class="eq">exp(−E/kT)</span>.</li>
              <li><b>Einstein A ↔ cross-section:</b> lifetime and linewidth specify the strength and spectral distribution of the transition, enabling <span class="eq">σ(ν)</span>.</li>
              <li><b>Beer–Lambert + saturation:</b> small-flux attenuation uses linear Beer–Lambert; saturation modifies it when stimulated rates compete with relaxation.</li>
            </ul>
          </div>
          <div class="card warn">
            <h3>Assumptions (explicit)</h3>
            <ul>
              <li>Two-level atoms; no other levels participate.</li>
              <li>Equal degeneracies <span class="eq">g1=g2</span> (not given; standard default) so net absorption ∝ <span class="eq">(n1−n2)</span>.</li>
              <li>Homogeneous Lorentzian broadening with FWHM <span class="eq">Δν</span>.</li>
              <li>Incident beam is narrowband compared to <span class="eq">Δν</span> and weak unless stated otherwise.</li>
              <li>Population relaxation time for saturation is approximated by <span class="eq">τsp</span>.</li>
              <li>For transmission sketches, we use a representative slab thickness <span class="eq">d = 1 cm</span> (consistent with a 1 cm<sup>3</sup> sample; you can change it in the interactive control).</li>
            </ul>
          </div>
        </div>

        <div class="card">
          <h3>Possible approaches (compare & choose)</h3>
          <ul>
            <li><b>Approach A (Einstein coefficients → cross-section):</b> use <span class="eq">A21</span> and Lorentzian normalization to get <span class="eq">σ(ν)</span>, then <span class="eq">α = (n1−n2)σ</span>. <span class="muted">Pros: direct, uses given data. Cons: must remember the line-center relation.</span></li>
            <li><b>Approach B (oscillator strength / dipole moment):</b> derive <span class="eq">σ0</span> from dipole matrix element. <span class="muted">Pros: deeper microscopic link. Cons: not enough data (dipole moment not given).</span></li>
            <li><b>Approach C (optical Bloch equations):</b> solve steady-state for populations and absorption. <span class="muted">Pros: most general. Cons: overkill; we only need the standard saturable absorber formulas.</span></li>
          </ul>
          <p><b>Best choice:</b> <b>Approach A</b> — it matches the provided lifetime and linewidth and yields clean analytic results and plots.</p>
        </div>
      </section>

      <section id="part2" class="fadeIn">
        <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

        <ol>
          <li><b>Compute thermal ratio</b> <span class="eq">r = exp(−ΔE/kT)</span>. <span class="muted">Goal:</span> determine how many atoms are excited.</li>
          <li><b>Convert ratio to populations</b>: <span class="eq">N2 = N r/(1+r)</span>, <span class="eq">N1 = N/(1+r)</span>. <span class="muted">Meaning:</span> equilibrium occupancies.</li>
          <li><b>Spontaneous photon rate</b>: <span class="eq">Rsp = N2 A21</span> with <span class="eq">A21=1/τsp</span>. <span class="muted">Meaning:</span> photons/s emitted regardless of incident light.</li>
          <li><b>Find line-center cross-section</b> from lifetime and linewidth:
            <span class="eq">σ0 = λ0^2 A21 / (4π^2 Δν)</span>. <span class="muted">Meaning:</span> peak absorption strength.</li>
          <li><b>Small-signal attenuation</b>: <span class="eq">α0 = (n1 − n2) σ0</span> at resonance. <span class="muted">Meaning:</span> Beer–Lambert slope at low flux.</li>
          <li><b>Frequency dependence</b>: multiply by Lorentzian factor <span class="eq">L(Δ)=1/(1+(2Δ/Δν)^2)</span>. <span class="muted">Meaning:</span> absorption spectrum.</li>
          <li><b>Saturation flux</b> (on resonance): set absorption to half: <span class="eq">α = α0/(1+φ/φs)</span> ⇒ <span class="eq">φs = 1/(2σ0 τsp)</span>. <span class="muted">Meaning:</span> flux needed for significant bleaching.</li>
          <li><b>Transmission with saturation</b>: solve propagation <span class="eq">dφ/dz = −α0 φ/(1+φ/φs)</span> to relate <span class="eq">φ(d)</span> to <span class="eq">φ(0)</span>. <span class="muted">Meaning:</span> nonlinear transmission curve.</li>
        </ol>

        <div class="row">
          <div class="card warn">
            <h3>Common mistakes</h3>
            <ul>
              <li>Using <span class="eq">α = n1 σ</span> and forgetting stimulated emission (should be <span class="eq">(n1−n2)σ</span> for equal degeneracies).</li>
              <li>Mixing cm and m: here we consistently use SI for <span class="eq">σ</span> and <span class="eq">α</span>.</li>
              <li>Using linewidth <span class="eq">Δν</span> as half-width; but the given is FWHM.</li>
            </ul>
          </div>
          <div class="card ok">
            <h3>Quick tips</h3>
            <ul>
              <li>Check the extreme-temperature limit: if <span class="eq">kT ≪ ΔE</span>, then <span class="eq">N2≈0</span>.</li>
              <li>At detuning <span class="eq">Δ=Δν</span>, Lorentzian factor is <span class="eq">0.2</span> (easy sanity check for the plots).</li>
              <li>Saturation flux is huge if <span class="eq">σ0</span> is tiny; intensity <span class="eq">I = φ hν</span> helps interpret.</li>
            </ul>
          </div>
        </div>
      </section>

      <section id="part3" class="fadeIn">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <div class="card callout">
          <h3>Physical intuition (before math)</h3>
          <p>
            The energy gap is <span class="eq">ΔE = 2.48 eV</span>. At the lower temperature (<span class="eq">kT1 = 0.026 eV</span>), the thermal energy is about 100× smaller than the gap,
            so essentially no atoms climb to the excited state: absorption is maximal and spontaneous emission is negligible.
            At the higher temperature (<span class="eq">kT2 = 0.26 eV</span>), the gap is still ~10× larger than <span class="eq">kT</span>, so the excited fraction remains small,
            but no longer absurdly tiny; spontaneous emission becomes macroscopic because the total number of atoms is enormous.
          </p>
        </div>

        <h3>(a) Thermal populations <span class="eq">N1</span> and <span class="eq">N2</span></h3>

        <div class="eqbox">
          <button class="copybtn" data-copy="eqA">(copy)</button>
          <div class="eq" id="eqA">Boltzmann ratio (two levels):
r ≡ N2/N1 = exp(−ΔE/kT)

With N = N1 + N2:
N1 = N/(1+r)
N2 = N r/(1+r)</div>
        </div>

        <p>Here <span class="eq">ΔE = 2.48 eV</span> and <span class="eq">N = 10^23</span> atoms.</p>

        <div class="row">
          <div class="card">
            <h3>At <span class="eq">kT1 = 0.026 eV</span></h3>
            <p class="eq">
              r1 = exp(−2.48/0.026) ≈ 3.76×10^−42
            </p>
            <p class="eq">
              N2(T1) ≈ N r1 ≈ 3.76×10^−19  (≪ 1 atom)
            </p>
            <p class="eq">
              N1(T1) ≈ 1.00×10^23
            </p>
            <p class="note">Explanation: the excited probability is so tiny that in a finite sample you essentially have zero excited atoms at any instant.</p>
          </div>

          <div class="card">
            <h3>At <span class="eq">kT2 = 0.26 eV</span></h3>
            <p class="eq">
              r2 = exp(−2.48/0.26) ≈ 7.20×10^−5
            </p>
            <p class="eq">
              N2(T2) = N r2/(1+r2) ≈ 7.20×10^18
            </p>
            <p class="eq">
              N1(T2) ≈ 9.9993×10^22
            </p>
            <p class="note">Explanation: only ~0.0072% are excited, but with 10^23 atoms that is still ~10^19 excited atoms.</p>
          </div>
        </div>

        <div class="card ok">
          <h3>Sanity check (limits)</h3>
          <ul>
            <li>If <span class="eq">kT → 0</span>, then <span class="eq">r → 0</span> and <span class="eq">N2→0</span>.</li>
            <li>If <span class="eq">kT → ∞</span>, then <span class="eq">r → 1</span> and <span class="eq">N1≈N2≈N/2</span> (for equal degeneracies).</li>
          </ul>
        </div>

        <h3>(b) Spontaneous photons emitted per second</h3>

        <div class="eqbox">
          <button class="copybtn" data-copy="eqB">(copy)</button>
          <div class="eq" id="eqB">Spontaneous emission rate (photons/s):
A21 = 1/τsp
Rsp = N2 A21 = N2 / τsp</div>
        </div>

        <p>Given <span class="eq">τsp = 1 ms = 10^−3 s</span>, so <span class="eq">A21 = 1000 s^−1</span>.</p>

        <div class="row">
          <div class="card">
            <h3>At <span class="eq">T1</span></h3>
            <p class="eq">Rsp(T1) ≈ (3.76×10^−19)×1000 ≈ 3.76×10^−16 photons/s ≈ 0</p>
          </div>
          <div class="card">
            <h3>At <span class="eq">T2</span></h3>
            <p class="eq">Rsp(T2) ≈ (7.20×10^18)×1000 ≈ 7.20×10^21 photons/s</p>
          </div>
        </div>

        <h3>(c) Small-signal attenuation coefficient at <span class="eq">λ0</span> (incident flux small)</h3>

        <p>
          In the linear regime, the attenuation coefficient is <span class="eq">α(ν) = (n1 − n2) σ(ν)</span> (assuming <span class="eq">g1=g2</span>),
          where <span class="eq">σ(ν)</span> is the absorption cross-section and <span class="eq">n1,n2</span> are number densities.
        </p>

        <div class="eqbox">
          <button class="copybtn" data-copy="eqC">(copy)</button>
          <div class="eq" id="eqC">Line-center absorption cross-section for a Lorentzian homogeneous line (FWHM Δν):
σ0 = (λ0^2 A21)/(4π^2 Δν)

Number densities:
n1 = N1/V
n2 = N2/V

Small-signal attenuation at resonance:
α0 ≡ α(ν0) = (n1 − n2) σ0</div>
        </div>

        <p>Now plug in the given numbers:</p>
        <ul>
          <li><span class="eq">λ0 = 0.5 μm = 5.0×10^−7 m</span></li>
          <li><span class="eq">A21 = 1000 s^−1</span></li>
          <li><span class="eq">Δν = 1 GHz = 10^9 Hz</span></li>
          <li><span class="eq">V = 10^−6 m^3</span></li>
          <li><span class="eq">N/V = 10^23 / 10^−6 = 10^29 m^−3</span></li>
        </ul>

        <div class="card">
          <p class="eq"><b>Cross-section:</b></p>
          <p class="eq">
            σ0 = λ0^2 A21 / (4π^2 Δν)
               = ( (5.0×10^−7)^2 × 1000 ) / (4π^2 × 10^9)
               ≈ 6.33×10^−21 m^2
          </p>
          <p class="eq"><b>Attenuation (both temperatures are nearly the same here because N2 ≪ N1):</b></p>
          <p class="eq">
            α0 ≈ (N/V) σ0 ≈ (10^29)(6.33×10^−21) ≈ 6.33×10^8 m^−1
          </p>
          <p class="note">Interpretation: this is an extremely strong absorber because the sample is extraordinarily dense (10<sup>29</sup> m<sup>−3</sup>).</p>
        </div>

        <div class="card ok">
          <h3>Sanity checks</h3>
          <ul>
            <li><b>Units:</b> <span class="eq">(m^−3)(m^2)=m^−1</span> ✔</li>
            <li><b>Sign:</b> <span class="eq">n1&gt;n2</span> ⇒ <span class="eq">α0&gt;0</span> absorption ✔</li>
            <li><b>Limit:</b> if <span class="eq">n2→n1</span> (equal populations), net absorption → 0 ✔</li>
          </ul>
        </div>

        <h3>(d) Frequency dependence of <span class="eq">α(ν)</span></h3>
        <p>
          For a Lorentzian with FWHM <span class="eq">Δν</span>, the normalized line factor at detuning <span class="eq">Δ = ν−ν0</span> is
          <span class="eq">L(Δ) = 1/(1+(2Δ/Δν)^2)</span>. Therefore:
        </p>

        <div class="eqbox">
          <button class="copybtn" data-copy="eqD">(copy)</button>
          <div class="eq" id="eqD">Lorentzian attenuation spectrum:
α(ν) = α0 · L(ν−ν0)

L(Δ) = 1 / (1 + (2Δ/Δν)^2)

Key markers:
α(ν0) = α0
α(ν0 ± Δν/2) = α0/2   (half-maximum points)
α(ν0 ± Δν) = α0/5     (because 1/(1+4)=0.2)</div>
        </div>

        <p class="note">
          On your sketch, label the peak <span class="eq">α0</span>, the center frequency <span class="eq">ν0=c/λ0</span>, and the FWHM <span class="eq">Δν</span>
          (distance between the two half-maximum points).
        </p>

        <h3>(e) Saturation photon-flux density for which attenuation halves</h3>

        <p>
          A standard steady-state saturable absorber model (two-level, homogeneous broadening) writes the intensity-dependent attenuation as:
          <span class="eq">α = α0/(1+s)</span>, where the saturation parameter is <span class="eq">s = φ/φs</span> on resonance.
          The condition “attenuation decreases by a factor of 2” is <span class="eq">α=α0/2</span> ⇒ <span class="eq">1+s=2</span> ⇒ <span class="eq">s=1</span>.
        </p>

        <div class="eqbox">
          <button class="copybtn" data-copy="eqE">(copy)</button>
          <div class="eq" id="eqE">On-resonance saturation photon-flux density (photons·m⁻²·s⁻¹):
φs = 1 / (2 σ0 τsp)

Equivalent saturation intensity:
Is = φs (hν0) = (hν0)/(2 σ0 τsp)</div>
        </div>

        <p>Numerically, with <span class="eq">σ0≈6.33×10^−21 m^2</span> and <span class="eq">τsp=10^−3 s</span>:</p>
        <div class="card">
          <p class="eq">
            φs = 1/(2 σ0 τsp)
               ≈ 1 / (2×6.33×10^−21×10^−3)
               ≈ 7.90×10^22 photons·m^−2·s^−1
          </p>
          <p class="eq">
            hν0 = ΔE ≈ 2.48 eV ≈ 3.97×10^−19 J
          </p>
          <p class="eq">
            Is = φs hν0 ≈ (7.90×10^22)(3.97×10^−19) ≈ 3.14×10^4 W/m^2
          </p>
        </div>

        <div class="card warn">
          <h3>Off-resonance saturation (important for part f)</h3>
          <p>
            For detuning <span class="eq">Δ</span>, the saturation parameter becomes
            <span class="eq">s(Δ) = (φ/φs) · L(Δ)</span>.
            This means you need <b>more</b> photon flux to saturate when detuned:
            <span class="eq">φs(Δ) = φs / L(Δ) = φs (1+(2Δ/Δν)^2)</span>.
          </p>
        </div>

        <h3>(f) Transmitted photon-flux density <span class="eq">φ(d)</span> vs incident <span class="eq">φ(0)</span></h3>

        <p>
          In the linear regime (<span class="eq">φ ≪ φs</span>), Beer–Lambert gives:
          <span class="eq">φ(d) = φ(0) e^{−α(ν) d}</span>.
          With saturation, <span class="eq">α</span> depends on <span class="eq">φ</span>, so we solve a nonlinear propagation equation.
        </p>

        <div class="eqbox">
          <button class="copybtn" data-copy="eqF">(copy)</button>
          <div class="eq" id="eqF">Saturable-absorption propagation model (narrowband beam):
α(ν,φ) = α0 L(Δ) / (1 + (φ/φs) L(Δ))

Differential equation:
dφ/dz = − α0 L(Δ) · φ / (1 + (φ/φs) L(Δ))

Integrated implicit relation (from z=0 to z=d):
φ(d) + φs(Δ) ln(φ(d)) = φ(0) + φs(Δ) ln(φ(0)) − α0(Δ) φs(Δ) d

where:
α0(Δ) = α0 L(Δ)
φs(Δ) = φs / L(Δ)</div>
        </div>

        <p>
          For the two requested cases:
        </p>
        <ul>
          <li><b>On resonance:</b> <span class="eq">Δ=0</span> ⇒ <span class="eq">L=1</span>, so <span class="eq">α0(0)=α0</span>, <span class="eq">φs(0)=φs</span>.</li>
          <li><b>At</b> <span class="eq">ν=ν0+Δν</span>: <span class="eq">Δ=Δν</span> ⇒ <span class="eq">L=1/5</span>, so <span class="eq">α0=α0/5</span> and <span class="eq">φs=5φs</span>.</li>
        </ul>

        <div class="card ok">
          <h3>Final numeric answers (key results)</h3>
          <div class="eqbox" style="margin:0;">
            <button class="copybtn" data-copy="finalAns">(copy)</button>
            <div class="eq" id="finalAns">Given: N=1e23, V=1e-6 m^3, ΔE=2.48 eV, λ0=0.5 μm, τsp=1 ms, Δν=1 GHz.

(a) Thermal populations:
At kT1=0.026 eV:  r=exp(-2.48/0.026)=3.76e-42 ⇒ N1≈1.00e23, N2≈3.76e-19 (~0).
At kT2=0.26 eV:   r=exp(-2.48/0.26)=7.20e-5  ⇒ N1≈9.9993e22, N2≈7.20e18.

(b) Spontaneous photons/s (A21=1/τsp=1000 s^-1):
Rsp(T1)≈3.76e-16 s^-1 (~0),   Rsp(T2)≈7.20e21 s^-1.

(c) Line-center cross-section and small-signal attenuation:
σ0 = λ0^2 A21 /(4π^2 Δν) ≈ 6.33e-21 m^2.
n≈N/V=1e29 m^-3; (n1-n2)≈n ⇒ α0≈ (n1−n2)σ0 ≈ 6.33e8 m^-1.

(d) Spectrum:
α(ν)=α0 / (1+(2(ν−ν0)/Δν)^2); half-maximum at ν0±Δν/2.

(e) Saturation photon-flux density for α→α/2 (on resonance):
φs = 1/(2σ0 τsp) ≈ 7.90e22 photons·m^-2·s^-1
(Is = φs hν0 ≈ 3.14e4 W/m^2).

(f) Transmission with saturation:
Use dφ/dz = −α0 L(Δ) φ /(1+(φ/φs)L(Δ)).
On resonance: L=1. At ν=ν0+Δν: L=1/5 so α0→α0/5 and φs→5φs.
In the low-flux limit φ(0)≪φs: φ(d)≈φ(0) exp(−α0 L(Δ) d).</div>
          </div>
        </div>

      </section>

      <section id="part4" class="fadeIn">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <div class="row">
          <div class="card">
            <h3>Re-interpreting the formulas</h3>
            <ul>
              <li><span class="eq">σ0 ∝ λ0^2 A21/Δν</span>: stronger transitions (larger <span class="eq">A21</span>) and narrower lines (smaller <span class="eq">Δν</span>) absorb more strongly.</li>
              <li><span class="eq">α0 ∝ (n1−n2)</span>: thermal excitation reduces absorption slightly (and would become gain if inverted).</li>
              <li><span class="eq">φs ∝ 1/(σ0 τsp)</span>: long lifetimes and large cross-sections saturate at lower flux (easier bleaching).</li>
              <li>Detuning reduces absorption by <span class="eq">L(Δ)</span> and increases the required saturation flux by <span class="eq">1/L(Δ)</span>.</li>
            </ul>
          </div>
          <div class="card callout">
            <h3>Parameter effects (connect to plots)</h3>
            <ul>
              <li>Increasing <span class="eq">kT</span> increases <span class="eq">N2</span>, decreasing <span class="eq">(n1−n2)</span> and hence lowering the whole <span class="eq">α(ν)</span> curve slightly.</li>
              <li>Increasing linewidth <span class="eq">Δν</span> (not varied here) lowers <span class="eq">σ0</span> and broadens the spectrum: peak absorption drops but the line spreads out.</li>
              <li>At a fixed thickness <span class="eq">d</span>, the transmission curve <span class="eq">φ(d)</span> vs <span class="eq">φ(0)</span> starts linear (Beer–Lambert) and bends upward as saturation reduces attenuation.</li>
            </ul>
          </div>
        </div>

        <div class="card">
          <h3>Alternative derivation idea (brief)</h3>
          <p>
            Instead of using the cross-section shortcut, one can start from Einstein coefficients:
            <span class="eq">A21 = (8πhν0^3/c^3) B21</span>, and with <span class="eq">B12=B21</span> (for equal degeneracy),
            relate the stimulated transition rate to the radiation energy density. Converting energy density to beam intensity yields the same
            <span class="eq">σ0</span> and saturation intensity <span class="eq">Is</span> once the Lorentzian spectral density is used.
          </p>
        </div>

        <div class="card ok">
          <h3>Concept check (quick self-test)</h3>
          <ul>
            <li><b>Q:</b> Why does <span class="eq">α</span> scale with <span class="eq">(n1−n2)</span> and not just <span class="eq">n1</span>? <b>A:</b> stimulated emission from level 2 cancels absorption events from level 1; net effect depends on population difference.</li>
            <li><b>Q:</b> At what detuning do you get half the peak absorption? <b>A:</b> when <span class="eq">|Δ|=Δν/2</span> (by definition of FWHM for Lorentzian).</li>
            <li><b>Q:</b> If <span class="eq">τsp</span> were 10× longer, what happens to <span class="eq">φs</span>? <b>A:</b> it becomes 10× smaller (easier to saturate).</li>
            <li><b>Q:</b> For <span class="eq">ν=ν0+Δν</span>, what happens to saturation flux? <b>A:</b> it increases by 5× because the Lorentzian factor is 1/5.</li>
          </ul>
        </div>
      </section>

      <section id="part5" class="fadeIn">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <div class="split">
          <div class="card">
            <h3>Interactive controls (what changes and why)</h3>
            <div class="controls">
              <div class="control">
                <label>
                  Thermal energy <span class="eq">kT</span> (eV)
                  <span class="v" id="kTread">0.260</span>
                </label>
                <input id="kTslider" type="range" min="0.01" max="0.60" step="0.001" value="0.26" />
                <div class="mini">This updates populations <span class="eq">N1,N2</span>, spontaneous rate, and the absorption level <span class="eq">α0</span>.</div>
              </div>

              <div class="control">
                <label>
                  Sample thickness <span class="eq">d</span> (cm)
                  <span class="v" id="dread">1.00</span>
                </label>
                <input id="dslider" type="range" min="0.01" max="2.00" step="0.01" value="1.00" />
                <div class="mini">Transmission curves depend strongly on <span class="eq">α d</span> (optical depth).</div>
              </div>

              <div class="control">
                <label>
                  Display detuning marker <span class="eq">Δ</span>
                  <span class="v" id="dnuRead">1.00</span>
                </label>
                <input id="detuneSlider" type="range" min="0.0" max="2.0" step="0.01" value="1.0" />
                <div class="mini">Marker is at <span class="eq">ν = ν0 + (detune)·Δν</span>. Absorption there scales by the Lorentzian factor.</div>
              </div>

              <div class="control">
                <label>
                  Temperature presets
                </label>
                <select id="preset">
                  <option value="0.026">kT1 = 0.026 eV (low)</option>
                  <option value="0.26" selected>kT2 = 0.26 eV (high)</option>
                </select>
                <div class="mini">Select the two temperatures used in parts (a)–(b).</div>
              </div>
            </div>

            <div class="kpi">
              <div class="card">
                <div class="k">Populations (in 1 cm³)</div>
                <div class="v" id="popRead">N1=… , N2=…</div>
              </div>
              <div class="card">
                <div class="k">Spontaneous emission rate</div>
                <div class="v" id="rspRead">Rsp=… photons/s</div>
              </div>
              <div class="card">
                <div class="k">Line-center cross-section</div>
                <div class="v" id="sigRead">σ0=… m²</div>
              </div>
              <div class="card">
                <div class="k">Small-signal attenuation (resonant)</div>
                <div class="v" id="alphaRead">α0=… m⁻¹</div>
              </div>
              <div class="card">
                <div class="k">Saturation photon flux (resonant)</div>
                <div class="v" id="phisRead">φs=…</div>
              </div>
              <div class="card">
                <div class="k">Lorentzian factor at marker</div>
                <div class="v" id="Lread">L=…</div>
              </div>
            </div>
          </div>

          <div class="card callout">
            <h3>What each canvas shows</h3>
            <ul>
              <li><b>Diagram:</b> a slab of medium (thickness <span class="eq">d</span>) with an incoming narrowband beam. Labels show <span class="eq">N1,N2</span>, <span class="eq">α(ν)</span>, and the direction of propagation.</li>
              <li><b>Main plot (spectrum):</b> <span class="eq">α(ν)</span> vs detuning <span class="eq">Δ/Δν</span> using the Lorentzian model, including a marker at the chosen detuning.</li>
              <li><b>Secondary plot (nonlinear transmission):</b> <span class="eq">φ(d)</span> vs <span class="eq">φ(0)</span> for two cases:
                (i) <span class="eq">ν=ν0</span> and (ii) <span class="eq">ν=ν0+Δν</span>. You will see the curves start linear and then bend as saturation sets in.</li>
            </ul>
            <p class="note">
              All plotted parameters match the symbols used in the derivation. The medium is extremely dense, so the optical depth can be enormous for d=1 cm; use the thickness slider to explore.
            </p>
          </div>
        </div>

        <div class="viz">
          <div>
            <canvas id="diagram" aria-label="Physical setup diagram"></canvas>
            <div class="caption">Diagram: narrowband beam through a two-level absorbing slab (labels update with controls).</div>
          </div>
          <div>
            <canvas id="plot1" aria-label="Attenuation spectrum plot"></canvas>
            <div class="caption">Main plot: Lorentzian attenuation spectrum <span class="eq">α(ν)</span> with linewidth <span class="eq">Δν</span>.</div>
          </div>
          <div>
            <canvas id="plot2" aria-label="Transmission vs incident flux plot"></canvas>
            <div class="caption">Secondary plot: transmitted photon flux <span class="eq">φ(d)</span> vs incident <span class="eq">φ(0)</span> (saturable absorption).</div>
          </div>
        </div>

        <footer>
          <div>
            Notes: The numerical values use SI internally. Degeneracies were not specified; we assumed <span class="eq">g1=g2</span>. If <span class="eq">g2≠g1</span>,
            replace <span class="eq">(n1−n2)</span> with <span class="eq">(n1 − (g1/g2)n2)</span> in the net absorption.
          </div>
        </footer>
      </section>
    </main>
  </div>

  <script>
    // ---------- Smooth scroll for TOC ----------
    document.querySelectorAll('[data-scroll]').forEach(a=>{
      a.addEventListener('click', (e)=>{
        e.preventDefault();
        const id = a.getAttribute('href');
        const el = document.querySelector(id);
        if(!el) return;
        el.scrollIntoView({behavior:'smooth', block:'start'});
      });
    });

    // ---------- Copy buttons ----------
    function copyText(txt){
      navigator.clipboard.writeText(txt).then(()=>{
        // no toast to keep minimal; button text feedback:
      }).catch(()=>{});
    }
    document.querySelectorAll('.copybtn').forEach(btn=>{
      btn.addEventListener('click', ()=>{
        const targetId = btn.getAttribute('data-copy');
        const el = document.getElementById(targetId);
        if(!el) return;
        copyText(el.textContent.trim());
        const old = btn.textContent;
        btn.textContent = 'copied';
        setTimeout(()=>btn.textContent = old, 900);
      });
    });

    // ---------- Constants (given) ----------
    const N_total = 1e23;             // atoms in 1 cm^3
    const V = 1e-6;                   // m^3
    const dE_eV = 2.48;               // eV
    const lambda0 = 0.5e-6;           // m
    const tau_sp = 1e-3;              // s
    const A21 = 1/tau_sp;             // s^-1
    const dnu_FWHM = 1e9;             // Hz (Δν)
    const eV = 1.602176634e-19;       // J
    const hnu = dE_eV * eV;           // J (photon energy)
    const c = 299792458;

    // Line-center absorption cross-section (Lorentzian, FWHM = Δν)
    // σ0 = λ^2 A / (4π^2 Δν)
    function sigma0(){
      return (lambda0*lambda0 * A21) / (4*Math.PI*Math.PI * dnu_FWHM);
    }

    // Lorentzian factor L(Δ) = 1/(1+(2Δ/Δν)^2)
    function Lfactor(detuneHz){
      const x = 2*detuneHz/dnu_FWHM;
      return 1/(1 + x*x);
    }

    // Thermal populations
    function populations(kT_eV){
      const r = Math.exp(-dE_eV / kT_eV); // N2/N1
      const N1 = N_total/(1+r);
      const N2 = N_total*r/(1+r);
      return {r, N1, N2};
    }

    // Small-signal resonant attenuation α0 = (n1 - n2) σ0
    function alpha0_from_kT(kT_eV){
      const {N1, N2} = populations(kT_eV);
      const n1 = N1/V;
      const n2 = N2/V;
      return (n1 - n2) * sigma0();
    }

    // Resonant saturation photon flux φs = 1/(2 σ0 τsp)
    function phi_s(){
      return 1/(2*sigma0()*tau_sp);
    }

    // Transmission with saturation (solve implicit equation):
    // y + phis ln y = x + phis ln x - alpha phis d
    // Here alpha = α0 L, phis_eff = phis / L
    function transmitPhi(phi0, alpha_eff, phis_eff, d_m){
      // If phi0 is extremely small, return Beer-Lambert to avoid log issues.
      const tiny = 1e-30;
      const x = Math.max(phi0, tiny);
      const K = x + phis_eff*Math.log(x) - alpha_eff*phis_eff*d_m;

      // Solve f(y)=y + phis ln y - K = 0 for y>0
      // Use Newton with safe bracketing.
      let y = Math.max(x*Math.exp(-alpha_eff*d_m), tiny); // start near linear solution
      for(let i=0;i<40;i++){
        const f = y + phis_eff*Math.log(Math.max(y,tiny)) - K;
        const fp = 1 + phis_eff/Math.max(y,tiny);
        const step = f/fp;
        y = y - step;
        if(!(y>0)) y = tiny;
        if(Math.abs(step)/Math.max(y,1) < 1e-10) break;
      }
      return y;
    }

    // ---------- Canvas helpers ----------
    function setupCanvas(canvas){
      const ctx = canvas.getContext('2d');
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.floor(rect.width * dpr);
      canvas.height = Math.floor(rect.height * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {ctx, w: rect.width, h: rect.height, dpr};
    }

    function drawPanelBG(ctx, w, h){
      // subtle gradient background
      const g = ctx.createLinearGradient(0,0,w,h);
      g.addColorStop(0, 'rgba(255,255,255,0.04)');
      g.addColorStop(1, 'rgba(0,0,0,0.18)');
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);
    }

    function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
      const {x,y,w,h} = box;
      ctx.save();
      ctx.translate(x,y);

      // Title
      ctx.fillStyle = 'rgba(233,238,247,0.95)';
      ctx.font = '600 14px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(title, 0, -10);

      // Grid
      ctx.strokeStyle = 'rgba(255,255,255,0.08)';
      ctx.lineWidth = 1;

      const nGrid = 5;
      for(let i=0;i<=nGrid;i++){
        const gx = (i/nGrid)*w;
        ctx.beginPath(); ctx.moveTo(gx,0); ctx.lineTo(gx,h); ctx.stroke();
        const gy = (i/nGrid)*h;
        ctx.beginPath(); ctx.moveTo(0,gy); ctx.lineTo(w,gy); ctx.stroke();
      }

      // Axes frame
      ctx.strokeStyle = 'rgba(255,255,255,0.18)';
      ctx.strokeRect(0,0,w,h);

      // Ticks and labels
      ctx.fillStyle = 'rgba(169,182,204,0.95)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace';

      function fmt(v){
        const av = Math.abs(v);
        if(av===0) return '0';
        if(av<1e-2 || av>=1e4) return v.toExponential(2);
        return (Math.round(v*1000)/1000).toString();
      }

      // x ticks
      for(let i=0;i<=nGrid;i++){
        const t = i/nGrid;
        const val = xMin + t*(xMax-xMin);
        const px = t*w;
        ctx.beginPath();
        ctx.moveTo(px,h); ctx.lineTo(px,h+6);
        ctx.strokeStyle='rgba(255,255,255,0.22)';
        ctx.stroke();
        ctx.fillText(fmt(val), px-12, h+18);
      }
      // y ticks
      for(let i=0;i<=nGrid;i++){
        const t = 1 - i/nGrid;
        const val = yMin + (1-t)*(yMax-yMin);
        const py = t*h;
        ctx.beginPath();
        ctx.moveTo(-6,py); ctx.lineTo(0,py);
        ctx.strokeStyle='rgba(255,255,255,0.22)';
        ctx.stroke();
        ctx.fillText(fmt(val), -58, py+4);
      }

      // Axis labels
      ctx.fillStyle = 'rgba(233,238,247,0.80)';
      ctx.font = '600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(xLabel, w/2 - ctx.measureText(xLabel).width/2, h+40);

      ctx.save();
      ctx.translate(-46, h/2);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();

      ctx.restore();
    }

    function xyToPix(box, xMin, xMax, yMin, yMax, xVal, yVal){
      const {x,y,w,h} = box;
      const px = x + (xVal - xMin)/(xMax-xMin) * w;
      const py = y + (1 - (yVal - yMin)/(yMax-yMin)) * h;
      return {px,py};
    }

    // ---------- Drawing: Diagram ----------
    function drawDiagram(kT, d_cm){
      const canvas = document.getElementById('diagram');
      const {ctx,w,h} = setupCanvas(canvas);
      ctx.clearRect(0,0,w,h);
      drawPanelBG(ctx,w,h);

      const pad = 18;
      const slabW = Math.min(220, w*0.42);
      const slabH = Math.min(200, h*0.55);
      const slabX = w*0.52;
      const slabY = h*0.22;

      // Beam
      ctx.strokeStyle = 'rgba(125,211,252,0.95)';
      ctx.lineWidth = 6;
      ctx.lineCap = 'round';
      const beamY = slabY + slabH*0.55;
      ctx.beginPath();
      ctx.moveTo(pad, beamY);
      ctx.lineTo(slabX, beamY);
      ctx.stroke();

      // Arrowhead
      ctx.fillStyle = 'rgba(125,211,252,0.95)';
      ctx.beginPath();
      ctx.moveTo(slabX, beamY);
      ctx.lineTo(slabX-18, beamY-10);
      ctx.lineTo(slabX-18, beamY+10);
      ctx.closePath();
      ctx.fill();

      // Slab
      ctx.fillStyle = 'rgba(167,139,250,0.10)';
      ctx.strokeStyle = 'rgba(167,139,250,0.65)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.roundRect(slabX, slabY, slabW, slabH, 16);
      ctx.fill();
      ctx.stroke();

      // Inside level diagram
      const {N1,N2} = populations(kT);
      ctx.fillStyle = 'rgba(233,238,247,0.95)';
      ctx.font = '600 13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText('Two-level atoms (thermal eq.)', slabX+14, slabY+22);

      // Levels
      const lx = slabX+22;
      const ly1 = slabY+slabH*0.70;
      const ly2 = slabY+slabH*0.35;
      ctx.strokeStyle = 'rgba(233,238,247,0.75)';
      ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(lx, ly1); ctx.lineTo(lx+70, ly1); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(lx, ly2); ctx.lineTo(lx+70, ly2); ctx.stroke();

      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace';
      ctx.fillStyle = 'rgba(233,238,247,0.85)';
      ctx.fillText('|1⟩ (E1=0)', lx+80, ly1+4);
      ctx.fillText('|2⟩ (E2=2.48 eV)', lx+80, ly2+4);

      // Transition arrow
      ctx.strokeStyle = 'rgba(125,211,252,0.85)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(lx+35, ly1-6);
      ctx.lineTo(lx+35, ly2+6);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(lx+35, ly2+6);
      ctx.lineTo(lx+28, ly2+18);
      ctx.lineTo(lx+42, ly2+18);
      ctx.closePath();
      ctx.fillStyle = 'rgba(125,211,252,0.85)';
      ctx.fill();

      // Output beam
      ctx.strokeStyle = 'rgba(52,211,153,0.9)';
      ctx.lineWidth = 6;
      ctx.beginPath();
      ctx.moveTo(slabX+slabW, beamY);
      ctx.lineTo(w-pad, beamY);
      ctx.stroke();

      // Labels
      ctx.fillStyle = 'rgba(169,182,204,0.95)';
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText('Incident photon flux  φ(0)', pad, beamY-16);
      ctx.fillText('Transmitted photon flux  φ(d)', slabX+slabW+10, beamY-16);

      // Thickness bracket
      ctx.strokeStyle = 'rgba(233,238,247,0.35)';
      ctx.lineWidth = 2;
      const bx1 = slabX;
      const bx2 = slabX+slabW;
      const by = slabY+slabH+20;
      ctx.beginPath();
      ctx.moveTo(bx1,by); ctx.lineTo(bx2,by);
      ctx.moveTo(bx1,by-8); ctx.lineTo(bx1,by+8);
      ctx.moveTo(bx2,by-8); ctx.lineTo(bx2,by+8);
      ctx.stroke();
      ctx.fillStyle = 'rgba(233,238,247,0.75)';
      ctx.font = '600 12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
      ctx.fillText(`d = ${d_cm.toFixed(2)} cm`, (bx1+bx2)/2 - 38, by+22);

      // Population text
      ctx.fillStyle = 'rgba(233,238,247,0.90)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace';
      const sN1 = fmtSci(N1, 3);
      const sN2 = fmtSci(N2, 3);
      ctx.fillText(`N1 ≈ ${sN1}   atoms`, slabX+14, slabY+slabH-42);
      ctx.fillText(`N2 ≈ ${sN2}   atoms`, slabX+14, slabY+slabH-22);

      // Corner constants
      ctx.fillStyle = 'rgba(169,182,204,0.9)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace';
      ctx.fillText(`λ0=0.5 μm,  Δν=1 GHz,  τsp=1 ms`, pad, h-18);
    }

    // ---------- Drawing: Plot 1 (attenuation spectrum) ----------
    function drawSpectrum(kT, detuneFactor){
      const canvas = document.getElementById('plot1');
      const {ctx,w,h} = setupCanvas(canvas);
      ctx.clearRect(0,0,w,h);
      drawPanelBG(ctx,w,h);

      const box = {x:72, y:46, w:w-92, h:h-98};
      const a0 = alpha0_from_kT(kT);
      const xMin = -2.0, xMax = 2.0; // detuning in units of Δν
      const yMin = 0, yMax = a0;     // show full peak

      drawAxes(ctx, box, xMin, xMax, yMin, yMax, 'detuning  Δ/Δν  (dimensionless)', 'attenuation  α  (m⁻¹)', 'Lorentzian absorption spectrum α(ν)');

      // curve
      ctx.strokeStyle = 'rgba(125,211,252,0.95)';
      ctx.lineWidth = 2.5;
      ctx.beginPath();
      for(let i=0;i<=500;i++){
        const t = i/500;
        const x = xMin + t*(xMax-xMin);
        const L = 1/(1 + (2*x)**2); // because x = Δ/Δν, so 2Δ/Δν = 2x
        const y = a0*L;
        const {px,py} = xyToPix(box,xMin,xMax,yMin,yMax,x,y);
        if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      }
      ctx.stroke();

      // Half max lines at ±0.5
      ctx.setLineDash([6,6]);
      ctx.strokeStyle = 'rgba(251,191,36,0.55)';
      ctx.lineWidth = 1.5;
      [-0.5, 0.5].forEach(x=>{
        const {px} = xyToPix(box,xMin,xMax,yMin,yMax,x,0);
        ctx.beginPath(); ctx.moveTo(px, box.y); ctx.lineTo(px, box.y+box.h); ctx.stroke();
      });
      // y=α0/2
      const {py:pyHalf} = xyToPix(box,xMin,xMax,yMin,yMax,0,a0/2);
      ctx.beginPath(); ctx.moveTo(box.x, pyHalf); ctx.lineTo(box.x+box.w, pyHalf); ctx.stroke();
      ctx.setLineDash([]);

      // Detuning marker
      const xm = Math.max(xMin, Math.min(xMax, detuneFactor));
      const Lm = 1/(1 + (2*xm)**2);
      const ym = a0*Lm;
      const pt = xyToPix(box,xMin,xMax,yMin,yMax,xm,ym);

      ctx.fillStyle = 'rgba(52,211,153,0.95)';
      ctx.beginPath(); ctx.arc(pt.px, pt.py, 5.2, 0, Math.PI*2); ctx.fill();

      // Marker line
      ctx.strokeStyle = 'rgba(52,211,153,0.35)';
      ctx.lineWidth = 1.5;
      ctx.beginPath(); ctx.moveTo(pt.px, box.y); ctx.lineTo(pt.px, box.y+box.h); ctx.stroke();

      // Legend text
      ctx.fillStyle = 'rgba(233,238,247,0.85)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace';
      ctx.fillText(`α0 = ${fmtSci(a0,3)} m⁻¹`, box.x+10, box.y-16);
      ctx.fillStyle = 'rgba(52,211,153,0.95)';
      ctx.fillText(`marker: Δ/Δν = ${xm.toFixed(2)},  L=${Lm.toFixed(3)}`, box.x+210, box.y-16);
    }

    // ---------- Drawing: Plot 2 (transmission vs incident flux) ----------
    function drawTransmission(kT, d_cm){
      const canvas = document.getElementById('plot2');
      const {ctx,w,h} = setupCanvas(canvas);
      ctx.clearRect(0,0,w,h);
      drawPanelBG(ctx,w,h);

      const box = {x:72, y:46, w:w-92, h:h-98};

      const a0 = alpha0_from_kT(kT);
      const phis = phi_s();

      // We'll plot phi0 from 1e-4 phis to 1e+2 phis (log scale), y is phi(d)/phis (log-ish but we plot linear in ratio with log x axis emulated)
      // For simplicity: x-axis is log10(phi0/phis), y-axis is phi(d)/phis (linear), capped.
      const xMin = -4, xMax = 2; // log10(phi0/phis)
      const yMin = 0, yMax = 1.2; // show up to ~1.2 phis

      drawAxes(ctx, box, xMin, xMax, yMin, yMax, 'log10( φ(0)/φs )', 'φ(d)/φs (dimensionless)', 'Transmission with saturation: φ(d) vs φ(0)');

      const d_m = d_cm/100;

      // Two cases: on resonance (Δ=0) and detuned by Δν (Δ=Δν)
      const cases = [
        {name:'ν=ν0 (resonant)', L:1.0, color:'rgba(125,211,252,0.95)'},
        {name:'ν=ν0+Δν', L:1/5, color:'rgba(167,139,250,0.95)'}
      ];

      // Draw curves
      cases.forEach((cs, idx)=>{
        const alpha_eff = a0 * cs.L;
        const phis_eff = phis / cs.L;

        ctx.strokeStyle = cs.color;
        ctx.lineWidth = 2.5;
        ctx.beginPath();
        for(let i=0;i<=360;i++){
          const t = i/360;
          const x = xMin + t*(xMax-xMin);
          const phi0 = phis * Math.pow(10, x);
          const phid = transmitPhi(phi0, alpha_eff, phis_eff, d_m);
          const y = Math.min(yMax, phid/phis); // ratio to resonant phis for axis consistency
          const {px,py} = xyToPix(box, xMin, xMax, yMin, yMax, x, y);
          if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
        }
        ctx.stroke();

        // A few label points
        const xlab = -1.0 + idx*0.35;
        const phi0lab = phis * Math.pow(10, xlab);
        const phidlab = transmitPhi(phi0lab, alpha_eff, phis_eff, d_m);
        const ylab = Math.min(yMax, phidlab/phis);
        const pt = xyToPix(box,xMin,xMax,yMin,yMax,xlab,ylab);

        ctx.fillStyle = cs.color;
        ctx.beginPath(); ctx.arc(pt.px, pt.py, 4.5, 0, Math.PI*2); ctx.fill();
      });

      // Draw low-flux linear regime guide for resonant case: phi(d)=phi(0)exp(-αd)
      const alpha_lin = a0;
      const expfac = Math.exp(-alpha_lin*d_m);
      ctx.setLineDash([5,6]);
      ctx.strokeStyle = 'rgba(52,211,153,0.55)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      for(let i=0;i<=200;i++){
        const t = i/200;
        const x = xMin + t*(xMax-xMin);
        const phi0 = phis * Math.pow(10, x);
        const phid = phi0 * expfac;
        const y = Math.min(yMax, phid/phis);
        const {px,py} = xyToPix(box,xMin,xMax,yMin,yMax,x,y);
        if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
      }
      ctx.stroke();
      ctx.setLineDash([]);

      // Legend
      ctx.fillStyle = 'rgba(233,238,247,0.85)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace';
      ctx.fillText(`d=${d_cm.toFixed(2)} cm  |  φs(res)=${fmtSci(phis,3)}  photons·m⁻²·s⁻¹`, box.x+10, box.y-16);

      // Legend markers
      const lx = box.x+10, ly = box.y+10;
      cases.forEach((cs, i)=>{
        ctx.fillStyle = cs.color;
        ctx.fillRect(lx, ly + i*18, 16, 4);
        ctx.fillStyle = 'rgba(233,238,247,0.85)';
        ctx.fillText(cs.name, lx+22, ly + i*18 + 6);
      });
      ctx.fillStyle = 'rgba(52,211,153,0.85)';
      ctx.fillRect(lx, ly+2*18, 16, 4);
      ctx.fillStyle = 'rgba(233,238,247,0.85)';
      ctx.fillText('linear Beer–Lambert guide (resonant)', lx+22, ly+2*18+6);
    }

    // ---------- Formatting helpers ----------
    function fmtSci(val, sig=3){
      if(val === 0) return '0';
      const abs = Math.abs(val);
      const exp = Math.floor(Math.log10(abs));
      const mant = val / Math.pow(10, exp);
      const m = mant.toFixed(sig-1);
      return `${m}e${exp>=0?'+':''}${exp}`;
    }

    function updateReadouts(kT, d_cm, detuneFactor){
      const pop = populations(kT);
      const rsp = pop.N2 * A21;
      const s0 = sigma0();
      const a0 = alpha0_from_kT(kT);
      const phis = phi_s();

      const detHz = detuneFactor * dnu_FWHM;
      const L = Lfactor(detHz);

      document.getElementById('kTread').textContent = kT.toFixed(3);
      document.getElementById('dread').textContent = d_cm.toFixed(2);
      document.getElementById('dnuRead').textContent = detuneFactor.toFixed(2);

      document.getElementById('popRead').textContent = `N1=${fmtSci(pop.N1,4)} , N2=${fmtSci(pop.N2,4)}`;
      document.getElementById('rspRead').textContent = `Rsp=${fmtSci(rsp,3)} photons/s`;
      document.getElementById('sigRead').textContent = `σ0=${fmtSci(s0,3)} m²`;
      document.getElementById('alphaRead').textContent = `α0=${fmtSci(a0,3)} m⁻¹`;
      document.getElementById('phisRead').textContent = `φs=${fmtSci(phis,3)} photons·m⁻²·s⁻¹`;
      document.getElementById('Lread').textContent = `L=${L.toFixed(4)} (at Δ=${detuneFactor.toFixed(2)}Δν)`;
    }

    // ---------- Main update ----------
    function redrawAll(){
      const kT = parseFloat(document.getElementById('kTslider').value);
      const d_cm = parseFloat(document.getElementById('dslider').value);
      const detuneFactor = parseFloat(document.getElementById('detuneSlider').value);

      updateReadouts(kT, d_cm, detuneFactor);
      drawDiagram(kT, d_cm);
      drawSpectrum(kT, detuneFactor);
      drawTransmission(kT, d_cm);
    }

    // ---------- UI wiring ----------
    const kTslider = document.getElementById('kTslider');
    const dslider = document.getElementById('dslider');
    const detuneSlider = document.getElementById('detuneSlider');
    const preset = document.getElementById('preset');

    function setKT(val){
      kTslider.value = val;
      redrawAll();
    }

    [kTslider, dslider, detuneSlider].forEach(el=>{
      el.addEventListener('input', redrawAll);
    });

    preset.addEventListener('change', ()=>{
      const val = parseFloat(preset.value);
      setKT(val);
    });

    // Handle resize (responsive, crisp)
    window.addEventListener('resize', ()=>{
      redrawAll();
    });

    // Initial draw
    redrawAll();

    // Small polyfill for roundRect (older browsers)
    if(!CanvasRenderingContext2D.prototype.roundRect){
      CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
        r = Math.min(r, w/2, h/2);
        this.beginPath();
        this.moveTo(x+r,y);
        this.arcTo(x+w,y,x+w,y+h,r);
        this.arcTo(x+w,y+h,x,y+h,r);
        this.arcTo(x,y+h,x,y,r);
        this.arcTo(x,y,x+w,y,r);
        this.closePath();
        return this;
      }
    }
  </script>
</body>
</html>
