<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Significance of the Saturation Photon-Flux Density — Lifetime Halving in a Two-Level Atom</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#101827;
      --panel2:#0f172a;
      --text:#e7eefc;
      --muted:#a9b7d3;
      --faint:#7f90b5;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.16);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 18px 50px rgba(0,0,0,.45);
      --radius:18px;
      --radius2:14px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Consolas, "Liberation Mono", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background:
        radial-gradient(1200px 700px at 10% 10%, rgba(125,211,252,.10), transparent 60%),
        radial-gradient(1000px 650px at 90% 20%, rgba(167,139,250,.10), transparent 55%),
        radial-gradient(900px 700px at 55% 90%, rgba(52,211,153,.08), transparent 60%),
        linear-gradient(180deg, #070a10, var(--bg));
      color:var(--text);
      line-height:1.55;
    }

    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    code, .mono{font-family:var(--mono)}
    .wrap{
      max-width:1200px;
      margin:0 auto;
      padding:28px 18px 80px;
      display:grid;
      grid-template-columns: 280px minmax(0, 1fr);
      gap:18px;
      align-items:start;
    }

    header.hero{
      grid-column: 1 / -1;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:22px 22px 18px;
      position:relative;
      overflow:hidden;
    }
    header.hero::before{
      content:"";
      position:absolute; inset:-2px;
      background:
        radial-gradient(800px 300px at 15% 30%, rgba(125,211,252,.18), transparent 55%),
        radial-gradient(700px 280px at 80% 35%, rgba(167,139,250,.16), transparent 58%),
        radial-gradient(700px 250px at 50% 110%, rgba(52,211,153,.12), transparent 60%);
      filter: blur(10px);
      opacity:.8;
      pointer-events:none;
    }
    header.hero > *{position:relative}
    .kicker{
      color:var(--muted);
      font-size:.92rem;
      letter-spacing:.08em;
      text-transform:uppercase;
      margin:0 0 8px;
    }
    h1{
      font-size: clamp(1.45rem, 2.5vw, 2.05rem);
      margin:0 0 8px;
      line-height:1.15;
    }
    .sub{
      color:var(--muted);
      max-width: 80ch;
      margin: 0 0 14px;
    }
    .metaRow{
      display:flex; flex-wrap:wrap; gap:10px;
      align-items:center;
      margin-top:10px;
    }
    .pill{
      border:1px solid var(--line2);
      background: rgba(0,0,0,.18);
      color: var(--muted);
      padding:7px 10px;
      border-radius:999px;
      font-size:.88rem;
    }

    nav.toc{
      position:sticky;
      top:14px;
      align-self:start;
      background: linear-gradient(180deg, rgba(16,24,39,.92), rgba(16,24,39,.75));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px 12px;
      backdrop-filter: blur(10px);
    }
    nav.toc h2{
      font-size: .95rem;
      margin:0 0 10px;
      color:var(--text);
      letter-spacing:.04em;
    }
    .toc a{
      display:block;
      padding:8px 10px;
      border-radius:12px;
      color: var(--muted);
      font-size:.92rem;
      border:1px solid transparent;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .toc a:hover{
      background: rgba(255,255,255,.05);
      border-color: rgba(255,255,255,.10);
      transform: translateX(2px);
      text-decoration:none;
      color: var(--text);
    }

    main{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap:16px;
    }

    section.card{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px 18px 16px;
      overflow:hidden;
    }
    section.card h2{
      margin:0 0 10px;
      font-size: 1.22rem;
      letter-spacing:.01em;
    }
    section.card h3{
      margin:14px 0 8px;
      font-size: 1.06rem;
      color: var(--text);
    }
    p{margin:10px 0; color: var(--text)}
    ul{margin:10px 0 10px 22px; color:var(--text)}
    li{margin:6px 0}
    .muted{color:var(--muted)}
    .grid2{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .wrap{grid-template-columns: 1fr}
      nav.toc{position:relative; top:auto}
      .grid2{grid-template-columns: 1fr}
    }

    .callouts{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      margin-top:12px;
    }
    .callout{
      grid-column: span 12;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.18);
      border-radius: var(--radius2);
      padding:12px 12px 10px;
    }
    .callout strong{
      display:inline-flex;
      align-items:center;
      gap:8px;
      letter-spacing:.02em;
    }
    .tag{
      font-size:.78rem;
      padding:2px 8px;
      border-radius:999px;
      border:1px solid var(--line2);
      color:var(--muted);
      background: rgba(255,255,255,.04);
    }
    .callout.assump strong{color: var(--good)}
    .callout.eq strong{color: var(--accent)}
    .callout.pit strong{color: var(--warn)}
    .callout.ans strong{color: var(--accent2)}

    .equationBox{
      border:1px solid rgba(125,211,252,.22);
      background: rgba(125,211,252,.06);
      padding:12px;
      border-radius: var(--radius2);
      margin:10px 0;
      position:relative;
      overflow:hidden;
    }
    .equationBox .eq{
      font-family:var(--mono);
      white-space:pre-wrap;
      color: var(--text);
      line-height:1.45;
      margin:0;
      font-size:.95rem;
    }
    .copyBtn{
      position:absolute;
      top:10px; right:10px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.25);
      color: var(--muted);
      padding:6px 9px;
      border-radius: 12px;
      font-size:.82rem;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, color .12s ease;
      user-select:none;
    }
    .copyBtn:hover{
      transform: translateY(-1px);
      background: rgba(255,255,255,.06);
      color: var(--text);
    }
    .copyNote{
      font-size:.85rem;
      color: var(--faint);
      margin-top:6px;
    }

    .vizPanel{
      border:1px solid var(--line2);
      background: rgba(0,0,0,.14);
      border-radius: var(--radius);
      overflow:hidden;
    }
    .vizHeader{
      padding:12px 12px 10px;
      border-bottom:1px solid var(--line);
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      justify-content:space-between;
      align-items:center;
    }
    .vizHeader .title{
      font-size:.98rem;
      color:var(--text);
      letter-spacing:.01em;
    }
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap:10px 12px;
      align-items:center;
      justify-content:flex-end;
    }
    .control{
      display:flex;
      gap:8px;
      align-items:baseline;
      border:1px solid var(--line2);
      background: rgba(255,255,255,.03);
      padding:8px 10px;
      border-radius: 14px;
    }
    .control label{
      color: var(--muted);
      font-size:.84rem;
      white-space:nowrap;
    }
    .control .val{
      font-family: var(--mono);
      color: var(--text);
      font-size:.85rem;
      min-width: 10ch;
      text-align:right;
    }
    input[type="range"]{
      width: 160px;
      accent-color: var(--accent);
    }
    select{
      background: rgba(0,0,0,.22);
      color: var(--text);
      border:1px solid var(--line2);
      border-radius: 12px;
      padding:6px 8px;
      outline:none;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      background: radial-gradient(500px 260px at 30% 20%, rgba(125,211,252,.06), transparent 60%),
                  radial-gradient(500px 260px at 80% 35%, rgba(167,139,250,.05), transparent 65%),
                  rgba(0,0,0,.05);
    }
    .vizGrid{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      padding:12px;
    }
    @media (min-width: 980px){
      .vizGrid{grid-template-columns: 1.05fr .95fr}
      canvas.big{height:360px}
      canvas.small{height:360px}
    }

    .footer{
      grid-column:1 / -1;
      text-align:center;
      color: var(--faint);
      margin-top: 14px;
      font-size:.9rem;
    }

    /* print-friendly */
    @media print{
      body{background:#fff; color:#000}
      header.hero, section.card, nav.toc{box-shadow:none}
      nav.toc{display:none}
      .copyBtn{display:none}
      .vizPanel{break-inside:avoid}
      canvas{background:#fff}
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="hero">
      <p class="kicker">Photonics • Two-level atoms • Saturation</p>
      <h1>Significance of the Saturation Photon-Flux Density: When Stimulated Emission Cuts the Lifetime in Half</h1>
      <p class="sub">
        In a driven two-level atom, stimulated emission adds an extra decay channel from the excited state. This article builds the model from first principles,
        derives the effective lifetime, and identifies the photon-flux density where the lifetime becomes <span class="mono">τ₂/2</span>—then connects it to the
        standard saturation photon-flux density <span class="mono">φₛ</span>.
      </p>
      <div class="metaRow">
        <span class="pill">Symbols & units defined</span>
        <span class="pill">Step-by-step derivation</span>
        <span class="pill">Interactive plots (φ, τ₂, σ)</span>
        <span class="pill">No external libraries</span>
      </div>
    </header>

    <nav class="toc" aria-label="Table of contents">
      <h2>On this page</h2>
      <div class="toc">
        <a href="#quick">Quick Summary</a>
        <a href="#p0">PART 0 — Concept Primer</a>
        <a href="#p1">PART 1 — Problem Analysis</a>
        <a href="#p2">PART 2 — Strategy & Tips</a>
        <a href="#p3">PART 3 — Full Solution</a>
        <a href="#p4">PART 4 — Deeper Understanding</a>
        <a href="#p5">PART 5 — Visualization Guide</a>
      </div>
    </nav>

    <main>
      <section id="quick" class="card">
        <h2>Quick Summary</h2>
        <ul>
          <li><b>What this is about:</b> how an applied photon field increases the decay rate of an excited state via <b>stimulated emission</b>.</li>
          <li><b>Key physics idea:</b> decay rates <i>add</i>. The excited-state population obeys an exponential decay with total rate
            <span class="mono">Γ = Γ_sp + Γ_st</span>.</li>
          <li><b>Governing model:</b> for an excited level (level 2),
            <span class="mono">dN₂/dt = −(1/τ₂ + σφ) N₂</span>, where <span class="mono">σ</span> is the stimulated-emission cross section and
            <span class="mono">φ</span> is photon flux density.</li>
          <li><b>Effective lifetime:</b> <span class="mono">τ_eff(φ) = 1 / (1/τ₂ + σφ)</span>.</li>
          <li><b>Half-life condition (effective lifetime halves):</b> <span class="mono">τ_eff = τ₂/2</span> happens at
            <span class="mono">φ = 1/(σ τ₂)</span>.</li>
          <li><b>Connection to saturation:</b> the <b>saturation photon-flux density</b> is
            <span class="mono">φₛ ≡ 1/(σ τ₂)</span>, so the “half-lifetime” flux is <b>exactly</b> <span class="mono">φ = φₛ</span>.</li>
          <li><b>Result type:</b> symbolic (with example numeric values used only for plots).</li>
        </ul>
      </section>

      <section id="p0" class="card">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <div class="grid2">
          <div>
            <h3>Core definitions (symbols + units)</h3>
            <ul>
              <li><b>Excited-state lifetime (no stimulation):</b> <span class="mono">τ₂</span> [s] — mean time before spontaneous decay from level 2.</li>
              <li><b>Spontaneous decay rate:</b> <span class="mono">Γ_sp = 1/τ₂</span> [s⁻¹].</li>
              <li><b>Photon flux density:</b> <span class="mono">φ</span> [m⁻² s⁻¹] — number of photons crossing unit area per unit time (in the relevant mode/band).</li>
              <li><b>Stimulated-emission cross section:</b> <span class="mono">σ</span> [m²] — effective area that converts photon flux into stimulated transition rate.</li>
              <li><b>Stimulated emission rate per excited atom:</b> <span class="mono">Γ_st = σ φ</span> [s⁻¹].</li>
              <li><b>Effective lifetime under stimulation:</b> <span class="mono">τ_eff</span> [s] — lifetime corresponding to total decay rate.</li>
              <li><b>Saturation photon-flux density:</b> <span class="mono">φₛ</span> [m⁻² s⁻¹] — characteristic flux at which stimulated processes compete strongly with spontaneous decay.</li>
            </ul>

            <h3>Physical meaning (what these represent)</h3>
            <p>
              Think of an excited atom as having multiple “exit doors” back to the ground state. Without light, it has the spontaneous door with rate
              <span class="mono">1/τ₂</span>. When a resonant photon field is present, a second door appears: stimulated emission, where the field
              <i>triggers</i> emission and the emitted photon joins the field. More photons (higher <span class="mono">φ</span>) means that door is used more often.
            </p>
          </div>

          <div>
            <h3>Key principles + validity</h3>
            <ul>
              <li><b>Rate equations:</b> valid when coherence can be neglected (population dynamics slower than optical phase evolution, or in steady/averaged regimes).</li>
              <li><b>Additive decay rates:</b> independent Poisson processes add: <span class="mono">Γ_total = Γ₁ + Γ₂ + …</span>.</li>
              <li><b>Linear stimulated rate:</b> <span class="mono">Γ_st = σφ</span> assumes weak enough field (or appropriate definition of <span class="mono">σ</span>) such that the stimulated transition probability per time is proportional to flux.</li>
            </ul>

            <h3>Common models / approximations</h3>
            <ul>
              <li><b>Two-level approximation:</b> only levels 1 and 2 matter; no shelving/metastable states.</li>
              <li><b>Homogeneous broadening / on-resonance:</b> <span class="mono">σ</span> is treated as a constant (effective cross section at the operating frequency).</li>
              <li><b>Neglect re-absorption:</b> emitted photons don’t get reabsorbed by the same atom within the timescale considered.</li>
            </ul>

            <h3>Mini intuition examples</h3>
            <ul>
              <li>If <span class="mono">φ = 0</span>, only spontaneous decay acts, so <span class="mono">τ_eff = τ₂</span>.</li>
              <li>If <span class="mono">σφ ≫ 1/τ₂</span>, stimulated emission dominates, so <span class="mono">τ_eff ≈ 1/(σφ)</span> (lifetime shrinks inversely with flux).</li>
            </ul>

            <div class="callout pit">
              <strong><span class="tag">What to watch for</span> Typical pitfalls</strong>
              <ul class="muted">
                <li>Confusing photon <i>flux density</i> <span class="mono">φ</span> with intensity <span class="mono">I</span>; they differ by photon energy: <span class="mono">I = (hν) φ</span>.</li>
                <li>Forgetting that <b>rates add</b>, not lifetimes.</li>
                <li>Mixing units for <span class="mono">σ</span> (often quoted in cm²) with <span class="mono">φ</span> in m⁻² s⁻¹.</li>
              </ul>
            </div>

          </div>
        </div>
      </section>

      <section id="p1" class="card">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <h3>Restate the problem (in plain words)</h3>
        <p>
          A two-level atom has an excited state (level 2) with lifetime <span class="mono">τ₂</span> when no stimulated emission occurs.
          When an optical field is present, stimulated emission adds an extra decay channel so that the excited state decays faster.
          Find the photon flux density <span class="mono">φ</span> at which the <b>effective lifetime</b> becomes half its original value.
          Then relate that flux to the <b>saturation photon-flux density</b> <span class="mono">φₛ</span>.
        </p>

        <h3>Given</h3>
        <ul>
          <li><span class="mono">τ₂</span>: excited-state lifetime without stimulated emission.</li>
          <li>A stimulated-emission process characterized by photon flux density <span class="mono">φ</span> and cross section <span class="mono">σ</span>.</li>
        </ul>

        <h3>Unknowns</h3>
        <ul>
          <li>The flux <span class="mono">φ</span> such that <span class="mono">τ_eff(φ) = τ₂/2</span>.</li>
          <li>The relationship between that <span class="mono">φ</span> and <span class="mono">φₛ</span>.</li>
        </ul>

        <h3>Relevant physics (and why)</h3>
        <ul>
          <li><b>Population rate equation</b> for the excited state: appropriate because we are asked about <i>lifetimes</i> (population decay timescales).</li>
          <li><b>Stimulated emission rate proportional to photon flux</b>: <span class="mono">Γ_st = σφ</span>, the standard semiclassical result used in laser physics.</li>
          <li><b>Independent decay channels add rates</b>: spontaneous + stimulated contributions sum in <span class="mono">Γ_total</span>.</li>
        </ul>

        <div class="callouts">
          <div class="callout assump">
            <strong><span class="tag">Assumptions</span> What we assume</strong>
            <ul class="muted">
              <li>Two-level system with excited state 2 decaying to state 1.</li>
              <li>Stimulated emission adds a decay term <span class="mono">σφ</span> (on-resonance effective cross section, constant in time).</li>
              <li>No other non-radiative decay channels, or they are absorbed into <span class="mono">1/τ₂</span>.</li>
              <li>We track population decay (rate equations), not coherent Rabi oscillations.</li>
            </ul>
          </div>
        </div>

        <h3>Possible approaches (compare)</h3>
        <ul>
          <li><b>Rate-equation approach (best here):</b> Write <span class="mono">dN₂/dt</span> with spontaneous and stimulated terms. Fast, direct, and matches “lifetime” language.</li>
          <li><b>Einstein A/B coefficient approach:</b> Use <span class="mono">A</span> and <span class="mono">Bρ(ν)</span> with energy density. Equivalent but needs extra conversions from density to flux.</li>
          <li><b>Optical Bloch equations:</b> Most general, includes coherence and power broadening—overkill for this question.</li>
        </ul>
        <p class="muted">
          We choose the <b>rate-equation approach</b> because it expresses the lifetime change transparently as a competition between two decay rates.
        </p>
      </section>

      <section id="p2" class="card">
        <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

        <ol>
          <li><b>Goal:</b> model the excited-state decay with and without stimulation. <br><span class="muted">Tool:</span> define spontaneous rate <span class="mono">Γ_sp = 1/τ₂</span>. <br><span class="muted">Meaning:</span> baseline probability per time to leave level 2.</li>
          <li><b>Goal:</b> express stimulated emission as an additional decay channel. <br><span class="muted">Tool:</span> <span class="mono">Γ_st = σφ</span>. <br><span class="muted">Meaning:</span> more incident photons → higher chance to be “triggered” to emit.</li>
          <li><b>Goal:</b> combine channels into a single exponential decay. <br><span class="muted">Tool:</span> add rates: <span class="mono">Γ = Γ_sp + Γ_st</span>. <br><span class="muted">Meaning:</span> the fastest exit dominates, but both contribute.</li>
          <li><b>Goal:</b> define effective lifetime. <br><span class="muted">Tool:</span> <span class="mono">τ_eff = 1/Γ</span>. <br><span class="muted">Meaning:</span> time constant of population decay in the presence of the field.</li>
          <li><b>Goal:</b> impose the half-lifetime condition. <br><span class="muted">Tool:</span> set <span class="mono">τ_eff = τ₂/2</span> and solve for <span class="mono">φ</span>. <br><span class="muted">Meaning:</span> stimulated emission rate equals spontaneous rate at that point.</li>
          <li><b>Goal:</b> connect to saturation. <br><span class="muted">Tool:</span> identify <span class="mono">φₛ</span> as the characteristic flux where <span class="mono">σφ</span> matches <span class="mono">1/τ₂</span>.</li>
        </ol>

        <div class="callout pit">
          <strong><span class="tag">Common mistakes</span> Quick tips</strong>
          <ul class="muted">
            <li>Do <b>not</b> set <span class="mono">τ_eff = τ₂ + (…)</span>; lifetime is not additive. Rates are.</li>
            <li>Keep <span class="mono">σ</span> and <span class="mono">φ</span> in consistent area units: if <span class="mono">σ</span> is in cm², convert to m² before using SI flux.</li>
            <li>Remember: <span class="mono">φₛ</span> is a photon-flux density; <span class="mono">Iₛ</span> is an intensity. They differ by <span class="mono">hν</span>.</li>
          </ul>
        </div>
      </section>

      <section id="p3" class="card">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <h3>Physical intuition (before math)</h3>
        <p>
          If light can stimulate emission, then increasing photon flux should increase the probability per second that an excited atom emits.
          Since “lifetime” is essentially “how long until it decays,” adding stimulated emission must <i>shorten</i> the effective lifetime.
          The moment the stimulated emission rate equals the spontaneous decay rate, you would expect the total decay rate to double—so the lifetime should halve.
        </p>

        <h3>Step-by-step derivation</h3>

        <p><b>1) Define the baseline spontaneous decay rate.</b></p>
        <div class="equationBox" data-copy="eq1">
          <button class="copyBtn" data-copy-btn="eq1">Copy</button>
          <pre class="eq" id="eq1">Γ_sp = 1/τ₂   (units: s⁻¹)</pre>
          <div class="copyNote">This is the decay probability per unit time in the absence of stimulation.</div>
        </div>

        <p><b>2) Model stimulated emission as a rate proportional to photon flux density.</b></p>
        <p>
          Let <span class="mono">φ</span> be the photon flux density [m⁻² s⁻¹]. With stimulated-emission cross section <span class="mono">σ</span> [m²],
          the stimulated emission rate per excited atom is:
        </p>
        <div class="equationBox" data-copy="eq2">
          <button class="copyBtn" data-copy-btn="eq2">Copy</button>
          <pre class="eq" id="eq2">Γ_st = σ φ   (units: m² · m⁻² s⁻¹ = s⁻¹)</pre>
          <div class="copyNote">Dimensional check already suggests the model is consistent: σ converts flux into a rate.</div>
        </div>

        <p><b>3) Add independent decay rates to get the total decay rate.</b></p>
        <p>
          Spontaneous and stimulated emission are distinct channels out of level 2, so their rates add:
        </p>
        <div class="equationBox" data-copy="eq3">
          <button class="copyBtn" data-copy-btn="eq3">Copy</button>
          <pre class="eq" id="eq3">Γ_total = Γ_sp + Γ_st = (1/τ₂) + (σ φ)</pre>
        </div>

        <p><b>4) Write the population rate equation and identify the effective lifetime.</b></p>
        <p>
          Let <span class="mono">N₂(t)</span> be the population of level 2. The decay is exponential with time constant <span class="mono">τ_eff</span>:
        </p>
        <div class="equationBox" data-copy="eq4">
          <button class="copyBtn" data-copy-btn="eq4">Copy</button>
          <pre class="eq" id="eq4">dN₂/dt = − Γ_total N₂
⇒ N₂(t) = N₂(0) exp(−t/τ_eff)
with  τ_eff = 1/Γ_total = 1 / ( (1/τ₂) + σ φ )</pre>
        </div>
        <p class="muted">
          What we did: we translated “lifetime” into the exponential decay constant of the excited-state population.
        </p>

        <p><b>5) Impose the condition “lifetime halves” and solve for φ.</b></p>
        <p>
          We want <span class="mono">τ_eff = τ₂/2</span>. Substitute the formula for <span class="mono">τ_eff</span>:
        </p>
        <div class="equationBox" data-copy="eq5">
          <button class="copyBtn" data-copy-btn="eq5">Copy</button>
          <pre class="eq" id="eq5">τ_eff = 1 / ( (1/τ₂) + σ φ ) = τ₂/2</pre>
        </div>

        <p>Now solve carefully (no jumps):</p>
        <div class="equationBox" data-copy="eq6">
          <button class="copyBtn" data-copy-btn="eq6">Copy</button>
          <pre class="eq" id="eq6">1 / ( (1/τ₂) + σ φ ) = τ₂/2
⇒ (1/τ₂) + σ φ = 2/τ₂
⇒ σ φ = (2/τ₂) − (1/τ₂) = 1/τ₂
⇒ φ = 1 / (σ τ₂)</pre>
        </div>

        <div class="callout ans">
          <strong><span class="tag">Final answer</span> Half-lifetime photon flux density</strong>
          <div class="equationBox" style="margin:10px 0 6px" data-copy="ans1">
            <button class="copyBtn" data-copy-btn="ans1">Copy</button>
            <pre class="eq" id="ans1">φ_half = 1/(σ τ₂)</pre>
          </div>
          <p class="muted" style="margin:0">
            Interpretation: at <span class="mono">φ = 1/(σ τ₂)</span>, the stimulated emission rate equals the spontaneous decay rate, doubling the total decay rate and halving the lifetime.
          </p>
        </div>

        <h3>How is this related to the saturation photon-flux density φₛ?</h3>
        <p>
          A standard way to define the <b>saturation photon-flux density</b> is the flux where the stimulated transition rate matches the natural decay rate:
          <span class="mono">σ φₛ = 1/τ₂</span>. Solving gives:
        </p>

        <div class="equationBox" data-copy="eq7">
          <button class="copyBtn" data-copy-btn="eq7">Copy</button>
          <pre class="eq" id="eq7">Define saturation by:  σ φₛ ≡ 1/τ₂
⇒ φₛ = 1/(σ τ₂)</pre>
        </div>

        <div class="callout ans">
          <strong><span class="tag">Connection</span> Relationship to saturation</strong>
          <div class="equationBox" style="margin:10px 0 6px" data-copy="ans2">
            <button class="copyBtn" data-copy-btn="ans2">Copy</button>
            <pre class="eq" id="ans2">φ_half = φₛ</pre>
          </div>
          <p class="muted" style="margin:0">
            So, the photon-flux density at which the lifetime drops to half is <b>exactly the saturation photon-flux density</b> (under this common definition).
          </p>
        </div>

        <h3>Sanity checks</h3>
        <ul>
          <li><b>Units:</b> <span class="mono">σ τ₂</span> has units <span class="mono">m²·s</span>, so <span class="mono">1/(σ τ₂)</span> has units <span class="mono">m⁻² s⁻¹</span>, matching photon flux density.</li>
          <li><b>Limits:</b>
            <ul>
              <li>If <span class="mono">φ→0</span>, then <span class="mono">τ_eff → τ₂</span> (no stimulation).</li>
              <li>If <span class="mono">φ→∞</span>, then <span class="mono">τ_eff ≈ 1/(σφ) → 0</span> (very fast stimulated decay).</li>
            </ul>
          </li>
          <li><b>Physical meaning:</b> at <span class="mono">φ=φₛ</span>, stimulated and spontaneous decay are equally likely per unit time, so total decay probability per second doubles.</li>
        </ul>

        <p class="muted">
          Connection to the diagram/plots: the diagram shows the two decay channels. The main plot shows <span class="mono">τ_eff/τ₂</span> decreasing with normalized flux <span class="mono">φ/φₛ</span>, and it crosses 0.5 precisely at 1.
        </p>
      </section>

      <section id="p4" class="card">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpret the final formula</h3>
        <p>
          The formula <span class="mono">φₛ = 1/(σ τ₂)</span> has a clean “competition” interpretation:
        </p>
        <ul>
          <li><span class="mono">τ₂</span> sets the natural timescale: shorter natural lifetime (larger <span class="mono">1/τ₂</span>) requires higher flux to compete.</li>
          <li><span class="mono">σ</span> sets coupling strength: larger cross section means each photon is more effective, lowering the flux needed for saturation.</li>
          <li><span class="mono">φ</span> is the knob you turn experimentally (via intensity and beam area) to change stimulated emission rate.</li>
        </ul>

        <div class="callout eq">
          <strong><span class="tag">Key control parameter</span> The saturation parameter</strong>
          <p class="muted" style="margin:8px 0 0">
            Define a dimensionless saturation parameter <span class="mono">s ≡ φ/φₛ</span>. Then:
          </p>
          <div class="equationBox" data-copy="eq8" style="margin-top:10px">
            <button class="copyBtn" data-copy-btn="eq8">Copy</button>
            <pre class="eq" id="eq8">τ_eff/τ₂ = 1 / (1 + s)   where  s = φ/φₛ</pre>
          </div>
          <p class="muted" style="margin:0">
            This is why the main plot has a universal shape: once you normalize by <span class="mono">φₛ</span>, the curve no longer depends on the particular values of <span class="mono">σ</span> and <span class="mono">τ₂</span>.
          </p>
        </div>

        <h3>How changing parameters affects the outcome (connect to plots)</h3>
        <ul>
          <li>Increasing <span class="mono">σ</span> decreases <span class="mono">φₛ</span> (saturation happens at lower flux). In the plots, the “absolute flux” axis rescales, but the normalized curve stays the same.</li>
          <li>Increasing <span class="mono">τ₂</span> also decreases <span class="mono">φₛ</span> (a long-lived state is easier to stimulate because there is more time for photons to trigger emission).</li>
          <li>At fixed <span class="mono">φ</span>, raising <span class="mono">σ</span> or <span class="mono">τ₂</span> increases <span class="mono">σφ τ₂</span>, reducing <span class="mono">τ_eff</span>.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p>
          Using Einstein coefficients: total downward rate is <span class="mono">A₂₁ + B₂₁ ρ(ν)</span>.
          Converting energy density <span class="mono">ρ(ν)</span> (or intensity) to photon flux gives an equivalent expression
          where <span class="mono">σ</span> encapsulates the conversion from field density to transition rate. Setting the induced term equal to <span class="mono">A₂₁</span> again yields the saturation condition.
        </p>

        <h3>Concept checks (quick self-test)</h3>
        <ul>
          <li><b>Q:</b> If <span class="mono">σφ = 3/τ₂</span>, what is <span class="mono">τ_eff</span>? <br><b>A:</b> <span class="mono">Γ = 1/τ₂ + 3/τ₂ = 4/τ₂</span> so <span class="mono">τ_eff = τ₂/4</span>.</li>
          <li><b>Q:</b> Why do we add rates, not lifetimes? <br><b>A:</b> Independent decay channels are independent Poisson processes; probabilities per unit time add.</li>
          <li><b>Q:</b> How do you convert between intensity and photon flux? <br><b>A:</b> <span class="mono">I = (hν) φ</span> (energy per photon times photons per area per time).</li>
          <li><b>Q:</b> What happens to <span class="mono">φₛ</span> if <span class="mono">σ</span> doubles? <br><b>A:</b> <span class="mono">φₛ</span> halves.</li>
        </ul>
      </section>

      <section id="p5" class="card">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <p>
          Below are three canvases: (1) a labeled diagram of the two-level system, (2) the main quantitative plot of normalized lifetime vs normalized flux,
          and (3) a secondary plot showing the total decay rate and the half-lifetime point in an alternative view. Use the sliders to change
          <span class="mono">σ</span> and <span class="mono">τ₂</span>; all visuals update live.
        </p>

        <div class="vizPanel" aria-label="Interactive visualizations">
          <div class="vizHeader">
            <div class="title"><b>Interactive Visualization:</b> stimulated emission shortens lifetime</div>
            <div class="controls">
              <div class="control">
                <label for="sigma">σ (cross section)</label>
                <input id="sigma" type="range" min="0" max="1000" value="300" />
                <div class="val" id="sigmaVal"></div>
              </div>
              <div class="control">
                <label for="tau">τ₂ (lifetime)</label>
                <input id="tau" type="range" min="1" max="200" value="10" />
                <div class="val" id="tauVal"></div>
              </div>
              <div class="control">
                <label for="mode">Flux scale</label>
                <select id="mode">
                  <option value="norm" selected>Normalized (φ/φₛ)</option>
                  <option value="abs">Absolute φ (m⁻² s⁻¹)</option>
                </select>
              </div>
            </div>
          </div>

          <div class="vizGrid">
            <div>
              <canvas id="cDiag" class="big" aria-label="Diagram canvas"></canvas>
            </div>
            <div>
              <canvas id="cMain" class="small" aria-label="Main plot canvas"></canvas>
            </div>
            <div style="grid-column:1 / -1">
              <canvas id="cSec" class="big" aria-label="Secondary plot canvas"></canvas>
            </div>
          </div>
        </div>

        <h3>What each canvas shows</h3>
        <ul>
          <li><b>Diagram (left/top):</b> A two-level atom with decay 2 → 1 by spontaneous emission and by stimulated emission driven by photon flux <span class="mono">φ</span>.</li>
          <li><b>Main plot:</b> <span class="mono">τ_eff/τ₂</span> versus either <span class="mono">φ/φₛ</span> (normalized) or absolute <span class="mono">φ</span>. The curve crosses 0.5 at the half-lifetime point.</li>
          <li><b>Secondary plot:</b> total decay rate <span class="mono">Γ_total</span> compared to spontaneous rate <span class="mono">1/τ₂</span>. At <span class="mono">φ=φₛ</span>, <span class="mono">Γ_total</span> is exactly doubled.</li>
        </ul>

        <h3>How the controls work</h3>
        <ul>
          <li><b>σ slider:</b> changes the stimulated coupling strength. Larger <span class="mono">σ</span> lowers <span class="mono">φₛ = 1/(σ τ₂)</span> and makes saturation occur at lower absolute flux.</li>
          <li><b>τ₂ slider:</b> changes the natural lifetime. Larger <span class="mono">τ₂</span> also lowers <span class="mono">φₛ</span>.</li>
          <li><b>Flux scale selector:</b> switches the horizontal axis between normalized and absolute flux. Normalized makes the curve “universal.” Absolute shows how <span class="mono">φₛ</span> shifts with parameters.</li>
        </ul>

        <div class="callout assump">
          <strong><span class="tag">Example values</span> Used for plotting only</strong>
          <p class="muted" style="margin:8px 0 0">
            The sliders set example values (default: <span class="mono">σ = 3.0×10⁻²⁰ m²</span>, <span class="mono">τ₂ = 10 ns</span>). The symbolic results above remain general.
          </p>
        </div>
      </section>

      <footer class="footer">
        Built as a self-contained learning article (vanilla HTML/CSS/JS). Copy buttons copy plain-text equations.
      </footer>
    </main>
  </div>

  <script>
    // ---------- utilities ----------
    const clamp = (x,a,b)=>Math.max(a,Math.min(b,x));
    function fmtSci(x, sig=3){
      if (!isFinite(x) || x===0) return (x===0 ? "0" : "—");
      const exp = Math.floor(Math.log10(Math.abs(x)));
      const m = x / Math.pow(10, exp);
      const mm = Number(m.toFixed(sig-1));
      return `${mm}×10^${exp}`;
    }
    function fmtSISeconds(s){
      // for τ2 slider (ns range mostly)
      if (s < 1e-6) return `${(s*1e9).toFixed(2)} ns`;
      if (s < 1e-3) return `${(s*1e6).toFixed(2)} µs`;
      if (s < 1) return `${(s*1e3).toFixed(2)} ms`;
      return `${s.toFixed(3)} s`;
    }
    function copyText(txt){
      navigator.clipboard?.writeText(txt).then(()=>{
        // subtle feedback
      }).catch(()=>{});
    }

    // Copy buttons for equations/final answers
    document.querySelectorAll("[data-copy-btn]").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-copy-btn");
        const el = document.getElementById(id);
        if (el) copyText(el.textContent.trim());
        btn.textContent = "Copied";
        setTimeout(()=>btn.textContent="Copy", 900);
      });
    });

    // Smooth scroll for TOC links
    document.querySelectorAll('nav.toc a[href^="#"]').forEach(a=>{
      a.addEventListener("click", (e)=>{
        e.preventDefault();
        const target = document.querySelector(a.getAttribute("href"));
        if(target) target.scrollIntoView({behavior:"smooth", block:"start"});
      });
    });

    // ---------- parameters ----------
    const elSigma = document.getElementById("sigma");
    const elTau = document.getElementById("tau");
    const elMode = document.getElementById("mode");
    const elSigmaVal = document.getElementById("sigmaVal");
    const elTauVal = document.getElementById("tauVal");

    // Map slider to physical values
    // sigma slider: 0..1000 -> (0.5..8.0)×10^-20 m^2 (log-ish but simple curve)
    function sigmaFromSlider(v){
      const t = v/1000;
      const sMin = 0.5e-20, sMax = 8.0e-20;
      // smooth nonlinear mapping for nicer control
      const k = t*t*(3-2*t); // smoothstep
      return sMin + (sMax - sMin)*k;
    }
    // tau slider: 1..200 ns linearly
    function tauFromSlider(v){
      return v * 1e-9;
    }

    // ---------- canvases + DPR handling ----------
    function setupCanvas(canvas){
      const ctx = canvas.getContext("2d");
      function resize(){
        const dpr = window.devicePixelRatio || 1;
        const rect = canvas.getBoundingClientRect();
        const w = Math.max(1, Math.floor(rect.width * dpr));
        const h = Math.max(1, Math.floor(rect.height * dpr));
        if (canvas.width !== w || canvas.height !== h){
          canvas.width = w; canvas.height = h;
        }
        return {ctx, dpr, w, h};
      }
      return {canvas, ctx, resize};
    }

    const cDiag = setupCanvas(document.getElementById("cDiag"));
    const cMain = setupCanvas(document.getElementById("cMain"));
    const cSec  = setupCanvas(document.getElementById("cSec"));

    const ro = new ResizeObserver(()=>renderAll());
    [cDiag.canvas,cMain.canvas,cSec.canvas].forEach(cv=>ro.observe(cv));

    // ---------- plotting helpers ----------
    function drawFrame(ctx, w, h, title){
      ctx.save();
      ctx.clearRect(0,0,w,h);

      // Title
      ctx.fillStyle = "rgba(231,238,252,.95)";
      ctx.font = `${Math.max(13, Math.floor(h*0.045))}px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto`;
      ctx.textBaseline = "top";
      ctx.fillText(title, 14, 12);

      // subtle border
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;
      ctx.strokeRect(0.5,0.5,w-1,h-1);
      ctx.restore();
    }

    function plotAxes(ctx, box, xLabel, yLabel, xTicks, yTicks){
      const {x0,y0,x1,y1} = box;
      ctx.save();

      // gridlines
      ctx.strokeStyle = "rgba(255,255,255,.10)";
      ctx.lineWidth = 1;

      for (const t of xTicks){
        const x = t.px;
        ctx.beginPath(); ctx.moveTo(x,y0); ctx.lineTo(x,y1); ctx.stroke();
      }
      for (const t of yTicks){
        const y = t.px;
        ctx.beginPath(); ctx.moveTo(x0,y); ctx.lineTo(x1,y); ctx.stroke();
      }

      // axes
      ctx.strokeStyle = "rgba(255,255,255,.35)";
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(x0,y1); ctx.lineTo(x1,y1);
      ctx.moveTo(x0,y0); ctx.lineTo(x0,y1);
      ctx.stroke();

      // ticks + labels
      ctx.fillStyle = "rgba(169,183,211,.95)";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
      ctx.textBaseline = "top";

      for (const t of xTicks){
        ctx.strokeStyle = "rgba(255,255,255,.35)";
        ctx.beginPath();
        ctx.moveTo(t.px, y1); ctx.lineTo(t.px, y1+5);
        ctx.stroke();
        ctx.fillText(t.label, t.px-10, y1+7);
      }
      ctx.textBaseline = "middle";
      for (const t of yTicks){
        ctx.strokeStyle = "rgba(255,255,255,.35)";
        ctx.beginPath();
        ctx.moveTo(x0-5, t.px); ctx.lineTo(x0, t.px);
        ctx.stroke();
        ctx.fillText(t.label, x0-40, t.px);
      }

      // axis labels
      ctx.fillStyle = "rgba(231,238,252,.90)";
      ctx.textBaseline = "bottom";
      ctx.fillText(xLabel, (x0+x1)/2 - ctx.measureText(xLabel).width/2, y1 + 42);

      // y label rotated
      ctx.save();
      ctx.translate(x0 - 60, (y0+y1)/2);
      ctx.rotate(-Math.PI/2);
      ctx.textBaseline = "top";
      ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
      ctx.restore();

      ctx.restore();
    }

    function linePath(ctx, xs, ys, mapX, mapY){
      ctx.beginPath();
      for (let i=0;i<xs.length;i++){
        const x = mapX(xs[i]);
        const y = mapY(ys[i]);
        if (i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
    }

    function drawLegend(ctx, items, x, y){
      ctx.save();
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
      let yy = y;
      for (const it of items){
        ctx.strokeStyle = it.color;
        ctx.lineWidth = 3;
        ctx.beginPath(); ctx.moveTo(x, yy+6); ctx.lineTo(x+16, yy+6); ctx.stroke();
        ctx.fillStyle = "rgba(231,238,252,.92)";
        ctx.fillText(it.text, x+22, yy);
        yy += 18;
      }
      ctx.restore();
    }

    // ---------- renderers ----------
    function renderDiagram(params){
      const {ctx,w,h} = cDiag.resize();

      drawFrame(ctx,w,h,"Diagram — Two-level atom with spontaneous + stimulated emission");

      const pad = 18;
      const xL = pad, xR = w-pad, yT = 56, yB = h-pad;

      // Atom block
      const ax0 = xL + 10, ax1 = xL + 180;
      const ay0 = yT + 10, ay1 = yB - 12;

      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,.20)";
      ctx.lineWidth = 1.2;
      ctx.fillStyle = "rgba(0,0,0,.16)";
      roundRect(ctx, ax0, ay0, ax1-ax0, ay1-ay0, 16, true, true);

      // Levels
      const y2 = ay0 + (ay1-ay0)*0.30;
      const y1 = ay0 + (ay1-ay0)*0.70;

      ctx.strokeStyle = "rgba(125,211,252,.85)";
      ctx.lineWidth = 3;
      ctx.beginPath(); ctx.moveTo(ax0+22, y2); ctx.lineTo(ax1-22, y2); ctx.stroke();

      ctx.strokeStyle = "rgba(167,139,250,.85)";
      ctx.beginPath(); ctx.moveTo(ax0+22, y1); ctx.lineTo(ax1-22, y1); ctx.stroke();

      // Labels
      ctx.fillStyle = "rgba(231,238,252,.95)";
      ctx.font = "13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText("Level 2 (excited)", ax0+22, y2-28);
      ctx.fillText("Level 1 (ground)", ax0+22, y1+10);

      // Decay arrows
      const xMid = (ax0+ax1)/2;
      // spontaneous arrow
      arrow(ctx, xMid-40, y2+6, xMid-40, y1-6, "rgba(52,211,153,.9)");
      ctx.fillStyle = "rgba(231,238,252,.90)";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText("spontaneous", xMid-90, (y1+y2)/2 - 8);
      ctx.fillStyle = "rgba(169,183,211,.90)";
      ctx.fillText("rate = 1/τ₂", xMid-95, (y1+y2)/2 + 8);

      // stimulated arrow
      arrow(ctx, xMid+40, y2+6, xMid+40, y1-6, "rgba(251,191,36,.95)");
      ctx.fillStyle = "rgba(231,238,252,.90)";
      ctx.fillText("stimulated", xMid+10, (y1+y2)/2 - 8);
      ctx.fillStyle = "rgba(169,183,211,.90)";
      ctx.fillText("rate = σφ", xMid+10, (y1+y2)/2 + 8);

      // External photon flux beam from right
      const beamX0 = ax1 + 40, beamX1 = xR - 18;
      const beamY = (y1+y2)/2;
      ctx.strokeStyle = "rgba(125,211,252,.55)";
      ctx.lineWidth = 10;
      ctx.lineCap = "round";
      ctx.beginPath(); ctx.moveTo(beamX1, beamY); ctx.lineTo(beamX0, beamY); ctx.stroke();

      // beam arrows
      for(let i=0;i<4;i++){
        const xx = beamX0 + (beamX1-beamX0)*(0.2 + i*0.18);
        arrow(ctx, xx, beamY, xx-30, beamY, "rgba(125,211,252,.9)", 2.5, 10);
      }
      ctx.fillStyle = "rgba(231,238,252,.92)";
      ctx.font = "13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
      ctx.fillText("Incident photon flux density  φ  (photons m⁻² s⁻¹)", beamX0-10, beamY-34);

      // Key formula
      const boxW = Math.min(520, xR - ax1 - 34);
      const boxX = ax1 + 18;
      const boxY = yT + 12;
      ctx.fillStyle = "rgba(125,211,252,.06)";
      ctx.strokeStyle = "rgba(125,211,252,.22)";
      ctx.lineWidth = 1.2;
      roundRect(ctx, boxX, boxY, boxW, 64, 14, true, true);
      ctx.fillStyle = "rgba(231,238,252,.95)";
      ctx.font = `12px ${getComputedStyle(document.body).fontFamily}`;
      const t1 = "Total decay rate: Γ = 1/τ₂ + σφ";
      const t2 = "Effective lifetime: τ_eff = 1/Γ";
      ctx.fillText(t1, boxX+12, boxY+14);
      ctx.fillText(t2, boxX+12, boxY+34);

      // Parameter readout
      const {sigma, tau2, phiS} = params;
      ctx.fillStyle = "rgba(169,183,211,.92)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
      ctx.fillText(`σ = ${fmtSci(sigma,3)} m²`, ax0+22, ay1-36);
      ctx.fillText(`τ₂ = ${fmtSISeconds(tau2)}`, ax0+22, ay1-20);
      ctx.fillText(`φₛ = 1/(σ τ₂) = ${fmtSci(phiS,3)} m⁻² s⁻¹`, ax0+22, ay1-4);

      ctx.restore();
    }

    function renderMainPlot(params){
      const {ctx,w,h} = cMain.resize();
      const mode = params.mode;

      drawFrame(ctx,w,h,"Main plot — Effective lifetime vs photon flux");

      const padL=70, padR=18, padT=54, padB=62;
      const x0=padL, x1=w-padR, y0=padT, y1=h-padB;

      // Data
      const N=250;
      const xs=[], ys=[];
      let xMax, xLabel;

      if (mode==="norm"){
        xMax = 6;
        xLabel = "Normalized flux  φ/φₛ  (dimensionless)";
        for(let i=0;i<N;i++){
          const x = xMax*i/(N-1);
          const s = x; // s = phi/phiS
          const y = 1/(1+s); // tau_eff/tau2
          xs.push(x); ys.push(y);
        }
      }else{
        // Absolute: show up to 6*phiS for context
        xMax = 6*params.phiS;
        xLabel = "Photon flux density  φ  (m⁻² s⁻¹)";
        for(let i=0;i<N;i++){
          const phi = xMax*i/(N-1);
          const y = 1/(1 + params.sigma*phi*params.tau2);
          xs.push(phi); ys.push(y);
        }
      }

      // Axis mapping
      const yMin=0, yMax=1.02;
      const mapX = (x)=> x0 + (x - 0)/(xMax - 0)*(x1-x0);
      const mapY = (y)=> y1 - (y - yMin)/(yMax-yMin)*(y1-y0);

      // Ticks
      const xTicks=[];
      const xTickCount=6;
      for(let i=0;i<=xTickCount;i++){
        const xv = (xMax*i/xTickCount);
        xTicks.push({px:mapX(xv), label: mode==="norm" ? xv.toFixed(0) : fmtSci(xv,2)});
      }
      const yTicks=[];
      for(let i=0;i<=5;i++){
        const yv=i/5;
        yTicks.push({px:mapY(yv), label: yv.toFixed(1)});
      }

      plotAxes(ctx,{x0,y0,x1,y1}, xLabel, "Normalized lifetime  τ_eff/τ₂", xTicks, yTicks);

      // Curve
      ctx.save();
      ctx.strokeStyle = "rgba(125,211,252,.95)";
      ctx.lineWidth = 3;
      ctx.lineCap = "round";
      linePath(ctx, xs, ys, mapX, mapY);
      ctx.restore();

      // Mark half-lifetime point
      const xHalf = (mode==="norm") ? 1 : params.phiS;
      const yHalf = 0.5;
      ctx.save();
      ctx.fillStyle = "rgba(167,139,250,.95)";
      ctx.strokeStyle = "rgba(167,139,250,.95)";
      ctx.lineWidth = 2;

      // dashed guides
      ctx.setLineDash([6,6]);
      ctx.beginPath(); ctx.moveTo(mapX(xHalf), y1); ctx.lineTo(mapX(xHalf), mapY(yHalf)); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(x0, mapY(yHalf)); ctx.lineTo(mapX(xHalf), mapY(yHalf)); ctx.stroke();
      ctx.setLineDash([]);

      // point
      ctx.beginPath();
      ctx.arc(mapX(xHalf), mapY(yHalf), 5.5, 0, Math.PI*2);
      ctx.fill();

      // label
      ctx.fillStyle = "rgba(231,238,252,.95)";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
      const lbl = (mode==="norm") ? "Half-lifetime at φ/φₛ = 1" : "Half-lifetime at φ = φₛ";
      ctx.fillText(lbl, mapX(xHalf)-110, mapY(yHalf)-16);

      drawLegend(ctx, [
        {color:"rgba(125,211,252,.95)", text:"τ_eff/τ₂ = 1/(1 + σφτ₂)"},
        {color:"rgba(167,139,250,.95)", text:"τ_eff/τ₂ = 0.5 point"}
      ], x0+10, y0+8);

      ctx.restore();
    }

    function renderSecondaryPlot(params){
      const {ctx,w,h} = cSec.resize();
      const mode = params.mode;

      drawFrame(ctx,w,h,"Secondary plot — Total decay rate Γ_total and the saturation condition");

      const padL=80, padR=18, padT=54, padB=62;
      const x0=padL, x1=w-padR, y0=padT, y1=h-padB;

      // We plot normalized decay rate: Γ_total / Γ_sp = 1 + σφτ2 = 1 + φ/φs
      const N=240;
      const xs=[], y1s=[], y2s=[];
      let xMax, xLabel;
      if (mode==="norm"){
        xMax = 6;
        xLabel = "Normalized flux  φ/φₛ  (dimensionless)";
        for(let i=0;i<N;i++){
          const s = xMax*i/(N-1);
          xs.push(s);
          y1s.push(1 + s);     // normalized total decay rate
          y2s.push(1);         // spontaneous baseline
        }
      }else{
        xMax = 6*params.phiS;
        xLabel = "Photon flux density  φ  (m⁻² s⁻¹)";
        for(let i=0;i<N;i++){
          const phi = xMax*i/(N-1);
          xs.push(phi);
          y1s.push(1 + params.sigma*phi*params.tau2);
          y2s.push(1);
        }
      }

      const yMin=0, yMax=1 + 6; // up to 7
      const mapX = (x)=> x0 + (x - 0)/(xMax - 0)*(x1-x0);
      const mapY = (y)=> y1 - (y - yMin)/(yMax-yMin)*(y1-y0);

      // ticks
      const xTicks=[];
      const xTickCount=6;
      for(let i=0;i<=xTickCount;i++){
        const xv = xMax*i/xTickCount;
        xTicks.push({px:mapX(xv), label: mode==="norm" ? xv.toFixed(0) : fmtSci(xv,2)});
      }
      const yTicks=[];
      for(let i=0;i<=7;i++){
        const yv=i;
        yTicks.push({px:mapY(yv), label: yv.toFixed(0)});
      }

      plotAxes(ctx,{x0,y0,x1,y1}, xLabel, "Normalized rate  Γ_total / Γ_sp", xTicks, yTicks);

      // baseline Γ_sp
      ctx.save();
      ctx.strokeStyle = "rgba(52,211,153,.9)";
      ctx.lineWidth = 2.5;
      ctx.setLineDash([8,6]);
      linePath(ctx, xs, y2s, mapX, mapY);
      ctx.setLineDash([]);

      // total
      ctx.strokeStyle = "rgba(251,191,36,.95)";
      ctx.lineWidth = 3;
      linePath(ctx, xs, y1s, mapX, mapY);

      // saturation point at φ=φs -> normalized rate = 2
      const xSat = (mode==="norm") ? 1 : params.phiS;
      const ySat = 2;

      ctx.fillStyle = "rgba(167,139,250,.95)";
      ctx.beginPath(); ctx.arc(mapX(xSat), mapY(ySat), 6, 0, Math.PI*2); ctx.fill();

      // annotations
      ctx.fillStyle = "rgba(231,238,252,.95)";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto";
      const sLbl = (mode==="norm") ? "At φ/φₛ=1: Γ_total/Γ_sp=2" : "At φ=φₛ: Γ_total/Γ_sp=2";
      ctx.fillText(sLbl, mapX(xSat)+10, mapY(ySat)-12);

      // guide line
      ctx.strokeStyle = "rgba(167,139,250,.6)";
      ctx.lineWidth = 2;
      ctx.setLineDash([6,6]);
      ctx.beginPath(); ctx.moveTo(mapX(xSat), y1); ctx.lineTo(mapX(xSat), mapY(ySat)); ctx.stroke();
      ctx.setLineDash([]);

      // legend + note
      drawLegend(ctx, [
        {color:"rgba(251,191,36,.95)", text:"Γ_total/Γ_sp = 1 + σφτ₂"},
        {color:"rgba(52,211,153,.9)",  text:"baseline Γ_sp (normalized = 1)"},
        {color:"rgba(167,139,250,.95)", text:"saturation point (φ=φₛ)"}
      ], x0+10, y0+8);

      // bottom caption: show computed phi_s
      ctx.fillStyle = "rgba(169,183,211,.92)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
      const cap = `φₛ = 1/(σ τ₂) = ${fmtSci(params.phiS,3)} m⁻² s⁻¹   |   Γ_sp = 1/τ₂ = ${fmtSci(1/params.tau2,3)} s⁻¹`;
      ctx.fillText(cap, x0, h-26);

      ctx.restore();
    }

    // ---------- drawing primitives ----------
    function roundRect(ctx, x, y, w, h, r, fill, stroke){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
      if (fill) ctx.fill();
      if (stroke) ctx.stroke();
    }
    function arrow(ctx, x0, y0, x1, y1, color, lw=3, head=12){
      ctx.save();
      ctx.strokeStyle = color;
      ctx.fillStyle = color;
      ctx.lineWidth = lw;
      ctx.lineCap = "round";
      ctx.beginPath(); ctx.moveTo(x0,y0); ctx.lineTo(x1,y1); ctx.stroke();

      const dx = x1-x0, dy = y1-y0;
      const ang = Math.atan2(dy,dx);
      const hx = x1 - head*Math.cos(ang);
      const hy = y1 - head*Math.sin(ang);

      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(hx + (head*0.55)*Math.cos(ang+Math.PI/2), hy + (head*0.55)*Math.sin(ang+Math.PI/2));
      ctx.lineTo(hx + (head*0.55)*Math.cos(ang-Math.PI/2), hy + (head*0.55)*Math.sin(ang-Math.PI/2));
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }

    // ---------- main render loop ----------
    function getParams(){
      const sigma = sigmaFromSlider(Number(elSigma.value));
      const tau2 = tauFromSlider(Number(elTau.value));
      const phiS = 1/(sigma*tau2);
      const mode = elMode.value;
      return {sigma, tau2, phiS, mode};
    }

    function renderAll(){
      const p = getParams();

      elSigmaVal.textContent = `${fmtSci(p.sigma,3)} m²`;
      elTauVal.textContent = fmtSISeconds(p.tau2);

      renderDiagram(p);
      renderMainPlot(p);
      renderSecondaryPlot(p);
    }

    // initial + interactions
    [elSigma, elTau, elMode].forEach(el=>{
      el.addEventListener("input", renderAll);
      el.addEventListener("change", renderAll);
    });

    // crisp initial render
    window.addEventListener("load", renderAll);
    window.addEventListener("resize", ()=>renderAll());
  </script>
</body>
</html>
