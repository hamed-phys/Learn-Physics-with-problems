<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Dielectric Media Classification: Linearity, Temporal & Spatial Dispersion, Homogeneity</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --panel2:#0f1730;
      --text:#e8eefc;
      --muted:#b9c4e6;
      --accent:#6ee7ff;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    *{box-sizing:border-box}
    body{
      margin:0;
      background: radial-gradient(900px 500px at 15% 10%, rgba(110,231,255,.12), transparent 60%),
                  radial-gradient(900px 500px at 85% 15%, rgba(167,139,250,.10), transparent 60%),
                  var(--bg);
      color:var(--text);
      font-family:var(--sans);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding: 28px 18px 18px;
      max-width: 1200px;
      margin: 0 auto;
    }
    .hero{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .hero{grid-template-columns:1fr}
    }
    .titleCard{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px 18px 14px;
      position:relative;
      overflow:hidden;
    }
    .titleCard:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(600px 200px at 30% 0%, rgba(110,231,255,.18), transparent 60%),
                  radial-gradient(500px 240px at 90% 20%, rgba(167,139,250,.14), transparent 60%);
      pointer-events:none;
      filter: blur(0.2px);
    }
    .titleCard > *{position:relative}
    h1{
      margin:0 0 8px;
      font-size: clamp(22px, 2.4vw, 34px);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: 14.5px;
      max-width: 72ch;
    }
    .quick{
      margin-top: 12px;
      padding: 12px 12px;
      border-radius: 14px;
      border:1px dashed rgba(110,231,255,.35);
      background: rgba(110,231,255,.06);
    }
    .quick h2{
      font-size: 15px;
      margin:0 0 8px;
      letter-spacing:.2px;
    }
    .quick ul{margin:0; padding-left: 18px; color: var(--text)}
    .quick li{margin: 6px 0}
    .tocCard{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px;
      position: sticky;
      top: 10px;
      align-self:start;
      max-height: calc(100vh - 24px);
      overflow:auto;
    }
    .tocCard h2{
      margin:0 0 10px;
      font-size: 14px;
      color: var(--muted);
      letter-spacing:.14em;
      text-transform: uppercase;
    }
    .tocCard nav a{
      display:block;
      padding: 8px 10px;
      margin: 4px 0;
      border-radius: 12px;
      border:1px solid transparent;
      color: var(--text);
      background: rgba(255,255,255,.02);
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-size: 14px;
    }
    .tocCard nav a:hover{
      background: rgba(110,231,255,.07);
      border-color: rgba(110,231,255,.20);
      transform: translateY(-1px);
      text-decoration:none;
    }

    main{
      max-width: 1200px;
      margin: 0 auto;
      padding: 0 18px 40px;
    }

    section{
      margin-top: 18px;
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: 0 10px 30px rgba(0,0,0,.22);
      overflow:hidden;
    }
    section > header{
      padding: 14px 16px 10px;
      border-bottom: 1px solid var(--line);
      margin:0;
      max-width:none;
    }
    section > header h2{
      margin:0;
      font-size: 18px;
      letter-spacing:.2px;
    }
    .content{
      padding: 14px 16px 16px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .grid2{grid-template-columns:1fr}
    }

    .card{
      background: rgba(0,0,0,.12);
      border:1px solid rgba(255,255,255,.08);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .callout{
      border-left: 4px solid var(--accent);
      background: rgba(110,231,255,.06);
    }

    .eqRow{
      display:flex;
      gap:10px;
      align-items:flex-start;
      flex-wrap:wrap;
    }
    .eq{
      font-family: var(--mono);
      background: rgba(255,255,255,.04);
      border: 1px solid rgba(255,255,255,.10);
      padding: 10px 10px;
      border-radius: 12px;
      display:block;
      width: 100%;
      overflow:auto;
      white-space: pre;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.05);
      color: var(--text);
      border-radius: 12px;
      padding: 8px 10px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      font-size: 13px;
    }
    .btn:hover{
      background: rgba(110,231,255,.08);
      border-color: rgba(110,231,255,.28);
      transform: translateY(-1px);
    }
    .btn:active{transform: translateY(0px) scale(.99)}
    .btn.small{padding: 6px 9px; font-size: 12.5px}
    .btn.primary{
      border-color: rgba(110,231,255,.35);
      background: rgba(110,231,255,.08);
    }

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      align-items:end;
    }
    @media (max-width: 980px){
      .controls{grid-template-columns:1fr}
    }
    label{
      display:block;
      font-size: 12.5px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    select, input[type="range"], input[type="number"]{
      width: 100%;
      padding: 9px 10px;
      border-radius: 12px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.22);
      color: var(--text);
      outline:none;
    }
    input[type="range"]{padding: 10px 0}
    .mini{
      font-size: 12.5px;
      color: var(--muted);
      margin-top: 6px;
    }

    table{
      width: 100%;
      border-collapse: collapse;
      overflow:hidden;
      border-radius: 14px;
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.12);
    }
    th, td{
      padding: 10px 10px;
      border-bottom: 1px solid rgba(255,255,255,.10);
      vertical-align: top;
      font-size: 14px;
    }
    th{
      text-align:left;
      color: var(--muted);
      font-weight: 650;
      background: rgba(255,255,255,.04);
    }
    tr:last-child td{border-bottom:none}
    .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding: 4px 10px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.04);
      font-size: 12.5px;
      margin: 2px 6px 2px 0;
      white-space:nowrap;
    }
    .dot{width:8px; height:8px; border-radius:50%}
    .dot.good{background: var(--good)}
    .dot.warn{background: var(--warn)}
    .dot.bad{background: var(--bad)}
    .mono{font-family:var(--mono)}
    .box{
      border:1px solid rgba(110,231,255,.28);
      background: rgba(110,231,255,.06);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .boxedAnswer{
      border:1px solid rgba(52,211,153,.35);
      background: rgba(52,211,153,.07);
      border-radius: 16px;
      padding: 12px 12px;
    }
    .boxedAnswer h3{margin: 0 0 8px}
    .hr{
      height:1px;
      background: rgba(255,255,255,.10);
      margin: 12px 0;
    }

    figure{
      margin:0;
      padding: 12px 12px 12px;
    }
    figcaption{
      margin-top: 10px;
      color: var(--muted);
      font-size: 13px;
    }
    canvas{
      width:100%;
      height: 320px;
      display:block;
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      border:1px solid rgba(255,255,255,.10);
    }
    .canvasGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
    }
    @media (max-width: 980px){
      .canvasGrid{grid-template-columns:1fr}
      canvas{height: 300px}
    }

    footer{
      max-width: 1200px;
      margin: 0 auto;
      padding: 16px 18px 34px;
      color: var(--muted);
      font-size: 13px;
    }

    /* subtle animation */
    @keyframes floatIn{
      from{opacity:0; transform: translateY(6px)}
      to{opacity:1; transform: translateY(0)}
    }
    section{animation: floatIn .35s ease both}

    /* print-friendly */
    @media print{
      :root{--bg:#fff; --text:#111; --muted:#333; --panel:#fff; --panel2:#fff}
      body{background:#fff}
      .tocCard{display:none}
      .titleCard, section{box-shadow:none}
      canvas{border:1px solid #ccc}
      a{color:#111; text-decoration:underline}
      .btn{display:none}
    }
  </style>
</head>
<body>
<header>
  <div class="hero">
    <div class="titleCard">
      <h1>5.2-1 Dielectric Media: classify constitutive laws</h1>
      <p class="subtitle">
        We are given four polarization relations <span class="mono">P(E)</span> and must classify each medium by
        <strong>linearity</strong>, <strong>temporal dispersiveness</strong> (memory), <strong>spatial dispersiveness</strong> (nonlocality),
        and <strong>homogeneity</strong>. Media are assumed <strong>isotropic</strong>.
      </p>
      <div class="quick">
        <h2>Quick Summary</h2>
        <ul>
          <li><strong>(a)</strong> Linear, <em>not</em> temporally dispersive, <strong>spatially dispersive</strong>, homogeneous.</li>
          <li><strong>(b)</strong> <strong>Nonlinear</strong> (quadratic), nondispersive (time &amp; space), homogeneous.</li>
          <li><strong>(c)</strong> Linear, <strong>temporally dispersive</strong> (differential equation in time), not spatially dispersive, homogeneous.</li>
          <li><strong>(d)</strong> Linear, nondispersive (time &amp; space), <strong>inhomogeneous</strong> (position-dependent coefficient).</li>
        </ul>
      </div>
    </div>

    <aside class="tocCard" aria-label="Table of Contents">
      <h2>Contents</h2>
      <nav>
        <a href="#interactive">Interactive Visuals</a>
        <a href="#part1">PART 1 — Problem Analysis</a>
        <a href="#part2">PART 2 — Strategy & Tips</a>
        <a href="#part3">PART 3 — Full Solution</a>
        <a href="#final">Final Classification Table</a>
        <a href="#checks">Sanity Checks</a>
      </nav>
    </aside>
  </div>
</header>

<main>
  <section id="interactive">
    <header><h2>Interactive Visualizations</h2></header>
    <div class="content">
      <div class="card callout">
        <div class="controls" role="group" aria-label="Interactive controls">
          <div>
            <label for="caseSelect">Choose constitutive law</label>
            <select id="caseSelect">
              <option value="a">(a)  P = ε0 χ E − a ∇×E</option>
              <option value="b">(b)  P + a P² = ε0 χ E</option>
              <option value="c">(c)  a1 ∂²P/∂t² + a2 ∂P/∂t + P = ε0 χ E</option>
              <option value="d">(d)  P = ε0{a1 + a2 exp[−(x²+y²)]} E</option>
            </select>
            <div class="mini" id="caseHint">Tip: change parameters below and watch all plots update live.</div>
          </div>
          <div>
            <label for="paramSlider">Parameter slider</label>
            <input id="paramSlider" type="range" min="0" max="1" step="0.001" value="0.35" />
            <div class="mini" id="paramLabel">—</div>
          </div>
          <div>
            <label for="chiInput">χ (dimensionless) &amp; example drive</label>
            <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
              <input id="chiInput" type="number" step="0.1" value="2.0" />
              <input id="driveInput" type="number" step="0.1" value="1.0" />
            </div>
            <div class="mini">Example values used for plotting only (final answers stay symbolic).</div>
          </div>
        </div>
      </div>

      <div class="canvasGrid" style="margin-top:12px;">
        <figure class="card">
          <canvas id="diagramCanvas" aria-label="Diagram canvas"></canvas>
          <figcaption>
            <strong>Diagram.</strong> Conceptual picture of how <span class="mono">E</span> produces <span class="mono">P</span>.
            Different cases add nonlinearity, time-memory, spatial nonlocality, or spatially varying coefficients.
          </figcaption>
        </figure>

        <figure class="card">
          <canvas id="mainPlot" aria-label="Main quantitative plot"></canvas>
          <figcaption>
            <strong>Main plot.</strong> A key quantitative relationship for the selected medium (e.g., <span class="mono">P(E)</span>,
            <span class="mono">|χ(ω)|</span>, <span class="mono">|P|/|E|</span> vs <span class="mono">k</span>, or spatial profile).
          </figcaption>
        </figure>

        <figure class="card">
          <canvas id="secondaryPlot" aria-label="Secondary plot"></canvas>
          <figcaption>
            <strong>Secondary plot.</strong> Complementary view (effective susceptibility, phase, or a parameter sweep).
          </figcaption>
        </figure>

        <figure class="card">
          <div class="eqRow">
            <button class="btn primary" id="copyEqBtn" title="Copy the key equation as plain text">Copy key equation</button>
            <button class="btn" id="copyFinalBtn" title="Copy the final classification summary as plain text">Copy final answer</button>
            <button class="btn" id="resetBtn" title="Reset example parameters">Reset</button>
          </div>
          <div class="hr"></div>
          <div class="mini" style="margin-bottom:8px;">Key equation (plain text):</div>
          <pre class="eq" id="keyEqText">—</pre>
          <div class="mini" style="margin-bottom:8px;">Computed example note (for plots only):</div>
          <pre class="eq" id="plotNote">—</pre>
        </figure>
      </div>
    </div>
  </section>

  <section id="part1">
    <header><h2>PART 1 — Problem Analysis (no solving yet)</h2></header>
    <div class="content">
      <article class="grid2">
        <div class="card">
          <h3 style="margin:0 0 8px;">Rewrite the problem (in my words)</h3>
          <p style="margin:0;">
            For each given constitutive relation connecting the polarization density <span class="mono">P</span> to the electric field
            <span class="mono">E</span>, determine whether the medium is:
            <strong>(i)</strong> linear or nonlinear,
            <strong>(ii)</strong> temporally dispersive (depends on past fields / frequency-dependent response),
            <strong>(iii)</strong> spatially dispersive (depends on spatial derivatives / wavevector),
            and <strong>(iv)</strong> homogeneous or inhomogeneous (material parameters constant or position-dependent).
          </p>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;">Given, unknowns, and what to find</h3>
          <p style="margin:0 0 8px;"><strong>Given:</strong> four equations (a–d) for <span class="mono">P</span> in terms of <span class="mono">E</span> and/or derivatives; constants <span class="mono">χ, a, a1, a2</span>; coordinates <span class="mono">(x,y)</span>.</p>
          <p style="margin:0 0 8px;"><strong>Unknowns:</strong> the qualitative “type” of each medium.</p>
          <p style="margin:0;"><strong>Must determine:</strong> for each (a–d) classify: linearity, temporal dispersion, spatial dispersion, homogeneity. (Isotropy is assumed.)</p>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;">Relevant principles and why they apply</h3>
          <p style="margin:0 0 8px;">
            In macroscopic electromagnetism, the dielectric response is encoded by the constitutive relation. The classification asked
            here is read off by checking:
          </p>
          <ul style="margin:0; padding-left:18px;">
            <li><strong>Linearity:</strong> is <span class="mono">P</span> proportional to <span class="mono">E</span> (superposition holds) or does it involve powers/products like <span class="mono">P²</span>, <span class="mono">|E|²E</span>, etc.?</li>
            <li><strong>Temporal dispersion:</strong> does <span class="mono">P(t)</span> depend on time derivatives / convolution in time (memory), implying frequency dependence?</li>
            <li><strong>Spatial dispersion:</strong> does <span class="mono">P</span> involve spatial derivatives of <span class="mono">E</span> (e.g., <span class="mono">∇×E</span>) or nonlocal integrals, implying wavevector dependence?</li>
            <li><strong>Homogeneity:</strong> are coefficients constant or explicitly functions of position?</li>
          </ul>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;">Possible approaches (compare)</h3>
          <ol style="margin:0; padding-left:18px;">
            <li><strong>Direct inspection:</strong> look for powers of fields (nonlinearity), time derivatives (temporal dispersion), spatial derivatives (spatial dispersion), and position-dependent coefficients (inhomogeneity). Fast and sufficient here.</li>
            <li><strong>Fourier-domain method:</strong> transform in time (<span class="mono">ω</span>) and space (<span class="mono">k</span>) to see if response becomes <span class="mono">P(ω,k)=ε0 χ(ω,k) E(ω,k)</span>. Best for interpreting dispersion rigorously.</li>
            <li><strong>Superposition test:</strong> explicitly test <span class="mono">P(E1+E2)=P(E1)+P(E2)</span> and scaling <span class="mono">P(αE)=αP(E)</span>. Clear for linearity, but slower than inspection.</li>
          </ol>
          <p style="margin:10px 0 0;">
            <strong>Chosen approach:</strong> combine <em>direct inspection</em> with a short <em>Fourier-domain interpretation</em>
            for cases (a) and (c), since dispersion is most naturally explained in <span class="mono">ω</span> and <span class="mono">k</span>.
          </p>
        </div>
      </article>
    </div>
  </section>

  <section id="part2">
    <header><h2>PART 2 — Strategy & Tips (roadmap only)</h2></header>
    <div class="content">
      <div class="grid2">
        <div class="card">
          <h3 style="margin:0 0 8px;">Step-by-step plan (5–10 steps)</h3>
          <ol style="margin:0; padding-left:18px;">
            <li><strong>Identify variables:</strong> confirm <span class="mono">P</span> is the response, <span class="mono">E</span> is the drive.</li>
            <li><strong>Check linearity:</strong> look for nonlinear functions/powers of <span class="mono">P</span> or <span class="mono">E</span>.</li>
            <li><strong>Check temporal dispersion:</strong> look for time derivatives of <span class="mono">P</span> or <span class="mono">E</span> (or explicit time integrals).</li>
            <li><strong>Check spatial dispersion:</strong> look for gradients/curls/Laplacians (spatial derivatives) of fields.</li>
            <li><strong>Check homogeneity:</strong> see whether coefficients depend on <span class="mono">x,y,z</span>.</li>
            <li><strong>Optional rigor:</strong> Fourier transform to interpret time derivatives as <span class="mono">(-iω)</span> factors and spatial derivatives as <span class="mono">(ik)</span> factors.</li>
            <li><strong>Summarize:</strong> compile results in a clean table.</li>
          </ol>
        </div>
        <div class="card">
          <h3 style="margin:0 0 8px;">Common mistakes &amp; quick tips</h3>
          <ul style="margin:0; padding-left:18px;">
            <li><strong>Mixing “spatial dispersion” with “inhomogeneity”:</strong> spatial dispersion means dependence on spatial <em>derivatives</em> (nonlocality), not just coefficients varying with position.</li>
            <li><strong>Thinking any derivative implies nonlinearity:</strong> derivatives can appear in perfectly linear models (e.g., linear ODEs/PDEs).</li>
            <li><strong>Forgetting memory:</strong> time derivatives on <span class="mono">P</span> typically imply frequency dependence → temporal dispersion.</li>
            <li><strong>Isotropy note:</strong> isotropy restricts tensor structure; scalar coefficients are consistent, though cross-products (like <span class="mono">k×E</span>) can still appear in isotropic models.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>

  <section id="part3">
    <header><h2>PART 3 — Full Solution</h2></header>
    <div class="content">
      <div class="card callout">
        <h3 style="margin:0 0 8px;">Physical intuition first</h3>
        <p style="margin:0;">
          A dielectric’s polarization <span class="mono">P</span> is the medium’s induced dipole moment per unit volume.
          If <span class="mono">P</span> reacts instantly and locally to <span class="mono">E</span>, the medium is nondispersive (in time) and not spatially dispersive.
          If <span class="mono">P</span> depends on past values of <span class="mono">E</span>, the response is temporally dispersive.
          If <span class="mono">P</span> depends on spatial derivatives of <span class="mono">E</span> (or equivalently on wavevector <span class="mono">k</span>), the medium is spatially dispersive.
          If coefficients vary with position, the medium is inhomogeneous.
        </p>
      </div>

      <div class="hr"></div>

      <article class="grid2">
        <div class="card">
          <h3 style="margin:0 0 8px;">Definitions used</h3>
          <div class="box">
            <p style="margin:0 0 8px;"><span class="tag"><span class="dot good"></span><strong>Linear</strong></span> if superposition holds: for any <span class="mono">E1,E2</span> and scalars <span class="mono">α,β</span>,</p>
            <div class="eq">P[αE1 + βE2] = αP[E1] + βP[E2].</div>
            <p style="margin:10px 0 8px;"><span class="tag"><span class="dot warn"></span><strong>Temporally dispersive</strong></span> if <span class="mono">P(t)</span> depends on the history of <span class="mono">E</span>. In frequency domain:</p>
            <div class="eq">P(ω) = ε0 χ(ω) E(ω)  (χ depends on ω).</div>
            <p style="margin:10px 0 8px;"><span class="tag"><span class="dot warn"></span><strong>Spatially dispersive</strong></span> if response depends on spatial derivatives or nonlocality. In <span class="mono">k</span>-space:</p>
            <div class="eq">P(k) = ε0 χ(k) E(k)  (χ depends on k, possibly via k×E, k·E, ...).</div>
            <p style="margin:10px 0 0;"><span class="tag"><span class="dot bad"></span><strong>Inhomogeneous</strong></span> if coefficients are functions of position (e.g., <span class="mono">χ=χ(x,y,z)</span>).</p>
          </div>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;">Given constitutive relations</h3>
          <div class="eqRow" style="margin-bottom:10px;">
            <div style="flex:1 1 280px;">
              <div class="mini">(a)</div>
              <pre class="eq">P = ε0 χ E − a ∇×E</pre>
            </div>
            <div style="flex:1 1 280px;">
              <div class="mini">(b)</div>
              <pre class="eq">P + a P² = ε0 χ E</pre>
            </div>
            <div style="flex:1 1 280px;">
              <div class="mini">(c)</div>
              <pre class="eq">a1 ∂²P/∂t² + a2 ∂P/∂t + P = ε0 χ E</pre>
            </div>
            <div style="flex:1 1 280px;">
              <div class="mini">(d)</div>
              <pre class="eq">P = ε0{a1 + a2 exp[−(x²+y²)]} E</pre>
            </div>
          </div>
          <p style="margin:0; color:var(--muted);">
            Here <span class="mono">ε0</span> is vacuum permittivity; <span class="mono">χ</span> is a (given) scalar susceptibility parameter; and
            <span class="mono">a, a1, a2</span> are constants unless explicitly shown as position-dependent (case d).
          </p>
        </div>
      </article>

      <div class="hr"></div>

      <article>
        <div class="card">
          <h3 style="margin:0 0 8px;">Case (a): <span class="mono">P = ε0 χ E − a ∇×E</span></h3>
          <p style="margin:0 0 8px;">
            <strong>Linearity:</strong> The right-hand side is a sum of terms each proportional to <span class="mono">E</span> (and its derivative),
            with constant coefficients. Derivatives are linear operators, so superposition holds → <span class="tag"><span class="dot good"></span>Linear</span>
          </p>
          <p style="margin:0 0 8px;">
            <strong>Temporal dispersion:</strong> No time derivatives or time integrals appear. At a given time <span class="mono">t</span>, <span class="mono">P</span>
            depends only on <span class="mono">E</span> at that same <span class="mono">t</span> → <span class="tag"><span class="dot good"></span>Not temporally dispersive</span>
          </p>
          <p style="margin:0 0 8px;">
            <strong>Spatial dispersion:</strong> The presence of <span class="mono">∇×E</span> means the polarization depends on spatial derivatives, i.e. not purely local in space.
            In spatial Fourier domain, <span class="mono">∇×E</span> becomes <span class="mono">i k × E</span>, so:
          </p>
          <pre class="eq">P(k) = ε0 χ E(k) − a (i k × E(k)).</pre>
          <p style="margin:0 0 8px;">
            Since the response explicitly depends on <span class="mono">k</span>, the medium is <span class="tag"><span class="dot warn"></span>Spatially dispersive</span>.
          </p>
          <p style="margin:0;">
            <strong>Homogeneity:</strong> coefficients <span class="mono">ε0, χ, a</span> are constants → <span class="tag"><span class="dot good"></span>Homogeneous</span>.
          </p>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3 style="margin:0 0 8px;">Case (b): <span class="mono">P + a P² = ε0 χ E</span></h3>
          <p style="margin:0 0 8px;">
            <strong>Linearity:</strong> The term <span class="mono">aP²</span> is nonlinear in the response. If you scale the field, the polarization does not scale proportionally.
            Hence <span class="tag"><span class="dot bad"></span>Nonlinear</span>.
          </p>
          <p style="margin:0 0 8px;">
            <strong>Temporal dispersion:</strong> There are no time derivatives/integrals. The relation is algebraic “instantaneous” → <span class="tag"><span class="dot good"></span>Not temporally dispersive</span>.
          </p>
          <p style="margin:0 0 8px;">
            <strong>Spatial dispersion:</strong> No spatial derivatives appear → <span class="tag"><span class="dot good"></span>Not spatially dispersive</span>.
          </p>
          <p style="margin:0 0 8px;"><strong>Homogeneity:</strong> constant coefficient <span class="mono">a</span> → <span class="tag"><span class="dot good"></span>Homogeneous</span>.</p>
          <p style="margin:0;">
            <strong>Extra (useful) algebraic solution:</strong> If one wants <span class="mono">P(E)</span> explicitly, solve the quadratic:
          </p>
          <pre class="eq">aP² + P − ε0 χ E = 0
P(E) = [−1 + √(1 + 4 a ε0 χ E)] / (2a)   (choose the root that gives P→ε0χE as a→0).</pre>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3 style="margin:0 0 8px;">Case (c): <span class="mono">a1 P¨ + a2 P˙ + P = ε0 χ E</span></h3>
          <p style="margin:0 0 8px;">
            <strong>Linearity:</strong> This is a linear differential equation in <span class="mono">P</span> driven by <span class="mono">E</span>; sums and derivatives are linear →
            <span class="tag"><span class="dot good"></span>Linear</span>.
          </p>
          <p style="margin:0 0 8px;">
            <strong>Temporal dispersion:</strong> Because time derivatives of <span class="mono">P</span> appear, the solution for <span class="mono">P(t)</span> depends on the past drive (via the ODE’s dynamics).
            In frequency domain (assume harmonic time dependence <span class="mono">e^{−iωt}</span>):
          </p>
          <pre class="eq">P˙ → (−iω)P,   P¨ → (−ω²)P
(1 − a1 ω² − i a2 ω) P(ω) = ε0 χ E(ω)
⇒ P(ω) = ε0 χ(ω) E(ω),   with  χ(ω) = χ / (1 − a1 ω² − i a2 ω).</pre>
          <p style="margin:0 0 8px;">
            Since <span class="mono">χ(ω)</span> depends on frequency, the medium is <span class="tag"><span class="dot warn"></span>Temporally dispersive</span>.
          </p>
          <p style="margin:0 0 8px;">
            <strong>Spatial dispersion:</strong> No spatial derivatives appear → <span class="tag"><span class="dot good"></span>Not spatially dispersive</span>.
          </p>
          <p style="margin:0;">
            <strong>Homogeneity:</strong> coefficients are constants → <span class="tag"><span class="dot good"></span>Homogeneous</span>.
          </p>
        </div>

        <div class="card" style="margin-top:12px;">
          <h3 style="margin:0 0 8px;">Case (d): <span class="mono">P = ε0{a1 + a2 e^{-(x²+y²)}} E</span></h3>
          <p style="margin:0 0 8px;">
            <strong>Linearity:</strong> <span class="mono">P</span> is proportional to <span class="mono">E</span> (a scalar factor times <span class="mono">E</span>) →
            <span class="tag"><span class="dot good"></span>Linear</span>.
          </p>
          <p style="margin:0 0 8px;">
            <strong>Temporal dispersion:</strong> no time derivatives/integrals → <span class="tag"><span class="dot good"></span>Not temporally dispersive</span>.
          </p>
          <p style="margin:0 0 8px;">
            <strong>Spatial dispersion:</strong> no spatial derivatives of <span class="mono">E</span> → <span class="tag"><span class="dot good"></span>Not spatially dispersive</span>.
          </p>
          <p style="margin:0;">
            <strong>Homogeneity:</strong> the coefficient <span class="mono">(a1 + a2 e^{-(x²+y²)})</span> depends on position → <span class="tag"><span class="dot bad"></span>Inhomogeneous</span>.
          </p>
        </div>
      </article>
    </div>
  </section>

  <section id="final">
    <header><h2>Final Classification Table</h2></header>
    <div class="content">
      <div class="boxedAnswer">
        <h3>Final result (symbolic classification)</h3>
        <table aria-label="Classification table">
          <thead>
            <tr>
              <th>Case</th>
              <th>Linearity</th>
              <th>Temporal dispersion?</th>
              <th>Spatial dispersion?</th>
              <th>Homogeneity</th>
            </tr>
          </thead>
          <tbody>
            <tr>
              <td class="mono">(a)</td>
              <td>Linear</td>
              <td>No (instantaneous in time)</td>
              <td><strong>Yes</strong> (depends on <span class="mono">∇×E</span> → <span class="mono">k×E</span>)</td>
              <td>Homogeneous (constants)</td>
            </tr>
            <tr>
              <td class="mono">(b)</td>
              <td><strong>Nonlinear</strong> (quadratic)</td>
              <td>No</td>
              <td>No</td>
              <td>Homogeneous (constants)</td>
            </tr>
            <tr>
              <td class="mono">(c)</td>
              <td>Linear</td>
              <td><strong>Yes</strong> (time-derivative dynamics → <span class="mono">χ(ω)</span>)</td>
              <td>No</td>
              <td>Homogeneous (constants)</td>
            </tr>
            <tr>
              <td class="mono">(d)</td>
              <td>Linear</td>
              <td>No</td>
              <td>No</td>
              <td><strong>Inhomogeneous</strong> (position-dependent coefficient)</td>
            </tr>
          </tbody>
        </table>

        <div class="hr"></div>
        <div class="mini">Copy-friendly final answer text:</div>
        <pre class="eq" id="finalAnswerText">Case (a): linear; not temporally dispersive; spatially dispersive; homogeneous.
Case (b): nonlinear; not temporally dispersive; not spatially dispersive; homogeneous.
Case (c): linear; temporally dispersive; not spatially dispersive; homogeneous.
Case (d): linear; not temporally dispersive; not spatially dispersive; inhomogeneous.</pre>
      </div>
    </div>
  </section>

  <section id="checks">
    <header><h2>Sanity Checks</h2></header>
    <div class="content">
      <div class="grid2">
        <div class="card">
          <h3 style="margin:0 0 8px;">Units (consistency)</h3>
          <ul style="margin:0; padding-left:18px;">
            <li><span class="mono">P</span> has units C/m², <span class="mono">ε0 E</span> also C/m² → <span class="mono">χ</span> is dimensionless in (a,b,c) when multiplying <span class="mono">ε0E</span>.</li>
            <li>In (a), the term <span class="mono">a ∇×E</span> must have units of <span class="mono">P</span>, so <span class="mono">a</span> carries units that convert <span class="mono">(V/m²)</span> into <span class="mono">(C/m²)</span> (problem treats <span class="mono">a</span> as a constant parameter).</li>
            <li>In (c), <span class="mono">a1</span> and <span class="mono">a2</span> carry time units so that <span class="mono">a1 P¨</span>, <span class="mono">a2 P˙</span>, and <span class="mono">P</span> have the same units.</li>
          </ul>
        </div>

        <div class="card">
          <h3 style="margin:0 0 8px;">Limiting cases &amp; interpretation</h3>
          <ul style="margin:0; padding-left:18px;">
            <li>(a) If <span class="mono">a→0</span>, response becomes local <span class="mono">P=ε0χE</span> (no spatial dispersion).</li>
            <li>(b) If <span class="mono">a→0</span>, quadratic law reduces to linear <span class="mono">P=ε0χE</span>.</li>
            <li>(c) If <span class="mono">a1,a2→0</span>, then <span class="mono">P=ε0χE</span> and temporal dispersion disappears.</li>
            <li>(d) If <span class="mono">a2=0</span>, coefficient becomes constant <span class="mono">a1</span> and the medium becomes homogeneous.</li>
          </ul>
        </div>
      </div>
    </div>
  </section>
</main>

<footer>
  Built with vanilla HTML/CSS/JS. Plots use example parameters only; the classification results are symbolic and general.
</footer>

<script>
/* =========================
   Utilities: crisp canvas + axes plotting
   ========================= */
function setupCanvas(canvas){
  const dpr = Math.max(1, window.devicePixelRatio || 1);
  const rect = canvas.getBoundingClientRect();
  const w = Math.max(10, Math.floor(rect.width * dpr));
  const h = Math.max(10, Math.floor(rect.height * dpr));
  if(canvas.width !== w || canvas.height !== h){
    canvas.width = w; canvas.height = h;
  }
  const ctx = canvas.getContext('2d');
  ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  return {ctx, w: rect.width, h: rect.height, dpr};
}
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function lerp(a,b,t){ return a + (b-a)*t; }

function drawPanelBackground(ctx, w, h){
  ctx.clearRect(0,0,w,h);
  // subtle gradient
  const g = ctx.createLinearGradient(0,0,w,h);
  g.addColorStop(0, "rgba(255,255,255,0.04)");
  g.addColorStop(1, "rgba(0,0,0,0.10)");
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);
}

function drawAxes(ctx, w, h, opts){
  const {
    xMin, xMax, yMin, yMax,
    xLabel, yLabel, title,
    xUnits="", yUnits="",
    grid=true, ticks=5, legend=[]
  } = opts;

  const padL = 56, padR = 16, padT = 34, padB = 44;
  const plotW = w - padL - padR;
  const plotH = h - padT - padB;

  // Title
  ctx.fillStyle = "rgba(232,238,252,0.95)";
  ctx.font = "600 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText(title, padL, 22);

  // Plot rect
  ctx.strokeStyle = "rgba(255,255,255,0.12)";
  ctx.lineWidth = 1;
  ctx.strokeRect(padL, padT, plotW, plotH);

  // Grid + ticks
  const n = ticks;
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace";
  ctx.fillStyle = "rgba(185,196,230,0.95)";
  ctx.strokeStyle = "rgba(255,255,255,0.08)";

  for(let i=0;i<=n;i++){
    const tx = padL + (plotW*i/n);
    const ty = padT + (plotH*i/n);

    if(grid){
      // vertical
      ctx.beginPath();
      ctx.moveTo(tx, padT);
      ctx.lineTo(tx, padT+plotH);
      ctx.stroke();
      // horizontal
      ctx.beginPath();
      ctx.moveTo(padL, ty);
      ctx.lineTo(padL+plotW, ty);
      ctx.stroke();
    }

    // tick labels
    const xv = lerp(xMin, xMax, i/n);
    const yv = lerp(yMax, yMin, i/n);

    const xTxt = prettyNum(xv);
    const yTxt = prettyNum(yv);

    ctx.fillText(xTxt, tx-10, padT+plotH+18);
    ctx.fillText(yTxt, 8, ty+4);
  }

  // Axis labels
  ctx.fillStyle = "rgba(232,238,252,0.95)";
  ctx.font = "600 12.5px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText(xLabel + (xUnits ? ` (${xUnits})` : ""), padL + plotW/2 - 30, h-12);

  ctx.save();
  ctx.translate(14, padT + plotH/2 + 30);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel + (yUnits ? ` (${yUnits})` : ""), 0, 0);
  ctx.restore();

  // Legend
  if(legend && legend.length){
    const bx = padL + 10;
    const by = padT + 10;
    ctx.font = "12.5px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
    legend.forEach((item, idx)=>{
      const y = by + idx*18;
      ctx.fillStyle = item.color;
      ctx.fillRect(bx, y-10, 10, 10);
      ctx.fillStyle = "rgba(232,238,252,0.95)";
      ctx.fillText(item.label, bx + 14, y-1);
    });
  }

  function xToPx(x){ return padL + (x - xMin) / (xMax - xMin) * plotW; }
  function yToPx(y){ return padT + (yMax - y) / (yMax - yMin) * plotH; }

  return {padL,padR,padT,padB,plotW,plotH,xToPx,yToPx};
}

function prettyNum(x){
  const ax = Math.abs(x);
  if(ax >= 1000) return (x).toFixed(0);
  if(ax >= 100) return (x).toFixed(1);
  if(ax >= 10) return (x).toFixed(2);
  if(ax >= 1) return (x).toFixed(3);
  if(ax >= 0.1) return (x).toFixed(3);
  return (x).toExponential(2);
}

function drawLine(ctx, map, xs, ys, color, width=2){
  ctx.strokeStyle = color;
  ctx.lineWidth = width;
  ctx.beginPath();
  for(let i=0;i<xs.length;i++){
    const px = map.xToPx(xs[i]);
    const py = map.yToPx(ys[i]);
    if(i===0) ctx.moveTo(px,py);
    else ctx.lineTo(px,py);
  }
  ctx.stroke();
}

function drawPoints(ctx, map, xs, ys, color){
  ctx.fillStyle = color;
  for(let i=0;i<xs.length;i++){
    const px = map.xToPx(xs[i]);
    const py = map.yToPx(ys[i]);
    ctx.beginPath();
    ctx.arc(px,py,2.5,0,Math.PI*2);
    ctx.fill();
  }
}

/* =========================
   Problem-specific model functions
   ========================= */
function chiOmega(chi, a1, a2, w){
  // From: (1 - a1 w^2 - i a2 w) P = ε0 chi E  => chi_eff(w) = chi / (1 - a1 w^2 - i a2 w)
  const re = 1 - a1*w*w;
  const im = -a2*w;
  const denom = re*re + im*im;
  return { re: chi*re/denom, im: -chi*im/denom, mag: Math.sqrt((chi*re/denom)**2 + (-chi*im/denom)**2), phase: Math.atan2(-chi*im/denom, chi*re/denom) };
}
function pNonlinear(eps0chiE, a){
  // Solve aP^2 + P - eps0chiE = 0
  if(Math.abs(a) < 1e-12) return eps0chiE;
  const disc = 1 + 4*a*eps0chiE;
  // for plotting, clamp to nonnegative to avoid NaN when disc<0 (would indicate breakdown of chosen example values)
  const d = Math.sqrt(Math.max(0, disc));
  return (-1 + d) / (2*a);
}

/* =========================
   UI + rendering
   ========================= */
const diagramCanvas = document.getElementById('diagramCanvas');
const mainPlot = document.getElementById('mainPlot');
const secondaryPlot = document.getElementById('secondaryPlot');

const caseSelect = document.getElementById('caseSelect');
const paramSlider = document.getElementById('paramSlider');
const chiInput = document.getElementById('chiInput');
const driveInput = document.getElementById('driveInput');

const paramLabel = document.getElementById('paramLabel');
const keyEqText = document.getElementById('keyEqText');
const plotNote = document.getElementById('plotNote');

const copyEqBtn = document.getElementById('copyEqBtn');
const copyFinalBtn = document.getElementById('copyFinalBtn');
const resetBtn = document.getElementById('resetBtn');
const finalAnswerText = document.getElementById('finalAnswerText');

const EPS0 = 1; // example scaling for plots; classification is symbolic

function setSliderForCase(c){
  if(c==='a'){
    paramSlider.min = 0; paramSlider.max = 2; paramSlider.step = 0.001; paramSlider.value = 0.6; // a (strength)
  }else if(c==='b'){
    paramSlider.min = -1.0; paramSlider.max = 1.0; paramSlider.step = 0.001; paramSlider.value = 0.25; // a (nonlinearity)
  }else if(c==='c'){
    paramSlider.min = 0; paramSlider.max = 2.5; paramSlider.step = 0.001; paramSlider.value = 0.8; // a2 damping (a1 fixed by drive input)
  }else if(c==='d'){
    paramSlider.min = 0; paramSlider.max = 3; paramSlider.step = 0.001; paramSlider.value = 1.2; // a2 amplitude
  }
}

function updateKeyEquation(){
  const c = caseSelect.value;
  if(c==='a'){
    keyEqText.textContent = "P = ε0 χ E − a ∇×E";
  }else if(c==='b'){
    keyEqText.textContent = "P + a P^2 = ε0 χ E";
  }else if(c==='c'){
    keyEqText.textContent = "a1 ∂^2P/∂t^2 + a2 ∂P/∂t + P = ε0 χ E";
  }else{
    keyEqText.textContent = "P = ε0{a1 + a2 exp[−(x^2+y^2)]} E";
  }
}

function updateParamLabel(){
  const c = caseSelect.value;
  const v = parseFloat(paramSlider.value);
  if(c==='a'){
    paramLabel.textContent = `a (spatial-dispersion strength) = ${v.toFixed(3)}  (example units)`;
  }else if(c==='b'){
    paramLabel.textContent = `a (nonlinearity strength) = ${v.toFixed(3)}  (example units)`;
  }else if(c==='c'){
    paramLabel.textContent = `a2 (damping) = ${v.toFixed(3)} ; a1 set from drive input`;
  }else{
    paramLabel.textContent = `a2 (inhomogeneity amplitude) = ${v.toFixed(3)} ; a1 set from drive input`;
  }
}

function drawDiagram(){
  const {ctx, w, h} = setupCanvas(diagramCanvas);
  drawPanelBackground(ctx, w, h);

  const c = caseSelect.value;
  const chi = parseFloat(chiInput.value);
  const drive = parseFloat(driveInput.value);
  const p = parseFloat(paramSlider.value);

  // coordinate frame
  ctx.save();
  ctx.translate(18, 18);

  // Title
  ctx.fillStyle = "rgba(232,238,252,0.95)";
  ctx.font = "700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText("Labeled diagram (conceptual)", 0, 0);

  // Draw a slab and vectors
  const slabX = 40, slabY = 55, slabW = w-120, slabH = h-120;
  ctx.fillStyle = "rgba(255,255,255,0.035)";
  ctx.strokeStyle = "rgba(255,255,255,0.14)";
  ctx.lineWidth = 1.2;
  roundRect(ctx, slabX, slabY, slabW, slabH, 16, true, true);

  // E vector (incoming)
  const ex0 = slabX - 10, ey0 = slabY + slabH*0.35;
  const ex1 = slabX + slabW*0.45, ey1 = ey0;
  arrow(ctx, ex0, ey0, ex1, ey1, "rgba(110,231,255,0.95)", 2.4);
  label(ctx, ex0+6, ey0-10, "E (applied field)", "rgba(110,231,255,0.95)");

  // P vector (inside)
  const px0 = slabX + slabW*0.55, py0 = slabY + slabH*0.65;
  const px1 = slabX + slabW*0.90, py1 = py0 - slabH*0.18;
  arrow(ctx, px0, py0, px1, py1, "rgba(167,139,250,0.95)", 2.4);
  label(ctx, px0+6, py0+18, "P (polarization)", "rgba(167,139,250,0.95)");

  // Annotations depending on case
  ctx.font = "12.5px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillStyle = "rgba(232,238,252,0.92)";

  if(c==='a'){
    // show curl symbol
    ctx.fillText("Spatial derivative term:  ∇×E  (nonlocal in space)", slabX+16, slabY+24);
    // draw little circular arrow
    const cx = slabX+slabW*0.18, cy = slabY+slabH*0.70;
    swirl(ctx, cx, cy, 18, "rgba(251,191,36,0.9)");
    label(ctx, cx-10, cy+34, "curl", "rgba(251,191,36,0.9)");
    plotNote.textContent =
      `Example assumption for plot: transverse wave so |P|/|E| ≈ sqrt((ε0χ)^2 + (a k)^2).\nUsing χ=${chi}, a=${p}.`;
  }else if(c==='b'){
    ctx.fillText("Nonlinearity: algebraic term a P² breaks superposition", slabX+16, slabY+24);
    // draw curve icon
    curveIcon(ctx, slabX+slabW*0.20, slabY+slabH*0.70, 55, 35, "rgba(251,113,133,0.9)");
    label(ctx, slabX+slabW*0.20, slabY+slabH*0.70+48, "nonlinear", "rgba(251,113,133,0.9)");
    plotNote.textContent =
      `Example plot uses ε0=1 scaling.\nQuadratic solution: P(E)=[-1+sqrt(1+4 a ε0 χ E)]/(2a).\nUsing χ=${chi}, a=${p}.`;
  }else if(c==='c'){
    ctx.fillText("Time-memory: P obeys a driven ODE (frequency-dependent χ(ω))", slabX+16, slabY+24);
    // draw clock
    clock(ctx, slabX+slabW*0.20, slabY+slabH*0.70, 18, "rgba(251,191,36,0.9)");
    label(ctx, slabX+slabW*0.20-16, slabY+slabH*0.70+34, "memory", "rgba(251,191,36,0.9)");
    plotNote.textContent =
      `Example: χ(ω)=χ/(1−a1 ω^2−i a2 ω). For visualization:\nset a1 = drive input = ${drive}, a2 = ${p}, χ=${chi}.`;
  }else{
    ctx.fillText("Inhomogeneity: coefficient depends on position (x,y)", slabX+16, slabY+24);
    // draw Gaussian bump
    gaussPatch(ctx, slabX+slabW*0.18, slabY+slabH*0.62, 90, 70);
    label(ctx, slabX+slabW*0.18, slabY+slabH*0.62+58, "a1 + a2 e^{-(x^2+y^2)}", "rgba(110,231,255,0.9)");
    plotNote.textContent =
      `Example spatial profile: χ_eff(r)=a1 + a2 exp(-r^2).\nUsing a1=drive input=${drive}, a2=${p}.`;
  }

  ctx.restore();
}

function drawMainAndSecondary(){
  drawMainPlot();
  drawSecondaryPlot();
}

function drawMainPlot(){
  const {ctx, w, h} = setupCanvas(mainPlot);
  drawPanelBackground(ctx, w, h);

  const c = caseSelect.value;
  const chi = parseFloat(chiInput.value);
  const drive = parseFloat(driveInput.value);
  const p = parseFloat(paramSlider.value);

  if(c==='b'){
    // Main: P vs E
    const xMin=-2, xMax=2;
    // compute y range from curve
    const xs = [], ys = [];
    let yMin=1e9, yMax=-1e9;
    for(let i=0;i<=250;i++){
      const E = lerp(xMin,xMax,i/250);
      const rhs = EPS0*chi*E;
      const P = pNonlinear(rhs, p);
      xs.push(E); ys.push(P);
      yMin = Math.min(yMin, P);
      yMax = Math.max(yMax, P);
    }
    // pad y range
    const pad = 0.12*(yMax-yMin || 1);
    yMin -= pad; yMax += pad;

    const map = drawAxes(ctx,w,h,{
      xMin,xMax,yMin,yMax,
      xLabel:"Electric field E (example)", yLabel:"Polarization P (scaled)",
      title:"Case (b): Nonlinear algebraic response P(E)",
      grid:true, ticks:5,
      legend:[{label:"P(E) from quadratic law", color:"rgba(167,139,250,0.95)"}]
    });
    drawLine(ctx, map, xs, ys, "rgba(167,139,250,0.95)", 2.4);

    // mark operating point from driveInput as E0
    const E0 = clamp(drive, xMin, xMax);
    const P0 = pNonlinear(EPS0*chi*E0, p);
    drawPoints(ctx, map, [E0], [P0], "rgba(110,231,255,0.95)");
    ctx.fillStyle = "rgba(110,231,255,0.95)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace";
    ctx.fillText(`E0=${prettyNum(E0)}, P0=${prettyNum(P0)}`, map.xToPx(E0)+6, map.yToPx(P0)-8);

  }else if(c==='c'){
    // Main: |chi(ω)| vs ω
    const a1 = Math.max(0, drive); // use drive input as a1 for demo
    const a2 = Math.max(0, p);
    const xMin=0, xMax=4;
    const xs=[], ys=[];
    let yMin=0, yMax=0;
    for(let i=0;i<=260;i++){
      const wv = lerp(xMin,xMax,i/260);
      const ce = chiOmega(chi, a1, a2, wv);
      xs.push(wv); ys.push(ce.mag);
      yMax = Math.max(yMax, ce.mag);
    }
    yMax = Math.max(yMax, 1e-6);
    const map = drawAxes(ctx,w,h,{
      xMin,xMax,yMin:0,yMax:yMax*1.12,
      xLabel:"Angular frequency ω", yLabel:"|χ(ω)|",
      title:"Case (c): Temporal dispersion magnitude |χ(ω)|",
      grid:true, ticks:5,
      legend:[{label:"|χ(ω)|", color:"rgba(110,231,255,0.95)"}]
    });
    drawLine(ctx, map, xs, ys, "rgba(110,231,255,0.95)", 2.4);

    // mark peak-ish frequency by scan
    let imax=0;
    for(let i=1;i<ys.length;i++) if(ys[i]>ys[imax]) imax=i;
    drawPoints(ctx, map, [xs[imax]], [ys[imax]], "rgba(251,191,36,0.95)");
    ctx.fillStyle = "rgba(251,191,36,0.95)";
    ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono','Courier New', monospace";
    ctx.fillText(`max at ω≈${prettyNum(xs[imax])}`, map.xToPx(xs[imax])+6, map.yToPx(ys[imax])-8);

  }else if(c==='a'){
    // Main: |P|/|E| vs k for a transverse plane wave (demo)
    // If E ⟂ k, then |k×E| = k|E|, so |P| ≈ sqrt((ε0χ)^2 + (a k)^2) |E|
    const a = Math.max(0, p);
    const xMin=0, xMax=6;
    const xs=[], ys=[];
    let yMax=0;
    for(let i=0;i<=260;i++){
      const k = lerp(xMin,xMax,i/260);
      const ratio = Math.sqrt((EPS0*chi)**2 + (a*k)**2);
      xs.push(k); ys.push(ratio);
      yMax = Math.max(yMax, ratio);
    }
    const map = drawAxes(ctx,w,h,{
      xMin,xMax,yMin:0,yMax:yMax*1.12,
      xLabel:"Wavevector magnitude k", yLabel:"|P|/|E| (scaled)",
      title:"Case (a): Spatial dispersion demo (transverse wave)",
      grid:true, ticks:5,
      legend:[{label:"sqrt((ε0χ)^2 + (a k)^2)", color:"rgba(167,139,250,0.95)"}]
    });
    drawLine(ctx, map, xs, ys, "rgba(167,139,250,0.95)", 2.4);

  }else{
    // Main: spatial profile of χ_eff(r)=a1 + a2 exp(-r^2), r in example units
    const a1 = drive;
    const a2 = p;
    const xMin=0, xMax=3;
    const xs=[], ys=[];
    let yMin=1e9, yMax=-1e9;
    for(let i=0;i<=260;i++){
      const r = lerp(xMin,xMax,i/260);
      const ce = a1 + a2*Math.exp(-(r*r));
      xs.push(r); ys.push(ce);
      yMin = Math.min(yMin, ce);
      yMax = Math.max(yMax, ce);
    }
    const pad = 0.12*(yMax-yMin || 1);
    const map = drawAxes(ctx,w,h,{
      xMin,xMax,yMin:yMin-pad,yMax:yMax+pad,
      xLabel:"Radius r = √(x²+y²)", yLabel:"χ_eff(r)",
      title:"Case (d): Inhomogeneous susceptibility profile",
      grid:true, ticks:5,
      legend:[{label:"a1 + a2 e^{-r^2}", color:"rgba(110,231,255,0.95)"}]
    });
    drawLine(ctx, map, xs, ys, "rgba(110,231,255,0.95)", 2.4);
  }
}

function drawSecondaryPlot(){
  const {ctx, w, h} = setupCanvas(secondaryPlot);
  drawPanelBackground(ctx, w, h);

  const c = caseSelect.value;
  const chi = parseFloat(chiInput.value);
  const drive = parseFloat(driveInput.value);
  const p = parseFloat(paramSlider.value);

  if(c==='b'){
    // Secondary: effective susceptibility χ_eff(E) = P/(ε0 E) (avoid E=0)
    const xMin=0.1, xMax=2.0;
    const xs=[], ys=[];
    let yMin=1e9, yMax=-1e9;
    for(let i=0;i<=240;i++){
      const E = lerp(xMin,xMax,i/240);
      const P = pNonlinear(EPS0*chi*E, p);
      const chiEff = P/(EPS0*E);
      xs.push(E); ys.push(chiEff);
      yMin = Math.min(yMin, chiEff);
      yMax = Math.max(yMax, chiEff);
    }
    const pad = 0.12*(yMax-yMin || 1);
    const map = drawAxes(ctx,w,h,{
      xMin,xMax,yMin:yMin-pad,yMax:yMax+pad,
      xLabel:"Field magnitude E", yLabel:"χ_eff(E)=P/(ε0E)",
      title:"Case (b): Parameter-sweep view (field-dependent χ_eff)",
      grid:true, ticks:5,
      legend:[{label:"χ_eff(E)", color:"rgba(251,191,36,0.95)"}]
    });
    drawLine(ctx, map, xs, ys, "rgba(251,191,36,0.95)", 2.4);

  }else if(c==='c'){
    // Secondary: phase of χ(ω)
    const a1 = Math.max(0, drive);
    const a2 = Math.max(0, p);
    const xMin=0, xMax=4;
    const xs=[], ys=[];
    for(let i=0;i<=260;i++){
      const wv = lerp(xMin,xMax,i/260);
      const ce = chiOmega(chi, a1, a2, wv);
      xs.push(wv); ys.push(ce.phase); // radians
    }
    const map = drawAxes(ctx,w,h,{
      xMin,xMax,yMin:-Math.PI,yMax:Math.PI,
      xLabel:"Angular frequency ω", yLabel:"arg(χ(ω))",
      yUnits:"rad",
      title:"Case (c): Phase of χ(ω) (dispersive lag)",
      grid:true, ticks:4,
      legend:[{label:"phase", color:"rgba(167,139,250,0.95)"}]
    });
    drawLine(ctx, map, xs, ys, "rgba(167,139,250,0.95)", 2.4);
    // horizontal 0 line
    ctx.strokeStyle = "rgba(255,255,255,0.20)";
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.moveTo(map.xToPx(xMin), map.yToPx(0));
    ctx.lineTo(map.xToPx(xMax), map.yToPx(0));
    ctx.stroke();

  }else if(c==='a'){
    // Secondary: compare local vs spatial-dispersive contribution fractions
    // Define f = (a k)/sqrt((ε0χ)^2 + (a k)^2)  (fraction from curl term in magnitude sense)
    const a = Math.max(0, p);
    const xMin=0, xMax=6;
    const xs=[], ys=[];
    for(let i=0;i<=260;i++){
      const k = lerp(xMin,xMax,i/260);
      const denom = Math.sqrt((EPS0*chi)**2 + (a*k)**2);
      const frac = denom>0 ? (a*k)/denom : 0;
      xs.push(k); ys.push(frac);
    }
    const map = drawAxes(ctx,w,h,{
      xMin,xMax,yMin:0,yMax:1.05,
      xLabel:"Wavevector magnitude k", yLabel:"Fraction from curl term",
      title:"Case (a): Parameter-sweep (relative importance of spatial term)",
      grid:true, ticks:5,
      legend:[{label:"(a k)/sqrt((ε0χ)^2+(a k)^2)", color:"rgba(251,191,36,0.95)"}]
    });
    drawLine(ctx, map, xs, ys, "rgba(251,191,36,0.95)", 2.4);

  }else{
    // Secondary: 2D slice along x (y=0): χ_eff(x)=a1+a2 exp(-x^2)
    const a1 = drive, a2 = p;
    const xMin=-3, xMax=3;
    const xs=[], ys=[];
    let yMin=1e9, yMax=-1e9;
    for(let i=0;i<=260;i++){
      const x = lerp(xMin,xMax,i/260);
      const ce = a1 + a2*Math.exp(-(x*x));
      xs.push(x); ys.push(ce);
      yMin = Math.min(yMin, ce);
      yMax = Math.max(yMax, ce);
    }
    const pad = 0.12*(yMax-yMin || 1);
    const map = drawAxes(ctx,w,h,{
      xMin,xMax,yMin:yMin-pad,yMax:yMax+pad,
      xLabel:"x (with y=0)", yLabel:"χ_eff(x,0)",
      title:"Case (d): 1D slice through inhomogeneity",
      grid:true, ticks:6,
      legend:[{label:"a1 + a2 e^{-x^2}", color:"rgba(167,139,250,0.95)"}]
    });
    drawLine(ctx, map, xs, ys, "rgba(167,139,250,0.95)", 2.4);
  }
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

function arrow(ctx, x0,y0,x1,y1,color, width){
  const dx = x1-x0, dy = y1-y0;
  const L = Math.hypot(dx,dy) || 1;
  const ux = dx/L, uy = dy/L;
  const head = 10, wing = 5;
  ctx.strokeStyle = color;
  ctx.lineWidth = width;
  ctx.lineCap = "round";
  ctx.beginPath();
  ctx.moveTo(x0,y0);
  ctx.lineTo(x1,y1);
  ctx.stroke();
  // head
  ctx.fillStyle = color;
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x1 - head*ux + wing*uy, y1 - head*uy - wing*ux);
  ctx.lineTo(x1 - head*ux - wing*uy, y1 - head*uy + wing*ux);
  ctx.closePath();
  ctx.fill();
}

function label(ctx, x, y, text, color){
  ctx.fillStyle = color;
  ctx.font = "12.5px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText(text, x, y);
}

function swirl(ctx, cx, cy, r, color){
  ctx.strokeStyle = color;
  ctx.lineWidth = 2.2;
  ctx.beginPath();
  ctx.arc(cx,cy,r,0.2*Math.PI,1.8*Math.PI);
  ctx.stroke();
  arrow(ctx, cx + r*Math.cos(1.8*Math.PI), cy + r*Math.sin(1.8*Math.PI),
            cx + r*Math.cos(1.8*Math.PI) + 14, cy + r*Math.sin(1.8*Math.PI) - 6,
            color, 1.8);
}

function curveIcon(ctx, x, y, w, h, color){
  ctx.strokeStyle = color;
  ctx.lineWidth = 2.2;
  ctx.beginPath();
  ctx.moveTo(x, y+h);
  ctx.bezierCurveTo(x+w*0.25, y+h*0.65, x+w*0.55, y+h*0.35, x+w, y);
  ctx.stroke();
  // axes
  ctx.strokeStyle = "rgba(255,255,255,0.18)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(x, y+h);
  ctx.lineTo(x+w, y+h);
  ctx.moveTo(x, y+h);
  ctx.lineTo(x, y);
  ctx.stroke();
}

function clock(ctx, cx, cy, r, color){
  ctx.strokeStyle = "rgba(255,255,255,0.14)";
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.arc(cx,cy,r,0,Math.PI*2);
  ctx.stroke();
  ctx.strokeStyle = color;
  ctx.lineWidth = 2.2;
  // hands
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(cx + r*0.55, cy - r*0.15);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(cx,cy);
  ctx.lineTo(cx - r*0.10, cy - r*0.60);
  ctx.stroke();
}

function gaussPatch(ctx, x, y, w, h){
  // draw a soft 2D bump
  const grd = ctx.createRadialGradient(x+w*0.5,y+h*0.5, 4, x+w*0.5,y+h*0.5, Math.max(w,h)*0.55);
  grd.addColorStop(0, "rgba(110,231,255,0.26)");
  grd.addColorStop(1, "rgba(110,231,255,0.02)");
  ctx.fillStyle = grd;
  ctx.strokeStyle = "rgba(110,231,255,0.18)";
  ctx.lineWidth = 1.2;
  roundRect(ctx, x, y, w, h, 18, true, true);
}

/* =========================
   Copy buttons
   ========================= */
async function copyText(txt){
  try{
    await navigator.clipboard.writeText(txt);
    return true;
  }catch(e){
    // fallback
    const ta = document.createElement('textarea');
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    try{ document.execCommand('copy'); }catch(_){}
    document.body.removeChild(ta);
    return true;
  }
}

copyEqBtn.addEventListener('click', async ()=>{
  await copyText(keyEqText.textContent.trim());
  flash(copyEqBtn, "Copied!");
});
copyFinalBtn.addEventListener('click', async ()=>{
  await copyText(finalAnswerText.textContent.trim());
  flash(copyFinalBtn, "Copied!");
});
resetBtn.addEventListener('click', ()=>{
  chiInput.value = 2.0;
  driveInput.value = 1.0;
  setSliderForCase(caseSelect.value);
  renderAll();
  flash(resetBtn, "Reset");
});

function flash(btn, msg){
  const old = btn.textContent;
  btn.textContent = msg;
  btn.style.borderColor = "rgba(52,211,153,0.55)";
  btn.style.background = "rgba(52,211,153,0.12)";
  setTimeout(()=>{
    btn.textContent = old;
    btn.style.borderColor = "";
    btn.style.background = "";
  }, 900);
}

/* =========================
   Render loop
   ========================= */
function renderAll(){
  updateKeyEquation();
  updateParamLabel();
  drawDiagram();
  drawMainAndSecondary();
}

caseSelect.addEventListener('change', ()=>{
  setSliderForCase(caseSelect.value);
  renderAll();
});
[paramSlider, chiInput, driveInput].forEach(el=>{
  el.addEventListener('input', renderAll);
});
window.addEventListener('resize', renderAll);

/* init */
setSliderForCase(caseSelect.value);
renderAll();
updateKeyEquation();

/* Smooth scrolling for TOC */
document.querySelectorAll('.tocCard nav a').forEach(a=>{
  a.addEventListener('click', (e)=>{
    const href = a.getAttribute('href');
    if(href && href.startsWith('#')){
      e.preventDefault();
      const el = document.querySelector(href);
      if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
    }
  });
});
</script>
</body>
</html>
