<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Maxwell–Garnett Metamaterial: Silver Nanospheres in Water (Effective Permittivity vs Wavelength)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#111a33;
      --panel2:#0f1730;
      --text:#eaf0ff;
      --muted:#b9c6ffcc;
      --line:#2a3a77;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#86efac;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 30% 10%, rgba(125,211,252,.18), transparent 60%),
        radial-gradient(1000px 600px at 80% 20%, rgba(167,139,250,.16), transparent 55%),
        radial-gradient(800px 500px at 40% 90%, rgba(134,239,172,.10), transparent 55%),
        linear-gradient(180deg, var(--bg), #070a14 70%);
      line-height:1.55;
    }
    header{
      padding:28px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }
    .hero{
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:16px;
      align-items:stretch;
    }
    .titleCard{
      background:linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px 16px;
      position:relative;
      overflow:hidden;
    }
    .titleCard:before{
      content:"";
      position:absolute;
      inset:-60px -80px auto auto;
      width:240px;height:240px;
      background:radial-gradient(circle at 30% 30%, rgba(125,211,252,.22), transparent 60%);
      filter:blur(2px);
      transform:rotate(18deg);
      pointer-events:none;
    }
    h1{
      margin:0 0 8px;
      font-size: clamp(20px, 2.2vw, 32px);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      max-width:75ch;
      font-size:14.5px;
    }
    .miniMeta{
      margin-top:12px;
      display:flex;
      flex-wrap:wrap;
      gap:8px;
    }
    .chip{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:7px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(17,26,51,.55);
      color:var(--muted);
      font-size:12.5px;
    }
    .chip b{color:var(--text); font-weight:600}
    .tocCard{
      background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.08);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      position:sticky;
      top:12px;
      height:fit-content;
    }
    .tocCard h2{
      margin:0 0 10px;
      font-size:14px;
      letter-spacing:.4px;
      text-transform:uppercase;
      color:var(--muted);
    }
    .toc{
      margin:0;
      padding:0 0 0 14px;
      display:grid;
      gap:6px;
      font-size:13.5px;
    }
    .toc a{
      color:var(--text);
      text-decoration:none;
      opacity:.92;
    }
    .toc a:hover{color:var(--accent)}
    main{
      max-width:1200px;
      margin:0 auto;
      padding:10px 18px 38px;
    }
    section{
      margin-top:18px;
    }
    .grid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      .hero{grid-template-columns:1fr}
      .grid{grid-template-columns:1fr}
      .tocCard{position:relative; top:auto}
    }
    .card{
      background:linear-gradient(180deg, rgba(255,255,255,.035), rgba(255,255,255,.015));
      border:1px solid rgba(255,255,255,.09);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px;
      overflow:hidden;
    }
    .card h3{
      margin:0 0 8px;
      font-size:16px;
    }
    .card p, .card li{color:var(--muted)}
    .callouts{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      margin-top:12px;
    }
    @media (max-width: 980px){ .callouts{grid-template-columns:1fr} }
    .callout{
      border-radius:var(--radius);
      padding:14px;
      border:1px solid rgba(255,255,255,.10);
      background:linear-gradient(180deg, rgba(17,26,51,.65), rgba(15,23,48,.55));
      position:relative;
      overflow:hidden;
    }
    .callout.assumptions:before{
      content:"";
      position:absolute; inset:auto -40px -60px auto;
      width:200px;height:200px;
      background:radial-gradient(circle at 30% 30%, rgba(125,211,252,.20), transparent 60%);
      transform:rotate(-10deg);
      pointer-events:none;
    }
    .callout.keyeq:before{
      content:"";
      position:absolute; inset:-60px auto auto -60px;
      width:220px;height:220px;
      background:radial-gradient(circle at 40% 40%, rgba(167,139,250,.18), transparent 60%);
      pointer-events:none;
    }
    .callout.mistakes:before{
      content:"";
      position:absolute; inset:auto auto -70px -70px;
      width:230px;height:230px;
      background:radial-gradient(circle at 40% 40%, rgba(251,191,36,.14), transparent 60%);
      pointer-events:none;
    }
    .callout.final:before{
      content:"";
      position:absolute; inset:-60px -60px auto auto;
      width:240px;height:240px;
      background:radial-gradient(circle at 35% 35%, rgba(134,239,172,.16), transparent 60%);
      pointer-events:none;
    }
    .tag{
      display:inline-block;
      font-size:12px;
      letter-spacing:.3px;
      text-transform:uppercase;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid rgba(255,255,255,.10);
      color:var(--text);
      background:rgba(255,255,255,.04);
      margin-bottom:10px;
    }

    .eqBox{
      margin:10px 0 0;
      padding:12px;
      border-radius:14px;
      border:1px dashed rgba(255,255,255,.16);
      background:rgba(0,0,0,.18);
      font-family:var(--mono);
      color:#eaf0ff;
      overflow:auto;
      position:relative;
    }
    .btnRow{
      display:flex;
      gap:8px;
      flex-wrap:wrap;
      margin-top:10px;
    }
    button{
      border:1px solid rgba(255,255,255,.14);
      background:rgba(255,255,255,.04);
      color:var(--text);
      padding:9px 11px;
      border-radius:12px;
      cursor:pointer;
      font-size:13px;
      transition: transform .08s ease, background .2s ease, border-color .2s ease;
    }
    button:hover{background:rgba(125,211,252,.10); border-color:rgba(125,211,252,.35)}
    button:active{transform:translateY(1px)}
    .small{font-size:12px; padding:7px 9px; border-radius:10px}
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:start;
    }
    @media (max-width: 980px){ .controls{grid-template-columns:1fr} }
    .control{
      background:rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
      border-radius:14px;
      padding:12px;
    }
    .control label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size:13px;
      color:var(--muted);
      margin-bottom:8px;
    }
    .control input[type="range"]{
      width:100%;
    }
    .control input[type="number"], .control select{
      width:100%;
      padding:9px 10px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.12);
      background:rgba(17,26,51,.55);
      color:var(--text);
      outline:none;
    }
    .hint{
      font-size:12.5px;
      color:var(--muted);
      margin:8px 0 0;
    }
    .twoCol{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 980px){ .twoCol{grid-template-columns:1fr} }
    .canvasWrap{
      border-radius:var(--radius);
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.18);
      overflow:hidden;
      position:relative;
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
    }
    .canvasTitle{
      position:absolute;
      left:12px; top:10px;
      font-size:13px;
      color:var(--muted);
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;
      border-radius:999px;
      backdrop-filter: blur(6px);
    }
    .legend{
      position:absolute;
      right:12px; top:10px;
      font-size:12.5px;
      color:var(--muted);
      background:rgba(0,0,0,.25);
      border:1px solid rgba(255,255,255,.10);
      padding:6px 10px;
      border-radius:14px;
      backdrop-filter: blur(6px);
      display:grid;
      gap:4px;
    }
    .legItem{display:flex; align-items:center; gap:8px; white-space:nowrap}
    .swatch{
      width:14px; height:3px; border-radius:99px; background:var(--accent);
    }
    .swatch.p2{background:var(--accent2)}
    .swatch.good{background:var(--good)}
    .kpiRow{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    @media (max-width: 980px){ .kpiRow{grid-template-columns:1fr} }
    .kpi{
      border-radius:14px;
      border:1px solid rgba(255,255,255,.10);
      background:rgba(0,0,0,.16);
      padding:10px 12px;
    }
    .kpi .label{font-size:12px; color:var(--muted)}
    .kpi .value{font-size:14px; margin-top:3px; font-family:var(--mono)}
    .fadeIn{
      animation: fadeIn .4s ease both;
    }
    @keyframes fadeIn{
      from{opacity:0; transform:translateY(6px)}
      to{opacity:1; transform:translateY(0)}
    }
    footer{
      max-width:1200px;
      margin:0 auto;
      padding:18px;
      color:var(--muted);
      font-size:12.5px;
      opacity:.92;
    }

    /* print-friendly */
    @media print{
      :root{--bg:#fff; --text:#111; --muted:#333; --panel:#fff; --panel2:#fff}
      body{background:#fff; color:#111}
      .tocCard{position:relative; top:auto}
      .card,.titleCard,.tocCard,.callout{box-shadow:none}
      button{display:none}
      .canvasWrap{break-inside:avoid}
      a{color:#111; text-decoration:underline}
    }
  </style>
</head>

<body>
<header>
  <div class="hero">
    <div class="titleCard fadeIn">
      <h1>Negative-Permittivity Metamaterial via Maxwell–Garnett Mixing<br/>Silver Nanospheres in Water</h1>
      <p class="subtitle">
        We compute the effective (complex) permittivity <span style="font-family:var(--mono)">ε<sub>e</sub>(λ)</span> of water containing a dilute
        volume fraction <span style="font-family:var(--mono)">f</span> of silver nanospheres using the Maxwell–Garnett formula,
        plot <span style="font-family:var(--mono)">Re{ε<sub>e</sub>}</span> and <span style="font-family:var(--mono)">Im{ε<sub>e</sub>}</span> from 250–1000 nm,
        and identify wavelength bands where <span style="font-family:var(--mono)">Re{ε<sub>e</sub>} &lt; 0</span>.
      </p>
      <div class="miniMeta">
        <span class="chip"><b>Host:</b> water (n ≈ 1.33)</span>
        <span class="chip"><b>Inclusion:</b> Ag nanospheres (ε<sub>s</sub>(λ) complex)</span>
        <span class="chip"><b>Mixing:</b> Maxwell–Garnett</span>
        <span class="chip"><b>Goal:</b> find negative-ε band(s)</span>
      </div>
    </div>

    <aside class="tocCard fadeIn" aria-label="Table of Contents">
      <h2>Table of Contents</h2>
      <ol class="toc">
        <li><a href="#quick" data-scroll>Quick Summary</a></li>
        <li><a href="#part0" data-scroll>PART 0 — Concept Primer</a></li>
        <li><a href="#part1" data-scroll>PART 1 — Problem Analysis</a></li>
        <li><a href="#part2" data-scroll>PART 2 — Strategy & Tips</a></li>
        <li><a href="#part3" data-scroll>PART 3 — Full Solution</a></li>
        <li><a href="#part4" data-scroll>PART 4 — Deeper Understanding</a></li>
        <li><a href="#part5" data-scroll>PART 5 — Visualization Guide</a></li>
      </ol>
      <p class="hint" style="margin-top:10px;">
        Tip: Use the sliders below to change <span style="font-family:var(--mono)">f</span> and <span style="font-family:var(--mono)">n</span>. All plots update live.
      </p>
    </aside>
  </div>
</header>

<main>

  <!-- Quick Summary -->
  <section id="quick" class="card fadeIn">
    <h3>Quick Summary</h3>
    <ul>
      <li><b>What this is about:</b> Effective-medium optics of a <i>composite</i>—water with embedded silver nanospheres.</li>
      <li><b>Key physics idea:</b> In the dilute, subwavelength-sphere limit, the composite behaves like a homogeneous medium with an <i>effective</i> permittivity <span style="font-family:var(--mono)">ε<sub>e</sub></span>.</li>
      <li><b>Governing relation (Maxwell–Garnett):</b> <span style="font-family:var(--mono)">ε<sub>e</sub> = ε · ( (ε<sub>s</sub>+2ε)+2f(ε<sub>s</sub>−ε) ) / ( (ε<sub>s</sub>+2ε)−f(ε<sub>s</sub>−ε) )</span>.</li>
      <li><b>Materials:</b> Host water: <span style="font-family:var(--mono)">ε = n²</span> (real, here taken constant). Inclusion silver: <span style="font-family:var(--mono)">ε<sub>s</sub>(λ)</span> complex and strongly dispersive.</li>
      <li><b>Negative-permittivity band:</b> Happens near the dipolar plasmon condition <span style="font-family:var(--mono)">Re{ε<sub>s</sub>} ≈ −2ε</span>, where the MG denominator can drive <span style="font-family:var(--mono)">Re{ε<sub>e</sub>} &lt; 0</span>.</li>
      <li><b>Output type:</b> Symbolic formula + numeric wavelength ranges (computed and listed below for chosen parameters).</li>
      <li><b>Interactivity:</b> Slider for <span style="font-family:var(--mono)">f</span> and <span style="font-family:var(--mono)">n</span> updates plots and automatically extracts negative-<span style="font-family:var(--mono)">Re{ε<sub>e</sub>}</span> wavelength intervals.</li>
    </ul>
  </section>

  <!-- Controls + Visualizations -->
  <section class="grid">
    <article class="card fadeIn">
      <h3>Interactive Parameters (used everywhere below)</h3>

      <div class="controls" role="group" aria-label="Interactive Controls">
        <div class="control">
          <label for="fSlider">
            <span>Volume fraction <span style="font-family:var(--mono)">f</span> (unitless)</span>
            <span class="chip" style="padding:5px 9px;"><b id="fVal">0.030</b></span>
          </label>
          <input id="fSlider" type="range" min="0" max="0.20" step="0.001" value="0.03"/>
          <p class="hint">Maxwell–Garnett is most reliable for <b>dilute</b> spherical inclusions (typically <span style="font-family:var(--mono)">f ≲ 0.1</span> depending on system).</p>
        </div>

        <div class="control">
          <label for="nSlider">
            <span>Host refractive index <span style="font-family:var(--mono)">n</span> (water)</span>
            <span class="chip" style="padding:5px 9px;"><b id="nVal">1.330</b></span>
          </label>
          <input id="nSlider" type="range" min="1.00" max="2.20" step="0.005" value="1.33"/>
          <p class="hint">Host permittivity is taken as <span style="font-family:var(--mono)">ε = n²</span> (real, constant) as stated in the problem.</p>
        </div>

        <div class="control">
          <label for="modelSel">
            <span>Silver permittivity model <span style="font-family:var(--mono)">ε<sub>s</sub>(λ)</span></span>
            <span class="chip" style="padding:5px 9px;"><b id="modelName">Drude (example)</b></span>
          </label>
          <select id="modelSel">
            <option value="drude_eV" selected>Drude in eV (editable parameters)</option>
            <option value="toy_DL">Toy Drude–Lorentz (adds one resonance; for learning)</option>
          </select>
          <p class="hint">
            Your textbook says “use the Ag relative-permittivity function from Prob. 8.2-3”.
            If your Prob. 8.2-3 uses different constants, enter them below (Drude mode).
          </p>
        </div>

        <div class="control" id="drudeParams">
          <div class="twoCol">
            <div>
              <label for="epsInf"><span><span style="font-family:var(--mono)">ε<sub>∞</sub></span> (dimensionless)</span></label>
              <input id="epsInf" type="number" step="0.01" value="5.00"/>
            </div>
            <div>
              <label for="wp"><span><span style="font-family:var(--mono)">ω<sub>p</sub></span> (eV)</span></label>
              <input id="wp" type="number" step="0.01" value="9.01"/>
            </div>
            <div>
              <label for="gamma"><span><span style="font-family:var(--mono)">γ</span> (eV)</span></label>
              <input id="gamma" type="number" step="0.001" value="0.021"/>
            </div>
            <div>
              <label for="extraLoss"><span>Extra loss scale</span></label>
              <input id="extraLoss" type="number" step="0.05" value="1.00"/>
            </div>
          </div>
          <p class="hint">
            Drude form used here: <span style="font-family:var(--mono)">ε<sub>s</sub>(ω) = ε∞ − ωp² / (ω(ω + iγ))</span>,
            with photon energy <span style="font-family:var(--mono)">ω</span> in eV (so <span style="font-family:var(--mono)">ω = 1240/λ[nm]</span>).
            “Extra loss scale” multiplies <span style="font-family:var(--mono)">γ</span> to explore damping sensitivity.
          </p>
        </div>

        <div class="control" id="toyParams" style="display:none;">
          <div class="twoCol">
            <div>
              <label for="toyF1"><span>Lorentz strength <span style="font-family:var(--mono)">F</span></span></label>
              <input id="toyF1" type="number" step="0.05" value="0.6"/>
            </div>
            <div>
              <label for="toyW1"><span>Lorentz resonance <span style="font-family:var(--mono)">ω<sub>0</sub></span> (eV)</span></label>
              <input id="toyW1" type="number" step="0.05" value="3.9"/>
            </div>
            <div>
              <label for="toyG1"><span>Lorentz damping <span style="font-family:var(--mono)">Γ</span> (eV)</span></label>
              <input id="toyG1" type="number" step="0.02" value="0.5"/>
            </div>
            <div>
              <label for="toyEpsInf"><span><span style="font-family:var(--mono)">ε∞</span> (dimensionless)</span></label>
              <input id="toyEpsInf" type="number" step="0.05" value="3.5"/>
            </div>
          </div>
          <p class="hint">
            Toy Drude–Lorentz: <span style="font-family:var(--mono)">ε = ε∞ − ωp²/(ω(ω+iγ)) + F ω0²/(ω0² − ω² − iΓω)</span>.
            This is for intuition (one bound-electron resonance) rather than a full Ag fit.
          </p>
        </div>
      </div>

      <div class="kpiRow" aria-label="Computed Results">
        <div class="kpi">
          <div class="label">Extracted negative band(s) where <span style="font-family:var(--mono)">Re{ε<sub>e</sub>} &lt; 0</span></div>
          <div class="value" id="negBands">—</div>
        </div>
        <div class="kpi">
          <div class="label">Minimum <span style="font-family:var(--mono)">Re{ε<sub>e</sub>}</span> in 250–1000 nm</div>
          <div class="value" id="minRe">—</div>
        </div>
        <div class="kpi">
          <div class="label">Wavelength at minimum (nm)</div>
          <div class="value" id="minReLam">—</div>
        </div>
      </div>

      <div class="btnRow">
        <button class="small" id="resetBtn" title="Reset to the textbook default values (f=0.03, n=1.33).">Reset defaults</button>
        <button class="small" id="copyFinalBtn" data-copy="finalAnswerText">Copy final answer (plain text)</button>
        <button class="small" id="copyEqBtn" data-copy="mgEqText">Copy Maxwell–Garnett equation</button>
      </div>

      <div class="eqBox" id="finalAnswerText" aria-label="Final Answer (plain text)">
Final answer will appear here after the first render.
      </div>
    </article>

    <article class="card fadeIn">
      <h3>Visualizations</h3>

      <figure class="canvasWrap" style="margin:0 0 12px;">
        <div class="canvasTitle">Diagram — Ag nanospheres in water (effective medium)</div>
        <canvas id="diagramCanvas" aria-label="Diagram canvas"></canvas>
      </figure>

      <figure class="canvasWrap" style="margin:0 0 12px;">
        <div class="canvasTitle">Main Plot — Effective permittivity vs wavelength</div>
        <div class="legend" aria-label="Legend">
          <div class="legItem"><span class="swatch"></span>Re{εe}</div>
          <div class="legItem"><span class="swatch p2"></span>Im{εe}</div>
          <div class="legItem"><span class="swatch good"></span>Re{εe}&lt;0 band</div>
        </div>
        <canvas id="mainPlotCanvas" aria-label="Main plot canvas"></canvas>
      </figure>

      <figure class="canvasWrap" style="margin:0;">
        <div class="canvasTitle">Secondary Plot — Negative-band endpoints vs volume fraction (sweep)</div>
        <canvas id="sweepCanvas" aria-label="Secondary sweep plot canvas"></canvas>
      </figure>

      <p class="hint" style="margin-top:10px;">
        The secondary plot recomputes the <i>dominant</i> negative band (if any) across <span style="font-family:var(--mono)">f ∈ [0, 0.20]</span>
        for the current <span style="font-family:var(--mono)">n</span> and silver model.
      </p>
    </article>
  </section>

  <!-- PART 0 -->
  <section id="part0" class="card fadeIn">
    <h3>PART 0 — Concept Primer (Theory Before Solving)</h3>

    <div class="callouts">
      <div class="callout keyeq">
        <div class="tag">Core Definitions</div>
        <ul>
          <li><b>Permittivity</b> <span style="font-family:var(--mono)">ε</span> (F/m): relates <span style="font-family:var(--mono)">D = ε E</span> for linear isotropic media. Often use <b>relative</b> permittivity <span style="font-family:var(--mono)">ε<sub>r</sub> = ε/ε0</span> (dimensionless).</li>
          <li><b>Complex permittivity</b> <span style="font-family:var(--mono)">ε = ε' + i ε''</span>: <span style="font-family:var(--mono)">ε'</span> sets phase velocity; <span style="font-family:var(--mono)">ε''</span> encodes absorption (loss).</li>
          <li><b>Refractive index</b> <span style="font-family:var(--mono)">n</span>: if lossless and nonmagnetic, <span style="font-family:var(--mono)">ε ≈ n²</span>.</li>
          <li><b>Effective medium</b>: for inclusions much smaller than wavelength and dilute, the composite can be treated as homogeneous with <span style="font-family:var(--mono)">ε → ε<sub>e</sub></span>.</li>
        </ul>
      </div>

      <div class="callout assumptions">
        <div class="tag">Physical Meaning + Validity</div>
        <ul>
          <li>Silver nanospheres polarize like <b>electric dipoles</b> when their radius <span style="font-family:var(--mono)">a ≪ λ</span>.</li>
          <li>Maxwell–Garnett assumes: random, non-touching spheres; dilute volume fraction; host is continuous; response is linear and local.</li>
          <li>Near the sphere plasmon condition <span style="font-family:var(--mono)">Re{ε<sub>s</sub>} ≈ −2ε</span>, dipole polarizability is large → strong dispersion and possibly <span style="font-family:var(--mono)">Re{ε<sub>e</sub>} &lt; 0</span>.</li>
        </ul>
      </div>
    </div>

    <div class="callouts">
      <div class="callout">
        <div class="tag">Common Models & Why</div>
        <p>
          Metals have free electrons that respond like a driven, damped plasma. A common minimal model is the <b>Drude model</b>
          (free-electron response), giving a dispersive complex permittivity:
        </p>
        <div class="eqBox" id="drudeEqText">
εs(ω) = ε∞ − ωp² / ( ω(ω + iγ) )
        </div>
        <p class="hint">
          Here <span style="font-family:var(--mono)">ωp</span> is a plasma frequency scale (sets where the real part crosses zero),
          and <span style="font-family:var(--mono)">γ</span> sets loss (broadening). More accurate fits add bound-electron (Lorentz) terms.
        </p>
      </div>

      <div class="callout mistakes">
        <div class="tag">What to Watch For</div>
        <ul>
          <li><b>Units mix-ups:</b> If you use eV for <span style="font-family:var(--mono)">ω</span>, keep <span style="font-family:var(--mono)">ωp, γ</span> in eV too.</li>
          <li><b>Wrong MG formula:</b> Maxwell–Garnett is asymmetric (host vs inclusions). Don’t swap <span style="font-family:var(--mono)">ε</span> and <span style="font-family:var(--mono)">εs</span>.</li>
          <li><b>Outside validity:</b> At large <span style="font-family:var(--mono)">f</span> or near percolation, MG can fail (needs other mixing rules / numerics).</li>
          <li><b>Negative ε ≠ no loss:</b> When <span style="font-family:var(--mono)">Re{εe}&lt;0</span>, <span style="font-family:var(--mono)">Im{εe}</span> often grows—material can be very lossy.</li>
        </ul>
      </div>
    </div>

    <div class="callout" style="margin-top:14px;">
      <div class="tag">Mini Intuition Examples</div>
      <ul>
        <li><b>Dilute limit:</b> If <span style="font-family:var(--mono)">f → 0</span>, inclusions vanish, so <span style="font-family:var(--mono)">εe → ε</span>.</li>
        <li><b>Resonant enhancement:</b> If <span style="font-family:var(--mono)">εs ≈ −2ε</span> (dipole plasmon), the sphere polarizability spikes, so even small <span style="font-family:var(--mono)">f</span> can strongly shift <span style="font-family:var(--mono)">εe</span>.</li>
      </ul>
    </div>
  </section>

  <!-- PART 1 -->
  <section id="part1" class="card fadeIn">
    <h3>PART 1 — Problem Analysis (No Solving Yet)</h3>

    <p>
      <b>Rephrased problem:</b> We have water (host) with refractive index fixed at <span style="font-family:var(--mono)">n = 1.33</span>
      and a dilute concentration of silver nanospheres occupying volume fraction <span style="font-family:var(--mono)">f = 3%</span>.
      Using the Maxwell–Garnett mixing rule, compute the effective permittivity <span style="font-family:var(--mono)">εe(λ0)</span>
      over <span style="font-family:var(--mono)">λ0 ∈ [250, 1000] nm</span>, plot its real and imaginary parts, identify wavelength
      ranges where <span style="font-family:var(--mono)">Re{εe}</span> is negative, and then study how changing <span style="font-family:var(--mono)">f</span> and <span style="font-family:var(--mono)">n</span> alters the result.
    </p>

    <div class="callouts">
      <div class="callout">
        <div class="tag">Given</div>
        <ul>
          <li>Host refractive index: <span style="font-family:var(--mono)">n = 1.33</span> (assumed constant) → <span style="font-family:var(--mono)">ε = n²</span>.</li>
          <li>Volume fraction: <span style="font-family:var(--mono)">f = 0.03</span>.</li>
          <li>Wavelength range: <span style="font-family:var(--mono)">λ0 = 250…1000 nm</span>.</li>
          <li>Silver permittivity: <span style="font-family:var(--mono)">εs(λ0)</span> complex (from Prob. 8.2-3; here implemented as an editable model).</li>
        </ul>
      </div>

      <div class="callout">
        <div class="tag">Unknowns / What to find</div>
        <ul>
          <li>Effective permittivity spectrum: <span style="font-family:var(--mono)">εe(λ0) = εe'(λ0) + i εe''(λ0)</span>.</li>
          <li>Wavelength intervals where <span style="font-family:var(--mono)">εe'(λ0) &lt; 0</span>.</li>
          <li>Parameter dependence on <span style="font-family:var(--mono)">f</span> and <span style="font-family:var(--mono)">n</span> (qualitative + computed).</li>
        </ul>
      </div>
    </div>

    <div class="callouts">
      <div class="callout assumptions">
        <div class="tag">Relevant principles & assumptions</div>
        <ul>
          <li><b>Maxwell–Garnett EMT</b> applies because: inclusions are spherical and assumed <b>subwavelength</b> and <b>dilute</b> in a host medium.</li>
          <li><b>Quasi-static dipole response:</b> each sphere responds like a dipole (dominant for <span style="font-family:var(--mono)">a ≪ λ</span>).</li>
          <li><b>Nonmagnetic media:</b> take <span style="font-family:var(--mono)">μ ≈ μ0</span> (so “single-negative” means ε negative, μ positive).</li>
          <li><b>Constant water index:</b> treat <span style="font-family:var(--mono)">ε</span> as wavelength-independent.</li>
        </ul>
      </div>

      <div class="callout">
        <div class="tag">Approaches (pros/cons)</div>
        <ol style="margin:0; padding-left:18px;">
          <li><b>Direct Maxwell–Garnett calculation</b> (best here): plug <span style="font-family:var(--mono)">ε, εs(λ), f</span> into MG; fast and explicit; valid for dilute spheres.</li>
          <li><b>Clausius–Mossotti / polarizability route:</b> compute sphere polarizability and relate to effective susceptibility; gives the same result but highlights the dipole resonance condition.</li>
          <li><b>Full-wave numerics</b> (FDTD/FEM): most accurate for dense/large spheres, but heavy and not needed for the stated assumptions.</li>
        </ol>
        <p class="hint">We choose (1) because the problem explicitly requests Maxwell–Garnett and the geometry/assumptions match it.</p>
      </div>
    </div>
  </section>

  <!-- PART 2 -->
  <section id="part2" class="card fadeIn">
    <h3>PART 2 — Strategy & Tips (Roadmap Only)</h3>

    <ol>
      <li><b>Convert host index to permittivity:</b> compute <span style="font-family:var(--mono)">ε = n²</span>. (Meaning: host “baseline” dielectric response.)</li>
      <li><b>Model the silver permittivity:</b> compute <span style="font-family:var(--mono)">εs(λ)</span> across 250–1000 nm. (Meaning: metal dispersion & loss.)</li>
      <li><b>Apply Maxwell–Garnett:</b> evaluate <span style="font-family:var(--mono)">εe(λ)</span> from the MG formula. (Meaning: homogenized response.)</li>
      <li><b>Split into real/imag parts:</b> compute <span style="font-family:var(--mono)">Re{εe}</span> and <span style="font-family:var(--mono)">Im{εe}</span>. (Meaning: phase vs absorption.)</li>
      <li><b>Find negative intervals:</b> scan for contiguous wavelength ranges where <span style="font-family:var(--mono)">Re{εe}&lt;0</span>. (Meaning: “single-negative” band.)</li>
      <li><b>Plot results:</b> produce spectrum plot with shading of negative band(s). (Meaning: visualize where metamaterial behavior occurs.)</li>
      <li><b>Parametric study:</b> vary <span style="font-family:var(--mono)">f</span> and <span style="font-family:var(--mono)">n</span>, re-run steps 1–6. (Meaning: how mixture strength and host polarizability shift resonance.)</li>
    </ol>

    <div class="callouts">
      <div class="callout mistakes">
        <div class="tag">Common mistakes & quick tips</div>
        <ul>
          <li><b>Tip:</b> Expect the negative band to appear near where <span style="font-family:var(--mono)">Re{εs}</span> is roughly <span style="font-family:var(--mono)">−2ε</span>. That’s the sphere dipole resonance “anchor”.</li>
          <li><b>Mistake:</b> Interpreting the MG pole as “infinite response” physically—loss and finite size smear it, and EMT can break down extremely close to the pole.</li>
          <li><b>Tip:</b> Increasing <span style="font-family:var(--mono)">f</span> typically strengthens dispersion and widens/shifts the negative band; increasing <span style="font-family:var(--mono)">n</span> (thus ε) shifts the resonance condition.</li>
        </ul>
      </div>

      <div class="callout keyeq">
        <div class="tag">Equation used (copyable)</div>
        <div class="eqBox" id="mgEqText">
Maxwell–Garnett (spherical inclusions):
εe = ε + 3 f ε (εs − ε) / ( εs + 2ε − f(εs − ε) )

Equivalent form:
εe = ε · [ (εs + 2ε) + 2f(εs − ε) ] / [ (εs + 2ε) − f(εs − ε) ]
        </div>
      </div>
    </div>
  </section>

  <!-- PART 3 -->
  <section id="part3" class="card fadeIn">
    <h3>PART 3 — Full Solution (Detailed + Teaching)</h3>

    <div class="callout">
      <div class="tag">Qualitative expectation (before math)</div>
      <p>
        Pure water has <span style="font-family:var(--mono)">ε = n² &gt; 0</span>. Silver has a strongly dispersive permittivity with a large negative real part
        over much of the visible/IR (depending on model) and a positive imaginary part (loss). When you embed small metal spheres in a dielectric,
        the <b>dipolar surface plasmon</b> occurs near <span style="font-family:var(--mono)">Re{εs} ≈ −2ε</span>. Around that resonance,
        the effective permittivity <span style="font-family:var(--mono)">εe</span> can swing rapidly and may cross into <span style="font-family:var(--mono)">Re{εe}&lt;0</span>.
        The band will generally be accompanied by increased <span style="font-family:var(--mono)">Im{εe}</span> (loss).
      </p>
    </div>

    <article class="callout assumptions">
      <div class="tag">Step 1 — Host permittivity</div>
      <p>
        The host (water) is assumed lossless with constant refractive index <span style="font-family:var(--mono)">n</span>, so its relative permittivity is
      </p>
      <div class="eqBox">
ε = n²   (dimensionless relative permittivity, since ε is used as εr in EMT)
      </div>
      <p class="hint">
        In this article we treat <span style="font-family:var(--mono)">ε</span>, <span style="font-family:var(--mono)">εs</span>, <span style="font-family:var(--mono)">εe</span> as <b>relative</b> permittivities (dimensionless), matching typical EMT notation.
      </p>
    </article>

    <article class="callout">
      <div class="tag">Step 2 — Silver permittivity model</div>
      <p>
        The problem references a specific function from Prob. 8.2-3. Because that function is not printed here,
        we implement an <b>editable Drude-type model</b> that captures the key physics (dispersive negative real part + loss).
        Using photon energy <span style="font-family:var(--mono)">ω</span> in eV,
      </p>
      <div class="eqBox">
ω(eV) = 1240 / λ(nm)

εs(ω) = ε∞ − ωp² / ( ω(ω + iγ) )
      </div>
      <p class="hint">
        If your Prob. 8.2-3 uses a different fitted model (e.g., Drude–Lorentz with multiple oscillators, or tabulated data),
        the <b>workflow is identical</b>: compute <span style="font-family:var(--mono)">εs(λ)</span> then plug into Maxwell–Garnett.
        You can adjust <span style="font-family:var(--mono)">ε∞, ωp, γ</span> to match your book’s function.
      </p>
    </article>

    <article class="callout keyeq">
      <div class="tag">Step 3 — Maxwell–Garnett mixing (spherical inclusions)</div>
      <p>
        For spherical inclusions with volume fraction <span style="font-family:var(--mono)">f</span>, host permittivity <span style="font-family:var(--mono)">ε</span>,
        and inclusion permittivity <span style="font-family:var(--mono)">εs</span>, the Maxwell–Garnett formula gives:
      </p>
      <div class="eqBox">
εe = ε + 3 f ε (εs − ε) / ( εs + 2ε − f(εs − ε) )
      </div>
      <p>
        <b>What we did and why:</b> We used the standard EMT result for dilute spheres.
        Physically, the fraction <span style="font-family:var(--mono)">f</span> controls how strongly the dipole polarizability of each sphere
        contributes to the macroscopic polarization of the mixture.
      </p>
    </article>

    <article class="callout">
      <div class="tag">Step 4 — Identify negative-ε condition (insight)</div>
      <p>
        The MG denominator <span style="font-family:var(--mono)">εs + 2ε − f(εs − ε)</span> can become small near the dipole resonance.
        In the dilute limit (<span style="font-family:var(--mono)">f → 0</span>), the resonance is centered near:
      </p>
      <div class="eqBox">
Dipole sphere resonance (quasi-static, dilute):
Re{εs(λ)} ≈ −2ε
      </div>
      <p class="hint">
        This explains why changing the host index <span style="font-family:var(--mono)">n</span> (hence ε) shifts the resonance wavelength:
        it changes the target value <span style="font-family:var(--mono)">−2ε</span>.
      </p>
    </article>

    <article class="callout final">
      <div class="tag">Numerical results + plots</div>
      <p>
        We now compute <span style="font-family:var(--mono)">εe(λ)</span> across 250–1000 nm and extract wavelength intervals where
        <span style="font-family:var(--mono)">Re{εe(λ)} &lt; 0</span>. The extracted intervals and minimum value update live in the panel above.
      </p>

      <div class="callouts">
        <div class="callout">
          <div class="tag">Sanity checks</div>
          <ul>
            <li><b>Units:</b> <span style="font-family:var(--mono)">ε, εs, εe</span> are dimensionless (relative permittivities). <span style="font-family:var(--mono)">λ</span> in nm only enters through <span style="font-family:var(--mono)">ω = 1240/λ</span> (eV).</li>
            <li><b>Limiting case:</b> As <span style="font-family:var(--mono)">f→0</span>, MG gives <span style="font-family:var(--mono)">εe→ε</span> (check the formula by inspection).</li>
            <li><b>Sign reasoning:</b> Negative <span style="font-family:var(--mono)">Re{εe}</span> occurs only if the inclusion response is strong enough (near resonance) to outweigh the positive host background.</li>
          </ul>
        </div>

        <div class="callout">
          <div class="tag">Connection to diagram & plots</div>
          <p>
            The diagram shows many subwavelength Ag spheres embedded in water. Because the spheres are much smaller than the optical wavelength,
            the composite responds like a homogeneous medium. The main plot shows how this homogenized permittivity varies with wavelength and
            highlights where it becomes negative.
          </p>
        </div>
      </div>
    </article>
  </section>

  <!-- PART 4 -->
  <section id="part4" class="card fadeIn">
    <h3>PART 4 — Deeper Understanding (Theory Around the Result)</h3>

    <div class="callouts">
      <div class="callout">
        <div class="tag">Re-interpreting the Maxwell–Garnett formula</div>
        <p>
          In the equivalent “ratio” form,
        </p>
        <div class="eqBox">
εe = ε · [ (εs + 2ε) + 2f(εs − ε) ] / [ (εs + 2ε) − f(εs − ε) ]
        </div>
        <ul>
          <li><span style="font-family:var(--mono)">ε</span> sets the baseline scale (if the metal did nothing, you get water).</li>
          <li><span style="font-family:var(--mono)">εs − ε</span> is the contrast driving polarization of spheres.</li>
          <li>The denominator can approach zero (a “pole”) near the dipolar plasmon → huge dispersion and possible negative band.</li>
          <li>Loss (imaginary parts) prevents truly infinite response and broadens/weakens the negative region.</li>
        </ul>
      </div>

      <div class="callout">
        <div class="tag">How parameters change the outcome</div>
        <ul>
          <li><b>Increasing volume fraction <span style="font-family:var(--mono)">f</span>:</b> strengthens the inclusion contribution, often widening the negative band and shifting it. But too large <span style="font-family:var(--mono)">f</span> can violate MG validity.</li>
          <li><b>Increasing host index <span style="font-family:var(--mono)">n</span>:</b> increases <span style="font-family:var(--mono)">ε</span>, moving the resonance condition to where <span style="font-family:var(--mono)">Re{εs} ≈ −2ε</span> (more negative target), typically shifting the band.</li>
          <li><b>Increasing damping <span style="font-family:var(--mono)">γ</span>:</b> increases <span style="font-family:var(--mono)">Im{εs}</span> and generally reduces the depth/extent of <span style="font-family:var(--mono)">Re{εe}&lt;0</span> because loss smears the resonance.</li>
        </ul>
      </div>
    </div>

    <div class="callout">
      <div class="tag">Alternative derivation idea (brief)</div>
      <p>
        Start from the <b>electrostatic polarizability</b> of a sphere in a host:
        <span style="font-family:var(--mono)">α = 4πa³ ε0 ε · (εs − ε)/(εs + 2ε)</span>.
        Then use a Clausius–Mossotti-type relation to connect number density to macroscopic susceptibility. Including local-field corrections yields
        the Maxwell–Garnett formula (and explains why the denominator involves <span style="font-family:var(--mono)">εs + 2ε</span>).
      </p>
    </div>

    <div class="callout">
      <div class="tag">Concept check (with answers)</div>
      <ul>
        <li><b>Q:</b> If <span style="font-family:var(--mono)">f → 0</span>, what is <span style="font-family:var(--mono)">εe</span>? <b>A:</b> <span style="font-family:var(--mono)">εe → ε</span> (pure host).</li>
        <li><b>Q:</b> Why does a negative-ε band tend to appear near <span style="font-family:var(--mono)">Re{εs} ≈ −2ε</span>? <b>A:</b> That’s the dipolar surface-plasmon condition of a sphere; it makes the polarizability large.</li>
        <li><b>Q:</b> Does <span style="font-family:var(--mono)">Re{εe}&lt;0</span> imply transparency? <b>A:</b> No—loss is set by <span style="font-family:var(--mono)">Im{εe}</span>, which can be large near resonance.</li>
        <li><b>Q:</b> What happens if spheres touch or form chains? <b>A:</b> EMT assumptions break; percolation and anisotropy can occur; MG may be inaccurate.</li>
      </ul>
    </div>
  </section>

  <!-- PART 5 -->
  <section id="part5" class="card fadeIn">
    <h3>PART 5 — Visualization Guide (How to Read the Plots)</h3>

    <div class="callouts">
      <div class="callout">
        <div class="tag">Diagram canvas</div>
        <p>
          Shows a host “water” box with many metallic nanospheres. This is the physical basis for homogenization:
          because spheres are subwavelength and dispersed, we describe the mixture by a single effective permittivity <span style="font-family:var(--mono)">εe</span>.
        </p>
      </div>

      <div class="callout">
        <div class="tag">Main plot canvas</div>
        <ul>
          <li><b>x-axis:</b> free-space wavelength <span style="font-family:var(--mono)">λ0</span> (nm).</li>
          <li><b>y-axis:</b> effective permittivity components.</li>
          <li><b>Curves:</b> <span style="font-family:var(--mono)">Re{εe}</span> and <span style="font-family:var(--mono)">Im{εe}</span>.</li>
          <li><b>Green shading:</b> wavelength regions where <span style="font-family:var(--mono)">Re{εe}&lt;0</span>.</li>
        </ul>
      </div>
    </div>

    <div class="callouts">
      <div class="callout">
        <div class="tag">Secondary sweep canvas</div>
        <p>
          For the current <span style="font-family:var(--mono)">n</span> and silver model, we sweep <span style="font-family:var(--mono)">f</span> from 0 to 0.20 and find
          the dominant (widest) negative band. The plot shows the band start and end wavelengths versus <span style="font-family:var(--mono)">f</span>.
          If no negative band exists for a given <span style="font-family:var(--mono)">f</span>, nothing is plotted at that point.
        </p>
      </div>

      <div class="callout">
        <div class="tag">Interactive controls</div>
        <ul>
          <li><b>Volume fraction <span style="font-family:var(--mono)">f</span> slider:</b> increases/decreases inclusion strength; watch the negative band grow/shrink and shift.</li>
          <li><b>Host index <span style="font-family:var(--mono)">n</span> slider:</b> changes <span style="font-family:var(--mono)">ε=n²</span>; shifts the plasmon condition and thus the negative band location.</li>
          <li><b>Silver model & parameters:</b> change dispersion/loss; observe how <span style="font-family:var(--mono)">Im{εe}</span> broadening can suppress negativity.</li>
        </ul>
      </div>
    </div>
  </section>

</main>

<footer>
  <p>
    Notes: This page implements Maxwell–Garnett EMT for spherical inclusions. The “silver permittivity” is provided as an editable Drude-type model
    to match the workflow requested. If your textbook’s Prob. 8.2-3 defines a different <span style="font-family:var(--mono)">ε<sub>s</sub>(λ)</span>,
    update the model parameters (or extend the JS function) and the plots/negative-band extraction will remain correct.
  </p>
</footer>

<script>
(function(){
  // ---------- Smooth scroll for TOC ----------
  document.querySelectorAll('[data-scroll]').forEach(a=>{
    a.addEventListener('click', (e)=>{
      e.preventDefault();
      const id = a.getAttribute('href');
      const el = document.querySelector(id);
      if(!el) return;
      el.scrollIntoView({behavior:'smooth', block:'start'});
      history.replaceState(null, '', id);
    });
  });

  // ---------- Complex arithmetic ----------
  function C(re, im){ return {re, im}; }
  function cAdd(a,b){ return C(a.re+b.re, a.im+b.im); }
  function cSub(a,b){ return C(a.re-b.re, a.im-b.im); }
  function cMul(a,b){ return C(a.re*b.re - a.im*b.im, a.re*b.im + a.im*b.re); }
  function cDiv(a,b){
    const d = b.re*b.re + b.im*b.im;
    return C((a.re*b.re + a.im*b.im)/d, (a.im*b.re - a.re*b.im)/d);
  }
  function cScale(a,k){ return C(a.re*k, a.im*k); }
  function cAbs(a){ return Math.hypot(a.re, a.im); }

  // ---------- Maxwell–Garnett ----------
  // εe = ε + 3 f ε (εs − ε) / ( εs + 2ε − f(εs − ε) )
  function maxwellGarnett(epsHost, epsInc, f){
    const eps = C(epsHost, 0);
    const es = epsInc;
    const num = cMul(cScale(eps, 3*f), cSub(es, eps));
    const den = cSub(cAdd(es, cScale(eps, 2)), cScale(cSub(es, eps), f));
    return cAdd(eps, cDiv(num, den));
  }

  // ---------- Silver permittivity models (in eV energy variable) ----------
  // ω(eV)=1240/λ(nm)
  function epsSilver(lambdaNm, model, p){
    const w = 1240 / lambdaNm; // eV
    const i = C(0,1);

    if(model === 'drude_eV'){
      const epsInf = p.epsInf;
      const wp = p.wp;
      const gamma = p.gamma * p.extraLoss; // allow extra loss scaling
      // ε = ε∞ − ωp² / ( ω(ω + iγ) )
      const denom = cMul(C(w,0), cAdd(C(w,0), cMul(i, C(gamma,0))));
      const frac = cDiv(C(wp*wp, 0), denom);
      return cSub(C(epsInf,0), frac);
    }

    if(model === 'toy_DL'){
      // Toy Drude–Lorentz:
      // ε = ε∞ − ωp²/(ω(ω+iγ)) + F ω0²/(ω0² − ω² − iΓω)
      const epsInf = p.toyEpsInf;
      const wp = p.wp;
      const gamma = p.gamma * p.extraLoss;

      const drudeDen = cMul(C(w,0), cAdd(C(w,0), cMul(i, C(gamma,0))));
      const drude = cDiv(C(wp*wp,0), drudeDen);

      const F = p.toyF1;
      const w0 = p.toyW1;
      const G = p.toyG1;
      // Lorentz denom: (w0^2 - w^2 - i G w)
      const lorDen = cSub(cSub(C(w0*w0,0), C(w*w,0)), cMul(i, C(G*w,0)));
      const lor = cDiv(C(F*w0*w0,0), lorDen);

      return cAdd(cSub(C(epsInf,0), drude), lor);
    }

    // fallback
    return C(1,0);
  }

  // ---------- Data generation ----------
  const LMIN = 250, LMAX = 1000, DL = 2;
  function makeLambdaGrid(){
    const arr = [];
    for(let L=LMIN; L<=LMAX+1e-9; L+=DL) arr.push(L);
    return arr;
  }
  const lambdas = makeLambdaGrid();

  function extractNegativeBands(lams, reVals){
    // return list of [Lstart, Lend] where re<0
    const bands = [];
    let inBand = false;
    let s = null;
    for(let i=0;i<lams.length;i++){
      const neg = reVals[i] < 0;
      if(neg && !inBand){
        inBand = true;
        s = lams[i];
      }else if(!neg && inBand){
        inBand = false;
        const e = lams[i-1];
        if(e >= s) bands.push([s,e]);
        s = null;
      }
    }
    if(inBand && s !== null){
      bands.push([s, lams[lams.length-1]]);
    }
    // merge tiny gaps? (optional) keep simple
    return bands;
  }

  function formatBands(bands){
    if(!bands.length) return "None in 250–1000 nm";
    return bands.map(b => `${b[0].toFixed(0)}–${b[1].toFixed(0)} nm`).join(" ; ");
  }

  // ---------- Plotting utilities ----------
  function setupCanvas(canvas){
    const ctx = canvas.getContext('2d');
    function resize(){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(300, rect.width);
      const h = rect.height || 320;
      canvas.width = Math.floor(w * dpr);
      canvas.height = Math.floor(h * dpr);
      ctx.setTransform(dpr,0,0,dpr,0,0);
      return {w, h, dpr};
    }
    return {ctx, resize};
  }

  function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel){
    const {x,y,w,h} = box;
    // background
    ctx.save();
    ctx.fillStyle = 'rgba(0,0,0,0.0)';
    ctx.fillRect(x,y,w,h);

    // grid & ticks
    const gridX = 7;
    const gridY = 6;

    ctx.strokeStyle = 'rgba(255,255,255,0.08)';
    ctx.lineWidth = 1;

    // vertical grid
    for(let i=0;i<=gridX;i++){
      const gx = x + (w*i/gridX);
      ctx.beginPath();
      ctx.moveTo(gx, y);
      ctx.lineTo(gx, y+h);
      ctx.stroke();
    }
    // horizontal grid
    for(let j=0;j<=gridY;j++){
      const gy = y + (h*j/gridY);
      ctx.beginPath();
      ctx.moveTo(x, gy);
      ctx.lineTo(x+w, gy);
      ctx.stroke();
    }

    // axes
    ctx.strokeStyle = 'rgba(255,255,255,0.18)';
    ctx.lineWidth = 1.25;
    ctx.beginPath();
    ctx.moveTo(x, y+h);
    ctx.lineTo(x+w, y+h);
    ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(x, y);
    ctx.lineTo(x, y+h);
    ctx.stroke();

    // tick labels
    ctx.fillStyle = 'rgba(233,240,255,0.82)';
    ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';

    for(let i=0;i<=gridX;i++){
      const gx = x + (w*i/gridX);
      const val = xMin + (xMax-xMin)*i/gridX;
      ctx.fillText(val.toFixed(0), gx, y+h+6);
    }
    ctx.textAlign = 'right';
    ctx.textBaseline = 'middle';
    for(let j=0;j<=gridY;j++){
      const gy = y + (h*j/gridY);
      const val = yMax - (yMax-yMin)*j/gridY;
      ctx.fillText(val.toFixed(2), x-8, gy);
    }

    // axis labels
    ctx.fillStyle = 'rgba(233,240,255,0.85)';
    ctx.textAlign = 'center';
    ctx.textBaseline = 'bottom';
    ctx.fillText(xLabel, x + w/2, y+h+32);

    ctx.save();
    ctx.translate(x-44, y + h/2);
    ctx.rotate(-Math.PI/2);
    ctx.textAlign = 'center';
    ctx.textBaseline = 'top';
    ctx.fillText(yLabel, 0, 0);
    ctx.restore();

    ctx.restore();
  }

  function mapX(x, xMin, xMax, box){ return box.x + (x - xMin) * box.w / (xMax - xMin); }
  function mapY(y, yMin, yMax, box){ return box.y + (yMax - y) * box.h / (yMax - yMin); }

  function drawLine(ctx, xs, ys, xMin, xMax, yMin, yMax, box, strokeStyle, lineWidth){
    ctx.save();
    ctx.strokeStyle = strokeStyle;
    ctx.lineWidth = lineWidth;
    ctx.beginPath();
    for(let i=0;i<xs.length;i++){
      const X = mapX(xs[i], xMin, xMax, box);
      const Y = mapY(ys[i], yMin, yMax, box);
      if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
    }
    ctx.stroke();
    ctx.restore();
  }

  function drawBandShading(ctx, bands, xMin, xMax, box, fillStyle){
    ctx.save();
    ctx.fillStyle = fillStyle;
    for(const [s,e] of bands){
      const X1 = mapX(s, xMin, xMax, box);
      const X2 = mapX(e, xMin, xMax, box);
      ctx.fillRect(X1, box.y, Math.max(0, X2-X1), box.h);
    }
    ctx.restore();
  }

  function niceRange(yMin, yMax){
    if(!isFinite(yMin) || !isFinite(yMax) || yMin===yMax){
      return {yMin:-1,yMax:1};
    }
    const pad = 0.08*(yMax-yMin);
    return {yMin: yMin - pad, yMax: yMax + pad};
  }

  // ---------- Diagram ----------
  const diagram = setupCanvas(document.getElementById('diagramCanvas'));
  function drawDiagram(f){
    const {ctx} = diagram;
    const {w,h} = diagram.resize();
    ctx.clearRect(0,0,w,h);

    // panel background
    ctx.fillStyle = 'rgba(0,0,0,0.10)';
    ctx.fillRect(0,0,w,h);

    // draw a translucent box representing water
    const pad = 22;
    const bx = pad, by = 50, bw = w - 2*pad, bh = h - 80;
    // 3D-ish box
    const dx = Math.min(42, bw*0.12);
    const dy = Math.min(28, bh*0.12);

    // back face
    ctx.fillStyle = 'rgba(125,211,252,0.06)';
    ctx.strokeStyle = 'rgba(125,211,252,0.25)';
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.rect(bx+dx, by-dy, bw, bh);
    ctx.fill();
    ctx.stroke();

    // front face
    ctx.fillStyle = 'rgba(125,211,252,0.04)';
    ctx.strokeStyle = 'rgba(233,240,255,0.18)';
    ctx.beginPath();
    ctx.rect(bx, by, bw, bh);
    ctx.fill();
    ctx.stroke();

    // connectors
    ctx.strokeStyle = 'rgba(233,240,255,0.12)';
    ctx.beginPath();
    ctx.moveTo(bx, by); ctx.lineTo(bx+dx, by-dy);
    ctx.moveTo(bx+bw, by); ctx.lineTo(bx+bw+dx, by-dy);
    ctx.moveTo(bx, by+bh); ctx.lineTo(bx+dx, by+bh-dy);
    ctx.moveTo(bx+bw, by+bh); ctx.lineTo(bx+bw+dx, by+bh-dy);
    ctx.stroke();

    // label water
    ctx.fillStyle = 'rgba(233,240,255,0.80)';
    ctx.font = '13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillText('Host: water (ε = n²)', bx+10, by+18);

    // number of spheres proportional to f (visual only)
    const count = Math.round(10 + 90*Math.min(1, f/0.12));
    const spheres = [];
    for(let i=0;i<count;i++){
      const rx = bx + 12 + Math.random()*(bw-24);
      const ry = by + 30 + Math.random()*(bh-42);
      const r = 4 + Math.random()*5;
      spheres.push({x:rx,y:ry,r});
    }

    // draw spheres (Ag)
    for(const s of spheres){
      // subtle depth via highlight
      const grad = ctx.createRadialGradient(s.x - s.r*0.35, s.y - s.r*0.35, 1, s.x, s.y, s.r);
      grad.addColorStop(0, 'rgba(251,191,36,0.95)');
      grad.addColorStop(1, 'rgba(234,88,12,0.75)');
      ctx.fillStyle = grad;
      ctx.beginPath();
      ctx.arc(s.x, s.y, s.r, 0, Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = 'rgba(0,0,0,0.25)';
      ctx.stroke();
    }

    // label Ag spheres
    ctx.fillStyle = 'rgba(233,240,255,0.80)';
    ctx.fillText('Inclusions: Ag nanospheres (εs(λ) complex)', bx+10, by+bh-10);

    // little inset: single sphere with field arrows
    const cx = pad + 90, cy = 42;
    ctx.fillStyle = 'rgba(0,0,0,0.22)';
    ctx.strokeStyle = 'rgba(255,255,255,0.12)';
    ctx.lineWidth = 1;
    ctx.beginPath();
    ctx.roundRect(bx + bw - 210, 14, 196, 72, 14);
    ctx.fill();
    ctx.stroke();

    const sx = bx + bw - 175, sy = 50;
    const sr = 18;
    const g2 = ctx.createRadialGradient(sx - sr*0.35, sy - sr*0.35, 1, sx, sy, sr);
    g2.addColorStop(0, 'rgba(251,191,36,0.95)');
    g2.addColorStop(1, 'rgba(234,88,12,0.75)');
    ctx.fillStyle = g2;
    ctx.beginPath();
    ctx.arc(sx, sy, sr, 0, Math.PI*2);
    ctx.fill();
    ctx.strokeStyle='rgba(0,0,0,0.25)';
    ctx.stroke();

    // incident E arrow
    ctx.strokeStyle = 'rgba(125,211,252,0.85)';
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(bx + bw - 130, 50);
    ctx.lineTo(bx + bw - 95, 50);
    ctx.stroke();
    // arrow head
    ctx.beginPath();
    ctx.moveTo(bx + bw - 95, 50);
    ctx.lineTo(bx + bw - 103, 45);
    ctx.lineTo(bx + bw - 103, 55);
    ctx.closePath();
    ctx.fillStyle = 'rgba(125,211,252,0.85)';
    ctx.fill();

    ctx.fillStyle='rgba(233,240,255,0.82)';
    ctx.font='12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillText('E (drives dipole)', bx + bw - 142, 34);

    // note f
    ctx.fillStyle='rgba(233,240,255,0.78)';
    ctx.font='12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Courier New"';
    ctx.fillText(`visual density ~ f = ${f.toFixed(3)}`, bx + bw - 205, 74);
  }

  // ---------- Main plot ----------
  const mainPlot = setupCanvas(document.getElementById('mainPlotCanvas'));
  function drawMainPlot(lams, reE, imE, bands){
    const {ctx} = mainPlot;
    const {w,h} = mainPlot.resize();
    ctx.clearRect(0,0,w,h);

    // find y range from both series (robust)
    let yMin = Infinity, yMax = -Infinity;
    for(let i=0;i<lams.length;i++){
      yMin = Math.min(yMin, reE[i], imE[i]);
      yMax = Math.max(yMax, reE[i], imE[i]);
    }
    // avoid huge spikes dominating: clamp to percentile-ish via simple robust cap
    // compute median abs and cap at 8x for display
    const absArr = reE.map((v,i)=>Math.max(Math.abs(v), Math.abs(imE[i])));
    absArr.sort((a,b)=>a-b);
    const med = absArr[Math.floor(absArr.length/2)] || 1;
    const cap = Math.max(5, 8*med);
    yMin = Math.max(yMin, -cap);
    yMax = Math.min(yMax, cap);
    const nr = niceRange(yMin, yMax);

    const margin = {l:62, r:18, t:22, b:52};
    const box = {x:margin.l, y:margin.t, w:w-margin.l-margin.r, h:h-margin.t-margin.b};

    // band shading
    drawBandShading(ctx, bands, LMIN, LMAX, box, 'rgba(134,239,172,0.08)');

    // axes
    drawAxes(ctx, box, LMIN, LMAX, nr.yMin, nr.yMax, 'λ0 (nm)', 'εe (dimensionless)');

    // lines
    drawLine(ctx, lams, reE, LMIN, LMAX, nr.yMin, nr.yMax, box, 'rgba(125,211,252,0.95)', 2.2);
    drawLine(ctx, lams, imE, LMIN, LMAX, nr.yMin, nr.yMax, box, 'rgba(167,139,250,0.95)', 2.0);

    // title inside plot area
    ctx.save();
    ctx.fillStyle = 'rgba(233,240,255,0.85)';
    ctx.font = '13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillText('Effective permittivity εe(λ0): real & imaginary parts', box.x+8, box.y+16);
    ctx.restore();
  }

  // ---------- Sweep plot: dominant negative band endpoints vs f ----------
  const sweepPlot = setupCanvas(document.getElementById('sweepCanvas'));
  function drawSweepPlot(n, model, params){
    const {ctx} = sweepPlot;
    const {w,h} = sweepPlot.resize();
    ctx.clearRect(0,0,w,h);

    const epsHost = n*n;
    const fVals = [];
    const startVals = [];
    const endVals = [];

    for(let ff=0; ff<=0.2001; ff+=0.005){
      const reE = [];
      for(const L of lambdas){
        const es = epsSilver(L, model, params);
        const ee = maxwellGarnett(epsHost, es, ff);
        reE.push(ee.re);
      }
      const bands = extractNegativeBands(lambdas, reE);

      // choose dominant band = widest in nm
      if(bands.length){
        let best = bands[0], bestW = best[1]-best[0];
        for(const b of bands){
          const wnm = b[1]-b[0];
          if(wnm > bestW){ best = b; bestW = wnm; }
        }
        fVals.push(ff);
        startVals.push(best[0]);
        endVals.push(best[1]);
      }
    }

    // axes limits
    const xMin = 0, xMax = 0.20;
    const yMin = LMIN, yMax = LMAX;

    const margin = {l:62, r:18, t:22, b:52};
    const box = {x:margin.l, y:margin.t, w:w-margin.l-margin.r, h:h-margin.t-margin.b};

    // axes
    drawAxes(ctx, box, xMin, xMax, yMin, yMax, 'volume fraction f (unitless)', 'λ endpoints (nm)');

    // plot lines only where values exist
    // start (accent) and end (accent2)
    if(fVals.length){
      // draw as connected lines in f-space
      ctx.save();
      ctx.strokeStyle = 'rgba(125,211,252,0.95)';
      ctx.lineWidth = 2.2;
      ctx.beginPath();
      for(let i=0;i<fVals.length;i++){
        const X = mapX(fVals[i], xMin, xMax, box);
        const Y = mapY(startVals[i], yMin, yMax, box);
        if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
      }
      ctx.stroke();

      ctx.strokeStyle = 'rgba(167,139,250,0.95)';
      ctx.lineWidth = 2.0;
      ctx.beginPath();
      for(let i=0;i<fVals.length;i++){
        const X = mapX(fVals[i], xMin, xMax, box);
        const Y = mapY(endVals[i], yMin, yMax, box);
        if(i===0) ctx.moveTo(X,Y); else ctx.lineTo(X,Y);
      }
      ctx.stroke();

      // add small points
      ctx.fillStyle = 'rgba(125,211,252,0.9)';
      for(let i=0;i<fVals.length;i++){
        const X = mapX(fVals[i], xMin, xMax, box);
        const Y = mapY(startVals[i], yMin, yMax, box);
        ctx.beginPath(); ctx.arc(X,Y,2.4,0,Math.PI*2); ctx.fill();
      }
      ctx.fillStyle = 'rgba(167,139,250,0.9)';
      for(let i=0;i<fVals.length;i++){
        const X = mapX(fVals[i], xMin, xMax, box);
        const Y = mapY(endVals[i], yMin, yMax, box);
        ctx.beginPath(); ctx.arc(X,Y,2.2,0,Math.PI*2); ctx.fill();
      }

      ctx.restore();
    }

    // title + legend
    ctx.save();
    ctx.fillStyle = 'rgba(233,240,255,0.85)';
    ctx.font = '13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    ctx.fillText('Dominant negative-ε band endpoints vs f (for current n & Ag model)', box.x+8, box.y+16);

    // legend
    const lx = box.x + box.w - 260, ly = box.y + 10;
    ctx.fillStyle = 'rgba(0,0,0,0.20)';
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.lineWidth = 1;
    roundRect(ctx, lx, ly, 252, 48, 12);
    ctx.fill(); ctx.stroke();

    ctx.fillStyle = 'rgba(233,240,255,0.80)';
    ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto';
    // swatches
    ctx.strokeStyle = 'rgba(125,211,252,0.95)';
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(lx+12, ly+18); ctx.lineTo(lx+28, ly+18); ctx.stroke();
    ctx.fillText('band start λstart(f)', lx+34, ly+22);

    ctx.strokeStyle = 'rgba(167,139,250,0.95)';
    ctx.lineWidth = 3;
    ctx.beginPath(); ctx.moveTo(lx+12, ly+34); ctx.lineTo(lx+28, ly+34); ctx.stroke();
    ctx.fillText('band end   λend(f)', lx+34, ly+38);

    ctx.restore();
  }

  function roundRect(ctx, x, y, w, h, r){
    ctx.beginPath();
    ctx.moveTo(x+r, y);
    ctx.arcTo(x+w, y, x+w, y+h, r);
    ctx.arcTo(x+w, y+h, x, y+h, r);
    ctx.arcTo(x, y+h, x, y, r);
    ctx.arcTo(x, y, x+w, y, r);
    ctx.closePath();
  }

  // ---------- UI bindings ----------
  const fSlider = document.getElementById('fSlider');
  const nSlider = document.getElementById('nSlider');
  const fVal = document.getElementById('fVal');
  const nVal = document.getElementById('nVal');
  const modelSel = document.getElementById('modelSel');
  const modelName = document.getElementById('modelName');

  const epsInfInp = document.getElementById('epsInf');
  const wpInp = document.getElementById('wp');
  const gammaInp = document.getElementById('gamma');
  const extraLossInp = document.getElementById('extraLoss');

  const toyF1 = document.getElementById('toyF1');
  const toyW1 = document.getElementById('toyW1');
  const toyG1 = document.getElementById('toyG1');
  const toyEpsInf = document.getElementById('toyEpsInf');

  const drudeParams = document.getElementById('drudeParams');
  const toyParams = document.getElementById('toyParams');

  const negBandsEl = document.getElementById('negBands');
  const minReEl = document.getElementById('minRe');
  const minReLamEl = document.getElementById('minReLam');
  const finalBox = document.getElementById('finalAnswerText');

  function getParams(){
    const p = {
      epsInf: parseFloat(epsInfInp.value),
      wp: parseFloat(wpInp.value),
      gamma: parseFloat(gammaInp.value),
      extraLoss: parseFloat(extraLossInp.value),
      toyF1: parseFloat(toyF1.value),
      toyW1: parseFloat(toyW1.value),
      toyG1: parseFloat(toyG1.value),
      toyEpsInf: parseFloat(toyEpsInf.value)
    };
    // ensure sane
    if(!isFinite(p.epsInf)) p.epsInf = 5;
    if(!isFinite(p.wp)) p.wp = 9;
    if(!isFinite(p.gamma)) p.gamma = 0.02;
    if(!isFinite(p.extraLoss) || p.extraLoss<=0) p.extraLoss = 1;
    if(!isFinite(p.toyF1)) p.toyF1 = 0.6;
    if(!isFinite(p.toyW1)) p.toyW1 = 3.9;
    if(!isFinite(p.toyG1)) p.toyG1 = 0.5;
    if(!isFinite(p.toyEpsInf)) p.toyEpsInf = 3.5;
    return p;
  }

  function updateModelUI(){
    const m = modelSel.value;
    if(m === 'drude_eV'){
      drudeParams.style.display = '';
      toyParams.style.display = 'none';
      modelName.textContent = 'Drude (editable)';
    }else{
      drudeParams.style.display = '';
      toyParams.style.display = '';
      modelName.textContent = 'Toy Drude–Lorentz';
    }
  }

  function computeAndRender(){
    const f = parseFloat(fSlider.value);
    const n = parseFloat(nSlider.value);
    fVal.textContent = f.toFixed(3);
    nVal.textContent = n.toFixed(3);

    const model = modelSel.value;
    const params = getParams();

    // compute eps_e(λ)
    const epsHost = n*n;
    const reE = new Array(lambdas.length);
    const imE = new Array(lambdas.length);

    let minRe = Infinity, minLam = lambdas[0];

    for(let i=0;i<lambdas.length;i++){
      const L = lambdas[i];
      const es = epsSilver(L, model, params);
      const ee = maxwellGarnett(epsHost, es, f);
      reE[i] = ee.re;
      imE[i] = ee.im;
      if(ee.re < minRe){
        minRe = ee.re;
        minLam = L;
      }
    }

    const bands = extractNegativeBands(lambdas, reE);

    // update KPI
    negBandsEl.textContent = formatBands(bands);
    minReEl.textContent = (isFinite(minRe) ? minRe.toFixed(4) : '—');
    minReLamEl.textContent = (isFinite(minRe) ? minLam.toFixed(0) : '—');

    // draw
    drawDiagram(f);
    drawMainPlot(lambdas, reE, imE, bands);
    drawSweepPlot(n, model, params);

    // final answer block (plain text)
    const epsTxt = (n*n).toFixed(5);
    const bandTxt = bands.length ? bands.map(b=>`${b[0].toFixed(0)}–${b[1].toFixed(0)} nm`).join("; ") : "None in 250–1000 nm";
    finalBox.textContent =
`Using Maxwell–Garnett for spherical inclusions:
εe(λ) = ε + 3 f ε (εs(λ) − ε) / ( εs(λ) + 2ε − f(εs(λ) − ε) ),  with ε = n².

For current settings:
n = ${n.toFixed(3)}  ⇒  ε = n² = ${epsTxt}
f = ${f.toFixed(3)}

Extracted wavelength band(s) where Re{εe} < 0 (within 250–1000 nm):
${bandTxt}

Minimum Re{εe} in the scan:
Re{εe}_min = ${isFinite(minRe)?minRe.toFixed(4):'—'} at λ ≈ ${isFinite(minRe)?minLam.toFixed(0):'—'} nm.

Note: The exact band depends on the chosen εs(λ) model (set it to match Prob. 8.2-3).`;
  }

  // copy buttons
  function copyTextFrom(el){
    const txt = (el.innerText || el.textContent || '').trim();
    if(!txt) return;
    navigator.clipboard.writeText(txt).then(()=>{
      // brief visual feedback
      const old = el.style.borderColor;
      el.style.borderColor = 'rgba(134,239,172,0.55)';
      setTimeout(()=>{ el.style.borderColor = old; }, 450);
    }).catch(()=>{ /* ignore */ });
  }
  document.querySelectorAll('[data-copy]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-copy');
      const el = document.getElementById(id);
      if(el) copyTextFrom(el);
    });
  });

  // reset
  document.getElementById('resetBtn').addEventListener('click', ()=>{
    fSlider.value = 0.03;
    nSlider.value = 1.33;
    modelSel.value = 'drude_eV';
    epsInfInp.value = 5.00;
    wpInp.value = 9.01;
    gammaInp.value = 0.021;
    extraLossInp.value = 1.00;
    toyF1.value = 0.6;
    toyW1.value = 3.9;
    toyG1.value = 0.5;
    toyEpsInf.value = 3.5;
    updateModelUI();
    computeAndRender();
  });

  // listeners
  [fSlider, nSlider, modelSel, epsInfInp, wpInp, gammaInp, extraLossInp, toyF1, toyW1, toyG1, toyEpsInf].forEach(el=>{
    el.addEventListener('input', ()=>{
      updateModelUI();
      computeAndRender();
    });
  });

  // responsive redraw
  window.addEventListener('resize', ()=>{
    computeAndRender();
  });

  // initial
  updateModelUI();
  computeAndRender();

})();
</script>
</body>
</html>
