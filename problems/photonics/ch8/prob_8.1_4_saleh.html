<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Type-II Hyperbolic Medium — k-Surface, High-k Waves, and Reflectivity</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1726;
      --panel2:#111c31;
      --text:#e7edf7;
      --muted:#a9b6cc;
      --line:rgba(255,255,255,.10);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 12px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0; font-family:var(--sans);
      background: radial-gradient(1200px 700px at 20% 0%, rgba(125,211,252,.10), transparent 55%),
                  radial-gradient(900px 600px at 100% 20%, rgba(167,139,250,.10), transparent 55%),
                  linear-gradient(180deg, #070a11, #0b0f17);
      color:var(--text);
      line-height:1.6;
    }
    header{
      padding:28px 18px 10px;
      border-bottom:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.03), transparent);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:0 10px 50px;}
    .hero{
      display:grid; grid-template-columns: 1.4fr .6fr; gap:14px; align-items:start;
    }
    h1{font-size: clamp(1.5rem, 2.3vw, 2.2rem); margin:0 0 8px;}
    .subtitle{color:var(--muted); margin:0 0 14px;}
    .badgeRow{display:flex; flex-wrap:wrap; gap:8px; margin:10px 0 0;}
    .badge{
      font-size:.85rem; color:rgba(255,255,255,.86);
      padding:6px 10px; border:1px solid var(--line); border-radius:999px;
      background: rgba(255,255,255,.04);
      backdrop-filter: blur(8px);
    }
    .layout{
      display:grid;
      grid-template-columns: 260px 1fr;
      gap:16px;
      align-items:start;
    }
    nav.toc{
      position:sticky; top:10px;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:12px;
    }
    .toc h2{font-size:1rem; margin:0 0 8px; color:rgba(255,255,255,.92)}
    .toc a{
      display:block;
      padding:8px 10px;
      color:var(--muted);
      text-decoration:none;
      border-radius:12px;
      border:1px solid transparent;
      transition: transform .15s ease, background .15s ease, color .15s ease;
      font-size:.95rem;
    }
    .toc a:hover{
      background: rgba(125,211,252,.09);
      color: rgba(255,255,255,.92);
      border-color: rgba(125,211,252,.18);
      transform: translateX(2px);
    }
    main{padding:16px 0 0;}
    section{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:18px;
      margin:0 0 16px;
      overflow:hidden;
    }
    section h2{
      margin:0 0 10px;
      font-size:1.25rem;
      letter-spacing:.2px;
    }
    section h3{margin:14px 0 8px; font-size:1.05rem; color:rgba(255,255,255,.92)}
    .grid2{display:grid; grid-template-columns: 1fr 1fr; gap:12px;}
    .grid3{display:grid; grid-template-columns: 1fr 1fr 1fr; gap:12px;}
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,23,38,.9), rgba(15,23,38,.55));
      border-radius: 14px;
      padding:12px;
    }
    .callout{
      border-left:4px solid var(--accent);
      background: rgba(125,211,252,.06);
      padding:12px 12px 12px 14px;
      border-radius: 14px;
      border:1px solid rgba(125,211,252,.18);
    }
    .warn{
      border-left-color: var(--warn);
      background: rgba(251,191,36,.06);
      border-color: rgba(251,191,36,.18);
    }
    .final{
      border-left-color: var(--good);
      background: rgba(52,211,153,.07);
      border-color: rgba(52,211,153,.18);
    }
    ul{margin:8px 0 0 18px}
    li{margin:6px 0}
    .eq{
      position:relative;
      margin:10px 0;
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      border-radius: 14px;
      padding:12px 12px 12px 12px;
      overflow:auto;
      font-family: var(--mono);
      font-size: .95rem;
      color: rgba(255,255,255,.92);
    }
    .eq .label{
      font-family: var(--sans);
      color: var(--muted);
      font-size:.85rem;
      margin-bottom:8px;
    }
    .copyBtn{
      position:absolute;
      top:10px; right:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: rgba(255,255,255,.90);
      padding:7px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:.85rem;
      transition: transform .12s ease, background .12s ease;
      user-select:none;
    }
    .copyBtn:hover{transform: translateY(-1px); background: rgba(255,255,255,.10);}
    .copyBtn:active{transform: translateY(0px);}
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:10px;
      margin-top:10px;
    }
    .ctrl{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 14px;
      padding:10px;
    }
    .ctrl label{display:block; font-size:.9rem; color:var(--muted); margin-bottom:6px}
    .ctrl .row{display:flex; gap:8px; align-items:center; justify-content:space-between}
    input[type="range"]{width:100%}
    select, button{
      width:100%;
      border-radius: 12px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:9px 10px;
      font-size: .95rem;
      cursor:pointer;
    }
    button{transition: transform .12s ease, background .12s ease;}
    button:hover{background: rgba(255,255,255,.10); transform: translateY(-1px);}
    button:active{transform: translateY(0px);}
    figure{margin:0}
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius: 14px;
      border:1px solid var(--line);
      background: radial-gradient(700px 300px at 30% 0%, rgba(125,211,252,.08), transparent 55%),
                  linear-gradient(180deg, rgba(0,0,0,.25), rgba(0,0,0,.12));
    }
    .cap{color:var(--muted); font-size:.92rem; margin-top:8px}
    .kpi{
      display:flex; gap:10px; flex-wrap:wrap;
      margin-top:10px;
    }
    .kpi .pill{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:999px;
      padding:8px 10px;
      font-size:.9rem;
      color:rgba(255,255,255,.88);
      font-family: var(--mono);
    }
    footer{
      margin-top:18px;
      color: var(--muted);
      font-size:.9rem;
      padding:10px 0 30px;
      border-top:1px solid var(--line);
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr;}
      nav.toc{position:relative; top:auto;}
      .hero{grid-template-columns:1fr;}
      .controls{grid-template-columns:1fr;}
      canvas{height:300px;}
      .grid2,.grid3{grid-template-columns:1fr;}
    }
    @media print{
      body{background:#fff; color:#000;}
      section, nav.toc{box-shadow:none; background:#fff; border-color:#ccc;}
      .copyBtn, .controls, .badgeRow{display:none !important;}
      canvas{border-color:#ccc;}
      a{color:#000;}
    }
  </style>
</head>
<body>
<header>
  <div class="wrap">
    <div class="hero">
      <div>
        <h1>Type-II Hyperbolic Medium: k-Surface, High-k Propagation, and Why It Can Be Reflective</h1>
        <p class="subtitle">
          We derive the dispersion (k-surface) for a Type-II hyperbolic medium (ε₁, ε₂ &lt; 0, ε₃ &gt; 0),
          show it supports propagating waves with very short transverse wavelengths (high-k modes),
          and explain—using an interface model—why it can nevertheless appear highly reflective.
        </p>
        <div class="badgeRow">
          <span class="badge">Anisotropic dielectrics</span>
          <span class="badge">Hyperbolic dispersion</span>
          <span class="badge">High-k waves</span>
          <span class="badge">Interface reflectance (TM)</span>
        </div>
      </div>
      <div class="card">
        <div style="color:rgba(255,255,255,.92); font-weight:600; margin-bottom:6px;">Interactive lab (live)</div>
        <div style="color:var(--muted); font-size:.95rem;">
          Use the controls below to switch Type-I/Type-II and change ε values.
          All canvases update together.
        </div>
      </div>
    </div>
  </div>
</header>

<div class="wrap layout">
  <nav class="toc" aria-label="Table of contents">
    <h2>Mini Table of Contents</h2>
    <a href="#qs">Quick Summary</a>
    <a href="#p0">PART 0 — Concept Primer</a>
    <a href="#p1">PART 1 — Problem Analysis</a>
    <a href="#p2">PART 2 — Strategy & Tips</a>
    <a href="#p3">PART 3 — Full Solution</a>
    <a href="#p4">PART 4 — Deeper Understanding</a>
    <a href="#p5">PART 5 — Visualization Guide</a>
  </nav>

  <main>
    <!-- Quick Summary -->
    <section id="qs">
      <h2>Quick Summary</h2>
      <ul>
        <li><b>Topic:</b> Wave propagation in <b>anisotropic</b> (tensor-ε) media with “indefinite” signs → <b>hyperbolic dispersion</b>.</li>
        <li><b>Key idea:</b> For extraordinary (TM-like) waves in a principal-axis permittivity tensor diag(ε₁, ε₂, ε₃), the k-surface becomes a <b>hyperboloid</b> when one sign differs from the others.</li>
        <li><b>Governing dispersion (uniaxial example ε₁=ε₂≡εt):</b> (kₓ²+kᵧ²)/ε₃ + k_z²/εt = (ω/c)².</li>
        <li><b>Type-II:</b> ε₁, ε₂ &lt; 0 and ε₃ &gt; 0 ⇒ <b>one-sheet hyperboloid</b> in k-space.</li>
        <li><b>High-k propagation:</b> In Type-II, real k_z exists for arbitrarily large transverse k_t = √(kₓ²+kᵧ²) once k_t exceeds a threshold → <b>very short transverse wavelengths</b>.</li>
        <li><b>Reflective behavior:</b> A usual dielectric incident wave has limited k_t (≤ √ε_d k₀). If the hyperbolic medium requires k_t &gt; √ε₃ k₀ to propagate, then transmission is evanescent → <b>near-total reflection</b>.</li>
        <li><b>Final result type:</b> <b>Symbolic</b> k-surface + <b>symbolic</b> propagation condition + (model) <b>reflectance vs angle</b>.</li>
      </ul>
    </section>

    <!-- Interactive visuals -->
    <section aria-label="Interactive visualizations">
      <h2>Interactive Visualizations</h2>
      <div class="grid2">
        <figure class="card">
          <canvas id="cDiagram" aria-label="Physical setup diagram"></canvas>
          <div class="cap"><b>Diagram:</b> Isotropic dielectric → anisotropic hyperbolic medium (optic axis along z). Shows incident TM wave and tensor signs.</div>
        </figure>
        <figure class="card">
          <canvas id="cKsurface" aria-label="k-space dispersion plot"></canvas>
          <div class="cap"><b>Main plot:</b> k-space cross-section (kₓ vs k_z, normalized by k₀). Hyperbola branch changes with Type-I/II and ε values.</div>
        </figure>
      </div>
      <div class="card" style="margin-top:12px;">
        <canvas id="cReflect" aria-label="Reflectance plot"></canvas>
        <div class="cap"><b>Secondary plot:</b> TM reflectance R(θ) at a dielectric–hyperbolic interface (model) and a propagation indicator inside the hyperbolic medium.</div>

        <div class="controls" role="group" aria-label="Controls">
          <div class="ctrl">
            <label for="selType">Medium type</label>
            <select id="selType">
              <option value="type2" selected>Type-II (ε₁=ε₂&lt;0, ε₃&gt;0)</option>
              <option value="type1">Type-I (ε₁=ε₂&gt;0, ε₃&lt;0)</option>
            </select>
          </div>

          <div class="ctrl">
            <label for="rngEt">Transverse permittivity εt = ε₁=ε₂ (unitless)</label>
            <div class="row"><span class="badge">value</span><span id="labEt" class="badge">−2.0</span></div>
            <input id="rngEt" type="range" min="0.5" max="8" step="0.1" value="2.0"/>
            <div class="cap">Sign set by “Medium type”. Slider controls |εt|.</div>
          </div>

          <div class="ctrl">
            <label for="rngEz">Axial permittivity ε₃ (unitless)</label>
            <div class="row"><span class="badge">value</span><span id="labEz" class="badge">+3.0</span></div>
            <input id="rngEz" type="range" min="0.5" max="12" step="0.1" value="3.0"/>
            <div class="cap">Sign set by “Medium type”. Slider controls |ε₃|.</div>
          </div>
        </div>

        <div class="controls" style="grid-template-columns: 1fr 1fr 1fr; margin-top:10px;">
          <div class="ctrl">
            <label for="rngEd">Incident dielectric ε_d (unitless)</label>
            <div class="row"><span class="badge">value</span><span id="labEd" class="badge">1.00</span></div>
            <input id="rngEd" type="range" min="1" max="6" step="0.05" value="1.00"/>
            <div class="cap">Example for reflectance plot (air: 1, glass: ~2.25).</div>
          </div>
          <div class="ctrl">
            <label for="btnReset">Quick actions</label>
            <button id="btnReset" type="button">Reset to Type-II example</button>
            <div class="cap">Resets to a clear “high-k but reflective” case.</div>
          </div>
          <div class="ctrl">
            <label>Live readout (normalized)</label>
            <div class="kpi">
              <div class="pill">k₀ = ω/c (set to 1 for plots)</div>
              <div class="pill" id="pillThresh">threshold: k_t &gt; √ε₃ k₀</div>
              <div class="pill" id="pillNote">note: propagation depends on k_t</div>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- PART 0 -->
    <section id="p0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <article class="card">
        <h3>Core definitions (symbols & units)</h3>
        <ul>
          <li><b>Permittivity tensor</b> (relative): <span style="font-family:var(--mono)">ε̿ = diag(ε₁, ε₂, ε₃)</span> (unitless). Physical permittivity is ε₀ εᵢ along axis i.</li>
          <li><b>Wavevector</b> <span style="font-family:var(--mono)">k = (kₓ, kᵧ, k_z)</span> (units: 1/m). It sets phase variation: <span style="font-family:var(--mono)">exp[i(k·r − ωt)]</span>.</li>
          <li><b>Free-space wavenumber</b>: <span style="font-family:var(--mono)">k₀ = ω/c</span> (1/m). In plots we normalize by k₀.</li>
          <li><b>Transverse magnitude</b>: <span style="font-family:var(--mono)">k_t = √(kₓ² + kᵧ²)</span> (1/m). Short transverse wavelength means large k_t.</li>
        </ul>
      </article>

      <article class="card">
        <h3>Physical meaning of the key quantities</h3>
        <ul>
          <li><b>εᵢ</b> tells you how strongly the medium polarizes along axis i; it also sets how E and D relate: <span style="font-family:var(--mono)">Dᵢ = ε₀ εᵢ Eᵢ</span>.</li>
          <li><b>k-surface</b> (also “dispersion surface”) is the set of k vectors allowed at a given ω. Its geometry tells you what kinds of propagation are possible.</li>
          <li><b>Hyperbolic medium</b> means the signs of ε components are mixed (indefinite tensor), causing the k-surface to become a hyperboloid instead of a sphere/ellipsoid.</li>
        </ul>
      </article>

      <div class="grid2">
        <article class="callout">
          <h3>Key laws/principles (and validity)</h3>
          <ul>
            <li><b>Maxwell (frequency domain):</b> ∇×E = iωμ₀H, ∇×H = −iωD with D = ε₀ ε̿ E.</li>
            <li><b>Plane-wave ansatz:</b> fields ∝ exp[i(k·r − ωt)] ⇒ ∇ → i k.</li>
            <li><b>Assumptions:</b> linear, homogeneous medium; principal axes aligned with coordinates; μ≈μ₀ (non-magnetic); losses neglected for clarity (ε real).</li>
          </ul>
        </article>

        <article class="callout warn">
          <h3>Common models/approximations (why we use them)</h3>
          <ul>
            <li><b>Uniaxial simplification:</b> ε₁=ε₂≡εt (transverse), ε₃≡εz (axial). Many hyperbolic metamaterials behave approximately uniaxial.</li>
            <li><b>TM-like (extraordinary) branch:</b> the hyperbolic behavior is most clearly seen for extraordinary waves (E has components both along and across the optic axis).</li>
            <li><b>Interface reflectance model:</b> treat an isotropic dielectric (ε_d) incident onto a uniaxial medium with optic axis normal to interface (z). Captures why coupling can be poor.</li>
          </ul>
        </article>
      </div>

      <article class="card">
        <h3>Mini intuition examples (no long algebra)</h3>
        <ul>
          <li><b>Ordinary isotropic dielectric:</b> k-surface is a sphere: |k| = √ε k₀. You cannot have arbitrarily large k at fixed ω.</li>
          <li><b>Hyperbolic case:</b> if one ε component is negative, the “sphere equation” becomes “hyperbola equation”. A hyperbola is open, so components of k can grow very large while still satisfying dispersion.</li>
        </ul>
      </article>

      <article class="callout warn">
        <h3>What to watch for (typical pitfalls)</h3>
        <ul>
          <li><b>Which dispersion branch?</b> Hyperbolic behavior refers to the extraordinary/TM-like branch in uniaxial media.</li>
          <li><b>Propagation vs existence of large k:</b> A medium may support high-k modes internally, but external plane waves may not couple to them (k_t mismatch).</li>
          <li><b>Signs matter:</b> Type-I vs Type-II swaps which axis “opens” the hyperbola.</li>
          <li><b>Reflection is an interface issue:</b> High reflectivity does not contradict internal high-k propagation.</li>
        </ul>
      </article>
    </section>

    <!-- PART 1 -->
    <section id="p1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <article class="card">
        <h3>Problem restatement (in my own words)</h3>
        <p style="margin:0;">
          We have a hyperbolic medium with principal permittivities ε₁, ε₂, ε₃. The book calls ε₁,ε₂&gt;0 and ε₃&lt;0 “Type-I”.
          We must (i) find the <b>k-surface</b> for “Type-II” where ε₁,ε₂&lt;0 and ε₃&gt;0, and (ii) show it supports propagating waves with
          <b>very short wavelengths</b> (large spatial frequencies), but (iii) can still be <b>highly reflective</b>.
        </p>
      </article>

      <div class="grid2">
        <article class="card">
          <h3>Given</h3>
          <ul>
            <li>Principal relative permittivities: Type-II means <b>ε₁&lt;0, ε₂&lt;0, ε₃&gt;0</b>.</li>
            <li>Context: Section 8.1C hyperbolic medium (plane-wave dispersion in anisotropic media).</li>
            <li>Implicit: homogeneous, linear medium; μ≈1; frequency ω fixed.</li>
          </ul>
        </article>

        <article class="card">
          <h3>Unknowns / what to prove</h3>
          <ul>
            <li>Find the <b>k-surface</b> equation for Type-II.</li>
            <li>Show <b>propagating</b> solutions exist with very large |k| (short wavelengths).</li>
            <li>Explain (and demonstrate with a model) why the medium can be <b>highly reflective</b>.</li>
          </ul>
        </article>
      </div>

      <article class="card">
        <h3>Relevant principles (and why they apply)</h3>
        <ul>
          <li><b>Maxwell + plane waves</b> → dispersion relation linking components of k to ω for a given ε̿.</li>
          <li><b>Geometry of quadratic surfaces</b> → classify the k-surface as ellipsoid vs hyperboloid depending on signs.</li>
          <li><b>Boundary conditions</b> at an interface → tangential k is conserved, which controls coupling and reflectance.</li>
        </ul>
        <p class="cap" style="margin-top:8px;">
          We <b>do not</b> need nonlinear optics or time-dependent ε; we also avoid microscopic metamaterial design—this is a wave-physics/dispersion question.
        </p>
      </article>

      <article class="callout">
        <h3>Assumptions (explicit)</h3>
        <ul>
          <li>Medium is homogeneous and anisotropic with diagonal ε̿ in chosen coordinates.</li>
          <li>Lossless for the derivations (ε real). (Loss would smooth singularities but not change the hyperbolic classification.)</li>
          <li>Non-magnetic: μ=μ₀.</li>
          <li>For the interface “reflective” argument we model an isotropic dielectric of permittivity ε_d incident onto the hyperbolic medium with optic axis along z (normal to interface).</li>
        </ul>
      </article>

      <article class="card">
        <h3>Possible approaches (compare and choose)</h3>
        <ul>
          <li><b>Approach A: general anisotropic dispersion from Maxwell eigenproblem</b> (most rigorous; more algebra).</li>
          <li><b>Approach B: uniaxial extraordinary-wave dispersion</b> (cleanest for k-surface geometry; matches “hyperbolic medium” discussion).</li>
          <li><b>Approach C: energy/phase velocity arguments</b> (good intuition but not enough to “find the k-surface”).</li>
        </ul>
        <p style="margin:8px 0 0;">
          <b>We choose Approach B</b>: it yields a clear quadratic k-surface, makes Type-II geometry obvious, and directly connects to high-k and reflectivity via k_t conservation.
        </p>
      </article>
    </section>

    <!-- PART 2 -->
    <section id="p2">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

      <article class="card">
        <ol style="margin:8px 0 0 18px;">
          <li><b>Set coordinates:</b> align axes with ε̿ principal axes so ε̿=diag(ε₁,ε₂,ε₃).</li>
          <li><b>Select the hyperbolic branch:</b> use the extraordinary/TM-like dispersion (uniaxial ε₁=ε₂≡εt).</li>
          <li><b>Write the k-surface equation</b> at fixed ω: a quadratic relation among kₓ,kᵧ,k_z.</li>
          <li><b>Insert Type-II signs</b> (εt&lt;0, ε₃&gt;0) and classify the surface (one-sheet hyperboloid).</li>
          <li><b>Propagation condition:</b> solve for k_z² and require k_z to be real → inequality involving k_t.</li>
          <li><b>“Very short wavelengths”:</b> show k_t can be arbitrarily large while still allowing real k_z.</li>
          <li><b>Reflectivity argument:</b> consider an interface; enforce tangential k conservation; show many incident angles produce evanescent transmission (or strong impedance mismatch) → large R.</li>
          <li><b>Sanity checks:</b> dimensional consistency; limiting cases (all ε&gt;0 → ellipsoid); interpret physically.</li>
        </ol>
      </article>

      <article class="callout warn">
        <h3>Common mistakes + quick tips</h3>
        <ul>
          <li><b>Mistake:</b> treating the k-surface like isotropic |k|=n k₀. <b>Tip:</b> anisotropy makes k components scale differently.</li>
          <li><b>Mistake:</b> claiming “high-k exists” ⇒ “low reflection”. <b>Tip:</b> coupling requires matching tangential k and impedance.</li>
          <li><b>Mistake:</b> mixing ε₃’s role (axial) with εt (transverse). <b>Tip:</b> keep k_t tied to ε₃ in the dispersion used below.</li>
        </ul>
      </article>
    </section>

    <!-- PART 3 -->
    <section id="p3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <article class="card">
        <h3>Physical intuition (before calculating)</h3>
        <p style="margin:0;">
          In isotropic media, the allowed k vectors at fixed ω form a sphere, so k cannot grow without bound.
          In a hyperbolic medium, one tensor component has the opposite sign, so the “sphere equation” becomes a
          hyperbola/hyperboloid. Hyperboloids are open surfaces: some components of k can grow very large while
          still satisfying dispersion. That is the origin of <b>subwavelength (high-k) propagating modes</b>.
          However, at an interface the incident wave’s tangential k is limited by the incident refractive index,
          so the medium may “have the modes” but still <b>not accept power</b> efficiently—appearing reflective.
        </p>
      </article>

      <article class="card">
        <h3>Step 1 — Set up the uniaxial hyperbolic model and define symbols</h3>
        <p style="margin:0 0 8px;">
          The problem states ε₁ and ε₂ share the same sign (both positive for Type-I, both negative for Type-II).
          A common and physically meaningful model is therefore <b>uniaxial</b>:
        </p>
        <div class="eq" id="eqTensor">
          <div class="label">Permittivity tensor (relative, unitless)</div>
          <button class="copyBtn" data-copy="ε̿ = diag(εt, εt, ε3), with εt = ε1 = ε2">Copy</button>
          ε̿ = diag(εt, εt, ε3),   where εt ≡ ε1 = ε2, and ε3 is the axial component.
        </div>
        <p style="margin:0;">
          We take z as the optic axis. The free-space wavenumber is k₀ = ω/c. The transverse wavevector magnitude is k_t = √(kₓ²+kᵧ²).
        </p>
      </article>

      <article class="card">
        <h3>Step 2 — Extraordinary (TM-like) dispersion and the k-surface</h3>
        <p style="margin:0 0 8px;">
          For a plane wave in a uniaxial medium, the extraordinary/TM-like branch obeys a quadratic dispersion of the form
          (this is the “k-surface” equation at fixed ω):
        </p>

        <div class="eq" id="eqDisp">
          <div class="label">Extraordinary-wave k-surface (fixed ω)</div>
          <button class="copyBtn" data-copy="(kx^2 + ky^2)/ε3 + kz^2/εt = k0^2,  where k0 = ω/c">Copy</button>
          (kₓ² + kᵧ²)/ε₃ + k_z²/εt = k₀²,   where k₀ = ω/c.
        </div>

        <p style="margin:0;">
          <b>Why this is the k-surface:</b> It is a constant-frequency relation linking components of k, analogous to |k|² = ε k₀² in isotropic media,
          but with tensor-weighted components. Its geometry depends entirely on the <b>signs</b> of εt and ε₃.
        </p>
      </article>

      <article class="card">
        <h3>Step 3 — Insert Type-II signs and classify the surface</h3>
        <p style="margin:0 0 8px;">
          <b>Type-II hyperbolic medium:</b> ε₁,ε₂&lt;0 and ε₃&gt;0, hence εt&lt;0 and ε₃&gt;0.
          Write εt = −|εt| with |εt|&gt;0. Substitute into the dispersion:
        </p>

        <div class="eq" id="eqType2">
          <div class="label">Type-II k-surface (one-sheet hyperboloid)</div>
          <button class="copyBtn" data-copy="(kx^2 + ky^2)/ε3 - kz^2/|εt| = k0^2   (Type-II: ε3>0, εt<0)">Copy</button>
          (kₓ² + kᵧ²)/ε₃ + k_z²/(−|εt|) = k₀²
          ⟹ (kₓ² + kᵧ²)/ε₃ − k_z²/|εt| = k₀².
        </div>

        <p style="margin:0;">
          This has the canonical “+ − = constant” form of a <b>one-sheet hyperboloid</b> in 3D k-space.
          (Compare to x²/a² + y²/b² − z²/c² = 1.)
        </p>
      </article>

      <article class="card">
        <h3>Step 4 — Show Type-II supports propagating very short wavelengths (high-k)</h3>
        <p style="margin:0 0 8px;">
          To decide if a plane wave <b>propagates</b> along z, we require k_z to be real.
          Solve the Type-II dispersion for k_z²:
        </p>

        <div class="eq" id="eqKz">
          <div class="label">Propagation condition inside Type-II</div>
          <button class="copyBtn" data-copy="kz^2 = |εt| ( (kt^2/ε3) - k0^2 ).  Propagation ⇔ kt > sqrt(ε3) k0">Copy</button>
          Start: (k_t²)/ε₃ − k_z²/|εt| = k₀²
          ⟹ k_z²/|εt| = (k_t²)/ε₃ − k₀²
          ⟹ k_z² = |εt| ( (k_t²/ε₃) − k₀² ).
          Propagation (real k_z) ⇔ (k_t²/ε₃) − k₀² ≥ 0 ⇔ k_t ≥ √ε₃ · k₀.
        </div>

        <p style="margin:0 0 8px;">
          <b>Key conclusion:</b> once k_t exceeds the threshold √ε₃ k₀, k_z becomes real and the wave propagates.
          There is no upper bound on k_t in this ideal model, so the medium supports arbitrarily large transverse spatial frequencies.
          That means arbitrarily small transverse wavelength:
        </p>

        <div class="eq" id="eqLambda">
          <div class="label">Very short transverse wavelength</div>
          <button class="copyBtn" data-copy="λt = 2π/kt.  Since kt can be arbitrarily large (for kt>√ε3 k0), λt can be arbitrarily small.">Copy</button>
          λ_t = 2π / k_t.
          Since k_t can be arbitrarily large (once k_t > √ε₃ k₀), λ_t can be arbitrarily small.
        </div>

        <div class="callout final">
          <h3>What you just proved (in plain language)</h3>
          <p style="margin:0;">
            A Type-II hyperbolic medium has an <b>open</b> k-surface. For sufficiently large transverse wavevector,
            it admits <b>propagating</b> modes with extremely fine spatial features (subwavelength patterns).
          </p>
        </div>
      </article>

      <article class="card">
        <h3>Step 5 — Why it can be highly reflective (interface + k<sub>t</sub> mismatch)</h3>
        <p style="margin:0 0 10px;">
          Consider an interface at z=0 between an isotropic dielectric (relative permittivity ε_d&gt;0, e.g., air ε_d=1)
          for z&lt;0 and the hyperbolic medium for z&gt;0. A plane wave incident from the dielectric at angle θ has
          tangential wavevector:
        </p>

        <div class="eq" id="eqKtConserve">
          <div class="label">Tangential k is conserved at the interface</div>
          <button class="copyBtn" data-copy="kt = k0 sqrt(εd) sin(θ).  In the incident dielectric, kt ≤ k0 sqrt(εd).">Copy</button>
          k_t = k₀ √ε_d · sinθ.
          Therefore (since |sinθ| ≤ 1):  k_t ≤ k₀ √ε_d.
        </div>

        <p style="margin:0 0 10px;">
          But Type-II propagation requires k_t ≥ √ε₃ k₀. Combine these:
        </p>

        <div class="eq" id="eqMismatch">
          <div class="label">Mismatch condition → evanescent transmission → high reflection</div>
          <button class="copyBtn" data-copy="If √ε3 > √εd, then kt ≤ k0√εd < k0√ε3, so kz is imaginary in the hyperbolic medium (no propagating transmission) ⇒ strong reflection.">Copy</button>
          If √ε₃ > √ε_d, then for any propagating incident wave:
          k_t ≤ k₀√ε_d  <  k₀√ε₃
          so the Type-II condition k_t ≥ k₀√ε₃ is not met.
          Then k_z becomes imaginary in the hyperbolic medium → transmitted field is evanescent → strong reflection.
        </div>

        <p style="margin:0 0 10px;">
          To make this concrete, for TM incidence (H along y) a simple boundary-condition model gives the Fresnel-like coefficient:
        </p>

        <div class="eq" id="eqFresnel">
          <div class="label">TM reflection coefficient (model: optic axis normal to interface)</div>
          <button class="copyBtn" data-copy="rp = (εt kz1 − εd kz2)/(εt kz1 + εd kz2),  kz1 = k0√εd cosθ,  kz2^2 = εt k0^2 (1 − (εd/ε3) sin^2θ)">Copy</button>
          r_p = (εt k_{z1} − ε_d k_{z2}) / (εt k_{z1} + ε_d k_{z2}),
          where k_{z1} = k₀√ε_d cosθ,
          and from (k_t²)/ε₃ + k_z²/εt = k₀²:
          k_{z2}² = εt k₀² ( 1 − (ε_d/ε₃) sin²θ ).
        </div>

        <p style="margin:0;">
          If k_{z2} is imaginary (evanescent), then |r_p| tends toward 1 (nearly total reflection). Even when k_{z2} is real,
          εt&lt;0 often yields strong impedance mismatch. This is why a Type-II hyperbolic medium can be <b>highly reflective</b>
          despite supporting internal high-k propagation.
        </p>
      </article>

      <article class="callout final" id="finalAnswerBox">
        <h3>Final Answer (boxed)</h3>

        <div class="eq" id="eqFinal">
          <div class="label">Type-II k-surface + propagation + reflectivity statement</div>
          <button class="copyBtn" data-copy="Type-II (ε1=ε2=εt<0, ε3>0):  (kx^2+ky^2)/ε3 − kz^2/|εt| = k0^2.  Propagation requires kt≥√ε3 k0, so arbitrarily large kt (→ arbitrarily small λt=2π/kt) is allowed.  But at an interface, kt is limited by the incident medium (kt≤k0√εd); if ε3>εd then no propagating transmission exists and reflectance is near unity (highly reflective).">Copy</button>
          Type-II (ε₁=ε₂≡εt&lt;0, ε₃&gt;0):
          (kₓ²+kᵧ²)/ε₃ − k_z²/|εt| = k₀².
          Propagation requires k_t ≥ √ε₃ k₀, so arbitrarily large k_t (→ arbitrarily small λ_t) is supported.
          However, at an interface k_t is limited by the incident medium (k_t ≤ k₀√ε_d); if ε₃&gt;ε_d then transmitted waves are evanescent and reflection can be near unity.
        </div>
      </article>

      <article class="card">
        <h3>Sanity checks</h3>
        <ul>
          <li><b>Units:</b> Each term in (kₓ²+kᵧ²)/ε₃ + k_z²/εt has units of (1/m²). RHS k₀² also (1/m²). Good.</li>
          <li><b>Limiting case:</b> If εt&gt;0 and ε₃&gt;0, k-surface becomes an ellipsoid (closed), no unbounded k.</li>
          <li><b>Sign logic:</b> For Type-II, the minus sign in −k_z²/|εt| opens the surface → allows large k_t.</li>
          <li><b>Physical meaning:</b> High-k modes exist, but coupling from an external propagating wave is restricted by tangential k conservation.</li>
        </ul>
      </article>
    </section>

    <!-- PART 4 -->
    <section id="p4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <article class="card">
        <h3>Re-interpreting the final formula: what controls what?</h3>
        <ul>
          <li><b>ε₃</b> sets the <b>threshold</b> k_t ≥ √ε₃ k₀ for Type-II propagation. Larger ε₃ means a higher “entry barrier” for transverse k.</li>
          <li><b>|εt|</b> scales k_z² = |εt|(k_t²/ε₃ − k₀²). Larger |εt| increases |k_z| for the same k_t (steeper hyperbola branch in k-space).</li>
          <li><b>k_t</b> corresponds to transverse spatial detail: higher k_t → smaller λ_t → finer features can propagate inside.</li>
        </ul>
      </article>

      <article class="card">
        <h3>How changing parameters affects outcomes (connect to the plots)</h3>
        <ul>
          <li>Increase <b>ε₃</b>: the hyperbola shifts so you need larger k_t to get real k_z; reflectance increases for ordinary incidence because fewer angles satisfy propagation inside.</li>
          <li>Increase <b>|εt|</b> (Type-II): once propagation is allowed, |k_z| grows faster with k_t, but interface mismatch can still keep R high.</li>
          <li>Increase <b>ε_d</b> (incident dielectric): raises the maximum available k_t = k₀√ε_d; improves the chance to meet k_t ≥ √ε₃ k₀ and can reduce reflectance at larger angles.</li>
        </ul>
      </article>

      <article class="card">
        <h3>Alternative derivation idea (brief)</h3>
        <p style="margin:0;">
          A more general route is to solve the anisotropic plane-wave eigenvalue problem:
          impose k×(k×E) + k₀² ε̿ E = 0 and require a non-trivial E.
          The determinant condition gives the Fresnel equation, whose extraordinary branch reduces to the hyperbolic quadratic above for the uniaxial case.
        </p>
      </article>

      <article class="callout">
        <h3>Concept checks (self-test, with answers)</h3>
        <ul>
          <li><b>Q:</b> Why does “hyperbolic” imply potentially unbounded k? <b>A:</b> Hyperboloids are open surfaces; they do not cap coordinates the way ellipsoids do.</li>
          <li><b>Q:</b> In Type-II, what must be large to get propagation along z? <b>A:</b> The transverse wavevector k_t must exceed √ε₃ k₀.</li>
          <li><b>Q:</b> If a medium supports high-k modes, does that guarantee low reflection from air? <b>A:</b> No—air cannot supply the required k_t; coupling is poor and reflection can be near unity.</li>
          <li><b>Q:</b> What parameter change helps air couple better? <b>A:</b> Lower ε₃ (reduces threshold) or use a higher-index incident medium (larger ε_d) or a grating/prism to add k_t.</li>
        </ul>
      </article>
    </section>

    <!-- PART 5 -->
    <section id="p5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <article class="card">
        <h3>What each canvas shows</h3>
        <ul>
          <li><b>Diagram canvas:</b> An interface at z=0 with an incident TM wave. It labels εt and ε₃ and shows which are negative/positive for the chosen type.</li>
          <li><b>Main k-space plot:</b> Cross-section of the k-surface in the (kₓ, k_z) plane at kᵧ=0, plotted in units of k₀. The curve is the allowed set satisfying
            (kₓ²/ε₃) + (k_z²/εt) = 1 (normalized form).</li>
          <li><b>Reflectance plot:</b> TM reflectance R(θ)=|r_p|² vs incidence angle θ (degrees) for the interface model. It also marks whether the transmitted k_{z2} is real (propagating) or imaginary (evanescent) at each θ.</li>
        </ul>
      </article>

      <article class="card">
        <h3>How the controls affect everything</h3>
        <ul>
          <li><b>Medium type:</b> Switches the signs: Type-II sets εt&lt;0, ε₃&gt;0; Type-I sets εt&gt;0, ε₃&lt;0. This changes the hyperbola orientation and propagation condition.</li>
          <li><b>|εt| slider:</b> Changes how fast k_z grows once propagation is allowed; the hyperbola opens more/less in k_z.</li>
          <li><b>|ε₃| slider:</b> Sets the propagation threshold k_t ≥ √ε₃ k₀ (Type-II). Larger ε₃ makes it harder for ordinary incident waves to couple, raising reflectance.</li>
          <li><b>ε_d slider:</b> Changes available incident k_t = k₀√ε_d sinθ and also affects the Fresnel coefficient; larger ε_d usually improves coupling.</li>
        </ul>
        <p class="cap" style="margin-top:8px;">
          All plots use the same symbols as the text: εt, ε₃, ε_d, k₀, k_t. For plotting we set k₀=1 (normalization).
        </p>
      </article>
    </section>

    <footer>
      <div class="wrap" style="padding:0;">
        Built as a self-contained learning article (vanilla HTML/CSS/JS). Tip: print this page for a clean worksheet-style handout.
      </div>
    </footer>
  </main>
</div>

<script>
/* ----------------------- Copy buttons ----------------------- */
(function(){
  function copyText(t){
    if(!navigator.clipboard){
      const ta=document.createElement('textarea');
      ta.value=t; document.body.appendChild(ta);
      ta.select(); document.execCommand('copy');
      document.body.removeChild(ta);
      return Promise.resolve();
    }
    return navigator.clipboard.writeText(t);
  }
  document.addEventListener('click', (e)=>{
    const b = e.target.closest('.copyBtn');
    if(!b) return;
    const t = b.getAttribute('data-copy') || '';
    const old = b.textContent;
    copyText(t).then(()=>{
      b.textContent='Copied!';
      setTimeout(()=>b.textContent=old, 900);
    }).catch(()=>{
      b.textContent='Copy failed';
      setTimeout(()=>b.textContent=old, 900);
    });
  });
})();

/* ----------------------- Canvas utilities ----------------------- */
function setupCanvas(canvas){
  const ctx = canvas.getContext('2d');
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(2, Math.floor(rect.width * dpr));
    const h = Math.max(2, Math.floor(rect.height * dpr));
    if(canvas.width !== w || canvas.height !== h){
      canvas.width = w; canvas.height = h;
    }
    ctx.setTransform(1,0,0,1,0,0);
    ctx.scale(dpr, dpr);
    return {w: rect.width, h: rect.height, dpr};
  }
  return {ctx, resize};
}

function niceTicks(min, max, approx=6){
  const span = max-min;
  if(span<=0) return {ticks:[min], step:1};
  const raw = span/approx;
  const pow = Math.pow(10, Math.floor(Math.log10(raw)));
  const candidates = [1,2,2.5,5,10].map(m=>m*pow);
  let step = candidates[0];
  for(const s of candidates){ if(Math.abs(raw-s) < Math.abs(raw-step)) step=s; }
  const start = Math.ceil(min/step)*step;
  const ticks=[];
  for(let v=start; v<=max+1e-9; v+=step) ticks.push(v);
  return {ticks, step};
}

function drawAxes(ctx, rect, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
  const {x,y,w,h} = rect;
  // background
  ctx.save();
  ctx.clearRect(x,y,w,h);

  // title
  ctx.fillStyle = 'rgba(255,255,255,.92)';
  ctx.font = '600 14px ui-sans-serif, system-ui';
  ctx.fillText(title, x+10, y+18);

  const plot = {x: x+55, y: y+30, w: w-70, h: h-60};

  // grid + ticks
  const xt = niceTicks(xMin, xMax, 7).ticks;
  const yt = niceTicks(yMin, yMax, 6).ticks;

  ctx.strokeStyle = 'rgba(255,255,255,.10)';
  ctx.lineWidth = 1;

  // gridlines x
  for(const xv of xt){
    const px = plot.x + (xv-xMin)/(xMax-xMin)*plot.w;
    ctx.beginPath();
    ctx.moveTo(px, plot.y);
    ctx.lineTo(px, plot.y+plot.h);
    ctx.stroke();
  }
  // gridlines y
  for(const yv of yt){
    const py = plot.y + plot.h - (yv-yMin)/(yMax-yMin)*plot.h;
    ctx.beginPath();
    ctx.moveTo(plot.x, py);
    ctx.lineTo(plot.x+plot.w, py);
    ctx.stroke();
  }

  // axis box
  ctx.strokeStyle = 'rgba(255,255,255,.18)';
  ctx.strokeRect(plot.x, plot.y, plot.w, plot.h);

  // tick labels
  ctx.fillStyle = 'rgba(255,255,255,.78)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

  for(const xv of xt){
    const px = plot.x + (xv-xMin)/(xMax-xMin)*plot.w;
    ctx.fillText(formatTick(xv), px-10, plot.y+plot.h+16);
  }
  for(const yv of yt){
    const py = plot.y + plot.h - (yv-yMin)/(yMax-yMin)*plot.h;
    ctx.fillText(formatTick(yv), plot.x-42, py+4);
  }

  // axis labels
  ctx.fillStyle = 'rgba(255,255,255,.85)';
  ctx.font = '600 12px ui-sans-serif, system-ui';
  ctx.fillText(xLabel, plot.x + plot.w/2 - ctx.measureText(xLabel).width/2, plot.y+plot.h+34);

  ctx.save();
  ctx.translate(plot.x-46, plot.y + plot.h/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
  ctx.restore();

  ctx.restore();
  return plot;

  function formatTick(v){
    const av = Math.abs(v);
    if(av>=1000 || (av>0 && av<0.01)) return v.toExponential(1);
    let s = v.toFixed(2);
    s = s.replace(/\.?0+$/,'');
    return s;
  }
}

function mapToPlot(plot, xMin, xMax, yMin, yMax, xVal, yVal){
  const px = plot.x + (xVal-xMin)/(xMax-xMin)*plot.w;
  const py = plot.y + plot.h - (yVal-yMin)/(yMax-yMin)*plot.h;
  return {px, py};
}

/* ----------------------- Physics model ----------------------- */
// Normalized plotting: set k0 = 1 for all canvases.
function modelParams(){
  const type = document.getElementById('selType').value;
  const absEt = parseFloat(document.getElementById('rngEt').value);
  const absEz = parseFloat(document.getElementById('rngEz').value);
  const ed = parseFloat(document.getElementById('rngEd').value);

  let et, ez;
  if(type === 'type2'){
    et = -absEt;  // εt < 0
    ez = +absEz;  // ε3 > 0
  }else{
    et = +absEt;  // εt > 0
    ez = -absEz;  // ε3 < 0
  }
  return {type, et, ez, ed, k0:1};
}

function kz2FromKt(kt, p){
  // Dispersion: kt^2/ez + kz^2/et = k0^2, with k0=1.
  // kz^2 = et*(k0^2 - kt^2/ez)
  const val = p.et*(p.k0*p.k0 - (kt*kt)/p.ez);
  return val; // may be negative => imaginary kz
}

function rpTM(theta, p){
  // Interface: isotropic εd -> uniaxial (εt, εz=ε3), optic axis along z normal to interface.
  // kt = k0*sqrt(εd)*sinθ
  // kz1 = k0*sqrt(εd)*cosθ
  // kz2^2 = εt*k0^2*(1 - (εd/εz) sin^2θ)
  const k0 = p.k0;
  const s = Math.sin(theta), c = Math.cos(theta);
  const kt = k0*Math.sqrt(p.ed)*s;
  const kz1 = k0*Math.sqrt(p.ed)*c;

  const kz2sq = p.et * k0*k0 * (1 - (p.ed/p.ez)*s*s);
  // Complex kz2: represent as (a + i b). We'll take principal sqrt.
  const kz2 = complexSqrt(kz2sq);

  // rp = (εt kz1 - εd kz2)/(εt kz1 + εd kz2)
  const num = csub( cmulReal(kz2, p.ed), {re: p.et*kz1, im:0} ); // careful with sign
  // Actually num = (εt kz1 - εd kz2)
  const num2 = csub({re: p.et*kz1, im:0}, cmulReal(kz2, p.ed));
  const den2 = cadd({re: p.et*kz1, im:0}, cmulReal(kz2, p.ed));
  const r = cdiv(num2, den2);
  const R = r.re*r.re + r.im*r.im;
  return {R, kt, kz2sq};
}

/* ----- complex helpers ----- */
function complexSqrt(x){
  // sqrt of a real number returning complex
  if(x >= 0) return {re: Math.sqrt(x), im: 0};
  return {re: 0, im: Math.sqrt(-x)};
}
function cadd(a,b){ return {re:a.re+b.re, im:a.im+b.im}; }
function csub(a,b){ return {re:a.re-b.re, im:a.im-b.im}; }
function cmulReal(a, r){ return {re:a.re*r, im:a.im*r}; }
function cdiv(a,b){
  const den = b.re*b.re + b.im*b.im;
  return {re:(a.re*b.re + a.im*b.im)/den, im:(a.im*b.re - a.re*b.im)/den};
}

/* ----------------------- Drawing ----------------------- */
const diag = setupCanvas(document.getElementById('cDiagram'));
const ks = setupCanvas(document.getElementById('cKsurface'));
const refl = setupCanvas(document.getElementById('cReflect'));

function drawAll(){
  const p = modelParams();

  // UI labels
  document.getElementById('labEd').textContent = p.ed.toFixed(2);
  document.getElementById('labEt').textContent = (p.et>=0?'+':'−') + Math.abs(p.et).toFixed(1);
  document.getElementById('labEz').textContent = (p.ez>=0?'+':'−') + Math.abs(p.ez).toFixed(1);

  // threshold note (for Type-II only, but show generic)
  const thresh = (p.ez>0) ? Math.sqrt(Math.abs(p.ez)) : NaN;
  document.getElementById('pillThresh').textContent =
    (p.type==='type2')
      ? `Type-II threshold: k_t ≥ √ε₃ k₀ = ${Math.sqrt(p.ez).toFixed(2)} k₀`
      : `Type-I: ε₃<0 (different propagation condition)`;
  document.getElementById('pillNote').textContent =
    `Current: εt=${p.et.toFixed(2)}, ε₃=${p.ez.toFixed(2)}, ε_d=${p.ed.toFixed(2)}`;

  drawDiagram(p);
  drawKsurface(p);
  drawReflectance(p);
}

function drawDiagram(p){
  const {ctx, resize} = diag;
  const R = resize();
  const w = R.w, h = R.h;

  ctx.clearRect(0,0,w,h);

  // soft border lighting
  ctx.save();
  ctx.globalAlpha = 1;
  // Title
  ctx.fillStyle = 'rgba(255,255,255,.92)';
  ctx.font = '600 14px ui-sans-serif, system-ui';
  ctx.fillText('Interface & optic-axis geometry (example setup)', 12, 20);

  // Interface block
  const x0 = 18, y0 = 38, W = w-36, H = h-56;
  const mid = x0 + W*0.45;

  // Left (dielectric)
  ctx.fillStyle = 'rgba(125,211,252,.06)';
  ctx.strokeStyle = 'rgba(125,211,252,.25)';
  roundRect(ctx, x0, y0, mid-x0, H, 14, true, true);

  // Right (hyperbolic)
  ctx.fillStyle = 'rgba(167,139,250,.06)';
  ctx.strokeStyle = 'rgba(167,139,250,.25)';
  roundRect(ctx, mid, y0, x0+W-mid, H, 14, true, true);

  // Interface line
  ctx.strokeStyle = 'rgba(255,255,255,.35)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(mid, y0);
  ctx.lineTo(mid, y0+H);
  ctx.stroke();

  // Labels
  ctx.fillStyle = 'rgba(255,255,255,.86)';
  ctx.font = '600 13px ui-sans-serif, system-ui';
  ctx.fillText(`Isotropic dielectric (ε_d = ${p.ed.toFixed(2)})`, x0+14, y0+22);

  const typeName = (p.type==='type2') ? 'Type-II hyperbolic' : 'Type-I hyperbolic';
  ctx.fillText(`${typeName} medium`, mid+14, y0+22);

  ctx.fillStyle = 'rgba(255,255,255,.78)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';

  const etStr = `εt=ε1=ε2 ${p.et>=0?'>0':'<0'} (${p.et.toFixed(2)})`;
  const ezStr = `ε3 ${p.ez>=0?'>0':'<0'} (${p.ez.toFixed(2)})`;
  ctx.fillText(etStr, mid+14, y0+44);
  ctx.fillText(ezStr, mid+14, y0+62);

  // axes
  const axx = mid+W*0.34, axy = y0+H*0.75;
  drawArrow(ctx, axx, axy, axx+60, axy, 'x');
  drawArrow(ctx, axx, axy, axx, axy-60, 'z');

  // incident ray
  const srcx = x0+W*0.15, srcy = y0+H*0.75;
  const hitx = mid, hity = y0+H*0.55;
  ctx.strokeStyle = 'rgba(255,255,255,.85)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(srcx, srcy);
  ctx.lineTo(hitx, hity);
  ctx.stroke();

  // reflected
  ctx.strokeStyle = 'rgba(255,255,255,.45)';
  ctx.setLineDash([6,5]);
  ctx.beginPath();
  ctx.moveTo(hitx, hity);
  ctx.lineTo(x0+W*0.18, y0+H*0.35);
  ctx.stroke();
  ctx.setLineDash([]);

  // transmitted direction (qualitative)
  ctx.strokeStyle = 'rgba(255,255,255,.55)';
  ctx.beginPath();
  ctx.moveTo(hitx, hity);
  ctx.lineTo(mid+W*0.22, y0+H*0.62);
  ctx.stroke();

  ctx.fillStyle = 'rgba(255,255,255,.78)';
  ctx.font = '12px ui-sans-serif, system-ui';
  ctx.fillText('incident TM wave', srcx-10, srcy+18);
  ctx.fillText('interface z=0', mid-45, y0+H-10);

  // angle theta
  const nLen = 46;
  const nx = mid, ny = hity;
  ctx.strokeStyle='rgba(125,211,252,.85)';
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(nx, ny);
  ctx.lineTo(nx, ny-nLen);
  ctx.stroke();
  ctx.fillStyle='rgba(125,211,252,.9)';
  ctx.fillText('normal', nx+6, ny-nLen+12);

  ctx.fillStyle='rgba(255,255,255,.75)';
  ctx.fillText('θ', nx-18, ny-20);

  ctx.restore();
}

function drawKsurface(p){
  const {ctx, resize} = ks;
  const R = resize();
  const w = R.w, h = R.h;

  // axes bounds in normalized units (k/k0)
  const xMin=-4, xMax=4, yMin=-4, yMax=4;
  const plot = drawAxes(ctx, {x:0,y:0,w,h}, xMin, xMax, yMin, yMax,
                        'kₓ / k₀', 'k_z / k₀',
                        'k-surface cross-section (kᵧ = 0)');

  // legend
  ctx.save();
  ctx.fillStyle='rgba(255,255,255,.78)';
  ctx.font='12px ui-sans-serif, system-ui';
  const lgx = plot.x + plot.w - 210;
  const lgy = plot.y + 10;
  ctx.fillText('Curve: allowed k (real)', lgx+22, lgy+12);
  ctx.strokeStyle='rgba(125,211,252,.9)';
  ctx.lineWidth=3;
  ctx.beginPath(); ctx.moveTo(lgx, lgy+8); ctx.lineTo(lgx+18, lgy+8); ctx.stroke();

  ctx.fillStyle='rgba(255,255,255,.78)';
  ctx.fillText('Shaded: real k_z region', lgx+22, lgy+32);
  ctx.fillStyle='rgba(52,211,153,.10)';
  ctx.fillRect(lgx, lgy+24, 18, 12);
  ctx.strokeStyle='rgba(52,211,153,.25)';
  ctx.strokeRect(lgx, lgy+24, 18, 12);
  ctx.restore();

  // Determine real kz region for Type-II: kz^2 = et(1 - kx^2/ez) with ky=0, k0=1
  // Actually from dispersion: kx^2/ez + kz^2/et = 1 => kz^2 = et*(1 - kx^2/ez)
  // For et<0, kz^2 >=0 requires (1 - kx^2/ez) <= 0 -> |kx| >= sqrt(ez) (when ez>0).
  // For Type-I (ez<0): kz^2 = et*(1 - kx^2/ez) = et*(1 + kx^2/|ez|) always positive if et>0.
  // We'll shade where kz is real given ky=0.
  ctx.save();
  ctx.fillStyle = 'rgba(52,211,153,.10)';
  ctx.strokeStyle = 'rgba(52,211,153,.0)';
  const samples = 500;
  for(let i=0;i<samples;i++){
    const kx = xMin + (xMax-xMin)*(i/(samples-1));
    const kz2 = p.et*(1 - (kx*kx)/p.ez);
    const real = kz2 >= 0;
    if(real){
      // shade a thin vertical strip behind curve
      const xpix = plot.x + (kx-xMin)/(xMax-xMin)*plot.w;
      ctx.fillRect(xpix, plot.y, plot.w/samples+1, plot.h);
    }
  }
  ctx.restore();

  // draw the curve(s) kz = ±sqrt(et*(1 - kx^2/ez))
  ctx.save();
  ctx.strokeStyle = 'rgba(125,211,252,.95)';
  ctx.lineWidth = 2.5;

  function drawBranch(sign){
    let started=false;
    ctx.beginPath();
    for(let i=0;i<samples;i++){
      const kx = xMin + (xMax-xMin)*(i/(samples-1));
      const kz2 = p.et*(1 - (kx*kx)/p.ez);
      if(kz2>=0){
        const kz = sign*Math.sqrt(kz2);
        const P = mapToPlot(plot, xMin, xMax, yMin, yMax, kx, kz);
        if(!started){ ctx.moveTo(P.px, P.py); started=true; }
        else ctx.lineTo(P.px, P.py);
      }else{
        if(started){ ctx.stroke(); ctx.beginPath(); started=false; }
      }
    }
    if(started) ctx.stroke();
  }
  drawBranch(+1);
  drawBranch(-1);
  ctx.restore();

  // annotate thresholds for Type-II (if ez>0)
  ctx.save();
  if(p.ez>0){
    const xth = Math.sqrt(p.ez);
    ctx.strokeStyle='rgba(251,191,36,.65)';
    ctx.lineWidth=2;
    ctx.setLineDash([6,6]);
    for(const sgn of [-1, +1]){
      const xval = sgn*xth;
      const P1 = mapToPlot(plot, xMin, xMax, yMin, yMax, xval, yMin);
      const P2 = mapToPlot(plot, xMin, xMax, yMin, yMax, xval, yMax);
      ctx.beginPath(); ctx.moveTo(P1.px, P1.py); ctx.lineTo(P2.px, P2.py); ctx.stroke();
    }
    ctx.setLineDash([]);
    ctx.fillStyle='rgba(251,191,36,.9)';
    ctx.font='12px ui-sans-serif, system-ui';
    ctx.fillText(`|kₓ| = √ε₃ ≈ ${xth.toFixed(2)}  (ky=0 threshold for real kz when εt<0)`, plot.x+10, plot.y+plot.h-10);
  }
  ctx.restore();
}

function drawReflectance(p){
  const {ctx, resize} = refl;
  const R = resize();
  const w = R.w, h = R.h;

  const xMin=0, xMax=85, yMin=0, yMax=1.05;
  const plot = drawAxes(ctx, {x:0,y:0,w,h}, xMin, xMax, yMin, yMax,
                        'Incidence angle θ (deg)', 'Reflectance R (unitless)',
                        'TM reflectance vs angle + propagation indicator');

  // draw R(θ)
  const N=400;
  ctx.save();
  ctx.strokeStyle='rgba(167,139,250,.95)';
  ctx.lineWidth=2.5;
  ctx.beginPath();
  for(let i=0;i<N;i++){
    const thDeg = xMin + (xMax-xMin)*(i/(N-1));
    const th = thDeg*Math.PI/180;
    const out = rpTM(th, p);
    const Rval = clamp(out.R, 0, 1.2);
    const P = mapToPlot(plot, xMin, xMax, yMin, yMax, thDeg, Rval);
    if(i===0) ctx.moveTo(P.px, P.py);
    else ctx.lineTo(P.px, P.py);
  }
  ctx.stroke();
  ctx.restore();

  // propagation indicator band at bottom: green where kz2^2 >=0 (real kz2), red where <0
  ctx.save();
  const bandH = 10;
  for(let i=0;i<N;i++){
    const thDeg = xMin + (xMax-xMin)*(i/(N-1));
    const th = thDeg*Math.PI/180;
    const out = rpTM(th, p);
    const prop = out.kz2sq >= 0;
    ctx.fillStyle = prop ? 'rgba(52,211,153,.55)' : 'rgba(251,113,133,.55)';
    const xp = plot.x + (thDeg-xMin)/(xMax-xMin)*plot.w;
    ctx.fillRect(xp, plot.y+plot.h-bandH, plot.w/N+1, bandH);
  }
  ctx.strokeStyle='rgba(255,255,255,.18)';
  ctx.strokeRect(plot.x, plot.y+plot.h-bandH, plot.w, bandH);
  ctx.fillStyle='rgba(255,255,255,.78)';
  ctx.font='12px ui-sans-serif, system-ui';
  ctx.fillText('Propagation inside hyperbolic medium: green = real k_z2, red = evanescent', plot.x+10, plot.y+plot.h-bandH-8);
  ctx.restore();

  // legend
  ctx.save();
  const lgx = plot.x + plot.w - 260;
  const lgy = plot.y + 10;
  ctx.fillStyle='rgba(255,255,255,.78)';
  ctx.font='12px ui-sans-serif, system-ui';

  ctx.strokeStyle='rgba(167,139,250,.95)';
  ctx.lineWidth=3;
  ctx.beginPath(); ctx.moveTo(lgx, lgy+8); ctx.lineTo(lgx+18, lgy+8); ctx.stroke();
  ctx.fillText('R(θ) = |r_p|²', lgx+24, lgy+12);

  ctx.fillStyle='rgba(52,211,153,.55)';
  ctx.fillRect(lgx, lgy+20, 18, 10);
  ctx.fillStyle='rgba(255,255,255,.78)';
  ctx.fillText('propagating in medium', lgx+24, lgy+29);

  ctx.fillStyle='rgba(251,113,133,.55)';
  ctx.fillRect(lgx, lgy+38, 18, 10);
  ctx.fillStyle='rgba(255,255,255,.78)';
  ctx.fillText('evanescent in medium', lgx+24, lgy+47);
  ctx.restore();
}

function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke){ ctx.lineWidth=1.5; ctx.stroke(); }
}

function drawArrow(ctx, x1,y1,x2,y2,label){
  const dx=x2-x1, dy=y2-y1;
  const L=Math.hypot(dx,dy)||1;
  const ux=dx/L, uy=dy/L;
  const ah=8;
  ctx.strokeStyle='rgba(255,255,255,.70)';
  ctx.lineWidth=2;
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x2,y2);
  ctx.lineTo(x2-ux*ah-uy*ah*0.6, y2-uy*ah+ux*ah*0.6);
  ctx.lineTo(x2-ux*ah+uy*ah*0.6, y2-uy*ah-ux*ah*0.6);
  ctx.closePath();
  ctx.fillStyle='rgba(255,255,255,.70)';
  ctx.fill();
  ctx.fillStyle='rgba(255,255,255,.78)';
  ctx.font='12px ui-sans-serif, system-ui';
  ctx.fillText(label, x2+6, y2+4);
}

/* ----------------------- Events ----------------------- */
function attach(){
  const els = ['selType','rngEt','rngEz','rngEd'];
  els.forEach(id=>{
    document.getElementById(id).addEventListener('input', drawAll);
    document.getElementById(id).addEventListener('change', drawAll);
  });
  document.getElementById('btnReset').addEventListener('click', ()=>{
    document.getElementById('selType').value='type2';
    document.getElementById('rngEt').value='2.0';
    document.getElementById('rngEz').value='3.0';
    document.getElementById('rngEd').value='1.00';
    drawAll();
  });
  window.addEventListener('resize', drawAll, {passive:true});
}

/* init */
attach();
drawAll();
</script>
</body>
</html>
