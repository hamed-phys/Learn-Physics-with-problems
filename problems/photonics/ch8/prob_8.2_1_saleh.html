<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>8.2-1 — Group Velocity in a Metal (Simplified Drude Model)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel: rgba(255,255,255,0.06);
      --panel2: rgba(255,255,255,0.085);
      --text: rgba(255,255,255,0.92);
      --muted: rgba(255,255,255,0.72);
      --faint: rgba(255,255,255,0.55);
      --line: rgba(255,255,255,0.14);
      --accent: #7bdcff;
      --accent2:#a8ffbd;
      --warn:#ffd27b;
      --danger:#ff7b9a;
      --shadow: 0 18px 60px rgba(0,0,0,0.45);
      --radius: 16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: var(--sans);
      color: var(--text);
      background:
        radial-gradient(1200px 700px at 18% 12%, rgba(123,220,255,0.16), transparent 55%),
        radial-gradient(900px 600px at 80% 20%, rgba(168,255,189,0.10), transparent 50%),
        radial-gradient(1200px 700px at 60% 92%, rgba(255,210,123,0.10), transparent 55%),
        linear-gradient(180deg, #070a14 0%, #0b1020 50%, #070a14 100%);
      overflow-x:hidden;
    }

    a{ color: var(--accent); text-decoration: none; }
    a:hover{ text-decoration: underline; }

    header{
      position: relative;
      padding: 38px 18px 18px;
    }

    .wrap{
      max-width: 1150px;
      margin: 0 auto;
      padding: 0 14px 50px;
    }

    .hero{
      display:grid;
      grid-template-columns: 1.35fr 0.65fr;
      gap: 14px;
      align-items: stretch;
    }

    @media (max-width: 980px){
      .hero{ grid-template-columns: 1fr; }
    }

    .card{
      background: var(--panel);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 16px 16px 14px;
      backdrop-filter: blur(10px);
    }

    .title{
      margin:0 0 6px;
      font-size: clamp(1.35rem, 1.7vw + 1rem, 2.05rem);
      line-height:1.15;
      letter-spacing: 0.2px;
    }
    .subtitle{
      margin:0;
      color: var(--muted);
      font-size: 0.98rem;
      line-height:1.35;
    }

    .metaRow{
      margin-top: 12px;
      display:flex;
      flex-wrap: wrap;
      gap: 10px;
      align-items:center;
    }

    .pill{
      font-size: 0.84rem;
      color: var(--muted);
      background: rgba(255,255,255,0.06);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 6px 10px;
      border-radius: 999px;
      display:inline-flex;
      gap: 8px;
      align-items:center;
    }
    .dot{ width:8px; height:8px; border-radius:50%; display:inline-block; background: var(--accent); box-shadow: 0 0 0 3px rgba(123,220,255,0.18); }

    .toc{
      position: sticky;
      top: 12px;
      align-self: start;
      padding: 14px 14px 12px;
    }
    .toc h3{
      margin: 0 0 10px;
      font-size: 0.98rem;
      letter-spacing: 0.3px;
      color: var(--text);
    }
    .toc nav{
      display:flex;
      flex-direction: column;
      gap: 8px;
      font-size: 0.92rem;
    }
    .toc a{
      color: var(--muted);
      padding: 6px 8px;
      border-radius: 10px;
      border: 1px solid transparent;
      transition: transform 140ms ease, background 140ms ease, border-color 140ms ease;
    }
    .toc a:hover{
      color: var(--text);
      background: rgba(255,255,255,0.06);
      border-color: rgba(255,255,255,0.12);
      transform: translateX(2px);
      text-decoration:none;
    }

    main{
      padding: 10px 0 34px;
    }

    section{
      margin-top: 14px;
      scroll-margin-top: 16px;
    }

    .sectionTitle{
      margin: 0 0 10px;
      font-size: 1.18rem;
      letter-spacing: 0.2px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    @media (max-width: 980px){
      .grid2{ grid-template-columns: 1fr; }
    }

    .callout{
      border-radius: 14px;
      padding: 12px 12px 10px;
      border: 1px solid rgba(255,255,255,0.14);
      background: rgba(255,255,255,0.055);
    }
    .callout h4{
      margin: 0 0 8px;
      font-size: 0.98rem;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .badge{
      font-size: 0.78rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid rgba(255,255,255,0.18);
      background: rgba(255,255,255,0.06);
      color: var(--muted);
      letter-spacing: 0.3px;
    }
    .badge.assump{ border-color: rgba(168,255,189,0.34); background: rgba(168,255,189,0.10); color: rgba(206,255,224,0.95); }
    .badge.keyeq{ border-color: rgba(123,220,255,0.34); background: rgba(123,220,255,0.10); color: rgba(203,244,255,0.95); }
    .badge.warn{ border-color: rgba(255,210,123,0.38); background: rgba(255,210,123,0.12); color: rgba(255,235,206,0.95); }
    .badge.ans{ border-color: rgba(255,123,154,0.36); background: rgba(255,123,154,0.12); color: rgba(255,220,232,0.95); }

    p{ color: var(--muted); line-height: 1.55; margin: 10px 0; }
    ul{ color: var(--muted); line-height: 1.55; margin: 10px 0 10px 20px; }
    li{ margin: 6px 0; }

    .eqRow{
      display:flex;
      gap: 10px;
      align-items: stretch;
      flex-wrap: wrap;
      margin: 10px 0;
    }

    .eq{
      flex: 1 1 520px;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.14);
      border-radius: 14px;
      padding: 10px 10px 10px;
      overflow:auto;
      position:relative;
    }
    .eq pre{
      margin:0;
      font-family: var(--mono);
      font-size: 0.92rem;
      color: rgba(255,255,255,0.92);
      white-space: pre-wrap;
    }
    .copyBtn{
      flex: 0 0 auto;
      align-self: flex-start;
      border-radius: 12px;
      padding: 9px 10px;
      background: rgba(255,255,255,0.08);
      border: 1px solid rgba(255,255,255,0.14);
      color: var(--text);
      cursor:pointer;
      transition: transform 120ms ease, background 120ms ease;
      font-size: 0.9rem;
    }
    .copyBtn:hover{ transform: translateY(-1px); background: rgba(255,255,255,0.11); }
    .copyBtn:active{ transform: translateY(0px) scale(0.99); }
    .copyBtn.ok{ border-color: rgba(168,255,189,0.42); background: rgba(168,255,189,0.12); }

    .vizHeader{
      display:flex;
      gap: 12px;
      flex-wrap: wrap;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .controls{
      display:flex;
      gap: 10px;
      flex-wrap: wrap;
      align-items:center;
      justify-content:flex-end;
    }
    label{
      font-size: 0.92rem;
      color: var(--muted);
      display:flex;
      gap: 10px;
      align-items:center;
      background: rgba(255,255,255,0.05);
      border: 1px solid rgba(255,255,255,0.12);
      padding: 8px 10px;
      border-radius: 12px;
    }
    input[type="range"]{ width: 210px; }
    .readout{
      font-family: var(--mono);
      font-size: 0.9rem;
      color: rgba(255,255,255,0.90);
      padding: 2px 8px;
      border-radius: 999px;
      background: rgba(0,0,0,0.25);
      border: 1px solid rgba(255,255,255,0.12);
    }

    figure{ margin:0; }
    canvas{
      width: 100%;
      height: 320px;
      display:block;
      border-radius: 14px;
      background: rgba(0,0,0,0.22);
      border: 1px solid rgba(255,255,255,0.14);
    }
    .canvasTall{ height: 360px; }
    .canvasShort{ height: 300px; }

    .caption{
      margin-top: 8px;
      font-size: 0.92rem;
      color: var(--faint);
    }

    .divider{
      height:1px;
      background: rgba(255,255,255,0.10);
      margin: 12px 0;
    }

    footer{
      padding: 22px 0 34px;
      color: var(--faint);
      font-size: 0.9rem;
    }

    /* subtle entrance */
    .fadeIn{
      animation: pop 520ms ease both;
    }
    @keyframes pop{
      from{ opacity:0; transform: translateY(8px); }
      to{ opacity:1; transform: translateY(0); }
    }

    /* print-friendly */
    @media print{
      body{ background:white; color:black; }
      .card, .callout, .eq{ box-shadow:none; backdrop-filter:none; }
      .toc{ display:none; }
      canvas{ border: 1px solid #ccc; }
      a{ color:#000; text-decoration: underline; }
      .copyBtn{ display:none; }
      .pill{ border-color:#ccc; color:#333; background:#f5f5f5; }
      p, ul, li{ color:#222; }
    }
  </style>
</head>

<body>
  <header class="wrap">
    <div class="hero">
      <div class="card fadeIn">
        <h1 class="title">8.2-1 — Group Velocity in a Metal (Simplified Drude Model)</h1>
        <p class="subtitle">
          Show that, for a dispersion described by the simplified Drude effective permittivity
          <span style="font-family:var(--mono); color:rgba(255,255,255,0.92);">ε(ω) ≈ ε0(1 − ωp²/ω²)</span>,
          the product of phase velocity and group velocity equals <span style="font-family:var(--mono);">c0²</span>.
        </p>
        <div class="metaRow">
          <span class="pill"><span class="dot"></span>Topic: dispersive EM waves</span>
          <span class="pill"><span class="dot" style="background:var(--accent2); box-shadow:0 0 0 3px rgba(168,255,189,0.18)"></span>Model: lossless Drude (simplified)</span>
          <span class="pill"><span class="dot" style="background:var(--warn); box-shadow:0 0 0 3px rgba(255,210,123,0.18)"></span>Result: symbolic identity</span>
        </div>
      </div>

      <aside class="card toc fadeIn" aria-label="Table of Contents">
        <h3>Mini Table of Contents</h3>
        <nav>
          <a href="#quick">Quick Summary</a>
          <a href="#part0">PART 0 — Concept Primer</a>
          <a href="#part1">PART 1 — Problem Analysis</a>
          <a href="#part2">PART 2 — Strategy & Tips</a>
          <a href="#part3">PART 3 — Full Solution</a>
          <a href="#part4">PART 4 — Deeper Understanding</a>
          <a href="#part5">PART 5 — Visualization Guide</a>
        </nav>
      </aside>
    </div>
  </header>

  <main class="wrap">
    <!-- Quick Summary -->
    <section id="quick" class="card fadeIn">
      <h2 class="sectionTitle">Quick Summary</h2>
      <ul>
        <li><b>What this is about:</b> wave propagation in a <b>dispersive metal</b> modeled by the simplified (lossless) Drude permittivity.</li>
        <li><b>Key physics idea:</b> dispersion makes <b>phase velocity</b> (<span style="font-family:var(--mono);">v<sub>p</sub></span>) and <b>group velocity</b> (<span style="font-family:var(--mono);">v<sub>g</sub></span>) differ, but they can be related by the shape of <span style="font-family:var(--mono);">k(ω)</span>.</li>
        <li><b>Governing relation:</b> for a plane wave in an isotropic medium,
          <span style="font-family:var(--mono);">k(ω)=ω√(μ ε(ω))</span> (here we take <span style="font-family:var(--mono);">μ≈μ0</span>).</li>
        <li><b>Drude (simplified) permittivity:</b> <span style="font-family:var(--mono);">ε(ω)≈ε0(1−ωp²/ω²)</span>, giving a cutoff: propagation only for <span style="font-family:var(--mono);">ω&gt;ωp</span> (otherwise <span style="font-family:var(--mono);">k</span> becomes imaginary).</li>
        <li><b>Velocities:</b> <span style="font-family:var(--mono);">v<sub>p</sub>=ω/k</span>, <span style="font-family:var(--mono);">v<sub>g</sub>=dω/dk</span>.</li>
        <li><b>Final result (symbolic):</b> <span style="font-family:var(--mono);">v<sub>p</sub> v<sub>g</sub> = c0²</span> for this lossless Drude model.</li>
      </ul>
    </section>

    <!-- PART 0 -->
    <section id="part0" class="card fadeIn">
      <h2 class="sectionTitle">PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <article class="callout">
          <h4><span class="badge keyeq">Core definitions</span></h4>
          <p>
            In a linear, homogeneous, isotropic medium supporting plane waves
            <span style="font-family:var(--mono);">E(z,t) ∝ exp[i(kz − ωt)]</span>:
          </p>
          <ul>
            <li><b>Angular frequency</b> <span style="font-family:var(--mono);">ω</span> [rad/s]: temporal oscillation rate.</li>
            <li><b>Wavenumber</b> <span style="font-family:var(--mono);">k</span> [1/m]: spatial oscillation rate along propagation direction.</li>
            <li><b>Phase velocity</b> <span style="font-family:var(--mono);">v<sub>p</sub>=ω/k</span> [m/s]: speed of a constant-phase point (e.g., a crest).</li>
            <li><b>Group velocity</b> <span style="font-family:var(--mono);">v<sub>g</sub>=dω/dk</span> [m/s]: speed of a narrowband pulse envelope (often linked to energy transport in low-loss media).</li>
          </ul>
          <div class="eqRow">
            <div class="eq" role="group" aria-label="Dispersion relation">
<pre>Plane-wave dispersion:  k(ω) = ω √( μ(ω) ε(ω) )</pre>
            </div>
            <button class="copyBtn" data-copy="Plane-wave dispersion: k(ω) = ω*sqrt( μ(ω)*ε(ω) )">Copy</button>
          </div>
        </article>

        <article class="callout">
          <h4><span class="badge assump">Physical meaning</span></h4>
          <p>
            <b>Dispersion</b> means the medium’s response depends on frequency, so
            <span style="font-family:var(--mono);">ε=ε(ω)</span> (and sometimes <span style="font-family:var(--mono);">μ=μ(ω)</span>).
            Then a pulse (a superposition of frequencies) reshapes because each frequency travels differently.
          </p>
          <p>
            In <b>low-loss</b> media, <span style="font-family:var(--mono);">v<sub>g</sub></span> is typically the energy velocity,
            while <span style="font-family:var(--mono);">v<sub>p</sub></span> is not directly an energy transport speed.
          </p>
          <ul>
            <li>If <span style="font-family:var(--mono);">k(ω)</span> is <b>linear</b>, then <span style="font-family:var(--mono);">v<sub>p</sub>=v<sub>g</sub></span> (no dispersion).</li>
            <li>If <span style="font-family:var(--mono);">k(ω)</span> is <b>curved</b>, then <span style="font-family:var(--mono);">v<sub>p</sub>≠v<sub>g</sub></span>.</li>
          </ul>
        </article>
      </div>

      <div class="divider"></div>

      <div class="grid2">
        <article class="callout">
          <h4><span class="badge keyeq">Simplified Drude model</span></h4>
          <p>
            The (simplified) Drude model captures the response of free electrons in a metal.
            Ignoring damping (collision loss), the effective permittivity becomes
          </p>

          <div class="eqRow">
            <div class="eq" role="group" aria-label="Simplified Drude permittivity">
<pre>ε(ω) ≈ ε0 ( 1 − ωp² / ω² )</pre>
            </div>
            <button class="copyBtn" data-copy="ε(ω) ≈ ε0 (1 − ωp^2/ω^2)">Copy</button>
          </div>

          <p>
            Here <span style="font-family:var(--mono);">ωp</span> [rad/s] is the <b>plasma frequency</b>.
            A key consequence:
          </p>
          <ul>
            <li>If <span style="font-family:var(--mono);">ω &lt; ωp</span>, then <span style="font-family:var(--mono);">ε(ω) &lt; 0</span> ⇒ <span style="font-family:var(--mono);">k</span> becomes imaginary ⇒ <b>no propagating bulk wave</b> (evanescent decay).</li>
            <li>If <span style="font-family:var(--mono);">ω &gt; ωp</span>, then <span style="font-family:var(--mono);">ε(ω) &gt; 0</span> ⇒ propagation is allowed.</li>
          </ul>
        </article>

        <article class="callout">
          <h4><span class="badge warn">What to watch for</span></h4>
          <ul>
            <li><b>Domain:</b> For this model, real propagation requires <span style="font-family:var(--mono);">ω&gt;ωp</span>. If you include <span style="font-family:var(--mono);">ω&lt;ωp</span> blindly, you’ll get imaginary refractive index and confusing “velocities.”</li>
            <li><b>Losses:</b> Real metals have damping; then <span style="font-family:var(--mono);">ε</span> is complex and the simple identity can break or require careful definitions.</li>
            <li><b>μ assumption:</b> We usually take <span style="font-family:var(--mono);">μ≈μ0</span> for non-magnetic metals at optical frequencies; changing μ(ω) changes results.</li>
            <li><b>Derivative step:</b> Group velocity comes from <span style="font-family:var(--mono);">v<sub>g</sub>=(dk/dω)^{-1}</span>; one missing chain-rule factor is the most common algebra slip.</li>
          </ul>
          <p>
            <b>Mini intuition example:</b> If the dispersion relation is <span style="font-family:var(--mono);">k=(1/c0)√(ω²−ωp²)</span>, then at high frequency
            (<span style="font-family:var(--mono);">ω≫ωp</span>) we recover free space: <span style="font-family:var(--mono);">k≈ω/c0</span>, so both <span style="font-family:var(--mono);">v<sub>p</sub></span> and <span style="font-family:var(--mono);">v<sub>g</sub></span> approach <span style="font-family:var(--mono);">c0</span>.
          </p>
        </article>
      </div>
    </section>

    <!-- PART 1 -->
    <section id="part1" class="card fadeIn">
      <h2 class="sectionTitle">PART 1 — Problem Analysis (No Solving Yet)</h2>

      <article class="callout">
        <h4><span class="badge">Restated problem</span></h4>
        <p>
          A metal is modeled by the simplified (lossless) Drude permittivity
          <span style="font-family:var(--mono);">ε(ω)=ε0(1−ωp²/ω²)</span>.
          Assuming an isotropic medium with <span style="font-family:var(--mono);">μ≈μ0</span>,
          show that for propagating frequencies the <b>phase velocity</b> <span style="font-family:var(--mono);">v<sub>p</sub></span> and <b>group velocity</b> <span style="font-family:var(--mono);">v<sub>g</sub></span> satisfy
          <span style="font-family:var(--mono);">v<sub>p</sub> v<sub>g</sub> = c0²</span>, where <span style="font-family:var(--mono);">c0</span> is the speed of light in vacuum.
        </p>

        <div class="grid2">
          <div>
            <p><b>Given</b></p>
            <ul>
              <li><span style="font-family:var(--mono);">ε(ω)=ε0(1−ωp²/ω²)</span></li>
              <li><span style="font-family:var(--mono);">μ≈μ0</span></li>
              <li>Plane-wave dispersion in a homogeneous isotropic medium</li>
            </ul>
          </div>
          <div>
            <p><b>Unknowns / what to show</b></p>
            <ul>
              <li>Find expressions for <span style="font-family:var(--mono);">v<sub>p</sub></span> and <span style="font-family:var(--mono);">v<sub>g</sub></span> vs <span style="font-family:var(--mono);">ω</span></li>
              <li>Prove <span style="font-family:var(--mono);">v<sub>p</sub> v<sub>g</sub> = c0²</span> (symbolic identity)</li>
              <li>State the frequency condition for which this holds (propagation regime)</li>
            </ul>
          </div>
        </div>
      </article>

      <div class="grid2" style="margin-top:12px;">
        <article class="callout">
          <h4><span class="badge">Relevant principles (and why)</span></h4>
          <ul>
            <li><b>Maxwell plane-wave dispersion:</b> in a linear homogeneous medium, <span style="font-family:var(--mono);">k=ω√(με)</span>. We need this because velocities come from <span style="font-family:var(--mono);">k(ω)</span>.</li>
            <li><b>Phase velocity definition:</b> <span style="font-family:var(--mono);">v<sub>p</sub>=ω/k</span>. Directly ties to phase fronts in <span style="font-family:var(--mono);">exp[i(kz−ωt)]</span>.</li>
            <li><b>Group velocity definition:</b> <span style="font-family:var(--mono);">v<sub>g</sub>=dω/dk</span>. Appropriate for a narrowband wave packet in a (nearly) lossless dispersive medium.</li>
          </ul>
          <p>
            We <b>do not</b> need boundary conditions or reflection/transmission here because the question is about <b>bulk propagation</b> and dispersion, not interfaces.
          </p>
        </article>

        <article class="callout">
          <h4><span class="badge assump">Assumptions</span></h4>
          <ul>
            <li><b>Lossless simplified Drude:</b> damping ignored ⇒ <span style="font-family:var(--mono);">ε(ω)</span> real.</li>
            <li><b>Non-magnetic medium:</b> <span style="font-family:var(--mono);">μ≈μ0</span> (typical for metals at optical/IR).</li>
            <li><b>Homogeneous, isotropic, linear:</b> scalar <span style="font-family:var(--mono);">ε(ω)</span>, plane waves are valid eigenmodes.</li>
            <li><b>Propagation regime:</b> use <span style="font-family:var(--mono);">ω&gt;ωp</span> so that <span style="font-family:var(--mono);">k</span> is real.</li>
          </ul>
        </article>
      </div>

      <article class="callout" style="margin-top:12px;">
        <h4><span class="badge">Possible approaches</span></h4>
        <ul>
          <li><b>Approach A (direct k(ω)):</b> Substitute <span style="font-family:var(--mono);">ε(ω)</span> into <span style="font-family:var(--mono);">k=ω√(με)</span>, simplify to a closed form <span style="font-family:var(--mono);">k(ω)</span>, then compute <span style="font-family:var(--mono);">v<sub>p</sub></span> and <span style="font-family:var(--mono);">v<sub>g</sub></span>. <b>Pros:</b> clean derivative; minimal algebra. <b>Cons:</b> must watch domain <span style="font-family:var(--mono);">ω&gt;ωp</span>.</li>
          <li><b>Approach B (refractive index n(ω)):</b> Define <span style="font-family:var(--mono);">n(ω)=√(ε/ε0)</span>, use <span style="font-family:var(--mono);">k=(nω)/c0</span>, then use standard identity <span style="font-family:var(--mono);">v<sub>g</sub>=c0/(n+ω dn/dω)</span>. <b>Pros:</b> connects to optics formulas. <b>Cons:</b> more steps; easy to slip on derivatives.</li>
          <li><b>Approach C (differentiate ω(k)):</b> Invert to <span style="font-family:var(--mono);">ω(k)</span>, then compute <span style="font-family:var(--mono);">v<sub>g</sub>=dω/dk</span> directly. <b>Pros:</b> intuitive. <b>Cons:</b> inversion step may be less direct.</li>
        </ul>
        <p><b>Best choice:</b> <b>Approach A</b> is fastest and most transparent because the Drude form produces a simple square-root expression for <span style="font-family:var(--mono);">k(ω)</span>.</p>
      </article>
    </section>

    <!-- PART 2 -->
    <section id="part2" class="card fadeIn">
      <h2 class="sectionTitle">PART 2 — Strategy & Tips (Roadmap Only)</h2>

      <article class="callout">
        <h4><span class="badge">Plan (5–10 steps)</span></h4>
        <ol style="color:var(--muted); line-height:1.55; margin:10px 0 10px 20px;">
          <li><b>Goal:</b> express the dispersion relation. <b>Tool:</b> plane-wave relation <span style="font-family:var(--mono);">k=ω√(με)</span>. <b>Meaning:</b> links material response to wave propagation.</li>
          <li><b>Goal:</b> insert Drude <span style="font-family:var(--mono);">ε(ω)</span> and simplify. <b>Tool:</b> algebra and <span style="font-family:var(--mono);">c0=1/√(μ0ε0)</span>. <b>Meaning:</b> get a compact <span style="font-family:var(--mono);">k(ω)</span> you can differentiate.</li>
          <li><b>Goal:</b> compute <span style="font-family:var(--mono);">v<sub>p</sub>=ω/k</span>. <b>Tool:</b> definition. <b>Meaning:</b> speed of phase fronts.</li>
          <li><b>Goal:</b> compute <span style="font-family:var(--mono);">v<sub>g</sub>=(dk/dω)^{-1}</span>. <b>Tool:</b> calculus. <b>Meaning:</b> speed of envelope for narrowband pulses.</li>
          <li><b>Goal:</b> multiply <span style="font-family:var(--mono);">v<sub>p</sub></span> and <span style="font-family:var(--mono);">v<sub>g</sub></span> and simplify to show it equals <span style="font-family:var(--mono);">c0²</span>. <b>Tool:</b> cancellation.</li>
          <li><b>Sanity checks:</b> units; limit <span style="font-family:var(--mono);">ω≫ωp</span> (recover free-space behavior); confirm propagation condition <span style="font-family:var(--mono);">ω&gt;ωp</span>.</li>
        </ol>
      </article>

      <div class="grid2" style="margin-top:12px;">
        <article class="callout">
          <h4><span class="badge warn">Common mistakes</span></h4>
          <ul>
            <li>Using <span style="font-family:var(--mono);">v<sub>g</sub>=dk/dω</span> instead of <span style="font-family:var(--mono);">v<sub>g</sub>=dω/dk</span>.</li>
            <li>Differentiating <span style="font-family:var(--mono);">k(ω)= (ω/c0)√(1−ωp²/ω²)</span> without simplifying first (invites algebra slips).</li>
            <li>Forgetting <span style="font-family:var(--mono);">c0=1/√(μ0ε0)</span>, which is what makes the final expression collapse cleanly.</li>
            <li>Trying to interpret velocities for <span style="font-family:var(--mono);">ω&lt;ωp</span> where <span style="font-family:var(--mono);">k</span> is imaginary (no traveling wave).</li>
          </ul>
        </article>

        <article class="callout">
          <h4><span class="badge">Quick tips</span></h4>
          <ul>
            <li>First rewrite <span style="font-family:var(--mono);">k(ω)</span> as <span style="font-family:var(--mono);">k=(1/c0)√(ω²−ωp²)</span>. The derivative becomes one line.</li>
            <li>Keep track of the <b>propagation regime</b> explicitly: <span style="font-family:var(--mono);">ω&gt;ωp</span>.</li>
            <li>Use the plots below to build intuition: near cutoff, <span style="font-family:var(--mono);">v<sub>g</sub></span> becomes small while <span style="font-family:var(--mono);">v<sub>p</sub></span> becomes large—yet their product stays constant.</li>
          </ul>
        </article>
      </div>
    </section>

    <!-- PART 3 -->
    <section id="part3" class="card fadeIn">
      <h2 class="sectionTitle">PART 3 — Full Solution (Detailed + Teaching)</h2>

      <article class="callout">
        <h4><span class="badge">Physical intuition first</span></h4>
        <p>
          The simplified Drude metal has a <b>cutoff</b> at <span style="font-family:var(--mono);">ω=ωp</span>.
          Just above cutoff, the medium barely supports propagation: the dispersion curve <span style="font-family:var(--mono);">k(ω)</span> starts from zero and grows slowly.
          A slowly growing <span style="font-family:var(--mono);">k</span> means a small slope <span style="font-family:var(--mono);">dk/dω</span>, which makes the group velocity
          <span style="font-family:var(--mono);">v<sub>g</sub>=(dk/dω)^{-1}</span> small. Meanwhile, <span style="font-family:var(--mono);">v<sub>p</sub>=ω/k</span> becomes large because <span style="font-family:var(--mono);">k</span> is tiny.
          So we expect a kind of “see-saw”: <span style="font-family:var(--mono);">v<sub>p</sub></span> increases while <span style="font-family:var(--mono);">v<sub>g</sub></span> decreases near cutoff.
          The problem claims their <b>product</b> stays fixed at <span style="font-family:var(--mono);">c0²</span>.
        </p>
      </article>

      <div class="divider"></div>

      <article class="callout">
        <h4><span class="badge keyeq">Step 1 — Write k(ω) using the dispersion relation</span></h4>
        <p>
          For a plane wave in a homogeneous isotropic medium (lossless here), the wavenumber is
          <span style="font-family:var(--mono);">k(ω)=ω√(μ ε(ω))</span>.
          We assume <span style="font-family:var(--mono);">μ≈μ0</span> and the simplified Drude permittivity
          <span style="font-family:var(--mono);">ε(ω)=ε0(1−ωp²/ω²)</span>.
        </p>

        <div class="eqRow">
          <div class="eq" role="group" aria-label="k(ω) substitution">
<pre>k(ω) = ω √( μ0 ε0 (1 − ωp²/ω²) )</pre>
          </div>
          <button class="copyBtn" data-copy="k(ω) = ω*sqrt( μ0*ε0*(1 - ωp^2/ω^2) )">Copy</button>
        </div>

        <p>
          Now use <span style="font-family:var(--mono);">c0 = 1/√(μ0 ε0)</span> ⇒ <span style="font-family:var(--mono);">√(μ0 ε0)=1/c0</span>.
          Then:
        </p>

        <div class="eqRow">
          <div class="eq" role="group" aria-label="k(ω) simplified">
<pre>k(ω) = (ω/c0) √(1 − ωp²/ω²)</pre>
          </div>
          <button class="copyBtn" data-copy="k(ω) = (ω/c0)*sqrt(1 - ωp^2/ω^2)">Copy</button>
        </div>

        <p>
          A very useful simplification is to combine the terms under one square root:
        </p>

        <div class="eqRow">
          <div class="eq" role="group" aria-label="k(ω) closed form">
<pre>k(ω) = (1/c0) √(ω² − ωp²)   ,  valid for ω > ωp</pre>
          </div>
          <button class="copyBtn" data-copy="k(ω) = (1/c0)*sqrt(ω^2 - ωp^2) , valid for ω>ωp">Copy</button>
        </div>

        <p>
          <b>Why valid for ω&gt;ωp?</b> Because then <span style="font-family:var(--mono);">ω²−ωp² &gt; 0</span>, so <span style="font-family:var(--mono);">k</span> is real and represents a propagating wave.
        </p>
      </article>

      <article class="callout" style="margin-top:12px;">
        <h4><span class="badge keyeq">Step 2 — Compute the phase velocity v<sub>p</sub></span></h4>
        <p>
          By definition,
          <span style="font-family:var(--mono);">v<sub>p</sub> = ω/k</span>.
          Insert the simplified form for <span style="font-family:var(--mono);">k(ω)</span>:
        </p>

        <div class="eqRow">
          <div class="eq" role="group" aria-label="phase velocity derivation">
<pre>v_p(ω) = ω / [ (1/c0) √(ω² − ωp²) ]
       = c0 · ω / √(ω² − ωp²)</pre>
          </div>
          <button class="copyBtn" data-copy="v_p(ω) = c0*ω/sqrt(ω^2 - ωp^2)">Copy</button>
        </div>

        <p>
          <b>Explanation:</b> The phase fronts move at a speed amplified when <span style="font-family:var(--mono);">k</span> is small (near cutoff).
        </p>
      </article>

      <article class="callout" style="margin-top:12px;">
        <h4><span class="badge keyeq">Step 3 — Compute the group velocity v<sub>g</sub></span></h4>
        <p>
          Group velocity is
          <span style="font-family:var(--mono);">v<sub>g</sub> = dω/dk</span>.
          It is often easiest to compute <span style="font-family:var(--mono);">dk/dω</span> and then invert:
          <span style="font-family:var(--mono);">v<sub>g</sub> = (dk/dω)<sup>−1</sup></span>.
        </p>

        <p>
          From <span style="font-family:var(--mono);">k(ω)=(1/c0)√(ω²−ωp²)</span>, differentiate:
        </p>

        <div class="eqRow">
          <div class="eq" role="group" aria-label="dk/dω derivation">
<pre>dk/dω = (1/c0) · (1/2)(ω² − ωp²)^(−1/2) · (2ω)
      = (1/c0) · ω / √(ω² − ωp²)</pre>
          </div>
          <button class="copyBtn" data-copy="dk/dω = (1/c0)*ω/sqrt(ω^2 - ωp^2)">Copy</button>
        </div>

        <p>
          Now invert to get <span style="font-family:var(--mono);">v<sub>g</sub></span>:
        </p>

        <div class="eqRow">
          <div class="eq" role="group" aria-label="group velocity result">
<pre>v_g(ω) = 1 / (dk/dω)
       = c0 · √(ω² − ωp²) / ω</pre>
          </div>
          <button class="copyBtn" data-copy="v_g(ω) = c0*sqrt(ω^2 - ωp^2)/ω">Copy</button>
        </div>

        <p>
          <b>Explanation:</b> The slope of <span style="font-family:var(--mono);">k(ω)</span> controls how quickly a wave packet moves. Near cutoff,
          <span style="font-family:var(--mono);">√(ω²−ωp²)</span> is small, so <span style="font-family:var(--mono);">v<sub>g</sub></span> is small.
        </p>
      </article>

      <article class="callout" style="margin-top:12px;">
        <h4><span class="badge ans">Step 4 — Multiply v<sub>p</sub> and v<sub>g</sub> (the promised identity)</span></h4>

        <div class="eqRow">
          <div class="eq" role="group" aria-label="product identity">
<pre>v_p v_g
= ( c0 · ω/√(ω² − ωp²) ) · ( c0 · √(ω² − ωp²)/ω )
= c0²</pre>
          </div>
          <button class="copyBtn" data-copy="v_p*v_g = (c0*ω/sqrt(ω^2-ωp^2))*(c0*sqrt(ω^2-ωp^2)/ω) = c0^2">Copy</button>
        </div>

        <div class="eqRow">
          <div class="eq" role="group" aria-label="final answer">
<pre>FINAL (for ω > ωp, μ≈μ0, lossless Drude):
v_p(ω) · v_g(ω) = c0²</pre>
          </div>
          <button class="copyBtn" data-copy="FINAL (for ω>ωp, μ≈μ0, lossless Drude): v_p(ω)*v_g(ω) = c0^2">Copy Final</button>
        </div>
      </article>

      <div class="grid2" style="margin-top:12px;">
        <article class="callout">
          <h4><span class="badge">Sanity checks</span></h4>
          <ul>
            <li><b>Units:</b> <span style="font-family:var(--mono);">v_p</span> and <span style="font-family:var(--mono);">v_g</span> are [m/s], so the product is [m²/s²], same as <span style="font-family:var(--mono);">c0²</span>.</li>
            <li><b>High-frequency limit:</b> if <span style="font-family:var(--mono);">ω≫ωp</span>, then <span style="font-family:var(--mono);">√(ω²−ωp²)≈ω</span>, so <span style="font-family:var(--mono);">v_p→c0</span> and <span style="font-family:var(--mono);">v_g→c0</span>.</li>
            <li><b>Near cutoff:</b> as <span style="font-family:var(--mono);">ω→ωp^+</span>, <span style="font-family:var(--mono);">√(ω²−ωp²)→0</span>, hence <span style="font-family:var(--mono);">v_g→0</span> while <span style="font-family:var(--mono);">v_p→∞</span>, but the product remains <span style="font-family:var(--mono);">c0²</span>.</li>
            <li><b>Physical interpretation:</b> phase fronts can “move” faster than <span style="font-family:var(--mono);">c0</span> in dispersive media without violating relativity, because energy/information is tied to the group (or signal) velocity, not the phase velocity.</li>
          </ul>
        </article>

        <article class="callout">
          <h4><span class="badge">Connect to the diagram & plots</span></h4>
          <p>
            The diagram below shows a plane wave entering a Drude metal. The plots visualize:
            (1) how <span style="font-family:var(--mono);">v_p</span> and <span style="font-family:var(--mono);">v_g</span> vary with frequency, and
            (2) how the dispersion curve <span style="font-family:var(--mono);">k(ω)</span> emerges from the square-root law.
            Move the <span style="font-family:var(--mono);">ωp</span> slider: the cutoff shifts, and all graphics update in real time.
          </p>
        </article>
      </div>
    </section>

    <!-- Visualizations -->
    <section class="card fadeIn" aria-label="Interactive visualizations">
      <div class="vizHeader">
        <h2 class="sectionTitle" style="margin:0;">Interactive Visualizations</h2>
        <div class="controls">
          <label>
            Plasma frequency <span style="font-family:var(--mono);">ωp</span> (example)
            <input id="wpSlider" type="range" min="0.5" max="3.0" step="0.01" value="1.50" />
            <span class="readout" id="wpReadout">1.50×10¹⁵ rad/s</span>
          </label>
          <label>
            Frequency marker <span style="font-family:var(--mono);">ω</span> (example)
            <input id="wSlider" type="range" min="0.6" max="5.0" step="0.01" value="2.20" />
            <span class="readout" id="wReadout">2.20×10¹⁵ rad/s</span>
          </label>
        </div>
      </div>

      <div class="grid2">
        <figure>
          <canvas id="diagram" class="canvasShort" aria-label="Diagram canvas"></canvas>
          <figcaption class="caption">
            <b>Diagram:</b> Plane wave in a Drude metal. Propagation requires <span style="font-family:var(--mono);">ω&gt;ωp</span> (otherwise <span style="font-family:var(--mono);">k</span> is imaginary).
          </figcaption>
        </figure>

        <figure>
          <canvas id="mainPlot" class="canvasTall" aria-label="Main plot canvas"></canvas>
          <figcaption class="caption">
            <b>Main plot:</b> <span style="font-family:var(--mono);">v_p(ω)</span> and <span style="font-family:var(--mono);">v_g(ω)</span> (m/s). Their product normalized by <span style="font-family:var(--mono);">c0²</span> stays at 1.
          </figcaption>
        </figure>
      </div>

      <div style="margin-top:14px;">
        <figure>
          <canvas id="secondaryPlot" class="canvasTall" aria-label="Secondary plot canvas"></canvas>
          <figcaption class="caption">
            <b>Secondary plot:</b> Dispersion relation <span style="font-family:var(--mono);">k(ω)=(1/c0)√(ω²−ωp²)</span> (1/m) with the cutoff at <span style="font-family:var(--mono);">ω=ωp</span>.
          </figcaption>
        </figure>
      </div>
    </section>

    <!-- PART 4 -->
    <section id="part4" class="card fadeIn">
      <h2 class="sectionTitle">PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <div class="grid2">
        <article class="callout">
          <h4><span class="badge">Re-interpreting the formula</span></h4>
          <p>
            From the solution we found:
            <span style="font-family:var(--mono);">v_p = c0 · ω/√(ω²−ωp²)</span> and
            <span style="font-family:var(--mono);">v_g = c0 · √(ω²−ωp²)/ω</span>.
          </p>
          <p>
            Notice how the same factor appears in numerator/denominator in opposite ways. That is why the product cancels to <span style="font-family:var(--mono);">c0²</span>.
            In other words, <b>phase speed and group speed are reciprocal “partners”</b> for this particular square-root dispersion.
          </p>
          <ul>
            <li><b>ω controls “how far above cutoff” you are:</b> as <span style="font-family:var(--mono);">ω</span> increases, both velocities approach <span style="font-family:var(--mono);">c0</span>.</li>
            <li><b>ωp sets the cutoff:</b> larger <span style="font-family:var(--mono);">ωp</span> pushes the onset of propagation to higher frequencies and makes the slow-group-velocity region extend further.</li>
          </ul>
        </article>

        <article class="callout">
          <h4><span class="badge">Parameter effects (tie to plots)</span></h4>
          <ul>
            <li>Increasing <span style="font-family:var(--mono);">ωp</span> shifts the cutoff rightward: the <span style="font-family:var(--mono);">k(ω)</span> curve starts later, and near-cutoff <span style="font-family:var(--mono);">v_g</span> becomes small over a wider ω range.</li>
            <li>At a fixed ω (the marker slider), if ω approaches ωp from above, <span style="font-family:var(--mono);">v_g</span> drops and <span style="font-family:var(--mono);">v_p</span> rises, but <span style="font-family:var(--mono);">v_p v_g / c0²</span> remains 1.</li>
            <li>The “square-root” shape in the dispersion plot directly explains why <span style="font-family:var(--mono);">dk/dω</span> is large near cutoff and thus why <span style="font-family:var(--mono);">v_g</span> is small.</li>
          </ul>
        </article>
      </div>

      <article class="callout" style="margin-top:12px;">
        <h4><span class="badge">Alternative derivation idea (brief)</span></h4>
        <p>
          Define the refractive index (for <span style="font-family:var(--mono);">ω&gt;ωp</span>) as
          <span style="font-family:var(--mono);">n(ω)=√(ε(ω)/ε0)=√(1−ωp²/ω²)</span>.
          Then <span style="font-family:var(--mono);">v_p=c0/n</span>.
          A standard identity for group velocity in a dispersive dielectric is
          <span style="font-family:var(--mono);">v_g = c0 / (n + ω dn/dω)</span>.
          For this <span style="font-family:var(--mono);">n(ω)</span>, that formula collapses to <span style="font-family:var(--mono);">v_g=c0 n</span>, giving <span style="font-family:var(--mono);">v_p v_g = c0²</span> immediately.
        </p>
      </article>

      <article class="callout" style="margin-top:12px;">
        <h4><span class="badge">Concept check (with answers)</span></h4>
        <ul>
          <li><b>Q:</b> Why must we restrict to <span style="font-family:var(--mono);">ω&gt;ωp</span> here? <b>A:</b> Because then <span style="font-family:var(--mono);">ε(ω)&gt;0</span> and <span style="font-family:var(--mono);">k</span> is real, representing a propagating plane wave.</li>
          <li><b>Q:</b> Does <span style="font-family:var(--mono);">v_p&gt;c0</span> violate relativity? <b>A:</b> No. Phase velocity is not the signal/energy speed; in low-loss media the relevant transport is tied to group/signal velocity.</li>
          <li><b>Q:</b> What happens as <span style="font-family:var(--mono);">ω→ωp^+</span>? <b>A:</b> <span style="font-family:var(--mono);">v_g→0</span>, <span style="font-family:var(--mono);">v_p→∞</span>, but the product remains <span style="font-family:var(--mono);">c0²</span>.</li>
          <li><b>Q:</b> Would including damping (complex ε) keep the identity exact? <b>A:</b> Generally no; with loss, definitions of phase/group velocity and energy velocity must be handled carefully and the neat cancellation need not hold.</li>
        </ul>
      </article>
    </section>

    <!-- PART 5 -->
    <section id="part5" class="card fadeIn">
      <h2 class="sectionTitle">PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <div class="grid2">
        <article class="callout">
          <h4><span class="badge">What each canvas shows</span></h4>
          <ul>
            <li><b>Diagram canvas:</b> A plane wave incident on a Drude metal region, indicating the cutoff condition <span style="font-family:var(--mono);">ω&gt;ωp</span> for propagation and showing <span style="font-family:var(--mono);">k(ω)</span> as the key medium-dependent quantity.</li>
            <li><b>Main plot:</b> Curves of <span style="font-family:var(--mono);">v_p(ω)</span> and <span style="font-family:var(--mono);">v_g(ω)</span> in m/s, plus a reference line for <span style="font-family:var(--mono);">v_p v_g / c0²</span> (dimensionless) to emphasize the constant product.</li>
            <li><b>Secondary plot:</b> The dispersion relation <span style="font-family:var(--mono);">k(ω)=(1/c0)√(ω²−ωp²)</span>, highlighting how the slope controls group velocity.</li>
          </ul>
        </article>

        <article class="callout">
          <h4><span class="badge">Interactive controls</span></h4>
          <ul>
            <li><b>Plasma frequency slider</b> changes <span style="font-family:var(--mono);">ωp</span> (example value). You should see the cutoff shift and the curves re-shape accordingly.</li>
            <li><b>Frequency marker slider</b> sets a specific <span style="font-family:var(--mono);">ω</span> (example value). A vertical marker updates on both plots, and the readout values for <span style="font-family:var(--mono);">v_p</span>, <span style="font-family:var(--mono);">v_g</span>, and their product are displayed on the main plot.</li>
            <li><b>What should remain invariant:</b> For any chosen <span style="font-family:var(--mono);">ω&gt;ωp</span>, the plotted quantity <span style="font-family:var(--mono);">v_p v_g / c0²</span> stays at 1 (up to numerical plotting tolerance).</li>
          </ul>
          <p>
            All plotted parameters and symbols match the text: <span style="font-family:var(--mono);">ω</span>, <span style="font-family:var(--mono);">ωp</span>, <span style="font-family:var(--mono);">k</span>, <span style="font-family:var(--mono);">v_p</span>, <span style="font-family:var(--mono);">v_g</span>, and <span style="font-family:var(--mono);">c0</span>.
          </p>
        </article>
      </div>
    </section>

    <footer class="wrap">
      <div class="card">
        <p style="margin:0;">
          Built for learning: theory → analysis → roadmap → full derivation → deeper insight → interactive intuition.
          (Example numeric values are used only for visualization; the proved result is fully symbolic.)
        </p>
      </div>
    </footer>
  </main>

  <script>
    // ---------- Copy buttons ----------
    function copyText(btn, text){
      const old = btn.textContent;
      navigator.clipboard.writeText(text).then(()=>{
        btn.classList.add('ok');
        btn.textContent = 'Copied!';
        setTimeout(()=>{ btn.classList.remove('ok'); btn.textContent = old; }, 850);
      }).catch(()=>{
        btn.textContent = 'Copy failed';
        setTimeout(()=>{ btn.textContent = old; }, 850);
      });
    }
    document.querySelectorAll('.copyBtn').forEach(btn=>{
      btn.addEventListener('click', ()=> copyText(btn, btn.getAttribute('data-copy') || ''));
    });

    // Smooth scrolling for ToC links
    document.querySelectorAll('.toc a').forEach(a=>{
      a.addEventListener('click', (e)=>{
        const href = a.getAttribute('href') || '';
        if(href.startsWith('#')){
          e.preventDefault();
          const el = document.querySelector(href);
          if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
        }
      });
    });

    // ---------- Constants & Model ----------
    const c0 = 299792458; // m/s (vacuum speed of light)
    const ONE_E15 = 1e15;

    function kOfOmega(omega, omegaP){
      // k(ω) = (1/c0)*sqrt(ω^2 - ωp^2), for ω>ωp
      const val = omega*omega - omegaP*omegaP;
      if(val <= 0) return NaN; // evanescent
      return Math.sqrt(val)/c0;
    }
    function vpOfOmega(omega, omegaP){
      const k = kOfOmega(omega, omegaP);
      if(!isFinite(k)) return NaN;
      return omega / k;
    }
    function vgOfOmega(omega, omegaP){
      // from derived expression: v_g = c0*sqrt(ω^2 - ωp^2)/ω
      const val = omega*omega - omegaP*omegaP;
      if(val <= 0) return NaN;
      return c0 * Math.sqrt(val) / omega;
    }
    function productNorm(omega, omegaP){
      const vp = vpOfOmega(omega, omegaP);
      const vg = vgOfOmega(omega, omegaP);
      if(!isFinite(vp) || !isFinite(vg)) return NaN;
      return (vp*vg)/(c0*c0);
    }

    // ---------- Canvas utilities ----------
    function setupHiDPI(canvas){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(2, Math.floor(rect.width * dpr));
      const h = Math.max(2, Math.floor(rect.height * dpr));
      if(canvas.width !== w || canvas.height !== h){
        canvas.width = w; canvas.height = h;
      }
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
      return {ctx, dpr, cssW: rect.width, cssH: rect.height};
    }

    function clear(ctx, w, h){
      ctx.clearRect(0,0,w,h);
    }

    function drawRoundedRect(ctx, x,y,w,h,r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    function niceTicks(min, max, n=6){
      const span = max - min;
      if(!(span>0)) return [min];
      const raw = span / (n-1);
      const pow = Math.pow(10, Math.floor(Math.log10(raw)));
      const candidates = [1,2,2.5,5,10].map(m=>m*pow);
      let step = candidates[0];
      for(const c of candidates){
        if(Math.abs(c-raw) < Math.abs(step-raw)) step = c;
      }
      const start = Math.ceil(min/step)*step;
      const ticks = [];
      for(let t=start; t<=max+1e-12; t+=step) ticks.push(t);
      return ticks;
    }

    function plotAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
      const {x,y,w,h} = box;
      // background panel
      ctx.save();
      drawRoundedRect(ctx, x, y, w, h, 14);
      ctx.fillStyle = 'rgba(0,0,0,0.22)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.14)';
      ctx.lineWidth = 1;
      ctx.stroke();

      const padL = 58, padR = 18, padT = 34, padB = 46;
      const px0 = x + padL, px1 = x + w - padR;
      const py0 = y + h - padB, py1 = y + padT;

      // Title
      ctx.fillStyle = 'rgba(255,255,255,0.90)';
      ctx.font = '600 13px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText(title, x + 14, y + 20);

      // grid + ticks
      ctx.strokeStyle = 'rgba(255,255,255,0.10)';
      ctx.lineWidth = 1;

      const xTicks = niceTicks(xMin, xMax, 6);
      const yTicks = niceTicks(yMin, yMax, 6);

      // gridlines + tick labels
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
      ctx.fillStyle = 'rgba(255,255,255,0.70)';

      // x grid
      xTicks.forEach(t=>{
        const u = (t - xMin)/(xMax-xMin);
        const X = px0 + u*(px1-px0);
        ctx.beginPath();
        ctx.moveTo(X, py0);
        ctx.lineTo(X, py1);
        ctx.stroke();
        // ticks
        ctx.strokeStyle = 'rgba(255,255,255,0.24)';
        ctx.beginPath();
        ctx.moveTo(X, py0);
        ctx.lineTo(X, py0+5);
        ctx.stroke();
        ctx.strokeStyle = 'rgba(255,255,255,0.10)';
        const txt = formatTick(t);
        const tw = ctx.measureText(txt).width;
        ctx.fillText(txt, X - tw/2, py0 + 18);
      });

      // y grid
      yTicks.forEach(t=>{
        const v = (t - yMin)/(yMax-yMin);
        const Y = py0 - v*(py0-py1);
        ctx.beginPath();
        ctx.moveTo(px0, Y);
        ctx.lineTo(px1, Y);
        ctx.stroke();
        // ticks
        ctx.strokeStyle = 'rgba(255,255,255,0.24)';
        ctx.beginPath();
        ctx.moveTo(px0-5, Y);
        ctx.lineTo(px0, Y);
        ctx.stroke();
        ctx.strokeStyle = 'rgba(255,255,255,0.10)';
        const txt = formatTick(t);
        const tw = ctx.measureText(txt).width;
        ctx.fillText(txt, px0 - 10 - tw, Y + 4);
      });

      // axes lines
      ctx.strokeStyle = 'rgba(255,255,255,0.38)';
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(px0, py0);
      ctx.lineTo(px1, py0);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(px0, py0);
      ctx.lineTo(px0, py1);
      ctx.stroke();

      // labels
      ctx.fillStyle = 'rgba(255,255,255,0.78)';
      ctx.font = '600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      // x label
      const xTw = ctx.measureText(xLabel).width;
      ctx.fillText(xLabel, px0 + (px1-px0)/2 - xTw/2, y + h - 14);
      // y label (rotated)
      ctx.save();
      ctx.translate(x + 18, py1 + (py0-py1)/2);
      ctx.rotate(-Math.PI/2);
      const yTw = ctx.measureText(yLabel).width;
      ctx.fillText(yLabel, -yTw/2, 0);
      ctx.restore();

      ctx.restore();
      return {px0, px1, py0, py1, padL, padR, padT, padB};
    }

    function formatTick(v){
      const av = Math.abs(v);
      if(av >= 1e9) return (v/1e9).toFixed(2) + 'e9';
      if(av >= 1e6) return (v/1e6).toFixed(2) + 'e6';
      if(av >= 1e3) return (v/1e3).toFixed(2) + 'e3';
      if(av >= 10) return v.toFixed(1);
      if(av >= 1) return v.toFixed(2);
      if(av >= 0.01) return v.toFixed(3);
      return v.toExponential(2);
    }

    function mapX(val, xMin, xMax, px0, px1){
      return px0 + (val-xMin)/(xMax-xMin)*(px1-px0);
    }
    function mapY(val, yMin, yMax, py0, py1){
      return py0 - (val-yMin)/(yMax-yMin)*(py0-py1);
    }

    function drawLine(ctx, xs, ys, xMin, xMax, yMin, yMax, frame, style, lineWidth=2){
      const {px0, px1, py0, py1} = frame;
      ctx.save();
      ctx.strokeStyle = style;
      ctx.lineWidth = lineWidth;
      ctx.beginPath();
      let started = false;
      for(let i=0;i<xs.length;i++){
        const x=xs[i], y=ys[i];
        if(!isFinite(y)) { started=false; continue; }
        const X = mapX(x, xMin, xMax, px0, px1);
        const Y = mapY(y, yMin, yMax, py0, py1);
        if(!started){ ctx.moveTo(X,Y); started=true; }
        else ctx.lineTo(X,Y);
      }
      ctx.stroke();
      ctx.restore();
    }

    function drawDashedVLine(ctx, xVal, xMin, xMax, frame, style){
      const {px0, px1, py0, py1} = frame;
      const X = mapX(xVal, xMin, xMax, px0, px1);
      ctx.save();
      ctx.strokeStyle = style;
      ctx.lineWidth = 1.5;
      ctx.setLineDash([6,6]);
      ctx.beginPath();
      ctx.moveTo(X, py0);
      ctx.lineTo(X, py1);
      ctx.stroke();
      ctx.setLineDash([]);
      ctx.restore();
      return X;
    }

    function legend(ctx, items, x, y){
      ctx.save();
      ctx.font = '12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillStyle = 'rgba(255,255,255,0.84)';
      const pad = 10;
      const lineH = 18;
      const w = 220;
      const h = pad*2 + items.length*lineH;
      drawRoundedRect(ctx, x, y, w, h, 12);
      ctx.fillStyle = 'rgba(0,0,0,0.25)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.14)';
      ctx.stroke();
      items.forEach((it, i)=>{
        const yy = y + pad + i*lineH + 12;
        ctx.strokeStyle = it.color;
        ctx.lineWidth = 3;
        ctx.beginPath();
        ctx.moveTo(x+12, yy-5);
        ctx.lineTo(x+42, yy-5);
        ctx.stroke();
        ctx.fillStyle = 'rgba(255,255,255,0.84)';
        ctx.fillText(it.label, x+52, yy-1);
      });
      ctx.restore();
    }

    // ---------- Drawing: Diagram ----------
    function drawDiagram(canvas, omegaP, omegaMarker){
      const {ctx, cssW:w, cssH:h} = setupHiDPI(canvas);
      clear(ctx, w, h);

      // Panel bg
      ctx.save();
      drawRoundedRect(ctx, 0, 0, w, h, 14);
      ctx.fillStyle = 'rgba(0,0,0,0.22)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.14)';
      ctx.stroke();

      // Title
      ctx.fillStyle = 'rgba(255,255,255,0.90)';
      ctx.font = '600 13px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      ctx.fillText('Diagram: Plane wave in a Drude metal (bulk propagation)', 14, 20);

      // Regions: left "vacuum", right "metal"
      const mid = w*0.52;
      ctx.fillStyle = 'rgba(123,220,255,0.06)';
      ctx.fillRect(10, 34, mid-14, h-44);
      ctx.fillStyle = 'rgba(168,255,189,0.06)';
      ctx.fillRect(mid, 34, w-mid-10, h-44);

      // Boundary
      ctx.strokeStyle = 'rgba(255,255,255,0.25)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(mid, 34);
      ctx.lineTo(mid, h-10);
      ctx.stroke();

      // Labels
      ctx.fillStyle = 'rgba(255,255,255,0.80)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
      ctx.fillText('Vacuum (ε0, μ0)', 18, 54);
      ctx.fillText('Drude metal (ε(ω), μ0)', mid+12, 54);

      // Incoming wave arrow + sinusoid
      const y0 = h*0.58;
      ctx.strokeStyle = 'rgba(123,220,255,0.95)';
      ctx.lineWidth = 2;
      // arrow
      ctx.beginPath();
      ctx.moveTo(40, y0);
      ctx.lineTo(mid-24, y0);
      ctx.stroke();
      ctx.beginPath();
      ctx.moveTo(mid-24, y0);
      ctx.lineTo(mid-38, y0-7);
      ctx.lineTo(mid-38, y0+7);
      ctx.closePath();
      ctx.fillStyle = 'rgba(123,220,255,0.95)';
      ctx.fill();

      // sine in vacuum
      ctx.strokeStyle = 'rgba(123,220,255,0.65)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      const amp = 14;
      for(let x=40; x<mid-40; x+=2){
        const t = (x-40)/(mid-80)*Math.PI*6;
        const yy = y0 + Math.sin(t)*amp;
        if(x===40) ctx.moveTo(x,yy); else ctx.lineTo(x,yy);
      }
      ctx.stroke();

      // transmitted wave in metal (amplitude changes + wavelength changes)
      const propagates = omegaMarker > omegaP;
      const kScale = propagates ? Math.sqrt(omegaMarker*omegaMarker - omegaP*omegaP)/omegaMarker : 0.0; // proportional to n
      const lambdaFactor = propagates ? Math.max(0.35, Math.min(1.0, kScale)) : 0.2;
      const amp2 = propagates ? 10 : 5;

      ctx.strokeStyle = propagates ? 'rgba(168,255,189,0.75)' : 'rgba(255,123,154,0.75)';
      ctx.lineWidth = 2;
      ctx.beginPath();
      const startX = mid + 18;
      const endX = w - 18;
      const cycles = propagates ? 6 * lambdaFactor : 2;
      for(let x=startX; x<endX; x+=2){
        const t = (x-startX)/(endX-startX)*Math.PI*2*cycles;
        const yy = y0 + Math.sin(t)*amp2;
        if(x===startX) ctx.moveTo(x,yy); else ctx.lineTo(x,yy);
      }
      ctx.stroke();

      // Annotation: cutoff condition
      ctx.fillStyle = 'rgba(255,255,255,0.84)';
      ctx.font = '600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
      const cond = propagates ? 'Propagation: ω > ωp (k real)' : 'Evanescent: ω ≤ ωp (k imaginary)';
      ctx.fillText(cond, mid+12, 76);

      // Key equation box
      const boxX = 14, boxY = h-78, boxW = w-28, boxH = 58;
      drawRoundedRect(ctx, boxX, boxY, boxW, boxH, 12);
      ctx.fillStyle = 'rgba(0,0,0,0.25)';
      ctx.fill();
      ctx.strokeStyle = 'rgba(255,255,255,0.14)';
      ctx.stroke();
      ctx.fillStyle = 'rgba(255,255,255,0.88)';
      ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
      ctx.fillText('ε(ω)=ε0(1−ωp²/ω²),   k(ω)=(1/c0)√(ω²−ωp²)   (ω>ωp)', boxX+12, boxY+22);
      ctx.fillText('v_p=ω/k,   v_g=dω/dk=(dk/dω)^{-1}  ⇒  v_p v_g = c0²', boxX+12, boxY+44);

      ctx.restore();
    }

    // ---------- Drawing: Main Plot (vp, vg, product) ----------
    function drawMainPlot(canvas, omegaP, omegaMarker){
      const {ctx, cssW:w, cssH:h} = setupHiDPI(canvas);
      clear(ctx, w, h);

      // ω axis (example): 0.5e15 to 5e15 rad/s
      const xMin = 0.5*ONE_E15, xMax = 5.0*ONE_E15;

      // Determine y ranges dynamically based on current omegaP
      // vp can get very large near cutoff; cap for readability.
      // We'll compute samples and set yMax to a robust percentile-ish cap.
      const N = 600;
      const xs = new Array(N);
      const vp = new Array(N);
      const vg = new Array(N);
      const pn = new Array(N);
      let vpMax = 0, vgMax = 0;
      for(let i=0;i<N;i++){
        const x = xMin + (xMax-xMin)*i/(N-1);
        xs[i]=x;
        vp[i]=vpOfOmega(x, omegaP);
        vg[i]=vgOfOmega(x, omegaP);
        pn[i]=productNorm(x, omegaP);
        if(isFinite(vp[i])) vpMax = Math.max(vpMax, vp[i]);
        if(isFinite(vg[i])) vgMax = Math.max(vgMax, vg[i]);
      }
      // cap vpMax to something like 4c0 to avoid exploding plot; still show the trend
      const yMax = Math.max(1.2*c0, Math.min(vpMax, 4.2*c0));
      const yMin = 0;

      const frame = plotAxes(
        ctx,
        {x:0,y:0,w:w,h:h},
        xMin, xMax,
        yMin, yMax,
        'ω (rad/s)  [example axis]',
        'Velocity (m/s)',
        'Main Plot: Phase velocity v_p(ω) and Group velocity v_g(ω)'
      );

      // draw curves
      drawLine(ctx, xs, vp.map(v=> (isFinite(v) ? Math.min(v, yMax*1.02) : NaN)), xMin,xMax,yMin,yMax,frame,'rgba(123,220,255,0.95)',2.6);
      drawLine(ctx, xs, vg, xMin,xMax,yMin,yMax,frame,'rgba(168,255,189,0.95)',2.6);

      // Also show product normalized (dimensionless) as a thin line mapped onto velocity axis:
      // We'll map pn in [0,1.1] to a thin band near bottom: y = 0.12*yMax*pn
      const pnScaled = pn.map(v=> isFinite(v) ? 0.12*yMax*Math.max(0, Math.min(1.1, v)) : NaN);
      drawLine(ctx, xs, pnScaled, xMin,xMax,yMin,yMax,frame,'rgba(255,210,123,0.95)',2.0);

      // cutoff line at ωp
      const cutX = omegaP;
      if(cutX > xMin && cutX < xMax){
        drawDashedVLine(ctx, cutX, xMin, xMax, frame, 'rgba(255,255,255,0.35)');
        // label cutoff
        ctx.save();
        ctx.fillStyle = 'rgba(255,255,255,0.78)';
        ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
        const X = mapX(cutX, xMin, xMax, frame.px0, frame.px1);
        ctx.fillText('ω=ωp', Math.min(frame.px1-44, X+6), frame.py1+14);
        ctx.restore();
      }

      // marker line at ω
      if(omegaMarker > xMin && omegaMarker < xMax){
        const X = drawDashedVLine(ctx, omegaMarker, xMin, xMax, frame, 'rgba(255,123,154,0.65)');
        // readouts
        const vpM = vpOfOmega(omegaMarker, omegaP);
        const vgM = vgOfOmega(omegaMarker, omegaP);
        const pnM = productNorm(omegaMarker, omegaP);

        ctx.save();
        const boxW = 340, boxH = 84;
        const bx = Math.min(frame.px1 - boxW, Math.max(frame.px0+8, X - boxW*0.2));
        const by = frame.py1 + 10;
        drawRoundedRect(ctx, bx, by, boxW, boxH, 12);
        ctx.fillStyle = 'rgba(0,0,0,0.30)';
        ctx.fill();
        ctx.strokeStyle = 'rgba(255,255,255,0.14)';
        ctx.stroke();

        ctx.fillStyle = 'rgba(255,255,255,0.88)';
        ctx.font = '600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial';
        ctx.fillText('Marker values at ω (example):', bx+12, by+20);
        ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';

        const vpTxt = isFinite(vpM) ? (vpM/c0).toFixed(3)+' c0' : '— (no propagation)';
        const vgTxt = isFinite(vgM) ? (vgM/c0).toFixed(3)+' c0' : '— (no propagation)';
        const pnTxt = isFinite(pnM) ? pnM.toFixed(6) : '—';

        ctx.fillText('v_p = ' + vpTxt, bx+12, by+42);
        ctx.fillText('v_g = ' + vgTxt, bx+12, by+60);
        ctx.fillText('v_p v_g / c0^2 = ' + pnTxt, bx+12, by+78);
        ctx.restore();
      }

      // legend
      legend(ctx, [
        {label:'v_p(ω)', color:'rgba(123,220,255,0.95)'},
        {label:'v_g(ω)', color:'rgba(168,255,189,0.95)'},
        {label:'(v_p v_g / c0²) scaled', color:'rgba(255,210,123,0.95)'}
      ], 14, 34);
    }

    // ---------- Drawing: Secondary Plot (k vs ω) ----------
    function drawSecondaryPlot(canvas, omegaP, omegaMarker){
      const {ctx, cssW:w, cssH:h} = setupHiDPI(canvas);
      clear(ctx, w, h);

      const xMin = 0.5*ONE_E15, xMax = 5.0*ONE_E15;

      // compute k range
      const N = 600;
      const xs = new Array(N);
      const ks = new Array(N);
      let kMax = 0;
      for(let i=0;i<N;i++){
        const x = xMin + (xMax-xMin)*i/(N-1);
        xs[i]=x;
        ks[i]=kOfOmega(x, omegaP);
        if(isFinite(ks[i])) kMax = Math.max(kMax, ks[i]);
      }
      const yMin = 0;
      const yMax = kMax > 0 ? kMax*1.10 : 1;

      const frame = plotAxes(
        ctx,
        {x:0,y:0,w:w,h:h},
        xMin, xMax,
        yMin, yMax,
        'ω (rad/s)  [example axis]',
        'k (1/m)',
        'Secondary Plot: Dispersion relation k(ω) = (1/c0)√(ω²−ωp²)'
      );

      // k curve
      drawLine(ctx, xs, ks, xMin,xMax,yMin,yMax,frame,'rgba(123,220,255,0.90)',2.7);

      // cutoff line
      const cutX = omegaP;
      if(cutX > xMin && cutX < xMax){
        drawDashedVLine(ctx, cutX, xMin, xMax, frame, 'rgba(255,255,255,0.35)');
        // shade evanescent region ω<ωp
        ctx.save();
        const X = mapX(cutX, xMin, xMax, frame.px0, frame.px1);
        ctx.fillStyle = 'rgba(255,123,154,0.10)';
        ctx.fillRect(frame.px0, frame.py1, X-frame.px0, frame.py0-frame.py1);
        ctx.fillStyle = 'rgba(255,255,255,0.78)';
        ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
        ctx.fillText('evanescent (ω≤ωp)', frame.px0+10, frame.py1+16);
        ctx.restore();
      }

      // marker
      if(omegaMarker > xMin && omegaMarker < xMax){
        drawDashedVLine(ctx, omegaMarker, xMin, xMax, frame, 'rgba(168,255,189,0.60)');
        const kM = kOfOmega(omegaMarker, omegaP);
        if(isFinite(kM)){
          const X = mapX(omegaMarker, xMin, xMax, frame.px0, frame.px1);
          const Y = mapY(kM, yMin, yMax, frame.py0, frame.py1);
          ctx.save();
          ctx.fillStyle = 'rgba(168,255,189,0.95)';
          ctx.beginPath();
          ctx.arc(X, Y, 4.5, 0, Math.PI*2);
          ctx.fill();

          // label
          ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace';
          ctx.fillStyle = 'rgba(255,255,255,0.86)';
          ctx.fillText('k(ω)', Math.min(frame.px1-40, X+8), Math.max(frame.py1+18, Y-8));
          ctx.restore();
        }
      }

      // legend
      legend(ctx, [
        {label:'k(ω)', color:'rgba(123,220,255,0.90)'},
        {label:'ω marker', color:'rgba(168,255,189,0.60)'},
        {label:'cutoff ωp', color:'rgba(255,255,255,0.35)'}
      ], 14, 34);
    }

    // ---------- UI wiring ----------
    const wpSlider = document.getElementById('wpSlider');
    const wSlider  = document.getElementById('wSlider');
    const wpReadout = document.getElementById('wpReadout');
    const wReadout  = document.getElementById('wReadout');

    const diagramCanvas = document.getElementById('diagram');
    const mainCanvas = document.getElementById('mainPlot');
    const secondaryCanvas = document.getElementById('secondaryPlot');

    function updateReadouts(){
      const wp = parseFloat(wpSlider.value)*ONE_E15;
      const w  = parseFloat(wSlider.value)*ONE_E15;

      wpReadout.textContent = (wp/ONE_E15).toFixed(2) + '×10¹⁵ rad/s';
      wReadout.textContent  = (w/ONE_E15).toFixed(2) + '×10¹⁵ rad/s';

      // keep ω marker >= 0.6e15 but also allow it to dip below wp to demonstrate evanescent
      // however, avoid a confusing case where ω slider min > ωp; we allow both freely.
      return {wp, w};
    }

    function redrawAll(){
      const {wp, w} = updateReadouts();
      drawDiagram(diagramCanvas, wp, w);
      drawMainPlot(mainCanvas, wp, w);
      drawSecondaryPlot(secondaryCanvas, wp, w);
    }

    wpSlider.addEventListener('input', redrawAll);
    wSlider.addEventListener('input', redrawAll);

    // responsive redraw on resize (debounced)
    let rTimer = null;
    window.addEventListener('resize', ()=>{
      clearTimeout(rTimer);
      rTimer = setTimeout(redrawAll, 120);
    });

    // initial draw
    redrawAll();
  </script>
</body>
</html>
