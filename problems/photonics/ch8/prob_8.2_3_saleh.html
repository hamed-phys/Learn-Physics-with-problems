<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Silver Nanosphere in Glass — Scattering, Absorption, and Internal Field (350–1000 nm)</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1730;
      --card:#101c3a;
      --text:#e9eefc;
      --muted:#b7c3e6;
      --faint:#7f8bb3;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#86efac;
      --warn:#fbbf24;
      --bad:#fb7185;
      --line:rgba(255,255,255,.10);
      --shadow: 0 14px 40px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 15% 10%, rgba(125,211,252,.10), transparent 55%),
                  radial-gradient(900px 700px at 85% 15%, rgba(167,139,250,.10), transparent 60%),
                  radial-gradient(1000px 800px at 40% 90%, rgba(134,239,172,.08), transparent 60%),
                  var(--bg);
      color:var(--text);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding:28px 18px 12px;
      border-bottom:1px solid var(--line);
      position:relative;
      overflow:hidden;
    }
    header .wrap{
      max-width:1180px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.25fr .75fr;
      gap:18px;
      align-items:start;
    }
    .title{
      display:flex; flex-direction:column; gap:8px;
    }
    h1{
      font-size: clamp(1.4rem, 2.2vw, 2.1rem);
      margin:0;
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      max-width:70ch;
      margin:0;
    }
    .badgeRow{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:6px;
    }
    .badge{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      padding:6px 10px;
      border-radius:999px;
      font-size:.86rem;
      color:var(--muted);
      backdrop-filter: blur(6px);
    }

    main{
      max-width:1180px;
      margin:0 auto;
      padding:18px;
      display:grid;
      grid-template-columns: 300px 1fr;
      gap:18px;
      align-items:start;
    }

    nav#toc{
      position:sticky;
      top:14px;
      align-self:start;
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: var(--radius);
      padding:14px 14px 12px;
      box-shadow: var(--shadow);
    }
    nav#toc h2{
      font-size:1rem;
      margin:0 0 10px 0;
      color:var(--text);
      letter-spacing:.2px;
    }
    .tocLinks{
      display:flex; flex-direction:column; gap:8px;
      font-size:.93rem;
    }
    .tocLinks a{
      color:var(--muted);
      padding:8px 10px;
      border-radius:12px;
      border:1px solid transparent;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
    }
    .tocLinks a:hover{
      background: rgba(125,211,252,.08);
      border-color: rgba(125,211,252,.25);
      transform: translateY(-1px);
      text-decoration:none;
      color:var(--text);
    }
    .tocHint{
      margin-top:10px;
      color:var(--faint);
      font-size:.85rem;
    }

    .content{
      display:flex;
      flex-direction:column;
      gap:16px;
      min-width:0;
    }

    section, article{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
    }
    section h2{
      margin:0 0 10px 0;
      font-size:1.18rem;
      letter-spacing:.2px;
    }
    section h3{
      margin:14px 0 8px 0;
      font-size:1.04rem;
      color:var(--text);
    }
    p{margin:10px 0}
    ul{margin:8px 0 10px 20px}
    li{margin:6px 0}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
    }
    .callout{
      border:1px solid var(--line);
      background: rgba(0,0,0,.20);
      border-radius: 16px;
      padding:12px;
    }
    .callout strong{color:var(--text)}
    .callout.assumptions{border-color: rgba(167,139,250,.35)}
    .callout.keyeq{border-color: rgba(125,211,252,.35)}
    .callout.mistakes{border-color: rgba(251,191,36,.35)}
    .callout.final{border-color: rgba(134,239,172,.35)}
    .kicker{
      color:var(--muted);
      font-size:.95rem;
    }

    .eqBlock{
      position:relative;
      border:1px dashed rgba(125,211,252,.35);
      background: rgba(125,211,252,.06);
      border-radius: 16px;
      padding:12px 12px 10px;
      overflow:hidden;
    }
    pre.eq{
      margin:0;
      font-family:var(--mono);
      font-size:.95rem;
      line-height:1.45;
      white-space:pre-wrap;
      word-break:break-word;
      color:var(--text);
    }
    .copyBtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid rgba(255,255,255,.16);
      background: rgba(0,0,0,.22);
      color: var(--text);
      border-radius: 12px;
      padding:7px 10px;
      font-size:.85rem;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
    }
    .copyBtn:hover{transform: translateY(-1px); background: rgba(255,255,255,.07); border-color: rgba(125,211,252,.35)}
    .copyBtn:active{transform: translateY(0px) scale(.98)}
    .mini{
      font-size:.88rem;
      color:var(--muted);
    }

    .vizWrap{
      display:grid;
      grid-template-columns: 1.05fr .95fr;
      gap:14px;
      align-items:start;
    }
    .canvasCard{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius: 16px;
      padding:12px;
      overflow:hidden;
    }
    .canvasCard h3{
      margin:0 0 8px 0;
      font-size:1rem;
      color:var(--text);
    }
    canvas{
      width:100%;
      height:320px;
      display:block;
      border-radius: 12px;
      background: radial-gradient(600px 380px at 30% 25%, rgba(125,211,252,.05), transparent 55%),
                  radial-gradient(550px 380px at 80% 10%, rgba(167,139,250,.05), transparent 60%),
                  rgba(8,12,26,.75);
      border:1px solid rgba(255,255,255,.08);
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr;
      gap:10px;
    }
    .ctrl{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      padding:12px;
    }
    .ctrl label{
      display:flex;
      align-items:baseline;
      justify-content:space-between;
      gap:10px;
      font-size:.95rem;
      color:var(--muted);
      margin-bottom:10px;
    }
    input[type="range"]{width:100%}
    .pillRow{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
    }
    .pill{
      border:1px solid rgba(255,255,255,.14);
      background: rgba(0,0,0,.18);
      border-radius: 999px;
      padding:6px 10px;
      font-size:.85rem;
      color:var(--muted);
    }

    .resultsGrid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
      align-items:start;
    }
    table{
      width:100%;
      border-collapse:collapse;
      overflow:hidden;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
    }
    th, td{
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.08);
      text-align:left;
      font-size:.93rem;
    }
    th{color:var(--text); background: rgba(255,255,255,.04)}
    td{color:var(--muted)}
    tr:last-child td{border-bottom:none}
    .smallNote{color:var(--faint); font-size:.88rem}

    footer{
      max-width:1180px;
      margin:0 auto;
      padding:14px 18px 30px;
      color:var(--faint);
      font-size:.9rem;
    }

    @media (max-width: 980px){
      header .wrap{grid-template-columns:1fr}
      main{grid-template-columns:1fr}
      nav#toc{position:relative; top:auto}
      .vizWrap{grid-template-columns:1fr}
      canvas{height:300px}
      .grid2, .grid3, .resultsGrid{grid-template-columns:1fr}
    }

    @media print{
      body{background:#fff; color:#000}
      header, nav#toc, .copyBtn, .controls{display:none !important}
      section, article{box-shadow:none; background:#fff; border:1px solid #ddd}
      canvas{border:1px solid #ccc; background:#fff}
      a{color:#000; text-decoration:underline}
      .eqBlock{background:#fff}
      pre.eq{color:#000}
      th{background:#f4f4f4}
      td{color:#111}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap">
      <div class="title">
        <h1>Silver Nanosphere in Glass: Scattering &amp; Absorption Efficiencies and Internal Field (350–1000 nm)</h1>
        <p class="subtitle">
          We model a <strong>10-nm radius</strong> Ag nanoparticle embedded in glass (<strong>n = 1.45</strong>) using a
          <strong>modified Drude + Lorentz</strong> permittivity, then compute <em>scattering</em>, <em>absorption</em>, and the
          <em>normalized internal field</em> versus wavelength. The article teaches the theory first and then applies it step-by-step.
        </p>
        <div class="badgeRow">
          <span class="badge">Rayleigh / Quasi-static limit</span>
          <span class="badge">Complex permittivity ε(ω)</span>
          <span class="badge">Plasmon resonance (Fröhlich condition)</span>
          <span class="badge">Interactive plots + parameter sweep</span>
        </div>
      </div>
      <div class="callout assumptions">
        <strong>Modeling choice (important):</strong>
        <p class="mini" style="margin:8px 0 0 0;">
          Because <code>a = 10 nm</code> and <code>λ = 350–1000 nm</code>, we have <code>ka ≪ 1</code> in the host medium, so the
          <strong>dipole (Rayleigh) approximation</strong> is accurate and is the simplest way to get <code>Q_s</code>, <code>Q_a</code>,
          and <code>E_i/E_0</code> analytically.
        </p>
      </div>
    </div>
  </header>

  <main>
    <nav id="toc" aria-label="Table of contents">
      <h2>Mini Table of Contents</h2>
      <div class="tocLinks">
        <a href="#quick">Quick Summary</a>
        <a href="#part0">PART 0 — Concept Primer</a>
        <a href="#part1">PART 1 — Problem Analysis</a>
        <a href="#part2">PART 2 — Strategy &amp; Tips</a>
        <a href="#part3">PART 3 — Full Solution</a>
        <a href="#part4">PART 4 — Deeper Understanding</a>
        <a href="#part5">PART 5 — Visualization Guide</a>
      </div>
      <div class="tocHint">Tip: use the radius slider to see how the resonance and the balance between scattering vs absorption changes.</div>
    </nav>

    <div class="content">
      <section id="quick">
        <h2>Quick Summary</h2>
        <ul>
          <li><strong>What this is about:</strong> Optical response of a <em>silver nanosphere</em> in a dielectric host: scattering, absorption, and internal field vs wavelength.</li>
          <li><strong>Key physics idea:</strong> In the <em>Rayleigh limit</em> (<code>ka ≪ 1</code>), the particle behaves like an induced <em>electric dipole</em> with polarizability <code>α(ω)</code>.</li>
          <li><strong>Material model:</strong> Ag relative permittivity <code>ε_r(ω)</code> given by a fitted <em>modified Drude + Lorentz</em> function (includes interband absorption).</li>
          <li><strong>Governing relations:</strong> <code>α(ω)</code> → cross-sections <code>C_sca</code>, <code>C_ext</code>, <code>C_abs</code> → efficiencies <code>Q_s, Q_a</code>.</li>
          <li><strong>Resonance condition:</strong> Plasmon peak occurs near <code>Re{ε_r} ≈ -2 ε_m</code> (Fröhlich condition), shifted/broadened by losses <code>Im{ε_r}</code>.</li>
          <li><strong>Final outputs:</strong> Numeric plots over 350–1000 nm, resonance wavelength, and scattering/absorption cross-sections (reported as “coefficients” <code>a_s</code>, <code>a_a</code>) at resonance.</li>
        </ul>
      </section>

      <section id="part0">
        <h2>PART 0 — Concept Primer (THEORY BEFORE SOLVING)</h2>

        <h3>0.1 Core definitions (symbols &amp; units)</h3>
        <div class="grid2">
          <div class="callout">
            <strong>Geometry &amp; waves</strong>
            <ul class="mini">
              <li><code>a</code> — sphere radius (m)</li>
              <li><code>λ0</code> — free-space wavelength (m)</li>
              <li><code>n</code> — host refractive index (dimensionless)</li>
              <li><code>k = 2π n / λ0</code> — host wavenumber (m⁻¹)</li>
            </ul>
          </div>
          <div class="callout">
            <strong>Material response</strong>
            <ul class="mini">
              <li><code>ε_r(ω) = ε(ω)/ε0</code> — particle relative permittivity (complex)</li>
              <li><code>ε_m = n²</code> — host relative permittivity (real, here)</li>
              <li><code>ω = 2π c / λ0</code> — angular frequency (rad/s)</li>
            </ul>
          </div>
        </div>

        <h3>0.2 Physical meaning of key quantities</h3>
        <ul>
          <li><strong>Polarizability</strong> <code>α(ω)</code> tells how strongly the nanoparticle’s charges separate in response to an electric field; larger |α| means stronger dipole radiation and stronger near fields.</li>
          <li><strong>Scattering cross-section</strong> <code>C_sca</code> is the effective area that reradiates energy into new directions (elastic process).</li>
          <li><strong>Absorption cross-section</strong> <code>C_abs</code> is the effective area that converts optical energy into heat inside the metal (lossy process).</li>
          <li><strong>Efficiencies</strong> <code>Q_s = C_sca/(πa²)</code>, <code>Q_a = C_abs/(πa²)</code> compare those areas to the particle’s geometric area.</li>
          <li><strong>Internal field</strong> <code>E_i</code> is the (nearly uniform) electric field inside a small sphere; its enhancement reflects resonance and is central to sensing, heating, and nonlinear optics.</li>
        </ul>

        <h3>0.3 Key laws/principles &amp; validity</h3>
        <div class="callout keyeq">
          <strong>Dipole (Rayleigh) approximation validity:</strong>
          <ul class="mini">
            <li>Requires <code>ka ≪ 1</code> and particle much smaller than wavelength in host.</li>
            <li>Field across the particle is nearly uniform → electrostatic boundary-value solution applies.</li>
            <li>Higher multipoles (quadrupole, etc.) are negligible for a ≈ 10 nm in visible/NIR.</li>
          </ul>
        </div>

        <h3>0.4 Common models/approximations and why we use them</h3>
        <ul>
          <li><strong>Electrostatic sphere solution</strong> gives closed-form <code>α(ω)</code> and <code>E_i/E_0</code>.</li>
          <li><strong>Modified Drude + Lorentz permittivity</strong> accounts for free-electron response (Drude) and interband transitions (Lorentz), which is essential for Ag in the visible.</li>
          <li><strong>Host medium effect</strong>: replacing vacuum by glass shifts resonance because the boundary condition depends on <code>ε_m = n²</code>.</li>
        </ul>

        <h3>0.5 Mini intuition examples (conceptual)</h3>
        <ul>
          <li><strong>Example 1:</strong> If the metal were lossless and had <code>ε_r = -2 ε_m</code>, the denominator <code>(ε_r + 2ε_m)</code> becomes tiny → huge dipole and large scattering.</li>
          <li><strong>Example 2:</strong> If losses increase (larger <code>Im{ε_r}</code>), the resonance peak broadens and internal-field enhancement drops—energy is damped into heat.</li>
        </ul>

        <h3>0.6 What to watch for (pitfalls)</h3>
        <div class="callout mistakes">
          <ul class="mini" style="margin:0 0 0 18px;">
            <li>Mixing <strong>free-space wavelength</strong> <code>λ0</code> with <strong>host wavelength</strong> <code>λ = λ0/n</code> inside <code>k</code>. Here: <code>k = 2πn/λ0</code>.</li>
            <li>Forgetting that <code>ε_r(ω)</code> is <strong>complex</strong>. Resonance is not exactly at <code>Re{ε_r} = -2ε_m</code> when losses are present.</li>
            <li>Using scattering-only formulas for absorption: must compute <code>C_ext</code> and subtract <code>C_sca</code>.</li>
            <li>Applying dipole formulas when <code>a</code> is too large (not the case here, but the slider can explore it).</li>
          </ul>
        </div>
      </section>

      <section id="part1">
        <h2>PART 1 — Problem Analysis (no solving yet)</h2>

        <h3>1.1 Restate the problem (in plain words)</h3>
        <p>
          A silver nanosphere of radius <code>a = 10 nm</code> is embedded in glass with refractive index <code>n = 1.45</code>.
          Using a specified fitted complex permittivity model for bulk Ag, compute and plot versus free-space wavelength <code>λ0</code> (350–1000 nm):
          <strong>scattering efficiency</strong> <code>Q_s</code>, <strong>absorption efficiency</strong> <code>Q_a</code>, and the <strong>normalized internal field</strong> <code>|E_i/E_0|</code>.
          Identify the resonance wavelength and report the scattering and absorption “coefficients” (interpreted as cross-sections) <code>a_s</code>, <code>a_a</code> at resonance.
        </p>

        <h3>1.2 Given quantities</h3>
        <ul>
          <li><code>a = 10 nm</code></li>
          <li><code>n = 1.45</code> → <code>ε_m = n²</code></li>
          <li>Wavelength range: <code>λ0 ∈ [350, 1000] nm</code></li>
          <li>Plasma wavelength: <code>λ_p = 135.2 nm</code> (defines <code>ω_p</code>)</li>
          <li>Permittivity model parameters: <code>ζ = 0.00229 ω_p</code>, <code>ω_L = 0.575 ω_p</code>, <code>ζ_L = 0.124 ω_p</code>, plus the coefficient <code>2.2</code> in the Lorentz term.</li>
        </ul>

        <h3>1.3 Unknowns / outputs</h3>
        <ul>
          <li><code>Q_s(λ0)</code> scattering efficiency</li>
          <li><code>Q_a(λ0)</code> absorption efficiency</li>
          <li><code>|E_i/E_0|(λ0)</code> internal field magnitude ratio</li>
          <li>Resonance wavelength <code>λ_res</code> (peak response)</li>
          <li>At resonance: <code>a_s</code>, <code>a_a</code> (taken here as <code>C_sca</code> and <code>C_abs</code>)</li>
        </ul>

        <h3>1.4 Relevant principles and why they apply</h3>
        <ul>
          <li><strong>Electrostatic boundary conditions for a sphere</strong> apply because the field varies little across a 10 nm particle at optical wavelengths.</li>
          <li><strong>Dipole radiation</strong> gives scattering; energy conservation gives absorption via <code>C_abs = C_ext − C_sca</code>.</li>
          <li>Full Mie theory is valid in general, but here it is overkill; the dipole model captures the dominant physics and makes resonance interpretation transparent.</li>
        </ul>

        <div class="callout assumptions">
          <strong>Assumptions used:</strong>
          <ul class="mini">
            <li>Sphere is homogeneous, isotropic, linear, and much smaller than wavelength (<code>ka ≪ 1</code>).</li>
            <li>Host glass has real, constant index <code>n = 1.45</code> across 350–1000 nm (a common approximation for teaching/first-pass design).</li>
            <li>Bulk Ag permittivity is used (no size-dependent damping correction); acceptable as a baseline.</li>
            <li>Nonmagnetic materials: <code>μ_r ≈ 1</code>.</li>
          </ul>
        </div>

        <h3>1.5 Possible approaches (compare)</h3>
        <div class="grid3">
          <div class="callout">
            <strong>Approach A: Rayleigh / dipole (chosen)</strong>
            <ul class="mini">
              <li>Pros: simple, fast, interpretable, ideal for resonance identification.</li>
              <li>Cons: misses higher multipoles for larger particles.</li>
            </ul>
          </div>
          <div class="callout">
            <strong>Approach B: Full Mie theory</strong>
            <ul class="mini">
              <li>Pros: exact for a sphere at any size.</li>
              <li>Cons: heavier math; less “teaching-friendly” here.</li>
            </ul>
          </div>
          <div class="callout">
            <strong>Approach C: Numerical EM (FDTD/FEM)</strong>
            <ul class="mini">
              <li>Pros: handles arbitrary geometry/material dispersion.</li>
              <li>Cons: not needed; slower; requires external tools.</li>
            </ul>
          </div>
        </div>
        <p>
          <strong>Chosen method:</strong> Approach A (dipole/Rayleigh). It matches the particle size and lets us compute <code>Q_s</code>, <code>Q_a</code>, and <code>E_i/E_0</code> directly from <code>ε(ω)</code>.
        </p>
      </section>

      <section id="part2">
        <h2>PART 2 — Strategy &amp; Tips (roadmap only)</h2>

        <ol>
          <li>
            <strong>Convert wavelength to angular frequency</strong><br/>
            Use <code>ω = 2πc/λ0</code>. Physically: you’re mapping the spectrum into frequency for the material model.
          </li>
          <li>
            <strong>Compute Ag complex permittivity</strong> <code>ε_r(ω)</code><br/>
            Use the modified Drude + Lorentz formula. Physically: separates free-electron and interband contributions.
          </li>
          <li>
            <strong>Compute host permittivity</strong><br/>
            <code>ε_m = n²</code>. Physically: host shifts resonance by changing boundary conditions.
          </li>
          <li>
            <strong>Compute dipole polarizability</strong> <code>α(ω)</code><br/>
            Use the electrostatic sphere formula. Physically: captures how strongly the sphere becomes a dipole.
          </li>
          <li>
            <strong>Compute cross-sections</strong> <code>C_sca</code>, <code>C_ext</code>, <code>C_abs</code><br/>
            Use dipole radiation and optical theorem forms; set <code>C_abs = C_ext − C_sca</code>.
          </li>
          <li>
            <strong>Convert to efficiencies</strong><br/>
            <code>Q = C/(πa²)</code>. Physically: compares interaction area to geometric size.
          </li>
          <li>
            <strong>Compute internal field ratio</strong><br/>
            <code>E_i/E_0 = 3ε_m/(ε_r + 2ε_m)</code> (complex). Plot <code>|E_i/E_0|</code>.
          </li>
          <li>
            <strong>Locate resonance</strong><br/>
            Find the wavelength where <code>|E_i/E_0|</code> (or <code>Q_ext</code>) is maximal.
          </li>
          <li>
            <strong>Report values at resonance</strong><br/>
            Read off <code>λ_res</code>, <code>Q_s</code>, <code>Q_a</code>, and compute <code>a_s = C_sca</code>, <code>a_a = C_abs</code>.
          </li>
        </ol>

        <div class="callout mistakes">
          <strong>Quick tips &amp; common mistakes:</strong>
          <ul class="mini">
            <li>Use <code>k = 2πn/λ0</code> (host wavenumber), not <code>2π/λ0</code>.</li>
            <li>Compute <code>C_ext</code> from <code>Im(α)</code> and then subtract scattering; don’t invent absorption separately.</li>
            <li>If your computed <code>C_abs</code> becomes slightly negative from numerical roundoff near weak response, clamp to 0.</li>
          </ul>
        </div>
      </section>

      <section id="part3">
        <h2>PART 3 — Full Solution (DETAILED + TEACHING)</h2>

        <h3>3.1 Qualitative expectation (before math)</h3>
        <p>
          A small Ag sphere supports a <strong>localized surface plasmon resonance</strong> (LSPR): collective electron motion that produces a strong dipole.
          In a dielectric host, the resonance typically appears in the <strong>visible</strong> and is strongest when the real part of the metal permittivity is near
          <code>−2ε_m</code>, while the imaginary part controls damping (absorption). For very small particles, absorption often dominates; as the particle gets larger,
          scattering grows rapidly (roughly ∝ <code>a⁶</code> through <code>|α|²</code>).
        </p>

        <h3>3.2 Material model: modified Drude + Lorentz permittivity</h3>
        <div class="eqBlock" id="eq-eps">
          <button class="copyBtn" data-copy="eq-eps">Copy</button>
          <pre class="eq">
Given model (relative permittivity of bulk Ag):
εr(ω) = 1 +  ( ωp^2 ) / ( -ω^2 + i ω ζ ωp )  +  ( 2.2 ωp^2 ) / ( ωL^2 - ω^2 + i ω ζL ωp )

Parameters:
ζ  = 0.00229 ωp
ωL = 0.575   ωp
ζL = 0.124   ωp

Plasma wavelength: λp = 135.2 nm  ⇒  ωp = 2π c / λp
Frequency-wavelength: ω = 2π c / λ0
          </pre>
        </div>
        <p class="kicker">
          What we did: we wrote the provided dispersion model in a computationally friendly form.
          Why: once we can compute <code>εr(ω)</code> for each <code>λ0</code>, everything else follows from electrostatics + dipole radiation.
        </p>

        <h3>3.3 Dipole polarizability of a small sphere in a host</h3>
        <div class="eqBlock" id="eq-alpha">
          <button class="copyBtn" data-copy="eq-alpha">Copy</button>
          <pre class="eq">
Host relative permittivity: εm = n^2

Electrostatic polarizability (sphere in a dielectric host):
α(ω) = 4π ε0 εm a^3 * ( εr(ω) - εm ) / ( εr(ω) + 2 εm )

(We will use εm in the cross-section formulas via ε = ε0 εm.)
          </pre>
        </div>
        <p class="kicker">
          Meaning: the fraction <code>(εr−εm)/(εr+2εm)</code> is the boundary-condition “contrast factor.”
          When its denominator becomes small (in magnitude), the dipole response becomes large → resonance.
        </p>

        <h3>3.4 Cross-sections and efficiencies in the host medium</h3>
        <div class="eqBlock" id="eq-cs">
          <button class="copyBtn" data-copy="eq-cs">Copy</button>
          <pre class="eq">
Host wavenumber: k = 2π n / λ0

Dipole formulas in a medium of permittivity ε = ε0 εm:
Cext = (k / (ε0 εm)) Im{ α }
Csca = (k^4 / (6π (ε0 εm)^2)) |α|^2
Cabs = Cext − Csca

Efficiencies (dimensionless):
Qs = Csca / (π a^2)
Qa = Cabs / (π a^2)
          </pre>
        </div>
        <p class="kicker">
          What we did: we connected dipole strength to power removed from the incident beam (extinction), then split it into scattered vs absorbed parts.
          Sanity: <code>Cabs ≥ 0</code> and <code>Cext = Csca + Cabs</code>.
        </p>

        <h3>3.5 Internal field inside the small sphere</h3>
        <div class="eqBlock" id="eq-ein">
          <button class="copyBtn" data-copy="eq-ein">Copy</button>
          <pre class="eq">
Uniform internal field (quasi-static sphere):
Ei/E0 = 3 εm / ( εr(ω) + 2 εm )

We typically plot magnitude: |Ei/E0|
          </pre>
        </div>
        <p class="kicker">
          Interpretation: this is the classic electrostatics result. At resonance, the internal field can be strongly enhanced (limited by losses).
        </p>

        <h3>3.6 Resonance identification</h3>
        <p>
          In an ideal lossless case, resonance occurs at the <strong>Fröhlich condition</strong>:
          <code>Re{εr(ω)} = −2εm</code>. With losses, the peak in <code>|Ei/E0|</code> occurs near (but not exactly at) that condition.
          In this solution, we define <strong>resonance</strong> as the wavelength where <code>|Ei/E0|</code> is maximal over 350–1000 nm.
        </p>

        <div class="resultsGrid">
          <div class="canvasCard">
            <h3>Interactive Visualizations (diagram + 2 plots)</h3>
            <div class="vizWrap">
              <div class="canvasCard">
                <h3>Diagram: Ag sphere in glass + incident wave</h3>
                <canvas id="canvasDiagram" aria-label="Diagram canvas"></canvas>
                <div class="smallNote" style="margin-top:8px">
                  Labeled geometry (radius <span id="lblA">10</span> nm) and propagation in glass (n = 1.45).
                </div>
              </div>
              <div class="controls">
                <div class="ctrl">
                  <label>
                    <span><strong>Radius a</strong> (nm)</span>
                    <span class="pill" id="aReadout">10.0</span>
                  </label>
                  <input id="aSlider" type="range" min="5" max="60" step="0.5" value="10" />
                  <div class="pillRow">
                    <span class="pill">Host index n = 1.45 (fixed)</span>
                    <span class="pill">Range: 350–1000 nm</span>
                    <span class="pill">Model: modified Drude + Lorentz</span>
                  </div>
                </div>

                <div class="ctrl">
                  <label>
                    <span><strong>Resonance definition</strong></span>
                    <span class="pill" id="resMode">max |Ei/E0|</span>
                  </label>
                  <div class="mini">
                    We mark resonance at the wavelength where the internal field enhancement peaks.
                    (In practice, extinction peak is often close.)
                  </div>
                </div>

                <div class="ctrl callout final">
                  <strong>Computed resonance &amp; coefficients</strong>
                  <p class="mini" style="margin:8px 0 0 0;">
                    Values update live with the radius slider.
                  </p>
                </div>
              </div>
            </div>
          </div>

          <div class="canvasCard">
            <h3>Main plot: efficiencies vs wavelength</h3>
            <canvas id="canvasMain" aria-label="Main plot canvas"></canvas>
            <div class="smallNote" style="margin-top:8px">
              Plots <code>Q_s(λ0)</code> and <code>Q_a(λ0)</code>. Vertical marker indicates resonance.
            </div>
          </div>
        </div>

        <div class="canvasCard">
          <h3>Secondary plot: internal field enhancement vs wavelength</h3>
          <canvas id="canvasSecondary" aria-label="Secondary plot canvas"></canvas>
          <div class="smallNote" style="margin-top:8px">
            Plots <code>|E_i/E_0|(λ0)</code>. Resonance is chosen as the maximum of this curve.
          </div>
        </div>

        <h3>3.7 Numerical results (from the model, at the selected radius)</h3>
        <div class="callout final">
          <p style="margin:0 0 10px 0;"><strong>Final answer (updates with slider):</strong></p>
          <div class="eqBlock" id="eq-final">
            <button class="copyBtn" data-copy="eq-final">Copy</button>
            <pre class="eq" id="finalText">Loading…</pre>
          </div>
          <p class="mini" style="margin:10px 0 0 0;">
            Interpretation: <code>a_s</code> and <code>a_a</code> are reported here as the scattering and absorption <strong>cross-sections</strong>
            (<code>C_sca</code>, <code>C_abs</code>) at resonance, consistent with common nanoparticle optics usage.
          </p>
        </div>

        <h3>3.8 Sanity checks</h3>
        <div class="grid2">
          <div class="callout">
            <strong>Units</strong>
            <ul class="mini">
              <li><code>k</code> has units m⁻¹.</li>
              <li><code>α</code> has units of F·m² (SI), but cross-section formulas remove units correctly.</li>
              <li><code>C</code> has units m², so <code>Q</code> is dimensionless.</li>
            </ul>
          </div>
          <div class="callout">
            <strong>Limiting behavior</strong>
            <ul class="mini">
              <li>As <code>a → 0</code>, <code>C_sca ∝ a⁶</code> becomes tiny faster than <code>C_abs ∝ a³</code> → absorption dominates for very small particles.</li>
              <li>If losses were reduced (<code>Im εr</code> smaller), peaks would become taller and narrower.</li>
            </ul>
          </div>
        </div>

        <p>
          Connection to the diagram: the incident field polarizes the Ag sphere; the induced dipole both radiates (scattering) and dissipates energy (absorption).
          The plots quantify these two channels and the field enhancement inside the particle that accompanies resonance.
        </p>
      </section>

      <section id="part4">
        <h2>PART 4 — Deeper Understanding (THEORY AROUND THE RESULT)</h2>

        <h3>4.1 Re-interpreting the key formulas</h3>
        <div class="callout keyeq">
          <p class="mini" style="margin:0">
            The entire spectral shape is controlled by the complex contrast factor:
            <code>(εr − εm)/(εr + 2εm)</code>.
            <br/><br/>
            • <strong>Resonance position:</strong> primarily when <code>Re(εr) ≈ −2εm</code> (host sets the “−2εm” target).<br/>
            • <strong>Peak height &amp; width:</strong> controlled by <code>Im(εr)</code> (loss).<br/>
            • <strong>Scattering vs absorption balance:</strong> set by size: <code>C_sca ∝ k^4 |α|^2 ∝ a^6</code>, while <code>C_abs</code> grows ~<code>a^3</code> (through <code>Im α</code>).
          </p>
        </div>

        <h3>4.2 How parameter changes affect outcomes (connect to plots)</h3>
        <ul>
          <li><strong>Increase radius a:</strong> scattering grows much faster than absorption. You should see <code>Q_s</code> rise strongly, and the resonance may shift slightly due to radiative damping (in more complete models) and the <code>k</code>-dependent scattering term.</li>
          <li><strong>Change host index n (fixed here):</strong> larger <code>n</code> (larger <code>εm</code>) shifts the resonance to longer wavelengths because the Fröhlich target becomes more negative (<code>−2εm</code>).</li>
          <li><strong>Increase damping parameters (not exposed):</strong> peaks broaden and <code>|E_i/E_0|</code> drops.</li>
        </ul>

        <h3>4.3 Alternative derivation idea (brief)</h3>
        <p>
          Instead of starting from polarizability, one can derive the same results by:
          (i) solving Laplace’s equation for the potential of a sphere in a uniform field with boundary conditions on <code>E_t</code> and <code>D_n</code>,
          (ii) extracting the induced dipole moment <code>p</code>, and (iii) using dipole radiation power in a dielectric to obtain <code>C_sca</code>,
          while <code>C_ext</code> comes from the optical theorem. This is mathematically equivalent but gives extra intuition about boundary conditions.
        </p>

        <h3>4.4 Concept checks (self-test)</h3>
        <ul>
          <li><strong>Q:</strong> Why is the resonance condition not exactly <code>Re(εr)=−2εm</code> in real metals? <br/>
              <strong>A:</strong> Because <code>Im(εr)≠0</code> adds damping; the maximum of a magnitude occurs when both real and imaginary parts balance.</li>
          <li><strong>Q:</strong> Why can <code>Q_s</code> exceed 1? <br/>
              <strong>A:</strong> Because “efficiency” is cross-section divided by geometric area; resonant scattering can have an effective area larger than the physical size.</li>
          <li><strong>Q:</strong> For very small particles, which dominates: scattering or absorption? <br/>
              <strong>A:</strong> Absorption, because <code>C_abs ~ a^3</code> while <code>C_sca ~ a^6</code>.</li>
          <li><strong>Q:</strong> What does a large <code>|E_i/E_0|</code> imply physically? <br/>
              <strong>A:</strong> Strong polarization and energy concentration inside/near the particle; often correlated with heating and enhanced light–matter interactions.</li>
        </ul>
      </section>

      <section id="part5">
        <h2>PART 5 — Visualization Guide (HOW TO READ THE PLOTS)</h2>
        <h3>5.1 Diagram canvas</h3>
        <ul>
          <li>Shows a sphere of radius <code>a</code> embedded in glass (index <code>n</code>), illuminated by a plane wave.</li>
          <li>The arrow indicates propagation direction; the oscillating line indicates the electric field polarization.</li>
          <li>The label reminds you that <code>k = 2πn/λ0</code> uses the host medium.</li>
        </ul>

        <h3>5.2 Main plot (efficiencies)</h3>
        <ul>
          <li>Two curves: <strong>scattering efficiency</strong> <code>Q_s</code> and <strong>absorption efficiency</strong> <code>Q_a</code> vs <code>λ0</code>.</li>
          <li>The vertical line marks resonance (chosen as the peak of <code>|E_i/E_0|</code>).</li>
          <li>Watch how <code>Q_s</code> grows rapidly as you increase <code>a</code>.</li>
        </ul>

        <h3>5.3 Secondary plot (internal field)</h3>
        <ul>
          <li>Shows <code>|E_i/E_0|(λ0)</code>. This is the most direct “plasmon enhancement” indicator in the quasi-static model.</li>
          <li>The resonance wavelength is taken at the maximum of this curve.</li>
        </ul>

        <h3>5.4 Interactive control</h3>
        <ul>
          <li><strong>Radius slider:</strong> changes <code>a</code> and updates the diagram and both plots live.</li>
          <li><strong>What should change and why:</strong> scattering scales roughly like <code>a^6</code>, so increasing <code>a</code> makes <code>Q_s</code> rise strongly; absorption grows more gently.</li>
        </ul>
      </section>
    </div>
  </main>

  <footer>
    Built with vanilla HTML/CSS/JS. Physics model: quasi-static (Rayleigh) dipole response with a modified Drude+Lorentz permittivity for Ag.
  </footer>

<script>
/* -----------------------------
   Utilities: Copy buttons
------------------------------*/
(function(){
  function textFromEqBlock(id){
    const el = document.getElementById(id);
    if(!el) return "";
    const pre = el.querySelector("pre");
    return pre ? pre.innerText.trim() : el.innerText.trim();
  }
  async function copyText(txt, btn){
    try{
      await navigator.clipboard.writeText(txt);
      const old = btn.textContent;
      btn.textContent = "Copied!";
      setTimeout(()=>btn.textContent = old, 900);
    }catch(e){
      const old = btn.textContent;
      btn.textContent = "Copy failed";
      setTimeout(()=>btn.textContent = old, 900);
    }
  }
  document.addEventListener("click", (ev)=>{
    const btn = ev.target.closest(".copyBtn");
    if(!btn) return;
    const key = btn.getAttribute("data-copy");
    if(!key) return;
    const txt = textFromEqBlock(key);
    copyText(txt, btn);
  });
})();

/* -----------------------------
   Complex arithmetic
------------------------------*/
class Complex{
  constructor(re, im){ this.re = re; this.im = im; }
  add(b){ return new Complex(this.re+b.re, this.im+b.im); }
  sub(b){ return new Complex(this.re-b.re, this.im-b.im); }
  mul(b){ return new Complex(this.re*b.re - this.im*b.im, this.re*b.im + this.im*b.re); }
  div(b){
    const d = b.re*b.re + b.im*b.im;
    return new Complex((this.re*b.re + this.im*b.im)/d, (this.im*b.re - this.re*b.im)/d);
  }
  scale(s){ return new Complex(this.re*s, this.im*s); }
  abs(){ return Math.hypot(this.re, this.im); }
  conj(){ return new Complex(this.re, -this.im); }
  static i(){ return new Complex(0,1); }
}

/* -----------------------------
   Physics model (Rayleigh dipole)
------------------------------*/
const c = 299792458; // m/s
const nHost = 1.45;
const epsM = nHost*nHost; // relative permittivity of host (assumed real)
const lambdaP_nm = 135.2; // nm
const omegaP = 2*Math.PI*c/(lambdaP_nm*1e-9); // rad/s (since λ = 2πc/ω)
const zeta = 0.00229 * omegaP;
const omegaL = 0.575 * omegaP;
const zetaL = 0.124 * omegaP;

// εr(ω) model: 1 + ωp^2/(-ω^2 + i ω ζ ωp) + 2.2 ωp^2/(ωL^2 - ω^2 + i ω ζL ωp)
function epsAgRel(omega){
  const w = omega;
  const i = Complex.i();

  // term1: ωp^2 / (-w^2 + i w ζ ωp)
  const denom1 = new Complex(-w*w, 0).add(i.scale(w*zeta*omegaP));
  const term1 = new Complex(omegaP*omegaP, 0).div(denom1);

  // term2: 2.2 ωp^2 / (ωL^2 - w^2 + i w ζL ωp)
  const denom2 = new Complex(omegaL*omegaL - w*w, 0).add(i.scale(w*zetaL*omegaP));
  const term2 = new Complex(2.2*omegaP*omegaP, 0).div(denom2);

  return new Complex(1,0).add(term1).add(term2);
}

// Helper: compute curves vs wavelength for a given radius a (meters)
function computeSpectra(a_m){
  const lamMin = 350, lamMax = 1000; // nm
  const step = 2; // nm
  const lambdas = [];
  const Qs = [];
  const Qa = [];
  const Ein = [];
  const Csca = [];
  const Cabs = [];

  const pi = Math.PI;

  for(let lam=lamMin; lam<=lamMax+1e-9; lam+=step){
    const lambda0 = lam*1e-9;
    const omega = 2*Math.PI*c/lambda0;
    const epsR = epsAgRel(omega);

    // Polarizability α = 4π ε0 εm a^3 * (epsR - epsM)/(epsR + 2 epsM)
    // For cross-sections we use αtilde = 4π εm a^3 * (epsR - epsM)/(epsR + 2 epsM),
    // because ε0 cancels in C formulas when dividing by ε=ε0 εm.
    const num = epsR.sub(new Complex(epsM,0));
    const den = epsR.add(new Complex(2*epsM,0));
    const frac = num.div(den);
    const alphaTilde = frac.scale(4*pi*epsM*Math.pow(a_m,3)); // α/ε0

    const k = 2*pi*nHost/lambda0;

    // Cext = (k/epsM) Im(alphaTilde)
    const Cext = (k/epsM)*alphaTilde.im;

    // Csca = k^4/(6π epsM^2) |alphaTilde|^2
    const CscaVal = (Math.pow(k,4)/(6*pi*Math.pow(epsM,2)))*Math.pow(alphaTilde.abs(),2);

    // Cabs = Cext - Csca
    let CabsVal = Cext - CscaVal;
    if(CabsVal < 0) CabsVal = 0; // numerical clamp

    const QsVal = CscaVal/(pi*a_m*a_m);
    const QaVal = CabsVal/(pi*a_m*a_m);

    // Ei/E0 = 3 epsM / (epsR + 2 epsM)
    const EiOverE0 = (new Complex(3*epsM,0)).div(den).abs();

    lambdas.push(lam);
    Qs.push(QsVal);
    Qa.push(QaVal);
    Ein.push(EiOverE0);
    Csca.push(CscaVal);
    Cabs.push(CabsVal);
  }

  // resonance: max |Ei/E0|
  let idx = 0;
  for(let i=1;i<Ein.length;i++){
    if(Ein[i] > Ein[idx]) idx = i;
  }

  return {
    lambdas, Qs, Qa, Ein, idxRes: idx,
    Csca, Cabs
  };
}

/* -----------------------------
   Canvas plotting helpers
------------------------------*/
function setupCanvas(canvas){
  const ctx = canvas.getContext("2d");
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(320, rect.width);
    const h = rect.height;
    canvas.width = Math.round(w*dpr);
    canvas.height = Math.round(h*dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
  }
  return {ctx, resize};
}

function niceTicks(min, max, desired=6){
  const span = max - min;
  if(span <= 0) return {min, max, step:1};
  const raw = span/desired;
  const pow10 = Math.pow(10, Math.floor(Math.log10(raw)));
  const frac = raw/pow10;
  let niceFrac = 1;
  if(frac >= 5) niceFrac = 5;
  else if(frac >= 2) niceFrac = 2;
  else niceFrac = 1;
  const step = niceFrac*pow10;
  const niceMin = Math.floor(min/step)*step;
  const niceMax = Math.ceil(max/step)*step;
  return {min:niceMin, max:niceMax, step};
}

function drawAxes(ctx, box, xLabel, yLabel, xRange, yRange, title){
  const {x,y,w,h} = box;
  ctx.save();
  ctx.clearRect(0,0,ctx.canvas.width, ctx.canvas.height);

  // background panel
  ctx.fillStyle = "rgba(0,0,0,0.14)";
  roundRect(ctx, x, y, w, h, 14);
  ctx.fill();

  // title
  ctx.fillStyle = "rgba(233,238,252,0.95)";
  ctx.font = "600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(title, x+12, y+22);

  const padL=56, padR=18, padT=34, padB=44;
  const px = x+padL, py = y+padT;
  const pw = w-padL-padR, ph = h-padT-padB;

  // grid + ticks
  const xt = niceTicks(xRange.min, xRange.max, 7);
  const yt = niceTicks(yRange.min, yRange.max, 6);

  // axes frame
  ctx.strokeStyle = "rgba(255,255,255,0.14)";
  ctx.lineWidth = 1;
  ctx.strokeRect(px, py, pw, ph);

  // gridlines
  ctx.strokeStyle = "rgba(255,255,255,0.07)";
  ctx.lineWidth = 1;

  // x ticks
  for(let xv=xt.min; xv<=xt.max+1e-12; xv+=xt.step){
    const tx = px + (xv-xRange.min)/(xRange.max-xRange.min)*pw;
    ctx.beginPath();
    ctx.moveTo(tx, py);
    ctx.lineTo(tx, py+ph);
    ctx.stroke();
  }
  // y ticks
  for(let yv=yt.min; yv<=yt.max+1e-12; yv+=yt.step){
    const ty = py+ph - (yv-yRange.min)/(yRange.max-yRange.min)*ph;
    ctx.beginPath();
    ctx.moveTo(px, ty);
    ctx.lineTo(px+pw, ty);
    ctx.stroke();
  }

  // tick labels
  ctx.fillStyle = "rgba(183,195,230,0.95)";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";

  for(let xv=xt.min; xv<=xt.max+1e-12; xv+=xt.step){
    const tx = px + (xv-xRange.min)/(xRange.max-xRange.min)*pw;
    ctx.fillText(formatTick(xv), tx-10, py+ph+18);
  }
  for(let yv=yt.min; yv<=yt.max+1e-12; yv+=yt.step){
    const ty = py+ph - (yv-yRange.min)/(yRange.max-yRange.min)*ph;
    ctx.fillText(formatTick(yv), x+10, ty+4);
  }

  // labels
  ctx.fillStyle = "rgba(233,238,252,0.92)";
  ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText(xLabel, px + pw/2 - ctx.measureText(xLabel).width/2, y+h-12);

  // y label rotated
  ctx.save();
  ctx.translate(x+16, py + ph/2);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
  ctx.restore();

  ctx.restore();

  return {plot:{x:px,y:py,w:pw,h:ph}};
}

function formatTick(v){
  const av = Math.abs(v);
  if(av >= 1000) return (Math.round(v)).toString();
  if(av >= 10) return (Math.round(v*10)/10).toString();
  if(av >= 1) return (Math.round(v*100)/100).toString();
  return (Math.round(v*1000)/1000).toString();
}

function roundRect(ctx, x, y, w, h, r){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
}

function drawCurve(ctx, plotBox, xVals, yVals, xRange, yRange, strokeStyle, lineWidth=2){
  const {x,y,w,h} = plotBox;
  ctx.save();
  ctx.strokeStyle = strokeStyle;
  ctx.lineWidth = lineWidth;
  ctx.beginPath();
  for(let i=0;i<xVals.length;i++){
    const xv = x + (xVals[i]-xRange.min)/(xRange.max-xRange.min)*w;
    const yv = y + h - (yVals[i]-yRange.min)/(yRange.max-yRange.min)*h;
    if(i===0) ctx.moveTo(xv,yv);
    else ctx.lineTo(xv,yv);
  }
  ctx.stroke();
  ctx.restore();
}

function drawVLine(ctx, plotBox, xVal, xRange, color, label){
  const {x,y,w,h} = plotBox;
  const xv = x + (xVal-xRange.min)/(xRange.max-xRange.min)*w;
  ctx.save();
  ctx.strokeStyle = color;
  ctx.lineWidth = 2;
  ctx.setLineDash([6,6]);
  ctx.beginPath();
  ctx.moveTo(xv, y);
  ctx.lineTo(xv, y+h);
  ctx.stroke();
  ctx.setLineDash([]);
  if(label){
    ctx.fillStyle = color;
    ctx.font = "600 12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
    ctx.fillText(label, xv+6, y+16);
  }
  ctx.restore();
}

function drawLegend(ctx, box, items){
  // items: [{name,color}]
  const {x,y,w} = box;
  ctx.save();
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  let cx = x+70, cy = y+12;
  items.forEach((it, idx)=>{
    const tx = cx + idx*140;
    ctx.strokeStyle = it.color;
    ctx.lineWidth = 3;
    ctx.beginPath();
    ctx.moveTo(tx, cy);
    ctx.lineTo(tx+26, cy);
    ctx.stroke();
    ctx.fillStyle = "rgba(233,238,252,0.92)";
    ctx.fillText(it.name, tx+34, cy+4);
  });
  ctx.restore();
}

/* -----------------------------
   Diagram rendering
------------------------------*/
function drawDiagram(ctx, canvas, a_nm){
  const rect = canvas.getBoundingClientRect();
  const W = rect.width, H = rect.height;

  ctx.clearRect(0,0,canvas.width, canvas.height);

  // panel
  ctx.save();
  ctx.fillStyle = "rgba(0,0,0,0.14)";
  roundRect(ctx, 10, 10, W-20, H-20, 14);
  ctx.fill();

  // glass background band
  ctx.fillStyle = "rgba(125,211,252,0.06)";
  ctx.fillRect(22, 40, W-44, H-70);

  // axes-like annotation
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(22, H-30);
  ctx.lineTo(W-22, H-30);
  ctx.stroke();

  // sphere
  const cx = W*0.52, cy = H*0.52;
  const R = Math.min(W,H)*0.15;

  const grad = ctx.createRadialGradient(cx-R*0.35, cy-R*0.35, R*0.2, cx, cy, R);
  grad.addColorStop(0, "rgba(233,238,252,0.38)");
  grad.addColorStop(1, "rgba(167,139,250,0.08)");
  ctx.fillStyle = grad;
  ctx.beginPath();
  ctx.arc(cx, cy, R, 0, Math.PI*2);
  ctx.fill();
  ctx.strokeStyle = "rgba(125,211,252,0.35)";
  ctx.lineWidth = 2;
  ctx.stroke();

  // radius arrow
  ctx.strokeStyle = "rgba(251,191,36,0.9)";
  ctx.fillStyle = "rgba(251,191,36,0.9)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(cx, cy);
  ctx.lineTo(cx+R, cy);
  ctx.stroke();
  // arrow head
  ctx.beginPath();
  ctx.moveTo(cx+R, cy);
  ctx.lineTo(cx+R-10, cy-5);
  ctx.lineTo(cx+R-10, cy+5);
  ctx.closePath();
  ctx.fill();

  // incident wave arrow
  ctx.strokeStyle = "rgba(134,239,172,0.9)";
  ctx.fillStyle = "rgba(134,239,172,0.9)";
  ctx.lineWidth = 3;
  const x0 = 36, y0 = cy;
  ctx.beginPath();
  ctx.moveTo(x0, y0);
  ctx.lineTo(cx-R-28, y0);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(cx-R-28, y0);
  ctx.lineTo(cx-R-40, y0-7);
  ctx.lineTo(cx-R-40, y0+7);
  ctx.closePath();
  ctx.fill();

  // E-field wiggle above arrow
  ctx.strokeStyle = "rgba(125,211,252,0.85)";
  ctx.lineWidth = 2;
  ctx.beginPath();
  const start = 36, end = cx-R-34;
  const amp = 10;
  const baseY = y0-28;
  const cycles = 5;
  for(let i=0;i<=260;i++){
    const t = i/260;
    const xx = start + t*(end-start);
    const yy = baseY + amp*Math.sin(2*Math.PI*cycles*t);
    if(i===0) ctx.moveTo(xx,yy); else ctx.lineTo(xx,yy);
  }
  ctx.stroke();

  // labels
  ctx.fillStyle = "rgba(233,238,252,0.92)";
  ctx.font = "600 14px system-ui, -apple-system, Segoe UI, Roboto, Arial";
  ctx.fillText("Glass host (n = 1.45)", 28, 34);

  ctx.fillStyle = "rgba(183,195,230,0.95)";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Consolas, monospace";
  ctx.fillText("Incident wave: k = 2πn/λ0", 28, H-42);
  ctx.fillText("Ag sphere", cx-28, cy+R+24);

  ctx.fillStyle = "rgba(251,191,36,0.95)";
  ctx.fillText(`a = ${a_nm.toFixed(1)} nm`, cx+R+10, cy+4);

  ctx.fillStyle = "rgba(125,211,252,0.95)";
  ctx.fillText("E-field", 28, y0-44);

  ctx.restore();
}

/* -----------------------------
   App state and rendering
------------------------------*/
const canvDiagram = document.getElementById("canvasDiagram");
const canvMain = document.getElementById("canvasMain");
const canvSec = document.getElementById("canvasSecondary");

const diag = setupCanvas(canvDiagram);
const main = setupCanvas(canvMain);
const sec  = setupCanvas(canvSec);

const aSlider = document.getElementById("aSlider");
const aReadout = document.getElementById("aReadout");
const lblA = document.getElementById("lblA");
const finalText = document.getElementById("finalText");

let spectra = null;

function renderAll(){
  // resize canvases
  diag.resize(); main.resize(); sec.resize();

  const a_nm = parseFloat(aSlider.value);
  const a_m = a_nm*1e-9;

  aReadout.textContent = a_nm.toFixed(1);
  lblA.textContent = a_nm.toFixed(1);

  // compute
  spectra = computeSpectra(a_m);

  // update diagram
  drawDiagram(diag.ctx, canvDiagram, a_nm);

  // common x-range
  const xRange = {min: 350, max: 1000};

  // main plot y-range: Qs & Qa
  const yMaxMain = Math.max(
    ...spectra.Qs,
    ...spectra.Qa
  );
  const yRangeMain = {min: 0, max: yMaxMain*1.08 + 1e-12};

  // draw main axes
  const boxMain = {x: 10, y: 10, w: canvMain.getBoundingClientRect().width-20, h: canvMain.getBoundingClientRect().height-20};
  const axMain = drawAxes(main.ctx, boxMain,
    "Free-space wavelength λ0 (nm)",
    "Efficiency Q (dimensionless)",
    xRange, yRangeMain,
    "Efficiencies: Qs (scattering) and Qa (absorption)"
  );

  // legend
  drawLegend(main.ctx, {x: boxMain.x, y: boxMain.y, w: boxMain.w}, [
    {name:"Qs", color:"rgba(125,211,252,0.95)"},
    {name:"Qa", color:"rgba(251,191,36,0.95)"}
  ]);

  // curves
  drawCurve(main.ctx, axMain.plot, spectra.lambdas, spectra.Qs, xRange, yRangeMain, "rgba(125,211,252,0.95)", 2.6);
  drawCurve(main.ctx, axMain.plot, spectra.lambdas, spectra.Qa, xRange, yRangeMain, "rgba(251,191,36,0.95)", 2.6);

  // resonance marker
  const lamRes = spectra.lambdas[spectra.idxRes];
  drawVLine(main.ctx, axMain.plot, lamRes, xRange, "rgba(134,239,172,0.95)", "res");

  // secondary plot y-range: |Ei/E0|
  const yMaxSec = Math.max(...spectra.Ein);
  const yRangeSec = {min: 0, max: yMaxSec*1.08 + 1e-12};

  const boxSec = {x: 10, y: 10, w: canvSec.getBoundingClientRect().width-20, h: canvSec.getBoundingClientRect().height-20};
  const axSec = drawAxes(sec.ctx, boxSec,
    "Free-space wavelength λ0 (nm)",
    "|Ei/E0| (dimensionless)",
    xRange, yRangeSec,
    "Internal field enhancement (quasi-static): |Ei/E0|"
  );

  drawLegend(sec.ctx, {x: boxSec.x, y: boxSec.y, w: boxSec.w}, [
    {name:"|Ei/E0|", color:"rgba(167,139,250,0.95)"}
  ]);

  drawCurve(sec.ctx, axSec.plot, spectra.lambdas, spectra.Ein, xRange, yRangeSec, "rgba(167,139,250,0.95)", 2.6);
  drawVLine(sec.ctx, axSec.plot, lamRes, xRange, "rgba(134,239,172,0.95)", "res");

  // Update final result text
  const i = spectra.idxRes;
  const QsRes = spectra.Qs[i];
  const QaRes = spectra.Qa[i];
  const EinRes = spectra.Ein[i];
  const CscaRes = spectra.Csca[i];
  const CabsRes = spectra.Cabs[i];

  const geo = Math.PI*a_m*a_m;
  const nm2 = 1e-18; // m^2 -> nm^2
  const Csca_nm2 = CscaRes / nm2;
  const Cabs_nm2 = CabsRes / nm2;
  const geo_nm2  = geo / nm2;

  // Also report Fröhlich check at resonance: Re(εr) + 2εm (computed by re-evaluating εr)
  const lambda0 = lamRes*1e-9;
  const omega = 2*Math.PI*c/lambda0;
  const epsR = epsAgRel(omega);

  finalText.textContent =
`Inputs:
- Host index n = ${nHost.toFixed(2)}  →  εm = n^2 = ${(epsM).toFixed(4)}
- Radius a = ${a_nm.toFixed(1)} nm
- Wavelength range: 350–1000 nm (step 2 nm)

Resonance (defined as max |Ei/E0| in this range):
- λ_res = ${lamRes.toFixed(1)} nm
- |Ei/E0|_res = ${EinRes.toFixed(3)}

Efficiencies at resonance:
- Qs(λ_res) = ${QsRes.toFixed(4)}
- Qa(λ_res) = ${QaRes.toFixed(4)}

“Coefficients” at resonance (reported as cross-sections):
- a_s = C_sca(λ_res) = ${CscaRes.toExponential(3)} m^2  (= ${Csca_nm2.toFixed(1)} nm^2)
- a_a = C_abs(λ_res) = ${CabsRes.toExponential(3)} m^2  (= ${Cabs_nm2.toFixed(1)} nm^2)

Geometric area:
- πa^2 = ${geo.toExponential(3)} m^2  (= ${geo_nm2.toFixed(1)} nm^2)

Material check at resonance (Ag relative permittivity):
- εr(λ_res) = ${epsR.re.toFixed(3)} + i ${epsR.im.toFixed(3)}
- Fröhlich target: Re{εr} ≈ −2εm = ${(-2*epsM).toFixed(3)} (loss shifts peak slightly)`;
}

aSlider.addEventListener("input", renderAll);
window.addEventListener("resize", renderAll);

// Initial render
renderAll();
</script>
</body>
</html>
