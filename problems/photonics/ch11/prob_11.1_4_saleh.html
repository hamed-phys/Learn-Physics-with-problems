<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Mirrorless Resonators (Facet-Fresnel Fabryâ€“Perot): FSR, Loss, Finesse, Linewidth, Q, and Mode Number</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#0f1733;
      --card:#101a3a;
      --ink:#eaf0ff;
      --muted:#b9c5ff;
      --muted2:#93a2e8;
      --line:rgba(255,255,255,.10);
      --accent:#7aa6ff;
      --accent2:#9cffd6;
      --warn:#ffd37a;
      --good:#9cff9c;
      --bad:#ff8aa0;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --radius2: 24px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }

    html,body{height:100%;}
    body{
      margin:0;
      font-family: var(--sans);
      color:var(--ink);
      background:
        radial-gradient(1200px 700px at 15% 10%, rgba(122,166,255,.18), transparent 55%),
        radial-gradient(900px 600px at 90% 30%, rgba(156,255,214,.10), transparent 55%),
        radial-gradient(800px 600px at 50% 100%, rgba(255,211,122,.08), transparent 55%),
        linear-gradient(180deg, var(--bg), #070a14 75%, #050712);
      line-height:1.55;
    }

    header{
      padding: 34px 18px 18px;
      max-width: 1180px;
      margin: 0 auto;
    }
    header .kicker{
      color: var(--muted2);
      letter-spacing:.12em;
      text-transform: uppercase;
      font-size: 12px;
    }
    header h1{
      margin:.3rem 0 .6rem;
      font-weight: 760;
      letter-spacing: -0.02em;
      line-height: 1.12;
      font-size: clamp(26px, 3.3vw, 44px);
    }
    header p{
      margin:0;
      color: var(--muted);
      max-width: 78ch;
    }

    main{
      max-width: 1180px;
      margin: 0 auto;
      padding: 12px 18px 90px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap: 18px;
      align-items:start;
    }

    nav#toc{
      position: sticky;
      top: 14px;
      align-self:start;
      background: linear-gradient(180deg, rgba(16,26,58,.92), rgba(16,26,58,.72));
      border:1px solid var(--line);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 14px 14px 10px;
      backdrop-filter: blur(8px);
    }
    #toc h2{
      margin: 0 0 10px;
      font-size: 14px;
      letter-spacing:.02em;
      color: var(--muted);
      display:flex;
      gap:10px;
      align-items:center;
      justify-content:space-between;
    }
    #toc a{
      display:block;
      color: var(--ink);
      text-decoration:none;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid transparent;
      font-size: 13px;
      transition: transform .18s ease, background .18s ease, border-color .18s ease;
    }
    #toc a:hover{
      background: rgba(122,166,255,.08);
      border-color: rgba(122,166,255,.18);
      transform: translateX(2px);
    }
    #toc .mini{
      font-size:12px;
      color: var(--muted2);
      margin-top: 10px;
      padding: 10px;
      border-radius: 14px;
      background: rgba(0,0,0,.18);
      border:1px dashed rgba(255,255,255,.12);
    }

    article{
      min-width:0;
      display:flex;
      flex-direction:column;
      gap: 18px;
    }

    section{
      background: linear-gradient(180deg, rgba(16,26,58,.92), rgba(16,26,58,.70));
      border:1px solid var(--line);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    section .inner{
      padding: 18px 18px 16px;
    }

    h2{
      margin: 0 0 10px;
      font-size: 18px;
      letter-spacing: -0.01em;
    }
    h3{
      margin: 16px 0 8px;
      font-size: 15px;
      color: var(--muted);
    }
    p{margin: 8px 0; color: var(--ink);}
    ul{margin: 10px 0 10px 20px; color: var(--ink);}
    li{margin: 6px 0;}
    .muted{color: var(--muted);}
    .small{font-size: 13px; color: var(--muted);}

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px;
    }

    .callout{
      border: 1px solid rgba(255,255,255,.12);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      padding: 12px 12px 10px;
    }
    .callout .tag{
      display:inline-flex;
      align-items:center;
      gap:8px;
      font-size: 12px;
      letter-spacing:.10em;
      text-transform:uppercase;
      color: var(--muted2);
      margin-bottom: 6px;
    }
    .callout strong{color: var(--ink);}

    .eq{
      font-family: var(--mono);
      font-size: 13px;
      background: rgba(0,0,0,.22);
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      padding: 10px 12px;
      overflow:auto;
      white-space: pre;
      position: relative;
    }
    .eq .copyBtn{
      position:absolute;
      right:10px;
      top:10px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      padding: 6px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size: 12px;
      transition: transform .14s ease, background .14s ease;
    }
    .eq .copyBtn:hover{transform: translateY(-1px); background: rgba(122,166,255,.12);}
    .eq .copied{
      border-color: rgba(156,255,214,.35);
      background: rgba(156,255,214,.10);
    }

    .resultBox{
      border: 1px solid rgba(156,255,214,.22);
      background: linear-gradient(180deg, rgba(156,255,214,.11), rgba(0,0,0,.14));
      border-radius: 18px;
      padding: 14px 14px 12px;
    }
    .resultBox h3{margin-top:0; color: var(--accent2);}
    .kpi{
      display:grid;
      grid-template-columns: 1.2fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .kpi .row{
      display:flex;
      justify-content:space-between;
      gap:10px;
      padding: 9px 10px;
      border-radius: 14px;
      background: rgba(0,0,0,.16);
      border:1px solid rgba(255,255,255,.10);
    }
    .kpi .row .name{color: var(--muted); font-size: 13px;}
    .kpi .row .val{font-family: var(--mono); font-size: 13px;}

    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-top: 8px;
    }
    .ctrl{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      padding: 10px 10px 8px;
    }
    .ctrl label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      font-size: 12px;
      color: var(--muted);
      margin-bottom: 6px;
    }
    .ctrl input[type="range"]{width:100%;}
    .ctrl .readout{
      font-family: var(--mono);
      font-size: 12px;
      color: var(--ink);
      opacity:.95;
    }

    figure{
      margin:0;
      border-top:1px solid var(--line);
      background: rgba(0,0,0,.14);
      padding: 14px;
      display:grid;
      grid-template-columns: 1fr;
      gap: 10px;
    }

    .canvasWrap{
      position:relative;
      border-radius: 18px;
      border:1px solid rgba(255,255,255,.12);
      overflow:hidden;
      background: rgba(5,7,18,.75);
    }
    canvas{display:block; width:100%; height: 320px;}
    .canvasTitle{
      position:absolute;
      left:12px;
      top:10px;
      font-size: 12px;
      color: var(--muted);
      background: rgba(0,0,0,.28);
      border:1px solid rgba(255,255,255,.10);
      padding: 6px 10px;
      border-radius: 999px;
      backdrop-filter: blur(6px);
    }

    .noteRow{
      display:flex;
      flex-wrap:wrap;
      gap:10px;
      align-items:center;
      justify-content:space-between;
      margin-top: 8px;
    }
    .pill{
      display:inline-flex;
      gap:8px;
      align-items:center;
      font-size: 12px;
      color: var(--muted);
      padding: 8px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.16);
    }

    footer{
      max-width:1180px;
      margin:0 auto;
      padding: 18px 18px 40px;
      color: var(--muted2);
      font-size: 12px;
      opacity:.92;
    }

    @media (max-width: 980px){
      main{grid-template-columns: 1fr;}
      nav#toc{position:relative; top:auto;}
      canvas{height: 300px;}
    }
    @media (prefers-reduced-motion: reduce){
      *{transition:none !important; scroll-behavior:auto !important;}
    }
    @media print{
      body{background:#fff; color:#000;}
      nav#toc{display:none;}
      section{box-shadow:none; border:1px solid #ddd; background:#fff;}
      .eq{background:#f6f6f6;}
      .canvasWrap{border:1px solid #ddd;}
      .canvasTitle{display:none;}
      .copyBtn{display:none;}
    }
  </style>
</head>

<body>
<header>
  <div class="kicker">Photonics â€¢ Fabryâ€“Perot by Fresnel facets</div>
  <h1>Mirrorless Resonators: a Laser Diodeâ€™s Cleaved-Facet Fabryâ€“Perot</h1>
  <p>
    We treat two parallel crystal facets (no coated mirrors) as a Fabryâ€“Perot resonator.
    The â€œmirrorsâ€ are simply Fresnel reflections at the crystalâ€“air interfaces.
    From that we compute the resonance spacing (FSR), total distributed loss, finesse, linewidth, quality factor, and longitudinal mode number.
  </p>
</header>

<main>
  <nav id="toc" aria-label="Table of contents">
    <h2>Contents <span class="small">sticky</span></h2>
    <a href="#quick">Quick Summary</a>
    <a href="#part0">PART 0 â€” Concept Primer</a>
    <a href="#part1">PART 1 â€” Problem Analysis</a>
    <a href="#part2">PART 2 â€” Strategy & Tips</a>
    <a href="#part3">PART 3 â€” Full Solution</a>
    <a href="#part4">PART 4 â€” Deeper Understanding</a>
    <a href="#part5">PART 5 â€” Visualization Guide</a>
    <div class="mini">
      <div><strong>Interactive:</strong> adjust cavity length <span class="muted">d</span>, index <span class="muted">n</span>, and internal loss <span class="muted">Î±<sub>s</sub></span>. All plots and results update live.</div>
    </div>
  </nav>

  <article>
    <!-- Quick Summary -->
    <section id="quick">
      <div class="inner">
        <h2>Quick Summary</h2>
        <ul>
          <li><strong>What this is:</strong> a â€œmirrorlessâ€ Fabryâ€“Perot made by two cleaved crystal facets in air; facets reflect by <strong>Fresnel reflection</strong>.</li>
          <li><strong>Key idea:</strong> longitudinal resonances occur when the round-trip phase is an integer multiple of <span class="muted">2Ï€</span>.</li>
          <li><strong>Facet reflectance (normal incidence):</strong> <span class="muted">R = ((n-1)/(n+1))Â²</span>.</li>
          <li><strong>Free spectral range (FSR):</strong> <span class="muted">Î”Î½<sub>F</sub> = c/(2 n d)</span> (using <span class="muted">n â‰ˆ n<sub>g</sub></span>).</li>
          <li><strong>Mirror loss as distributed loss:</strong> <span class="muted">Î±<sub>m</sub> = (1/(2d)) ln(1/(Râ‚Râ‚‚))</span> â†’ for equal facets <span class="muted">Î±<sub>m</sub> = (1/d) ln(1/R)</span>.</li>
          <li><strong>Finesse:</strong> with internal loss, use the round-trip intensity factor <span class="muted">A = Râ‚Râ‚‚ e<sup>-2Î±<sub>s</sub>d</sup></span> and
            <span class="muted">ğ“• = Ï€ A<sup>1/4</sup> / (1 - A<sup>1/2</sup>)</span>.</li>
          <li><strong>Mode linewidth:</strong> <span class="muted">Î´Î½ = Î”Î½<sub>F</sub>/ğ“•</span>; <strong>quality factor</strong> <span class="muted">Q = Î½â‚€/Î´Î½</span>.</li>
          <li><strong>Numerical results (given data):</strong> Î”Î½<sub>F</sub> â‰ˆ <strong>2.08Ã—10Â¹Â¹ Hz</strong>, Î±<sub>T</sub> â‰ˆ <strong>5.81Ã—10Â¹</strong> cmâ»Â¹, ğ“• â‰ˆ <strong>2.56</strong>, Î´Î½ â‰ˆ <strong>8.14Ã—10Â¹â° Hz</strong>, Q â‰ˆ <strong>2.38Ã—10Â³</strong>, mode number q â‰ˆ <strong>929</strong>.</li>
        </ul>
      </div>
    </section>

    <!-- PART 0 -->
    <section id="part0">
      <div class="inner">
        <h2>PART 0 â€” Concept Primer (Theory Before Solving)</h2>

        <div class="grid2">
          <div class="callout">
            <div class="tag">Core definitions</div>
            <ul>
              <li><strong>Refractive index</strong> <span class="muted">n</span> (unitless): sets phase velocity <span class="muted">v<sub>p</sub>=c/n</span>.</li>
              <li><strong>Cavity length</strong> <span class="muted">d</span> (m): facet separation inside the medium.</li>
              <li><strong>Power reflectance</strong> <span class="muted">R</span> (unitless): fraction of power reflected at one facet.</li>
              <li><strong>Internal (distributed) loss</strong> <span class="muted">Î±<sub>s</sub></span> (1/length): power attenuation <span class="muted">I(z)=Iâ‚€e<sup>-Î±<sub>s</sub>z</sup></span>.</li>
              <li><strong>FSR</strong> <span class="muted">Î”Î½<sub>F</sub></span> (Hz): frequency spacing between adjacent longitudinal resonances.</li>
              <li><strong>Finesse</strong> <span class="muted">ğ“•</span> (unitless): <span class="muted">FSR / linewidth</span>.</li>
              <li><strong>Quality factor</strong> <span class="muted">Q</span> (unitless): <span class="muted">Q = (stored energy)/(energy lost per radian) = Î½â‚€/Î´Î½</span>.</li>
            </ul>
          </div>

          <div class="callout">
            <div class="tag">Physical meaning</div>
            <ul>
              <li><span class="muted">R</span> controls how strongly the cavity â€œrecyclesâ€ light each round trip.</li>
              <li><span class="muted">Î±<sub>s</sub></span> models absorption/scattering inside the crystal; it reduces the effective feedback.</li>
              <li><span class="muted">Î”Î½<sub>F</sub></span> is set by the <em>round-trip time</em> in the medium.</li>
              <li><span class="muted">ğ“•</span> measures how sharp resonances are; larger <span class="muted">ğ“•</span> means narrower peaks.</li>
              <li><span class="muted">Q</span> tells you how many optical cycles the field persists before decaying significantly.</li>
            </ul>
          </div>
        </div>

        <h3>Key laws / principles (and validity)</h3>
        <div class="callout">
          <div class="tag">Fabryâ€“Perot + Fresnel</div>
          <p class="muted">
            We assume: plane-parallel facets, normal incidence, linear optics, and a uniform index <span class="muted">n</span>.
            Fresnel reflection at normal incidence gives the facet reflectance.
            The Fabryâ€“Perot resonance condition comes from requiring constructive interference after a round trip.
          </p>
        </div>

        <div class="eq" data-copy="R = ((n1 - n2)/(n1 + n2))^2   (normal incidence, power reflectance)">
          <button class="copyBtn" type="button">Copy</button>
R = ((n1 - n2)/(n1 + n2))^2   (normal incidence, power reflectance)
        </div>

        <div class="eq" data-copy="Resonance: 2 n d = q Î»0   â‡”   q = 2 n d / Î»0">
          <button class="copyBtn" type="button">Copy</button>
Resonance: 2 n d = q Î»0   â‡”   q = 2 n d / Î»0
        </div>

        <div class="eq" data-copy="FSR: Î”Î½F = c / (2 n d)  (using n â‰ˆ group index ng)">
          <button class="copyBtn" type="button">Copy</button>
FSR: Î”Î½F = c / (2 n d)  (using n â‰ˆ group index ng)
        </div>

        <h3>Common models / approximations (and why)</h3>
        <ul>
          <li><strong>Normal incidence:</strong> simplifies Fresnel reflection and phase accumulation.</li>
          <li><strong>Group index â‰ˆ phase index:</strong> for a quick estimate of FSR; in dispersive media replace <span class="muted">n</span> with <span class="muted">n<sub>g</sub></span>.</li>
          <li><strong>Distributed loss model:</strong> treat internal attenuation as exponential power decay with <span class="muted">Î±<sub>s</sub></span>.</li>
        </ul>

        <h3>Mini intuition examples</h3>
        <ul>
          <li>If <span class="muted">d</span> increases, the round-trip time increases, so resonances get closer: <span class="muted">Î”Î½<sub>F</sub> âˆ 1/d</span>.</li>
          <li>If <span class="muted">R</span> increases (better mirrors), peaks sharpen: <span class="muted">ğ“•</span> grows and <span class="muted">Î´Î½</span> shrinks.</li>
        </ul>

        <div class="callout">
          <div class="tag">What to watch for</div>
          <ul>
            <li><strong>Units:</strong> internal loss is given in cmâ»Â¹ but cavity length may be in mm or mâ€”convert carefully.</li>
            <li><strong>Mirror loss vs internal loss:</strong> mirror loss can dominate when facet reflectance is modest.</li>
            <li><strong>FSR uses group index:</strong> if dispersion matters, <span class="muted">n</span> should be replaced by <span class="muted">n<sub>g</sub></span> (not provided here, so we use <span class="muted">n</span>).</li>
          </ul>
        </div>
      </div>

      <figure>
        <div class="canvasWrap">
          <div class="canvasTitle">Diagram: Cleaved-facet â€œmirrorlessâ€ Fabryâ€“Perot</div>
          <canvas id="diag" aria-label="Resonator diagram"></canvas>
        </div>
        <div class="small">
          Two parallel facets separated by <span class="muted">d</span> in a crystal (index <span class="muted">n</span>) in air.
          Each facet has Fresnel power reflectance <span class="muted">R</span>. Internal loss is modeled by <span class="muted">Î±<sub>s</sub></span>.
        </div>
      </figure>
    </section>

    <!-- PART 1 -->
    <section id="part1">
      <div class="inner">
        <h2>PART 1 â€” Problem Analysis (No Solving Yet)</h2>

        <h3>Problem restatement (in plain words)</h3>
        <p>
          A crystal in air acts like a Fabryâ€“Perot resonator because each cleaved face reflects light by Fresnel reflection.
          The faces are parallel and separated by <span class="muted">d</span>.
          Given the index <span class="muted">n</span> and internal loss <span class="muted">Î±<sub>s</sub></span>, determine:
          (i) resonance spacing (FSR) <span class="muted">Î”Î½<sub>F</sub></span>,
          (ii) overall distributed loss coefficient <span class="muted">Î±<sub>T</sub></span> (internal + mirror),
          (iii) finesse <span class="muted">ğ“•</span>,
          (iv) spectral width (linewidth) <span class="muted">Î´Î½</span> of a mode,
          (v) quality factor <span class="muted">Q</span>,
          and (vi) estimate the longitudinal mode number <span class="muted">q</span> at free-space wavelength <span class="muted">Î»â‚€</span>.
        </p>

        <div class="grid2">
          <div class="callout">
            <div class="tag">Given</div>
            <ul>
              <li>Ambient: air, <span class="muted">n<sub>air</sub>=1</span></li>
              <li>Crystal index: <span class="muted">n = 3.6</span></li>
              <li>Internal loss: <span class="muted">Î±<sub>s</sub> = 1 cmâ»Â¹</span></li>
              <li>Facet separation: <span class="muted">d = 0.2 mm</span></li>
              <li>Free-space wavelength: <span class="muted">Î»â‚€ = 1.55 Î¼m</span></li>
            </ul>
          </div>

          <div class="callout">
            <div class="tag">Unknowns to find</div>
            <ul>
              <li><span class="muted">Î”Î½<sub>F</sub></span> (Hz)</li>
              <li><span class="muted">Î±<sub>T</sub> = Î±<sub>s</sub> + Î±<sub>m</sub></span> (cmâ»Â¹)</li>
              <li><span class="muted">ğ“•</span> (unitless)</li>
              <li><span class="muted">Î´Î½</span> (Hz)</li>
              <li><span class="muted">Q</span> (unitless)</li>
              <li><span class="muted">q</span> (integer mode index, approximate)</li>
            </ul>
          </div>
        </div>

        <h3>Relevant physical principles (and why they apply)</h3>
        <ul>
          <li><strong>Fresnel reflection:</strong> the â€œmirrorsâ€ are just index steps at the facets, so <span class="muted">R</span> is set by <span class="muted">n</span> and <span class="muted">n<sub>air</sub></span>.</li>
          <li><strong>Fabryâ€“Perot resonance condition:</strong> parallel facets create multiple-beam interference; resonances occur when the round-trip phase is <span class="muted">2Ï€q</span>.</li>
          <li><strong>Loss as exponential attenuation:</strong> internal absorption/scatter is captured by <span class="muted">I(z)=Iâ‚€e^{-Î±_s z}</span>.</li>
        </ul>

        <div class="callout">
          <div class="tag">Assumptions</div>
          <ul>
            <li>Normal incidence (no angular dependence of Fresnel coefficients).</li>
            <li>Plane-parallel facets; no wedge; single longitudinal path length <span class="muted">d</span>.</li>
            <li>Uniform index <span class="muted">n</span>; ignore dispersion so <span class="muted">n â‰ˆ n_g</span>.</li>
            <li>Loss coefficient <span class="muted">Î±_s</span> applies to <em>power</em> (intensity).</li>
          </ul>
        </div>

        <h3>Possible approaches (and which we choose)</h3>
        <ul>
          <li><strong>Time-of-flight approach (best for FSR):</strong> compute round-trip time <span class="muted">Ï„ = 2nd/c</span>, then <span class="muted">Î”Î½_F = 1/Ï„</span>. Simple and robust.</li>
          <li><strong>Phase condition approach (best for mode number):</strong> <span class="muted">2nd = qÎ»â‚€</span>. Directly yields <span class="muted">q</span>.</li>
          <li><strong>Airy-function approach (best for finesse/linewidth):</strong> use the Fabryâ€“Perot transmission spectrum and relate <span class="muted">FSR/linewidth</span> to the effective round-trip attenuation.</li>
        </ul>
        <p class="muted">
          Weâ€™ll combine these: time-of-flight for FSR, distributed-loss equivalence for mirror loss, and an Airy-based finesse expression including internal loss.
        </p>
      </div>
    </section>

    <!-- PART 2 -->
    <section id="part2">
      <div class="inner">
        <h2>PART 2 â€” Strategy & Tips (Roadmap Only)</h2>

        <ol>
          <li>
            <strong>Compute facet reflectance</strong> <span class="muted">R</span>.
            <div class="small">Tool: Fresnel at normal incidence. Meaning: how much feedback the facets provide.</div>
          </li>
          <li>
            <strong>Compute FSR</strong> <span class="muted">Î”Î½_F</span>.
            <div class="small">Tool: round-trip time <span class="muted">Ï„=2nd/c</span>. Meaning: spacing between adjacent longitudinal modes.</div>
          </li>
          <li>
            <strong>Compute mirror loss as an equivalent distributed loss</strong> <span class="muted">Î±_m</span>.
            <div class="small">Tool: equate round-trip power transmission to <span class="muted">Râ‚Râ‚‚</span>. Meaning: convert facet leakage to cmâ»Â¹.</div>
          </li>
          <li>
            <strong>Combine losses</strong> to get <span class="muted">Î±_T = Î±_s + Î±_m</span>.
            <div class="small">Meaning: total per-length power loss inside the cavity.</div>
          </li>
          <li>
            <strong>Compute effective round-trip factor</strong> <span class="muted">A=Râ‚Râ‚‚ e^{-2Î±_s d}</span>.
            <div class="small">Meaning: how much power remains after one round trip (excluding phase).</div>
          </li>
          <li>
            <strong>Compute finesse</strong> <span class="muted">ğ“•</span>.
            <div class="small">Tool: generalized Fabryâ€“Perot formula using <span class="muted">A</span>. Meaning: sharpness of resonances.</div>
          </li>
          <li>
            <strong>Compute linewidth</strong> <span class="muted">Î´Î½</span> and <strong>quality factor</strong> <span class="muted">Q</span>.
            <div class="small">Tools: <span class="muted">Î´Î½=Î”Î½_F/ğ“•</span>, <span class="muted">Q=Î½â‚€/Î´Î½</span>.</div>
          </li>
          <li>
            <strong>Compute longitudinal mode number</strong> <span class="muted">q</span>.
            <div class="small">Tool: phase condition <span class="muted">q=2nd/Î»â‚€</span>.</div>
          </li>
        </ol>

        <div class="grid2">
          <div class="callout">
            <div class="tag">Common mistakes</div>
            <ul>
              <li>Forgetting that <span class="muted">d=0.2 mm = 0.02 cm</span> when using cmâ»Â¹.</li>
              <li>Using <span class="muted">Î±_s</span> as an amplitude loss instead of a <em>power</em> loss.</li>
              <li>Mixing up <span class="muted">R</span> (single facet) with <span class="muted">Râ‚Râ‚‚</span> (round trip).</li>
            </ul>
          </div>
          <div class="callout">
            <div class="tag">Quick tips</div>
            <ul>
              <li>Compute <span class="muted">R</span> first; it drives everything else.</li>
              <li>Expect <span class="muted">Î±_m</span> to be large for uncoated facets in high-index materials.</li>
              <li>Do a sanity check: if <span class="muted">Râ†’1</span> and <span class="muted">Î±_sâ†’0</span>, then <span class="muted">ğ“•â†’âˆ</span> and <span class="muted">Î´Î½â†’0</span>.</li>
            </ul>
          </div>
        </div>
      </div>
    </section>

    <!-- PART 3 -->
    <section id="part3">
      <div class="inner">
        <h2>PART 3 â€” Full Solution (Detailed + Teaching)</h2>

        <h3>Physical intuition first (before crunching numbers)</h3>
        <p>
          A high-index crystal facet in air reflects a surprisingly large fraction of light (tens of percent),
          so the two facets form a weak-to-moderate Fabryâ€“Perot cavity. Because the cavity is only <span class="muted">0.2 mm</span> long,
          the mode spacing should be in the <span class="muted">~100â€“300 GHz</span> range.
          But since <span class="muted">R</span> is not close to 1, the finesse should be only a few, giving linewidths comparable to the FSR divided by a small number.
        </p>

        <div class="callout">
          <div class="tag">Step 1 â€” Fresnel facet reflectance</div>
          <p>
            For normal incidence, the <strong>power reflectance</strong> at an interface between indices <span class="muted">n</span> (crystal) and <span class="muted">1</span> (air) is:
          </p>
          <div class="eq" data-copy="R = ((n - 1)/(n + 1))^2   (crystal â†” air, normal incidence)">
            <button class="copyBtn" type="button">Copy</button>
R = ((n - 1)/(n + 1))^2   (crystal â†” air, normal incidence)
          </div>
          <p class="muted">
            With <span class="muted">n=3.6</span>:
            <span class="muted">R = (2.6/4.6)Â² â‰ˆ 0.319</span>.
          </p>
        </div>

        <div class="callout">
          <div class="tag">Step 2 â€” Resonance spacing (FSR)</div>
          <p>
            The round-trip optical path length is <span class="muted">2nd</span>.
            The round-trip time is <span class="muted">Ï„ = 2nd / c</span>, so the frequency spacing between modes is:
          </p>
          <div class="eq" data-copy="Î”Î½F = 1/Ï„ = c/(2 n d)">
            <button class="copyBtn" type="button">Copy</button>
Î”Î½F = 1/Ï„ = c/(2 n d)
          </div>
          <p class="muted">
            Insert <span class="muted">d = 0.2 mm = 2.0Ã—10â»â´ m</span>, <span class="muted">n=3.6</span>:
            <br/>
            <span class="muted">Î”Î½F = 3.00Ã—10â¸ / (2Â·3.6Â·2.0Ã—10â»â´) = 2.083Ã—10Â¹Â¹ Hz â‰ˆ 208 GHz</span>.
          </p>
        </div>

        <div class="callout">
          <div class="tag">Step 3 â€” Mirror loss as a distributed loss coefficient</div>
          <p>
            Each round trip, the cavity loses power through the facets by a factor <span class="muted">Râ‚Râ‚‚</span> (because only <span class="muted">R</span> is reflected at each facet).
            A convenient laser-physics quantity is the <strong>equivalent distributed mirror loss</strong> <span class="muted">Î±_m</span> (units 1/length) defined by:
          </p>
          <div class="eq" data-copy="e^{-2 Î±m d} = R1 R2  â‡’  Î±m = (1/(2d)) ln(1/(R1 R2))">
            <button class="copyBtn" type="button">Copy</button>
e^{-2 Î±m d} = R1 R2  â‡’  Î±m = (1/(2d)) ln(1/(R1 R2))
          </div>
          <p class="muted">
            For identical facets <span class="muted">Râ‚=Râ‚‚=R</span>:
            <span class="muted">Î±m = (1/d) ln(1/R)</span>.
          </p>
          <p>
            Now use <span class="muted">d = 0.2 mm = 0.02 cm</span> and <span class="muted">Râ‰ˆ0.319</span>:
          </p>
          <div class="eq" data-copy="Î±m = (1/0.02 cm) ln(1/0.319) â‰ˆ 57.1 cm^-1">
            <button class="copyBtn" type="button">Copy</button>
Î±m = (1/0.02 cm) ln(1/0.319) â‰ˆ 57.1 cm^-1
          </div>
          <p class="muted">
            Interpretation: facet leakage dominates strongly over the given internal loss <span class="muted">Î±s=1 cmâ»Â¹</span>.
          </p>
        </div>

        <div class="callout">
          <div class="tag">Step 4 â€” Overall distributed loss</div>
          <p>
            The overall distributed loss coefficient is the sum of internal loss and mirror loss:
          </p>
          <div class="eq" data-copy="Î±T = Î±s + Î±m">
            <button class="copyBtn" type="button">Copy</button>
Î±T = Î±s + Î±m
          </div>
          <p class="muted">
            Numerically: <span class="muted">Î±T â‰ˆ 1 + 57.1 = 58.1 cmâ»Â¹</span>.
          </p>
        </div>

        <div class="callout">
          <div class="tag">Step 5 â€” Finesse including internal loss</div>
          <p>
            Internal loss reduces the effective feedback each round trip. Define the <strong>round-trip intensity factor</strong>:
          </p>
          <div class="eq" data-copy="A = R1 R2 e^{-2 Î±s d}   (power factor per round trip, excluding phase)">
            <button class="copyBtn" type="button">Copy</button>
A = R1 R2 e^{-2 Î±s d}   (power factor per round trip, excluding phase)
          </div>
          <p>
            A generalized finesse expression that reduces to the usual <span class="muted">ğ“• = Ï€âˆšR/(1âˆ’R)</span> when <span class="muted">Î±sâ†’0</span> is:
          </p>
          <div class="eq" data-copy="ğ“• = Ï€ A^{1/4} / (1 - A^{1/2})   (symmetric FP, internal power loss Î±s)">
            <button class="copyBtn" type="button">Copy</button>
ğ“• = Ï€ A^{1/4} / (1 - A^{1/2})   (symmetric FP, internal power loss Î±s)
          </div>
          <p class="muted">
            Here <span class="muted">d=0.02 cm</span>, <span class="muted">Î±s=1 cmâ»Â¹</span> so <span class="muted">e^{-2Î±s d}=e^{-0.04}=0.9608</span>.
            With <span class="muted">Râ‰ˆ0.319</span>, we have <span class="muted">A = RÂ² e^{-2Î±s d} â‰ˆ 0.1018Ã—0.9608 â‰ˆ 0.0978</span>.
            Then <span class="muted">A^{1/2}â‰ˆ0.3127</span> and <span class="muted">A^{1/4}â‰ˆ0.5592</span>, giving:
            <span class="muted">ğ“• â‰ˆ Ï€Â·0.5592/(1âˆ’0.3127) â‰ˆ 2.56</span>.
          </p>
        </div>

        <div class="callout">
          <div class="tag">Step 6 â€” Mode linewidth and quality factor</div>
          <p>
            By definition of finesse, the approximate full-width-at-half-maximum (FWHM) linewidth is:
          </p>
          <div class="eq" data-copy="Î´Î½ = Î”Î½F / ğ“•">
            <button class="copyBtn" type="button">Copy</button>
Î´Î½ = Î”Î½F / ğ“•
          </div>
          <p class="muted">
            Using <span class="muted">Î”Î½F â‰ˆ 2.083Ã—10Â¹Â¹ Hz</span> and <span class="muted">ğ“• â‰ˆ 2.56</span>:
            <span class="muted">Î´Î½ â‰ˆ 8.14Ã—10Â¹â° Hz â‰ˆ 81.4 GHz</span>.
          </p>

          <p>
            The optical frequency at <span class="muted">Î»â‚€</span> is <span class="muted">Î½â‚€ = c/Î»â‚€</span>, and the cavity quality factor is:
          </p>
          <div class="eq" data-copy="Î½0 = c/Î»0 ,   Q = Î½0/Î´Î½">
            <button class="copyBtn" type="button">Copy</button>
Î½0 = c/Î»0 ,   Q = Î½0/Î´Î½
          </div>
          <p class="muted">
            With <span class="muted">Î»â‚€=1.55 Î¼m</span>, <span class="muted">Î½â‚€ â‰ˆ 1.935Ã—10Â¹â´ Hz</span>.
            Therefore <span class="muted">Q â‰ˆ 1.935Ã—10Â¹â´ / 8.14Ã—10Â¹â° â‰ˆ 2.38Ã—10Â³</span>.
          </p>
        </div>

        <div class="callout">
          <div class="tag">Step 7 â€” Longitudinal mode number q</div>
          <p>
            Resonances satisfy <span class="muted">2nd = qÎ»â‚€</span> (equivalently, <span class="muted">q</span> half-wavelengths in the medium fit in length <span class="muted">d</span>).
            Thus:
          </p>
          <div class="eq" data-copy="q = 2 n d / Î»0">
            <button class="copyBtn" type="button">Copy</button>
q = 2 n d / Î»0
          </div>
          <p class="muted">
            Using <span class="muted">d=0.2 mm = 200 Î¼m</span>, <span class="muted">n=3.6</span>, <span class="muted">Î»â‚€=1.55 Î¼m</span>:
            <span class="muted">q = 2Â·3.6Â·200/1.55 â‰ˆ 929</span>.
          </p>
        </div>

        <div class="resultBox">
          <h3>Final Numerical Answers (Given Parameters)</h3>
          <div class="eq" data-copy="R â‰ˆ 0.319
Î”Î½F â‰ˆ 2.083Ã—10^11 Hz (â‰ˆ 208 GHz)
Î±m â‰ˆ 57.1 cm^-1
Î±T = Î±s + Î±m â‰ˆ 58.1 cm^-1
A = R^2 e^{-2Î±s d} â‰ˆ 0.0978
ğ“• â‰ˆ 2.56
Î´Î½ = Î”Î½F/ğ“• â‰ˆ 8.14Ã—10^10 Hz (â‰ˆ 81.4 GHz)
Î½0 = c/Î»0 â‰ˆ 1.935Ã—10^14 Hz
Q = Î½0/Î´Î½ â‰ˆ 2.38Ã—10^3
q â‰ˆ 929">
            <button class="copyBtn" type="button">Copy</button>
R â‰ˆ 0.319
Î”Î½F â‰ˆ 2.083Ã—10^11 Hz (â‰ˆ 208 GHz)
Î±m â‰ˆ 57.1 cm^-1
Î±T = Î±s + Î±m â‰ˆ 58.1 cm^-1
A = R^2 e^{-2Î±s d} â‰ˆ 0.0978
ğ“• â‰ˆ 2.56
Î´Î½ = Î”Î½F/ğ“• â‰ˆ 8.14Ã—10^10 Hz (â‰ˆ 81.4 GHz)
Î½0 = c/Î»0 â‰ˆ 1.935Ã—10^14 Hz
Q = Î½0/Î´Î½ â‰ˆ 2.38Ã—10^3
q â‰ˆ 929
          </div>

          <div class="kpi" id="kpi">
            <div class="row"><div class="name">Facet reflectance R</div><div class="val" id="kR">â€”</div></div>
            <div class="row"><div class="name">FSR Î”Î½F</div><div class="val" id="kFSR">â€”</div></div>
            <div class="row"><div class="name">Mirror loss Î±m</div><div class="val" id="kAm">â€”</div></div>
            <div class="row"><div class="name">Total loss Î±T</div><div class="val" id="kAT">â€”</div></div>
            <div class="row"><div class="name">Finesse ğ“•</div><div class="val" id="kFin">â€”</div></div>
            <div class="row"><div class="name">Linewidth Î´Î½</div><div class="val" id="kLW">â€”</div></div>
            <div class="row"><div class="name">Quality factor Q</div><div class="val" id="kQ">â€”</div></div>
            <div class="row"><div class="name">Mode number q</div><div class="val" id="kq">â€”</div></div>
          </div>
        </div>

        <div class="callout">
          <div class="tag">Sanity checks</div>
          <ul>
            <li><strong>Units:</strong> <span class="muted">Î”Î½F</span> is in Hz; <span class="muted">Î±</span> in cmâ»Â¹; <span class="muted">Q</span> is dimensionless.</li>
            <li><strong>Limiting case:</strong> If <span class="muted">Râ†’1</span>, then <span class="muted">Î±mâ†’0</span> and <span class="muted">ğ“•â†’âˆ</span>, so <span class="muted">Î´Î½â†’0</span>.</li>
            <li><strong>Physical meaning:</strong> Here, modest <span class="muted">Râ‰ˆ0.32</span> means substantial leakage, so the cavity resonances are relatively broad (finesse only ~2.6).</li>
          </ul>
        </div>

        <p class="muted">
          Connection to the diagram and plots: the cavity is just the crystal segment of length <span class="muted">d</span>.
          The spectral peaks in the plot occur whenever the phase condition <span class="muted">2nd = qÎ»â‚€</span> is met; their spacing is the FSR.
          Loss (internal <span class="muted">Î±s</span> and mirror leakage via <span class="muted">R</span>) sets the peak width.
        </p>
      </div>

      <figure>
        <div class="grid2">
          <div class="canvasWrap">
            <div class="canvasTitle">Main plot: Fabryâ€“Perot transmission vs frequency</div>
            <canvas id="plot1" aria-label="Transmission spectrum plot"></canvas>
          </div>
          <div class="canvasWrap">
            <div class="canvasTitle">Secondary plot: FSR & linewidth vs cavity length</div>
            <canvas id="plot2" aria-label="Parameter sweep plot"></canvas>
          </div>
        </div>

        <div class="controls" aria-label="Interactive controls">
          <div class="ctrl">
            <label>
              <span>Cavity length d (mm)</span>
              <span class="readout" id="rd">â€”</span>
            </label>
            <input id="sd" type="range" min="0.05" max="1.00" step="0.01" value="0.20" />
            <div class="small">Changes FSR and mode number strongly: <span class="muted">Î”Î½F âˆ 1/d</span>, <span class="muted">q âˆ d</span>.</div>
          </div>
          <div class="ctrl">
            <label>
              <span>Index n (unitless)</span>
              <span class="readout" id="rn">â€”</span>
            </label>
            <input id="sn" type="range" min="1.50" max="4.20" step="0.01" value="3.60" />
            <div class="small">Changes both Fresnel R and FSR: higher <span class="muted">n</span> â†’ larger <span class="muted">R</span> and smaller <span class="muted">Î”Î½F</span>.</div>
          </div>
          <div class="ctrl">
            <label>
              <span>Internal loss Î±<sub>s</sub> (cmâ»Â¹)</span>
              <span class="readout" id="ra">â€”</span>
            </label>
            <input id="sa" type="range" min="0.0" max="10.0" step="0.1" value="1.0" />
            <div class="small">Broader peaks and lower finesse when <span class="muted">Î±s</span> increases.</div>
          </div>
          <div class="ctrl">
            <label>
              <span>Wavelength Î»â‚€ (Î¼m)</span>
              <span class="readout" id="rl">â€”</span>
            </label>
            <input id="sl" type="range" min="0.80" max="2.20" step="0.01" value="1.55" />
            <div class="small">Changes optical frequency <span class="muted">Î½â‚€=c/Î»â‚€</span> and mode number <span class="muted">q</span>.</div>
          </div>
        </div>

        <div class="noteRow">
          <div class="pill">Model: symmetric facets (Râ‚=Râ‚‚=R), normal incidence, nâ‰ˆn<sub>g</sub></div>
          <div class="pill">Plots use normalized Airy-like transmission with internal loss via A = RÂ²e<sup>-2Î±s d</sup></div>
        </div>
      </figure>
    </section>

    <!-- PART 4 -->
    <section id="part4">
      <div class="inner">
        <h2>PART 4 â€” Deeper Understanding (Theory Around the Result)</h2>

        <h3>Re-interpreting the key formulas</h3>
        <div class="grid2">
          <div class="callout">
            <div class="tag">What controls FSR?</div>
            <p>
              <span class="muted">Î”Î½F = c/(2nd)</span> depends only on the optical round-trip time.
              Bigger <span class="muted">n</span> or bigger <span class="muted">d</span> â†’ slower round trip â†’ smaller FSR.
            </p>
          </div>
          <div class="callout">
            <div class="tag">What controls linewidth?</div>
            <p>
              Linewidth <span class="muted">Î´Î½</span> is set by how quickly energy leaks out each cycle.
              Lower effective feedback (smaller <span class="muted">R</span> or larger <span class="muted">Î±s</span>) â†’ smaller finesse â†’ broader peaks.
            </p>
          </div>
        </div>

        <h3>Parameter effects (connect to interactive plots)</h3>
        <ul>
          <li><strong>Increase d:</strong> FSR decreases (<span class="muted">1/d</span>), and mode number increases (<span class="muted">âˆ d</span>). In the sweep plot, both FSR and linewidth in GHz generally drop with increasing <span class="muted">d</span> (because FSR drops; finesse changes more gently).</li>
          <li><strong>Increase n:</strong> FSR decreases, but facet reflectance increasesâ€”often raising finesse and lowering linewidth.</li>
          <li><strong>Increase Î±<sub>s</sub>:</strong> effective round-trip factor <span class="muted">A</span> falls, so peaks broaden and finesse decreases.</li>
          <li><strong>Change Î»â‚€:</strong> doesnâ€™t affect FSR (in this simple model), but changes <span class="muted">Î½â‚€</span> and thus <span class="muted">Q</span> and <span class="muted">q</span>.</li>
        </ul>

        <h3>Alternative derivation idea (brief)</h3>
        <p class="muted">
          Instead of using finesse, you can estimate <span class="muted">Q</span> from an energy-decay time:
          treat the intracavity power after each round trip as multiplied by <span class="muted">A</span>.
          Converting that discrete decay to an exponential gives a photon lifetime, and then <span class="muted">Q â‰ˆ 2Ï€Î½â‚€ Ï„_ph</span>.
          It leads to the same scaling: more loss â†’ smaller <span class="muted">Ï„_ph</span> â†’ smaller <span class="muted">Q</span>.
        </p>

        <h3>Concept checks (quick self-test)</h3>
        <ul>
          <li><strong>Q:</strong> If you double <span class="muted">d</span>, what happens to FSR? <em>It halves.</em></li>
          <li><strong>Q:</strong> If <span class="muted">R</span> increases while <span class="muted">Î±s</span> stays fixed, what happens to linewidth? <em>It decreases (finesse increases).</em></li>
          <li><strong>Q:</strong> Why is mirror loss often dominant here? <em>Because uncoated facets with moderate R leak a large fraction each bounce, equivalent to a large cmâ»Â¹ loss.</em></li>
          <li><strong>Q:</strong> What would you replace <span class="muted">n</span> with for a more accurate FSR in dispersive media? <em>Use the group index <span class="muted">n<sub>g</sub></span>.</em></li>
        </ul>
      </div>
    </section>

    <!-- PART 5 -->
    <section id="part5">
      <div class="inner">
        <h2>PART 5 â€” Visualization Guide (How to Read the Plots)</h2>

        <h3>Canvas 1: Diagram</h3>
        <ul>
          <li>Shows a crystal slab of length <span class="muted">d</span> between two facets in air.</li>
          <li>Facet reflectance <span class="muted">R</span> is computed from <span class="muted">n</span> via Fresnel reflection at normal incidence.</li>
          <li>Internal loss <span class="muted">Î±<sub>s</sub></span> is indicated along the propagation direction.</li>
        </ul>

        <h3>Canvas 2: Main plot (Transmission spectrum)</h3>
        <ul>
          <li><strong>x-axis:</strong> frequency offset (GHz) across a few FSRs.</li>
          <li><strong>y-axis:</strong> normalized transmission (Airy-like). Peaks occur at resonances.</li>
          <li><strong>FSR:</strong> the spacing between adjacent peaks is <span class="muted">Î”Î½<sub>F</sub></span>.</li>
          <li><strong>Linewidth:</strong> broader peaks correspond to smaller finesse.</li>
        </ul>

        <h3>Canvas 3: Secondary plot (Parameter sweep)</h3>
        <ul>
          <li>Sweeps cavity length <span class="muted">d</span> and plots <span class="muted">Î”Î½<sub>F</sub></span> and <span class="muted">Î´Î½</span> (both in GHz).</li>
          <li>Helps you see the scaling: both decrease roughly as <span class="muted">1/d</span> when finesse is not changing dramatically.</li>
        </ul>

        <h3>Interactive controls</h3>
        <ul>
          <li><strong>d slider:</strong> changes geometry; updates FSR, linewidth, and the sweep marker.</li>
          <li><strong>n slider:</strong> changes Fresnel reflectance and phase velocity; affects both peak sharpness and FSR.</li>
          <li><strong>Î±<sub>s</sub> slider:</strong> increases internal attenuation; broadens peaks and reduces finesse.</li>
          <li><strong>Î»â‚€ slider:</strong> changes <span class="muted">Î½â‚€</span>, and thus <span class="muted">Q</span> and <span class="muted">q</span>.</li>
        </ul>

        <div class="callout">
          <div class="tag">Consistency note</div>
          <p class="muted">
            The same symbols and numerical values shown in the text (R, d, n, Î±<sub>s</sub>, Î»â‚€) are exactly what drive the computed KPIs and the plotted curves.
          </p>
        </div>
      </div>
    </section>
  </article>
</main>

<footer>
  Built with vanilla HTML/CSS/JS. Interactive plots are rendered on &lt;canvas&gt; with high-DPI handling and responsive resizing.
</footer>

<script>
/* -------------------------- Utilities -------------------------- */
function fmtSI(x, unit="", sig=3){
  if (!isFinite(x)) return "â€”";
  const ax = Math.abs(x);
  const prefixes = [
    {p:1e-24,s:"y"},{p:1e-21,s:"z"},{p:1e-18,s:"a"},{p:1e-15,s:"f"},
    {p:1e-12,s:"p"},{p:1e-9,s:"n"},{p:1e-6,s:"Âµ"},{p:1e-3,s:"m"},
    {p:1,s:""},{p:1e3,s:"k"},{p:1e6,s:"M"},{p:1e9,s:"G"},
    {p:1e12,s:"T"},{p:1e15,s:"P"},{p:1e18,s:"E"},{p:1e21,s:"Z"},{p:1e24,s:"Y"},
  ];
  let pref = prefixes[8];
  for (let i=0;i<prefixes.length;i++){
    if (ax >= prefixes[i].p && ax < (prefixes[i+1]?.p ?? Infinity)){ pref = prefixes[i]; break; }
  }
  const v = x / pref.p;
  const s = Number(v.toPrecision(sig)).toString();
  return `${s} ${pref.s}${unit}`.trim();
}
function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
function lerp(a,b,t){ return a + (b-a)*t; }

function niceTicks(min, max, target=6){
  if (!(isFinite(min)&&isFinite(max)) || max===min) return {min, max, step:1, ticks:[min]};
  const span = Math.abs(max-min);
  const raw = span / Math.max(1,target);
  const pow10 = Math.pow(10, Math.floor(Math.log10(raw)));
  const candidates = [1,2,2.5,5,10].map(m=>m*pow10);
  let step = candidates[0], best = Infinity;
  for (const c of candidates){
    const n = span/c;
    const diff = Math.abs(n-target);
    if (diff < best){ best=diff; step=c; }
  }
  const lo = Math.floor(min/step)*step;
  const hi = Math.ceil(max/step)*step;
  const ticks=[];
  for (let v=lo; v<=hi+0.5*step; v+=step) ticks.push(v);
  return {min:lo, max:hi, step, ticks};
}

/* -------------------------- Copy buttons -------------------------- */
function setupCopyButtons(){
  document.querySelectorAll(".eq").forEach(eq=>{
    const btn = eq.querySelector(".copyBtn");
    if(!btn) return;
    btn.addEventListener("click", async ()=>{
      const text = eq.getAttribute("data-copy") || eq.innerText.trim();
      try{
        await navigator.clipboard.writeText(text);
        eq.classList.add("copied");
        btn.textContent="Copied";
        setTimeout(()=>{ eq.classList.remove("copied"); btn.textContent="Copy"; }, 900);
      }catch(e){
        btn.textContent="Copy failed";
        setTimeout(()=>{ btn.textContent="Copy"; }, 900);
      }
    });
  });
}

/* -------------------------- Physics model -------------------------- */
const C = 299792458; // m/s

function computeAll(params){
  const n = params.n;
  const d_mm = params.d_mm;
  const alpha_cm = params.alpha_cm;
  const lambda_um = params.lambda_um;

  const d_m = d_mm * 1e-3;
  const d_cm = d_mm * 0.1;  // 1 mm = 0.1 cm
  const lambda_m = lambda_um * 1e-6;

  // Fresnel power reflectance (crystal-air)
  const R = Math.pow((n - 1)/(n + 1), 2);

  // FSR (Hz)
  const FSR = C / (2 * n * d_m);

  // Mirror loss coefficient Î±m (cm^-1): Î±m=(1/(2d)) ln(1/(R1R2)) with d in cm
  const alpha_m = (1/(2*d_cm)) * Math.log(1/(R*R)); // symmetric
  const alpha_T = alpha_cm + alpha_m;

  // Round-trip intensity factor including internal loss
  const A = (R*R) * Math.exp(-2 * alpha_cm * d_cm);

  // Finesse including internal loss (symmetric generalized)
  const sqrtA = Math.sqrt(A);
  const fourthA = Math.sqrt(sqrtA);
  const finesse = Math.PI * fourthA / Math.max(1e-12, (1 - sqrtA));

  // linewidth (Hz)
  const dnu = FSR / finesse;

  // optical frequency
  const nu0 = C / lambda_m;
  const Q = nu0 / dnu;

  // longitudinal mode number q
  const q = (2 * n * d_m) / lambda_m;

  // Airy-like transmission coefficient using effective "reflectivity" sqrtA
  // Standard: T = 1 / (1 + F * sin^2(Î´/2)), with F = 4R/(1-R)^2.
  // Here use R_eff = sqrtA (since for lossless symmetric A=R^2 -> sqrtA=R)
  const R_eff = sqrtA;
  const Fcoef = (4 * R_eff) / Math.pow(Math.max(1e-12, (1 - R_eff)), 2);

  return {n,d_mm,d_m,d_cm,alpha_cm,lambda_um,lambda_m,R,FSR,alpha_m,alpha_T,A,finesse,dnu,nu0,Q,q,R_eff,Fcoef};
}

function airyTransmission(deltaPhase, Fcoef){
  // deltaPhase is total round-trip phase detuning from resonance (radians)
  const s = Math.sin(deltaPhase/2);
  return 1 / (1 + Fcoef * s*s);
}

/* -------------------------- Canvas rendering (HiDPI) -------------------------- */
function prepareCanvas(canvas){
  const ctx = canvas.getContext("2d");
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(320, rect.width);
    const h = rect.height;
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
    return {w, h, dpr};
  }
  return {ctx, resize};
}

function drawAxes(ctx, box, xTicks, yTicks, labels){
  const {x,y,w,h} = box;
  // grid
  ctx.save();
  ctx.strokeStyle = "rgba(255,255,255,0.10)";
  ctx.lineWidth = 1;

  // vertical grid
  for (const t of xTicks.ticks){
    const px = x + (t - xTicks.min) / (xTicks.max - xTicks.min) * w;
    ctx.beginPath(); ctx.moveTo(px, y); ctx.lineTo(px, y+h); ctx.stroke();
  }
  // horizontal grid
  for (const t of yTicks.ticks){
    const py = y + (1 - (t - yTicks.min) / (yTicks.max - yTicks.min)) * h;
    ctx.beginPath(); ctx.moveTo(x, py); ctx.lineTo(x+w, py); ctx.stroke();
  }

  // axes lines
  ctx.strokeStyle = "rgba(255,255,255,0.25)";
  ctx.beginPath(); ctx.rect(x,y,w,h); ctx.stroke();

  // ticks + labels
  ctx.fillStyle = "rgba(234,240,255,0.92)";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  ctx.textAlign = "center";
  ctx.textBaseline = "top";
  for (const t of xTicks.ticks){
    const px = x + (t - xTicks.min) / (xTicks.max - xTicks.min) * w;
    ctx.strokeStyle = "rgba(255,255,255,0.35)";
    ctx.beginPath(); ctx.moveTo(px, y+h); ctx.lineTo(px, y+h+6); ctx.stroke();
    ctx.fillText(String(Number(t.toPrecision(3))), px, y+h+8);
  }
  ctx.textAlign="right";
  ctx.textBaseline="middle";
  for (const t of yTicks.ticks){
    const py = y + (1 - (t - yTicks.min) / (yTicks.max - yTicks.min)) * h;
    ctx.strokeStyle = "rgba(255,255,255,0.35)";
    ctx.beginPath(); ctx.moveTo(x-6, py); ctx.lineTo(x, py); ctx.stroke();
    ctx.fillText(String(Number(t.toPrecision(3))), x-8, py);
  }

  // labels
  ctx.fillStyle = "rgba(185,197,255,0.95)";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="center";
  ctx.textBaseline="top";
  ctx.fillText(labels.x, x + w/2, y + h + 34);

  ctx.save();
  ctx.translate(x - 44, y + h/2);
  ctx.rotate(-Math.PI/2);
  ctx.textAlign="center";
  ctx.textBaseline="top";
  ctx.fillText(labels.y, 0, 0);
  ctx.restore();

  // title
  ctx.fillStyle = "rgba(234,240,255,0.95)";
  ctx.font = "13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="left";
  ctx.textBaseline="top";
  ctx.fillText(labels.title, x, y - 24);

  ctx.restore();
}

/* -------------------------- Diagram -------------------------- */
function renderDiagram(canvasPack, model){
  const {ctx, resize} = canvasPack;
  const {w,h} = resize();
  ctx.clearRect(0,0,w,h);

  // background subtle
  const grad = ctx.createLinearGradient(0,0,0,h);
  grad.addColorStop(0,"rgba(122,166,255,0.08)");
  grad.addColorStop(1,"rgba(0,0,0,0)");
  ctx.fillStyle = grad;
  ctx.fillRect(0,0,w,h);

  // Draw slab
  const pad = 22;
  const slabX = pad + 40;
  const slabY = 70;
  const slabW = w - slabX - pad - 20;
  const slabH = h - slabY - 80;

  ctx.fillStyle = "rgba(122,166,255,0.10)";
  ctx.strokeStyle = "rgba(255,255,255,0.18)";
  ctx.lineWidth = 2;
  roundRect(ctx, slabX, slabY, slabW, slabH, 18, true, true);

  // Facets
  ctx.strokeStyle = "rgba(255,255,255,0.35)";
  ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(slabX, slabY); ctx.lineTo(slabX, slabY+slabH); ctx.stroke();
  ctx.beginPath(); ctx.moveTo(slabX+slabW, slabY); ctx.lineTo(slabX+slabW, slabY+slabH); ctx.stroke();

  // Rays (bounces)
  ctx.strokeStyle = "rgba(156,255,214,0.65)";
  ctx.lineWidth = 2;
  const y0 = slabY + slabH*0.25;
  const y1 = slabY + slabH*0.75;
  const xL = slabX + 8;
  const xR = slabX + slabW - 8;
  ctx.beginPath();
  ctx.moveTo(xL, y0);
  ctx.lineTo(xR, y1);
  ctx.lineTo(xL, y0+slabH*0.10);
  ctx.lineTo(xR, y1-slabH*0.10);
  ctx.stroke();

  // Arrow for propagation
  drawArrow(ctx, xL+20, y0+10, xR-30, y1-10, "rgba(156,255,214,0.85)");

  // Labels
  ctx.fillStyle = "rgba(234,240,255,0.95)";
  ctx.font = "13px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign = "left";
  ctx.textBaseline="top";

  ctx.fillText("Crystal (index n)", slabX+16, slabY+10);
  ctx.fillStyle = "rgba(185,197,255,0.95)";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.fillText(`n = ${model.n.toFixed(2)}`, slabX+16, slabY+30);

  ctx.fillStyle = "rgba(255,211,122,0.95)";
  ctx.fillText(`Î±s = ${model.alpha_cm.toFixed(2)} cmâ»Â¹`, slabX+16, slabY+48);

  // Outside air labels
  ctx.fillStyle = "rgba(185,197,255,0.9)";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="center";
  ctx.fillText("Air (n=1)", slabX-30, slabY+slabH/2-10);
  ctx.fillText("Air (n=1)", slabX+slabW+30, slabY+slabH/2-10);

  // R labels at facets
  ctx.fillStyle = "rgba(234,240,255,0.92)";
  ctx.textAlign="left";
  ctx.fillText(`Facet R â‰ˆ ${model.R.toFixed(3)}`, slabX+10, slabY+slabH+10);
  ctx.fillText(`Facet R â‰ˆ ${model.R.toFixed(3)}`, slabX+slabW-140, slabY+slabH+10);

  // d label with bracket
  ctx.strokeStyle = "rgba(255,255,255,0.35)";
  ctx.lineWidth = 2;
  const yB = slabY-20;
  ctx.beginPath();
  ctx.moveTo(slabX, yB);
  ctx.lineTo(slabX, yB+10);
  ctx.moveTo(slabX+slabW, yB);
  ctx.lineTo(slabX+slabW, yB+10);
  ctx.moveTo(slabX, yB);
  ctx.lineTo(slabX+slabW, yB);
  ctx.stroke();
  ctx.fillStyle = "rgba(234,240,255,0.95)";
  ctx.textAlign="center";
  ctx.fillText(`d = ${model.d_mm.toFixed(2)} mm`, slabX+slabW/2, yB-2);

  // Small note
  ctx.fillStyle = "rgba(185,197,255,0.90)";
  ctx.textAlign="left";
  ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, 'Liberation Mono', 'Courier New', monospace";
  ctx.fillText("Resonance: 2 n d = q Î»0", pad, h-28);
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr,y);
  ctx.arcTo(x+w,y,x+w,y+h,rr);
  ctx.arcTo(x+w,y+h,x,y+h,rr);
  ctx.arcTo(x,y+h,x,y,rr);
  ctx.arcTo(x,y,x+w,y,rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}
function drawArrow(ctx, x1,y1,x2,y2, color){
  const head = 10;
  const ang = Math.atan2(y2-y1, x2-x1);
  ctx.save();
  ctx.strokeStyle = color;
  ctx.fillStyle = color;
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(x1,y1);
  ctx.lineTo(x2,y2);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(x2,y2);
  ctx.lineTo(x2 - head*Math.cos(ang - 0.45), y2 - head*Math.sin(ang - 0.45));
  ctx.lineTo(x2 - head*Math.cos(ang + 0.45), y2 - head*Math.sin(ang + 0.45));
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

/* -------------------------- Plot 1: Transmission spectrum -------------------------- */
function renderPlot1(canvasPack, model){
  const {ctx, resize} = canvasPack;
  const {w,h} = resize();
  ctx.clearRect(0,0,w,h);

  const margin = {l:62, r:20, t:44, b:58};
  const box = {x:margin.l, y:margin.t, w:w-margin.l-margin.r, h:h-margin.t-margin.b};

  // x range: show Â±2.5 FSR around center resonance
  const spanFSR = 2.5;
  const xMin = -spanFSR*model.FSR/1e9;
  const xMax =  spanFSR*model.FSR/1e9;

  // sample transmission
  const N = 1000;
  const xs = new Array(N);
  const ys = new Array(N);
  let yMax = 0;
  for(let i=0;i<N;i++){
    const xGHz = lerp(xMin,xMax,i/(N-1));
    const nu = xGHz*1e9;
    const deltaPhase = 2*Math.PI*(nu/model.FSR); // detuning relative to resonance
    const T = airyTransmission(deltaPhase, model.Fcoef);
    xs[i]=xGHz;
    ys[i]=T;
    if(T>yMax) yMax=T;
  }
  const yMin = 0;
  const yMaxPlot = Math.max(1.05, yMax*1.05);

  const xTicks = niceTicks(xMin, xMax, 6);
  const yTicks = niceTicks(yMin, yMaxPlot, 5);

  drawAxes(ctx, box, xTicks, yTicks, {
    title: "Normalized transmission spectrum (Airy-like)",
    x: "Frequency offset from resonance (GHz)",
    y: "Normalized transmission (arb.)"
  });

  // plot curve
  ctx.save();
  ctx.beginPath();
  for(let i=0;i<N;i++){
    const px = box.x + (xs[i]-xTicks.min)/(xTicks.max-xTicks.min)*box.w;
    const py = box.y + (1-(ys[i]-yTicks.min)/(yTicks.max-yTicks.min))*box.h;
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.strokeStyle = "rgba(156,255,214,0.85)";
  ctx.lineWidth = 2;
  ctx.stroke();

  // annotate FSR and linewidth
  const fsrGHz = model.FSR/1e9;
  const lwGHz = model.dnu/1e9;

  // resonance markers
  ctx.strokeStyle = "rgba(255,255,255,0.22)";
  ctx.lineWidth = 1.5;
  for(let k=-2;k<=2;k++){
    const xk = k*fsrGHz;
    if(xk < xTicks.min || xk > xTicks.max) continue;
    const px = box.x + (xk-xTicks.min)/(xTicks.max-xTicks.min)*box.w;
    ctx.beginPath(); ctx.moveTo(px, box.y); ctx.lineTo(px, box.y+box.h); ctx.stroke();
  }

  // linewidth bar near center peak
  const yBar = box.y + box.h*0.18;
  const xL = -lwGHz/2, xR = lwGHz/2;
  const pxL = box.x + (xL-xTicks.min)/(xTicks.max-xTicks.min)*box.w;
  const pxR = box.x + (xR-xTicks.min)/(xTicks.max-xTicks.min)*box.w;

  ctx.strokeStyle = "rgba(255,211,122,0.95)";
  ctx.lineWidth = 3;
  ctx.beginPath(); ctx.moveTo(pxL, yBar); ctx.lineTo(pxR, yBar); ctx.stroke();
  ctx.fillStyle = "rgba(255,211,122,0.95)";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="center";
  ctx.textBaseline="bottom";
  ctx.fillText(`Î´Î½ â‰ˆ ${lwGHz.toFixed(1)} GHz`, (pxL+pxR)/2, yBar-6);

  // legend
  ctx.fillStyle = "rgba(234,240,255,0.92)";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="left";
  ctx.textBaseline="top";
  ctx.fillText(`FSR â‰ˆ ${fsrGHz.toFixed(1)} GHz   |   finesse ğ“• â‰ˆ ${model.finesse.toFixed(2)}`, box.x+4, box.y+4);

  ctx.restore();
}

/* -------------------------- Plot 2: Sweep vs d -------------------------- */
function renderPlot2(canvasPack, model){
  const {ctx, resize} = canvasPack;
  const {w,h} = resize();
  ctx.clearRect(0,0,w,h);

  const margin = {l:62, r:20, t:44, b:58};
  const box = {x:margin.l, y:margin.t, w:w-margin.l-margin.r, h:h-margin.t-margin.b};

  // Sweep d from 0.05 mm to 1.0 mm using current n and alpha and lambda
  const dMin = 0.05, dMax = 1.0;
  const N = 260;
  const xs = [];
  const fsr = [];
  const lw = [];
  let yMax=0;
  for(let i=0;i<N;i++){
    const dmm = lerp(dMin, dMax, i/(N-1));
    const m = computeAll({d_mm:dmm, n:model.n, alpha_cm:model.alpha_cm, lambda_um:model.lambda_um});
    const fsrGHz = m.FSR/1e9;
    const lwGHz = m.dnu/1e9;
    xs.push(dmm);
    fsr.push(fsrGHz);
    lw.push(lwGHz);
    yMax = Math.max(yMax, fsrGHz, lwGHz);
  }
  const yMin=0;
  const yMaxPlot = yMax*1.08;

  const xTicks = niceTicks(dMin, dMax, 6);
  const yTicks = niceTicks(yMin, yMaxPlot, 5);

  drawAxes(ctx, box, xTicks, yTicks, {
    title: "Length sweep: FSR and linewidth vs d",
    x: "Cavity length d (mm)",
    y: "Frequency (GHz)"
  });

  // plot FSR curve
  ctx.save();
  ctx.lineWidth=2;

  ctx.beginPath();
  for(let i=0;i<N;i++){
    const px = box.x + (xs[i]-xTicks.min)/(xTicks.max-xTicks.min)*box.w;
    const py = box.y + (1-(fsr[i]-yTicks.min)/(yTicks.max-yTicks.min))*box.h;
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.strokeStyle = "rgba(122,166,255,0.90)";
  ctx.stroke();

  // plot linewidth curve
  ctx.beginPath();
  for(let i=0;i<N;i++){
    const px = box.x + (xs[i]-xTicks.min)/(xTicks.max-xTicks.min)*box.w;
    const py = box.y + (1-(lw[i]-yTicks.min)/(yTicks.max-yTicks.min))*box.h;
    if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
  }
  ctx.strokeStyle = "rgba(255,211,122,0.95)";
  ctx.stroke();

  // marker at current d
  const dNow = model.d_mm;
  const fsrNow = model.FSR/1e9;
  const lwNow = model.dnu/1e9;

  const pxNow = box.x + (dNow-xTicks.min)/(xTicks.max-xTicks.min)*box.w;

  // vertical marker
  ctx.strokeStyle = "rgba(255,255,255,0.25)";
  ctx.lineWidth = 1.5;
  ctx.beginPath(); ctx.moveTo(pxNow, box.y); ctx.lineTo(pxNow, box.y+box.h); ctx.stroke();

  // points
  function dot(x,y,color){
    ctx.fillStyle=color;
    ctx.beginPath(); ctx.arc(x,y,4.5,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle="rgba(0,0,0,0.35)";
    ctx.lineWidth=1;
    ctx.stroke();
  }
  const pyFSR = box.y + (1-(fsrNow-yTicks.min)/(yTicks.max-yTicks.min))*box.h;
  const pyLW  = box.y + (1-(lwNow-yTicks.min)/(yTicks.max-yTicks.min))*box.h;
  dot(pxNow, pyFSR, "rgba(122,166,255,0.95)");
  dot(pxNow, pyLW,  "rgba(255,211,122,0.98)");

  // legend
  ctx.fillStyle = "rgba(234,240,255,0.92)";
  ctx.font = "12px system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial";
  ctx.textAlign="left";
  ctx.textBaseline="top";
  ctx.fillText("FSR Î”Î½F", box.x+4, box.y+4);
  ctx.fillStyle="rgba(122,166,255,0.90)";
  ctx.fillRect(box.x+68, box.y+8, 18, 3);

  ctx.fillStyle="rgba(234,240,255,0.92)";
  ctx.fillText("Linewidth Î´Î½", box.x+4, box.y+22);
  ctx.fillStyle="rgba(255,211,122,0.95)";
  ctx.fillRect(box.x+95, box.y+26, 18, 3);

  ctx.restore();
}

/* -------------------------- UI + Wiring -------------------------- */
const canvases = {
  diag: prepareCanvas(document.getElementById("diag")),
  plot1: prepareCanvas(document.getElementById("plot1")),
  plot2: prepareCanvas(document.getElementById("plot2")),
};

const ui = {
  sd: document.getElementById("sd"),
  sn: document.getElementById("sn"),
  sa: document.getElementById("sa"),
  sl: document.getElementById("sl"),
  rd: document.getElementById("rd"),
  rn: document.getElementById("rn"),
  ra: document.getElementById("ra"),
  rl: document.getElementById("rl"),
  kR: document.getElementById("kR"),
  kFSR: document.getElementById("kFSR"),
  kAm: document.getElementById("kAm"),
  kAT: document.getElementById("kAT"),
  kFin: document.getElementById("kFin"),
  kLW: document.getElementById("kLW"),
  kQ: document.getElementById("kQ"),
  kq: document.getElementById("kq"),
};

function getParams(){
  return {
    d_mm: parseFloat(ui.sd.value),
    n: parseFloat(ui.sn.value),
    alpha_cm: parseFloat(ui.sa.value),
    lambda_um: parseFloat(ui.sl.value),
  };
}

function updateReadouts(model){
  ui.rd.textContent = model.d_mm.toFixed(2);
  ui.rn.textContent = model.n.toFixed(2);
  ui.ra.textContent = model.alpha_cm.toFixed(2);
  ui.rl.textContent = model.lambda_um.toFixed(2);

  ui.kR.textContent = model.R.toFixed(3);
  ui.kFSR.textContent = fmtSI(model.FSR, "Hz", 4) + `  (${(model.FSR/1e9).toFixed(1)} GHz)`;
  ui.kAm.textContent = `${model.alpha_m.toFixed(1)} cmâ»Â¹`;
  ui.kAT.textContent = `${model.alpha_T.toFixed(1)} cmâ»Â¹`;
  ui.kFin.textContent = model.finesse.toFixed(2);
  ui.kLW.textContent = fmtSI(model.dnu, "Hz", 4) + `  (${(model.dnu/1e9).toFixed(1)} GHz)`;
  ui.kQ.textContent = fmtSI(model.Q, "", 4);
  ui.kq.textContent = `${Math.round(model.q)}  (â‰ˆ ${model.q.toFixed(1)})`;
}

function renderAll(){
  const model = computeAll(getParams());
  updateReadouts(model);
  renderDiagram(canvases.diag, model);
  renderPlot1(canvases.plot1, model);
  renderPlot2(canvases.plot2, model);
}

function setupResize(){
  const ro = new ResizeObserver(()=>renderAll());
  ro.observe(document.getElementById("diag"));
  ro.observe(document.getElementById("plot1"));
  ro.observe(document.getElementById("plot2"));
  window.addEventListener("resize", ()=>renderAll(), {passive:true});
}

function setupControls(){
  [ui.sd, ui.sn, ui.sa, ui.sl].forEach(el=>{
    el.addEventListener("input", ()=>renderAll(), {passive:true});
  });
}

/* -------------------------- Smooth TOC scroll -------------------------- */
document.querySelectorAll('#toc a[href^="#"]').forEach(a=>{
  a.addEventListener("click", (e)=>{
    e.preventDefault();
    const id = a.getAttribute("href").slice(1);
    const target = document.getElementById(id);
    if(!target) return;
    target.scrollIntoView({behavior:"smooth", block:"start"});
  });
});

/* -------------------------- Init -------------------------- */
setupCopyButtons();
setupControls();
setupResize();
renderAll();
</script>
</body>
</html>
