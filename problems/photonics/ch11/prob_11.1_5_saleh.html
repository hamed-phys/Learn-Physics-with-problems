<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Fabryâ€“Perot Etalon with GaAs/AlAs Bragg (DBR) Reflectors â€” Finesse, Q, and Transmittance</title>
  <style>
    :root{
      --bg:#0b1020;
      --panel:#101a33;
      --card:#0f1830;
      --text:#e9eefc;
      --muted:#b8c3e6;
      --soft:#93a4d8;
      --accent:#7aa7ff;
      --accent2:#63e6be;
      --warn:#ffd166;
      --danger:#ff6b6b;
      --grid:rgba(255,255,255,.08);
      --border:rgba(255,255,255,.10);
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, "Helvetica Neue", Arial, "Noto Sans", "Liberation Sans", sans-serif;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 800px at 15% 10%, rgba(122,167,255,.18), transparent 60%),
        radial-gradient(900px 600px at 85% 20%, rgba(99,230,190,.12), transparent 55%),
        radial-gradient(800px 700px at 50% 100%, rgba(255,209,102,.08), transparent 55%),
        linear-gradient(180deg, #070a14 0%, #0b1020 45%, #070a14 100%);
      line-height:1.55;
    }
    header{
      padding:28px 18px 12px;
      max-width:1200px;
      margin:0 auto;
    }
    .hero{
      border:1px solid var(--border);
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      padding:22px 18px;
      overflow:hidden;
      position:relative;
    }
    .hero:before{
      content:"";
      position:absolute; inset:-2px;
      background: radial-gradient(800px 240px at 30% 0%, rgba(122,167,255,.25), transparent 60%),
                  radial-gradient(700px 240px at 80% 10%, rgba(99,230,190,.18), transparent 55%);
      filter: blur(0px);
      pointer-events:none;
      opacity:.8;
    }
    .hero > *{position:relative}
    h1{
      margin:0 0 8px;
      letter-spacing:.2px;
      font-size: clamp(1.4rem, 2.4vw, 2.15rem);
    }
    .subtitle{
      margin:0;
      color:var(--muted);
      font-size: clamp(.95rem, 1.6vw, 1.06rem);
      max-width: 80ch;
    }

    main{
      max-width:1200px;
      margin:16px auto 64px;
      padding:0 18px;
      display:grid;
      grid-template-columns: 320px 1fr;
      gap:16px;
      align-items:start;
    }
    @media (max-width: 980px){
      main{grid-template-columns:1fr}
    }

    nav.toc{
      position: sticky;
      top: 14px;
      align-self: start;
      border:1px solid var(--border);
      background: rgba(16,26,51,.72);
      backdrop-filter: blur(10px);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding:14px 14px 12px;
    }
    nav.toc h2{
      margin:0 0 10px;
      font-size:1rem;
      color:var(--text);
      letter-spacing:.2px;
    }
    nav.toc a{
      display:block;
      padding:8px 10px;
      border-radius: 12px;
      color: var(--muted);
      text-decoration:none;
      border:1px solid transparent;
      transition: transform .15s ease, background .15s ease, border-color .15s ease;
      font-size:.95rem;
    }
    nav.toc a:hover{
      background: rgba(255,255,255,.06);
      border-color: rgba(255,255,255,.10);
      transform: translateY(-1px);
      color: var(--text);
    }
    nav.toc .mini{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed rgba(255,255,255,.14);
      color:var(--soft);
      font-size:.9rem;
    }

    article{
      border:1px solid var(--border);
      background: rgba(16,26,51,.45);
      backdrop-filter: blur(10px);
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    section{
      padding: 18px 18px;
      border-top:1px solid rgba(255,255,255,.08);
    }
    section:first-child{border-top:none}
    h2{
      margin:0 0 10px;
      font-size: 1.2rem;
      letter-spacing:.15px;
    }
    h3{
      margin:14px 0 8px;
      font-size: 1.05rem;
      color: var(--text);
    }
    p{margin:10px 0;color:var(--text)}
    ul{margin:10px 0 0 20px; color:var(--muted)}
    li{margin:6px 0}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
    }
    @media (max-width: 900px){
      .grid2{grid-template-columns:1fr}
    }

    .callout{
      border:1px solid var(--border);
      background: rgba(15,24,48,.65);
      border-radius: var(--radius);
      padding:12px 12px;
      margin:12px 0;
    }
    .callout strong{color:var(--text)}
    .callout.assump{border-left:4px solid var(--warn)}
    .callout.keyeq{border-left:4px solid var(--accent)}
    .callout.mist{border-left:4px solid var(--danger)}
    .callout.final{border-left:4px solid var(--accent2)}
    .badge{
      display:inline-block;
      padding:3px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--muted);
      font-size:.82rem;
      margin-right:6px;
      vertical-align:middle;
    }
    .eqwrap{
      margin:10px 0;
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      background: rgba(0,0,0,.20);
      overflow:hidden;
    }
    .eqbar{
      display:flex;
      justify-content:space-between;
      align-items:center;
      gap:10px;
      padding:10px 10px;
      border-bottom:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .eqtitle{
      font-size:.9rem;
      color: var(--muted);
      display:flex;
      align-items:center;
      gap:8px;
      flex-wrap:wrap;
    }
    pre.eq{
      margin:0;
      padding:12px 12px;
      color: var(--text);
      font-family: var(--mono);
      font-size:.92rem;
      white-space: pre-wrap;
      word-break: break-word;
      line-height:1.45;
    }
    button.copy{
      border:1px solid rgba(255,255,255,.16);
      background: rgba(122,167,255,.14);
      color: var(--text);
      padding:7px 10px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .15s ease, background .15s ease;
      font-size:.88rem;
    }
    button.copy:hover{transform: translateY(-1px); background: rgba(122,167,255,.22);}
    button.copy:active{transform: translateY(0px);}

    figure{
      margin:0;
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(15,24,48,.60);
      overflow:hidden;
    }
    figcaption{
      padding:10px 12px;
      color: var(--muted);
      border-top:1px solid rgba(255,255,255,.08);
      font-size:.92rem;
    }
    .canvasWrap{
      padding:10px;
    }
    canvas{
      width:100%;
      height: 320px;
      display:block;
      border-radius: 14px;
      background: rgba(8,10,18,.55);
      border:1px solid rgba(255,255,255,.08);
    }
    .plotRow{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .controls{
      border:1px solid var(--border);
      border-radius: var(--radius2);
      background: rgba(15,24,48,.55);
      padding:12px 12px;
    }
    .controls h3{margin:0 0 10px}
    .ctrlGrid{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px 12px;
    }
    @media (max-width: 720px){
      .ctrlGrid{grid-template-columns:1fr}
    }
    .ctrl{
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
      border-radius: 14px;
      padding:10px 10px;
    }
    .ctrl label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      color: var(--muted);
      font-size:.92rem;
      margin-bottom:6px;
    }
    .ctrl .val{
      color: var(--text);
      font-family: var(--mono);
      font-size:.92rem;
    }
    input[type="range"]{
      width:100%;
    }
    select{
      width:100%;
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.12);
      background: rgba(8,10,18,.55);
      color: var(--text);
      outline:none;
    }
    .readout{
      margin-top:10px;
      padding-top:10px;
      border-top:1px dashed rgba(255,255,255,.14);
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:10px;
    }
    @media (max-width: 720px){
      .readout{grid-template-columns:1fr}
    }
    .metric{
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:10px 10px;
      background: rgba(0,0,0,.18);
    }
    .metric .k{color:var(--muted); font-size:.9rem}
    .metric .v{color:var(--text); font-family: var(--mono); font-size:1.0rem; margin-top:4px}
    .footer{
      padding: 16px 18px;
      color: var(--muted);
      font-size:.92rem;
    }
    .printHint{
      color: var(--soft);
      font-size:.9rem;
      margin-top:8px;
    }
    @media print{
      body{background:#fff;color:#000}
      nav.toc{display:none}
      article, .hero, figure, .controls{box-shadow:none; backdrop-filter:none}
      canvas{border:1px solid #ddd; background:#fff}
      .callout{break-inside:avoid}
    }
  </style>
</head>
<body>
<header>
  <div class="hero">
    <h1>Fabryâ€“Perot Etalon with GaAs/AlAs Bragg (DBR) Reflectors</h1>
    <p class="subtitle">
      We compute the <b>Bragg reflector transmittance</b> (quarter-wave GaAs/AlAs stack, incidence from GaAs),
      then use that mirror reflectivity to find the <b>Fabryâ€“Perot finesse</b> and <b>quality factor Q</b>.
      Interactive plots below let you vary the number of DBR periods and cavity length and see how the spectrum changes.
    </p>
  </div>
</header>

<main>
  <nav class="toc" aria-label="Table of contents">
    <h2>On this page</h2>
    <a href="#quick" data-scroll>Quick Summary</a>
    <a href="#part0" data-scroll>PART 0 â€” Concept Primer</a>
    <a href="#part1" data-scroll>PART 1 â€” Problem Analysis</a>
    <a href="#part2" data-scroll>PART 2 â€” Strategy & Tips</a>
    <a href="#part3" data-scroll>PART 3 â€” Full Solution</a>
    <a href="#part4" data-scroll>PART 4 â€” Deeper Understanding</a>
    <a href="#part5" data-scroll>PART 5 â€” Visualization Guide</a>
    <div class="mini">
      <div><span class="badge">Symbols</span> n<sub>H</sub>=3.6 (GaAs), n<sub>L</sub>=3.2 (AlAs)</div>
      <div><span class="badge">Design</span> quarter-wave at Î»<sub>0</sub></div>
      <div class="printHint">Tip: Print view is clean (Ctrl/Cmd+P).</div>
    </div>
  </nav>

  <article>
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li>We have a <b>Fabryâ€“Perot etalon</b>: GaAs cavity sandwiched between two identical <b>Bragg (DBR) mirrors</b>.</li>
        <li>Each DBR is a <b>quarter-wave</b> multilayer: alternating GaAs (n<sub>H</sub>=3.6) and AlAs (n<sub>L</sub>=3.2).</li>
        <li>At the design wavelength Î»<sub>0</sub>, a quarter-wave DBR acts like an <b>impedance transformer</b> producing high reflectivity as periods increase.</li>
        <li>Key mirror result at Î»<sub>0</sub> (lossless, normal incidence, same external medium both sides):<br/>
          reflectance <b>R</b> and transmittance <b>T=1âˆ’R</b> depend on the index ratio (n<sub>H</sub>/n<sub>L</sub>) and number of periods.</li>
        <li>Fabryâ€“Perot linewidth relates to mirror reflectivity: <b>finesse</b> ğ“• â‰ˆ Ï€âˆšR/(1âˆ’R) for identical mirrors with negligible loss.</li>
        <li>Quality factor: <b>Q = Î½<sub>0</sub>/Î”Î½ = (Î½<sub>0</sub>/FSR)Â·ğ“• = (2n<sub>cav</sub>L/Î»<sub>0</sub>)Â·ğ“•</b> (symbolic unless cavity length L is specified).</li>
        <li>For <b>N=10 periods</b> (20 layers) and incidence from GaAs: R(Î»<sub>0</sub>) â‰ˆ 0.6835, T(Î»<sub>0</sub>) â‰ˆ 0.3165, and ğ“• â‰ˆ 8.22 (numeric).</li>
      </ul>
    </section>

    <section id="part0">
      <h2>PART 0 â€” Concept Primer (THEORY BEFORE SOLVING)</h2>

      <div class="grid2">
        <div class="callout keyeq">
          <strong>Core definitions</strong>
          <ul>
            <li><b>Refractive index</b> n (dimensionless): controls phase velocity v = c/n.</li>
            <li><b>Quarter-wave layer</b>: thickness d such that optical thickness n d = Î»<sub>0</sub>/4.</li>
            <li><b>DBR (Bragg mirror)</b>: periodic index stack creating a <b>stop band</b> around Î»<sub>0</sub>.</li>
            <li><b>Fabryâ€“Perot resonance</b>: constructive interference after round trips in a cavity.</li>
            <li><b>Finesse</b> ğ“• (dimensionless): ğ“• = FSR / Î”Î½ (free spectral range divided by linewidth).</li>
            <li><b>Quality factor</b> Q (dimensionless): Q = Î½<sub>0</sub>/Î”Î½ = Ï‰<sub>0</sub>/Î”Ï‰.</li>
          </ul>
        </div>

        <div class="callout assump">
          <strong>Physical meaning (intuition)</strong>
          <ul>
            <li>Each interface partially reflects; a periodic stack makes these reflections <b>add in phase</b> near Î»<sub>0</sub>.</li>
            <li>The DBR reflectivity grows roughly exponentially with the number of periods because the effective impedance mismatch increases.</li>
            <li>In a Fabryâ€“Perot, higher mirror reflectivity means light bounces more times â†’ <b>narrower resonances</b> â†’ larger ğ“• and Q.</li>
          </ul>
        </div>
      </div>

      <h3>Key laws / principles (and when they apply)</h3>
      <ul>
        <li><b>1D wave interference in stratified media</b> (normal incidence): use Fresnel relations + phase accumulation.</li>
        <li><b>Transfer-matrix method</b>: exact for linear, homogeneous layers with planar interfaces; valid when scattering/absorption is negligible.</li>
        <li><b>Lossless energy conservation</b>: for real n and no absorption, R + T = 1 at normal incidence (same medium both sides).</li>
      </ul>

      <h3>Common models / approximations</h3>
      <ul>
        <li><b>Quarter-wave approximation</b>: d = Î»<sub>0</sub>/(4n). Maximizes stop-band reflectivity at Î»<sub>0</sub>.</li>
        <li><b>High-finesse Fabryâ€“Perot approximation</b>: mirror reflectivity treated as constant near resonance â†’ ğ“• â‰ˆ Ï€âˆšR/(1âˆ’R).</li>
        <li><b>Normal incidence</b>: TE and TM behave identically (no polarization splitting).</li>
      </ul>

      <h3>Mini intuition examples</h3>
      <ul>
        <li><b>Single interface:</b> even a large index step gives limited reflection; many weak reflections can cooperate to make a strong mirror.</li>
        <li><b>Cavity effect:</b> two modest mirrors can still yield sharp resonances if the cavity length supports many round trips (high R).</li>
      </ul>

      <div class="callout mist">
        <strong>What to watch for (pitfalls)</strong>
        <ul>
          <li><b>N ambiguity:</b> â€œN alternating layersâ€ vs â€œN periods (pairs)â€. Reflectivity depends strongly on which is meant.</li>
          <li><b>Design vs off-design wavelengths:</b> quarter-wave condition is exact only at Î»<sub>0</sub>; spectra broaden into a stop band.</li>
          <li><b>Q needs cavity length:</b> finesse can be found from mirror R alone, but Q also depends on cavity order m = 2nL/Î».</li>
          <li><b>Mirror phase:</b> exact cavity resonance positions shift because DBRs introduce wavelength-dependent reflection phase.</li>
        </ul>
      </div>
    </section>

    <section id="part1">
      <h2>PART 1 â€” Problem Analysis (no solving yet)</h2>

      <h3>Restate the problem (in plain language)</h3>
      <p>
        A GaAs layer (the cavity) is placed between two identical GaAs/AlAs Bragg reflectors (DBRs).
        Each DBR is made of alternating quarter-wave layers of GaAs (n<sub>1</sub>=3.6) and AlAs (n<sub>2</sub>=3.2),
        and light is incident from an extended GaAs medium.
        We must determine:
        (i) the DBR transmittance (at the Bragg/design wavelength),
        (ii) the Fabryâ€“Perot finesse ğ“•, and
        (iii) the resonator quality factor Q.
      </p>

      <div class="grid2">
        <div>
          <h3>Given</h3>
          <ul>
            <li>High-index layer (GaAs): n<sub>H</sub> = 3.6</li>
            <li>Low-index layer (AlAs): n<sub>L</sub> = 3.2</li>
            <li>Quarter-wave thicknesses: n<sub>H</sub>d<sub>H</sub>=Î»<sub>0</sub>/4, n<sub>L</sub>d<sub>L</sub>=Î»<sub>0</sub>/4</li>
            <li>Incidence medium: GaAs (n<sub>0</sub>=3.6)</li>
            <li>Two identical DBRs form the cavity mirrors</li>
            <li>Number parameter: N = 10 (interpreted below)</li>
          </ul>
        </div>
        <div>
          <h3>Unknowns</h3>
          <ul>
            <li>DBR transmittance T<sub>DBR</sub>(Î»<sub>0</sub>)</li>
            <li>Mirror reflectance R(Î»<sub>0</sub>)</li>
            <li>Fabryâ€“Perot finesse ğ“•</li>
            <li>Quality factor Q (will be symbolic unless cavity length L is specified)</li>
          </ul>

          <div class="callout assump">
            <strong>Assumptions (explicit)</strong>
            <ul>
              <li>Normal incidence (1D stack), linear optics, no absorption (real n).</li>
              <li>Perfect layer thicknesses (exact quarter-wave at Î»<sub>0</sub>).</li>
              <li>Two identical mirrors; cavity is uniform GaAs of thickness L.</li>
            </ul>
          </div>
        </div>
      </div>

      <h3>Which physics principles apply (and why)</h3>
      <ul>
        <li><b>Transfer-matrix / multilayer interference:</b> needed because multiple reflections interfere across many layers.</li>
        <li><b>Fabryâ€“Perot resonance condition:</b> the cavity transmission peaks when round-trip phase â‰ˆ 2Ï€m.</li>
        <li><b>Energy conservation:</b> with lossless layers and same medium on both sides, T = 1 âˆ’ R at Î»<sub>0</sub>.</li>
      </ul>

      <h3>Possible approaches (compare briefly)</h3>
      <ul>
        <li><b>(A) Closed-form quarter-wave DBR formula at Î»<sub>0</sub>:</b> fastest; gives R(Î»<sub>0</sub>) analytically; best for â€œtransmittance at the design wavelengthâ€.</li>
        <li><b>(B) Transfer-matrix calculation:</b> exact at any wavelength; best for plotting spectra and seeing the stop band and cavity resonances.</li>
        <li><b>(C) Coupled-mode / Bragg grating theory:</b> insightful for long gratings and stop-band width, but more work for a finite multilayer with boundary conditions.</li>
      </ul>

      <p>
        <b>We choose (A) for the analytic answer</b> (transmittance at Î»<sub>0</sub>, finesse and Q),
        and <b>use (B) inside the interactive visualization</b> to show full spectra and parameter dependence.
      </p>
    </section>

    <section id="part2">
      <h2>PART 2 â€” Strategy & Tips (roadmap only)</h2>

      <ol style="margin:10px 0 0 20px; color:var(--muted)">
        <li>
          <b>Define the DBR design:</b> set d<sub>H</sub>=Î»<sub>0</sub>/(4n<sub>H</sub>), d<sub>L</sub>=Î»<sub>0</sub>/(4n<sub>L</sub>).<br/>
          <span class="badge">Meaning</span> each layer gives Ï€/2 phase at Î»<sub>0</sub>.
        </li>
        <li>
          <b>Compute DBR reflectance at Î»<sub>0</sub>:</b> use quarter-wave closed-form impedance transformation.<br/>
          <span class="badge">Tool</span> effective admittance (normal incidence).
        </li>
        <li>
          <b>Convert to transmittance:</b> lossless and symmetric external medium â†’ T<sub>DBR</sub>=1âˆ’R.<br/>
          <span class="badge">Meaning</span> energy conservation.
        </li>
        <li>
          <b>Compute finesse:</b> for identical mirrors (power reflectivity R), ğ“• â‰ˆ Ï€âˆšR/(1âˆ’R).<br/>
          <span class="badge">Meaning</span> sharper resonances for larger R.
        </li>
        <li>
          <b>Relate Q to finesse:</b> Q=(Î½<sub>0</sub>/FSR)ğ“• with FSR=c/(2nL).<br/>
          <span class="badge">Meaning</span> Q increases with cavity order m=2nL/Î»<sub>0</sub>.
        </li>
        <li>
          <b>Sanity checks:</b> verify limits: Nâ†’0 gives Râ†’0; Nâ†’âˆ gives Râ†’1 and ğ“•â†’âˆ.</li>
      </ol>

      <div class="callout mist">
        <strong>Common mistakes + quick tips</strong>
        <ul>
          <li><b>Counting N wrong:</b> If N means â€œperiods (pairs)â€, total layers = 2N. If N means â€œlayersâ€, periods = N/2.</li>
          <li><b>Forgetting the medium:</b> DBR reflectance depends on incidence and substrate indices; here both are GaAs.</li>
          <li><b>Mixing amplitude vs power:</b> finesse uses <i>power</i> reflectivity R (not amplitude r).</li>
        </ul>
      </div>
    </section>

    <section id="part3">
      <h2>PART 3 â€” Full Solution (DETAILED + TEACHING)</h2>

      <h3>Qualitative expectation (before calculating)</h3>
      <p>
        Because GaAs and AlAs have only moderate index contrast (3.6 vs 3.2), a small number of periods will not make a
        â€œnear-perfectâ€ mirror. Increasing the number of periods should push the DBR reflectivity upward toward 1,
        which in turn increases the Fabryâ€“Perot finesse and Q (narrower, taller transmission peaks).
      </p>

      <h3>Step 1 â€” Quarter-wave condition and layer thicknesses</h3>
      <p>
        At the design wavelength Î»<sub>0</sub>, the quarter-wave condition is
        <b>n d = Î»<sub>0</sub>/4</b>. Therefore,
      </p>

      <div class="eqwrap">
        <div class="eqbar">
          <div class="eqtitle"><span class="badge">Key equation</span>Quarter-wave thicknesses</div>
          <button class="copy" data-copy="d_H = Î»0/(4 n_H)
d_L = Î»0/(4 n_L)">Copy</button>
        </div>
        <pre class="eq">d_H = Î»0 / (4 n_H)
d_L = Î»0 / (4 n_L)</pre>
      </div>

      <p>
        Physically: each layer produces a phase shift Î´ = (2Ï€/Î»<sub>0</sub>)Â·(n d) = (2Ï€/Î»<sub>0</sub>)Â·(Î»<sub>0</sub>/4) = Ï€/2,
        which is what makes reflections from successive interfaces add constructively in the stop band.
      </p>

      <h3>Step 2 â€” DBR reflectance at Î»<sub>0</sub> (closed-form)</h3>
      <p>
        For normal incidence in a lossless dielectric stack, it is convenient to use the <b>optical admittance</b> Y.
        At normal incidence, Y = n (for TE/TM alike). A quarter-wave layer transforms admittance in a simple way;
        after N <b>periods (pairs)</b> of alternating indices, the net transformation yields an effective admittance seen by the incident medium.
      </p>

      <p>
        For a quarter-wave DBR with indices n<sub>H</sub>, n<sub>L</sub>, <b>N periods</b>, and with the same medium on both sides
        (here n<sub>0</sub> = n<sub>S</sub> = n<sub>H</sub> = 3.6 because the light is in extended GaAs on both sides),
        the on-design <b>power reflectance</b> simplifies to:
      </p>

      <div class="eqwrap">
        <div class="eqbar">
          <div class="eqtitle"><span class="badge">Key equation</span>DBR reflectance at Î»0 (n0 = nS)</div>
          <button class="copy" data-copy="Let q = (n_H/n_L)^(2N).  Then  R(Î»0) = ((q - 1)/(q + 1))^2
and T(Î»0) = 1 - R(Î»0) (lossless, same medium both sides).">Copy</button>
        </div>
        <pre class="eq">q = (n_H/n_L)^(2N)

R(Î»0) = ((q - 1)/(q + 1))^2

T(Î»0) = 1 - R(Î»0)    (lossless, same medium both sides)</pre>
      </div>

      <p>
        <b>Why this form?</b> The ratio (n<sub>H</sub>/n<sub>L</sub>) gets exponentiated because each period increases the effective impedance mismatch.
        If n<sub>H</sub>=n<sub>L</sub>, then q=1 â†’ R=0 (no mirror). As N grows, q grows â†’ Râ†’1.
      </p>

      <div class="callout assump">
        <strong>About the meaning of â€œN = 10â€</strong>
        <ul>
          <li>In most DBR formulas, <b>N means number of periods (pairs)</b>, so total layers = 2N.</li>
          <li>If your statement â€œN = 10 alternating layersâ€ literally means 10 layers total, then periods = 5.
              You can use the same formula by replacing N â†’ 5.</li>
        </ul>
      </div>

      <h3>Step 3 â€” Plug in numbers for N = 10 periods</h3>
      <p>
        Use n<sub>H</sub>=3.6, n<sub>L</sub>=3.2, N=10.
        First compute the ratio:
        (n<sub>H</sub>/n<sub>L</sub>) = 3.6/3.2 = 1.125.
      </p>
      <p>
        Then
        q = (1.125)^(2N) = (1.125)^(20).
        Numerically this gives:
      </p>

      <div class="eqwrap">
        <div class="eqbar">
          <div class="eqtitle"><span class="badge">Numeric</span>DBR reflectance & transmittance at Î»0 (N=10 periods)</div>
          <button class="copy" data-copy="n_H = 3.6, n_L = 3.2, N = 10 periods
q = (n_H/n_L)^(2N) = (1.125)^(20)
R(Î»0) â‰ˆ 0.6835
T(Î»0) â‰ˆ 0.3165">Copy</button>
        </div>
        <pre class="eq">n_H = 3.6, n_L = 3.2, N = 10 periods
q = (n_H/n_L)^(2N) = (1.125)^(20)

R(Î»0) â‰ˆ 0.6835
T(Î»0) â‰ˆ 0.3165</pre>
      </div>

      <p>
        <b>Sanity checks:</b>
        (i) R is between 0 and 1 âœ”.
        (ii) R + T â‰ˆ 1 âœ” (lossless).
        (iii) Moderate index contrast + only 10 periods â†’ R is not near unity âœ”.
      </p>

      <h3>Step 4 â€” Fabryâ€“Perot finesse from mirror reflectivity</h3>
      <p>
        For a symmetric Fabryâ€“Perot with identical mirrors of <b>power reflectivity R</b> and negligible internal loss,
        the transmission peaks have linewidth Î”Î½ set by how many round trips light survives.
        A standard high-finesse relation is:
      </p>

      <div class="eqwrap">
        <div class="eqbar">
          <div class="eqtitle"><span class="badge">Key equation</span>Finesse (identical lossless mirrors)</div>
          <button class="copy" data-copy="ğ“• â‰ˆ Ï€ âˆšR / (1 - R)">Copy</button>
        </div>
        <pre class="eq">ğ“• â‰ˆ Ï€ âˆšR / (1 - R)</pre>
      </div>

      <p>
        Insert R(Î»<sub>0</sub>) â‰ˆ 0.6835:
      </p>

      <div class="eqwrap">
        <div class="eqbar">
          <div class="eqtitle"><span class="badge">Numeric</span>Finesse for N=10 periods</div>
          <button class="copy" data-copy="R â‰ˆ 0.6835  â‡’  ğ“• â‰ˆ Ï€ âˆšR / (1 - R) â‰ˆ 8.22">Copy</button>
        </div>
        <pre class="eq">R â‰ˆ 0.6835  â‡’  ğ“• â‰ˆ Ï€ âˆšR / (1 - R) â‰ˆ 8.22</pre>
      </div>

      <p>
        <b>Interpretation:</b> the cavity resonance width is about 1/8 of the free spectral range.
        If you increase the number of DBR periods, R rises and ğ“• grows rapidly (see the interactive plot).
      </p>

      <h3>Step 5 â€” Quality factor Q</h3>
      <p>
        The free spectral range (FSR) of a Fabryâ€“Perot cavity of refractive index n<sub>cav</sub> and thickness L is
      </p>

      <div class="eqwrap">
        <div class="eqbar">
          <div class="eqtitle"><span class="badge">Key equation</span>FSR and Q</div>
          <button class="copy" data-copy="FSR = c / (2 n_cav L)
Q = Î½0/Î”Î½ = (Î½0/FSR) Â· ğ“• = (2 n_cav L / Î»0) Â· ğ“•">Copy</button>
        </div>
        <pre class="eq">FSR = c / (2 n_cav L)

Q = Î½0/Î”Î½ = (Î½0/FSR) Â· ğ“•
         = (2 n_cav L / Î»0) Â· ğ“•</pre>
      </div>

      <p>
        Here the cavity is GaAs, so n<sub>cav</sub> = n<sub>H</sub> = 3.6.
        Without a specified L (or equivalently the resonance order m), Q remains <b>symbolic</b>.
        If the cavity supports an integer number m of half-wavelengths:
        2 n<sub>cav</sub> L = m Î»<sub>0</sub> â‡’ Q = m ğ“•.
      </p>

      <div class="callout final">
        <strong>FINAL ANSWER (compact)</strong>
        <div class="eqwrap">
          <div class="eqbar">
            <div class="eqtitle"><span class="badge">Final</span>DBR transmittance, finesse, and Q</div>
            <button class="copy" data-copy="Given n_H=3.6 (GaAs), n_L=3.2 (AlAs), quarter-wave at Î»0, incidence from GaAs.
Let q = (n_H/n_L)^(2N) where N is the number of DBR periods (pairs).

DBR reflectance at Î»0:  R(Î»0) = ((q - 1)/(q + 1))^2
DBR transmittance at Î»0 (lossless):  T_DBR(Î»0) = 1 - R(Î»0)

Fabryâ€“Perot finesse (two identical mirrors):  ğ“• â‰ˆ Ï€ âˆšR / (1 - R)

Quality factor:  Q = (2 n_cav L / Î»0) Â· ğ“•  (with n_cav=3.6 for GaAs).
If cavity is m half-waves: Q = m ğ“•.

For N=10 periods: Râ‰ˆ0.6835, Tâ‰ˆ0.3165, ğ“•â‰ˆ8.22.">Copy</button>
          </div>
          <pre class="eq">Given n_H=3.6 (GaAs), n_L=3.2 (AlAs), quarter-wave at Î»0, incidence from GaAs.
Let q = (n_H/n_L)^(2N) where N is the number of DBR periods (pairs).

DBR reflectance at Î»0:  R(Î»0) = ((q - 1)/(q + 1))^2
DBR transmittance at Î»0 (lossless):  T_DBR(Î»0) = 1 - R(Î»0)

Fabryâ€“Perot finesse (two identical mirrors):  ğ“• â‰ˆ Ï€ âˆšR / (1 - R)

Quality factor:  Q = (2 n_cav L / Î»0) Â· ğ“•  (with n_cav=3.6 for GaAs).
If cavity is m half-waves: Q = m ğ“•.

For N=10 periods: Râ‰ˆ0.6835, Tâ‰ˆ0.3165, ğ“•â‰ˆ8.22.</pre>
        </div>
      </div>

      <h3>Sanity checks (required)</h3>
      <ul>
        <li><b>Units:</b> ğ“• and Q are dimensionless; FSR has units of Hz; c/(2nL) is Hz âœ”.</li>
        <li><b>Limits:</b> Nâ†’0 â‡’ qâ†’1 â‡’ Râ†’0 â‡’ ğ“•â†’0 (no cavity buildup) âœ”.</li>
        <li><b>High reflectivity:</b> Nâ†’âˆ â‡’ Râ†’1 â‡’ ğ“•â†’âˆ and Qâ†’âˆ (ideal lossless limit) âœ”.</li>
      </ul>

      <p>
        Connection to the diagram and plots: the DBR spectrum shows a stop band centered at Î»<sub>0</sub>.
        The cavity spectrum shows sharp transmission peaks within/near that band; as N increases, mirror reflectivity increases,
        and the peaks narrow (higher finesse).
      </p>
    </section>

    <section id="viz" aria-label="Interactive visualizations">
      <h2>Interactive Visualizations</h2>

      <div class="controls" role="group" aria-label="Controls">
        <h3>Controls (updates all canvases live)</h3>
        <div class="ctrlGrid">
          <div class="ctrl">
            <label for="Nper">
              <span>DBR periods N (pairs)</span>
              <span class="val" id="NperVal">10</span>
            </label>
            <input id="Nper" type="range" min="1" max="25" step="1" value="10" />
            <div class="printHint">Total layers = 2N. (If your â€œNâ€ meant layers, set this slider to N/2.)</div>
          </div>

          <div class="ctrl">
            <label for="mMode">
              <span>Cavity length as half-wave order m</span>
              <span class="val" id="mModeVal">5</span>
            </label>
            <input id="mMode" type="range" min="1" max="30" step="1" value="5" />
            <div class="printHint">We set cavity thickness L = mÂ·Î»0/(2 n_cav) (example for plots).</div>
          </div>

          <div class="ctrl">
            <label for="span">
              <span>Wavelength span around Î»0</span>
              <span class="val" id="spanVal">Â±12%</span>
            </label>
            <input id="span" type="range" min="4" max="25" step="1" value="12" />
            <div class="printHint">Plot range: Î»/Î»0 from (1âˆ’span) to (1+span).</div>
          </div>

          <div class="ctrl">
            <label for="plotRes">
              <span>Sampling points</span>
              <span class="val" id="plotResVal">900</span>
            </label>
            <input id="plotRes" type="range" min="300" max="1600" step="50" value="900" />
            <div class="printHint">Higher = smoother curves (slower).</div>
          </div>
        </div>

        <div class="readout">
          <div class="metric">
            <div class="k">Mirror reflectance at Î»0 (from DBR)</div>
            <div class="v" id="R0Read">â€”</div>
          </div>
          <div class="metric">
            <div class="k">Mirror transmittance at Î»0</div>
            <div class="v" id="T0Read">â€”</div>
          </div>
          <div class="metric">
            <div class="k">Estimated finesse ğ“• â‰ˆ Ï€âˆšR/(1âˆ’R)</div>
            <div class="v" id="FRead">â€”</div>
          </div>
          <div class="metric">
            <div class="k">Estimated Q = mÂ·ğ“• (since 2nL = mÎ»0)</div>
            <div class="v" id="QRead">â€”</div>
          </div>
        </div>
      </div>

      <div class="plotRow" style="margin-top:12px">
        <figure>
          <div class="canvasWrap">
            <canvas id="cDiagram" aria-label="Diagram canvas"></canvas>
          </div>
          <figcaption>
            <b>Diagram:</b> GaAs cavity between two GaAs/AlAs quarter-wave DBRs (stack drawn to scale in number of layers, not physical thickness).
          </figcaption>
        </figure>

        <figure>
          <div class="canvasWrap">
            <canvas id="cMain" aria-label="Main plot canvas"></canvas>
          </div>
          <figcaption>
            <b>Main plot:</b> Total Fabryâ€“Perot transmittance spectrum T<sub>FP</sub>(Î») computed by transfer matrix for DBR + cavity + DBR.
          </figcaption>
        </figure>

        <figure>
          <div class="canvasWrap">
            <canvas id="cSecondary" aria-label="Secondary plot canvas"></canvas>
          </div>
          <figcaption>
            <b>Secondary plot:</b> DBR reflectance spectrum R<sub>DBR</sub>(Î») and a parameter-sweep curve ğ“•(N) at Î»<sub>0</sub>.
          </figcaption>
        </figure>
      </div>
    </section>

    <section id="part4">
      <h2>PART 4 â€” Deeper Understanding (THEORY AROUND THE RESULT)</h2>

      <h3>Re-interpreting the final formulas</h3>
      <ul>
        <li><b>q = (n<sub>H</sub>/n<sub>L</sub>)<sup>2N</sup>:</b> captures how stacking periods amplifies impedance mismatch exponentially.</li>
        <li><b>R(Î»<sub>0</sub>) = ((qâˆ’1)/(q+1))<sup>2</sup>:</b> a â€œtanh-likeâ€ saturation toward 1 as q grows.</li>
        <li><b>ğ“• â‰ˆ Ï€âˆšR/(1âˆ’R):</b> near Râ†’1, the denominator dominates and finesse grows very fast.</li>
        <li><b>Q = (2nL/Î»<sub>0</sub>)ğ“•:</b> even with the same mirrors, a longer cavity (higher order m) yields higher Q.</li>
      </ul>

      <h3>How parameters affect outcomes (connect to plots)</h3>
      <ul>
        <li>Increasing <b>N</b> widens and deepens the DBR stop band and increases reflectivity near Î»<sub>0</sub>. The cavity peaks narrow â†’ higher finesse.</li>
        <li>Increasing cavity order <b>m</b> increases Q roughly linearly (Q â‰ˆ mğ“•) but does not necessarily increase finesse (finesse is mostly mirror-limited).</li>
        <li>Moving away from Î»<sub>0</sub> breaks the quarter-wave phase condition; DBR reflectivity drops and cavity peaks broaden and shift.</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        Instead of the quarter-wave closed-form formula, you can compute the DBR reflection coefficient <i>r(Î»)</i>
        using the transfer matrix for one period, then raise it to the Nth power (Bloch approach) and apply boundary conditions.
        This also gives insight into the <b>stop-band width</b> and how the field decays inside the mirror.
      </p>

      <h3>Concept checks (self-test)</h3>
      <ul>
        <li><b>Q:</b> If mirror reflectivity increases, what happens to linewidth Î”Î½? <b>A:</b> Î”Î½ decreases (peaks get narrower).</li>
        <li><b>Q:</b> Does doubling cavity length necessarily double finesse? <b>A:</b> Noâ€”finesse is mainly mirror reflectivity; length changes FSR and thus Q.</li>
        <li><b>Q:</b> Why quarter-wave? <b>A:</b> It aligns reflected waves in phase at Î»<sub>0</sub>, maximizing constructive interference in reflection.</li>
        <li><b>Q:</b> If n<sub>H</sub>=n<sub>L</sub>, what happens? <b>A:</b> The DBR disappears: Râ†’0, no stop band.</li>
      </ul>
    </section>

    <section id="part5">
      <h2>PART 5 â€” Visualization Guide (HOW TO READ THE PLOTS)</h2>

      <h3>What each canvas shows</h3>
      <ul>
        <li><b>Diagram canvas:</b> a labeled schematic of the left DBR, GaAs cavity, and right DBR. Blue-ish blocks represent GaAs (n=3.6), green-ish blocks represent AlAs (n=3.2).</li>
        <li><b>Main plot (T<sub>FP</sub> vs Î»/Î»<sub>0</sub>):</b> the full resonator transmission spectrum computed from the total transfer matrix. Peaks correspond to cavity resonances.</li>
        <li><b>Secondary plot:</b>
          <ul>
            <li>R<sub>DBR</sub>(Î») vs Î»/Î»<sub>0</sub> (how reflective the mirror is across wavelength).</li>
            <li>ğ“•(N) at Î»<sub>0</sub> (a sweep showing how finesse scales with number of periods).</li>
          </ul>
        </li>
      </ul>

      <h3>Interactive controls</h3>
      <ul>
        <li><b>DBR periods N:</b> increases the mirror strength. You should see R<sub>DBR</sub> rise near Î»<sub>0</sub> and Fabryâ€“Perot peaks narrow (higher ğ“•).</li>
        <li><b>Cavity order m:</b> changes cavity length L = mÂ·Î»<sub>0</sub>/(2n). This changes peak spacing (FSR) and increases Q â‰ˆ mğ“•.</li>
        <li><b>Span & sampling:</b> change the plotted range and resolution.</li>
      </ul>

      <div class="callout keyeq">
        <strong>Important note about â€œexample valuesâ€</strong>
        <p style="margin:8px 0 0; color:var(--muted)">
          The plots use normalized wavelength Î»/Î»<sub>0</sub> and an example cavity choice L = mÂ·Î»<sub>0</sub>/(2n).
          This keeps the visualization general while matching the same symbols used in the derivation.
        </p>
      </div>
    </section>

    <footer class="footer">
      Built as a self-contained learning article (vanilla HTML/CSS/JS). Interactive spectra computed with a lossless transfer-matrix model at normal incidence.
    </footer>
  </article>
</main>

<script>
/* ---------------------------
   Smooth TOC scrolling
---------------------------- */
document.querySelectorAll('[data-scroll]').forEach(a=>{
  a.addEventListener('click', (e)=>{
    e.preventDefault();
    const id = a.getAttribute('href');
    const el = document.querySelector(id);
    if(!el) return;
    el.scrollIntoView({behavior:'smooth', block:'start'});
  });
});

/* ---------------------------
   Copy buttons
---------------------------- */
async function copyText(txt){
  try{
    await navigator.clipboard.writeText(txt);
    return true;
  }catch(e){
    // Fallback
    const ta = document.createElement('textarea');
    ta.value = txt;
    document.body.appendChild(ta);
    ta.select();
    try{
      document.execCommand('copy');
      document.body.removeChild(ta);
      return true;
    }catch(err){
      document.body.removeChild(ta);
      return false;
    }
  }
}
document.querySelectorAll('button.copy').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const txt = btn.getAttribute('data-copy') || '';
    const ok = await copyText(txt);
    const old = btn.textContent;
    btn.textContent = ok ? 'Copied!' : 'Copy failed';
    setTimeout(()=>btn.textContent = old, 900);
  });
});

/* ---------------------------
   Physics + plotting utilities
---------------------------- */
const nH = 3.6; // GaAs
const nL = 3.2; // AlAs
const n0 = 3.6; // incident GaAs
const nS = 3.6; // exit GaAs
const nC = 3.6; // cavity GaAs

function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }

function matMul(A,B){
  return [
    [A[0][0]*B[0][0] + A[0][1]*B[1][0], A[0][0]*B[0][1] + A[0][1]*B[1][1]],
    [A[1][0]*B[0][0] + A[1][1]*B[1][0], A[1][0]*B[0][1] + A[1][1]*B[1][1]]
  ];
}

function layerMatrix(n, lambdaRatio, lambda0=1){
  // normal incidence characteristic matrix for a single layer with thickness d = Î»0/(4n) (quarter-wave at Î»0)
  // delta = 2Ï€ n d / Î» = 2Ï€ (Î»0/4)/Î» = (Ï€/2)*(Î»0/Î») = (Ï€/2)/lambdaRatio
  const delta = (Math.PI/2) * (1/lambdaRatio);
  const c = Math.cos(delta);
  const s = Math.sin(delta);
  // Use i = (0,1). Represent complex as {re,im}.
  // Matrix: [[c, i s / n], [i n s, c]]
  return [
    [{re:c, im:0}, {re:0, im:s/n}],
    [{re:0, im:n*s}, {re:c, im:0}]
  ];
}

function cAdd(a,b){ return {re:a.re+b.re, im:a.im+b.im}; }
function cSub(a,b){ return {re:a.re-b.re, im:a.im-b.im}; }
function cMul(a,b){ return {re:a.re*b.re - a.im*b.im, im:a.re*b.im + a.im*b.re}; }
function cDiv(a,b){
  const den = b.re*b.re + b.im*b.im;
  return {re:(a.re*b.re + a.im*b.im)/den, im:(a.im*b.re - a.re*b.im)/den};
}
function cAbs2(a){ return a.re*a.re + a.im*a.im; }

function matMulC(A,B){
  return [
    [cAdd(cMul(A[0][0],B[0][0]), cMul(A[0][1],B[1][0])),
     cAdd(cMul(A[0][0],B[0][1]), cMul(A[0][1],B[1][1]))],
    [cAdd(cMul(A[1][0],B[0][0]), cMul(A[1][1],B[1][0])),
     cAdd(cMul(A[1][0],B[0][1]), cMul(A[1][1],B[1][1]))]
  ];
}

function identityC(){
  return [
    [{re:1,im:0},{re:0,im:0}],
    [{re:0,im:0},{re:1,im:0}]
  ];
}

function stackMatrixQuarterWave(periods, lambdaRatio){
  // Build (L,H)^N with L first (common for DBR adjacent to high-index medium),
  // but at Î»0 for n0=nS, the reflectance depends only on ratio and N.
  // Still, for spectra we compute exact matrix.
  let M = identityC();
  for(let k=0;k<periods;k++){
    M = matMulC(M, layerMatrix(nL, lambdaRatio));
    M = matMulC(M, layerMatrix(nH, lambdaRatio));
  }
  return M;
}

function cavityMatrix(lambdaRatio, mHalfWaves){
  // Cavity thickness L = m * Î»0/(2 nC).
  // Phase delta = 2Ï€ nC L / Î» = 2Ï€ nC * (m Î»0/(2 nC)) / Î» = Ï€ m * (Î»0/Î») = Ï€ m / lambdaRatio
  const delta = Math.PI * mHalfWaves * (1/lambdaRatio);
  const c = Math.cos(delta);
  const s = Math.sin(delta);
  return [
    [{re:c, im:0}, {re:0, im:s/nC}],
    [{re:0, im:nC*s}, {re:c, im:0}]
  ];
}

function rtFromMatrix(M, nIn, nOut){
  // For characteristic matrix M = [[A,B],[C,D]] (complex),
  // at normal incidence with admittances Y=n:
  // denom = (Y0*A + Y0*Ys*B + C + Ys*D)
  // r = (Y0*A + Y0*Ys*B - C - Ys*D) / denom
  // t = (2 Y0) / denom
  const A=M[0][0], B=M[0][1], C=M[1][0], D=M[1][1];
  const Y0 = {re:nIn, im:0};
  const Ys = {re:nOut, im:0};
  const Y0A = cMul(Y0, A);
  const Y0YsB = cMul(cMul(Y0,Ys), B);
  const YsD = cMul(Ys, D);

  const denom = cAdd(cAdd(Y0A, Y0YsB), cAdd(C, YsD));
  const numerR = cSub(cAdd(Y0A, Y0YsB), cAdd(C, YsD));
  const r = cDiv(numerR, denom);
  const t = cDiv({re:2*nIn, im:0}, denom);

  // Power coefficients (n real): T = |t|^2 * (nOut/nIn)
  const R = cAbs2(r);
  const T = cAbs2(t) * (nOut/nIn);
  return {r,t,R,T};
}

function dbrRT(periods, lambdaRatio){
  const M = stackMatrixQuarterWave(periods, lambdaRatio);
  return rtFromMatrix(M, n0, nS);
}

function fpTotalT(periods, lambdaRatio, mHalfWaves){
  // Total stack: DBR + cavity + reversed DBR (for symmetry)
  // For quarter-wave layers at normal incidence, reversing the order gives same power spectrum for symmetric media,
  // but we still compute the explicit reversed stack for clarity.
  let M = identityC();

  // Left DBR: (L,H)^N
  for(let k=0;k<periods;k++){
    M = matMulC(M, layerMatrix(nL, lambdaRatio));
    M = matMulC(M, layerMatrix(nH, lambdaRatio));
  }
  // Cavity
  M = matMulC(M, cavityMatrix(lambdaRatio, mHalfWaves));

  // Right DBR: reverse order -> (H,L)^N
  for(let k=0;k<periods;k++){
    M = matMulC(M, layerMatrix(nH, lambdaRatio));
    M = matMulC(M, layerMatrix(nL, lambdaRatio));
  }

  const out = rtFromMatrix(M, n0, nS);
  return out;
}

function analyticR0(periods){
  // Closed-form at Î»0 for n0=nS and quarter-wave DBR
  const ratio = nH/nL;
  const q = Math.pow(ratio, 2*periods);
  const R = Math.pow((q-1)/(q+1), 2);
  return R;
}

function finesseFromR(R){
  const eps = 1e-12;
  const Rc = clamp(R, 0, 1-eps);
  return Math.PI * Math.sqrt(Rc) / (1 - Rc);
}

/* ---------------------------
   Canvas plotting helper
---------------------------- */
function setupCanvas(canvas){
  const ctx = canvas.getContext('2d');
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    const w = Math.max(10, Math.floor(rect.width));
    const h = Math.max(10, Math.floor(rect.height));
    canvas.width = Math.floor(w * dpr);
    canvas.height = Math.floor(h * dpr);
    ctx.setTransform(dpr,0,0,dpr,0,0);
    return {w,h,dpr};
  }
  return {ctx, resize};
}

function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
  const {x,y,w,h} = box;
  // background
  ctx.save();
  ctx.fillStyle = 'rgba(8,10,18,0.55)';
  ctx.fillRect(x,y,w,h);

  // padding for labels
  const padL = 56, padR = 16, padT = 34, padB = 46;
  const plot = {x:x+padL, y:y+padT, w:w-padL-padR, h:h-padT-padB};

  // gridlines
  ctx.strokeStyle = 'rgba(255,255,255,0.10)';
  ctx.lineWidth = 1;

  const nGrid = 6;
  for(let i=0;i<=nGrid;i++){
    const gx = plot.x + plot.w * (i/nGrid);
    ctx.beginPath(); ctx.moveTo(gx, plot.y); ctx.lineTo(gx, plot.y+plot.h); ctx.stroke();
    const gy = plot.y + plot.h * (i/nGrid);
    ctx.beginPath(); ctx.moveTo(plot.x, gy); ctx.lineTo(plot.x+plot.w, gy); ctx.stroke();
  }

  // axes
  ctx.strokeStyle = 'rgba(255,255,255,0.45)';
  ctx.lineWidth = 1.2;
  ctx.beginPath();
  ctx.moveTo(plot.x, plot.y+plot.h);
  ctx.lineTo(plot.x+plot.w, plot.y+plot.h);
  ctx.stroke();
  ctx.beginPath();
  ctx.moveTo(plot.x, plot.y);
  ctx.lineTo(plot.x, plot.y+plot.h);
  ctx.stroke();

  // ticks & labels
  ctx.fillStyle = 'rgba(255,255,255,0.82)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  for(let i=0;i<=nGrid;i++){
    const tx = plot.x + plot.w*(i/nGrid);
    const val = xMin + (xMax-xMin)*(i/nGrid);
    ctx.fillText(val.toFixed(2), tx, plot.y+plot.h+8);
  }
  ctx.textAlign = 'right';
  ctx.textBaseline = 'middle';
  for(let i=0;i<=nGrid;i++){
    const ty = plot.y + plot.h*(i/nGrid);
    const val = yMax - (yMax-yMin)*(i/nGrid);
    ctx.fillText(val.toFixed(2), plot.x-8, ty);
  }

  // title
  ctx.textAlign = 'left';
  ctx.textBaseline = 'top';
  ctx.font = '14px ' + getComputedStyle(document.body).fontFamily;
  ctx.fillStyle = 'rgba(233,238,252,0.95)';
  ctx.fillText(title, plot.x, y+10);

  // axis labels
  ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
  ctx.fillStyle = 'rgba(184,195,230,0.95)';
  ctx.textAlign = 'center';
  ctx.textBaseline = 'bottom';
  ctx.fillText(xLabel, plot.x + plot.w/2, y + h - 10);

  // y label rotated
  ctx.save();
  ctx.translate(x+16, plot.y + plot.h/2);
  ctx.rotate(-Math.PI/2);
  ctx.textAlign = 'center';
  ctx.textBaseline = 'top';
  ctx.fillText(yLabel, 0, 0);
  ctx.restore();

  ctx.restore();
  return plot;
}

function plotLine(ctx, plot, xs, ys, xMin, xMax, yMin, yMax, strokeStyle){
  ctx.save();
  ctx.strokeStyle = strokeStyle;
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<xs.length;i++){
    const px = plot.x + (xs[i]-xMin)/(xMax-xMin)*plot.w;
    const py = plot.y + (1-(ys[i]-yMin)/(yMax-yMin))*plot.h;
    if(i===0) ctx.moveTo(px,py);
    else ctx.lineTo(px,py);
  }
  ctx.stroke();
  ctx.restore();
}

function drawLegend(ctx, plot, items){
  // items: [{label, color}]
  ctx.save();
  const pad = 10;
  let x = plot.x + plot.w - 10;
  let y = plot.y + 8;
  ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
  ctx.textAlign = 'right';
  ctx.textBaseline = 'top';
  for(const it of items){
    ctx.fillStyle = 'rgba(255,255,255,0.90)';
    ctx.fillText(it.label, x, y);
    // color swatch
    ctx.fillStyle = it.color;
    ctx.fillRect(x-100, y+4, 16, 3);
    y += 18;
  }
  ctx.restore();
}

/* ---------------------------
   Diagram
---------------------------- */
function drawDiagram(ctx, w, h, periods, mHalfWaves){
  ctx.clearRect(0,0,w,h);

  // layout
  const margin = 18;
  const yMid = h*0.52;
  const barH = Math.min(120, h*0.35);
  const x0 = margin;
  const x1 = w - margin;

  // Blocks counts for drawing (not physical)
  const totalLayers = 2*periods;
  const blockW = (x1-x0) / (totalLayers*2 + 10); // allocate some for cavity
  const cavityW = blockW * 10;

  // labels
  ctx.fillStyle = 'rgba(233,238,252,0.95)';
  ctx.font = '14px ' + getComputedStyle(document.body).fontFamily;
  ctx.fillText('Structure (not to thickness scale)', margin, 10);

  // Draw left DBR
  let x = x0;
  const top = yMid - barH/2;
  for(let k=0;k<totalLayers;k++){
    const isL = (k%2===0); // L then H
    ctx.fillStyle = isL ? 'rgba(99,230,190,0.28)' : 'rgba(122,167,255,0.28)';
    ctx.fillRect(x, top, blockW, barH);
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.strokeRect(x, top, blockW, barH);
    x += blockW;
  }

  // cavity
  ctx.fillStyle = 'rgba(255,209,102,0.18)';
  ctx.fillRect(x, top, cavityW, barH);
  ctx.strokeStyle = 'rgba(255,255,255,0.14)';
  ctx.strokeRect(x, top, cavityW, barH);
  const xCav0 = x;
  x += cavityW;

  // right DBR
  for(let k=0;k<totalLayers;k++){
    const isH = (k%2===0); // reversed: H then L
    ctx.fillStyle = isH ? 'rgba(122,167,255,0.28)' : 'rgba(99,230,190,0.28)';
    ctx.fillRect(x, top, blockW, barH);
    ctx.strokeStyle = 'rgba(255,255,255,0.10)';
    ctx.strokeRect(x, top, blockW, barH);
    x += blockW;
  }

  // Annotations
  ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
  ctx.fillStyle = 'rgba(184,195,230,0.95)';

  // arrows
  function arrow(xa,ya,xb,yb){
    const dx=xb-xa, dy=yb-ya;
    const L=Math.hypot(dx,dy)||1;
    const ux=dx/L, uy=dy/L;
    const head=8;
    ctx.beginPath(); ctx.moveTo(xa,ya); ctx.lineTo(xb,yb); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(xb,yb);
    ctx.lineTo(xb - head*(ux) + head*0.5*(-uy), yb - head*(uy) + head*0.5*(ux));
    ctx.lineTo(xb - head*(ux) - head*0.5*(-uy), yb - head*(uy) - head*0.5*(ux));
    ctx.closePath(); ctx.fill();
  }

  ctx.strokeStyle = 'rgba(255,255,255,0.35)';
  ctx.fillStyle = 'rgba(255,255,255,0.35)';

  // Left DBR label
  const xLeftMid = x0 + (totalLayers*blockW)/2;
  ctx.fillStyle = 'rgba(233,238,252,0.92)';
  ctx.fillText(`Left DBR: N=${periods} periods (L/H quarter-wave)`, x0, top-24);

  // Cavity label
  ctx.fillStyle = 'rgba(233,238,252,0.92)';
  ctx.fillText(`GaAs cavity: m=${mHalfWaves} half-waves at Î»0`, xCav0+6, top+barH+10);

  // Legend blocks
  const lx = margin;
  const ly = h - 44;
  ctx.fillStyle = 'rgba(122,167,255,0.28)';
  ctx.fillRect(lx, ly, 22, 12);
  ctx.strokeStyle = 'rgba(255,255,255,0.18)';
  ctx.strokeRect(lx, ly, 22, 12);
  ctx.fillStyle = 'rgba(184,195,230,0.95)';
  ctx.fillText('GaAs (n=3.6)', lx+28, ly-1);

  ctx.fillStyle = 'rgba(99,230,190,0.28)';
  ctx.fillRect(lx+140, ly, 22, 12);
  ctx.strokeStyle = 'rgba(255,255,255,0.18)';
  ctx.strokeRect(lx+140, ly, 22, 12);
  ctx.fillStyle = 'rgba(184,195,230,0.95)';
  ctx.fillText('AlAs (n=3.2)', lx+168, ly-1);

  ctx.fillStyle = 'rgba(255,209,102,0.18)';
  ctx.fillRect(lx+280, ly, 22, 12);
  ctx.strokeStyle = 'rgba(255,255,255,0.18)';
  ctx.strokeRect(lx+280, ly, 22, 12);
  ctx.fillStyle = 'rgba(184,195,230,0.95)';
  ctx.fillText('Cavity', lx+308, ly-1);

  // incident arrow
  ctx.strokeStyle = 'rgba(255,255,255,0.45)';
  ctx.fillStyle = 'rgba(255,255,255,0.45)';
  const ay = yMid;
  arrow(margin, ay, x0-6, ay);
  ctx.fillStyle = 'rgba(184,195,230,0.95)';
  ctx.fillText('Incident from GaAs', margin, ay-18);
}

/* ---------------------------
   Main render loop
---------------------------- */
const cDiagram = setupCanvas(document.getElementById('cDiagram'));
const cMain = setupCanvas(document.getElementById('cMain'));
const cSecondary = setupCanvas(document.getElementById('cSecondary'));

const elN = document.getElementById('Nper');
const elM = document.getElementById('mMode');
const elSpan = document.getElementById('span');
const elRes = document.getElementById('plotRes');

const NperVal = document.getElementById('NperVal');
const mModeVal = document.getElementById('mModeVal');
const spanVal = document.getElementById('spanVal');
const plotResVal = document.getElementById('plotResVal');

const R0Read = document.getElementById('R0Read');
const T0Read = document.getElementById('T0Read');
const FRead = document.getElementById('FRead');
const QRead = document.getElementById('QRead');

function fmt(x, digits=4){
  if(!isFinite(x)) return 'â€”';
  return x.toFixed(digits);
}

function updateLabels(){
  const N = parseInt(elN.value,10);
  const m = parseInt(elM.value,10);
  const sp = parseInt(elSpan.value,10);
  const res = parseInt(elRes.value,10);
  NperVal.textContent = String(N);
  mModeVal.textContent = String(m);
  spanVal.textContent = `Â±${sp}%`;
  plotResVal.textContent = String(res);

  // Readouts from analytic Î»0 formulas
  const R0 = analyticR0(N);
  const T0 = 1 - R0;
  const F = finesseFromR(R0);
  const Q = m * F; // since 2nL = mÎ»0 by our plotting convention
  R0Read.textContent = `${fmt(R0,5)}`;
  T0Read.textContent = `${fmt(T0,5)}`;
  FRead.textContent = `${fmt(F,3)}`;
  QRead.textContent = `${fmt(Q,2)}`;
}

function render(){
  updateLabels();
  const N = parseInt(elN.value,10);
  const m = parseInt(elM.value,10);
  const sp = parseInt(elSpan.value,10)/100;
  const res = parseInt(elRes.value,10);

  // Resize canvases
  const rd = cDiagram.resize();
  const rm = cMain.resize();
  const rs = cSecondary.resize();

  // Diagram
  drawDiagram(cDiagram.ctx, rd.w, rd.h, N, m);

  // Build wavelength grid: lambdaRatio in [1-sp, 1+sp]
  const xMin = 1 - sp, xMax = 1 + sp;
  const xs = new Array(res);
  const Tfp = new Array(res);
  const Rdbr = new Array(res);

  let yMaxMain = 1.02;
  let yMaxSec = 1.02;

  for(let i=0;i<res;i++){
    const lr = xMin + (xMax-xMin) * (i/(res-1)); // Î»/Î»0
    xs[i] = lr;

    const dbr = dbrRT(N, lr);
    Rdbr[i] = dbr.R;

    const fp = fpTotalT(N, lr, m);
    Tfp[i] = fp.T;
  }

  // Main plot: FP transmission
  {
    const ctx = cMain.ctx;
    ctx.clearRect(0,0,rm.w,rm.h);
    const plot = drawAxes(ctx, {x:10,y:10,w:rm.w-20,h:rm.h-20}, xMin, xMax, 0, 1.0,
                          'Normalized wavelength  Î»/Î»0  (dimensionless)',
                          'Transmittance  T_FP  (unitless)',
                          'Fabryâ€“Perot Transmittance Spectrum (DBR + cavity + DBR)');
    plotLine(ctx, plot, xs, Tfp, xMin, xMax, 0, 1.0, 'rgba(122,167,255,0.95)');
    // Mark Î»0
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    ctx.setLineDash([6,6]);
    const x0p = plot.x + (1-xMin)/(xMax-xMin)*plot.w;
    ctx.beginPath(); ctx.moveTo(x0p, plot.y); ctx.lineTo(x0p, plot.y+plot.h); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(184,195,230,0.95)';
    ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
    ctx.fillText('Î»0', x0p+6, plot.y+6);
    ctx.restore();

    drawLegend(ctx, plot, [{label:'T_FP(Î»)', color:'rgba(122,167,255,0.95)'}]);
  }

  // Secondary plot: DBR reflectance + finesse vs N
  {
    const ctx = cSecondary.ctx;
    ctx.clearRect(0,0,rs.w,rs.h);

    // Split into two stacked plots inside same canvas: top = Rdbr vs Î», bottom = finesse vs N sweep
    const pad = 10;
    const H = rs.h - 2*pad;
    const topH = Math.floor(H*0.58);
    const botH = H - topH - 10;

    // Top plot
    const plotTop = drawAxes(ctx, {x:pad,y:pad,w:rs.w-2*pad,h:topH},
      xMin, xMax, 0, 1.0,
      'Normalized wavelength  Î»/Î»0  (dimensionless)',
      'Reflectance  R_DBR  (unitless)',
      'DBR Reflectance Spectrum');
    plotLine(ctx, plotTop, xs, Rdbr, xMin, xMax, 0, 1.0, 'rgba(99,230,190,0.95)');
    // Î»0 marker
    ctx.save();
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    ctx.setLineDash([6,6]);
    const x0p = plotTop.x + (1-xMin)/(xMax-xMin)*plotTop.w;
    ctx.beginPath(); ctx.moveTo(x0p, plotTop.y); ctx.lineTo(x0p, plotTop.y+plotTop.h); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(184,195,230,0.95)';
    ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
    ctx.fillText('Î»0', x0p+6, plotTop.y+6);
    ctx.restore();
    drawLegend(ctx, plotTop, [{label:'R_DBR(Î»)', color:'rgba(99,230,190,0.95)'}]);

    // Bottom plot: finesse vs N at Î»0
    const yMin2 = 0;
    // compute sweep
    const Ns = [];
    const Fs = [];
    let Fmax = 0;
    const Nmax = 25;
    for(let k=1;k<=Nmax;k++){
      const R0 = analyticR0(k);
      const F0 = finesseFromR(R0);
      Ns.push(k);
      Fs.push(F0);
      Fmax = Math.max(Fmax, F0);
    }
    Fmax = Math.max(5, Fmax);
    const plotBot = drawAxes(ctx, {x:pad,y:pad+topH+10,w:rs.w-2*pad,h:botH},
      1, Nmax, yMin2, Fmax*1.05,
      'DBR periods  N  (pairs)',
      'Finesse  ğ“•  (dimensionless)',
      'Finesse vs Number of DBR Periods (at Î»0)');
    // line
    plotLine(ctx, plotBot, Ns, Fs, 1, Nmax, yMin2, Fmax*1.05, 'rgba(255,209,102,0.95)');

    // highlight current N
    ctx.save();
    const xN = plotBot.x + (N-1)/(Nmax-1)*plotBot.w;
    ctx.strokeStyle = 'rgba(255,255,255,0.35)';
    ctx.setLineDash([6,6]);
    ctx.beginPath(); ctx.moveTo(xN, plotBot.y); ctx.lineTo(xN, plotBot.y+plotBot.h); ctx.stroke();
    ctx.setLineDash([]);
    ctx.fillStyle = 'rgba(184,195,230,0.95)';
    ctx.font = '12px ' + getComputedStyle(document.body).fontFamily;
    ctx.fillText('current N', xN+6, plotBot.y+6);
    ctx.restore();

    drawLegend(ctx, plotBot, [{label:'ğ“•(N) at Î»0', color:'rgba(255,209,102,0.95)'}]);
  }
}

['input','change'].forEach(evt=>{
  elN.addEventListener(evt, render);
  elM.addEventListener(evt, render);
  elSpan.addEventListener(evt, render);
  elRes.addEventListener(evt, render);
});
window.addEventListener('resize', render);

// initial
render();
</script>
</body>
</html>
