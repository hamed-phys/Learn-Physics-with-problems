<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Impulse Response of a Severely Defocused Imaging System (Stationary Phase)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#101827;
      --card:#0f172a;
      --text:#e6eaf2;
      --muted:#a9b3c7;
      --line:rgba(255,255,255,.10);
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#34d399;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius:16px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background:
        radial-gradient(1200px 600px at 20% 10%, rgba(125,211,252,.12), transparent 60%),
        radial-gradient(900px 600px at 80% 0%, rgba(167,139,250,.10), transparent 65%),
        radial-gradient(900px 700px at 60% 90%, rgba(52,211,153,.08), transparent 60%),
        var(--bg);
      line-height:1.55;
    }
    header{
      padding:32px 18px 18px;
      border-bottom:1px solid var(--line);
      position:relative;
      overflow:hidden;
    }
    header .wrap{
      max-width:1150px;
      margin:0 auto;
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:18px;
      align-items:start;
    }
    h1{
      margin:0 0 10px;
      font-size: clamp(1.4rem, 2.3vw, 2.2rem);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      margin:0 0 14px;
      font-size:1.02rem;
    }
    .quick{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:14px 14px 12px;
      box-shadow: var(--shadow);
    }
    .quick h2{
      margin:0 0 8px;
      font-size:1rem;
      letter-spacing:.2px;
      color:#dbe7ff;
    }
    .quick ul{
      margin:0;
      padding-left:18px;
      color:var(--muted);
    }
    .badgeRow{
      display:flex; flex-wrap:wrap; gap:8px; margin-top:10px;
    }
    .badge{
      font-size:.85rem;
      padding:6px 10px;
      border:1px solid var(--line);
      border-radius:999px;
      background: rgba(255,255,255,.04);
      color: #d9e3f8;
      backdrop-filter: blur(6px);
    }

    main{
      max-width:1150px;
      margin:0 auto;
      padding:18px;
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      align-items:start;
    }

    nav{
      position:sticky;
      top:14px;
      align-self:start;
      background: rgba(16,24,39,.72);
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding:12px;
      box-shadow: var(--shadow);
      backdrop-filter: blur(10px);
    }
    nav .tocTitle{
      font-size:.95rem;
      margin:0 0 10px;
      color:#dbe7ff;
      letter-spacing:.25px;
      display:flex;
      align-items:center;
      gap:8px;
    }
    nav a{
      display:block;
      color: var(--muted);
      text-decoration:none;
      padding:7px 8px;
      border-radius:10px;
      border:1px solid transparent;
      transition: transform .12s ease, background .12s ease, color .12s ease, border-color .12s ease;
      font-size:.95rem;
    }
    nav a:hover{
      background: rgba(125,211,252,.08);
      border-color: rgba(125,211,252,.20);
      color: #eaf4ff;
      transform: translateX(2px);
    }

    article{
      display:flex;
      flex-direction:column;
      gap:16px;
      min-width:0;
    }

    section{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding:16px;
      box-shadow: var(--shadow);
      position:relative;
      overflow:hidden;
    }
    section h2{
      margin:0 0 10px;
      font-size:1.15rem;
      letter-spacing:.2px;
      display:flex;
      align-items:center;
      gap:10px;
    }
    .kicker{
      font-size:.84rem;
      color:var(--muted);
      margin-top:-2px;
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
    }
    @media (max-width: 980px){
      header .wrap{grid-template-columns:1fr}
      main{grid-template-columns:1fr}
      nav{position:relative; top:auto}
      .grid2{grid-template-columns:1fr}
    }

    .callout{
      border:1px solid rgba(125,211,252,.22);
      background: rgba(125,211,252,.07);
      border-radius: 14px;
      padding:12px;
      color: #d7efff;
    }
    .warn{
      border-color: rgba(251,191,36,.25);
      background: rgba(251,191,36,.07);
      color:#fff1c7;
    }
    .note{
      border-color: rgba(167,139,250,.25);
      background: rgba(167,139,250,.07);
      color:#efe7ff;
    }

    .eqWrap{
      margin:10px 0;
      border: 1px dashed rgba(255,255,255,.18);
      background: rgba(0,0,0,.18);
      border-radius: 14px;
      padding:12px;
      position:relative;
      overflow:hidden;
    }
    .eq{
      font-family: var(--mono);
      font-size: .98rem;
      white-space: pre-wrap;
      word-break: break-word;
      margin:0;
      color:#eaf4ff;
    }
    .eq small{color:var(--muted)}
    .copyBtn{
      position:absolute;
      top:10px;
      right:10px;
      border:1px solid var(--line);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:7px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:.85rem;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .copyBtn:hover{
      transform: translateY(-1px);
      border-color: rgba(125,211,252,.35);
      background: rgba(125,211,252,.10);
    }
    .copyBtn:active{transform: translateY(0px) scale(.98)}
    .copyToast{
      position:absolute;
      top:12px;
      right:110px;
      font-size:.85rem;
      color: var(--good);
      opacity:0;
      transform: translateY(-4px);
      transition: opacity .25s ease, transform .25s ease;
      pointer-events:none;
    }
    .copyToast.show{opacity:1; transform: translateY(0px)}

    .viz{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .vizRow{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      align-items:stretch;
    }
    @media (max-width: 980px){
      .vizRow{grid-template-columns:1fr}
    }

    .canvasCard{
      background: rgba(0,0,0,.18);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:10px;
      min-width:0;
    }
    .canvasTop{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom:8px;
    }
    .canvasTitle{
      font-size:.95rem;
      margin:0;
      color:#dbe7ff;
      letter-spacing:.2px;
    }
    canvas{
      width:100%;
      height:320px;
      border-radius: 12px;
      display:block;
      background: rgba(8,12,20,.7);
      border:1px solid rgba(255,255,255,.08);
    }
    .small canvas{height:260px}

    .controls{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:12px;
      align-items:start;
      margin-top:10px;
    }
    @media (max-width: 980px){
      .controls{grid-template-columns:1fr}
    }
    .controlBox{
      background: rgba(0,0,0,.14);
      border:1px solid rgba(255,255,255,.10);
      border-radius: 14px;
      padding:12px;
    }
    .controlBox h3{
      margin:0 0 10px;
      font-size:.98rem;
      color:#dbe7ff;
    }
    .row{
      display:grid;
      grid-template-columns: 1fr 120px;
      gap:10px;
      align-items:center;
      margin:10px 0;
    }
    .row label{color:var(--muted); font-size:.93rem}
    input[type="range"]{width:100%}
    .val{
      font-family: var(--mono);
      font-size:.92rem;
      text-align:right;
      color:#eaf4ff;
      padding:6px 8px;
      border-radius: 10px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }
    .btnRow{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    .btn{
      border:1px solid rgba(255,255,255,.12);
      background: rgba(255,255,255,.06);
      color: var(--text);
      padding:8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:.9rem;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .btn:hover{
      transform: translateY(-1px);
      border-color: rgba(167,139,250,.35);
      background: rgba(167,139,250,.10);
    }
    .btn:active{transform: translateY(0px) scale(.99)}
    .metrics{
      font-family: var(--mono);
      font-size:.92rem;
      color:#eaf4ff;
      display:grid;
      gap:8px;
    }
    .metrics div{
      padding:8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(255,255,255,.04);
    }

    .boxFinal{
      border:1px solid rgba(52,211,153,.25);
      background: rgba(52,211,153,.08);
      border-radius: 16px;
      padding:14px;
      box-shadow: 0 10px 30px rgba(0,0,0,.25);
    }
    .boxFinal h3{margin:0 0 8px; color:#d9ffef; font-size:1.05rem}
    .boxFinal .eq{font-size:1.02rem}

    footer{
      max-width:1150px;
      margin:0 auto;
      padding:24px 18px 40px;
      color: var(--muted);
      font-size:.92rem;
    }
    @media print{
      body{background:#fff; color:#000}
      nav{display:none}
      section, .quick{box-shadow:none}
      canvas{border:1px solid #bbb; background:#fff}
      .copyBtn, .btnRow{display:none}
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div>
      <h1>Impulse Response of a Severely Defocused Imaging System (Wave Optics ‚Üí Stationary Phase)</h1>
      <p class="subtitle">
        Goal: show that for <em>large</em> defocus (large focusing error <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span>),
        the coherent impulse response becomes a scaled copy of the pupil function:
        <span class="eq" style="display:inline; font-family:var(--mono)">h(x,y) ‚àù p(x/(Œµ d‚ÇÇ), y/(Œµ d‚ÇÇ))</span>.
      </p>
      <div class="badgeRow">
        <span class="badge">Wave optics</span>
        <span class="badge">Generalized pupil</span>
        <span class="badge">Stationary phase</span>
        <span class="badge">Severe defocus limit</span>
      </div>
    </div>

    <aside class="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li>Coherent impulse response is a diffraction integral over the pupil with a <strong>quadratic defocus phase</strong>.</li>
        <li>When <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span> is large, the integral is highly oscillatory ‚Üí dominated by <strong>stationary phase points</strong>.</li>
        <li>The stationary point occurs at pupil coordinates
          <span class="eq" style="display:inline; font-family:var(--mono)">(u*,v*) = (‚àíx/(Œµ d‚ÇÇ), ‚àíy/(Œµ d‚ÇÇ))</span>.</li>
        <li>Therefore the amplitude is proportional to the <strong>pupil evaluated at that point</strong>:
          <span class="eq" style="display:inline; font-family:var(--mono)">h(x,y) ‚àù p(u*,v*)</span>.</li>
        <li>Up to a constant scale and phase, this gives
          <span class="eq" style="display:inline; font-family:var(--mono)">h(x,y) ‚âà p(x/(Œµ d‚ÇÇ), y/(Œµ d‚ÇÇ))</span>.</li>
      </ul>
    </aside>
  </div>
</header>

<main>
  <nav aria-label="Table of contents">
    <div class="tocTitle">üìå Table of Contents</div>
    <a href="#viz">Interactive Visualizations</a>
    <a href="#part1">PART 1 ‚Äî Problem Analysis</a>
    <a href="#part2">PART 2 ‚Äî Strategy & Tips</a>
    <a href="#part3">PART 3 ‚Äî Full Solution</a>
    <a href="#checks">Sanity Checks</a>
    <a href="#final">Final Result</a>
  </nav>

  <article>

    <!-- Visualizations -->
    <section id="viz">
      <h2>Interactive Visualizations</h2>
      <p class="kicker">
        These plots use <strong>example values</strong> (so you can see the physics). The symbolic result in the derivation remains general.
        Controls update the <em>diagram</em> and <em>both plots</em> live.
      </p>

      <div class="viz">
        <div class="vizRow">
          <div class="canvasCard small">
            <div class="canvasTop">
              <p class="canvasTitle">Diagram: pupil ‚Üí defocused image plane geometry</p>
            </div>
            <canvas id="cDiagram" aria-label="Geometry diagram"></canvas>
          </div>

          <div class="canvasCard small">
            <div class="canvasTop">
              <p class="canvasTitle">Secondary plot: approximation error vs defocus (parameter sweep)</p>
            </div>
            <canvas id="cSweep" aria-label="Error sweep plot"></canvas>
          </div>
        </div>

        <div class="canvasCard">
          <div class="canvasTop">
            <p class="canvasTitle">Main plot: cross-section of |h(x,0)| for a rectangular pupil</p>
          </div>
          <canvas id="cMain" aria-label="Main plot of impulse response"></canvas>

          <div class="controls">
            <div class="controlBox">
              <h3>Controls (example parameters)</h3>

              <div class="row">
                <label for="sEps">Defocus parameter <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span> (dimensionless in this demo model)</label>
                <div class="val" id="vEps">10.0</div>
              </div>
              <input id="sEps" type="range" min="2" max="30" step="0.1" value="10"/>

              <div class="row">
                <label for="sA">Rectangular pupil half-width <span class="eq" style="display:inline; font-family:var(--mono)">a</span> (mm)</label>
                <div class="val" id="vA">1.00</div>
              </div>
              <input id="sA" type="range" min="0.3" max="2.0" step="0.01" value="1.00"/>

              <div class="row">
                <label for="sD2">Propagation distance <span class="eq" style="display:inline; font-family:var(--mono)">d‚ÇÇ</span> (mm)</label>
                <div class="val" id="vD2">50.0</div>
              </div>
              <input id="sD2" type="range" min="10" max="120" step="1" value="50"/>

              <div class="row">
                <label for="sLam">Wavelength <span class="eq" style="display:inline; font-family:var(--mono)">Œª</span> (nm)</label>
                <div class="val" id="vLam">532</div>
              </div>
              <input id="sLam" type="range" min="400" max="800" step="1" value="532"/>

              <div class="btnRow">
                <button class="btn" id="btnReSweep">Recompute sweep</button>
                <button class="btn" id="btnReset">Reset</button>
              </div>

              <p class="kicker" style="margin:10px 0 0;">
                Demo model: coherent impulse response uses a 1D defocus integral (then squared magnitude). The stationary-phase approximation becomes a <strong>box</strong> equal to the scaled pupil.
              </p>
            </div>

            <div class="controlBox">
              <h3>Live Metrics</h3>
              <div class="metrics">
                <div>Support width prediction: <span class="eq" style="display:inline; font-family:var(--mono)" id="mWidth">‚Äî</span></div>
                <div>RMSE (exact vs approx on main plot): <span class="eq" style="display:inline; font-family:var(--mono)" id="mRMSE">‚Äî</span></div>
                <div>Stationary point at y=0: <span class="eq" style="display:inline; font-family:var(--mono)" id="mUstar">‚Äî</span></div>
              </div>
              <div class="callout note" style="margin-top:10px">
                <strong>Interpretation:</strong> As <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span> grows, the oscillatory integral localizes at the stationary point, so the output ‚Äúmaps‚Äù pupil values into image-plane coordinates.
              </div>
            </div>
          </div>

        </div>
      </div>
    </section>

    <!-- PART 1 -->
    <section id="part1">
      <h2>PART 1 ‚Äî Problem Analysis (no solving yet)</h2>

      <div class="callout">
        <strong>Problem restatement (in my words).</strong><br/>
        In coherent wave-optics imaging, the impulse response <span class="eq" style="display:inline; font-family:var(--mono)">h(x,y)</span>
        is obtained from a diffraction integral over the pupil function <span class="eq" style="display:inline; font-family:var(--mono)">p(u,v)</span>,
        modified by a defocus-dependent quadratic phase (the ‚Äúgeneralized pupil‚Äù). Show that when the defocus is severe
        (focusing error <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span> is very large),
        the impulse response is approximately a scaled version of the pupil:
        <span class="eq" style="display:inline; font-family:var(--mono)">h(x,y) ‚âà p(x/(Œµ d‚ÇÇ), y/(Œµ d‚ÇÇ))</span> (up to constant scale/phase).
      </div>

      <div class="grid2">
        <div>
          <h3 style="margin:10px 0 6px; font-size:1rem;">Given quantities</h3>
          <ul style="margin:0; color:var(--muted);">
            <li>Pupil function <span class="eq" style="display:inline; font-family:var(--mono)">p(u,v)</span> (aperture transmission in pupil coordinates).</li>
            <li>Defocus/focusing error parameter <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span> (assumed very large).</li>
            <li>Wavelength <span class="eq" style="display:inline; font-family:var(--mono)">Œª</span> and distance <span class="eq" style="display:inline; font-family:var(--mono)">d‚ÇÇ</span> from pupil to image plane (as used in the diffraction integral).</li>
            <li>Generalized pupil (defocus phase factor), consistent with the screenshot:
              <span class="eq" style="display:inline; font-family:var(--mono)">p‚ÇÅ(u,v)=p(u,v) exp(‚àíj œÄ Œµ (u¬≤+v¬≤)/Œª)</span>.</li>
          </ul>

          <h3 style="margin:12px 0 6px; font-size:1rem;">Unknowns</h3>
          <ul style="margin:0; color:var(--muted);">
            <li>Impulse response <span class="eq" style="display:inline; font-family:var(--mono)">h(x,y)</span> in the severe defocus limit.</li>
            <li>The asymptotic form of the diffraction integral for large <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span>.</li>
          </ul>
        </div>

        <div>
          <h3 style="margin:10px 0 6px; font-size:1rem;">What must be found / proved</h3>
          <ul style="margin:0; color:var(--muted);">
            <li>Show asymptotically (large <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span>) that
              <span class="eq" style="display:inline; font-family:var(--mono)">h(x,y)</span> becomes proportional to
              <span class="eq" style="display:inline; font-family:var(--mono)">p(x/(Œµ d‚ÇÇ), y/(Œµ d‚ÇÇ))</span>.</li>
            <li>Explain why stationary phase is the correct tool: the phase oscillates rapidly for large defocus.</li>
          </ul>

          <h3 style="margin:12px 0 6px; font-size:1rem;">Relevant principles and why they apply</h3>
          <ul style="margin:0; color:var(--muted);">
            <li><strong>Scalar diffraction / Fourier optics:</strong> coherent imaging impulse response is a pupil integral with phase factors (propagation + aberrations).</li>
            <li><strong>Defocus as quadratic phase:</strong> defocusing adds a quadratic phase across the pupil (generalized pupil).</li>
            <li><strong>Stationary phase method:</strong> for integrals of the form <span class="eq" style="display:inline; font-family:var(--mono)">‚à¨ A(u,v) e^{j k Œ¶(u,v)} dudv</span> with large parameter <span class="eq" style="display:inline; font-family:var(--mono)">k</span>, the dominant contribution comes from points where <span class="eq" style="display:inline; font-family:var(--mono)">‚àáŒ¶=0</span>.</li>
          </ul>
        </div>
      </div>

      <h3 style="margin:12px 0 6px; font-size:1rem;">Possible approaches (compare 2‚Äì3)</h3>
      <ol style="margin:0; color:var(--muted);">
        <li><strong>Direct evaluation</strong> of the diffraction integral (exact Fresnel integral). Works only for special pupils (Gaussian, rectangle) and still messy in 2D.</li>
        <li><strong>Geometrical optics (ray mapping)</strong>: severe defocus maps pupil coordinates to image-plane coordinates (a blur equal to the pupil). Fast intuition, but not a wave-optics proof.</li>
        <li><strong>Stationary phase (best)</strong>: gives a systematic wave-optics asymptotic limit, and reproduces the ray-mapping result including scaling and phase.</li>
      </ol>

      <div class="callout note" style="margin-top:12px">
        <strong>Chosen approach:</strong> stationary phase on the wave-optics pupil integral, because the problem explicitly hints it and because ‚Äúsevere defocus‚Äù means a rapidly varying phase.
      </div>
    </section>

    <!-- PART 2 -->
    <section id="part2">
      <h2>PART 2 ‚Äî Strategy & Tips (roadmap only)</h2>

      <ol style="margin:0; color:var(--muted);">
        <li><strong>Write the coherent impulse response integral.</strong> Goal: express <span class="eq" style="display:inline; font-family:var(--mono)">h(x,y)</span> as a 2D integral over pupil coordinates. Tool: Fourier optics model.</li>
        <li><strong>Insert the generalized pupil.</strong> Goal: include defocus via <span class="eq" style="display:inline; font-family:var(--mono)">p‚ÇÅ(u,v)=p(u,v)e^{-j(\text{quadratic})}</span>. Tool: defocus phase factor.</li>
        <li><strong>Identify the large parameter.</strong> Goal: show the phase is dominated by terms proportional to <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span>. Tool: asymptotics.</li>
        <li><strong>Compute stationary point(s).</strong> Goal: solve <span class="eq" style="display:inline; font-family:var(--mono)">‚àÇŒ¶/‚àÇu=0</span>, <span class="eq" style="display:inline; font-family:var(--mono)">‚àÇŒ¶/‚àÇv=0</span> to find <span class="eq" style="display:inline; font-family:var(--mono)">(u*,v*)</span>.</li>
        <li><strong>Apply the stationary phase formula.</strong> Goal: approximate the integral by the contribution from <span class="eq" style="display:inline; font-family:var(--mono)">(u*,v*)</span>. Tool: Hessian determinant gives amplitude scaling and a constant phase.</li>
        <li><strong>Read off the mapping.</strong> Goal: show the dependence on <span class="eq" style="display:inline; font-family:var(--mono)">(x,y)</span> enters via <span class="eq" style="display:inline; font-family:var(--mono)">p(u*,v*) = p(‚àíx/(Œµd‚ÇÇ), ‚àíy/(Œµd‚ÇÇ))</span> ‚Üí scaled pupil.</li>
        <li><strong>State the final result</strong> with ‚Äú‚àù‚Äù and explain what is absorbed into constants.</li>
      </ol>

      <div class="grid2" style="margin-top:12px;">
        <div class="callout warn">
          <strong>Common mistakes</strong>
          <ul style="margin:8px 0 0; padding-left:18px;">
            <li>Mixing up the scaling: it‚Äôs <span class="eq" style="display:inline; font-family:var(--mono)">x/(Œµ d‚ÇÇ)</span>, not <span class="eq" style="display:inline; font-family:var(--mono)">x Œµ d‚ÇÇ</span>.</li>
            <li>Forgetting the linear phase term from Fourier transforming the pupil (the term with <span class="eq" style="display:inline; font-family:var(--mono)">x u + y v</span>).</li>
            <li>Worrying about the sign: <span class="eq" style="display:inline; font-family:var(--mono)">p(‚àíu,‚àív)</span> vs <span class="eq" style="display:inline; font-family:var(--mono)">p(u,v)</span> is just an image inversion (often irrelevant for symmetric pupils).</li>
          </ul>
        </div>

        <div class="callout">
          <strong>Quick tips</strong>
          <ul style="margin:8px 0 0; padding-left:18px;">
            <li>Write the integrand as <span class="eq" style="display:inline; font-family:var(--mono)">A(u,v) e^{j k Œ¶(u,v)}</span> and keep only the <em>phase</em> inside derivatives.</li>
            <li>Stationary phase cares about where <span class="eq" style="display:inline; font-family:var(--mono)">‚àáŒ¶=0</span>, not the absolute phase prefactor.</li>
            <li>The amplitude prefactor depends on <span class="eq" style="display:inline; font-family:var(--mono)">det(Hessian)</span>, but the mapping of <span class="eq" style="display:inline; font-family:var(--mono)">p</span> is the main point.</li>
          </ul>
        </div>
      </div>
    </section>

    <!-- PART 3 -->
    <section id="part3">
      <h2>PART 3 ‚Äî Full Solution</h2>

      <h3 style="margin:10px 0 6px; font-size:1rem;">Physical intuition (before the math)</h3>
      <p style="margin:0; color:var(--muted);">
        Defocus makes the phase across the pupil vary rapidly (quadratically). In the severe-defocus limit, most pupil
        contributions cancel by destructive interference. Only those pupil points where the total phase is locally
        ‚Äúflat‚Äù (stationary) add coherently. That stationary point depends on <span class="eq" style="display:inline; font-family:var(--mono)">(x,y)</span>,
        so each image-plane location samples (approximately) one pupil location ‚Äî exactly the ray-optics ‚Äúpupil mapping‚Äù
        picture.
      </p>

      <h3 style="margin:12px 0 6px; font-size:1rem;">Step 1: Coherent impulse response as a pupil integral</h3>
      <p style="margin:0; color:var(--muted);">
        In scalar Fourier optics, the coherent impulse response at image coordinates <span class="eq" style="display:inline; font-family:var(--mono)">(x,y)</span>
        can be written (up to an overall constant) as the Fourier transform of the generalized pupil function:
      </p>

      <div class="eqWrap">
        <div class="copyToast" data-toast-for="eq1">Copied ‚úì</div>
        <button class="copyBtn" data-copy="eq1">Copy</button>
        <pre class="eq" id="eq1">h(x,y) = C ‚à¨ p‚ÇÅ(u,v) exp[ -j (2œÄ/(Œª d‚ÇÇ)) (x u + y v) ] du dv
where C is an x,y-independent constant (propagation factors, etc.).</pre>
      </div>

      <p style="margin:0; color:var(--muted);">
        Here <span class="eq" style="display:inline; font-family:var(--mono)">(u,v)</span> are coordinates in the (exit) pupil plane,
        and <span class="eq" style="display:inline; font-family:var(--mono)">d‚ÇÇ</span> is the distance (or effective propagation) from pupil to image plane.
      </p>

      <h3 style="margin:12px 0 6px; font-size:1rem;">Step 2: Insert the generalized pupil (defocus phase)</h3>
      <p style="margin:0; color:var(--muted);">
        The screenshot states a defocus-modified (generalized) pupil function:
      </p>

      <div class="eqWrap">
        <div class="copyToast" data-toast-for="eq2">Copied ‚úì</div>
        <button class="copyBtn" data-copy="eq2">Copy</button>
        <pre class="eq" id="eq2">p‚ÇÅ(u,v) = p(u,v) exp[ -j (œÄ Œµ/Œª) (u¬≤ + v¬≤) ]</pre>
      </div>

      <p style="margin:0; color:var(--muted);">
        Substituting <span class="eq" style="display:inline; font-family:var(--mono)">p‚ÇÅ</span> into the impulse response integral gives
      </p>

      <div class="eqWrap">
        <div class="copyToast" data-toast-for="eq3">Copied ‚úì</div>
        <button class="copyBtn" data-copy="eq3">Copy</button>
        <pre class="eq" id="eq3">h(x,y) = C ‚à¨ p(u,v) exp{ -j (œÄ/Œª) [ Œµ(u¬≤+v¬≤) + (2/d‚ÇÇ)(x u + y v) ] } du dv</pre>
      </div>

      <p style="margin:0; color:var(--muted);">
        The key point: for large <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span>, the phase oscillates very rapidly in <span class="eq" style="display:inline; font-family:var(--mono)">(u,v)</span>.
        That is precisely when stationary phase applies.
      </p>

      <h3 style="margin:12px 0 6px; font-size:1rem;">Step 3: Identify the phase and compute stationary points</h3>
      <p style="margin:0; color:var(--muted);">
        Define the phase function (ignoring the overall factor <span class="eq" style="display:inline; font-family:var(--mono)">‚àíœÄ/Œª</span>, which does not affect where stationarity occurs):
      </p>

      <div class="eqWrap">
        <div class="copyToast" data-toast-for="eq4">Copied ‚úì</div>
        <button class="copyBtn" data-copy="eq4">Copy</button>
        <pre class="eq" id="eq4">Œ¶(u,v) = Œµ(u¬≤+v¬≤) + (2/d‚ÇÇ)(x u + y v)</pre>
      </div>

      <p style="margin:0; color:var(--muted);">
        Stationary phase points satisfy <span class="eq" style="display:inline; font-family:var(--mono)">‚àáŒ¶ = 0</span>:
      </p>

      <div class="eqWrap">
        <div class="copyToast" data-toast-for="eq5">Copied ‚úì</div>
        <button class="copyBtn" data-copy="eq5">Copy</button>
        <pre class="eq" id="eq5">‚àÇŒ¶/‚àÇu = 2Œµu + (2x/d‚ÇÇ) = 0  ‚áí  u* = ‚àí x/(Œµ d‚ÇÇ)
‚àÇŒ¶/‚àÇv = 2Œµv + (2y/d‚ÇÇ) = 0  ‚áí  v* = ‚àí y/(Œµ d‚ÇÇ)</pre>
      </div>

      <p style="margin:0; color:var(--muted);">
        So the dominant contribution to the integral comes from the pupil point
        <span class="eq" style="display:inline; font-family:var(--mono)">(u*,v*) = (‚àíx/(Œµ d‚ÇÇ), ‚àíy/(Œµ d‚ÇÇ))</span>,
        provided this point lies inside the pupil support (otherwise the integral is strongly suppressed).
      </p>

      <h3 style="margin:12px 0 6px; font-size:1rem;">Step 4: Stationary phase approximation (2D)</h3>
      <p style="margin:0; color:var(--muted);">
        The 2D stationary phase formula says, schematically,
        <span class="eq" style="display:inline; font-family:var(--mono)">‚à¨ A(u,v) e^{‚àíj(œÄ/Œª)Œ¶(u,v)} dudv</span>
        is approximately
        <span class="eq" style="display:inline; font-family:var(--mono)">A(u*,v*)</span> times an <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span>-dependent amplitude and an overall phase,
        with the amplitude governed by the Hessian of <span class="eq" style="display:inline; font-family:var(--mono)">Œ¶</span>.
      </p>

      <p style="margin:10px 0 0; color:var(--muted);">
        Here, <span class="eq" style="display:inline; font-family:var(--mono)">A(u,v)=p(u,v)</span>, and the Hessian is simple because
        <span class="eq" style="display:inline; font-family:var(--mono)">Œ¶</span> is quadratic:
      </p>

      <div class="eqWrap">
        <div class="copyToast" data-toast-for="eq6">Copied ‚úì</div>
        <button class="copyBtn" data-copy="eq6">Copy</button>
        <pre class="eq" id="eq6">H = [ ‚àÇ¬≤Œ¶/‚àÇu¬≤   ‚àÇ¬≤Œ¶/‚àÇu‚àÇv ] = [ 2Œµ   0 ]
    [ ‚àÇ¬≤Œ¶/‚àÇv‚àÇu   ‚àÇ¬≤Œ¶/‚àÇv¬≤ ]   [ 0   2Œµ ]

det(H) = 4 Œµ¬≤</pre>
      </div>

      <p style="margin:0; color:var(--muted);">
        Therefore, the stationary-phase magnitude scales like <span class="eq" style="display:inline; font-family:var(--mono)">1/|Œµ|</span> (in 2D),
        and the <em>shape</em> is the pupil evaluated at the stationary point:
      </p>

      <div class="eqWrap">
        <div class="copyToast" data-toast-for="eq7">Copied ‚úì</div>
        <button class="copyBtn" data-copy="eq7">Copy</button>
        <pre class="eq" id="eq7">h(x,y) ‚âà K(Œµ,Œª) ¬∑ p(u*,v*) ¬∑ exp[ -j (œÄ/Œª) Œ¶(u*,v*) ]
with (u*,v*) = ( -x/(Œµ d‚ÇÇ), -y/(Œµ d‚ÇÇ) ),
and K(Œµ,Œª) absorbing constants (including 1/|Œµ| and a stationary-phase phase shift).</pre>
      </div>

      <p style="margin:0; color:var(--muted);">
        The problem‚Äôs claim is about the <strong>functional dependence</strong> on <span class="eq" style="display:inline; font-family:var(--mono)">(x,y)</span>.
        That dependence appears in <span class="eq" style="display:inline; font-family:var(--mono)">p(u*,v*)</span>, i.e.
      </p>

      <div class="eqWrap">
        <div class="copyToast" data-toast-for="eq8">Copied ‚úì</div>
        <button class="copyBtn" data-copy="eq8">Copy</button>
        <pre class="eq" id="eq8">p(u*,v*) = p( -x/(Œµ d‚ÇÇ), -y/(Œµ d‚ÇÇ) )</pre>
      </div>

      <p style="margin:0; color:var(--muted);">
        Up to a coordinate inversion (a sign flip) and an overall phase, this is the same as
        <span class="eq" style="display:inline; font-family:var(--mono)">p(x/(Œµ d‚ÇÇ), y/(Œµ d‚ÇÇ))</span>. Many pupils are even or symmetric so the sign is irrelevant,
        but even without symmetry the result simply corresponds to an image inversion.
      </p>

      <h3 style="margin:12px 0 6px; font-size:1rem;">Step 5: Extract the advertised severe-defocus form</h3>
      <div class="boxFinal" id="final">
        <h3>Final boxed result (shape)</h3>
        <div class="eqWrap" style="margin:0;">
          <div class="copyToast" data-toast-for="eqFinal">Copied ‚úì</div>
          <button class="copyBtn" data-copy="eqFinal">Copy</button>
          <pre class="eq" id="eqFinal">Severe-defocus (|Œµ| ‚â´ 1) stationary-phase result:

h(x,y) ‚àù p( x/(Œµ d‚ÇÇ), y/(Œµ d‚ÇÇ) )

More precisely:
h(x,y) ‚âà K(Œµ,Œª) ¬∑ p( -x/(Œµ d‚ÇÇ), -y/(Œµ d‚ÇÇ) ) ¬∑ exp[ -j(œÄ/Œª) Œ¶(u*,v*) ],
with (u*,v*) = ( -x/(Œµ d‚ÇÇ), -y/(Œµ d‚ÇÇ) ), and K independent of (x,y).</pre>
        </div>
      </div>
    </section>

    <!-- Checks -->
    <section id="checks">
      <h2>Sanity Checks</h2>

      <div class="grid2">
        <div class="callout">
          <strong>Units</strong>
          <p style="margin:8px 0 0; color:var(--muted);">
            The pupil coordinates <span class="eq" style="display:inline; font-family:var(--mono)">(u,v)</span> have length units.
            The stationary point <span class="eq" style="display:inline; font-family:var(--mono)">u* = ‚àíx/(Œµ d‚ÇÇ)</span> is consistent if <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span> is dimensionless in the adopted defocus normalization.
            Many texts define <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span> as a dimensionless ‚Äúdefocus coefficient‚Äù (so the quadratic phase is dimensionless), matching the given <span class="eq" style="display:inline; font-family:var(--mono)">exp(‚àíj œÄ Œµ (u¬≤+v¬≤)/Œª)</span>.
          </p>
        </div>

        <div class="callout note">
          <strong>Limiting cases</strong>
          <ul style="margin:8px 0 0; padding-left:18px; color:var(--muted);">
            <li><strong>Large defocus:</strong> support of <span class="eq" style="display:inline; font-family:var(--mono)">h</span> expands ~ <span class="eq" style="display:inline; font-family:var(--mono)">Œµ d‚ÇÇ</span> times the pupil size (a ‚Äúbig blur‚Äù).</li>
            <li><strong>Outside mapped region:</strong> if <span class="eq" style="display:inline; font-family:var(--mono)">(u*,v*)</span> lies outside the pupil, then <span class="eq" style="display:inline; font-family:var(--mono)">p(u*,v*)=0</span> and the impulse response is strongly suppressed ‚Üí consistent with the mapping picture.</li>
            <li><strong>Not severe defocus:</strong> for moderate <span class="eq" style="display:inline; font-family:var(--mono)">Œµ</span>, multiple pupil regions interfere and you do <em>not</em> get a simple scaled pupil; the full diffraction integral matters.</li>
          </ul>
        </div>
      </div>

      <div class="callout warn" style="margin-top:12px;">
        <strong>Physical interpretation</strong><br/>
        In severe defocus, the system behaves like a ‚Äúpupil projector‚Äù:
        the impulse response amplitude at <span class="eq" style="display:inline; font-family:var(--mono)">(x,y)</span> is essentially the pupil transmission at the pupil location that a ray would have originated from to reach <span class="eq" style="display:inline; font-family:var(--mono)">(x,y)</span>.
        This is why the result matches ray theory.
      </div>
    </section>

  </article>
</main>

<footer>
  <div style="max-width:1150px; margin:0 auto;">
    <div style="border-top:1px solid rgba(0,0,0,.2); padding-top:14px;">
      Built as a self-contained HTML article (no external libraries). Interactive plots are a numerical demo for intuition; the derivation above is symbolic and general.
    </div>
  </div>
</footer>

<script>
/* ------------------------------
   Utility: smooth scrolling TOC
--------------------------------*/
document.querySelectorAll('nav a').forEach(a=>{
  a.addEventListener('click', (e)=>{
    const href = a.getAttribute('href');
    if(!href || !href.startsWith('#')) return;
    e.preventDefault();
    const el = document.querySelector(href);
    if(el) el.scrollIntoView({behavior:'smooth', block:'start'});
  });
});

/* ------------------------------
   Copy buttons for equations
--------------------------------*/
function showToast(eqId){
  const toast = document.querySelector(`.copyToast[data-toast-for="${eqId}"]`);
  if(!toast) return;
  toast.classList.add('show');
  clearTimeout(toast._t);
  toast._t = setTimeout(()=>toast.classList.remove('show'), 900);
}
document.querySelectorAll('.copyBtn').forEach(btn=>{
  btn.addEventListener('click', async ()=>{
    const id = btn.getAttribute('data-copy');
    const el = document.getElementById(id);
    if(!el) return;
    const text = el.innerText.replace(/\u00A0/g,' ').trim();
    try{
      await navigator.clipboard.writeText(text);
      showToast(id);
    }catch(err){
      // Fallback
      const ta = document.createElement('textarea');
      ta.value = text;
      document.body.appendChild(ta);
      ta.select();
      try{ document.execCommand('copy'); showToast(id); }catch(e){}
      document.body.removeChild(ta);
    }
  });
});

/* ------------------------------
   Canvas plotting helpers
--------------------------------*/
function setupCanvas(canvas){
  const ctx = canvas.getContext('2d');
  function resize(){
    const dpr = window.devicePixelRatio || 1;
    const rect = canvas.getBoundingClientRect();
    canvas.width = Math.max(2, Math.floor(rect.width * dpr));
    canvas.height = Math.max(2, Math.floor(rect.height * dpr));
    ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
  }
  resize();
  return {ctx, resize};
}

function clear(ctx, w, h){
  ctx.clearRect(0,0,w,h);
}

function drawPanelBackground(ctx, w, h){
  // subtle gradient
  const g = ctx.createLinearGradient(0,0,0,h);
  g.addColorStop(0, 'rgba(255,255,255,0.04)');
  g.addColorStop(1, 'rgba(0,0,0,0.10)');
  ctx.fillStyle = g;
  ctx.fillRect(0,0,w,h);
}

function axes(ctx, box, xLabel, yLabel, title){
  const {x,y,w,h} = box;
  // title
  ctx.fillStyle = 'rgba(230,234,242,0.95)';
  ctx.font = '600 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText(title, x+6, y+16);

  // axes lines
  ctx.strokeStyle = 'rgba(255,255,255,0.22)';
  ctx.lineWidth = 1;
  ctx.beginPath();
  ctx.moveTo(x, y+h);
  ctx.lineTo(x+w, y+h);
  ctx.moveTo(x, y);
  ctx.lineTo(x, y+h);
  ctx.stroke();

  // labels
  ctx.fillStyle = 'rgba(169,179,199,0.95)';
  ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText(xLabel, x+w-ctx.measureText(xLabel).width-2, y+h-6);
  ctx.save();
  ctx.translate(x+10, y+18);
  ctx.rotate(-Math.PI/2);
  ctx.fillText(yLabel, 0, 0);
  ctx.restore();
}

function plotGrid(ctx, box, nx=6, ny=5){
  const {x,y,w,h} = box;
  ctx.strokeStyle = 'rgba(255,255,255,0.08)';
  ctx.lineWidth = 1;
  // vertical
  for(let i=1;i<nx;i++){
    const xx = x + (w*i)/nx;
    ctx.beginPath();
    ctx.moveTo(xx, y);
    ctx.lineTo(xx, y+h);
    ctx.stroke();
  }
  // horizontal
  for(let j=1;j<ny;j++){
    const yy = y + (h*j)/ny;
    ctx.beginPath();
    ctx.moveTo(x, yy);
    ctx.lineTo(x+w, yy);
    ctx.stroke();
  }
}

function ticks(ctx, box, xMin, xMax, yMin, yMax, nx=6, ny=5){
  const {x,y,w,h} = box;
  ctx.fillStyle = 'rgba(169,179,199,0.95)';
  ctx.font = '11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace';
  // x ticks
  for(let i=0;i<=nx;i++){
    const t = i/nx;
    const xv = xMin + (xMax-xMin)*t;
    const xx = x + w*t;
    ctx.strokeStyle = 'rgba(255,255,255,0.18)';
    ctx.beginPath();
    ctx.moveTo(xx, y+h);
    ctx.lineTo(xx, y+h+4);
    ctx.stroke();
    const s = formatNum(xv, 3);
    const tw = ctx.measureText(s).width;
    ctx.fillText(s, xx - tw/2, y+h+16);
  }
  // y ticks
  for(let j=0;j<=ny;j++){
    const t = j/ny;
    const yv = yMax - (yMax-yMin)*t;
    const yy = y + h*t;
    ctx.strokeStyle = 'rgba(255,255,255,0.18)';
    ctx.beginPath();
    ctx.moveTo(x-4, yy);
    ctx.lineTo(x, yy);
    ctx.stroke();
    const s = formatNum(yv, 3);
    const tw = ctx.measureText(s).width;
    ctx.fillText(s, x-8-tw, yy+4);
  }
}

function mapX(xv, xMin, xMax, box){
  return box.x + ( (xv-xMin)/(xMax-xMin) ) * box.w;
}
function mapY(yv, yMin, yMax, box){
  return box.y + (1 - ( (yv-yMin)/(yMax-yMin) )) * box.h;
}

function legend(ctx, box, items){
  // items: [{label, strokeStyle}]
  const pad = 10;
  const lineH = 16;
  const w = 210;
  const h = pad*2 + lineH*items.length;
  const x = box.x + box.w - w - 10;
  const y = box.y + 10;

  ctx.fillStyle = 'rgba(0,0,0,0.35)';
  ctx.strokeStyle = 'rgba(255,255,255,0.12)';
  ctx.lineWidth = 1;
  roundRect(ctx, x, y, w, h, 10, true, true);

  ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  items.forEach((it, i)=>{
    const yy = y + pad + i*lineH + 5;
    ctx.strokeStyle = it.strokeStyle;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(x+12, yy);
    ctx.lineTo(x+36, yy);
    ctx.stroke();

    ctx.fillStyle = 'rgba(230,234,242,0.95)';
    ctx.fillText(it.label, x+44, yy+4);
  });
}

function roundRect(ctx, x, y, w, h, r, fill, stroke){
  const rr = Math.min(r, w/2, h/2);
  ctx.beginPath();
  ctx.moveTo(x+rr, y);
  ctx.arcTo(x+w, y, x+w, y+h, rr);
  ctx.arcTo(x+w, y+h, x, y+h, rr);
  ctx.arcTo(x, y+h, x, y, rr);
  ctx.arcTo(x, y, x+w, y, rr);
  ctx.closePath();
  if(fill) ctx.fill();
  if(stroke) ctx.stroke();
}

function formatNum(v, sig=3){
  if(!isFinite(v)) return '‚Äî';
  const av = Math.abs(v);
  if(av===0) return '0';
  if(av>=1000 || av<0.01) return v.toExponential(sig-1);
  return (Math.round(v*10**sig)/10**sig).toString();
}

/* ------------------------------
   Physics demo model (1D)
   - rectangular pupil p(u)=1 for |u|<=a else 0
   - coherent field slice:
     H(x) = ‚à´_{-a}^{a} exp( -j œÄ/Œª [ Œµ u^2 + 2 (x/d2) u ] ) du
   - plotted quantity: |H(x)| normalized
   - stationary phase predicts: H(x) ‚àù p( -x/(Œµ d2) )  -> box in x with width 2 a Œµ d2
--------------------------------*/
function complex(re, im){ return {re, im}; }
function cadd(a,b){ return {re:a.re+b.re, im:a.im+b.im}; }
function cmul(a,b){ return {re:a.re*b.re - a.im*b.im, im:a.re*b.im + a.im*b.re}; }
function cabs(a){ return Math.hypot(a.re, a.im); }
function cexp(iPhase){ // exp(j*phase) where iPhase is real phase
  return {re: Math.cos(iPhase), im: Math.sin(iPhase)};
}

// Numerically integrate with trapezoid
function integrateField1D(x, a, eps, d2, lam, N=1400){
  const uMin = -a, uMax = a;
  const du = (uMax-uMin)/(N-1);
  let sum = complex(0,0);
  for(let i=0;i<N;i++){
    const u = uMin + i*du;
    // phase = - (œÄ/Œª) [ eps u^2 + 2 (x/d2) u ]
    const phase = -Math.PI/lam * (eps*u*u + 2*(x/d2)*u);
    const e = cexp(phase); // exp(j*phase) with phase already signed
    // trapezoid weight
    const w = (i===0 || i===N-1) ? 0.5 : 1.0;
    sum = cadd(sum, {re: e.re*w, im: e.im*w});
  }
  return {re: sum.re*du, im: sum.im*du};
}

function approxPupilBox(x, a, eps, d2){
  // p(-x/(eps d2)) for rectangular pupil
  const uStar = -x/(eps*d2);
  return (Math.abs(uStar) <= a) ? 1 : 0;
}

/* ------------------------------
   Plotting: Main and Sweep
--------------------------------*/
const canvDiagram = setupCanvas(document.getElementById('cDiagram'));
const canvMain = setupCanvas(document.getElementById('cMain'));
const canvSweep = setupCanvas(document.getElementById('cSweep'));

function drawDiagram(params){
  const canvas = document.getElementById('cDiagram');
  const ctx = canvDiagram.ctx;
  const w = canvas.clientWidth;
  const h = canvas.clientHeight;
  clear(ctx, w, h);
  drawPanelBackground(ctx, w, h);

  // Layout
  const leftX = 26, rightX = w-26;
  const midY = h*0.55;

  // Pupil plane line
  const pupilX = w*0.26;
  ctx.strokeStyle = 'rgba(255,255,255,0.25)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(pupilX, 36);
  ctx.lineTo(pupilX, h-30);
  ctx.stroke();

  // Pupil aperture rectangle
  const aPix = Math.min(70, (h-100)*0.22);
  ctx.fillStyle = 'rgba(125,211,252,0.18)';
  ctx.strokeStyle = 'rgba(125,211,252,0.35)';
  ctx.lineWidth = 2;
  roundRect(ctx, pupilX-10, midY-aPix, 20, 2*aPix, 8, true, true);

  // Image plane line (defocused)
  const imgX = w*0.77;
  ctx.strokeStyle = 'rgba(255,255,255,0.25)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(imgX, 36);
  ctx.lineTo(imgX, h-30);
  ctx.stroke();

  // Ideal focus plane (dashed)
  const focusX = imgX - 36;
  ctx.setLineDash([6,6]);
  ctx.strokeStyle = 'rgba(52,211,153,0.35)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  ctx.moveTo(focusX, 44);
  ctx.lineTo(focusX, h-40);
  ctx.stroke();
  ctx.setLineDash([]);

  // Rays from two pupil points to image plane
  const slopeScale = 0.55 + 0.02*(params.eps); // visual only
  const rays = [
    {u:-params.a*0.9, col:'rgba(167,139,250,0.55)'},
    {u: params.a*0.9, col:'rgba(167,139,250,0.55)'}
  ];
  rays.forEach((r,idx)=>{
    const y0 = midY + (r.u/params.a)*aPix;
    const yImg = midY + (r.u/params.a)*aPix*slopeScale;
    ctx.strokeStyle = r.col;
    ctx.lineWidth = 2;
    ctx.beginPath();
    ctx.moveTo(pupilX, y0);
    ctx.lineTo(imgX, yImg);
    ctx.stroke();
    // dot at image
    ctx.fillStyle = r.col;
    ctx.beginPath();
    ctx.arc(imgX, yImg, 3.5, 0, Math.PI*2);
    ctx.fill();
  });

  // Labels
  ctx.fillStyle = 'rgba(230,234,242,0.95)';
  ctx.font = '600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText('Pupil plane', pupilX-34, 26);
  ctx.fillText('Defocused image plane', imgX-70, 26);
  ctx.fillStyle = 'rgba(52,211,153,0.95)';
  ctx.fillText('Ideal focus plane', focusX-62, h-18);

  // d2 arrow
  const yArrow = h*0.82;
  ctx.strokeStyle = 'rgba(255,255,255,0.25)';
  ctx.lineWidth = 1.5;
  ctx.beginPath();
  ctx.moveTo(pupilX, yArrow);
  ctx.lineTo(imgX, yArrow);
  ctx.stroke();
  // arrowheads
  drawArrowHead(ctx, pupilX, yArrow, Math.PI, 'rgba(255,255,255,0.25)');
  drawArrowHead(ctx, imgX, yArrow, 0, 'rgba(255,255,255,0.25)');
  ctx.fillStyle = 'rgba(169,179,199,0.95)';
  ctx.font = '12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace';
  ctx.fillText('d‚ÇÇ', (pupilX+imgX)/2 - 8, yArrow-8);

  // eps note
  ctx.fillStyle = 'rgba(169,179,199,0.95)';
  ctx.font = '12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial';
  ctx.fillText('Defocus strength Œµ (large) ‚Üí stationary phase dominates', leftX, h-10);
}

function drawArrowHead(ctx, x, y, ang, col){
  ctx.save();
  ctx.translate(x,y);
  ctx.rotate(ang);
  ctx.fillStyle = col;
  ctx.beginPath();
  ctx.moveTo(0,0);
  ctx.lineTo(10,4);
  ctx.lineTo(10,-4);
  ctx.closePath();
  ctx.fill();
  ctx.restore();
}

function drawMainPlot(params){
  const canvas = document.getElementById('cMain');
  const ctx = canvMain.ctx;
  const W = canvas.clientWidth;
  const H = canvas.clientHeight;
  clear(ctx, W, H);
  drawPanelBackground(ctx, W, H);

  const padL=62, padR=20, padT=30, padB=44;
  const box = {x:padL, y:padT, w:W-padL-padR, h:H-padT-padB};

  // Domain in x: show a bit beyond predicted support
  const xSupport = params.eps * params.d2 * params.a; // mm * dimensionless
  const xMax = Math.max(1.0, 1.25*xSupport);
  const xMin = -xMax;

  // Compute arrays
  const M = 420;
  const xs = new Array(M);
  const exact = new Array(M);
  const approx = new Array(M);

  // Integrate exact field and normalize
  let maxVal = 0;
  for(let i=0;i<M;i++){
    const t = i/(M-1);
    const x = xMin + (xMax-xMin)*t;
    xs[i]=x;
    const Hx = integrateField1D(x, params.a, params.eps, params.d2, params.lam, params.Nint);
    const mag = cabs(Hx);
    exact[i]=mag;
    if(mag>maxVal) maxVal=mag;
    approx[i]=approxPupilBox(x, params.a, params.eps, params.d2);
  }
  if(maxVal<=0) maxVal=1;
  for(let i=0;i<M;i++) exact[i]/=maxVal;

  // For display, scale approx to match average inside support
  const insideIdx = xs.map((x, i)=> ({x,i})).filter(o=>Math.abs(o.x)<=xSupport*0.95);
  let avg=0;
  for(const o of insideIdx) avg += exact[o.i];
  avg = insideIdx.length ? avg/insideIdx.length : 1;
  const approxScaled = approx.map(v=>v*avg);

  // y-range
  const yMin = 0, yMax = 1.05;

  // Grid, axes, ticks
  plotGrid(ctx, box, 8, 6);
  axes(ctx, box, 'x (mm)', '|h(x,0)| (normalized)', 'Main plot: exact integral vs stationary-phase (scaled pupil)');
  ticks(ctx, box, xMin, xMax, yMin, yMax, 6, 5);

  // Plot exact
  ctx.strokeStyle = 'rgba(125,211,252,0.95)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<M;i++){
    const xx = mapX(xs[i], xMin, xMax, box);
    const yy = mapY(exact[i], yMin, yMax, box);
    if(i===0) ctx.moveTo(xx, yy);
    else ctx.lineTo(xx, yy);
  }
  ctx.stroke();

  // Plot approx
  ctx.strokeStyle = 'rgba(167,139,250,0.95)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<M;i++){
    const xx = mapX(xs[i], xMin, xMax, box);
    const yy = mapY(approxScaled[i], yMin, yMax, box);
    if(i===0) ctx.moveTo(xx, yy);
    else ctx.lineTo(xx, yy);
  }
  ctx.stroke();

  // Support markers
  ctx.strokeStyle = 'rgba(251,191,36,0.40)';
  ctx.lineWidth = 1.5;
  [ -xSupport, xSupport ].forEach(xv=>{
    const xx = mapX(xv, xMin, xMax, box);
    ctx.beginPath();
    ctx.moveTo(xx, box.y);
    ctx.lineTo(xx, box.y+box.h);
    ctx.stroke();
  });
  ctx.fillStyle = 'rgba(251,191,36,0.90)';
  ctx.font = '11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace';
  ctx.fillText('predicted edges ¬±(Œµ d‚ÇÇ a)', mapX(-xSupport, xMin, xMax, box)+6, box.y+14);

  legend(ctx, box, [
    {label:'Exact |h| (numerical)', strokeStyle:'rgba(125,211,252,0.95)'},
    {label:'Stationary-phase shape (scaled p)', strokeStyle:'rgba(167,139,250,0.95)'},
  ]);

  // Metrics: RMSE
  let err2=0;
  for(let i=0;i<M;i++){
    const d = exact[i] - approxScaled[i];
    err2 += d*d;
  }
  const rmse = Math.sqrt(err2/M);

  // Update metrics text
  document.getElementById('mWidth').textContent = `2¬∑a¬∑Œµ¬∑d‚ÇÇ ‚âà ${formatNum(2*params.a*params.eps*params.d2,3)} mm`;
  document.getElementById('mRMSE').textContent = `${formatNum(rmse,4)}`;
  const uStarAtY0 = `u* = -x/(Œµ d‚ÇÇ), so at x=+1mm ‚Üí u*=${formatNum(-1/(params.eps*params.d2),4)} mm`;
  document.getElementById('mUstar').textContent = uStarAtY0;

  return {xMin, xMax, rmse};
}

function drawSweepPlot(params){
  const canvas = document.getElementById('cSweep');
  const ctx = canvSweep.ctx;
  const W = canvas.clientWidth;
  const H = canvas.clientHeight;
  clear(ctx, W, H);
  drawPanelBackground(ctx, W, H);

  const padL=62, padR=18, padT=30, padB=44;
  const box = {x:padL, y:padT, w:W-padL-padR, h:H-padT-padB};

  // Sweep eps from 2 to 30
  const eMin = 2, eMax = 30;
  const K = 40;
  const es = [];
  const errs = [];

  // For speed, use fewer samples than main plot
  const M = 200;
  const Nint = Math.max(450, Math.min(900, Math.floor(params.Nint*0.55)));

  for(let k=0;k<K;k++){
    const eps = eMin + (eMax-eMin)*k/(K-1);
    // choose x-range relative to support for this eps
    const xSupport = eps * params.d2 * params.a;
    const xMax = Math.max(1.0, 1.15*xSupport);
    const xMin = -xMax;

    // compute exact and approx (normalized like main plot)
    let maxVal=0;
    const exact = new Array(M);
    const approx = new Array(M);
    const xs = new Array(M);
    for(let i=0;i<M;i++){
      const t = i/(M-1);
      const x = xMin + (xMax-xMin)*t;
      xs[i]=x;
      const Hx = integrateField1D(x, params.a, eps, params.d2, params.lam, Nint);
      const mag = cabs(Hx);
      exact[i]=mag;
      if(mag>maxVal) maxVal=mag;
      approx[i]=approxPupilBox(x, params.a, eps, params.d2);
    }
    if(maxVal<=0) maxVal=1;
    for(let i=0;i<M;i++) exact[i]/=maxVal;

    // scale approx to average inside support
    const inside = xs.map((x,i)=>({x,i})).filter(o=>Math.abs(o.x)<=xSupport*0.95);
    let avg=0;
    for(const o of inside) avg += exact[o.i];
    avg = inside.length ? avg/inside.length : 1;
    for(let i=0;i<M;i++) approx[i]*=avg;

    // RMSE
    let err2=0;
    for(let i=0;i<M;i++){
      const d = exact[i] - approx[i];
      err2 += d*d;
    }
    const rmse = Math.sqrt(err2/M);

    es.push(eps);
    errs.push(rmse);
  }

  // y range
  const yMin = 0;
  const yMax = Math.max(0.12, Math.min(0.6, 1.05*Math.max(...errs)));

  plotGrid(ctx, box, 7, 6);
  axes(ctx, box, 'Œµ (defocus strength)', 'RMSE (normalized)', 'Secondary plot: error decreases as Œµ grows');
  ticks(ctx, box, eMin, eMax, yMin, yMax, 6, 5);

  // curve
  ctx.strokeStyle = 'rgba(52,211,153,0.95)';
  ctx.lineWidth = 2;
  ctx.beginPath();
  for(let i=0;i<K;i++){
    const xx = mapX(es[i], eMin, eMax, box);
    const yy = mapY(errs[i], yMin, yMax, box);
    if(i===0) ctx.moveTo(xx, yy);
    else ctx.lineTo(xx, yy);
  }
  ctx.stroke();

  // marker at current eps
  const cur = params.eps;
  // interpolate nearest
  let idx=0, best=1e9;
  for(let i=0;i<K;i++){
    const d = Math.abs(es[i]-cur);
    if(d<best){best=d; idx=i;}
  }
  const mx = mapX(es[idx], eMin, eMax, box);
  const my = mapY(errs[idx], yMin, yMax, box);
  ctx.fillStyle = 'rgba(251,191,36,0.95)';
  ctx.beginPath();
  ctx.arc(mx, my, 4.5, 0, Math.PI*2);
  ctx.fill();
  ctx.fillStyle = 'rgba(251,191,36,0.95)';
  ctx.font = '11px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace';
  ctx.fillText(`Œµ=${formatNum(es[idx],3)} ‚Üí RMSE‚âà${formatNum(errs[idx],3)}`, mx+8, my-8);
}

/* ------------------------------
   Controls and live updates
--------------------------------*/
const sEps = document.getElementById('sEps');
const sA   = document.getElementById('sA');
const sD2  = document.getElementById('sD2');
const sLam = document.getElementById('sLam');

const vEps = document.getElementById('vEps');
const vA   = document.getElementById('vA');
const vD2  = document.getElementById('vD2');
const vLam = document.getElementById('vLam');

function getParams(){
  // units for plotting demo:
  // a in mm, d2 in mm, lam in mm
  const eps = parseFloat(sEps.value);
  const a = parseFloat(sA.value);
  const d2 = parseFloat(sD2.value);
  const lam_nm = parseFloat(sLam.value);
  const lam = lam_nm * 1e-6; // nm -> mm (since 1 mm = 1e6 nm)

  // numerical integration resolution
  const Nint = Math.floor(900 + 25*(30-eps)); // fewer oscillations at higher eps still okay; cap in integrate calls
  return {eps, a, d2, lam, lam_nm, Nint: Math.max(700, Math.min(1600, Nint))};
}

function updateLabels(p){
  vEps.textContent = formatNum(p.eps, 3);
  vA.textContent = formatNum(p.a, 3);
  vD2.textContent = formatNum(p.d2, 3);
  vLam.textContent = String(Math.round(p.lam_nm));
}

let lastMain = null;
function renderAll(recomputeSweep=false){
  const p = getParams();
  updateLabels(p);

  // resize canvases
  canvDiagram.resize();
  canvMain.resize();
  canvSweep.resize();

  drawDiagram(p);
  lastMain = drawMainPlot(p);
  if(recomputeSweep) drawSweepPlot(p);
}

[sEps,sA,sD2,sLam].forEach(el=>{
  el.addEventListener('input', ()=> renderAll(false));
});

document.getElementById('btnReSweep').addEventListener('click', ()=> renderAll(true));
document.getElementById('btnReset').addEventListener('click', ()=>{
  sEps.value = 10;
  sA.value = 1.00;
  sD2.value = 50;
  sLam.value = 532;
  renderAll(true);
});

window.addEventListener('resize', ()=> renderAll(false));

// Initial render
renderAll(true);
</script>
</body>
</html>
