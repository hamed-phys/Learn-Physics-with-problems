<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>Threshold Population Difference for an Ar+ Ion Laser (Photon Lifetime & Threshold Inversion)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --panel:#0f1624;
      --card:#121b2c;
      --text:#e8eefc;
      --muted:#a8b3cf;
      --faint:#6f7aa0;
      --line:#23304a;
      --accent:#7dd3fc;
      --accent2:#a78bfa;
      --good:#86efac;
      --warn:#fbbf24;
      --bad:#fb7185;
      --shadow: 0 10px 30px rgba(0,0,0,.35);
      --radius: 18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 900px at 20% -10%, rgba(125,211,252,.18), transparent 55%),
                  radial-gradient(1000px 800px at 90% 10%, rgba(167,139,250,.16), transparent 60%),
                  radial-gradient(900px 700px at 40% 110%, rgba(134,239,172,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding:28px 18px 10px;
      max-width:1200px;
      margin:0 auto;
    }
    .title{
      display:flex;
      align-items:flex-end;
      justify-content:space-between;
      gap:14px;
      flex-wrap:wrap;
    }
    h1{
      margin:0;
      font-size:clamp(1.4rem, 2.2vw, 2.2rem);
      letter-spacing:.2px;
    }
    .subtitle{
      margin:8px 0 0;
      color:var(--muted);
      max-width:78ch;
    }
    .layout{
      max-width:1200px;
      margin:0 auto;
      padding:14px 18px 56px;
      display:grid;
      grid-template-columns: 290px 1fr;
      gap:18px;
      align-items:start;
    }
    nav{
      position:sticky;
      top:14px;
      background: linear-gradient(180deg, rgba(18,27,44,.85), rgba(18,27,44,.70));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:14px;
      backdrop-filter: blur(10px);
    }
    nav h2{
      margin:0 0 10px;
      font-size:0.95rem;
      color:var(--muted);
      letter-spacing:.35px;
      text-transform:uppercase;
    }
    .toc a{
      display:block;
      padding:8px 10px;
      border-radius:12px;
      color:var(--text);
      font-size:0.95rem;
      border:1px solid transparent;
    }
    .toc a:hover{
      background:rgba(125,211,252,.08);
      border-color:rgba(125,211,252,.18);
      text-decoration:none;
    }

    main{
      display:flex;
      flex-direction:column;
      gap:16px;
      min-width:0;
    }

    section{
      background: linear-gradient(180deg, rgba(15,22,36,.92), rgba(15,22,36,.74));
      border:1px solid var(--line);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:18px 18px;
      backdrop-filter: blur(10px);
      overflow:hidden;
    }
    section h2{
      margin:0 0 10px;
      font-size:1.25rem;
    }
    section h3{
      margin:18px 0 8px;
      font-size:1.08rem;
      color:var(--text);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1.1fr .9fr;
      gap:14px;
      align-items:start;
    }
    @media (max-width: 980px){
      .layout{grid-template-columns: 1fr}
      nav{position:relative; top:auto}
      .grid2{grid-template-columns:1fr}
    }

    .card{
      background: linear-gradient(180deg, rgba(18,27,44,.92), rgba(18,27,44,.70));
      border:1px solid rgba(35,48,74,.9);
      border-radius:16px;
      padding:14px;
    }

    .callouts{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      margin-top:10px;
    }
    .callout{
      grid-column: span 6;
      background: rgba(18,27,44,.88);
      border:1px solid rgba(35,48,74,.95);
      border-radius:16px;
      padding:12px 12px 10px;
      position:relative;
      overflow:hidden;
    }
    .callout::before{
      content:"";
      position:absolute;
      inset:-2px -2px auto -2px;
      height:4px;
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      opacity:.9;
    }
    .callout h4{
      margin:0 0 6px;
      font-size:0.95rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.3px;
    }
    .callout ul{margin:6px 0 0 18px; color:var(--text)}
    .callout p{margin:6px 0 0; color:var(--text)}
    @media (max-width: 900px){
      .callout{grid-column: span 12;}
    }

    .eq{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      flex-wrap:wrap;
      padding:10px 12px;
      background: rgba(11,15,23,.55);
      border:1px solid rgba(35,48,74,.95);
      border-radius:14px;
      margin:10px 0;
    }
    .eq code{
      font-family:var(--mono);
      font-size:0.96rem;
      color:#eaf2ff;
      white-space:pre-wrap;
      word-break:break-word;
    }
    .btn{
      appearance:none;
      border:1px solid rgba(125,211,252,.28);
      background: rgba(125,211,252,.10);
      color:var(--text);
      padding:8px 10px;
      border-radius:12px;
      cursor:pointer;
      font-weight:600;
      transition: transform .15s ease, background .15s ease;
      user-select:none;
    }
    .btn:hover{background: rgba(125,211,252,.16)}
    .btn:active{transform: translateY(1px)}
    .btn.small{padding:6px 9px; font-size:0.9rem}
    .pill{
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:8px 10px;
      border-radius:999px;
      border:1px solid rgba(35,48,74,.95);
      background: rgba(18,27,44,.75);
      color:var(--muted);
      font-size:0.92rem;
    }
    .mono{font-family:var(--mono)}
    .muted{color:var(--muted)}
    .faint{color:var(--faint)}
    .kpi{
      display:grid;
      grid-template-columns: repeat(12, 1fr);
      gap:12px;
      margin-top:10px;
    }
    .kpi .box{
      grid-column: span 4;
      background: rgba(18,27,44,.88);
      border:1px solid rgba(35,48,74,.95);
      border-radius:16px;
      padding:12px;
      min-width:0;
    }
    .kpi .box h4{
      margin:0 0 6px;
      font-size:0.9rem;
      color:var(--muted);
      text-transform:uppercase;
      letter-spacing:.35px;
    }
    .kpi .value{
      font-size:1.25rem;
      font-weight:800;
      letter-spacing:.2px;
      margin:0;
    }
    .kpi .note{
      margin:4px 0 0;
      color:var(--faint);
      font-size:0.9rem;
    }
    @media (max-width: 900px){
      .kpi .box{grid-column: span 12;}
    }

    figure{margin:0}
    canvas{
      width:100%;
      height:340px;
      display:block;
      background: rgba(11,15,23,.35);
      border:1px solid rgba(35,48,74,.95);
      border-radius:16px;
    }
    .canvasRow{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
      margin-top:10px;
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:12px;
      margin-top:10px;
    }
    .control{
      background: rgba(18,27,44,.88);
      border:1px solid rgba(35,48,74,.95);
      border-radius:16px;
      padding:12px;
    }
    .control label{
      display:flex;
      justify-content:space-between;
      gap:10px;
      color:var(--muted);
      font-size:0.92rem;
      margin-bottom:8px;
    }
    input[type="range"]{
      width:100%;
    }
    .badge{
      font-family:var(--mono);
      color:var(--text);
      padding:2px 8px;
      border-radius:999px;
      border:1px solid rgba(125,211,252,.28);
      background: rgba(125,211,252,.10);
      white-space:nowrap;
    }

    .finalBox{
      border:1px solid rgba(134,239,172,.35);
      background: rgba(134,239,172,.08);
    }
    .finalBox::before{
      background: linear-gradient(90deg, var(--good), var(--accent));
    }

    .warnBox{
      border:1px solid rgba(251,191,36,.35);
      background: rgba(251,191,36,.08);
    }
    .warnBox::before{
      background: linear-gradient(90deg, var(--warn), var(--accent2));
    }

    footer{
      max-width:1200px;
      margin:0 auto;
      padding:0 18px 40px;
      color:var(--faint);
      font-size:0.92rem;
    }

    /* Subtle entrance */
    section{animation: rise .35s ease both;}
    @keyframes rise{
      from{opacity:0; transform: translateY(8px);}
      to{opacity:1; transform: translateY(0);}
    }

    /* Print-friendly */
    @media print{
      body{background:#fff; color:#000}
      nav{display:none}
      section, header{box-shadow:none; background:#fff; border:1px solid #ddd}
      canvas{border:1px solid #ddd; background:#fff}
      .btn{display:none}
      a{color:#000; text-decoration:underline}
    }
  </style>
</head>
<body>
<header>
  <div class="title">
    <div>
      <h1>Threshold Population Difference for an Ar<sup>+</sup> Ion Laser</h1>
      <p class="subtitle">
        We compute (a) the <b>photon lifetime</b> of a 1 m resonator with mirror reflectances 98% and 100%,
        and (b) the <b>threshold population difference</b> needed for laser action on the 515 nm transition.
      </p>
    </div>
    <div class="pill"><span>Topic:</span> <span class="mono">cavity loss ↔ gain threshold</span></div>
  </div>
</header>

<div class="layout">
  <nav aria-label="Table of contents">
    <h2>Table of Contents</h2>
    <div class="toc">
      <a href="#quick">Quick Summary</a>
      <a href="#part0">PART 0 — Concept Primer</a>
      <a href="#part1">PART 1 — Problem Analysis</a>
      <a href="#part2">PART 2 — Strategy & Tips</a>
      <a href="#part3">PART 3 — Full Solution</a>
      <a href="#part4">PART 4 — Deeper Understanding</a>
      <a href="#part5">PART 5 — Visualization Guide</a>
    </div>
  </nav>

  <main>
    <section id="quick">
      <h2>Quick Summary</h2>
      <ul>
        <li>This problem links <b>mirror losses</b> in an optical cavity to the <b>gain required at threshold</b>.</li>
        <li>Key idea: cavity energy decays each round trip by a factor <span class="mono">R1·R2</span>, giving a <b>photon lifetime</b> <span class="mono">τp</span>.</li>
        <li>Governing relations:
          <span class="mono">τp = -(2L/c)/ln(R1R2)</span> and
          <span class="mono">αcav = (1/2L) ln(1/(R1R2))</span>.</li>
        <li>Threshold condition: <span class="mono">g_th = αcav</span>, with <span class="mono">g = σ0 (N2−N1)</span>.</li>
        <li>Using a Lorentzian line: <span class="mono">σ0 = (λ^2/(4π^2 τsp Δν))</span>, where <span class="mono">Δν ≈ cΔλ/λ^2</span>.</li>
        <li>Numeric results (given data): photon lifetime <b>≈ 330 ns</b>; inversion density threshold <b>≈ 5.1×10<sup>13</sup> m<sup>−3</sup></b>.</li>
        <li>Because the lower level is essentially empty, <span class="mono">(N2−N1)_th ≈ N2_th</span>.</li>
        <li>Also reported: total threshold inverted atoms in the mode volume (1 mm diameter, 1 m length) <b>≈ 4.0×10<sup>7</sup></b>.</li>
      </ul>
    </section>

    <section id="part0">
      <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

      <div class="grid2">
        <div class="card">
          <h3>Core definitions (symbols & units)</h3>
          <ul>
            <li><b>Cavity length</b> <span class="mono">L</span> (m): distance between mirrors.</li>
            <li><b>Mirror power reflectances</b> <span class="mono">R1, R2</span> (dimensionless): fraction of optical power reflected.</li>
            <li><b>Round-trip time</b> <span class="mono">t_rt = 2L/c</span> (s): time for light to go forth and back.</li>
            <li><b>Photon lifetime</b> <span class="mono">τp</span> (s): exponential decay time of intracavity energy if gain is off.</li>
            <li><b>Loss coefficient</b> <span class="mono">αcav</span> (m<sup>−1</sup>): equivalent distributed intensity loss per meter.</li>
            <li><b>Gain coefficient</b> <span class="mono">g</span> (m<sup>−1</sup>): amplification per meter due to stimulated emission.</li>
            <li><b>Population difference</b> <span class="mono">ΔN = N2 − N1</span> (m<sup>−3</sup>): upper minus lower level density.</li>
            <li><b>Stimulated emission cross section</b> <span class="mono">σ</span> (m<sup>2</sup>): microscopic “strength” of stimulated emission.</li>
          </ul>
        </div>

        <div class="card">
          <h3>Physical meaning (what these represent)</h3>
          <ul>
            <li><span class="mono">τp</span> answers: <i>how long photons stay in the cavity</i> before escaping through output coupling (or other losses).</li>
            <li><span class="mono">αcav</span> summarizes mirror losses as if the cavity had a weak “fog” absorbing the light continuously.</li>
            <li><span class="mono">g = σΔN</span> says: more inversion (<span class="mono">ΔN</span>) or stronger transition (<span class="mono">σ</span>) gives more gain.</li>
            <li>Threshold is reached when <b>gain exactly cancels loss</b>: steady intracavity power becomes possible.</li>
          </ul>
        </div>
      </div>

      <h3>Key laws/principles & validity</h3>
      <div class="callouts">
        <div class="callout">
          <h4>Cavity decay model</h4>
          <p>
            If other losses are negligible, each round trip multiplies intracavity energy by <span class="mono">R1R2</span>.
            When <span class="mono">R1R2</span> is close to 1, this becomes an exponential decay in time.
          </p>
        </div>
        <div class="callout">
          <h4>Laser threshold condition</h4>
          <p>
            In steady-state near threshold, the small-signal gain equals the cavity loss:
            <span class="mono">g_th = αcav</span>.
            This is valid when gain saturation is negligible right at threshold.
          </p>
        </div>
      </div>

      <h3>Common models/approximations (and why we use them)</h3>
      <ul>
        <li><b>Single-pass distributed loss:</b> replace mirror loss by <span class="mono">αcav</span> so we can compare directly to gain (both in m<sup>−1</sup>).</li>
        <li><b>Group velocity ≈ c:</b> for a low-pressure gas discharge, refractive index is ~1, so speed of light in the cavity is ~c.</li>
        <li><b>Lorentzian homogeneous line:</b> using the given linewidth, we estimate the <b>peak</b> stimulated emission cross section.</li>
      </ul>

      <h3>Mini intuition examples</h3>
      <ul>
        <li>If <span class="mono">R1</span> decreases (more output coupling), photons leak faster ⇒ <span class="mono">τp</span> decreases ⇒ threshold inversion increases.</li>
        <li>If linewidth <span class="mono">Δν</span> gets broader, the peak cross section drops ⇒ more inversion is needed for the same gain.</li>
      </ul>

      <div class="callout warnBox" style="grid-column: span 12;">
        <h4>What to watch for (pitfalls)</h4>
        <ul>
          <li>Using amplitude reflectivity instead of <b>power</b> reflectance (this problem gives power reflectances).</li>
          <li>Forgetting the factor of <span class="mono">2L</span> (round-trip) in the decay model.</li>
          <li>Mixing linewidth in wavelength <span class="mono">Δλ</span> with linewidth in frequency <span class="mono">Δν</span>.</li>
          <li>Not stating whether “population difference” is per unit volume (<span class="mono">m^-3</span>) or total number in the mode volume.</li>
        </ul>
      </div>
    </section>

    <section id="part1">
      <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

      <h3>Restate the problem (in plain words)</h3>
      <p>
        An Ar<sup>+</sup> ion laser uses a 1 m long resonator with mirror reflectances 98% and 100%.
        Other cavity losses are negligible. The lasing transition is at <span class="mono">λ0 = 515 nm</span>,
        the spontaneous lifetime is <span class="mono">τsp = 10 ns</span>, and the emission linewidth is
        <span class="mono">Δλ = 0.003 nm</span>. The lower laser level decays so fast that its population is effectively zero.
        The oscillating mode has diameter 1 mm. Find:
        (a) photon lifetime <span class="mono">τp</span>, and (b) threshold population difference for laser action.
      </p>

      <div class="grid2">
        <div class="card">
          <h3>Given</h3>
          <ul>
            <li><span class="mono">L = 1.0 m</span></li>
            <li><span class="mono">R1 = 0.98</span>, <span class="mono">R2 = 1.00</span></li>
            <li><span class="mono">λ0 = 515 nm</span></li>
            <li><span class="mono">τsp = 10 ns</span></li>
            <li><span class="mono">Δλ = 0.003 nm</span></li>
            <li>Mode diameter <span class="mono">d = 1 mm</span> ⇒ radius <span class="mono">w = d/2 = 0.5 mm</span></li>
            <li>Lower level population: <span class="mono">N1 ≈ 0</span></li>
          </ul>
        </div>
        <div class="card">
          <h3>Unknowns</h3>
          <ul>
            <li>(a) Photon lifetime <span class="mono">τp</span></li>
            <li>(b) Threshold population difference <span class="mono">ΔN_th = (N2−N1)_th</span></li>
            <li>Optionally: total inverted atoms <span class="mono">ΔN_th · V_mode</span></li>
          </ul>
        </div>
      </div>

      <h3>Relevant principles (and why they apply)</h3>
      <ul>
        <li><b>Cavity ring-down</b>: With gain off, intracavity energy decays by mirror loss each round trip; other losses are negligible (explicitly stated).</li>
        <li><b>Threshold gain condition</b>: Laser action begins when small-signal gain equals loss: <span class="mono">g_th = αcav</span>.</li>
        <li><b>Cross section from lifetime + linewidth</b>: Using Einstein-A and a normalized line shape gives <span class="mono">σ0</span> from <span class="mono">τsp</span> and <span class="mono">Δν</span>.</li>
      </ul>

      <div class="callouts">
        <div class="callout">
          <h4>Assumptions (explicit)</h4>
          <ul>
            <li>Only mirror transmission causes loss (no scattering/absorption).</li>
            <li>Refractive index ≈ 1, so speed ≈ <span class="mono">c</span>.</li>
            <li>Homogeneous Lorentzian line; we use peak cross section (line center).</li>
            <li>Uniform inversion over the mode volume (for the “total number” estimate).</li>
          </ul>
        </div>
        <div class="callout">
          <h4>Why other effects are ignored</h4>
          <ul>
            <li>Gain saturation affects operation <i>above</i> threshold, not the threshold condition itself.</li>
            <li>Diffraction/beam waist details are not needed; diameter is given to estimate mode volume only.</li>
            <li>Frequency pulling/dispersion are negligible for the requested quantities.</li>
          </ul>
        </div>
      </div>

      <h3>Possible approaches (compare & choose)</h3>
      <ol>
        <li><b>Round-trip exponential decay approach</b>: write <span class="mono">U(t) = U0 (R1R2)^{t/t_rt}</span> ⇒ <span class="mono">τp</span>. <span class="muted">Pros:</span> direct, physical. <span class="muted">Cons:</span> must be careful with logs.</li>
        <li><b>Distributed loss coefficient approach</b>: define <span class="mono">αcav</span> from <span class="mono">exp(-2αL)=R1R2</span>, then <span class="mono">τp=1/(cα)</span>. <span class="muted">Pros:</span> matches laser threshold form exactly.</li>
        <li><b>Quality factor (Q) approach</b>: compute Q from losses then use <span class="mono">τp = Q/ω</span>. <span class="muted">Pros:</span> elegant; <span class="muted">Cons:</span> extra steps.</li>
      </ol>
      <p>
        <b>Best choice:</b> the distributed-loss approach, because it naturally connects (a) photon lifetime and (b) threshold gain in the same language (m<sup>−1</sup>).
      </p>
    </section>

    <section id="part2">
      <h2>PART 2 — Strategy & Tips (Roadmap Only)</h2>

      <ol>
        <li><b>Translate mirror losses to an equivalent loss coefficient</b><br/>
          Use <span class="mono">exp(-2αcav L) = R1R2</span> to get <span class="mono">αcav</span>.
          <span class="muted">Meaning:</span> loss per meter that mimics the mirrors.
        </li>
        <li><b>Compute photon lifetime</b><br/>
          Use <span class="mono">τp = 1/(c αcav)</span>.
          <span class="muted">Meaning:</span> how fast cavity energy decays with no gain.
        </li>
        <li><b>Convert linewidth in wavelength to linewidth in frequency</b><br/>
          Use <span class="mono">Δν ≈ (c/λ0^2) Δλ</span>.
          <span class="muted">Meaning:</span> bandwidth relevant to line shape in frequency domain.
        </li>
        <li><b>Estimate peak stimulated-emission cross section</b><br/>
          For Lorentzian: <span class="mono">σ0 = (λ0^2/(4π^2 τsp Δν))</span>.
          <span class="muted">Meaning:</span> microscopic gain strength at line center.
        </li>
        <li><b>Apply threshold condition</b><br/>
          Set <span class="mono">g_th = αcav</span> and <span class="mono">g = σ0 ΔN</span> ⇒ <span class="mono">ΔN_th = αcav/σ0</span>.
        </li>
        <li><b>Optional: total inversion in the mode volume</b><br/>
          Compute <span class="mono">V_mode = π (d/2)^2 L</span> and multiply by <span class="mono">ΔN_th</span>.
        </li>
      </ol>

      <div class="callout warnBox" style="grid-column: span 12;">
        <h4>Common mistakes & quick tips</h4>
        <ul>
          <li>Use <span class="mono">R</span> as <b>power</b> reflectance, not amplitude reflectivity.</li>
          <li>Remember the <b>round trip</b> is length <span class="mono">2L</span>, so mirrors act over <span class="mono">2L</span>.</li>
          <li>Use SI units consistently: nm → m, ns → s, mm → m.</li>
          <li>State clearly: <span class="mono">ΔN_th</span> is a density (m<sup>−3</sup>), and total number is density × volume.</li>
        </ul>
      </div>
    </section>

    <section id="part3">
      <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

      <h3>Physical intuition before calculating</h3>
      <p>
        A cavity with one mirror at 98% reflectance and the other essentially perfect loses ~2% of its intracavity
        power every round trip. Because the round-trip time for a 1 m cavity is only a few nanoseconds, it will take
        many round trips for the energy to decay by a factor of <span class="mono">e</span>. That suggests a photon lifetime on the order of
        <b>hundreds of nanoseconds</b>. At threshold, the gain per meter must match this weak loss per meter, giving a relatively modest
        threshold inversion density once we compute the cross section.
      </p>

      <h3>(a) Photon lifetime</h3>

      <p><b>Step 1: Round-trip energy loss</b></p>
      <p>
        Let <span class="mono">U</span> be intracavity energy. After each round trip, the energy is multiplied by <span class="mono">R1R2</span>:
        <span class="mono">U → U (R1R2)</span>.
        The round-trip time is
        <span class="mono">t_rt = 2L/c</span>.
      </p>

      <div class="eq">
        <code id="eq1">t_rt = 2L/c</code>
        <button class="btn small" data-copy="#eq1">Copy</button>
      </div>

      <p><b>Step 2: Convert discrete loss to an exponential decay</b></p>
      <p>
        After <span class="mono">n</span> round trips: <span class="mono">U_n = U0 (R1R2)^n</span>.
        At time <span class="mono">t = n t_rt</span>:
      </p>

      <div class="eq">
        <code id="eq2">U(t) = U0 (R1R2)^(t/t_rt) = U0 exp[ (t/t_rt) ln(R1R2) ]</code>
        <button class="btn small" data-copy="#eq2">Copy</button>
      </div>

      <p>
        We define photon lifetime <span class="mono">τp</span> by <span class="mono">U(t)=U0 exp(-t/τp)</span>.
        Matching exponents:
        <span class="mono">-1/τp = ln(R1R2)/t_rt</span>, so
      </p>

      <div class="eq">
        <code id="eq3">τp = - t_rt / ln(R1R2) = - (2L/c) / ln(R1R2)</code>
        <button class="btn small" data-copy="#eq3">Copy</button>
      </div>

      <p><b>Step 3: Insert numbers</b></p>
      <p>
        With <span class="mono">L=1 m</span>, <span class="mono">R1=0.98</span>, <span class="mono">R2=1.00</span>, <span class="mono">c≈3.00×10^8 m/s</span>:
        <span class="mono">R1R2 = 0.98</span>, and <span class="mono">ln(0.98) &lt; 0</span>, so <span class="mono">τp</span> is positive as it must be.
      </p>

      <div class="eq">
        <code id="eq4">τp ≈ - (2·1 / 3.00e8) / ln(0.98) ≈ 3.30×10^-7 s ≈ 330 ns</code>
        <button class="btn small" data-copy="#eq4">Copy</button>
      </div>

      <p class="muted">
        <b>Sanity checks:</b> Units: (m)/(m/s) = s. Limiting case: if <span class="mono">R1R2 → 1</span>, then <span class="mono">ln(R1R2)→0-</span> and <span class="mono">τp→∞</span> (photons live forever in a lossless cavity).
      </p>

      <h3>(b) Threshold population difference</h3>

      <p><b>Step 1: Express cavity loss as a distributed attenuation coefficient</b></p>
      <p>
        Define <span class="mono">αcav</span> such that over a round trip (distance <span class="mono">2L</span>) the intensity attenuation equals mirror losses:
      </p>

      <div class="eq">
        <code id="eq5">exp(-2 αcav L) = R1 R2  ⟹  αcav = (1/(2L)) ln(1/(R1R2))</code>
        <button class="btn small" data-copy="#eq5">Copy</button>
      </div>

      <p>
        This is the same loss that appears in the gain balance <span class="mono">g_th = αcav</span>.
        Note also the consistent relation to photon lifetime:
        <span class="mono">τp = 1/(c αcav)</span>.
      </p>

      <p><b>Step 2: Convert linewidth from wavelength to frequency</b></p>
      <p>
        For small changes, <span class="mono">ν = c/λ</span> gives <span class="mono">|dν| = (c/λ^2) |dλ|</span>. Thus:
      </p>

      <div class="eq">
        <code id="eq6">Δν ≈ (c/λ0^2) Δλ</code>
        <button class="btn small" data-copy="#eq6">Copy</button>
      </div>

      <p>
        With <span class="mono">λ0 = 515 nm = 5.15×10^-7 m</span> and <span class="mono">Δλ = 0.003 nm = 3.0×10^-12 m</span>:
        <span class="mono">Δν ≈ (3.00×10^8)(3.0×10^-12)/(5.15×10^-7)^2 ≈ 3.40×10^9 Hz</span>.
      </p>

      <p><b>Step 3: Peak stimulated emission cross section from lifetime and linewidth</b></p>
      <p>
        Using Einstein-A with a normalized Lorentzian line shape of FWHM <span class="mono">Δν</span>:
        the line-shape peak is <span class="mono">g(ν0)=2/(πΔν)</span> (units 1/Hz).
        A commonly used relation (for n≈1 and ignoring degeneracy factors) is:
      </p>

      <div class="eq">
        <code id="eq7">σ(ν) = (λ0^2/(8π)) (1/τsp) g(ν)</code>
        <button class="btn small" data-copy="#eq7">Copy</button>
      </div>

      <p>
        Therefore at line center:
      </p>

      <div class="eq">
        <code id="eq8">σ0 = σ(ν0) = (λ0^2/(8π)) (1/τsp) (2/(πΔν)) = λ0^2/(4π^2 τsp Δν)</code>
        <button class="btn small" data-copy="#eq8">Copy</button>
      </div>

      <p>
        Numerically with <span class="mono">τsp = 10 ns = 1.0×10^-8 s</span> and <span class="mono">Δν ≈ 3.40×10^9 Hz</span>:
        <span class="mono">σ0 ≈ 2.0×10^-16 m^2</span>.
      </p>

      <p><b>Step 4: Threshold gain condition</b></p>
      <p>
        Small-signal gain coefficient is <span class="mono">g = σ0 (N2−N1)</span>. At threshold:
      </p>

      <div class="eq">
        <code id="eq9">g_th = αcav  and  g_th = σ0 ΔN_th  ⟹  ΔN_th = αcav/σ0</code>
        <button class="btn small" data-copy="#eq9">Copy</button>
      </div>

      <p>
        First compute <span class="mono">αcav</span>:
        <span class="mono">αcav = (1/(2·1 m)) ln(1/0.98) ≈ 0.0101 m^-1</span>.
        Then:
        <span class="mono">ΔN_th ≈ 0.0101 / (1.98×10^-16) ≈ 5.1×10^13 m^-3</span>.
      </p>

      <div class="callout finalBox" style="grid-column: span 12;">
        <h4>Final answers (boxed)</h4>

        <div class="eq">
          <code id="ans1">Photon lifetime:  τp = - (2L/c)/ln(R1R2)  →  τp ≈ 3.30×10^-7 s ≈ 330 ns  (for R1=0.98, R2=1, L=1 m)</code>
          <button class="btn small" data-copy="#ans1">Copy</button>
        </div>

        <div class="eq">
          <code id="ans2">Threshold inversion density:  ΔN_th = αcav/σ0,  with αcav=(1/(2L))ln(1/(R1R2)),  σ0=λ0^2/(4π^2 τsp Δν),  Δν≈cΔλ/λ0^2
Numeric:  ΔN_th ≈ 5.1×10^13 m^-3  (and since N1≈0, N2_th≈ΔN_th)</code>
          <button class="btn small" data-copy="#ans2">Copy</button>
        </div>

        <div class="eq">
          <code id="ans3">Mode-volume estimate (optional):  V_mode = π(d/2)^2 L ≈ π(0.5e-3)^2·1 ≈ 7.85×10^-7 m^3
Total inverted atoms at threshold:  ΔN_th V_mode ≈ (5.1×10^13)(7.85×10^-7) ≈ 4.0×10^7</code>
          <button class="btn small" data-copy="#ans3">Copy</button>
        </div>

        <p class="muted" style="margin:8px 0 0;">
          <b>Sanity checks:</b> Units: <span class="mono">αcav</span> (m<sup>−1</sup>) divided by <span class="mono">σ0</span> (m<sup>2</sup>) gives (m<sup>−3</sup>).
          If mirror reflectance decreases, <span class="mono">αcav</span> increases ⇒ higher <span class="mono">ΔN_th</span>.
        </p>
      </div>

      <p>
        <b>Connection to geometry:</b> the mode diameter only matters for converting an inversion <i>density</i> to a <i>total number</i>
        of inverted ions in the oscillating volume. The threshold condition itself depends on cavity loss and cross section.
      </p>
    </section>

    <section id="part4">
      <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

      <h3>Re-interpreting the formulas</h3>
      <ul>
        <li><span class="mono">τp = (2L/c)/ln(1/(R1R2))</span>: longer cavities increase round-trip time, but losses per round trip are unchanged; net effect is photons live longer in longer cavities if mirror losses are fixed.</li>
        <li><span class="mono">αcav = (1/(2L)) ln(1/(R1R2))</span>: for fixed mirrors, a longer cavity spreads the same fractional round-trip loss over more meters → smaller loss per meter → easier threshold in terms of m<sup>−1</sup>.</li>
        <li><span class="mono">σ0 ∝ 1/(τsp Δν)</span>: shorter spontaneous lifetime (bigger A-coefficient) and narrower linewidth both increase peak cross section, lowering the required inversion.</li>
        <li><span class="mono">ΔN_th = αcav/σ0</span>: threshold is a “macroscopic loss” divided by a “microscopic gain strength.”</li>
      </ul>

      <h3>How changing parameters affects the outcome (linked to the interactive plots)</h3>
      <ul>
        <li><b>Decrease R1</b> (more output coupling): <span class="mono">αcav</span> increases, <span class="mono">τp</span> decreases, and <span class="mono">ΔN_th</span> rises sharply.</li>
        <li><b>Increase linewidth Δλ</b>: <span class="mono">Δν</span> increases ⇒ <span class="mono">σ0</span> decreases ⇒ <span class="mono">ΔN_th</span> increases approximately linearly with linewidth.</li>
        <li><b>Change cavity length L</b> (not plotted by default): both <span class="mono">αcav</span> and <span class="mono">τp</span> scale with 1/L and L respectively; longer L typically lowers threshold gain per meter but increases total mode volume.</li>
      </ul>

      <h3>Alternative derivation idea (brief)</h3>
      <p>
        You can compute the cavity quality factor <span class="mono">Q</span> from energy lost per cycle at frequency <span class="mono">ω</span>, then use
        <span class="mono">τp = Q/ω</span>. This is mathematically equivalent to the ring-down approach because both describe exponential energy decay.
      </p>

      <h3>Concept-check (quick self-test)</h3>
      <ul>
        <li><b>Q:</b> If both mirrors were 100% reflective, what is <span class="mono">τp</span>? <b>A:</b> It diverges (no loss), <span class="mono">τp → ∞</span>.</li>
        <li><b>Q:</b> Why does broader linewidth raise threshold? <b>A:</b> The same spontaneous rate is spread over more frequencies, reducing peak cross section and gain at line center.</li>
        <li><b>Q:</b> If the lower level is empty, what is <span class="mono">ΔN</span>? <b>A:</b> <span class="mono">ΔN = N2 − N1 ≈ N2</span>.</li>
        <li><b>Q:</b> Does mode diameter affect <span class="mono">ΔN_th</span> (m<sup>−3</sup>)? <b>A:</b> No; it only affects the total number of inverted atoms needed.</li>
      </ul>
    </section>

    <section id="part5">
      <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

      <div class="controls">
        <div class="control">
          <label>
            <span>Output-coupler reflectance <span class="mono">R1</span></span>
            <span class="badge" id="r1Badge">0.980</span>
          </label>
          <input id="r1" type="range" min="0.90" max="0.999" step="0.001" value="0.98"/>
          <div class="faint" style="margin-top:8px;">
            Lower <span class="mono">R1</span> → more loss per round trip → smaller <span class="mono">τp</span> and larger <span class="mono">ΔN_th</span>.
          </div>
        </div>
        <div class="control">
          <label>
            <span>Linewidth in wavelength <span class="mono">Δλ</span> (nm)</span>
            <span class="badge" id="dlBadge">0.003</span>
          </label>
          <input id="dl" type="range" min="0.001" max="0.020" step="0.001" value="0.003"/>
          <div class="faint" style="margin-top:8px;">
            Larger <span class="mono">Δλ</span> → larger <span class="mono">Δν</span> → smaller <span class="mono">σ0</span> → larger <span class="mono">ΔN_th</span>.
          </div>
        </div>
      </div>

      <div class="kpi">
        <div class="box">
          <h4>Photon lifetime τp</h4>
          <p class="value" id="kpiTau">—</p>
          <p class="note">Cavity ring-down time (energy e-folding).</p>
        </div>
        <div class="box">
          <h4>Threshold inversion ΔN_th</h4>
          <p class="value" id="kpiDN">—</p>
          <p class="note">Inversion density at line center.</p>
        </div>
        <div class="box">
          <h4>Total inverted atoms</h4>
          <p class="value" id="kpiNtot">—</p>
          <p class="note">Using mode diameter 1 mm, length 1 m.</p>
        </div>
      </div>

      <div class="canvasRow">
        <figure class="card">
          <h3 style="margin:0 0 8px;">Diagram: 1 m resonator and mode geometry</h3>
          <canvas id="cDiagram" aria-label="Resonator diagram"></canvas>
          <p class="muted" style="margin:10px 0 0;">
            This shows the two mirrors (R1 and R2), cavity length L, and the oscillating mode diameter (1 mm).
          </p>
        </figure>

        <figure class="card">
          <h3 style="margin:0 0 8px;">Main plot: Threshold inversion density vs mirror reflectance</h3>
          <canvas id="cMain" aria-label="Threshold inversion plot"></canvas>
          <p class="muted" style="margin:10px 0 0;">
            Curve: <span class="mono">ΔN_th(R1)</span> at fixed <span class="mono">L, λ0, τsp</span> and the selected <span class="mono">Δλ</span>.
            Marker: current slider value.
          </p>
        </figure>

        <figure class="card">
          <h3 style="margin:0 0 8px;">Secondary plot: Photon lifetime vs mirror reflectance</h3>
          <canvas id="cSecondary" aria-label="Photon lifetime plot"></canvas>
          <p class="muted" style="margin:10px 0 0;">
            Curve: <span class="mono">τp(R1)</span>. Marker: current <span class="mono">R1</span>.
          </p>
        </figure>
      </div>

      <h3>Interactive controls (what changes and why)</h3>
      <ul>
        <li><b><span class="mono">R1</span> slider:</b> changes cavity loss (<span class="mono">αcav</span>) which updates <b>all computed KPIs</b> and moves the marker on both plots.</li>
        <li><b><span class="mono">Δλ</span> slider:</b> changes linewidth, thus changing <span class="mono">Δν</span> and <span class="mono">σ0</span>, which updates the <b>threshold inversion plot</b> and KPIs (but not <span class="mono">τp</span>, since mirrors set <span class="mono">τp</span>).</li>
      </ul>

      <div class="callout">
        <h4>Reading the axes</h4>
        <ul>
          <li>Main plot y-axis is <span class="mono">ΔN_th</span> in <span class="mono">m^-3</span>.</li>
          <li>Secondary plot y-axis is <span class="mono">τp</span> in ns.</li>
          <li>x-axis is mirror reflectance <span class="mono">R1</span> (dimensionless).</li>
        </ul>
      </div>
    </section>
  </main>
</div>

<footer>
  <p>
    Notes: Cross-section estimation uses a Lorentzian homogeneous linewidth and n≈1, ignoring degeneracy factors.
    Different conventions can shift σ0 by order-unity factors; the scaling with <span class="mono">Δν</span>, <span class="mono">τsp</span>, and cavity loss is robust.
  </p>
</footer>

<script>
  // ---------- Utilities ----------
  function clamp(x,a,b){ return Math.max(a, Math.min(b,x)); }
  function fmtSci(x, sig=3){
    if (!isFinite(x) || x===0) return (x===0 ? "0" : "—");
    const e = Math.floor(Math.log10(Math.abs(x)));
    const m = x / Math.pow(10,e);
    const mm = m.toFixed(sig-1);
    return `${mm}×10^${e}`;
  }
  function fmtEng(x){
    // Simple engineering-ish formatter for seconds -> ns/us/ms
    const ax = Math.abs(x);
    if (ax < 1e-9) return `${(x*1e12).toFixed(2)} ps`;
    if (ax < 1e-6) return `${(x*1e9).toFixed(2)} ns`;
    if (ax < 1e-3) return `${(x*1e6).toFixed(2)} µs`;
    if (ax < 1) return `${(x*1e3).toFixed(2)} ms`;
    return `${x.toFixed(3)} s`;
  }

  // Copy buttons
  document.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-copy]');
    if(!btn) return;
    const sel = btn.getAttribute('data-copy');
    const el = document.querySelector(sel);
    if(!el) return;
    const text = el.textContent.trim();
    navigator.clipboard.writeText(text).then(()=>{
      const old = btn.textContent;
      btn.textContent = "Copied!";
      setTimeout(()=>btn.textContent = old, 900);
    });
  });

  // ---------- Physics model (SI units) ----------
  const c = 299792458; // m/s
  const L = 1.0;       // m
  const R2 = 1.0;
  const lambda0 = 515e-9; // m
  const tauSp = 10e-9;    // s
  const dMode = 1e-3;     // m
  const wMode = dMode/2;
  const Vmode = Math.PI*wMode*wMode*L;

  function alphaCav(R1){
    const RR = R1*R2;
    return (1/(2*L))*Math.log(1/(RR));
  }
  function tauPhoton(R1){
    const RR = R1*R2;
    // τp = -(2L/c)/ln(RR)
    return -(2*L/c)/Math.log(RR);
  }
  function dnuFromDl(dl_nm){
    const dl = dl_nm*1e-9; // nm -> m
    return (c/(lambda0*lambda0))*dl;
  }
  function sigma0(dl_nm){
    const dnu = dnuFromDl(dl_nm);
    // σ0 = λ^2/(4π^2 τsp Δν)
    return (lambda0*lambda0)/(4*Math.PI*Math.PI * tauSp * dnu);
  }
  function deltaNTh(R1, dl_nm){
    const a = alphaCav(R1);
    const s0 = sigma0(dl_nm);
    return a/s0;
  }

  // ---------- Plotting helpers ----------
  function setupCanvas(canvas){
    const ctx = canvas.getContext('2d');
    function resize(){
      const dpr = window.devicePixelRatio || 1;
      const rect = canvas.getBoundingClientRect();
      canvas.width = Math.max(2, Math.round(rect.width * dpr));
      canvas.height = Math.max(2, Math.round(rect.height * dpr));
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
    }
    resize();
    return {ctx, resize};
  }

  function clear(ctx, w, h){
    ctx.clearRect(0,0,w,h);
  }

  function drawAxes(ctx, box, xMin,xMax,yMin,yMax, xLabel, yLabel, title){
    const {x,y,w,h} = box;
    // Panel
    ctx.save();
    ctx.fillStyle = "rgba(11,15,23,0.18)";
    ctx.fillRect(x,y,w,h);

    // Title
    ctx.fillStyle = "rgba(232,238,252,0.95)";
    ctx.font = "600 14px ui-sans-serif, system-ui";
    ctx.fillText(title, x+10, y+18);

    const padL = 56, padR = 16, padT = 30, padB = 42;
    const px0 = x + padL, px1 = x + w - padR;
    const py0 = y + h - padB, py1 = y + padT;

    // Grid
    ctx.strokeStyle = "rgba(35,48,74,0.85)";
    ctx.lineWidth = 1;
    const nGrid = 6;
    for(let i=0;i<=nGrid;i++){
      const gx = px0 + (px1-px0)*i/nGrid;
      ctx.beginPath(); ctx.moveTo(gx, py0); ctx.lineTo(gx, py1); ctx.stroke();
      const gy = py0 - (py0-py1)*i/nGrid;
      ctx.beginPath(); ctx.moveTo(px0, gy); ctx.lineTo(px1, gy); ctx.stroke();
    }

    // Axes
    ctx.strokeStyle = "rgba(232,238,252,0.85)";
    ctx.lineWidth = 1.2;
    ctx.beginPath(); ctx.moveTo(px0, py0); ctx.lineTo(px1, py0); ctx.stroke();
    ctx.beginPath(); ctx.moveTo(px0, py0); ctx.lineTo(px0, py1); ctx.stroke();

    // Ticks + labels
    ctx.fillStyle = "rgba(168,179,207,0.95)";
    ctx.font = "12px ui-sans-serif, system-ui";
    for(let i=0;i<=nGrid;i++){
      const tx = px0 + (px1-px0)*i/nGrid;
      const xv = xMin + (xMax-xMin)*i/nGrid;
      ctx.beginPath(); ctx.moveTo(tx, py0); ctx.lineTo(tx, py0+5); ctx.stroke();
      ctx.fillText(xv.toFixed(3), tx-14, py0+20);
    }
    for(let i=0;i<=nGrid;i++){
      const ty = py0 - (py0-py1)*i/nGrid;
      const yv = yMin + (yMax-yMin)*i/nGrid;
      ctx.beginPath(); ctx.moveTo(px0-5, ty); ctx.lineTo(px0, ty); ctx.stroke();
      const label = (Math.abs(yMax) >= 1e5 || Math.abs(yMax) <= 1e-2) ? fmtSci(yv,3) : yv.toFixed(2);
      ctx.fillText(label, x+8, ty+4);
    }

    // Axis labels
    ctx.fillStyle = "rgba(232,238,252,0.9)";
    ctx.font = "600 12px ui-sans-serif, system-ui";
    ctx.fillText(xLabel, (px0+px1)/2 - ctx.measureText(xLabel).width/2, y+h-10);

    ctx.save();
    ctx.translate(x+14, (py0+py1)/2);
    ctx.rotate(-Math.PI/2);
    ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
    ctx.restore();

    ctx.restore();
    return {px0,px1,py0,py1, padL, padR, padT, padB};
  }

  function mapX(xv, xMin,xMax, px0,px1){
    return px0 + (xv-xMin)*(px1-px0)/(xMax-xMin);
  }
  function mapY(yv, yMin,yMax, py0,py1){
    return py0 - (yv-yMin)*(py0-py1)/(yMax-yMin);
  }

  function drawLine(ctx, xs, ys, xMin,xMax,yMin,yMax, frame){
    ctx.save();
    ctx.strokeStyle = "rgba(125,211,252,0.95)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<xs.length;i++){
      const px = mapX(xs[i], xMin,xMax, frame.px0,frame.px1);
      const py = mapY(ys[i], yMin,yMax, frame.py0,frame.py1);
      if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.stroke();
    ctx.restore();
  }

  function drawMarker(ctx, x, y, xMin,xMax,yMin,yMax, frame, color="rgba(167,139,250,0.95)"){
    const px = mapX(x, xMin,xMax, frame.px0,frame.px1);
    const py = mapY(y, yMin,yMax, frame.py0,frame.py1);
    ctx.save();
    ctx.fillStyle = color;
    ctx.beginPath(); ctx.arc(px,py,5,0,Math.PI*2); ctx.fill();
    ctx.strokeStyle = "rgba(232,238,252,0.85)";
    ctx.lineWidth = 1;
    ctx.beginPath(); ctx.arc(px,py,7,0,Math.PI*2); ctx.stroke();
    ctx.restore();
  }

  function drawLegend(ctx, x, y, items){
    ctx.save();
    ctx.font = "12px ui-sans-serif, system-ui";
    let dy = 0;
    for(const it of items){
      ctx.fillStyle = it.color;
      ctx.fillRect(x, y+dy-9, 14, 3);
      ctx.fillStyle = "rgba(232,238,252,0.9)";
      ctx.fillText(it.label, x+20, y+dy-6);
      dy += 16;
    }
    ctx.restore();
  }

  // ---------- Canvases ----------
  const diagram = setupCanvas(document.getElementById('cDiagram'));
  const mainPlot = setupCanvas(document.getElementById('cMain'));
  const secPlot = setupCanvas(document.getElementById('cSecondary'));

  function drawDiagram(R1){
    const canvas = document.getElementById('cDiagram');
    const ctx = diagram.ctx;
    const w = canvas.clientWidth, h = canvas.clientHeight;
    clear(ctx, w, h);

    const pad = 18;
    const x0 = pad, x1 = w - pad;
    const yMid = h*0.55;

    // Title band
    ctx.fillStyle = "rgba(232,238,252,0.95)";
    ctx.font = "600 14px ui-sans-serif, system-ui";
    ctx.fillText("Fabry–Pérot resonator (L = 1 m) with oscillating mode (d = 1 mm)", pad, 22);

    // Mirrors
    const mW = 18, mH = 130;
    const leftX = x0+28, rightX = x1-28;
    ctx.fillStyle = "rgba(125,211,252,0.12)";
    ctx.strokeStyle = "rgba(125,211,252,0.9)";
    ctx.lineWidth = 2;

    // Left mirror
    ctx.beginPath();
    ctx.roundRect(leftX-mW/2, yMid-mH/2, mW, mH, 8);
    ctx.fill(); ctx.stroke();

    // Right mirror
    ctx.fillStyle = "rgba(167,139,250,0.12)";
    ctx.strokeStyle = "rgba(167,139,250,0.9)";
    ctx.beginPath();
    ctx.roundRect(rightX-mW/2, yMid-mH/2, mW, mH, 8);
    ctx.fill(); ctx.stroke();

    // Optical axis & beam
    ctx.strokeStyle = "rgba(232,238,252,0.75)";
    ctx.lineWidth = 1.5;
    ctx.beginPath(); ctx.moveTo(leftX, yMid); ctx.lineTo(rightX, yMid); ctx.stroke();

    // Mode (cylinder-ish)
    const modeHalf = 28;
    ctx.fillStyle = "rgba(134,239,172,0.10)";
    ctx.strokeStyle = "rgba(134,239,172,0.9)";
    ctx.lineWidth = 1.5;
    ctx.beginPath();
    ctx.roundRect(leftX+24, yMid-modeHalf, (rightX-leftX)-48, 2*modeHalf, 16);
    ctx.fill(); ctx.stroke();

    // Labels
    ctx.fillStyle = "rgba(168,179,207,0.95)";
    ctx.font = "12px ui-sans-serif, system-ui";
    ctx.fillText(`Mirror 1: R1 = ${R1.toFixed(3)}`, leftX-40, yMid-mH/2-10);
    ctx.fillText(`Mirror 2: R2 = 1.000`, rightX-56, yMid-mH/2-10);

    // Length arrow
    const axY = yMid + mH/2 + 30;
    ctx.strokeStyle = "rgba(232,238,252,0.75)";
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.moveTo(leftX+8, axY); ctx.lineTo(rightX-8, axY);
    ctx.stroke();
    // arrowheads
    ctx.beginPath();
    ctx.moveTo(leftX+8, axY); ctx.lineTo(leftX+18, axY-6); ctx.lineTo(leftX+18, axY+6); ctx.closePath();
    ctx.fillStyle = "rgba(232,238,252,0.75)";
    ctx.fill();
    ctx.beginPath();
    ctx.moveTo(rightX-8, axY); ctx.lineTo(rightX-18, axY-6); ctx.lineTo(rightX-18, axY+6); ctx.closePath();
    ctx.fill();

    ctx.fillStyle = "rgba(232,238,252,0.9)";
    ctx.font = "600 12px ui-sans-serif, system-ui";
    ctx.fillText("Cavity length L = 1 m", (leftX+rightX)/2 - 52, axY+18);

    // Mode diameter bracket
    const bxX = (leftX+rightX)/2;
    const topY = yMid - modeHalf;
    const botY = yMid + modeHalf;
    ctx.strokeStyle = "rgba(134,239,172,0.85)";
    ctx.lineWidth = 1.2;
    ctx.beginPath();
    ctx.moveTo(bxX, topY); ctx.lineTo(bxX, botY); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(bxX-10, topY); ctx.lineTo(bxX+10, topY); ctx.stroke();
    ctx.beginPath();
    ctx.moveTo(bxX-10, botY); ctx.lineTo(bxX+10, botY); ctx.stroke();
    ctx.fillStyle = "rgba(232,238,252,0.9)";
    ctx.font = "12px ui-sans-serif, system-ui";
    ctx.fillText("Mode diameter d = 1 mm", bxX+14, yMid+4);

    // Small note
    ctx.fillStyle = "rgba(111,122,160,0.95)";
    ctx.font = "12px ui-sans-serif, system-ui";
    ctx.fillText("Lower laser level ~ empty ⇒ ΔN ≈ N2 at threshold", pad, h-18);
  }

  function drawMainPlot(R1, dl_nm){
    const canvas = document.getElementById('cMain');
    const ctx = mainPlot.ctx;
    const w = canvas.clientWidth, h = canvas.clientHeight;
    clear(ctx, w, h);

    // Sweep R1
    const xMin = 0.90, xMax = 0.999;
    const n = 220;
    const xs = [], ys = [];
    let yMax = 0, yMin = Infinity;
    for(let i=0;i<n;i++){
      const x = xMin + (xMax-xMin)*i/(n-1);
      const y = deltaNTh(x, dl_nm);
      xs.push(x);
      ys.push(y);
      yMax = Math.max(yMax, y);
      yMin = Math.min(yMin, y);
    }
    // Expand for nicer view
    yMin = Math.max(0, yMin*0.95);
    yMax = yMax*1.05;

    const frame = drawAxes(
      ctx,
      {x:10,y:10,w:w-20,h:h-20},
      xMin,xMax,yMin,yMax,
      "R1 (power reflectance)",
      "ΔN_th (m^-3)",
      "Threshold inversion density vs R1"
    );

    drawLine(ctx, xs, ys, xMin,xMax,yMin,yMax, frame);

    const yNow = deltaNTh(R1, dl_nm);
    drawMarker(ctx, R1, yNow, xMin,xMax,yMin,yMax, frame, "rgba(167,139,250,0.95)");

    // Legend
    drawLegend(ctx, frame.px0 + 10, 42, [
      {label:`ΔN_th(R1) at Δλ=${dl_nm.toFixed(3)} nm`, color:"rgba(125,211,252,0.95)"},
      {label:`current R1`, color:"rgba(167,139,250,0.95)"}
    ]);

    // Annotate value
    ctx.save();
    ctx.fillStyle = "rgba(232,238,252,0.92)";
    ctx.font = "600 12px ui-sans-serif, system-ui";
    const label = `ΔN_th ≈ ${fmtSci(yNow,3)} m^-3`;
    ctx.fillText(label, frame.px0 + 10, h-18);
    ctx.restore();
  }

  function drawSecondaryPlot(R1){
    const canvas = document.getElementById('cSecondary');
    const ctx = secPlot.ctx;
    const w = canvas.clientWidth, h = canvas.clientHeight;
    clear(ctx, w, h);

    const xMin = 0.90, xMax = 0.999;
    const n = 220;
    const xs = [], ys = [];
    let yMax = 0, yMin = Infinity;
    for(let i=0;i<n;i++){
      const x = xMin + (xMax-xMin)*i/(n-1);
      const y = tauPhoton(x); // seconds
      xs.push(x);
      ys.push(y*1e9); // ns
      yMax = Math.max(yMax, y*1e9);
      yMin = Math.min(yMin, y*1e9);
    }
    yMin = Math.max(0, yMin*0.95);
    yMax = yMax*1.05;

    const frame = drawAxes(
      ctx,
      {x:10,y:10,w:w-20,h:h-20},
      xMin,xMax,yMin,yMax,
      "R1 (power reflectance)",
      "τp (ns)",
      "Photon lifetime vs R1"
    );
    ctx.save();
    ctx.strokeStyle = "rgba(134,239,172,0.95)";
    ctx.lineWidth = 2;
    ctx.beginPath();
    for(let i=0;i<xs.length;i++){
      const px = mapX(xs[i], xMin,xMax, frame.px0,frame.px1);
      const py = mapY(ys[i], yMin,yMax, frame.py0,frame.py1);
      if(i===0) ctx.moveTo(px,py); else ctx.lineTo(px,py);
    }
    ctx.stroke();
    ctx.restore();

    const yNow = tauPhoton(R1)*1e9;
    drawMarker(ctx, R1, yNow, xMin,xMax,yMin,yMax, frame, "rgba(167,139,250,0.95)");

    drawLegend(ctx, frame.px0 + 10, 42, [
      {label:"τp(R1)", color:"rgba(134,239,172,0.95)"},
      {label:"current R1", color:"rgba(167,139,250,0.95)"}
    ]);

    ctx.save();
    ctx.fillStyle = "rgba(232,238,252,0.92)";
    ctx.font = "600 12px ui-sans-serif, system-ui";
    ctx.fillText(`τp ≈ ${yNow.toFixed(1)} ns`, frame.px0 + 10, h-18);
    ctx.restore();
  }

  function updateKPIs(R1, dl_nm){
    const tau = tauPhoton(R1);
    const a = alphaCav(R1);
    const dnu = dnuFromDl(dl_nm);
    const s0 = sigma0(dl_nm);
    const dN = a/s0;
    const Ntot = dN*Vmode;

    document.getElementById('kpiTau').textContent = `${(tau*1e9).toFixed(1)} ns`;
    document.getElementById('kpiDN').textContent = `${fmtSci(dN,3)} m^-3`;
    document.getElementById('kpiNtot').textContent = `${fmtSci(Ntot,3)} atoms`;

    // Also keep a faint detailed tooltip-like line (optional)
    // (Not shown, but could be used if you extend the page)
  }

  function renderAll(){
    const R1 = parseFloat(document.getElementById('r1').value);
    const dl_nm = parseFloat(document.getElementById('dl').value);

    document.getElementById('r1Badge').textContent = R1.toFixed(3);
    document.getElementById('dlBadge').textContent = dl_nm.toFixed(3);

    updateKPIs(R1, dl_nm);
    drawDiagram(R1);
    drawMainPlot(R1, dl_nm);
    drawSecondaryPlot(R1);
  }

  // Resize handling
  function handleResize(){
    diagram.resize();
    mainPlot.resize();
    secPlot.resize();
    renderAll();
  }
  window.addEventListener('resize', handleResize);

  // Controls
  document.getElementById('r1').addEventListener('input', renderAll);
  document.getElementById('dl').addEventListener('input', renderAll);

  // Polyfill-ish for roundRect if needed
  if (!CanvasRenderingContext2D.prototype.roundRect) {
    CanvasRenderingContext2D.prototype.roundRect = function(x,y,w,h,r){
      r = Math.min(r, w/2, h/2);
      this.beginPath();
      this.moveTo(x+r, y);
      this.arcTo(x+w, y, x+w, y+h, r);
      this.arcTo(x+w, y+h, x, y+h, r);
      this.arcTo(x, y+h, x, y, r);
      this.arcTo(x, y, x+w, y, r);
      this.closePath();
      return this;
    }
  }

  // Initial render
  renderAll();
</script>
</body>
</html>
