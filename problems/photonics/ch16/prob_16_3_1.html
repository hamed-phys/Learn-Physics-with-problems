<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Operation of an Ytterbium-Doped YAG Laser (Yb3+:YAG) — Three-Level Laser Analysis</title>
  <style>
    :root{
      --bg:#0b0f14;
      --panel:#0f1620;
      --panel2:#0c121a;
      --ink:#e8eef7;
      --muted:#b6c2d6;
      --faint:#7f90aa;
      --accent:#7dd3fc;
      --accent2:#a7f3d0;
      --warn:#fdba74;
      --ok:#86efac;
      --bad:#fda4af;
      --line:rgba(255,255,255,.10);
      --line2:rgba(255,255,255,.06);
      --shadow: 0 12px 40px rgba(0,0,0,.35);
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial, "Noto Sans", "Helvetica Neue", sans-serif;
      --radius: 18px;
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{
      margin:0;
      background: radial-gradient(1200px 700px at 20% -10%, rgba(125,211,252,.20), transparent 55%),
                  radial-gradient(900px 700px at 95% 10%, rgba(167,243,208,.14), transparent 60%),
                  radial-gradient(900px 700px at 60% 120%, rgba(253,186,116,.10), transparent 55%),
                  var(--bg);
      color:var(--ink);
      font-family:var(--sans);
      line-height:1.55;
    }
    a{color:var(--accent); text-decoration:none}
    a:hover{text-decoration:underline}
    header{
      padding: 34px 18px 18px;
      max-width: 1180px;
      margin: 0 auto;
    }
    .title{
      display:grid;
      grid-template-columns: 1.3fr .7fr;
      gap: 16px;
      align-items: start;
    }
    h1{
      margin: 0 0 10px;
      font-weight: 750;
      letter-spacing: .2px;
      font-size: clamp(1.55rem, 2.6vw, 2.4rem);
    }
    .subtitle{
      color:var(--muted);
      margin:0;
      font-size: 1.02rem;
    }
    .meta{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px 14px 12px;
      box-shadow: var(--shadow);
    }
    .meta .k{
      color:var(--faint);
      font-size:.85rem;
      margin-bottom:6px;
    }
    .meta .v{
      font-family:var(--mono);
      font-size:.95rem;
      color:var(--ink);
      white-space:nowrap;
      overflow:hidden;
      text-overflow:ellipsis;
    }

    main{
      max-width: 1180px;
      margin: 0 auto;
      padding: 0 18px 70px;
      display:grid;
      grid-template-columns: 310px 1fr;
      gap: 18px;
      align-items:start;
    }

    nav.toc{
      position: sticky;
      top: 14px;
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: var(--radius);
      padding: 14px;
      box-shadow: var(--shadow);
    }
    nav.toc h2{
      margin: 0 0 10px;
      font-size: .95rem;
      letter-spacing:.3px;
      color: var(--muted);
      text-transform: uppercase;
    }
    .toc a{
      display:block;
      padding: 8px 10px;
      border-radius: 12px;
      color: var(--ink);
      border:1px solid transparent;
      font-size:.95rem;
    }
    .toc a:hover{
      background: rgba(125,211,252,.10);
      border-color: rgba(125,211,252,.20);
      text-decoration:none;
    }
    .toc .small{
      font-size:.88rem;
      color:var(--muted);
      padding-left: 18px;
    }

    article{
      background: linear-gradient(180deg, rgba(255,255,255,.05), rgba(255,255,255,.02));
      border:1px solid var(--line);
      border-radius: var(--radius);
      padding: 18px;
      box-shadow: var(--shadow);
      overflow:hidden;
    }

    section{margin-top: 18px}
    section:first-child{margin-top:0}
    h2{
      margin: 0 0 10px;
      font-size: 1.35rem;
      letter-spacing:.2px;
    }
    h3{
      margin: 16px 0 8px;
      font-size: 1.1rem;
      color: var(--accent2);
    }
    p{margin: 8px 0}
    ul,ol{margin: 8px 0 8px 20px}
    li{margin: 6px 0}
    code, .mono{
      font-family: var(--mono);
      font-size: .95em;
      background: rgba(255,255,255,.06);
      padding: .15em .35em;
      border-radius: 8px;
      border: 1px solid rgba(255,255,255,.08);
    }

    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap: 14px;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 14px;
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
      border:1px solid var(--line2);
      border-radius: 16px;
      padding: 12px;
    }
    .callout{
      border:1px solid rgba(125,211,252,.25);
      background: rgba(125,211,252,.07);
    }
    .assumptions{
      border:1px solid rgba(167,243,208,.22);
      background: rgba(167,243,208,.07);
    }
    .mistakes{
      border:1px solid rgba(253,186,116,.25);
      background: rgba(253,186,116,.08);
    }
    .final{
      border:1px solid rgba(134,239,172,.25);
      background: rgba(134,239,172,.08);
    }
    .danger{
      border:1px solid rgba(253,164,175,.25);
      background: rgba(253,164,175,.08);
    }

    .eq{
      display:flex;
      gap:10px;
      align-items:flex-start;
      justify-content:space-between;
      margin: 10px 0;
      padding: 10px;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.10);
      background: rgba(0,0,0,.18);
    }
    .eq pre{
      margin:0;
      white-space:pre-wrap;
      word-break:break-word;
      font-family: var(--mono);
      font-size: .92rem;
      color: var(--ink);
    }
    .btn{
      appearance:none;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      padding: 8px 10px;
      border-radius: 12px;
      cursor:pointer;
      font-size:.9rem;
      transition: transform .06s ease, background .15s ease, border-color .15s ease;
      user-select:none;
      white-space:nowrap;
    }
    .btn:hover{background: rgba(125,211,252,.12); border-color: rgba(125,211,252,.28)}
    .btn:active{transform: translateY(1px)}
    .btn.small{padding:6px 8px; font-size:.85rem}
    .note{
      color: var(--muted);
      font-size: .95rem;
    }
    .kpi{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap: 10px;
      margin-top: 10px;
    }
    .kpi .item{
      border:1px solid var(--line2);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding: 10px;
    }
    .kpi .label{
      color: var(--faint);
      font-size: .85rem;
      margin-bottom:6px;
    }
    .kpi .value{
      font-family: var(--mono);
      font-size: 1rem;
    }

    figure{
      margin: 12px 0 0;
      padding: 12px;
      border-radius: 16px;
      border:1px solid var(--line2);
      background: rgba(0,0,0,.14);
    }
    figcaption{
      margin-top:10px;
      color: var(--muted);
      font-size: .92rem;
    }
    canvas{
      width:100%;
      height: 280px;
      display:block;
      border-radius: 14px;
      border:1px solid rgba(255,255,255,.08);
      background: radial-gradient(800px 320px at 30% 20%, rgba(125,211,252,.06), transparent 55%),
                  radial-gradient(700px 320px at 85% 30%, rgba(167,243,208,.05), transparent 60%),
                  rgba(255,255,255,.02);
    }
    .canvasTall{height: 330px;}
    .controls{
      display:flex;
      flex-wrap:wrap;
      gap: 10px;
      align-items:center;
      margin: 12px 0 0;
    }
    .control{
      border:1px solid var(--line2);
      background: rgba(0,0,0,.14);
      border-radius: 14px;
      padding: 10px;
      display:flex;
      gap:10px;
      align-items:center;
      flex: 1 1 240px;
      min-width: 220px;
    }
    .control label{
      font-size:.9rem;
      color: var(--muted);
      min-width: 140px;
    }
    input[type="range"]{width:100%}
    select{
      width: 100%;
      padding: 8px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      color: var(--ink);
      outline:none;
    }
    .pill{
      display:inline-block;
      padding: 2px 10px;
      border-radius: 999px;
      border:1px solid rgba(255,255,255,.14);
      background: rgba(255,255,255,.06);
      font-family: var(--mono);
      font-size: .88rem;
      color: var(--ink);
    }

    footer{
      max-width: 1180px;
      margin: 0 auto;
      padding: 14px 18px 30px;
      color: var(--muted);
      font-size: .92rem;
    }

    @media (max-width: 980px){
      main{grid-template-columns: 1fr}
      nav.toc{position: relative; top:auto}
      .title{grid-template-columns:1fr}
      .kpi{grid-template-columns:1fr}
      .grid2{grid-template-columns:1fr}
      .grid3{grid-template-columns:1fr}
    }

    @media print{
      body{background:white; color:black}
      nav.toc{display:none}
      article, .meta, figure, .card {box-shadow:none}
      canvas{border:1px solid #bbb; background:white}
      .btn{display:none}
      .eq{background:#f6f6f6}
      code, .mono{background:#f2f2f2; border-color:#ddd}
    }

    /* subtle motion, but respectful */
    @media (prefers-reduced-motion: no-preference){
      .meta, article, nav.toc, figure{animation: floatIn .35s ease both}
      @keyframes floatIn{
        from{transform: translateY(6px); opacity:0}
        to{transform: translateY(0); opacity:1}
      }
    }
  </style>
</head>
<body>
  <header>
    <div class="title">
      <div>
        <h1>16.3-1 — Operation of an Ytterbium-Doped YAG Laser (Yb<sup>3+</sup>:YAG)</h1>
        <p class="subtitle">
          A guided, theory-first solution: pump-band wavelength conversion, absorption/gain coefficients,
          cavity loss &amp; photon lifetime, and the threshold inversion for oscillation — with live, interactive plots.
        </p>
      </div>
      <div class="meta">
        <div class="k">Problem theme</div>
        <div class="v">Three-level solid-state laser • cross sections • cavity losses</div>
        <div style="height:10px"></div>
        <div class="k">Key outputs</div>
        <div class="v">λ<sub>pump</sub>, Δλ<sub>pump</sub>, α, g, α<sub>r</sub>, τ<sub>p</sub>, ΔN<sub>th</sub></div>
      </div>
    </div>
  </header>

  <main>
    <nav class="toc" aria-label="Table of Contents">
      <h2>Table of Contents</h2>
      <a href="#qs">Quick Summary</a>
      <a href="#p0">PART 0 — Concept Primer</a>
      <a href="#p1">PART 1 — Problem Analysis</a>
      <a href="#p2">PART 2 — Strategy &amp; Tips</a>
      <a href="#p3">PART 3 — Full Solution</a>
      <a class="small" href="#p3a">a) Pump band → wavelengths</a>
      <a class="small" href="#p3b">b) α and g at line center</a>
      <a class="small" href="#p3c">c) α<sub>r</sub> and τ<sub>p</sub></a>
      <a class="small" href="#p3d">d) Threshold inversion</a>
      <a class="small" href="#p3e">e) Why E<sub>3</sub> close to E<sub>2</sub></a>
      <a class="small" href="#p3f">f) If host is YVO<sub>4</sub></a>
      <a href="#p4">PART 4 — Deeper Understanding</a>
      <a href="#p5">PART 5 — Visualization Guide</a>
    </nav>

    <article>
      <!-- Quick Summary -->
      <section id="qs">
        <h2>Quick Summary</h2>
        <ul>
          <li>This problem analyzes a <b>three-level</b> Yb<sup>3+</sup>:YAG laser (pump → upper laser level → ground) and its cavity.</li>
          <li>Key physics idea: <b>energy–wavelength conversion</b> (<code>λ = hc/E</code>) and <b>net stimulated gain</b> from population difference <code>ΔN = N2 − N1</code>.</li>
          <li>Governing relations:
            <span class="mono">α(ν) ≈ σ(ν)·(N1 − N2)</span>,
            <span class="mono">g(ν) ≈ σ(ν)·(N2 − N1) = σ(ν)·ΔN</span>
            (equal degeneracy approximation).
          </li>
          <li>Cavity mirror losses can be represented as an <b>equivalent distributed loss</b>:
            <span class="mono">αr = (1/(2L)) ln(1/(R1R2))</span>.
          </li>
          <li>Photon lifetime (no internal loss): <span class="mono">τp = (2nL/c) / (−ln(R1R2))</span>.</li>
          <li>Numerical results (with given data and n≈1.82 for YAG at 1.03 μm):
            <b>λpump ≈ 940 nm</b>, <b>Δλpump ≈ 17.6 nm</b>,
            <b>α0 ≈ 2.8 cm⁻¹</b>, <b>g0 ≈ −2.8 cm⁻¹</b>,
            <b>αr ≈ 0.0186 cm⁻¹</b> (for R1=0.8,R2=1),
            <b>τp ≈ 3.3 ns</b>,
            <b>ΔNth ≈ 9.3×10¹⁷ cm⁻³</b>.
          </li>
        </ul>
      </section>

      <!-- PART 0 -->
      <section id="p0">
        <h2>PART 0 — Concept Primer (Theory Before Solving)</h2>

        <div class="grid2">
          <div class="card callout">
            <h3>Core definitions (symbols &amp; units)</h3>
            <ul>
              <li><b>Energy–wavelength</b>: <code>λ = hc/E</code> (λ in m or nm; E in J or eV). Useful constant: <code>hc ≈ 1240 eV·nm</code>.</li>
              <li><b>Stimulated-emission / absorption cross section</b> <code>σ(ν)</code> (units: cm²): “effective area” governing stimulated transition probability per photon flux.</li>
              <li><b>Population densities</b> <code>N1, N2</code> (cm⁻³): lower and upper laser-level populations; total active ion density <code>Na = N1 + N2</code> (for the two laser levels).</li>
              <li><b>Gain coefficient</b> <code>g(ν)</code> (cm⁻¹): exponential growth per unit length of intensity due to stimulated emission.</li>
              <li><b>Absorption coefficient</b> <code>α(ν)</code> (cm⁻¹): exponential decay per unit length due to absorption.</li>
              <li><b>Mirror reflectance</b> <code>R1, R2</code> (dimensionless), cavity length <code>L</code> (cm or m), refractive index <code>n</code> (dimensionless).</li>
              <li><b>Photon lifetime</b> <code>τp</code> (s): mean energy storage time of photons in the resonator.</li>
            </ul>
          </div>

          <div class="card assumptions">
            <h3>Physical meaning &amp; validity (when models work)</h3>
            <ul>
              <li><b>Cross section model</b>: Using a single peak value <code>σ0 = σ(ν0)</code> assumes we evaluate exactly at line center.</li>
              <li><b>Net gain vs absorption</b>: The same transition causes both—what matters is the <b>population difference</b> <code>ΔN = N2 − N1</code>.</li>
              <li><b>Equal degeneracy approximation</b>: We treat absorption and emission cross sections as equal at line center and ignore degeneracy factors. This is standard unless detailed spectroscopy is specified.</li>
              <li><b>Mirror-loss equivalence</b>: Converting discrete mirror loss to an equivalent distributed loss <code>αr</code> is valid for threshold and lifetime calculations.</li>
              <li><b>No scattering/extra loss</b>: Lets us attribute all photon decay to mirror transmission only.</li>
            </ul>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>Common approximations (and why we use them)</h3>
          <ul>
            <li><b>Narrowband conversion</b> for pump width: use differential relation <code>|dλ| = (hc/E²)|dE|</code> to convert ΔE → Δλ.</li>
            <li><b>Small-signal gain</b>: treat <code>g = σΔN</code> without saturation; good near threshold.</li>
            <li><b>Uniform medium</b>: assume constant populations along the rod (no longitudinal pump depletion), suitable for “first-pass” analytic design.</li>
          </ul>

          <h3>Mini intuition examples</h3>
          <ul>
            <li>If <code>N2 = 0</code> and <code>N1 = Na</code>, the medium <b>must absorb</b>: <code>g = −σNa</code> (negative gain).</li>
            <li>If you increase mirror transmission (decrease <code>R1</code>), cavity losses increase, so the needed inversion <code>ΔNth</code> increases.</li>
          </ul>

          <div class="card mistakes" style="margin-top:12px">
            <h3>What to watch for (pitfalls)</h3>
            <ul>
              <li>Mixing <b>energy width</b> ΔE with <b>frequency width</b> Δν without conversion.</li>
              <li>Forgetting that <b>λ decreases when E increases</b> (negative derivative); usually you want magnitudes.</li>
              <li>Confusing <b>mirror reflectance</b> with “loss coefficient” — you must convert using logs.</li>
              <li>In three-level lasers, <b>positive gain requires N2 &gt; Na/2</b> (more than half the ions moved out of the ground state).</li>
            </ul>
          </div>
        </div>
      </section>

      <!-- PART 1 -->
      <section id="p1">
        <h2>PART 1 — Problem Analysis (No Solving Yet)</h2>

        <p>
          We are given a Yb<sup>3+</sup>:YAG three-level laser operating at <b>λ<sub>0</sub> = 1.030 μm</b> on the
          <span class="mono"><sup>2</sup>F<sub>5/2</sub> → <sup>2</sup>F<sub>7/2</sub></span> transition.
          The system is pumped optically via a pump band (level ③) with specified <b>central energy</b> and <b>width</b>.
          We must compute pump diode wavelength specs, absorption/gain coefficients at line center,
          cavity mirror-loss equivalents (α<sub>r</sub>) and photon lifetime τ<sub>p</sub>, and finally the
          threshold inversion (population difference) for oscillation.
        </p>

        <div class="grid2">
          <div class="card">
            <h3>Given quantities</h3>
            <ul>
              <li>Pump band center energy: <code>E3 = 1.31915 eV</code></li>
              <li>Pump band energy width: <code>ΔE = 0.02475 eV</code></li>
              <li>Laser line center cross section: <code>σ0 = 2.0×10^-20 cm^2</code></li>
              <li>Yb<sup>3+</sup> doping density: <code>Na = 1.4×10^20 cm^-3</code></li>
              <li>Rod length: <code>L = 6 cm</code>, diameter <code>d = 2 mm</code> (geometry mostly for diagram; losses ignore area)</li>
              <li>Mirrors: <code>R1 = 0.8</code>, <code>R2 = 1.0</code>, no other losses</li>
              <li>Thermal equilibrium: <code>T = 300 K</code> (i.e., no pumping → essentially all in ground laser level)</li>
            </ul>
          </div>

          <div class="card">
            <h3>Unknowns / what must be found</h3>
            <ul>
              <li>(a) Pump diode center wavelength <code>λpump</code> and absorption-band width <code>Δλpump</code> (nm)</li>
              <li>(b) Absorption coefficient <code>α(ν0)</code> and gain coefficient <code>g(ν0)</code> at line center</li>
              <li>(c) Resonator loss coefficient <code>αr</code> and photon lifetime <code>τp</code></li>
              <li>(d) Threshold population difference <code>ΔNth</code> (and implied upper-level population)</li>
              <li>(e) Conceptual: why level ③ energy close to level ② helps</li>
              <li>(f) Conceptual: differences if host is YVO<sub>4</sub> instead of YAG</li>
            </ul>
          </div>
        </div>

        <div class="card assumptions" style="margin-top:14px">
          <h3>Relevant principles &amp; why they apply</h3>
          <ul>
            <li><b>Energy ↔ wavelength conversion</b>: pump diode specification depends on matching absorption band.</li>
            <li><b>Beer–Lambert law</b>: intensity change in medium: <code>I(z)=I0 exp[(g−α)z]</code>; at line center we evaluate using <code>σ0</code>.</li>
            <li><b>Laser threshold condition</b>: net gain per pass compensates cavity losses; mirror reflectances set the required gain.</li>
            <li><b>Cavity photon lifetime</b>: energy decays exponentially with per-round-trip loss; relates to log loss.</li>
          </ul>
        </div>

        <div class="card">
          <h3>Possible approaches (and best choice)</h3>
          <ol>
            <li><b>Differential conversion approach</b> (best for part a): use <code>λ = hc/E</code> and <code>Δλ ≈ (hc/E^2)ΔE</code>. Fast and accurate for modest bandwidths.</li>
            <li><b>Full spectral modeling</b>: assume a lineshape (Gaussian/Lorentzian), convert ΔE to Δν, then to Δλ. More detailed but unnecessary because only widths are requested.</li>
            <li><b>Round-trip gain equation</b> (best for parts c–d): write round-trip intensity condition using <code>R1R2 exp[2(g−α_i)L]=1</code>, then solve for required <code>g</code> and thus <code>ΔN</code>.</li>
          </ol>
          <p class="note">
            We will use the <b>differential conversion</b> for pump bandwidth and the <b>round-trip log-loss</b> model
            for cavity loss and threshold. This is the cleanest path with the given data.
          </p>
        </div>
      </section>

      <!-- PART 2 -->
      <section id="p2">
        <h2>PART 2 — Strategy &amp; Tips (Roadmap Only)</h2>
        <ol>
          <li>
            <b>Convert pump energy to wavelength</b><br/>
            Tool: <code>λ = (hc)/E</code> with <code>hc ≈ 1240 eV·nm</code><br/>
            Meaning: selects the diode center wavelength that best overlaps the absorption band.
          </li>
          <li>
            <b>Convert energy width to wavelength width</b><br/>
            Tool: <code>|Δλ| ≈ (hc/E^2)|ΔE|</code><br/>
            Meaning: tells how “broad” the absorption feature is in nm (diode spectral tolerance).
          </li>
          <li>
            <b>Compute absorption/gain at line center in thermal equilibrium</b><br/>
            Tool: <code>g0 = σ0(N2 − N1)</code>, <code>α0 = σ0(N1 − N2)</code><br/>
            Meaning: with essentially all ions in the lower level, the medium absorbs strongly at ν0.
          </li>
          <li>
            <b>Convert mirror losses to equivalent distributed loss</b><br/>
            Tool: <code>αr = (1/(2L)) ln(1/(R1R2))</code><br/>
            Meaning: “how much per cm” the cavity loses due to mirrors.
          </li>
          <li>
            <b>Compute photon lifetime</b><br/>
            Tool: <code>τp = (2nL/c)/(−ln(R1R2))</code> (no internal loss)<br/>
            Meaning: sets dynamical timescales (build-up/decay of intracavity photons).
          </li>
          <li>
            <b>Threshold inversion</b><br/>
            Tool: <code>gth = αr</code>, so <code>ΔNth = αr/σ0</code><br/>
            Meaning: minimum population difference needed to start oscillation.
          </li>
          <li>
            <b>Interpretation questions (e–f)</b><br/>
            Tool: energy efficiency (quantum defect), thermal loading, host spectroscopy/thermal properties.
          </li>
        </ol>

        <div class="card mistakes">
          <h3>Common mistakes &amp; quick tips</h3>
          <ul>
            <li><b>Tip:</b> Use nm consistently in part (a): keep <code>hc = 1240 eV·nm</code> to avoid unit slips.</li>
            <li><b>Mistake:</b> Using <code>αr = (1/L)ln(1/(R1R2))</code> (missing the factor 2). Mirror loss occurs per <b>round trip</b>, length <b>2L</b>.</li>
            <li><b>Tip:</b> For three-level lasers, check: does your computed <code>N2_th</code> exceed <code>Na/2</code>? It must.</li>
          </ul>
        </div>
      </section>

      <!-- PART 3 -->
      <section id="p3">
        <h2>PART 3 — Full Solution (Detailed + Teaching)</h2>

        <div class="card callout">
          <h3>Qualitative expectation (before calculating)</h3>
          <ul>
            <li>The pump band energy around ~1.3 eV corresponds to a wavelength in the near-IR (roughly 900–1000 nm), consistent with common Yb pumping near ~940 nm.</li>
            <li>At thermal equilibrium (no pump), almost all ions remain in the ground laser level → the material behaves as an <b>absorber</b> at the laser wavelength: net gain should be negative.</li>
            <li>A mirror with <code>R1=0.8</code> is quite “leaky” compared to a high-reflector, so cavity losses should be modest but not tiny; threshold inversion will be nonzero but small compared to <code>Na</code>.</li>
          </ul>
        </div>

        <!-- a -->
        <section id="p3a">
          <h3>a) Pump band: free-space diode wavelength and absorption width</h3>

          <p>
            We’re given the pump-band (level ③) center energy:
            <code>E3 = 1.31915 eV</code>, with width <code>ΔE = 0.02475 eV</code>.
            The free-space photon wavelength is related to energy by:
          </p>

          <div class="eq">
            <pre id="eqA">λ = hc / E
with hc ≈ 1240 eV·nm</pre>
            <button class="btn small" data-copy="#eqA">Copy</button>
          </div>

          <p><b>Center wavelength</b></p>
          <p>
            <code>λpump = 1240 / 1.31915 nm</code>.
            Numerically:
          </p>

          <div class="eq">
            <pre id="eqA2">λpump ≈ 940.2 nm</pre>
            <button class="btn small" data-copy="#eqA2">Copy</button>
          </div>

          <p>
            Next, convert the energy width to a wavelength width. Differentiate <code>λ = hc/E</code>:
            <code>dλ = -(hc/E^2)dE</code>. For a modest width, use magnitude:
          </p>

          <div class="eq">
            <pre id="eqA3">Δλ ≈ (hc/E^2) ΔE  (use magnitudes)</pre>
            <button class="btn small" data-copy="#eqA3">Copy</button>
          </div>

          <p>
            Plug in numbers:
            <code>Δλ ≈ 1240*(0.02475)/(1.31915^2) nm</code> ≈ <b>17.6 nm</b>.
          </p>

          <div class="card final">
            <h3>Answer (a)</h3>
            <div class="eq">
              <pre id="ansA">Pump-diode center wavelength: λpump ≈ 940 nm
Absorption-band width: Δλpump ≈ 17.6 nm (about ±8.8 nm half-width)</pre>
              <button class="btn" data-copy="#ansA">Copy final (a)</button>
            </div>

            <p class="note">
              <b>Sanity check:</b> 940 nm is the standard pump region for Yb:YAG. Width ~18 nm is a realistic diode-array matching tolerance.
            </p>
          </div>
        </section>

        <!-- b -->
        <section id="p3b">
          <h3>b) Absorption and gain coefficients at ν<sub>0</sub> (thermal equilibrium)</h3>

          <p>
            At the laser transition frequency ν<sub>0</sub>, the peak cross section is given:
            <code>σ0 = 2.0×10^-20 cm^2</code>.
            The Yb<sup>3+</sup> doping density is <code>Na = 1.4×10^20 cm^-3</code>.
          </p>

          <p>
            In the simplest two-level net-gain model (equal degeneracy, emission and absorption cross sections equal at line center),
            the <b>net small-signal gain coefficient</b> is:
          </p>

          <div class="eq">
            <pre id="eqB">g(ν0) = σ0 (N2 − N1) = σ0 ΔN
α(ν0) = σ0 (N1 − N2) = −g(ν0)</pre>
            <button class="btn small" data-copy="#eqB">Copy</button>
          </div>

          <p>
            At <b>thermal equilibrium with no pumping</b>, essentially all ions are in the lower laser level:
            <code>N1 ≈ Na</code>, <code>N2 ≈ 0</code>. Therefore:
          </p>

          <p class="mono">
            g0 = σ0(0 − Na) = −σ0 Na
          </p>

          <p>Compute:</p>
          <p class="mono">
            σ0 Na = (2.0×10^-20 cm^2)(1.4×10^20 cm^-3) = 2.8 cm^-1
          </p>

          <div class="card final">
            <h3>Answer (b)</h3>
            <div class="eq">
              <pre id="ansB">At thermal equilibrium (N1≈Na, N2≈0):
α(ν0) ≈ +2.8 cm^-1
g(ν0) ≈ −2.8 cm^-1  (negative gain = absorption)</pre>
              <button class="btn" data-copy="#ansB">Copy final (b)</button>
            </div>
            <p class="note">
              <b>Sign check:</b> With no inversion (N2&lt;N1), the medium must attenuate → gain is negative.
            </p>
          </div>
        </section>

        <!-- c -->
        <section id="p3c">
          <h3>c) Resonator loss coefficient α<sub>r</sub> and photon lifetime τ<sub>p</sub></h3>

          <p>
            The rod length is <code>L = 6 cm</code>. Mirror reflectances are <code>R1 = 0.8</code>, <code>R2 = 1.0</code>.
            There are no other losses (no scattering, no internal absorption other than the stimulated process).
          </p>

          <p>
            For intensity, one round trip multiplies by <code>R1 R2</code>.
            We can represent this discrete loss as an equivalent distributed loss coefficient α<sub>r</sub> by setting:
          </p>

          <div class="eq">
            <pre id="eqC">exp(−2 αr L) = R1 R2
⇒ αr = (1/(2L)) ln(1/(R1 R2))</pre>
            <button class="btn small" data-copy="#eqC">Copy</button>
          </div>

          <p>
            With <code>L = 6 cm</code> and <code>R1R2 = 0.8</code>:
            <code>ln(1/0.8) = ln(1.25) ≈ 0.2231</code>.
            Hence:
          </p>
          <p class="mono">αr = (1/(12 cm)) (0.2231) ≈ 0.0186 cm^-1</p>

          <p>
            Next, photon lifetime τ<sub>p</sub> is the energy decay time of the intracavity field.
            If the only loss per round trip is mirror loss, then energy decays with an effective rate:
          </p>

          <div class="eq">
            <pre id="eqC2">τp = t_rt / (−ln(R1 R2))
where t_rt = (2 n L) / c</pre>
            <button class="btn small" data-copy="#eqC2">Copy</button>
          </div>

          <p>
            We need the refractive index <code>n</code>. A typical value for YAG near 1.03 μm is
            <span class="pill">n ≈ 1.82</span> (used as an <b>example value</b> for τ<sub>p</sub> since it was not supplied).
            Then, with <code>L = 6 cm = 0.06 m</code>:
          </p>
          <p class="mono">
            t_rt = 2 n L / c = 2(1.82)(0.06) / (3.0×10^8) ≈ 7.28×10^-10 s
          </p>
          <p class="mono">
            τp = (7.28×10^-10) / 0.2231 ≈ 3.26×10^-9 s ≈ 3.3 ns
          </p>

          <div class="card final">
            <h3>Answer (c)</h3>
            <div class="eq">
              <pre id="ansC">Mirror-loss equivalent coefficient:
αr = (1/(2L)) ln(1/(R1R2)) = (1/12) ln(1/0.8) ≈ 0.0186 cm^-1

Photon lifetime (example n≈1.82):
τp = (2nL/c)/(−ln(R1R2)) ≈ 3.3 ns</pre>
              <button class="btn" data-copy="#ansC">Copy final (c)</button>
            </div>
            <p class="note">
              <b>Units check:</b> α<sub>r</sub> has units cm⁻¹; τ<sub>p</sub> has seconds. Both scale with cavity length as expected.
            </p>
          </div>
        </section>

        <!-- d -->
        <section id="p3d">
          <h3>d) Threshold population difference ΔN<sub>th</sub> for oscillation</h3>

          <p>
            Laser oscillation begins when the round-trip gain equals round-trip loss.
            Using the “equivalent distributed loss” picture, the threshold condition at line center is:
          </p>

          <div class="eq">
            <pre id="eqD">g_th(ν0) = αr
and g(ν0) = σ0 ΔN  ⇒  ΔN_th = αr / σ0</pre>
            <button class="btn small" data-copy="#eqD">Copy</button>
          </div>

          <p>
            Insert the values from (c) and the given σ<sub>0</sub>:
            <code>αr ≈ 0.0186 cm^-1</code>, <code>σ0 = 2.0×10^-20 cm^2</code>.
          </p>

          <p class="mono">
            ΔN_th = 0.0186 / (2.0×10^-20) ≈ 9.3×10^17 cm^-3
          </p>

          <p>
            Because this is a <b>three-level</b> laser, the lower laser level is essentially the ground state.
            With only two laser levels considered, <code>Na = N1 + N2</code> and <code>ΔN = N2 − N1 = 2N2 − Na</code>.
            Solve for the upper-level population at threshold:
          </p>

          <p class="mono">
            N2_th = (ΔN_th + Na)/2
            = (9.3×10^17 + 1.4×10^20)/2 ≈ 7.05×10^19 cm^-3
          </p>

          <p class="mono">
            N1_th = Na − N2_th ≈ 6.95×10^19 cm^-3
          </p>

          <p class="note">
            Notice <code>N2_th ≈ 0.503 Na</code>, i.e. slightly more than half the ions must be in the upper laser level
            to overcome ground-state absorption — the hallmark of a three-level laser threshold.
          </p>

          <div class="card final">
            <h3>Answer (d)</h3>
            <div class="eq">
              <pre id="ansD">Threshold inversion (population difference):
ΔN_th = αr/σ0 ≈ (0.0186 cm^-1)/(2.0×10^-20 cm^2) ≈ 9.3×10^17 cm^-3

Equivalent upper-level threshold population (three-level, Na=N1+N2):
N2_th = (ΔN_th + Na)/2 ≈ 7.05×10^19 cm^-3  (≈0.503 Na)</pre>
              <button class="btn" data-copy="#ansD">Copy final (d)</button>
            </div>

            <div class="card mistakes" style="margin-top:12px">
              <b>Sanity checks:</b>
              <ul>
                <li><b>Units:</b> α<sub>r</sub>/σ has (cm⁻¹)/(cm²) = cm⁻³ ✅</li>
                <li><b>Three-level requirement:</b> N<sub>2</sub> must exceed Na/2 for positive ΔN; we got 0.503 Na ✅</li>
                <li><b>Magnitude:</b> ΔN_th / Na ≈ 0.0066 (less than 1%) — plausible because mirror loss is relatively small ✅</li>
              </ul>
            </div>
          </div>
        </section>

        <!-- e -->
        <section id="p3e">
          <h3>e) Why is it advantageous to have E<sub>3</sub> close to E<sub>2</sub>?</h3>

          <div class="card callout">
            <p>
              In many solid-state lasers, the pump excites ions to a higher manifold (level ③), which then relaxes
              quickly (usually nonradiatively) to the upper laser level (level ②).
              If <b>E<sub>3</sub> is close to E<sub>2</sub></b>, the energy lost in that relaxation is small.
            </p>
            <ul>
              <li><b>Higher efficiency (lower quantum defect):</b> Less pump photon energy is wasted as heat.</li>
              <li><b>Reduced thermal loading:</b> Less heat → weaker thermal lensing, less stress, higher power scalability.</li>
              <li><b>Less risk of parasitic effects:</b> Lower heat reduces thermally induced birefringence, fracture risk, and unwanted refractive-index gradients.</li>
              <li><b>Faster, cleaner relaxation:</b> A small energy gap can be bridged efficiently by phonons without populating unwanted intermediate states.</li>
            </ul>
          </div>

          <div class="card final">
            <h3>Answer (e)</h3>
            <div class="eq">
              <pre id="ansE">Having level ③ close in energy to level ② minimizes the energy dumped as heat during ③→② relaxation (small quantum defect),
improving optical efficiency and reducing thermal lensing/stress—critical advantages for power scaling.</pre>
              <button class="btn" data-copy="#ansE">Copy final (e)</button>
            </div>
          </div>
        </section>

        <!-- f -->
        <section id="p3f">
          <h3>f) How might operation change if YVO<sub>4</sub> is used as the host instead of YAG?</h3>

          <p>
            The host crystal changes both <b>spectroscopy</b> (cross sections, bandwidths, polarization properties)
            and <b>thermal/mechanical</b> behavior. YVO<sub>4</sub> (yttrium vanadate) is a <b>birefringent</b> crystal and often
            provides different emission/absorption strengths and bandwidths compared with YAG.
          </p>

          <div class="grid2">
            <div class="card">
              <h3>Likely spectral/laser-performance changes</h3>
              <ul>
                <li><b>Different σ(ν):</b> Emission and absorption cross sections can be larger or smaller → changes threshold <code>ΔN_th = αr/σ0</code>.</li>
                <li><b>Different linewidths:</b> Broader/narrower transitions affect pump tolerance and gain bandwidth (important for tunability/ultrashort pulses).</li>
                <li><b>Polarization effects:</b> Birefringence can enforce polarization, which can be beneficial for certain cavity designs.</li>
              </ul>
            </div>
            <div class="card">
              <h3>Likely thermal/engineering changes</h3>
              <ul>
                <li><b>Thermal conductivity:</b> If lower than YAG, heat removal is harder → more thermal lensing.</li>
                <li><b>Thermo-optic coefficients:</b> Different dn/dT can make the cavity more/less sensitive to heating.</li>
                <li><b>Stress/birefringence:</b> Intrinsic birefringence plus thermal stress can alter mode quality unless managed carefully.</li>
              </ul>
            </div>
          </div>

          <div class="card final" style="margin-top:14px">
            <h3>Answer (f)</h3>
            <div class="eq">
              <pre id="ansF">Switching the host from YAG to YVO4 would change the spectroscopy (σ0, bandwidth, polarization selection) and the thermal behavior.
As a result, the threshold inversion ΔN_th = αr/σ0, pump-wavelength tolerance, gain bandwidth, and thermal-lensing constraints could all shift—sometimes favorably (stronger polarized gain), sometimes unfavorably (harder heat handling), depending on the specific Yb:YVO4 parameters.</pre>
              <button class="btn" data-copy="#ansF">Copy final (f)</button>
            </div>
          </div>
        </section>

        <!-- Visuals + controls -->
        <section>
          <h3>Interactive Visualization (linked to the solved formulas)</h3>
          <p class="note">
            Use the control to change the output-coupler reflectance <code>R1</code>. The plots update:
            the mirror-loss coefficient <code>αr</code>, photon lifetime <code>τp</code>, and threshold inversion <code>ΔN_th</code>.
          </p>

          <figure>
            <canvas id="diag" class="canvasTall" aria-label="Laser rod and cavity diagram"></canvas>
            <figcaption>
              Diagram: Yb:YAG rod of length <span class="mono">L</span> between mirrors of reflectance <span class="mono">R1</span> and <span class="mono">R2</span>.
              Pump excites ions to level ③ which relax to upper laser level ②, emitting at 1.03 μm to level ①.
            </figcaption>

            <div class="controls">
              <div class="control">
                <label for="r1">Output coupler reflectance R1</label>
                <input id="r1" type="range" min="0.50" max="0.99" step="0.01" value="0.80" />
                <span class="pill" id="r1Val">0.80</span>
              </div>
              <div class="control">
                <label for="nsel">Refractive index n (for τp)</label>
                <select id="nsel">
                  <option value="1.82" selected>n = 1.82 (YAG @ 1.03 μm, example)</option>
                  <option value="1.95">n = 1.95 (example higher n)</option>
                  <option value="1.75">n = 1.75 (example lower n)</option>
                </select>
              </div>
              <div class="control">
                <label for="len">Rod length L (cm)</label>
                <input id="len" type="range" min="2" max="20" step="0.5" value="6" />
                <span class="pill" id="lenVal">6.0</span>
              </div>
            </div>

            <div class="kpi" aria-label="Live computed values">
              <div class="item">
                <div class="label">Equivalent mirror loss αr (cm⁻¹)</div>
                <div class="value" id="kAlphaR">0.0186</div>
              </div>
              <div class="item">
                <div class="label">Photon lifetime τp (ns)</div>
                <div class="value" id="kTauP">3.26</div>
              </div>
              <div class="item">
                <div class="label">Threshold inversion ΔNth (cm⁻³)</div>
                <div class="value" id="kDN">9.30e17</div>
              </div>
            </div>
          </figure>

          <div class="grid2" style="margin-top:14px">
            <figure>
              <canvas id="plotMain" aria-label="Main plot: threshold inversion vs reflectance"></canvas>
              <figcaption>
                Main plot: <b>Threshold inversion</b> ΔN<sub>th</sub> versus output-coupler reflectance R1
                (with R2 fixed). Higher transmission (lower R1) increases cavity loss and raises ΔN<sub>th</sub>.
              </figcaption>
            </figure>

            <figure>
              <canvas id="plot2" aria-label="Secondary plot: photon lifetime vs reflectance"></canvas>
              <figcaption>
                Secondary plot: <b>Photon lifetime</b> τ<sub>p</sub> versus R1. More reflective mirrors reduce loss per round trip, increasing τ<sub>p</sub>.
              </figcaption>
            </figure>
          </div>
        </section>

        <!-- Final answers combined -->
        <section>
          <h3>All final numeric results (collected)</h3>
          <div class="card final">
            <div class="eq">
              <pre id="ansALL">Given:
E3 = 1.31915 eV, ΔE = 0.02475 eV, σ0 = 2.0×10^-20 cm^2, Na = 1.4×10^20 cm^-3, L = 6 cm, R1 = 0.8, R2 = 1.0, (example n≈1.82)

(a) λpump = (1240 eV·nm)/E3 ≈ 940.2 nm
    Δλpump ≈ (1240/E3^2)ΔE ≈ 17.6 nm

(b) Thermal equilibrium (N1≈Na, N2≈0):
    α(ν0) ≈ +σ0 Na ≈ +2.8 cm^-1
    g(ν0) ≈ −σ0 Na ≈ −2.8 cm^-1

(c) Equivalent resonator loss:
    αr = (1/(2L)) ln(1/(R1R2)) ≈ 0.0186 cm^-1
    Photon lifetime (no internal loss):
    τp = (2nL/c)/(−ln(R1R2)) ≈ 3.3 ns  (n≈1.82 example)

(d) Threshold inversion:
    ΔNth = αr/σ0 ≈ 9.3×10^17 cm^-3
    Upper-level population at threshold (three-level):
    N2_th = (ΔNth + Na)/2 ≈ 7.05×10^19 cm^-3

(e) E3 close to E2 → small quantum defect → less heat, higher efficiency, easier power scaling.

(f) YVO4 host changes σ0, bandwidth, polarization (birefringence), and thermal properties, shifting threshold and thermal lensing behavior.</pre>
              <button class="btn" data-copy="#ansALL">Copy final answer (all)</button>
            </div>
          </div>
        </section>
      </section>

      <!-- PART 4 -->
      <section id="p4">
        <h2>PART 4 — Deeper Understanding (Theory Around the Result)</h2>

        <div class="card callout">
          <h3>Re-interpreting the key formulas</h3>
          <ul>
            <li><code>ΔN_th = αr/σ0</code>: threshold gets easier when the <b>cross section is large</b> (strong light–matter coupling) and when <b>cavity loss is small</b>.</li>
            <li><code>αr = (1/(2L)) ln(1/(R1R2))</code>: longer cavities reduce α<sub>r</sub> (loss “spread out”), but this does <b>not</b> automatically mean better lasers—mode size, pump overlap, and diffraction also matter.</li>
            <li><code>τp ∝ L / (−ln(R1R2))</code>: higher reflectivity stores photons longer, usually narrowing linewidth and affecting dynamic response.</li>
          </ul>
        </div>

        <div class="grid2">
          <div class="card">
            <h3>Parameter effects (connect to the plots)</h3>
            <ul>
              <li><b>Decrease R1</b> → increase mirror transmission → larger −ln(R1R2) → larger α<sub>r</sub> → larger ΔN<sub>th</sub> and shorter τ<sub>p</sub>.</li>
              <li><b>Increase L</b> → smaller α<sub>r</sub> (because of 1/(2L)) but larger round-trip time; τ<sub>p</sub> often increases because photons take longer per round trip, even though each trip has the same fractional loss.</li>
              <li><b>Increase σ0</b> (different host or temperature) → lower ΔN<sub>th</sub> directly.</li>
            </ul>
          </div>
          <div class="card">
            <h3>Alternative derivation (brief)</h3>
            <p>
              Instead of defining α<sub>r</sub>, you can write the round-trip intensity condition directly:
              <span class="mono">I → I·R1R2·exp(2gL) = I</span> at threshold (no internal loss).
              Taking logs yields <span class="mono">2gL + ln(R1R2) = 0</span> → <span class="mono">g = (1/(2L)) ln(1/(R1R2))</span>,
              which is exactly α<sub>r</sub>.
            </p>
          </div>
        </div>

        <div class="card" style="margin-top:14px">
          <h3>Concept check (self-test, with answers)</h3>
          <ul>
            <li><b>Q:</b> Why is gain negative at thermal equilibrium? <b>A:</b> Because N<sub>1</sub> &gt; N<sub>2</sub>, so stimulated absorption exceeds stimulated emission: <code>g=σ(N2−N1)&lt;0</code>.</li>
            <li><b>Q:</b> If R1 increases toward 1, what happens to τ<sub>p</sub>? <b>A:</b> Loss per round trip decreases, so τ<sub>p</sub> increases.</li>
            <li><b>Q:</b> For a three-level laser, why is N<sub>2</sub>≈Na/2 “special”? <b>A:</b> That is where ΔN = N2−(Na−N2)=2N2−Na crosses zero; only above that is net gain positive.</li>
            <li><b>Q:</b> If σ<sub>0</sub> doubled, what happens to ΔN<sub>th</sub>? <b>A:</b> It halves, since <code>ΔN_th = αr/σ0</code>.</li>
          </ul>
        </div>
      </section>

      <!-- PART 5 -->
      <section id="p5">
        <h2>PART 5 — Visualization Guide (How to Read the Plots)</h2>

        <div class="card">
          <h3>What each canvas shows</h3>
          <ul>
            <li><b>Diagram canvas:</b> Cavity geometry (rod length L, mirrors R1/R2) plus a simplified three-level energy diagram (levels ①,②,③ and pump/laser arrows).</li>
            <li><b>Main plot:</b> ΔN<sub>th</sub>(R1) computed from <code>ΔN_th = αr/σ0</code> with <code>αr = (1/(2L)) ln(1/(R1R2))</code>.</li>
            <li><b>Secondary plot:</b> τ<sub>p</sub>(R1) computed from <code>τp = (2nL/c)/(−ln(R1R2))</code>.</li>
          </ul>

          <h3>Interactive controls</h3>
          <ul>
            <li><b>R1 slider:</b> Changes output coupling. Lower R1 → more loss → higher ΔN<sub>th</sub>, lower τ<sub>p</sub>. Both plots update live.</li>
            <li><b>n selector:</b> Changes only τ<sub>p</sub> (material/cavity optical path). ΔN<sub>th</sub> does not depend on n in this simplified loss-only model.</li>
            <li><b>L slider:</b> Changes α<sub>r</sub>, τ<sub>p</sub>, and thus ΔN<sub>th</sub>. Both plots update live.</li>
          </ul>

          <p class="note">
            The plotted formulas match the symbols used in the solution text, and the KPI boxes show the current numerical values at the selected parameters.
          </p>
        </div>
      </section>
    </article>
  </main>

  <footer>
    Built as a self-contained learning article (vanilla HTML/CSS/JS). Numeric τ<sub>p</sub> uses an example refractive index because n was not specified in the prompt.
  </footer>

  <script>
    // ---------- Copy buttons ----------
    (function(){
      function copyText(sel){
        const el = document.querySelector(sel);
        if(!el) return;
        const text = el.innerText.replace(/\u00a0/g,' ');
        navigator.clipboard.writeText(text).then(()=>{
          // flash
          const btn = document.querySelector('[data-copy="'+sel+'"]');
          if(btn){
            const old = btn.textContent;
            btn.textContent = "Copied!";
            btn.style.borderColor = "rgba(134,239,172,.45)";
            btn.style.background = "rgba(134,239,172,.12)";
            setTimeout(()=>{
              btn.textContent = old;
              btn.style.borderColor = "";
              btn.style.background = "";
            }, 900);
          }
        }).catch(()=>{ /* ignore */ });
      }
      document.addEventListener('click', (e)=>{
        const b = e.target.closest('[data-copy]');
        if(!b) return;
        copyText(b.getAttribute('data-copy'));
      });
    })();

    // ---------- Math helpers ----------
    const C = 299792458; // m/s
    const sigma0 = 2.0e-20; // cm^2
    const R2 = 1.0;

    function alphaR_cmInv(L_cm, R1, R2){
      // αr = (1/(2L)) ln(1/(R1R2))
      const prod = Math.max(1e-12, Math.min(0.9999999999, R1*R2));
      return (1/(2*L_cm))*Math.log(1/prod);
    }
    function tauP_ns(L_cm, n, R1, R2){
      // τp = (2 n L / c) / (-ln(R1R2))
      const prod = Math.max(1e-12, Math.min(0.9999999999, R1*R2));
      const L_m = L_cm / 100;
      const t_rt = 2*n*L_m / C;
      const denom = -Math.log(prod);
      return (t_rt/denom) * 1e9;
    }
    function dN_th_cm3(alphaR){
      // ΔN_th = αr / σ0
      return alphaR / sigma0;
    }

    function fmtSci(x, sig=3){
      if(!isFinite(x)) return "—";
      const ax = Math.abs(x);
      if(ax === 0) return "0";
      if(ax >= 1e4 || ax < 1e-2){
        const e = Math.floor(Math.log10(ax));
        const m = x / Math.pow(10,e);
        return m.toFixed(sig-1) + "e" + (e>=0?"+":"") + e;
      }
      return x.toFixed(Math.max(0, sig - 1 - Math.floor(Math.log10(ax))));
    }

    // ---------- Canvas drawing utilities ----------
    function setupCanvas(canvas){
      const dpr = Math.max(1, window.devicePixelRatio || 1);
      const rect = canvas.getBoundingClientRect();
      const w = Math.max(10, Math.floor(rect.width * dpr));
      const h = Math.max(10, Math.floor(rect.height * dpr));
      if(canvas.width !== w || canvas.height !== h){
        canvas.width = w;
        canvas.height = h;
      }
      const ctx = canvas.getContext('2d');
      ctx.setTransform(dpr,0,0,dpr,0,0); // draw in CSS pixels
      return {ctx, w: rect.width, h: rect.height, dpr};
    }

    function clear(ctx, w, h){
      ctx.clearRect(0,0,w,h);
    }

    function drawPanelTitle(ctx, title, x, y){
      ctx.save();
      ctx.font = "700 14px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillStyle = "rgba(232,238,247,.92)";
      ctx.fillText(title, x, y);
      ctx.restore();
    }

    function drawAxes(ctx, box, xLabel, yLabel, xMin, xMax, yMin, yMax, opts={}){
      const {x, y, w, h} = box;
      const grid = opts.grid ?? true;
      const ticks = opts.ticks ?? 5;

      // frame
      ctx.save();
      ctx.strokeStyle = "rgba(255,255,255,.14)";
      ctx.lineWidth = 1;
      ctx.strokeRect(x, y, w, h);

      // grid + ticks
      if(grid){
        ctx.strokeStyle = "rgba(255,255,255,.07)";
        for(let i=1;i<ticks;i++){
          const gx = x + (w*i/ticks);
          const gy = y + (h*i/ticks);
          ctx.beginPath(); ctx.moveTo(gx,y); ctx.lineTo(gx,y+h); ctx.stroke();
          ctx.beginPath(); ctx.moveTo(x,gy); ctx.lineTo(x+w,gy); ctx.stroke();
        }
      }

      // tick labels
      ctx.fillStyle = "rgba(182,194,214,.92)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      for(let i=0;i<=ticks;i++){
        const tx = x + (w*i/ticks);
        const ty = y + h;
        const xv = xMin + (xMax-xMin)*(i/ticks);
        ctx.fillText((opts.xFmt?opts.xFmt(xv):xv.toFixed(2)), tx-14, ty+18);
      }
      for(let i=0;i<=ticks;i++){
        const ty = y + h - (h*i/ticks);
        const yv = yMin + (yMax-yMin)*(i/ticks);
        ctx.fillText((opts.yFmt?opts.yFmt(yv):fmtSci(yv,3)), x-6, ty+4);
      }

      // axis labels
      ctx.fillStyle = "rgba(232,238,247,.92)";
      ctx.font = "600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(xLabel, x + w/2 - ctx.measureText(xLabel).width/2, y + h + 40);

      ctx.save();
      ctx.translate(x - 48, y + h/2);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, -ctx.measureText(yLabel).width/2, 0);
      ctx.restore();

      ctx.restore();

      function xMap(v){ return x + (v - xMin) * w / (xMax - xMin); }
      function yMap(v){ return y + h - (v - yMin) * h / (yMax - yMin); }
      return {xMap, yMap};
    }

    function drawLine(ctx, pts, strokeStyle="rgba(125,211,252,.9)", lineWidth=2){
      if(pts.length<2) return;
      ctx.save();
      ctx.strokeStyle = strokeStyle;
      ctx.lineWidth = lineWidth;
      ctx.beginPath();
      ctx.moveTo(pts[0].x, pts[0].y);
      for(let i=1;i<pts.length;i++) ctx.lineTo(pts[i].x, pts[i].y);
      ctx.stroke();
      ctx.restore();
    }

    function drawLegend(ctx, items, x, y){
      ctx.save();
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      let yy = y;
      for(const it of items){
        ctx.fillStyle = it.color;
        ctx.fillRect(x, yy-9, 14, 6);
        ctx.fillStyle = "rgba(232,238,247,.92)";
        ctx.fillText(it.label, x+20, yy);
        yy += 18;
      }
      ctx.restore();
    }

    // ---------- Diagram ----------
    function drawDiagram(state){
      const canvas = document.getElementById('diag');
      const {ctx, w, h} = setupCanvas(canvas);
      clear(ctx, w, h);

      const pad = 18;
      drawPanelTitle(ctx, "Physical setup + 3-level picture (schematic)", pad, 22);

      // Cavity rod (top half)
      const cx = pad, cy = 42, cw = w - 2*pad, ch = Math.min(150, h*0.50);
      const rodY = cy + 36;
      const rodH = 26;
      const rodX = cx + 58;
      const rodW = cw - 116;

      // mirrors
      ctx.save();
      ctx.strokeStyle = "rgba(232,238,247,.80)";
      ctx.lineWidth = 2;

      // left mirror
      ctx.beginPath();
      ctx.moveTo(rodX-18, rodY-16); ctx.lineTo(rodX-18, rodY+rodH+16);
      ctx.stroke();

      // right mirror
      ctx.beginPath();
      ctx.moveTo(rodX+rodW+18, rodY-16); ctx.lineTo(rodX+rodW+18, rodY+rodH+16);
      ctx.stroke();

      // rod
      ctx.fillStyle = "rgba(125,211,252,.10)";
      ctx.strokeStyle = "rgba(125,211,252,.28)";
      ctx.lineWidth = 1.5;
      ctx.beginPath();
      roundRect(ctx, rodX, rodY, rodW, rodH, 10);
      ctx.fill();
      ctx.stroke();

      // beam axis line
      ctx.strokeStyle = "rgba(232,238,247,.22)";
      ctx.setLineDash([6,6]);
      ctx.beginPath();
      ctx.moveTo(rodX-12, rodY+rodH/2);
      ctx.lineTo(rodX+rodW+12, rodY+rodH/2);
      ctx.stroke();
      ctx.setLineDash([]);

      // labels
      ctx.fillStyle = "rgba(232,238,247,.92)";
      ctx.font = "600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Mirror R1", rodX-42, rodY-22);
      ctx.fillText("Mirror R2", rodX+rodW-10, rodY-22);

      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      ctx.fillStyle = "rgba(182,194,214,.95)";
      ctx.fillText("R1 = " + state.R1.toFixed(2), rodX-50, rodY-6);
      ctx.fillText("R2 = " + state.R2.toFixed(2), rodX+rodW-12, rodY-6);

      // length bracket
      const bx1 = rodX, bx2 = rodX+rodW, by = rodY+rodH+36;
      ctx.strokeStyle = "rgba(167,243,208,.65)";
      ctx.lineWidth = 2;
      ctx.beginPath(); ctx.moveTo(bx1, by); ctx.lineTo(bx2, by); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(bx1, by-7); ctx.lineTo(bx1, by+7); ctx.stroke();
      ctx.beginPath(); ctx.moveTo(bx2, by-7); ctx.lineTo(bx2, by+7); ctx.stroke();
      ctx.fillStyle = "rgba(167,243,208,.92)";
      ctx.font = "700 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      const Ltxt = "L = " + state.L_cm.toFixed(1) + " cm";
      ctx.fillText(Ltxt, (bx1+bx2)/2 - ctx.measureText(Ltxt).width/2, by+22);

      // Pump arrow into rod
      ctx.strokeStyle = "rgba(253,186,116,.85)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(rodX + rodW*0.25, rodY-26);
      ctx.lineTo(rodX + rodW*0.25, rodY+2);
      ctx.stroke();
      arrowHead(ctx, rodX + rodW*0.25, rodY+2, 0, "rgba(253,186,116,.85)");
      ctx.fillStyle = "rgba(253,186,116,.92)";
      ctx.font = "600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Pump (~940 nm)", rodX + rodW*0.25 - 52, rodY-32);

      // Laser arrow along axis
      ctx.strokeStyle = "rgba(125,211,252,.85)";
      ctx.lineWidth = 3;
      ctx.beginPath();
      ctx.moveTo(rodX + rodW*0.35, rodY+rodH/2);
      ctx.lineTo(rodX + rodW*0.65, rodY+rodH/2);
      ctx.stroke();
      arrowHead(ctx, rodX + rodW*0.65, rodY+rodH/2, 0, "rgba(125,211,252,.85)");
      ctx.fillStyle = "rgba(125,211,252,.92)";
      ctx.font = "600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Laser (1.03 μm)", rodX + rodW*0.52 - 46, rodY+rodH/2 - 12);

      ctx.restore();

      // Energy-level diagram (bottom half)
      const ex = pad+12, ey = cy + ch + 14, ew = w - 2*(pad+12), eh = h - ey - 18;
      const midX = ex + ew*0.25;
      const baseY = ey + eh - 18;

      ctx.save();
      ctx.fillStyle = "rgba(255,255,255,.04)";
      ctx.strokeStyle = "rgba(255,255,255,.08)";
      ctx.lineWidth = 1;
      roundRect(ctx, ex, ey, ew, eh, 14);
      ctx.fill(); ctx.stroke();

      ctx.fillStyle = "rgba(232,238,247,.92)";
      ctx.font = "700 13px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("Three-level schematic (Yb:YAG)", ex+12, ey+24);

      // levels
      const y1 = baseY;
      const y2 = ey + eh*0.55;
      const y3 = ey + eh*0.25;

      drawLevel(ctx, midX, y1, 170, "Level ① (lower / ground manifold)");
      drawLevel(ctx, midX, y2, 170, "Level ② (upper laser level)");
      drawLevel(ctx, midX, y3, 170, "Level ③ (pump band)");

      // transitions
      // pump 1->3
      drawArrow(ctx, midX+90, y1-2, midX+90, y3+2, "rgba(253,186,116,.9)", 2.5);
      ctx.fillStyle = "rgba(253,186,116,.92)";
      ctx.font = "600 12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText("pump", midX+104, (y1+y3)/2);

      // fast relaxation 3->2
      drawWavy(ctx, midX-80, y3+2, midX-80, y2-2, "rgba(167,243,208,.9)");
      ctx.fillStyle = "rgba(167,243,208,.92)";
      ctx.fillText("fast nonradiative", midX-210, (y3+y2)/2);

      // laser 2->1
      drawArrow(ctx, midX+10, y2-2, midX+10, y1+2, "rgba(125,211,252,.9)", 2.8);
      ctx.fillStyle = "rgba(125,211,252,.92)";
      ctx.fillText("laser (1.03 μm)", midX+22, (y2+y1)/2);

      ctx.restore();
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.beginPath();
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }
    function arrowHead(ctx, x, y, angle, color){
      const size = 8;
      ctx.save();
      ctx.translate(x,y);
      ctx.rotate(angle);
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.moveTo(0,0);
      ctx.lineTo(-size, -size*0.6);
      ctx.lineTo(-size, size*0.6);
      ctx.closePath();
      ctx.fill();
      ctx.restore();
    }
    function drawArrow(ctx, x1,y1,x2,y2,color, lw){
      ctx.save();
      ctx.strokeStyle = color;
      ctx.lineWidth = lw;
      ctx.beginPath();
      ctx.moveTo(x1,y1);
      ctx.lineTo(x2,y2);
      ctx.stroke();
      const ang = Math.atan2(y2-y1, x2-x1);
      arrowHead(ctx, x2, y2, ang, color);
      ctx.restore();
    }
    function drawLevel(ctx, cx, y, w, label){
      const x = cx - w/2;
      const h = 0;
      ctx.save();
      ctx.strokeStyle = "rgba(232,238,247,.70)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(x, y);
      ctx.lineTo(x+w, y);
      ctx.stroke();
      ctx.fillStyle = "rgba(182,194,214,.95)";
      ctx.font = "12px ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Arial";
      ctx.fillText(label, x, y-8);
      ctx.restore();
    }
    function drawWavy(ctx, x1,y1,x2,y2,color){
      ctx.save();
      ctx.strokeStyle = color;
      ctx.lineWidth = 2;
      const steps = 16;
      ctx.beginPath();
      for(let i=0;i<=steps;i++){
        const t = i/steps;
        const x = x1 + (x2-x1)*t;
        const y = y1 + (y2-y1)*t + Math.sin(t*steps*Math.PI)*3.0;
        if(i===0) ctx.moveTo(x,y); else ctx.lineTo(x,y);
      }
      ctx.stroke();
      arrowHead(ctx, x2, y2, Math.atan2(y2-y1, x2-x1), color);
      ctx.restore();
    }

    // ---------- Plots ----------
    function drawMainPlot(state){
      const canvas = document.getElementById('plotMain');
      const {ctx, w, h} = setupCanvas(canvas);
      clear(ctx, w, h);

      drawPanelTitle(ctx, "Main: Threshold inversion ΔNth vs R1", 16, 22);

      // compute curve
      const xMin = 0.50, xMax = 0.99;
      const L = state.L_cm, n = state.n, R2 = state.R2;

      // y range: compute at ends
      const yA = dN_th_cm3(alphaR_cmInv(L, xMax, R2));
      const yB = dN_th_cm3(alphaR_cmInv(L, xMin, R2));
      const yMin = Math.max(0, yA*0.85);
      const yMax = yB*1.05;

      const box = {x: 62, y: 38, w: w-86, h: h-92};
      const map = drawAxes(ctx, box, "R1 (dimensionless)", "ΔNth (cm⁻³)", xMin, xMax, yMin, yMax, {
        ticks: 5,
        xFmt: v => v.toFixed(2),
        yFmt: v => fmtSci(v,3)
      });

      const pts = [];
      const N = 140;
      for(let i=0;i<=N;i++){
        const R1 = xMin + (xMax-xMin)*i/N;
        const aR = alphaR_cmInv(L, R1, R2);
        const dN = dN_th_cm3(aR);
        pts.push({x: map.xMap(R1), y: map.yMap(dN)});
      }
      drawLine(ctx, pts, "rgba(125,211,252,.95)", 2.5);

      // marker for current R1
      const aR0 = alphaR_cmInv(L, state.R1, R2);
      const dN0 = dN_th_cm3(aR0);
      ctx.save();
      ctx.fillStyle = "rgba(167,243,208,.95)";
      ctx.strokeStyle = "rgba(167,243,208,.95)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.arc(map.xMap(state.R1), map.yMap(dN0), 4.8, 0, Math.PI*2);
      ctx.fill();

      // legend
      drawLegend(ctx, [
        {label:"ΔNth(R1) = αr/σ0", color:"rgba(125,211,252,.95)"},
        {label:"current setting", color:"rgba(167,243,208,.95)"}
      ], box.x + 12, box.y + 18);

      // annotation
      ctx.fillStyle = "rgba(232,238,247,.92)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      const txt = "at R1=" + state.R1.toFixed(2) + ": ΔNth=" + fmtSci(dN0,3) + " cm^-3";
      ctx.fillText(txt, box.x + 12, box.y + box.h - 10);
      ctx.restore();
    }

    function drawSecondaryPlot(state){
      const canvas = document.getElementById('plot2');
      const {ctx, w, h} = setupCanvas(canvas);
      clear(ctx, w, h);

      drawPanelTitle(ctx, "Secondary: Photon lifetime τp vs R1", 16, 22);

      const xMin = 0.50, xMax = 0.99;
      const L = state.L_cm, n = state.n, R2 = state.R2;

      const tA = tauP_ns(L, n, xMin, R2);
      const tB = tauP_ns(L, n, xMax, R2);
      const yMin = Math.max(0, Math.min(tA,tB)*0.9);
      const yMax = Math.max(tA,tB)*1.15;

      const box = {x: 62, y: 38, w: w-86, h: h-92};
      const map = drawAxes(ctx, box, "R1 (dimensionless)", "τp (ns)", xMin, xMax, yMin, yMax, {
        ticks: 5,
        xFmt: v => v.toFixed(2),
        yFmt: v => (v<10 ? v.toFixed(2) : v.toFixed(1))
      });

      const pts = [];
      const N = 140;
      for(let i=0;i<=N;i++){
        const R1 = xMin + (xMax-xMin)*i/N;
        const t = tauP_ns(L, n, R1, R2);
        pts.push({x: map.xMap(R1), y: map.yMap(t)});
      }
      drawLine(ctx, pts, "rgba(167,243,208,.95)", 2.5);

      // marker for current
      const t0 = tauP_ns(L, n, state.R1, R2);
      ctx.save();
      ctx.fillStyle = "rgba(125,211,252,.95)";
      ctx.beginPath();
      ctx.arc(map.xMap(state.R1), map.yMap(t0), 4.8, 0, Math.PI*2);
      ctx.fill();

      drawLegend(ctx, [
        {label:"τp(R1) = (2nL/c)/(-ln(R1R2))", color:"rgba(167,243,208,.95)"},
        {label:"current setting", color:"rgba(125,211,252,.95)"}
      ], box.x + 12, box.y + 18);

      ctx.fillStyle = "rgba(232,238,247,.92)";
      ctx.font = "12px ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, Liberation Mono, Courier New, monospace";
      const txt = "at R1=" + state.R1.toFixed(2) + ": τp=" + t0.toFixed(2) + " ns";
      ctx.fillText(txt, box.x + 12, box.y + box.h - 10);
      ctx.restore();
    }

    // ---------- State + UI wiring ----------
    const state = {
      R1: 0.80,
      R2: 1.00,
      L_cm: 6.0,
      n: 1.82
    };

    function updateKPIs(){
      const aR = alphaR_cmInv(state.L_cm, state.R1, state.R2);
      const t = tauP_ns(state.L_cm, state.n, state.R1, state.R2);
      const dN = dN_th_cm3(aR);

      document.getElementById('kAlphaR').textContent = aR.toFixed(4);
      document.getElementById('kTauP').textContent = t.toFixed(2);
      document.getElementById('kDN').textContent = fmtSci(dN,3);

      // also update the displayed slider values
      document.getElementById('r1Val').textContent = state.R1.toFixed(2);
      document.getElementById('lenVal').textContent = state.L_cm.toFixed(1);
    }

    function renderAll(){
      updateKPIs();
      drawDiagram(state);
      drawMainPlot(state);
      drawSecondaryPlot(state);
    }

    function bindUI(){
      const r1 = document.getElementById('r1');
      const nsel = document.getElementById('nsel');
      const len = document.getElementById('len');

      r1.addEventListener('input', ()=>{
        state.R1 = parseFloat(r1.value);
        renderAll();
      });
      nsel.addEventListener('change', ()=>{
        state.n = parseFloat(nsel.value);
        renderAll();
      });
      len.addEventListener('input', ()=>{
        state.L_cm = parseFloat(len.value);
        renderAll();
      });

      // initial sync
      r1.value = state.R1.toFixed(2);
      len.value = state.L_cm.toFixed(1);
      nsel.value = String(state.n);
    }

    // Re-render on resize (responsive + high-DPI)
    let resizeTimer = null;
    window.addEventListener('resize', ()=>{
      clearTimeout(resizeTimer);
      resizeTimer = setTimeout(renderAll, 120);
    });

    bindUI();
    renderAll();
  </script>
</body>
</html>
