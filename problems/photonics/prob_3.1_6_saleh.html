<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Gaussian Beam Parameters from Divergence (Nd:YAG, 1.06 Œºm)</title>
  <style>
    :root{
      --bg:#0b0f17;
      --card:#111a2a;
      --card2:#0f1626;
      --text:#e9eefb;
      --muted:#b9c4df;
      --faint:#7f8bb0;
      --accent:#7aa2ff;
      --accent2:#72f1b8;
      --warn:#ffcc66;
      --danger:#ff6b6b;
      --border:rgba(255,255,255,.10);
      --shadow: 0 18px 60px rgba(0,0,0,.35);
      --radius:18px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: ui-sans-serif, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
      --maxw: 1180px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      background: radial-gradient(1200px 800px at 15% 10%, rgba(122,162,255,.18), transparent 60%),
                  radial-gradient(900px 700px at 90% 10%, rgba(114,241,184,.12), transparent 55%),
                  radial-gradient(1100px 900px at 55% 110%, rgba(255,204,102,.10), transparent 55%),
                  var(--bg);
      color:var(--text);
      line-height:1.55;
    }
    header{
      position:relative;
      padding: 42px 18px 18px;
      border-bottom:1px solid var(--border);
      overflow:hidden;
    }
    .wrap{max-width:var(--maxw); margin:0 auto;}
    .topgrid{
      display:grid;
      grid-template-columns: 1.15fr .85fr;
      gap:18px;
      align-items:start;
    }
    h1{
      margin:0 0 10px 0;
      font-size: clamp(1.45rem, 2.4vw, 2.2rem);
      letter-spacing:.2px;
    }
    .subtitle{
      color:var(--muted);
      margin:0 0 14px 0;
      max-width: 70ch;
    }
    .chiprow{
      display:flex; flex-wrap:wrap; gap:8px;
      margin-top:10px;
    }
    .chip{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      padding:6px 10px;
      border-radius:999px;
      color:var(--muted);
      font-size:.88rem;
      backdrop-filter: blur(10px);
    }
    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius:var(--radius);
      box-shadow:var(--shadow);
      padding:16px 16px 14px;
    }
    .quick ul{
      margin:8px 0 0 18px;
      color:var(--muted);
    }
    .quick li{margin:6px 0}
    main{
      padding: 18px 18px 60px;
    }
    .layout{
      display:grid;
      grid-template-columns: 280px 1fr;
      gap:18px;
      align-items:start;
    }
    nav.toc{
      position: sticky;
      top: 14px;
      align-self:start;
      padding:14px;
      border-radius:var(--radius);
      border:1px solid var(--border);
      background: rgba(17,26,42,.55);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0,0,0,.25);
    }
    nav.toc .toc-title{
      font-weight:700;
      font-size:.95rem;
      margin-bottom:10px;
      color:var(--text);
      display:flex;
      align-items:center;
      gap:8px;
    }
    nav.toc a{
      display:block;
      text-decoration:none;
      color:var(--muted);
      padding:7px 10px;
      border-radius:12px;
      border:1px solid transparent;
      margin:4px 0;
      transition: transform .14s ease, background .14s ease, border-color .14s ease;
      font-size:.94rem;
    }
    nav.toc a:hover{
      background: rgba(122,162,255,.08);
      border-color: rgba(122,162,255,.22);
      transform: translateX(2px);
      color:var(--text);
    }
    article{
      display:flex;
      flex-direction:column;
      gap:18px;
      min-width: 0;
    }
    section{
      border:1px solid var(--border);
      border-radius:var(--radius);
      background: rgba(17,26,42,.40);
      backdrop-filter: blur(10px);
      box-shadow: 0 10px 40px rgba(0,0,0,.20);
      padding: 16px;
      overflow:hidden;
    }
    section h2{
      margin:0 0 8px 0;
      font-size: 1.18rem;
      letter-spacing:.2px;
    }
    .muted{color:var(--muted)}
    .faint{color:var(--faint)}
    .grid2{
      display:grid;
      grid-template-columns: 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    .grid3{
      display:grid;
      grid-template-columns: 1fr 1fr 1fr;
      gap:14px;
      align-items:stretch;
    }
    .callout{
      padding:12px;
      border-radius:16px;
      border:1px solid var(--border);
      background: rgba(0,0,0,.18);
    }
    .callout strong{color:var(--text)}
    .eqblock{
      margin:10px 0 0;
      border:1px solid rgba(122,162,255,.25);
      background: rgba(122,162,255,.06);
      border-radius: 14px;
      padding: 10px 10px 8px;
      position: relative;
      overflow:hidden;
    }
    pre.eq{
      margin:0;
      font-family:var(--mono);
      font-size:.92rem;
      color: var(--text);
      white-space: pre-wrap;
      line-height:1.45;
    }
    .copybtn{
      position:absolute;
      top:8px;
      right:8px;
      border:1px solid rgba(255,255,255,.18);
      background: rgba(0,0,0,.25);
      color: var(--text);
      border-radius: 12px;
      padding: 6px 10px;
      font-size:.82rem;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease, border-color .12s ease;
      user-select:none;
    }
    .copybtn:hover{
      background: rgba(0,0,0,.40);
      transform: translateY(-1px);
      border-color: rgba(255,255,255,.25);
    }
    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
    .pill{
      border:1px solid var(--border);
      background: rgba(255,255,255,.04);
      border-radius: 999px;
      padding: 6px 10px;
      color: var(--muted);
      font-size:.9rem;
    }
    .controls{
      display:grid;
      grid-template-columns: 1fr;
      gap:12px;
    }
    .control{
      border:1px solid var(--border);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      padding:12px;
    }
    .control label{
      display:flex;
      justify-content:space-between;
      align-items:baseline;
      gap:10px;
      font-size:.95rem;
      color:var(--text);
      margin-bottom:8px;
    }
    .control .val{
      color: var(--accent2);
      font-family: var(--mono);
      font-size:.92rem;
    }
    input[type="range"]{width:100%;}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap;}
    button.small{
      border:1px solid rgba(255,255,255,.18);
      background: rgba(255,255,255,.06);
      color: var(--text);
      border-radius: 14px;
      padding: 8px 10px;
      cursor:pointer;
      transition: transform .12s ease, background .12s ease;
      font-size:.9rem;
    }
    button.small:hover{transform: translateY(-1px); background: rgba(255,255,255,.10);}
    figure{
      margin:0;
      border:1px solid var(--border);
      background: rgba(0,0,0,.14);
      border-radius: 18px;
      overflow:hidden;
    }
    figure figcaption{
      padding:10px 12px;
      border-top:1px solid var(--border);
      color:var(--muted);
      font-size:.92rem;
    }
    canvas{display:block; width:100%; height:320px;}
    .kpi{
      display:grid;
      grid-template-columns: repeat(4, minmax(0,1fr));
      gap:12px;
    }
    .kpi .box{
      border:1px solid var(--border);
      background: rgba(0,0,0,.16);
      border-radius: 16px;
      padding: 12px;
      min-width:0;
    }
    .kpi .label{
      color:var(--muted);
      font-size:.88rem;
      margin-bottom:6px;
    }
    .kpi .value{
      font-family:var(--mono);
      font-size:1.02rem;
      color:var(--text);
      word-break:break-word;
    }
    .final{
      border:1px solid rgba(114,241,184,.32);
      background: rgba(114,241,184,.07);
    }
    .final h3{
      margin:0 0 8px 0;
      font-size:1.05rem;
    }
    .final pre{
      margin:0;
      font-family:var(--mono);
      white-space:pre-wrap;
      line-height:1.45;
      font-size:.95rem;
    }
    footer{
      padding: 18px;
      border-top:1px solid var(--border);
      color:var(--faint);
      font-size:.92rem;
    }

    /* subtle motion */
    @keyframes floatIn{
      from{opacity:0; transform: translateY(8px);}
      to{opacity:1; transform: translateY(0);}
    }
    section{animation: floatIn .35s ease both;}
    section:nth-child(2){animation-delay:.03s}
    section:nth-child(3){animation-delay:.06s}
    section:nth-child(4){animation-delay:.09s}
    section:nth-child(5){animation-delay:.12s}
    section:nth-child(6){animation-delay:.15s}

    /* responsive */
    @media (max-width: 980px){
      .topgrid{grid-template-columns:1fr}
      .layout{grid-template-columns: 1fr}
      nav.toc{position:relative; top:auto}
      canvas{height:300px}
      .kpi{grid-template-columns: repeat(2, minmax(0,1fr));}
    }
    @media (max-width: 520px){
      .grid2{grid-template-columns:1fr}
      .grid3{grid-template-columns:1fr}
      .kpi{grid-template-columns: 1fr;}
    }

    /* print */
    @media print{
      body{background:#fff; color:#000}
      header, main, section, nav.toc, figure{background:#fff !important; color:#000 !important; box-shadow:none !important}
      .copybtn, .controls, .btnbar{display:none !important}
      nav.toc{position:relative; border:1px solid #ddd}
      section{page-break-inside:avoid}
      a{color:#000; text-decoration:none}
      canvas{display:none}
      figure figcaption{border-top:1px solid #ddd}
    }
  </style>
</head>
<body>
  <header>
    <div class="wrap topgrid">
      <div>
        <h1>Beam Parameters from Divergence (Gaussian Nd:YAG Beam, 1.06&nbsp;Œºm)</h1>
        <p class="subtitle">
          We determine the <em>waist radius</em>, <em>depth of focus</em> (Rayleigh range), <em>maximum intensity</em> at the waist,
          and the <em>on-axis intensity</em> at a specified distance from the waist, using standard Gaussian-beam relations.
        </p>
        <div class="chiprow">
          <div class="chip">Wavelength: 1.06 Œºm</div>
          <div class="chip">Power: 1 W</div>
          <div class="chip">Full divergence: 2Œ∏‚ÇÄ = 1 mrad</div>
          <div class="chip">Evaluate at z = 1.00 m</div>
        </div>
      </div>

      <div class="card quick">
        <strong>Quick Summary</strong>
        <ul>
          <li>Half-angle divergence: <span class="muted">Œ∏‚ÇÄ = (2Œ∏‚ÇÄ)/2 = 0.5 mrad</span></li>
          <li>Waist radius: <span class="muted">w‚ÇÄ = Œª/(œÄŒ∏‚ÇÄ) ‚âà <span id="qs_w0">0.675 mm</span></span></li>
          <li>Rayleigh range: <span class="muted">z<sub>R</sub> = œÄw‚ÇÄ¬≤/Œª ‚âà <span id="qs_zr">1.35 m</span></span></li>
          <li>Depth of focus (common convention): <span class="muted">2z<sub>R</sub> ‚âà <span id="qs_dof">2.70 m</span></span></li>
          <li>Peak (on-axis) intensity at waist: <span class="muted">I‚ÇÄ = 2P/(œÄw‚ÇÄ¬≤) ‚âà <span id="qs_i0">1.40√ó10‚Å∂ W/m¬≤</span></span></li>
          <li>On-axis intensity at z=1 m: <span class="muted">I(0,z)=I‚ÇÄ/(1+(z/z<sub>R</sub>)¬≤) ‚âà <span id="qs_iz">9.02√ó10‚Åµ W/m¬≤</span></span></li>
        </ul>
      </div>
    </div>
  </header>

  <main>
    <div class="wrap layout">
      <nav class="toc" aria-label="Table of contents">
        <div class="toc-title">üìå Table of Contents</div>
        <a href="#interactive">Interactive Visuals</a>
        <a href="#part1">PART 1 ‚Äî Problem Analysis</a>
        <a href="#part2">PART 2 ‚Äî Strategy & Tips</a>
        <a href="#part3">PART 3 ‚Äî Full Solution</a>
        <a href="#final">Final Numerical Results</a>
      </nav>

      <article>
        <section id="interactive">
          <h2>Interactive Visualizations (linked to the same physics & symbols)</h2>
          <p class="muted">
            Use the controls to change parameters (divergence, power, and position <em>z</em>).
            All plots and the diagram update live.
          </p>

          <div class="grid2">
            <div class="controls">
              <div class="control">
                <label>
                  Full divergence (2Œ∏‚ÇÄ) <span class="faint">[mrad]</span>
                  <span class="val" id="val_div">1.00</span>
                </label>
                <input id="divSlider" type="range" min="0.2" max="3.0" step="0.01" value="1.00" />
                <div class="faint">Half-angle: Œ∏‚ÇÄ = (2Œ∏‚ÇÄ)/2</div>
              </div>

              <div class="control">
                <label>
                  Optical power P <span class="faint">[W]</span>
                  <span class="val" id="val_p">1.00</span>
                </label>
                <input id="pSlider" type="range" min="0.1" max="10" step="0.01" value="1.00" />
                <div class="faint">Intensity scales linearly with P.</div>
              </div>

              <div class="control">
                <label>
                  Observation distance z from waist <span class="faint">[m]</span>
                  <span class="val" id="val_z">1.00</span>
                </label>
                <input id="zSlider" type="range" min="0" max="4" step="0.01" value="1.00" />
                <div class="faint">Affects beam radius w(z) and I(0,z).</div>
              </div>

              <div class="btnbar">
                <button class="small" id="resetBtn">Reset to problem values</button>
                <button class="small" id="set1mBtn">Set z = 1.00 m</button>
              </div>
            </div>

            <div class="callout">
              <strong>Live computed parameters</strong>
              <div class="kpi" style="margin-top:10px">
                <div class="box">
                  <div class="label">w‚ÇÄ (waist radius)</div>
                  <div class="value" id="k_w0">‚Äî</div>
                </div>
                <div class="box">
                  <div class="label">z<sub>R</sub> (Rayleigh range)</div>
                  <div class="value" id="k_zr">‚Äî</div>
                </div>
                <div class="box">
                  <div class="label">I‚ÇÄ (peak at waist)</div>
                  <div class="value" id="k_i0">‚Äî</div>
                </div>
                <div class="box">
                  <div class="label">I(0,z) on axis</div>
                  <div class="value" id="k_iz">‚Äî</div>
                </div>
              </div>
              <div class="faint" style="margin-top:10px">
                Notes: Gaussian beam uses the <em>1/e¬≤ radius</em> convention. Peak intensity relation: P = (œÄw¬≤/2) I(0).
              </div>
            </div>
          </div>

          <div class="grid2" style="margin-top:14px">
            <figure>
              <canvas id="cDiagram" aria-label="Gaussian beam diagram"></canvas>
              <figcaption>
                <strong>Diagram:</strong> Gaussian beam waist at z=0, expanding envelope w(z), Rayleigh range z<sub>R</sub>, and the chosen observation point.
              </figcaption>
            </figure>

            <figure>
              <canvas id="cMain" aria-label="On-axis intensity vs z plot"></canvas>
              <figcaption>
                <strong>Main plot:</strong> On-axis intensity I(0,z) versus z. Marker indicates the current slider value.
              </figcaption>
            </figure>
          </div>

          <div style="margin-top:14px">
            <figure>
              <canvas id="cSecondary" aria-label="Radial intensity profile plot"></canvas>
              <figcaption>
                <strong>Secondary plot:</strong> Radial intensity profile I(r,z) at the selected z (shows how the beam spreads).
              </figcaption>
            </figure>
          </div>
        </section>

        <section id="part1">
          <h2>PART 1 ‚Äî Problem Analysis (no solving yet)</h2>

          <div class="callout">
            <strong>Restated problem (in my own words)</strong>
            <p class="muted" style="margin:8px 0 0">
              A Nd:YAG laser emits a Gaussian beam at wavelength Œª = 1.06&nbsp;Œºm with optical power P = 1&nbsp;W.
              The far-field beam divergence is given as a full-angle value 2Œ∏‚ÇÄ = 1&nbsp;mrad.
              Find (i) the beam waist radius w‚ÇÄ, (ii) the depth of focus (related to the Rayleigh range),
              (iii) the maximum intensity (peak irradiance) of the beam, and (iv) the on-axis intensity at z = 100&nbsp;cm from the waist.
            </p>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div class="callout">
              <strong>Given quantities</strong>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>Wavelength: Œª = 1.06 Œºm = 1.06√ó10<sup>‚àí6</sup> m</li>
                <li>Optical power: P = 1 W</li>
                <li>Full divergence angle: 2Œ∏‚ÇÄ = 1 mrad = 1√ó10<sup>‚àí3</sup> rad</li>
                <li>Distance from waist: z = 100 cm = 1.00 m</li>
              </ul>
            </div>
            <div class="callout">
              <strong>Unknowns to determine</strong>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>Beam waist radius: w‚ÇÄ</li>
                <li>Depth of focus (often 2z<sub>R</sub>): z<sub>R</sub> and/or 2z<sub>R</sub></li>
                <li>Maximum (peak) intensity at waist: I‚ÇÄ = I(0,0)</li>
                <li>On-axis intensity at z = 1 m: I(0,z)</li>
              </ul>
            </div>
          </div>

          <div class="callout" style="margin-top:12px">
            <strong>Relevant physical principles (and why they apply)</strong>
            <p class="muted" style="margin:8px 0 0">
              The beam is stated to be a <em>Gaussian beam</em>, so it is well-described by paraxial Gaussian-beam optics.
              In this model, the far-field divergence Œ∏‚ÇÄ and waist radius w‚ÇÄ are linked by diffraction:
              smaller waist means larger divergence.
              The axial evolution of beam radius w(z) and intensity I(r,z) follows standard Gaussian formulas involving the Rayleigh range z<sub>R</sub>.
            </p>
          </div>

          <div class="grid3" style="margin-top:12px">
            <div class="callout">
              <strong>Approach A: Use divergence-to-waist relation</strong>
              <p class="muted" style="margin:8px 0 0">
                Use Œ∏‚ÇÄ ‚âà Œª/(œÄw‚ÇÄ) to obtain w‚ÇÄ directly, then compute z<sub>R</sub>, then intensities.
                <br><span class="faint">Best when divergence is provided (as here).</span>
              </p>
            </div>
            <div class="callout">
              <strong>Approach B: Start from z<sub>R</sub> and beam size evolution</strong>
              <p class="muted" style="margin:8px 0 0">
                If a beam radius at a known distance were given, combine w(z) with divergence definition to solve for w‚ÇÄ.
                <br><span class="faint">Not needed because we already have divergence.</span>
              </p>
            </div>
            <div class="callout">
              <strong>Approach C: Use beam quality / M¬≤</strong>
              <p class="muted" style="margin:8px 0 0">
                For non-ideal beams, divergence and waist relate as Œ∏‚ÇÄ = M¬≤ Œª/(œÄw‚ÇÄ).
                <br><span class="faint">Problem implies ideal Gaussian (M¬≤‚âà1), so keep it simple.</span>
              </p>
            </div>
          </div>

          <div class="callout" style="margin-top:12px">
            <strong>Chosen approach</strong>
            <p class="muted" style="margin:8px 0 0">
              We use <strong>Approach A</strong> because the problem explicitly gives the divergence of a Gaussian beam,
              which immediately yields w‚ÇÄ. From w‚ÇÄ we get z<sub>R</sub>, and from power P we get peak intensity and on-axis intensity at z.
            </p>
          </div>
        </section>

        <section id="part2">
          <h2>PART 2 ‚Äî Strategy & Tips (roadmap only)</h2>

          <div class="callout">
            <strong>Step-by-step plan (roadmap)</strong>
            <ol class="muted" style="margin:8px 0 0 20px">
              <li><strong>Convert divergence to half-angle</strong>: goal is Œ∏‚ÇÄ (not 2Œ∏‚ÇÄ).</li>
              <li><strong>Find waist radius</strong>: use diffraction relation Œ∏‚ÇÄ = Œª/(œÄw‚ÇÄ) (Gaussian, M¬≤=1).</li>
              <li><strong>Compute Rayleigh range</strong>: z<sub>R</sub> = œÄw‚ÇÄ¬≤/Œª.</li>
              <li><strong>Depth of focus</strong>: report 2z<sub>R</sub> (common convention), and also note z<sub>R</sub>.</li>
              <li><strong>Peak intensity at waist</strong>: use power normalization P = (œÄw‚ÇÄ¬≤/2) I‚ÇÄ ‚áí I‚ÇÄ = 2P/(œÄw‚ÇÄ¬≤).</li>
              <li><strong>On-axis intensity vs z</strong>: I(0,z) = I‚ÇÄ / (1 + (z/z<sub>R</sub>)¬≤).</li>
              <li><strong>Optional check</strong>: compute w(z) = w‚ÇÄ‚àö(1+(z/z<sub>R</sub>)¬≤) and confirm I(0,z) ‚àù 1/w(z)¬≤.</li>
            </ol>
          </div>

          <div class="grid2" style="margin-top:12px">
            <div class="callout">
              <strong>Common mistakes</strong>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>Using 2Œ∏‚ÇÄ as the half-angle (forgetting to divide by 2).</li>
                <li>Mixing radius conventions (1/e vs 1/e¬≤). Here w is the 1/e¬≤ radius.</li>
                <li>Using average intensity P/(œÄw¬≤) instead of peak intensity 2P/(œÄw¬≤).</li>
                <li>Confusing ‚Äúdepth of focus‚Äù with z<sub>R</sub> vs 2z<sub>R</sub>. (We‚Äôll state both.)</li>
              </ul>
            </div>
            <div class="callout">
              <strong>Quick tips</strong>
              <ul class="muted" style="margin:8px 0 0 18px">
                <li>Keep everything in SI units until the end.</li>
                <li>Sanity check: smaller divergence ‚áí larger w‚ÇÄ and lower peak intensity.</li>
                <li>At z = z<sub>R</sub>, on-axis intensity drops to half: I(0,z<sub>R</sub>) = I‚ÇÄ/2.</li>
              </ul>
            </div>
          </div>
        </section>

        <section id="part3">
          <h2>PART 3 ‚Äî Full Solution</h2>

          <div class="callout">
            <strong>Physical intuition first</strong>
            <p class="muted" style="margin:8px 0 0">
              A diffraction-limited Gaussian beam has an unavoidable tradeoff between how tightly it can be focused
              (small waist w‚ÇÄ) and how quickly it spreads (large divergence Œ∏‚ÇÄ). The Rayleigh range z<sub>R</sub> sets the
              distance over which the beam stays ‚Äúroughly collimated‚Äù near the waist. Intensity is highest where the beam
              cross-section is smallest‚Äîat the waist‚Äîand drops as the beam expands.
            </p>
          </div>

          <div class="callout" style="margin-top:12px">
            <strong>1) Convert divergence to half-angle</strong>
            <p class="muted" style="margin:8px 0 0">
              The problem gives the <em>full-angle</em> divergence 2Œ∏‚ÇÄ. Therefore
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq1">Copy</button>
              <pre class="eq" id="eq1">Œ∏‚ÇÄ = (2Œ∏‚ÇÄ)/2</pre>
            </div>
            <p class="muted" style="margin:10px 0 0">
              Numerically: 2Œ∏‚ÇÄ = 1 mrad ‚áí Œ∏‚ÇÄ = 0.5 mrad = 0.5√ó10‚Åª¬≥ rad.
            </p>
          </div>

          <div class="callout" style="margin-top:12px">
            <strong>2) Waist radius from divergence (ideal Gaussian, M¬≤ = 1)</strong>
            <p class="muted" style="margin:8px 0 0">
              For a diffraction-limited Gaussian beam (using the 1/e¬≤ radius convention), the far-field half-angle divergence is
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq2">Copy</button>
              <pre class="eq" id="eq2">Œ∏‚ÇÄ = Œª / (œÄ w‚ÇÄ)    ‚áí    w‚ÇÄ = Œª / (œÄ Œ∏‚ÇÄ)</pre>
            </div>
            <p class="muted" style="margin:10px 0 0">
              Insert values (Œª = 1.06√ó10‚Åª‚Å∂ m, Œ∏‚ÇÄ = 0.5√ó10‚Åª¬≥ rad):
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq3">Copy</button>
              <pre class="eq" id="eq3">w‚ÇÄ = (1.06√ó10‚Åª‚Å∂) / (œÄ¬∑0.5√ó10‚Åª¬≥) ‚âà 6.75√ó10‚Åª‚Å¥ m = 0.675 mm</pre>
            </div>
          </div>

          <div class="callout" style="margin-top:12px">
            <strong>3) Rayleigh range and depth of focus</strong>
            <p class="muted" style="margin:8px 0 0">
              The Rayleigh range (distance from the waist where the beam area doubles) is
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq4">Copy</button>
              <pre class="eq" id="eq4">z_R = œÄ w‚ÇÄ¬≤ / Œª</pre>
            </div>
            <p class="muted" style="margin:10px 0 0">
              Compute w‚ÇÄ¬≤ = (6.75√ó10‚Åª‚Å¥)¬≤ ‚âà 4.56√ó10‚Åª‚Å∑ m¬≤, so
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq5">Copy</button>
              <pre class="eq" id="eq5">z_R = œÄ(4.56√ó10‚Åª‚Å∑) / (1.06√ó10‚Åª‚Å∂) ‚âà 1.35 m</pre>
            </div>
            <p class="muted" style="margin:10px 0 0">
              Many optics texts define the <em>depth of focus</em> (or depth of field) as the full confocal parameter
              <span class="muted">b = 2z<sub>R</sub></span>. Therefore:
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq6">Copy</button>
              <pre class="eq" id="eq6">Depth of focus (common): 2z_R ‚âà 2(1.35 m) = 2.70 m</pre>
            </div>
          </div>

          <div class="callout" style="margin-top:12px">
            <strong>4) Maximum (peak) intensity at the waist</strong>
            <p class="muted" style="margin:8px 0 0">
              For a Gaussian intensity profile at a given z,
              <span class="muted">I(r,z) = I(0,z) exp(-2r¬≤/w(z)¬≤)</span>.
              The total power is the integral over the cross-section:
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq7">Copy</button>
              <pre class="eq" id="eq7">P = ‚à´‚ÇÄ^‚àû I(0,z) e^{-2r¬≤/w¬≤} (2œÄr dr) = (œÄ w(z)¬≤ / 2) I(0,z)</pre>
            </div>
            <p class="muted" style="margin:10px 0 0">
              At the waist, w(z)=w‚ÇÄ and I(0,0)=I‚ÇÄ, so:
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq8">Copy</button>
              <pre class="eq" id="eq8">I‚ÇÄ = I(0,0) = 2P / (œÄ w‚ÇÄ¬≤)</pre>
            </div>
            <p class="muted" style="margin:10px 0 0">
              Insert P=1 W and w‚ÇÄ¬≤‚âà4.56√ó10‚Åª‚Å∑ m¬≤:
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq9">Copy</button>
              <pre class="eq" id="eq9">I‚ÇÄ = 2¬∑1 / (œÄ¬∑4.56√ó10‚Åª‚Å∑) ‚âà 1.40√ó10‚Å∂ W/m¬≤  (‚âà 140 W/cm¬≤)</pre>
            </div>
          </div>

          <div class="callout" style="margin-top:12px">
            <strong>5) On-axis intensity at z = 100 cm</strong>
            <p class="muted" style="margin:8px 0 0">
              The Gaussian-beam radius evolves as
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq10">Copy</button>
              <pre class="eq" id="eq10">w(z) = w‚ÇÄ ‚àö(1 + (z/z_R)¬≤)</pre>
            </div>
            <p class="muted" style="margin:10px 0 0">
              Because power is conserved and the transverse area scale is ~w(z)¬≤, the on-axis intensity falls as
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq11">Copy</button>
              <pre class="eq" id="eq11">I(0,z) = I‚ÇÄ / (1 + (z/z_R)¬≤)</pre>
            </div>
            <p class="muted" style="margin:10px 0 0">
              For z = 1.00 m and z<sub>R</sub> ‚âà 1.35 m:
              (z/z<sub>R</sub>)¬≤ ‚âà (1/1.35)¬≤ ‚âà 0.548. Hence
            </p>
            <div class="eqblock">
              <button class="copybtn" data-copy="eq12">Copy</button>
              <pre class="eq" id="eq12">I(0,1 m) = I‚ÇÄ / (1 + 0.548) ‚âà 0.646 I‚ÇÄ ‚âà 9.02√ó10‚Åµ W/m¬≤ (‚âà 90.2 W/cm¬≤)</pre>
            </div>
            <p class="muted" style="margin:10px 0 0">
              (Optional) The beam radius at 1 m is
              w(1 m) = w‚ÇÄ‚àö(1+0.548) ‚âà 0.675 mm √ó 1.244 ‚âà 0.84 mm,
              consistent with I ‚àù 1/w¬≤.
            </p>
          </div>

          <div class="grid3" style="margin-top:12px">
            <div class="callout">
              <strong>Sanity check: units</strong>
              <p class="muted" style="margin:8px 0 0">
                w‚ÇÄ has units of meters from Œª/(œÄŒ∏). z<sub>R</sub> has units meters from (m¬≤)/m. I‚ÇÄ uses W/(m¬≤), correct for intensity.
              </p>
            </div>
            <div class="callout">
              <strong>Sanity check: limiting cases</strong>
              <p class="muted" style="margin:8px 0 0">
                If Œ∏‚ÇÄ ‚Üì (better collimation), then w‚ÇÄ ‚Üë and I‚ÇÄ ‚Üì. If z ‚â´ z<sub>R</sub>, then I(0,z) ~ I‚ÇÄ (z<sub>R</sub>/z)¬≤, i.e. inverse-square scaling.
              </p>
            </div>
            <div class="callout">
              <strong>Physical interpretation</strong>
              <p class="muted" style="margin:8px 0 0">
                z<sub>R</sub> ‚âà 1.35 m means the beam stays near its minimum size over meter-scale distances‚Äîconsistent with a small (mrad) divergence.
              </p>
            </div>
          </div>
        </section>

        <section id="final" class="final">
          <h2>Final Numerical Results (for the given problem values)</h2>

          <div class="eqblock" style="border-color: rgba(114,241,184,.35); background: rgba(114,241,184,.06);">
            <button class="copybtn" data-copy="finalText">Copy final answer</button>
            <pre class="eq" id="finalText">Given: Œª = 1.06 Œºm, P = 1 W, full divergence 2Œ∏‚ÇÄ = 1 mrad ‚áí Œ∏‚ÇÄ = 0.5 mrad, and z = 1.00 m.

Waist radius:
w‚ÇÄ = Œª/(œÄŒ∏‚ÇÄ) ‚âà 6.75√ó10‚Åª‚Å¥ m = 0.675 mm

Rayleigh range:
z_R = œÄw‚ÇÄ¬≤/Œª ‚âà 1.35 m

Depth of focus (common convention, confocal parameter):
2z_R ‚âà 2.70 m

Maximum (peak) intensity at the waist:
I‚ÇÄ = 2P/(œÄw‚ÇÄ¬≤) ‚âà 1.40√ó10‚Å∂ W/m¬≤  (‚âà 140 W/cm¬≤)

On-axis intensity at z = 1.00 m:
I(0,z) = I‚ÇÄ / (1 + (z/z_R)¬≤) ‚âà 9.02√ó10‚Åµ W/m¬≤  (‚âà 90.2 W/cm¬≤)</pre>
          </div>

          <p class="muted" style="margin:10px 0 0">
            If your course defines ‚Äúdepth of focus‚Äù differently, the most standard Gaussian-beam quantity to report is z<sub>R</sub>;
            many texts then call 2z<sub>R</sub> the depth of focus (confocal parameter).
          </p>
        </section>
      </article>
    </div>
  </main>

  <footer>
    <div class="wrap">
      Built with vanilla HTML/CSS/JS. Canvas plots are generated in real time using the same Gaussian-beam equations shown above.
    </div>
  </footer>

  <script>
    // ---------- Utilities ----------
    function clamp(x, a, b){ return Math.max(a, Math.min(b, x)); }

    function fmtSI(x, unit){
      // compact SI-ish formatting for display
      const ax = Math.abs(x);
      if (ax === 0) return `0 ${unit}`.trim();
      const pow = Math.floor(Math.log10(ax));
      // choose engineering exponent multiple of 3
      const e = Math.floor(pow/3)*3;
      const scaled = x / Math.pow(10, e);
      const prefix = ({
        "-12":"p","-9":"n","-6":"¬µ","-3":"m","0":"","3":"k","6":"M","9":"G","12":"T"
      })[String(e)] ?? `e${e}`;
      const val = (Math.abs(scaled) >= 100) ? scaled.toFixed(0)
                : (Math.abs(scaled) >= 10) ? scaled.toFixed(1)
                : scaled.toFixed(2);
      return `${val} ${prefix}${unit}`.trim();
    }

    function fmtSci(x){
      const ax = Math.abs(x);
      if (ax === 0) return "0";
      const e = Math.floor(Math.log10(ax));
      const m = x / Math.pow(10, e);
      const mStr = (Math.abs(m) >= 10) ? m.toFixed(0) : m.toFixed(2);
      return `${mStr}√ó10^${e}`;
    }

    async function copyText(text){
      try{
        await navigator.clipboard.writeText(text);
        toast("Copied!");
      }catch(e){
        // fallback
        const ta = document.createElement("textarea");
        ta.value = text;
        document.body.appendChild(ta);
        ta.select();
        document.execCommand("copy");
        ta.remove();
        toast("Copied!");
      }
    }

    let toastTimer = null;
    function toast(msg){
      let el = document.getElementById("toast");
      if(!el){
        el = document.createElement("div");
        el.id = "toast";
        el.style.position = "fixed";
        el.style.left = "50%";
        el.style.bottom = "18px";
        el.style.transform = "translateX(-50%)";
        el.style.padding = "10px 12px";
        el.style.border = "1px solid rgba(255,255,255,.18)";
        el.style.background = "rgba(0,0,0,.55)";
        el.style.backdropFilter = "blur(10px)";
        el.style.color = "#e9eefb";
        el.style.borderRadius = "14px";
        el.style.fontFamily = "ui-sans-serif,system-ui";
        el.style.fontSize = "0.92rem";
        el.style.zIndex = "9999";
        el.style.opacity = "0";
        el.style.transition = "opacity .15s ease";
        document.body.appendChild(el);
      }
      el.textContent = msg;
      el.style.opacity = "1";
      clearTimeout(toastTimer);
      toastTimer = setTimeout(()=>{ el.style.opacity = "0"; }, 900);
    }

    // Smooth scrolling for TOC
    document.querySelectorAll('nav.toc a[href^="#"]').forEach(a=>{
      a.addEventListener("click", (e)=>{
        e.preventDefault();
        const id = a.getAttribute("href");
        const target = document.querySelector(id);
        if(target) target.scrollIntoView({behavior:"smooth", block:"start"});
      });
    });

    // Copy buttons for equations + final text
    document.querySelectorAll(".copybtn").forEach(btn=>{
      btn.addEventListener("click", ()=>{
        const id = btn.getAttribute("data-copy");
        const el = document.getElementById(id);
        if(el) copyText(el.textContent.trim());
      });
    });

    // ---------- Physics Model ----------
    const model = {
      lambda: 1.06e-6,      // m
      divFull_mrad: 1.00,   // mrad (2Œ∏0)
      P: 1.00,              // W
      z: 1.00               // m
    };

    function derived(m){
      const theta0 = (m.divFull_mrad*1e-3)/2; // rad
      const w0 = m.lambda / (Math.PI * theta0); // m
      const zR = Math.PI * w0*w0 / m.lambda;    // m
      const I0 = 2*m.P / (Math.PI * w0*w0);     // W/m^2 (peak at waist)
      const Iz = I0 / (1 + (m.z/zR)*(m.z/zR));  // W/m^2 on axis
      const wz = w0 * Math.sqrt(1 + (m.z/zR)*(m.z/zR));
      return {theta0, w0, zR, I0, Iz, wz};
    }

    // ---------- Canvas Plotting ----------
    function setupCanvas(canvas){
      const ctx = canvas.getContext("2d");
      const state = {canvas, ctx, dpr:1, w:0, h:0};
      function resize(){
        const rect = canvas.getBoundingClientRect();
        const dpr = window.devicePixelRatio || 1;
        state.dpr = dpr;
        state.w = Math.max(1, Math.floor(rect.width * dpr));
        state.h = Math.max(1, Math.floor(rect.height * dpr));
        canvas.width = state.w;
        canvas.height = state.h;
        ctx.setTransform(1,0,0,1,0,0);
        ctx.imageSmoothingEnabled = true;
        ctx.lineJoin = "round";
        ctx.lineCap = "round";
      }
      resize();
      return {state, resize};
    }

    function clear(ctx, w, h){
      ctx.clearRect(0,0,w,h);
      // subtle background
      const g = ctx.createLinearGradient(0,0,0,h);
      g.addColorStop(0,"rgba(255,255,255,0.03)");
      g.addColorStop(1,"rgba(255,255,255,0.00)");
      ctx.fillStyle = g;
      ctx.fillRect(0,0,w,h);
    }

    function drawAxes(ctx, box, xMin, xMax, yMin, yMax, xLabel, yLabel, title){
      const {x,y,w,h,padL,padR,padT,padB} = box;
      // frame
      ctx.strokeStyle = "rgba(255,255,255,0.10)";
      ctx.lineWidth = 1;
      ctx.strokeRect(x+0.5, y+0.5, w-1, h-1);

      // title
      ctx.fillStyle = "rgba(233,238,251,0.95)";
      ctx.font = `${Math.round(14*box.dprScale)}px ui-sans-serif,system-ui`;
      ctx.fillText(title, x+padL, y+padT-10*box.dprScale);

      // plot area
      const px0 = x + padL, px1 = x + w - padR;
      const py0 = y + padT, py1 = y + h - padB;

      // grid + ticks
      const nX = 6, nY = 5;
      ctx.strokeStyle = "rgba(255,255,255,0.08)";
      ctx.lineWidth = 1;

      ctx.font = `${Math.round(12*box.dprScale)}px ui-sans-serif,system-ui`;
      ctx.fillStyle = "rgba(185,196,223,0.95)";

      for(let i=0;i<=nX;i++){
        const t = i/nX;
        const xx = px0 + t*(px1-px0);
        ctx.beginPath(); ctx.moveTo(xx, py0); ctx.lineTo(xx, py1); ctx.stroke();

        const xv = xMin + t*(xMax-xMin);
        const lbl = niceNumberLabel(xv);
        ctx.fillText(lbl, xx-10*box.dprScale, py1 + 18*box.dprScale);
      }

      for(let j=0;j<=nY;j++){
        const t = j/nY;
        const yy = py1 - t*(py1-py0);
        ctx.beginPath(); ctx.moveTo(px0, yy); ctx.lineTo(px1, yy); ctx.stroke();

        const yv = yMin + t*(yMax-yMin);
        const lbl = niceNumberLabel(yv);
        ctx.fillText(lbl, x + 8*box.dprScale, yy + 4*box.dprScale);
      }

      // axes labels
      ctx.fillStyle = "rgba(233,238,251,0.92)";
      ctx.font = `${Math.round(13*box.dprScale)}px ui-sans-serif,system-ui`;
      ctx.fillText(xLabel, px0, y + h - 10*box.dprScale);

      // y label (rotated)
      ctx.save();
      ctx.translate(x + 14*box.dprScale, py0 + (py1-py0)/2);
      ctx.rotate(-Math.PI/2);
      ctx.fillText(yLabel, 0, 0);
      ctx.restore();

      return {px0,px1,py0,py1};
    }

    function niceNumberLabel(v){
      const av = Math.abs(v);
      if(av === 0) return "0";
      if(av >= 1000 || av < 0.01){
        // scientific-ish
        const e = Math.floor(Math.log10(av));
        const m = v / Math.pow(10, e);
        const mm = (Math.abs(m) >= 10) ? m.toFixed(0) : m.toFixed(1);
        return `${mm}e${e}`;
      }
      if(av >= 100) return v.toFixed(0);
      if(av >= 10) return v.toFixed(1);
      return v.toFixed(2);
    }

    function mapX(xv, ax){ return ax.px0 + (xv-ax.xMin)*(ax.px1-ax.px0)/(ax.xMax-ax.xMin); }
    function mapY(yv, ax){ return ax.py1 - (yv-ax.yMin)*(ax.py1-ax.py0)/(ax.yMax-ax.yMin); }

    function drawLine(ctx, points, strokeStyle, lineWidth){
      if(points.length < 2) return;
      ctx.strokeStyle = strokeStyle;
      ctx.lineWidth = lineWidth;
      ctx.beginPath();
      ctx.moveTo(points[0].x, points[0].y);
      for(let i=1;i<points.length;i++) ctx.lineTo(points[i].x, points[i].y);
      ctx.stroke();
    }

    function drawMarker(ctx, x, y, color){
      ctx.fillStyle = color;
      ctx.beginPath();
      ctx.arc(x, y, 4.5, 0, Math.PI*2);
      ctx.fill();
      ctx.strokeStyle = "rgba(0,0,0,0.35)";
      ctx.lineWidth = 1;
      ctx.stroke();
    }

    function drawLegend(ctx, x, y, items, dprScale){
      const pad = 10*dprScale;
      const lh = 18*dprScale;
      ctx.font = `${Math.round(12*dprScale)}px ui-sans-serif,system-ui`;
      let w = 0;
      for(const it of items){
        w = Math.max(w, ctx.measureText(it.label).width + 34*dprScale);
      }
      const h = items.length*lh + pad*1.2;
      ctx.fillStyle = "rgba(0,0,0,0.25)";
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.lineWidth = 1;
      ctx.beginPath();
      roundRect(ctx, x, y, w+pad*1.4, h, 12*dprScale);
      ctx.fill();
      ctx.stroke();

      items.forEach((it, i)=>{
        const yy = y + pad*0.8 + (i+0.8)*lh;
        ctx.strokeStyle = it.color;
        ctx.lineWidth = 2;
        ctx.beginPath();
        ctx.moveTo(x + pad*0.9, yy-5*dprScale);
        ctx.lineTo(x + pad*0.9 + 16*dprScale, yy-5*dprScale);
        ctx.stroke();
        ctx.fillStyle = "rgba(233,238,251,0.90)";
        ctx.fillText(it.label, x + pad*0.9 + 22*dprScale, yy-2*dprScale);
      });
    }

    function roundRect(ctx, x, y, w, h, r){
      const rr = Math.min(r, w/2, h/2);
      ctx.moveTo(x+rr, y);
      ctx.arcTo(x+w, y, x+w, y+h, rr);
      ctx.arcTo(x+w, y+h, x, y+h, rr);
      ctx.arcTo(x, y+h, x, y, rr);
      ctx.arcTo(x, y, x+w, y, rr);
      ctx.closePath();
    }

    // ---------- Specific Drawings ----------
    const cDiagram = setupCanvas(document.getElementById("cDiagram"));
    const cMain = setupCanvas(document.getElementById("cMain"));
    const cSecondary = setupCanvas(document.getElementById("cSecondary"));

    function drawDiagram(){
      const {ctx} = cDiagram.state;
      const W = cDiagram.state.w, H = cDiagram.state.h;
      clear(ctx, W, H);

      const d = derived(model);

      const pad = 22 * cDiagram.state.dpr;
      const x0 = pad, x1 = W - pad;
      const yMid = H * 0.52;

      // scale z to fit
      const zMax = 4.0; // m
      const zx = z => x0 + (z/zMax) * (x1-x0);

      // beam envelope scale (visual only)
      const wVisMax = 2.5e-3; // 2.5 mm
      const wy = w => (w / wVisMax) * (H*0.30);

      // z axis
      ctx.strokeStyle = "rgba(185,196,223,0.5)";
      ctx.lineWidth = 1.2;
      ctx.beginPath();
      ctx.moveTo(x0, yMid);
      ctx.lineTo(x1, yMid);
      ctx.stroke();

      // draw envelope for z in [0,zMax]
      ctx.strokeStyle = "rgba(122,162,255,0.85)";
      ctx.lineWidth = 2.2;

      const n = 220;
      ctx.beginPath();
      for(let i=0;i<=n;i++){
        const z = (i/n)*zMax;
        const wz = d.w0 * Math.sqrt(1 + (z/d.zR)*(z/d.zR));
        const yy = yMid - wy(wz);
        const xx = zx(z);
        if(i===0) ctx.moveTo(xx, yy); else ctx.lineTo(xx, yy);
      }
      ctx.stroke();

      ctx.beginPath();
      for(let i=0;i<=n;i++){
        const z = (i/n)*zMax;
        const wz = d.w0 * Math.sqrt(1 + (z/d.zR)*(z/d.zR));
        const yy = yMid + wy(wz);
        const xx = zx(z);
        if(i===0) ctx.moveTo(xx, yy); else ctx.lineTo(xx, yy);
      }
      ctx.stroke();

      // waist line
      ctx.strokeStyle = "rgba(114,241,184,0.9)";
      ctx.lineWidth = 2;
      const w0y = wy(d.w0);
      ctx.beginPath();
      ctx.moveTo(zx(0), yMid - w0y);
      ctx.lineTo(zx(0), yMid + w0y);
      ctx.stroke();

      // Rayleigh range marker
      const zrX = zx(Math.min(d.zR, zMax));
      ctx.strokeStyle = "rgba(255,204,102,0.9)";
      ctx.setLineDash([6*cDiagram.state.dpr, 6*cDiagram.state.dpr]);
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(zrX, yMid - H*0.30);
      ctx.lineTo(zrX, yMid + H*0.30);
      ctx.stroke();
      ctx.setLineDash([]);

      // observation point
      const zX = zx(clamp(model.z, 0, zMax));
      const wzObs = d.w0 * Math.sqrt(1 + (model.z/d.zR)*(model.z/d.zR));
      const yTop = yMid - wy(wzObs);
      const yBot = yMid + wy(wzObs);
      ctx.strokeStyle = "rgba(114,241,184,0.9)";
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(zX, yTop);
      ctx.lineTo(zX, yBot);
      ctx.stroke();

      ctx.fillStyle = "rgba(233,238,251,0.92)";
      ctx.font = `${Math.round(13*cDiagram.state.dpr)}px ui-sans-serif,system-ui`;
      ctx.fillText("z-axis", x1 - 60*cDiagram.state.dpr, yMid - 10*cDiagram.state.dpr);

      // labels
      ctx.fillStyle = "rgba(233,238,251,0.95)";
      ctx.font = `${Math.round(14*cDiagram.state.dpr)}px ui-sans-serif,system-ui`;
      ctx.fillText("Gaussian beam envelope w(z)", x0, pad*0.95);

      ctx.fillStyle = "rgba(185,196,223,0.95)";
      ctx.font = `${Math.round(12*cDiagram.state.dpr)}px ui-sans-serif,system-ui`;
      ctx.fillText("waist (z=0)", zx(0)+6*cDiagram.state.dpr, yMid + 18*cDiagram.state.dpr);
      ctx.fillText("z_R", zrX + 6*cDiagram.state.dpr, yMid - H*0.30 + 16*cDiagram.state.dpr);
      ctx.fillText("observation z", zX + 6*cDiagram.state.dpr, yTop - 10*cDiagram.state.dpr);

      // ticks on z axis
      const ticks = 5;
      ctx.strokeStyle = "rgba(255,255,255,0.12)";
      ctx.lineWidth = 1;
      for(let i=0;i<=ticks;i++){
        const z = i*(zMax/ticks);
        const xx = zx(z);
        ctx.beginPath();
        ctx.moveTo(xx, yMid-6*cDiagram.state.dpr);
        ctx.lineTo(xx, yMid+6*cDiagram.state.dpr);
        ctx.stroke();
        ctx.fillStyle = "rgba(185,196,223,0.9)";
        ctx.font = `${Math.round(11*cDiagram.state.dpr)}px ui-sans-serif,system-ui`;
        ctx.fillText(z.toFixed(1)+" m", xx-14*cDiagram.state.dpr, yMid+22*cDiagram.state.dpr);
      }
    }

    function drawMainPlot(){
      const {ctx} = cMain.state;
      const W = cMain.state.w, H = cMain.state.h;
      clear(ctx, W, H);

      const d = derived(model);

      const padL = 60*cMain.state.dpr, padR = 16*cMain.state.dpr, padT = 36*cMain.state.dpr, padB = 44*cMain.state.dpr;
      const box = {x:0,y:0,w:W,h:H,padL,padR,padT,padB,dprScale:cMain.state.dpr};

      const zMax = 4.0;
      // y range: from min at zMax to max at 0
      const Imax = d.I0;
      const Imin = d.I0 / (1 + (zMax/d.zR)*(zMax/d.zR));

      const ax = drawAxes(ctx, box,
        0, zMax,
        Math.max(0, Imin*0.95), Imax*1.05,
        "z [m]",
        "I(0,z) [W/m¬≤]",
        "On-axis intensity vs distance"
      );
      ax.xMin=0; ax.xMax=zMax; ax.yMin=Math.max(0, Imin*0.95); ax.yMax=Imax*1.05;

      // curve
      const pts=[];
      const n=260;
      for(let i=0;i<=n;i++){
        const z = (i/n)*zMax;
        const I = d.I0 / (1 + (z/d.zR)*(z/d.zR));
        pts.push({x: mapX(z, ax), y: mapY(I, ax)});
      }
      drawLine(ctx, pts, "rgba(122,162,255,0.9)", 2.4);

      // marker at current z
      const zc = clamp(model.z, 0, zMax);
      const Ic = d.I0 / (1 + (zc/d.zR)*(zc/d.zR));
      drawMarker(ctx, mapX(zc, ax), mapY(Ic, ax), "rgba(114,241,184,0.95)");

      // legend
      drawLegend(ctx, W - 210*cMain.state.dpr, 14*cMain.state.dpr,
        [{label:"I(0,z)", color:"rgba(122,162,255,0.9)"},
         {label:"current z", color:"rgba(114,241,184,0.95)"}],
        cMain.state.dpr
      );
    }

    function drawSecondaryPlot(){
      const {ctx} = cSecondary.state;
      const W = cSecondary.state.w, H = cSecondary.state.h;
      clear(ctx, W, H);

      const d = derived(model);
      const wz = d.wz;

      const padL = 62*cSecondary.state.dpr, padR = 16*cSecondary.state.dpr, padT = 36*cSecondary.state.dpr, padB = 44*cSecondary.state.dpr;
      const box = {x:0,y:0,w:W,h:H,padL,padR,padT,padB,dprScale:cSecondary.state.dpr};

      // r range up to 3w(z)
      const rMax = 3*wz;
      const Imax = d.Iz;           // at r=0
      const Imin = d.Iz*Math.exp(-2*(rMax*rMax)/(wz*wz)); // tiny

      const ax = drawAxes(ctx, box,
        0, rMax,
        Math.max(0, Imin), Imax*1.05,
        "r [m]",
        "I(r,z) [W/m¬≤]",
        "Radial intensity profile at the selected z"
      );
      ax.xMin=0; ax.xMax=rMax; ax.yMin=Math.max(0, Imin); ax.yMax=Imax*1.05;

      // profile curve
      const pts=[];
      const n=260;
      for(let i=0;i<=n;i++){
        const r = (i/n)*rMax;
        const I = d.Iz*Math.exp(-2*(r*r)/(wz*wz));
        pts.push({x: mapX(r, ax), y: mapY(I, ax)});
      }
      drawLine(ctx, pts, "rgba(255,204,102,0.92)", 2.4);

      // mark r = w(z) (1/e^2 radius)
      const rw = wz;
      const Iw = d.Iz*Math.exp(-2); // by definition
      ctx.strokeStyle = "rgba(114,241,184,0.8)";
      ctx.setLineDash([6*cSecondary.state.dpr, 6*cSecondary.state.dpr]);
      ctx.lineWidth = 2;
      ctx.beginPath();
      ctx.moveTo(mapX(rw, ax), ax.py0);
      ctx.lineTo(mapX(rw, ax), ax.py1);
      ctx.stroke();
      ctx.setLineDash([]);

      drawMarker(ctx, mapX(rw, ax), mapY(Iw, ax), "rgba(114,241,184,0.95)");

      // legend
      drawLegend(ctx, W - 270*cSecondary.state.dpr, 14*cSecondary.state.dpr,
        [{label:"I(r,z)", color:"rgba(255,204,102,0.92)"},
         {label:"r = w(z)", color:"rgba(114,241,184,0.95)"}],
        cSecondary.state.dpr
      );

      // small annotation
      ctx.fillStyle = "rgba(185,196,223,0.95)";
      ctx.font = `${Math.round(12*cSecondary.state.dpr)}px ui-sans-serif,system-ui`;
      const note = `w(z) = ${fmtSI(wz, "m")}  at z = ${model.z.toFixed(2)} m`;
      ctx.fillText(note, 14*cSecondary.state.dpr, H - 14*cSecondary.state.dpr);
    }

    // ---------- UI + Updates ----------
    const divSlider = document.getElementById("divSlider");
    const pSlider = document.getElementById("pSlider");
    const zSlider = document.getElementById("zSlider");

    function updateUI(){
      document.getElementById("val_div").textContent = Number(model.divFull_mrad).toFixed(2);
      document.getElementById("val_p").textContent = Number(model.P).toFixed(2);
      document.getElementById("val_z").textContent = Number(model.z).toFixed(2);

      const d = derived(model);

      // KPIs
      document.getElementById("k_w0").textContent = `${fmtSI(d.w0, "m")}  (${(d.w0*1e3).toFixed(3)} mm)`;
      document.getElementById("k_zr").textContent = `${d.zR.toFixed(3)} m`;
      document.getElementById("k_i0").textContent = `${fmtSci(d.I0)} W/m¬≤`;
      document.getElementById("k_iz").textContent = `${fmtSci(d.Iz)} W/m¬≤`;

      // Quick summary (problem defaults only shown up top, but we keep it synced if user changes)
      document.getElementById("qs_w0").textContent = `${(d.w0*1e3).toFixed(3)} mm`;
      document.getElementById("qs_zr").textContent = `${d.zR.toFixed(2)} m`;
      document.getElementById("qs_dof").textContent = `${(2*d.zR).toFixed(2)} m`;
      document.getElementById("qs_i0").textContent = `${(d.I0).toExponential(2)} W/m¬≤`;
      document.getElementById("qs_iz").textContent = `${(d.Iz).toExponential(2)} W/m¬≤`;

      // Redraw visuals
      drawDiagram();
      drawMainPlot();
      drawSecondaryPlot();
    }

    divSlider.addEventListener("input", ()=>{
      model.divFull_mrad = Number(divSlider.value);
      updateUI();
    });
    pSlider.addEventListener("input", ()=>{
      model.P = Number(pSlider.value);
      updateUI();
    });
    zSlider.addEventListener("input", ()=>{
      model.z = Number(zSlider.value);
      updateUI();
    });

    document.getElementById("resetBtn").addEventListener("click", ()=>{
      model.divFull_mrad = 1.00;
      model.P = 1.00;
      model.z = 1.00;
      divSlider.value = "1.00";
      pSlider.value = "1.00";
      zSlider.value = "1.00";
      updateUI();
    });
    document.getElementById("set1mBtn").addEventListener("click", ()=>{
      model.z = 1.00;
      zSlider.value = "1.00";
      updateUI();
    });

    // Handle resizing crisply (HiDPI)
    function onResize(){
      cDiagram.resize();
      cMain.resize();
      cSecondary.resize();
      updateUI();
    }
    window.addEventListener("resize", onResize, {passive:true});

    // Initialize
    updateUI();
  </script>
</body>
</html>
